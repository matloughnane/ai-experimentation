module.exports=[688947,(e,t,r)=>{t.exports=e.x("stream",()=>require("stream"))},362562,(e,t,r)=>{t.exports=e.x("module",()=>require("module"))},363890,(e,t,r)=>{t.exports=e.x("stream/web",()=>require("stream/web"))},427699,(e,t,r)=>{t.exports=e.x("events",()=>require("events"))},193484,(e,t,r)=>{"use strict";r.byteLength=function(e){var t=u(e),r=t[0],a=t[1];return(r+a)*3/4-a},r.toByteArray=function(e){var t,r,a=u(e),i=a[0],o=a[1],l=new n((i+o)*3/4-o),p=0,d=o>0?i-4:i;for(r=0;r<d;r+=4)t=s[e.charCodeAt(r)]<<18|s[e.charCodeAt(r+1)]<<12|s[e.charCodeAt(r+2)]<<6|s[e.charCodeAt(r+3)],l[p++]=t>>16&255,l[p++]=t>>8&255,l[p++]=255&t;return 2===o&&(t=s[e.charCodeAt(r)]<<2|s[e.charCodeAt(r+1)]>>4,l[p++]=255&t),1===o&&(t=s[e.charCodeAt(r)]<<10|s[e.charCodeAt(r+1)]<<4|s[e.charCodeAt(r+2)]>>2,l[p++]=t>>8&255,l[p++]=255&t),l},r.fromByteArray=function(e){for(var t,r=e.length,s=r%3,n=[],i=0,o=r-s;i<o;i+=16383)n.push(function(e,t,r){for(var s,n=[],i=t;i<r;i+=3)s=(e[i]<<16&0xff0000)+(e[i+1]<<8&65280)+(255&e[i+2]),n.push(a[s>>18&63]+a[s>>12&63]+a[s>>6&63]+a[63&s]);return n.join("")}(e,i,i+16383>o?o:i+16383));return 1===s?n.push(a[(t=e[r-1])>>2]+a[t<<4&63]+"=="):2===s&&n.push(a[(t=(e[r-2]<<8)+e[r-1])>>10]+a[t>>4&63]+a[t<<2&63]+"="),n.join("")};for(var a=[],s=[],n="u">typeof Uint8Array?Uint8Array:Array,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",o=0,l=i.length;o<l;++o)a[o]=i[o],s[i.charCodeAt(o)]=o;function u(e){var t=e.length;if(t%4>0)throw Error("Invalid string. Length must be a multiple of 4");var r=e.indexOf("=");-1===r&&(r=t);var a=r===t?0:4-r%4;return[r,a]}s[45]=62,s[95]=63},785734,(e,t,r)=>{"use strict";var a=Object.defineProperty,s=Object.getOwnPropertyDescriptor,n=Object.getOwnPropertyNames,i=Object.prototype.hasOwnProperty,o={},l={SYMBOL_FOR_REQ_CONTEXT:()=>p,getContext:()=>d};for(var u in l)a(o,u,{get:l[u],enumerable:!0});t.exports=((e,t,r,o)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let l of n(t))i.call(e,l)||l===r||a(e,l,{get:()=>t[l],enumerable:!(o=s(t,l))||o.enumerable});return e})(a({},"__esModule",{value:!0}),o);let p=Symbol.for("@vercel/request-context");function d(){let e=globalThis;return e[p]?.get?.()??{}}},501997,(e,t,r)=>{"use strict";var a=Object.defineProperty,s=Object.getOwnPropertyDescriptor,n=Object.getOwnPropertyNames,i=Object.prototype.hasOwnProperty,o={},l={getVercelOidcToken:()=>c,getVercelOidcTokenSync:()=>m};for(var u in l)a(o,u,{get:l[u],enumerable:!0});t.exports=((e,t,r,o)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let l of n(t))i.call(e,l)||l===r||a(e,l,{get:()=>t[l],enumerable:!(o=s(t,l))||o.enumerable});return e})(a({},"__esModule",{value:!0}),o);var p=e.r(785734),d=e.r(291447);async function c(){let t,r="";try{r=m()}catch(e){t=e}try{let[{getTokenPayload:t,isExpired:a},{refreshToken:s}]=await Promise.all([await e.A(666263),await e.A(249241)]);(!r||a(t(r)))&&(await s(),r=m())}catch(r){let e=t instanceof Error?t.message:"";if(r instanceof Error&&(e=`${e}
${r.message}`),e)throw new d.VercelOidcTokenError(e);throw r}return r}function m(){let e=(0,p.getContext)().headers?.["x-vercel-oidc-token"]??process.env.VERCEL_OIDC_TOKEN;if(!e)throw Error("The 'x-vercel-oidc-token' header is missing from the request. Do you have the OIDC option enabled in the Vercel project settings?");return e}},609523,(e,t,r)=>{"use strict";var a=Object.defineProperty,s=Object.getOwnPropertyDescriptor,n=Object.getOwnPropertyNames,i=Object.prototype.hasOwnProperty,o={},l={getContext:()=>d.getContext,getVercelOidcToken:()=>p.getVercelOidcToken,getVercelOidcTokenSync:()=>p.getVercelOidcTokenSync};for(var u in l)a(o,u,{get:l[u],enumerable:!0});t.exports=((e,t,r,o)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let l of n(t))i.call(e,l)||l===r||a(e,l,{get:()=>t[l],enumerable:!(o=s(t,l))||o.enumerable});return e})(a({},"__esModule",{value:!0}),o);var p=e.r(501997),d=e.r(785734)},787645,e=>{"use strict";let t,r,a,s,n,i,o,l,u;e.i(908139);var p,d,c,m,g,h,f,y,v,b,w,k,_,I,S,x,T,E,A,O,z,M,P,R,C,j,N,L,D,q,$,F,U,Z,B,V,K,G,W,Q,J,H,Y,X,ee,et,er,ea,es,en,ei,eo,el,eu,ep,ed,ec,em,eg,eh,ef,ey,ev,eb,ew=e.i(441248),ek=e.i(447347),e_=e.i(398253),eI=e.i(710744),eS=e.i(837413),ex=e.i(296815),eT=e.i(208185),eE=e.i(680325),eA=e.i(372293),eO=e.i(376180),ez=e.i(359533),eM=e.i(101501),eP=e.i(588499),eR=e.i(649812),eC=e.i(193695);e.i(110668);var ej=e.i(997693),eN=e.i(127511),eL=e.i(782192),eD=e.i(185249);eL.MastraBase,eL.MastraBase;var eq=e.i(727480),e$=e.i(666106),eF=e.i(384810),eU=e.i(711998);e.i(910272);var eZ=e.i(62018),eB=e.i(639060),eV="vercel.ai.error",eK=Symbol.for(eV),eG=class e extends Error{constructor({name:e,message:t,cause:r}){super(t),this[ur]=!0,this.name=e,this.cause=r}static isInstance(t){return e.hasMarker(t,eV)}static hasMarker(e,t){let r=Symbol.for(t);return null!=e&&"object"==typeof e&&r in e&&"boolean"==typeof e[r]&&!0===e[r]}};ur=eK;var eW=eG,eQ="AI_APICallError",eJ=`vercel.ai.error.${eQ}`,eH=Symbol.for(eJ),eY=class extends eW{constructor({message:e,url:t,requestBodyValues:r,statusCode:a,responseHeaders:s,responseBody:n,cause:i,isRetryable:o=null!=a&&(408===a||409===a||429===a||a>=500),data:l}){super({name:eQ,message:e,cause:i}),this[ua]=!0,this.url=t,this.requestBodyValues=r,this.statusCode=a,this.responseHeaders=s,this.responseBody=n,this.isRetryable=o,this.data=l}static isInstance(e){return eW.hasMarker(e,eJ)}};ua=eH;var eX="AI_EmptyResponseBodyError",e0=`vercel.ai.error.${eX}`,e1=Symbol.for(e0),e2=class extends eW{constructor({message:e="Empty response body"}={}){super({name:eX,message:e}),this[us]=!0}static isInstance(e){return eW.hasMarker(e,e0)}};function e3(e){return null==e?"unknown error":"string"==typeof e?e:e instanceof Error?e.message:JSON.stringify(e)}us=e1;var e5="AI_InvalidArgumentError",e4=`vercel.ai.error.${e5}`,e6=Symbol.for(e4),e7=class extends eW{constructor({message:e,cause:t,argument:r}){super({name:e5,message:e,cause:t}),this[un]=!0,this.argument=r}static isInstance(e){return eW.hasMarker(e,e4)}};un=e6;var e9="AI_JSONParseError",e8=`vercel.ai.error.${e9}`,te=Symbol.for(e8),tt=class extends eW{constructor({text:e,cause:t}){super({name:e9,message:`JSON parsing failed: Text: ${e}.
Error message: ${e3(t)}`,cause:t}),this[ui]=!0,this.text=e}static isInstance(e){return eW.hasMarker(e,e8)}};ui=te;var tr="AI_TypeValidationError",ta=`vercel.ai.error.${tr}`,ts=Symbol.for(ta),tn=class e extends eW{constructor({value:e,cause:t}){super({name:tr,message:`Type validation failed: Value: ${JSON.stringify(e)}.
Error message: ${e3(t)}`,cause:t}),this[uo]=!0,this.value=e}static isInstance(e){return eW.hasMarker(e,ta)}static wrap({value:t,cause:r}){return e.isInstance(r)&&r.value===t?r:new e({value:t,cause:r})}};uo=ts;var ti=class extends Error{constructor(e,t){super(e),this.name="ParseError",this.type=t.type,this.field=t.field,this.value=t.value,this.line=t.line}};function to(e){}var tl=class extends TransformStream{constructor({onError:e,onRetry:t,onComment:r}={}){let a;super({start(s){a=function(e){if("function"==typeof e)throw TypeError("`callbacks` must be an object, got a function instead. Did you mean `{onEvent: fn}`?");let{onEvent:t=to,onError:r=to,onRetry:a=to,onComment:s}=e,n="",i=!0,o,l="",u="";function p(e){if(""===e)return void(l.length>0&&t({id:o,event:u||void 0,data:l.endsWith(`
`)?l.slice(0,-1):l}),o=void 0,l="",u="");if(e.startsWith(":")){s&&s(e.slice(e.startsWith(": ")?2:1));return}let r=e.indexOf(":");if(-1!==r){let t=e.slice(0,r),a=" "===e[r+1]?2:1;d(t,e.slice(r+a),e);return}d(e,"",e)}function d(e,t,s){switch(e){case"event":u=t;break;case"data":l=`${l}${t}
`;break;case"id":o=t.includes("\0")?void 0:t;break;case"retry":/^\d+$/.test(t)?a(parseInt(t,10)):r(new ti(`Invalid \`retry\` value: "${t}"`,{type:"invalid-retry",value:t,line:s}));break;default:r(new ti(`Unknown field "${e.length>20?`${e.slice(0,20)}\u2026`:e}"`,{type:"unknown-field",field:e,value:t,line:s}))}}return{feed:function(e){let t=i?e.replace(/^\xEF\xBB\xBF/,""):e,[r,a]=function(e){let t=[],r="",a=0;for(;a<e.length;){let s=e.indexOf("\r",a),n=e.indexOf(`
`,a),i=-1;if(-1!==s&&-1!==n?i=Math.min(s,n):-1!==s?i=s===e.length-1?-1:s:-1!==n&&(i=n),-1===i){r=e.slice(a);break}{let r=e.slice(a,i);t.push(r),"\r"===e[(a=i+1)-1]&&e[a]===`
`&&a++}}return[t,r]}(`${n}${t}`);for(let e of r)p(e);n=a,i=!1},reset:function(e={}){n&&e.consume&&p(n),i=!0,o=void 0,l="",u="",n=""}}}({onEvent:e=>{s.enqueue(e)},onError(t){"terminate"===e?s.error(t):"function"==typeof e&&e(t)},onRetry:t,onComment:r})},transform(e){a.feed(e)}})}};function tu(...e){return e.reduce((e,t)=>({...e,...null!=t?t:{}}),{})}function tp(e){return Object.fromEntries([...e.headers])}var td=({prefix:e,size:t=16,alphabet:r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",separator:a="-"}={})=>{let s=()=>{let e=r.length,a=Array(t);for(let s=0;s<t;s++)a[s]=r[Math.random()*e|0];return a.join("")};if(null==e)return s;if(r.includes(a))throw new e7({argument:"separator",message:`The separator "${a}" must not be part of the alphabet "${r}".`});return()=>`${e}${a}${s()}`},tc=td();function tm(e){return(e instanceof Error||e instanceof DOMException)&&("AbortError"===e.name||"ResponseAborted"===e.name||"TimeoutError"===e.name)}var tg=["fetch failed","failed to fetch"];function th({error:e,url:t,requestBodyValues:r}){if(tm(e))return e;if(e instanceof TypeError&&tg.includes(e.message.toLowerCase())){let a=e.cause;if(null!=a)return new eY({message:`Cannot connect to API: ${a.message}`,cause:a,url:t,requestBodyValues:r,isRetryable:!0})}return e}function tf(e=globalThis){var t,r,a;return e.window?"runtime/browser":(null==(t=e.navigator)?void 0:t.userAgent)?`runtime/${e.navigator.userAgent.toLowerCase()}`:(null==(a=null==(r=e.process)?void 0:r.versions)?void 0:a.node)?`runtime/node.js/${e.process.version.substring(0)}`:e.EdgeRuntime?"runtime/vercel-edge":"runtime/unknown"}function ty(e,...t){let r=new Headers(function(e){if(null==e)return{};let t={};if(e instanceof Headers)e.forEach((e,r)=>{t[r.toLowerCase()]=e});else for(let[r,a]of(Array.isArray(e)||(e=Object.entries(e)),e))null!=a&&(t[r.toLowerCase()]=a);return t}(e)),a=r.get("user-agent")||"";return r.set("user-agent",[a,...t].filter(Boolean).join(" ")),Object.fromEntries(r.entries())}var tv="3.0.17",tb=()=>globalThis.fetch,tw=async({url:e,headers:t={},successfulResponseHandler:r,failedResponseHandler:a,abortSignal:s,fetch:n=tb()})=>{try{let i=await n(e,{method:"GET",headers:ty(t,`ai-sdk/provider-utils/${tv}`,tf()),signal:s}),o=tp(i);if(!i.ok){let t;try{t=await a({response:i,url:e,requestBodyValues:{}})}catch(t){if(tm(t)||eY.isInstance(t))throw t;throw new eY({message:"Failed to process error response",cause:t,statusCode:i.status,url:e,responseHeaders:o,requestBodyValues:{}})}throw t.value}try{return await r({response:i,url:e,requestBodyValues:{}})}catch(t){if(t instanceof Error&&(tm(t)||eY.isInstance(t)))throw t;throw new eY({message:"Failed to process successful response",cause:t,statusCode:i.status,url:e,responseHeaders:o,requestBodyValues:{}})}}catch(t){throw th({error:t,url:e,requestBodyValues:{}})}};function tk({settingValue:e,environmentVariableName:t}){return"string"==typeof e?e:null!=e||"u"<typeof process?void 0:null!=(e=process.env[t])&&"string"==typeof e?e:void 0}var t_=/"__proto__"\s*:/,tI=/"constructor"\s*:/;function tS(e){let t=JSON.parse(e);return null===t||"object"!=typeof t||!1===t_.test(e)&&!1===tI.test(e)?t:function(e){let t=[e];for(;t.length;){let e=t;for(let r of(t=[],e)){if(Object.prototype.hasOwnProperty.call(r,"__proto__")||Object.prototype.hasOwnProperty.call(r,"constructor")&&Object.prototype.hasOwnProperty.call(r.constructor,"prototype"))throw SyntaxError("Object contains forbidden prototype property");for(let e in r){let a=r[e];a&&"object"==typeof a&&t.push(a)}}}return e}(t)}function tx(e){let{stackTraceLimit:t}=Error;try{Error.stackTraceLimit=0}catch(t){return tS(e)}try{return tS(e)}finally{Error.stackTraceLimit=t}}var tT=Symbol.for("vercel.ai.validator");function tE(e){let t;return()=>(null==t&&(t=e()),t)}async function tA({value:e,schema:t}){let r=await tO({value:e,schema:t});if(!r.success)throw tn.wrap({value:e,cause:r.error});return r.value}async function tO({value:e,schema:t}){var r;let a="object"==typeof t&&null!==t&&tT in t&&!0===t[tT]&&"validate"in t?t:"function"==typeof t?t():(r=t,{[tT]:!0,validate:async e=>{let t=await r["~standard"].validate(e);return null==t.issues?{success:!0,value:t.value}:{success:!1,error:new tn({value:e,cause:t.issues})}}});try{if(null==a.validate)return{success:!0,value:e,rawValue:e};let t=await a.validate(e);if(t.success)return{success:!0,value:t.value,rawValue:e};return{success:!1,error:tn.wrap({value:e,cause:t.error}),rawValue:e}}catch(t){return{success:!1,error:tn.wrap({value:e,cause:t}),rawValue:e}}}async function tz({text:e,schema:t}){try{let r=tx(e);if(null==t)return r;return tA({value:r,schema:t})}catch(t){if(tt.isInstance(t)||tn.isInstance(t))throw t;throw new tt({text:e,cause:t})}}async function tM({text:e,schema:t}){try{let r=tx(e);if(null==t)return{success:!0,value:r,rawValue:r};return await tO({value:r,schema:t})}catch(t){return{success:!1,error:tt.isInstance(t)?t:new tt({text:e,cause:t}),rawValue:void 0}}}var tP=()=>globalThis.fetch,tR=async({url:e,headers:t,body:r,failedResponseHandler:a,successfulResponseHandler:s,abortSignal:n,fetch:i})=>tC({url:e,headers:{"Content-Type":"application/json",...t},body:{content:JSON.stringify(r),values:r},failedResponseHandler:a,successfulResponseHandler:s,abortSignal:n,fetch:i}),tC=async({url:e,headers:t={},body:r,successfulResponseHandler:a,failedResponseHandler:s,abortSignal:n,fetch:i=tP()})=>{try{let o=await i(e,{method:"POST",headers:ty(t,`ai-sdk/provider-utils/${tv}`,tf()),body:r.content,signal:n}),l=tp(o);if(!o.ok){let t;try{t=await s({response:o,url:e,requestBodyValues:r.values})}catch(t){if(tm(t)||eY.isInstance(t))throw t;throw new eY({message:"Failed to process error response",cause:t,statusCode:o.status,url:e,responseHeaders:l,requestBodyValues:r.values})}throw t.value}try{return await a({response:o,url:e,requestBodyValues:r.values})}catch(t){if(t instanceof Error&&(tm(t)||eY.isInstance(t)))throw t;throw new eY({message:"Failed to process successful response",cause:t,statusCode:o.status,url:e,responseHeaders:l,requestBodyValues:r.values})}}catch(t){throw th({error:t,url:e,requestBodyValues:r.values})}};async function tj(e){return"function"==typeof e&&(e=e()),Promise.resolve(e)}var tN=({errorSchema:e,errorToMessage:t,isRetryable:r})=>async({response:a,url:s,requestBodyValues:n})=>{let i=await a.text(),o=tp(a);if(""===i.trim())return{responseHeaders:o,value:new eY({message:a.statusText,url:s,requestBodyValues:n,statusCode:a.status,responseHeaders:o,responseBody:i,isRetryable:null==r?void 0:r(a)})};try{let l=await tz({text:i,schema:e});return{responseHeaders:o,value:new eY({message:t(l),url:s,requestBodyValues:n,statusCode:a.status,responseHeaders:o,responseBody:i,data:l,isRetryable:null==r?void 0:r(a,l)})}}catch(e){return{responseHeaders:o,value:new eY({message:a.statusText,url:s,requestBodyValues:n,statusCode:a.status,responseHeaders:o,responseBody:i,isRetryable:null==r?void 0:r(a)})}}},tL=e=>async({response:t,url:r,requestBodyValues:a})=>{let s=await t.text(),n=await tM({text:s,schema:e}),i=tp(t);if(!n.success)throw new eY({message:"Invalid JSON response",cause:n.error,statusCode:t.status,responseHeaders:i,responseBody:s,url:r,requestBodyValues:a});return{responseHeaders:i,value:n.value,rawValue:n.rawValue}},tD=Symbol("Let zodToJsonSchema decide on which parser to use"),tq={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",allowedAdditionalProperties:!0,rejectedAdditionalProperties:!1,definitionPath:"definitions",strictUnions:!1,definitions:{},errorMessages:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"};function t$(e,t){return t7(e.type._def,t)}var tF=void 0,tU=/^[cC][^\s-]{8,}$/,tZ=/^[0-9a-z]+$/,tB=/^[0-9A-HJKMNP-TV-Z]{26}$/,tV=/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,tK=()=>(void 0===tF&&(tF=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),tF),tG=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,tW=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,tQ=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,tJ=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,tH=/^[a-zA-Z0-9_-]{21}$/,tY=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/;function tX(e,t){let r={type:"string"};if(e.checks)for(let a of e.checks)switch(a.kind){case"min":r.minLength="number"==typeof r.minLength?Math.max(r.minLength,a.value):a.value;break;case"max":r.maxLength="number"==typeof r.maxLength?Math.min(r.maxLength,a.value):a.value;break;case"email":switch(t.emailStrategy){case"format:email":t2(r,"email",a.message,t);break;case"format:idn-email":t2(r,"idn-email",a.message,t);break;case"pattern:zod":t3(r,tV,a.message,t)}break;case"url":t2(r,"uri",a.message,t);break;case"uuid":t2(r,"uuid",a.message,t);break;case"regex":t3(r,a.regex,a.message,t);break;case"cuid":t3(r,tU,a.message,t);break;case"cuid2":t3(r,tZ,a.message,t);break;case"startsWith":t3(r,RegExp(`^${t0(a.value,t)}`),a.message,t);break;case"endsWith":t3(r,RegExp(`${t0(a.value,t)}$`),a.message,t);break;case"datetime":t2(r,"date-time",a.message,t);break;case"date":t2(r,"date",a.message,t);break;case"time":t2(r,"time",a.message,t);break;case"duration":t2(r,"duration",a.message,t);break;case"length":r.minLength="number"==typeof r.minLength?Math.max(r.minLength,a.value):a.value,r.maxLength="number"==typeof r.maxLength?Math.min(r.maxLength,a.value):a.value;break;case"includes":t3(r,RegExp(t0(a.value,t)),a.message,t);break;case"ip":"v6"!==a.version&&t2(r,"ipv4",a.message,t),"v4"!==a.version&&t2(r,"ipv6",a.message,t);break;case"base64url":t3(r,tJ,a.message,t);break;case"jwt":t3(r,tY,a.message,t);break;case"cidr":"v6"!==a.version&&t3(r,tG,a.message,t),"v4"!==a.version&&t3(r,tW,a.message,t);break;case"emoji":t3(r,tK(),a.message,t);break;case"ulid":t3(r,tB,a.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":t2(r,"binary",a.message,t);break;case"contentEncoding:base64":r.contentEncoding="base64";break;case"pattern:zod":t3(r,tQ,a.message,t)}break;case"nanoid":t3(r,tH,a.message,t)}return r}function t0(e,t){return"escape"===t.patternStrategy?function(e){let t="";for(let r=0;r<e.length;r++)t1.has(e[r])||(t+="\\"),t+=e[r];return t}(e):e}var t1=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function t2(e,t,r,a){var s;e.format||(null==(s=e.anyOf)?void 0:s.some(e=>e.format))?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format}),delete e.format),e.anyOf.push({format:t,...r&&a.errorMessages&&{errorMessage:{format:r}}})):e.format=t}function t3(e,t,r,a){var s;e.pattern||(null==(s=e.allOf)?void 0:s.some(e=>e.pattern))?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern}),delete e.pattern),e.allOf.push({pattern:t5(t,a),...r&&a.errorMessages&&{errorMessage:{pattern:r}}})):e.pattern=t5(t,a)}function t5(e,t){var r;if(!t.applyRegexFlags||!e.flags)return e.source;let a={i:e.flags.includes("i"),m:e.flags.includes("m"),s:e.flags.includes("s")},s=a.i?e.source.toLowerCase():e.source,n="",i=!1,o=!1,l=!1;for(let e=0;e<s.length;e++){if(i){n+=s[e],i=!1;continue}if(a.i){if(o){if(s[e].match(/[a-z]/)){l?(n+=s[e],n+=`${s[e-2]}-${s[e]}`.toUpperCase(),l=!1):"-"===s[e+1]&&(null==(r=s[e+2])?void 0:r.match(/[a-z]/))?(n+=s[e],l=!0):n+=`${s[e]}${s[e].toUpperCase()}`;continue}}else if(s[e].match(/[a-z]/)){n+=`[${s[e]}${s[e].toUpperCase()}]`;continue}}if(a.m){if("^"===s[e]){n+=`(^|(?<=[\r
]))`;continue}else if("$"===s[e]){n+=`($|(?=[\r
]))`;continue}}if(a.s&&"."===s[e]){n+=o?`${s[e]}\r
`:`[${s[e]}\r
]`;continue}n+=s[e],"\\"===s[e]?i=!0:o&&"]"===s[e]?o=!1:o||"["!==s[e]||(o=!0)}return n}function t4(e,t){var r,a,s,n,i,o;let l={type:"object",additionalProperties:null!=(r=t7(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]}))?r:t.allowedAdditionalProperties};if((null==(a=e.keyType)?void 0:a._def.typeName)===eZ.ZodFirstPartyTypeKind.ZodString&&(null==(s=e.keyType._def.checks)?void 0:s.length)){let{type:r,...a}=tX(e.keyType._def,t);return{...l,propertyNames:a}}if((null==(n=e.keyType)?void 0:n._def.typeName)===eZ.ZodFirstPartyTypeKind.ZodEnum)return{...l,propertyNames:{enum:e.keyType._def.values}};if((null==(i=e.keyType)?void 0:i._def.typeName)===eZ.ZodFirstPartyTypeKind.ZodBranded&&e.keyType._def.type._def.typeName===eZ.ZodFirstPartyTypeKind.ZodString&&(null==(o=e.keyType._def.type._def.checks)?void 0:o.length)){let{type:r,...a}=t$(e.keyType._def,t);return{...l,propertyNames:a}}return l}var t6={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function t7(e,t,r=!1){var a;let s=t.seen.get(e);if(t.override){let n=null==(a=t.override)?void 0:a.call(t,e,t,s,r);if(n!==tD)return n}if(s&&!r){let e=t9(s,t);if(void 0!==e)return e}let n={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,n);let i=((e,t,r)=>{var a,s,n,i,o,l;switch(t){case eZ.ZodFirstPartyTypeKind.ZodString:return tX(e,r);case eZ.ZodFirstPartyTypeKind.ZodNumber:let u={type:"number"};if(!e.checks)return u;for(let t of e.checks)switch(t.kind){case"int":u.type="integer";break;case"min":t.inclusive?u.minimum=t.value:u.exclusiveMinimum=t.value;break;case"max":t.inclusive?u.maximum=t.value:u.exclusiveMaximum=t.value;break;case"multipleOf":u.multipleOf=t.value}return u;case eZ.ZodFirstPartyTypeKind.ZodObject:return function(e,t){let r={type:"object",properties:{}},a=[],s=e.shape();for(let e in s){let n=s[e];if(void 0===n||void 0===n._def)continue;let i=function(e){try{return e.isOptional()}catch(e){return!0}}(n),o=t7(n._def,{...t,currentPath:[...t.currentPath,"properties",e],propertyPath:[...t.currentPath,"properties",e]});void 0!==o&&(r.properties[e]=o,i||a.push(e))}a.length&&(r.required=a);let n=function(e,t){if("ZodNever"!==e.catchall._def.typeName)return t7(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]});switch(e.unknownKeys){case"passthrough":return t.allowedAdditionalProperties;case"strict":return t.rejectedAdditionalProperties;case"strip":return"strict"===t.removeAdditionalStrategy?t.allowedAdditionalProperties:t.rejectedAdditionalProperties}}(e,t);return void 0!==n&&(r.additionalProperties=n),r}(e,r);case eZ.ZodFirstPartyTypeKind.ZodBigInt:let p={type:"integer",format:"int64"};if(!e.checks)return p;for(let t of e.checks)switch(t.kind){case"min":t.inclusive?p.minimum=t.value:p.exclusiveMinimum=t.value;break;case"max":t.inclusive?p.maximum=t.value:p.exclusiveMaximum=t.value;break;case"multipleOf":p.multipleOf=t.value}return p;case eZ.ZodFirstPartyTypeKind.ZodBoolean:return{type:"boolean"};case eZ.ZodFirstPartyTypeKind.ZodDate:return function e(t,r,a){let s=null!=a?a:r.dateStrategy;if(Array.isArray(s))return{anyOf:s.map((a,s)=>e(t,r,a))};switch(s){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":var n=t;let i={type:"integer",format:"unix-time"};for(let e of n.checks)switch(e.kind){case"min":i.minimum=e.value;break;case"max":i.maximum=e.value}return i}}(e,r);case eZ.ZodFirstPartyTypeKind.ZodUndefined:return{not:{}};case eZ.ZodFirstPartyTypeKind.ZodNull:return{type:"null"};case eZ.ZodFirstPartyTypeKind.ZodArray:let d;return d={type:"array"},(null==(n=e.type)?void 0:n._def)&&(null==(o=null==(i=e.type)?void 0:i._def)?void 0:o.typeName)!==eZ.ZodFirstPartyTypeKind.ZodAny&&(d.items=t7(e.type._def,{...r,currentPath:[...r.currentPath,"items"]})),e.minLength&&(d.minItems=e.minLength.value),e.maxLength&&(d.maxItems=e.maxLength.value),e.exactLength&&(d.minItems=e.exactLength.value,d.maxItems=e.exactLength.value),d;case eZ.ZodFirstPartyTypeKind.ZodUnion:case eZ.ZodFirstPartyTypeKind.ZodDiscriminatedUnion:let c,m=e.options instanceof Map?Array.from(e.options.values()):e.options;if(m.every(e=>e._def.typeName in t6&&(!e._def.checks||!e._def.checks.length))){let e=m.reduce((e,t)=>{let r=t6[t._def.typeName];return r&&!e.includes(r)?[...e,r]:e},[]);return{type:e.length>1?e:e[0]}}if(m.every(e=>"ZodLiteral"===e._def.typeName&&!e.description)){let e=m.reduce((e,t)=>{let r=typeof t._def.value;switch(r){case"string":case"number":case"boolean":return[...e,r];case"bigint":return[...e,"integer"];case"object":if(null===t._def.value)return[...e,"null"];default:return e}},[]);if(e.length===m.length){let t=e.filter((e,t,r)=>r.indexOf(e)===t);return{type:t.length>1?t:t[0],enum:m.reduce((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value],[])}}}else if(m.every(e=>"ZodEnum"===e._def.typeName))return{type:"string",enum:m.reduce((e,t)=>[...e,...t._def.values.filter(t=>!e.includes(t))],[])};return a=e,s=r,(c=(a.options instanceof Map?Array.from(a.options.values()):a.options).map((e,t)=>t7(e._def,{...s,currentPath:[...s.currentPath,"anyOf",`${t}`]})).filter(e=>!!e&&(!s.strictUnions||"object"==typeof e&&Object.keys(e).length>0))).length?{anyOf:c}:void 0;case eZ.ZodFirstPartyTypeKind.ZodIntersection:let g,h;return g=[t7(e.left._def,{...r,currentPath:[...r.currentPath,"allOf","0"]}),t7(e.right._def,{...r,currentPath:[...r.currentPath,"allOf","1"]})].filter(e=>!!e),h=[],g.forEach(e=>{if((!("type"in e)||"string"!==e.type)&&"allOf"in e)h.push(...e.allOf);else{let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){let{additionalProperties:r,...a}=e;t=a}h.push(t)}}),h.length?{allOf:h}:void 0;case eZ.ZodFirstPartyTypeKind.ZodTuple:return e.rest?{type:"array",minItems:e.items.length,items:e.items.map((e,t)=>t7(e._def,{...r,currentPath:[...r.currentPath,"items",`${t}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[]),additionalItems:t7(e.rest._def,{...r,currentPath:[...r.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map((e,t)=>t7(e._def,{...r,currentPath:[...r.currentPath,"items",`${t}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[])};case eZ.ZodFirstPartyTypeKind.ZodRecord:return t4(e,r);case eZ.ZodFirstPartyTypeKind.ZodLiteral:let f;return"bigint"!=(f=typeof e.value)&&"number"!==f&&"boolean"!==f&&"string"!==f?{type:Array.isArray(e.value)?"array":"object"}:{type:"bigint"===f?"integer":f,const:e.value};case eZ.ZodFirstPartyTypeKind.ZodEnum:return{type:"string",enum:Array.from(e.values)};case eZ.ZodFirstPartyTypeKind.ZodNativeEnum:let y,v,b;return y=e.values,{type:1===(b=Array.from(new Set((v=Object.keys(e.values).filter(e=>"number"!=typeof y[y[e]]).map(e=>y[e])).map(e=>typeof e)))).length?"string"===b[0]?"string":"number":["string","number"],enum:v};case eZ.ZodFirstPartyTypeKind.ZodNullable:if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return{type:[t6[e.innerType._def.typeName],"null"]};let w=t7(e.innerType._def,{...r,currentPath:[...r.currentPath,"anyOf","0"]});return w&&{anyOf:[w,{type:"null"}]};case eZ.ZodFirstPartyTypeKind.ZodOptional:if(r.currentPath.toString()===(null==(l=r.propertyPath)?void 0:l.toString()))return t7(e.innerType._def,r);let k=t7(e.innerType._def,{...r,currentPath:[...r.currentPath,"anyOf","1"]});return k?{anyOf:[{not:{}},k]}:{};case eZ.ZodFirstPartyTypeKind.ZodMap:if("record"===r.mapStrategy)return t4(e,r);return{type:"array",maxItems:125,items:{type:"array",items:[t7(e.keyType._def,{...r,currentPath:[...r.currentPath,"items","items","0"]})||{},t7(e.valueType._def,{...r,currentPath:[...r.currentPath,"items","items","1"]})||{}],minItems:2,maxItems:2}};case eZ.ZodFirstPartyTypeKind.ZodSet:let _;return _={type:"array",uniqueItems:!0,items:t7(e.valueType._def,{...r,currentPath:[...r.currentPath,"items"]})},e.minSize&&(_.minItems=e.minSize.value),e.maxSize&&(_.maxItems=e.maxSize.value),_;case eZ.ZodFirstPartyTypeKind.ZodLazy:return()=>e.getter()._def;case eZ.ZodFirstPartyTypeKind.ZodPromise:return t7(e.type._def,r);case eZ.ZodFirstPartyTypeKind.ZodNaN:case eZ.ZodFirstPartyTypeKind.ZodNever:return{not:{}};case eZ.ZodFirstPartyTypeKind.ZodEffects:return"input"===r.effectStrategy?t7(e.schema._def,r):{};case eZ.ZodFirstPartyTypeKind.ZodAny:case eZ.ZodFirstPartyTypeKind.ZodUnknown:return{};case eZ.ZodFirstPartyTypeKind.ZodDefault:return{...t7(e.innerType._def,r),default:e.defaultValue()};case eZ.ZodFirstPartyTypeKind.ZodBranded:return t$(e,r);case eZ.ZodFirstPartyTypeKind.ZodReadonly:case eZ.ZodFirstPartyTypeKind.ZodCatch:return t7(e.innerType._def,r);case eZ.ZodFirstPartyTypeKind.ZodPipeline:if("input"===r.pipeStrategy)return t7(e.in._def,r);if("output"===r.pipeStrategy)return t7(e.out._def,r);let I=t7(e.in._def,{...r,currentPath:[...r.currentPath,"allOf","0"]}),S=t7(e.out._def,{...r,currentPath:[...r.currentPath,"allOf",I?"1":"0"]});return{allOf:[I,S].filter(e=>void 0!==e)};case eZ.ZodFirstPartyTypeKind.ZodFunction:case eZ.ZodFirstPartyTypeKind.ZodVoid:case eZ.ZodFirstPartyTypeKind.ZodSymbol:default:return}})(e,e.typeName,t),o="function"==typeof i?t7(i(),t):i;if(o&&t8(e,t,o),t.postProcess){let r=t.postProcess(o,e,t);return n.jsonSchema=o,r}return n.jsonSchema=o,o}var t9=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"relative":return{$ref:((e,t)=>{let r=0;for(;r<e.length&&r<t.length&&e[r]===t[r];r++);return[(e.length-r).toString(),...t.slice(r)].join("/")})(t.currentPath,e.path)};case"none":case"seen":if(e.path.length<t.currentPath.length&&e.path.every((e,r)=>t.currentPath[r]===e))return console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),{};return"seen"===t.$refStrategy?{}:void 0}},t8=(e,t,r)=>(e.description&&(r.description=e.description),r);function re(e,t){var r,a;let s;if("_zod"in e){let a;return a=null!=(r=null==t?void 0:t.useReferences)&&r,rr(()=>eF.toJSONSchema(e,{target:"draft-7",io:"output",reused:a?"ref":"inline"}),{validate:async t=>{let r=await e$.safeParseAsync(e,t);return r.success?{success:!0,value:r.data}:{success:!1,error:r.error}}})}return s=null!=(a=null==t?void 0:t.useReferences)&&a,rr(()=>((e,t)=>{var r;let a,s,n=(s=void 0!==(a="string"==typeof t?{...tq,name:t}:{...tq,...t}).name?[...a.basePath,a.definitionPath,a.name]:a.basePath,{...a,currentPath:s,propertyPath:void 0,seen:new Map(Object.entries(a.definitions).map(([e,t])=>[t._def,{def:t._def,path:[...a.basePath,a.definitionPath,e],jsonSchema:void 0}]))}),i="object"==typeof t&&t.definitions?Object.entries(t.definitions).reduce((e,[t,r])=>{var a;return{...e,[t]:null!=(a=t7(r._def,{...n,currentPath:[...n.basePath,n.definitionPath,t]},!0))?a:{}}},{}):void 0,o="string"==typeof t?t:(null==t?void 0:t.nameStrategy)==="title"||null==t?void 0:t.name,l=null!=(r=t7(e._def,void 0===o?n:{...n,currentPath:[...n.basePath,n.definitionPath,o]},!1))?r:{},u="object"==typeof t&&void 0!==t.name&&"title"===t.nameStrategy?t.name:void 0;void 0!==u&&(l.title=u);let p=void 0===o?i?{...l,[n.definitionPath]:i}:l:{$ref:[..."relative"===n.$refStrategy?[]:n.basePath,n.definitionPath,o].join("/"),[n.definitionPath]:{...i,[o]:l}};return p.$schema="http://json-schema.org/draft-07/schema#",p})(e,{$refStrategy:s?"root":"none"}),{validate:async t=>{let r=await e.safeParseAsync(t);return r.success?{success:!0,value:r.data}:{success:!1,error:r.error}}})}var rt=Symbol.for("vercel.ai.schema");function rr(e,{validate:t}={}){return{[rt]:!0,_type:void 0,[tT]:!0,get jsonSchema(){return"function"==typeof e&&(e=e()),e},validate:t}}function ra(e){return null==e?rr({properties:{},additionalProperties:!1}):"object"==typeof e&&null!==e&&rt in e&&!0===e[rt]&&"jsonSchema"in e&&"validate"in e?e:"function"==typeof e?e():re(e)}var{btoa:rs,atob:rn}=globalThis,ri=(0,eB.__commonJS)({"../../../node_modules/.pnpm/@vercel+oidc@3.0.5/node_modules/@vercel/oidc/dist/get-context.js"(e,t){var r=Object.defineProperty,a=Object.getOwnPropertyDescriptor,s=Object.getOwnPropertyNames,n=Object.prototype.hasOwnProperty,i={},o={SYMBOL_FOR_REQ_CONTEXT:()=>u,getContext:()=>p};for(var l in o)r(i,l,{get:o[l],enumerable:!0});t.exports=((e,t,i,o)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let l of s(t))n.call(e,l)||l===i||r(e,l,{get:()=>t[l],enumerable:!(o=a(t,l))||o.enumerable});return e})(r({},"__esModule",{value:!0}),i);var u=Symbol.for("@vercel/request-context");function p(){let e=globalThis;return e[u]?.get?.()??{}}}}),ro=(0,eB.__commonJS)({"../../../node_modules/.pnpm/@vercel+oidc@3.0.5/node_modules/@vercel/oidc/dist/get-vercel-oidc-token.js"(t,r){var a=Object.defineProperty,s=Object.getOwnPropertyDescriptor,n=Object.getOwnPropertyNames,i=Object.prototype.hasOwnProperty,o={},l={getVercelOidcToken:()=>c,getVercelOidcTokenSync:()=>m};for(var u in l)a(o,u,{get:l[u],enumerable:!0});r.exports=((e,t,r,o)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let l of n(t))i.call(e,l)||l===r||a(e,l,{get:()=>t[l],enumerable:!(o=s(t,l))||o.enumerable});return e})(a({},"__esModule",{value:!0}),o);var p=ri(),d=(0,eB.require_token_error)();async function c(){let t,r="";try{r=m()}catch(e){t=e}try{let[{getTokenPayload:t,isExpired:a},{refreshToken:s}]=await Promise.all([await e.A(741324),await e.A(321766)]);(!r||a(t(r)))&&(await s(),r=m())}catch(e){throw t?.message&&e instanceof Error&&(e.message=`${t.message}
${e.message}`),new d.VercelOidcTokenError("Failed to refresh OIDC token",e)}return r}function m(){let e=(0,p.getContext)().headers?.["x-vercel-oidc-token"]??process.env.VERCEL_OIDC_TOKEN;if(!e)throw Error("The 'x-vercel-oidc-token' header is missing from the request. Do you have the OIDC option enabled in the Vercel project settings?");return e}}}),rl=(0,eB.__commonJS)({"../../../node_modules/.pnpm/@vercel+oidc@3.0.5/node_modules/@vercel/oidc/dist/index.js"(e,t){var r=Object.defineProperty,a=Object.getOwnPropertyDescriptor,s=Object.getOwnPropertyNames,n=Object.prototype.hasOwnProperty,i={},o={getContext:()=>p.getContext,getVercelOidcToken:()=>u.getVercelOidcToken,getVercelOidcTokenSync:()=>u.getVercelOidcTokenSync};for(var l in o)r(i,l,{get:o[l],enumerable:!0});t.exports=((e,t,i,o)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let l of s(t))n.call(e,l)||l===i||r(e,l,{get:()=>t[l],enumerable:!(o=a(t,l))||o.enumerable});return e})(r({},"__esModule",{value:!0}),i);var u=ro(),p=ri()}}),ru=(0,eB.__toESM)(rl(),1),rp=(0,eB.__toESM)(rl(),1),rd=Symbol.for("vercel.ai.gateway.error"),rc=class e extends(uu=Error,ul=rd,uu){constructor({message:e,statusCode:t=500,cause:r}){super(e),this[ul]=!0,this.statusCode=t,this.cause=r}static isInstance(t){return e.hasMarker(t)}static hasMarker(e){return"object"==typeof e&&null!==e&&rd in e&&!0===e[rd]}},rm="GatewayAuthenticationError",rg=Symbol.for(`vercel.ai.gateway.error.${rm}`),rh=class e extends(ud=rc,up=rg,ud){constructor({message:e="Authentication failed",statusCode:t=401,cause:r}={}){super({message:e,statusCode:t,cause:r}),this[up]=!0,this.name=rm,this.type="authentication_error"}static isInstance(e){return rc.hasMarker(e)&&rg in e}static createContextualError({apiKeyProvided:t,oidcTokenProvided:r,message:a="Authentication failed",statusCode:s=401,cause:n}){return new e({message:t?`AI Gateway authentication failed: Invalid API key.

Create a new API key: https://vercel.com/d?to=%2F%5Bteam%5D%2F%7E%2Fai%2Fapi-keys

Provide via 'apiKey' option or 'AI_GATEWAY_API_KEY' environment variable.`:r?`AI Gateway authentication failed: Invalid OIDC token.

Run 'npx vercel link' to link your project, then 'vc env pull' to fetch the token.

Alternatively, use an API key: https://vercel.com/d?to=%2F%5Bteam%5D%2F%7E%2Fai%2Fapi-keys`:`AI Gateway authentication failed: No authentication provided.

Option 1 - API key:
Create an API key: https://vercel.com/d?to=%2F%5Bteam%5D%2F%7E%2Fai%2Fapi-keys
Provide via 'apiKey' option or 'AI_GATEWAY_API_KEY' environment variable.

Option 2 - OIDC token:
Run 'npx vercel link' to link your project, then 'vc env pull' to fetch the token.`,statusCode:s,cause:n})}},rf="GatewayInvalidRequestError",ry=Symbol.for(`vercel.ai.gateway.error.${rf}`),rv=class extends(um=rc,uc=ry,um){constructor({message:e="Invalid request",statusCode:t=400,cause:r}={}){super({message:e,statusCode:t,cause:r}),this[uc]=!0,this.name=rf,this.type="invalid_request_error"}static isInstance(e){return rc.hasMarker(e)&&ry in e}},rb="GatewayRateLimitError",rw=Symbol.for(`vercel.ai.gateway.error.${rb}`),rk=class extends(uh=rc,ug=rw,uh){constructor({message:e="Rate limit exceeded",statusCode:t=429,cause:r}={}){super({message:e,statusCode:t,cause:r}),this[ug]=!0,this.name=rb,this.type="rate_limit_exceeded"}static isInstance(e){return rc.hasMarker(e)&&rw in e}},r_="GatewayModelNotFoundError",rI=Symbol.for(`vercel.ai.gateway.error.${r_}`),rS=tE(()=>re(eU.z.object({modelId:eU.z.string()}))),rx=class extends(uy=rc,uf=rI,uy){constructor({message:e="Model not found",statusCode:t=404,modelId:r,cause:a}={}){super({message:e,statusCode:t,cause:a}),this[uf]=!0,this.name=r_,this.type="model_not_found",this.modelId=r}static isInstance(e){return rc.hasMarker(e)&&rI in e}},rT="GatewayInternalServerError",rE=Symbol.for(`vercel.ai.gateway.error.${rT}`),rA=class extends(ub=rc,uv=rE,ub){constructor({message:e="Internal server error",statusCode:t=500,cause:r}={}){super({message:e,statusCode:t,cause:r}),this[uv]=!0,this.name=rT,this.type="internal_server_error"}static isInstance(e){return rc.hasMarker(e)&&rE in e}},rO="GatewayResponseError",rz=Symbol.for(`vercel.ai.gateway.error.${rO}`),rM=class extends(uk=rc,uw=rz,uk){constructor({message:e="Invalid response from Gateway",statusCode:t=502,response:r,validationError:a,cause:s}={}){super({message:e,statusCode:t,cause:s}),this[uw]=!0,this.name=rO,this.type="response_error",this.response=r,this.validationError=a}static isInstance(e){return rc.hasMarker(e)&&rz in e}};async function rP({response:e,statusCode:t,defaultMessage:r="Gateway request failed",cause:a,authMethod:s}){let n=await tO({value:e,schema:rR});if(!n.success)return new rM({message:`Invalid error response format: ${r}`,statusCode:t,response:e,validationError:n.error,cause:a});let i=n.value,o=i.error.type,l=i.error.message;switch(o){case"authentication_error":return rh.createContextualError({apiKeyProvided:"api-key"===s,oidcTokenProvided:"oidc"===s,statusCode:t,cause:a});case"invalid_request_error":return new rv({message:l,statusCode:t,cause:a});case"rate_limit_exceeded":return new rk({message:l,statusCode:t,cause:a});case"model_not_found":{let e=await tO({value:i.error.param,schema:rS});return new rx({message:l,statusCode:t,modelId:e.success?e.value.modelId:void 0,cause:a})}default:return new rA({message:l,statusCode:t,cause:a})}}var rR=tE(()=>re(eU.z.object({error:eU.z.object({message:eU.z.string(),type:eU.z.string().nullish(),param:eU.z.unknown().nullish(),code:eU.z.union([eU.z.string(),eU.z.number()]).nullish()})})));function rC(e,t){var r;return rc.isInstance(e)?e:eY.isInstance(e)?rP({response:function(e){if(void 0!==e.data)return e.data;if(null!=e.responseBody)try{return JSON.parse(e.responseBody)}catch(t){return e.responseBody}return{}}(e),statusCode:null!=(r=e.statusCode)?r:500,defaultMessage:"Gateway request failed",cause:e,authMethod:t}):rP({response:{},statusCode:500,defaultMessage:e instanceof Error?`Gateway request failed: ${e.message}`:"Unknown Gateway error",cause:e,authMethod:t})}var rj="ai-gateway-auth-method";async function rN(e){let t=await tO({value:e[rj],schema:rL});return t.success?t.value:void 0}var rL=tE(()=>re(eU.z.union([eU.z.literal("api-key"),eU.z.literal("oidc")]))),rD=class{constructor(e){this.config=e}async getAvailableModels(){try{let{value:e}=await tw({url:`${this.config.baseURL}/config`,headers:await tj(this.config.headers()),successfulResponseHandler:tL(rq),failedResponseHandler:tN({errorSchema:eU.z.any(),errorToMessage:e=>e}),fetch:this.config.fetch});return e}catch(e){throw await rC(e)}}async getCredits(){try{let e=new URL(this.config.baseURL),{value:t}=await tw({url:`${e.origin}/v1/credits`,headers:await tj(this.config.headers()),successfulResponseHandler:tL(r$),failedResponseHandler:tN({errorSchema:eU.z.any(),errorToMessage:e=>e}),fetch:this.config.fetch});return t}catch(e){throw await rC(e)}}},rq=tE(()=>re(eU.z.object({models:eU.z.array(eU.z.object({id:eU.z.string(),name:eU.z.string(),description:eU.z.string().nullish(),pricing:eU.z.object({input:eU.z.string(),output:eU.z.string(),input_cache_read:eU.z.string().nullish(),input_cache_write:eU.z.string().nullish()}).transform(({input:e,output:t,input_cache_read:r,input_cache_write:a})=>({input:e,output:t,...r?{cachedInputTokens:r}:{},...a?{cacheCreationInputTokens:a}:{}})).nullish(),specification:eU.z.object({specificationVersion:eU.z.literal("v2"),provider:eU.z.string(),modelId:eU.z.string()}),modelType:eU.z.enum(["language","embedding","image"]).nullish()}))}))),r$=tE(()=>re(eU.z.object({balance:eU.z.string(),total_used:eU.z.string()}).transform(({balance:e,total_used:t})=>({balance:e,totalUsed:t})))),rF=class{constructor(e,t){this.modelId=e,this.config=t,this.specificationVersion="v2",this.supportedUrls={"*/*":[/.*/]}}get provider(){return this.config.provider}async getArgs(e){let{abortSignal:t,...r}=e;return{args:this.maybeEncodeFileParts(r),warnings:[]}}async doGenerate(e){let{args:t,warnings:r}=await this.getArgs(e),{abortSignal:a}=e,s=await tj(this.config.headers());try{let{responseHeaders:n,value:i,rawValue:o}=await tR({url:this.getUrl(),headers:tu(s,e.headers,this.getModelConfigHeaders(this.modelId,!1),await tj(this.config.o11yHeaders)),body:t,successfulResponseHandler:tL(eU.z.any()),failedResponseHandler:tN({errorSchema:eU.z.any(),errorToMessage:e=>e}),...a&&{abortSignal:a},fetch:this.config.fetch});return{...i,request:{body:t},response:{headers:n,body:o},warnings:r}}catch(e){throw await rC(e,await rN(s))}}async doStream(e){let{args:t,warnings:r}=await this.getArgs(e),{abortSignal:a}=e,s=await tj(this.config.headers());try{let n,{value:i,responseHeaders:o}=await tR({url:this.getUrl(),headers:tu(s,e.headers,this.getModelConfigHeaders(this.modelId,!0),await tj(this.config.o11yHeaders)),body:t,successfulResponseHandler:(n=eU.z.any(),async({response:e})=>{let t=tp(e);if(null==e.body)throw new e2({});return{responseHeaders:t,value:function({stream:e,schema:t}){return e.pipeThrough(new TextDecoderStream).pipeThrough(new tl).pipeThrough(new TransformStream({async transform({data:e},r){"[DONE]"!==e&&r.enqueue(await tM({text:e,schema:t}))}}))}({stream:e.body,schema:n})}}),failedResponseHandler:tN({errorSchema:eU.z.any(),errorToMessage:e=>e}),...a&&{abortSignal:a},fetch:this.config.fetch});return{stream:i.pipeThrough(new TransformStream({start(e){r.length>0&&e.enqueue({type:"stream-start",warnings:r})},transform(t,r){if(t.success){let a=t.value;("raw"!==a.type||e.includeRawChunks)&&("response-metadata"===a.type&&a.timestamp&&"string"==typeof a.timestamp&&(a.timestamp=new Date(a.timestamp)),r.enqueue(a))}else r.error(t.error)}})),request:{body:t},response:{headers:o}}}catch(e){throw await rC(e,await rN(s))}}isFilePart(e){return e&&"object"==typeof e&&"type"in e&&"file"===e.type}maybeEncodeFileParts(e){for(let t of e.prompt)for(let e of t.content)if(this.isFilePart(e)&&e.data instanceof Uint8Array){let t=Uint8Array.from(e.data),r=Buffer.from(t).toString("base64");e.data=new URL(`data:${e.mediaType||"application/octet-stream"};base64,${r}`)}return e}getUrl(){return`${this.config.baseURL}/language-model`}getModelConfigHeaders(e,t){return{"ai-language-model-specification-version":"2","ai-language-model-id":e,"ai-language-model-streaming":String(t)}}},rU=class{constructor(e,t){this.modelId=e,this.config=t,this.specificationVersion="v2",this.maxEmbeddingsPerCall=2048,this.supportsParallelCalls=!0}get provider(){return this.config.provider}async doEmbed({values:e,headers:t,abortSignal:r,providerOptions:a}){var s;let n=await tj(this.config.headers());try{let{responseHeaders:i,value:o,rawValue:l}=await tR({url:this.getUrl(),headers:tu(n,null!=t?t:{},this.getModelConfigHeaders(),await tj(this.config.o11yHeaders)),body:{input:1===e.length?e[0]:e,...a?{providerOptions:a}:{}},successfulResponseHandler:tL(rZ),failedResponseHandler:tN({errorSchema:eU.z.any(),errorToMessage:e=>e}),...r&&{abortSignal:r},fetch:this.config.fetch});return{embeddings:o.embeddings,usage:null!=(s=o.usage)?s:void 0,providerMetadata:o.providerMetadata,response:{headers:i,body:l}}}catch(e){throw await rC(e,await rN(n))}}getUrl(){return`${this.config.baseURL}/embedding-model`}getModelConfigHeaders(){return{"ai-embedding-model-specification-version":"2","ai-model-id":this.modelId}}},rZ=tE(()=>re(eU.z.object({embeddings:eU.z.array(eU.z.array(eU.z.number())),usage:eU.z.object({tokens:eU.z.number()}).nullish(),providerMetadata:eU.z.record(eU.z.string(),eU.z.record(eU.z.string(),eU.z.unknown())).optional()}))),rB=class{constructor(e,t){this.modelId=e,this.config=t,this.specificationVersion="v2",this.maxImagesPerCall=Number.MAX_SAFE_INTEGER}get provider(){return this.config.provider}async doGenerate({prompt:e,n:t,size:r,aspectRatio:a,seed:s,providerOptions:n,headers:i,abortSignal:o}){var l;let u=await tj(this.config.headers());try{let{responseHeaders:p,value:d}=await tR({url:this.getUrl(),headers:tu(u,null!=i?i:{},this.getModelConfigHeaders(),await tj(this.config.o11yHeaders)),body:{prompt:e,n:t,...r&&{size:r},...a&&{aspectRatio:a},...s&&{seed:s},...n&&{providerOptions:n}},successfulResponseHandler:tL(rK),failedResponseHandler:tN({errorSchema:eU.z.any(),errorToMessage:e=>e}),...o&&{abortSignal:o},fetch:this.config.fetch});return{images:d.images,warnings:null!=(l=d.warnings)?l:[],providerMetadata:d.providerMetadata,response:{timestamp:new Date,modelId:this.modelId,headers:p}}}catch(e){throw rC(e,await rN(u))}}getUrl(){return`${this.config.baseURL}/image-model`}getModelConfigHeaders(){return{"ai-image-model-specification-version":"2","ai-model-id":this.modelId}}},rV=eU.z.object({images:eU.z.array(eU.z.unknown()).optional()}).catchall(eU.z.unknown()),rK=eU.z.object({images:eU.z.array(eU.z.string()),warnings:eU.z.array(eU.z.object({type:eU.z.literal("other"),message:eU.z.string()})).optional(),providerMetadata:eU.z.record(eU.z.string(),rV).optional()});async function rG(){var e;return null==(e=(0,ru.getContext)().headers)?void 0:e["x-vercel-id"]}async function rW(e){let t=tk({settingValue:e.apiKey,environmentVariableName:"AI_GATEWAY_API_KEY"});if(t)return{token:t,authMethod:"api-key"};try{return{token:await (0,rp.getVercelOidcToken)(),authMethod:"oidc"}}catch(e){return null}}!function(e={}){var t,r,a;let s=null,n=null,i=null!=(t=e.metadataCacheRefreshMillis)?t:3e5,o=0,l=null!=(r=null==(a=e.baseURL)?void 0:a.replace(/\/$/,""))?r:"https://ai-gateway.vercel.sh/v1/ai",u=async()=>{let t=await rW(e);if(t)return ty({Authorization:`Bearer ${t.token}`,"ai-gateway-protocol-version":"0.0.1",[rj]:t.authMethod,...e.headers},"ai-sdk/gateway/2.0.15");throw rh.createContextualError({apiKeyProvided:!1,oidcTokenProvided:!1,statusCode:401})},p=()=>{let e=tk({settingValue:void 0,environmentVariableName:"VERCEL_DEPLOYMENT_ID"}),t=tk({settingValue:void 0,environmentVariableName:"VERCEL_ENV"}),r=tk({settingValue:void 0,environmentVariableName:"VERCEL_REGION"});return async()=>{let a=await rG();return{...e&&{"ai-o11y-deployment-id":e},...t&&{"ai-o11y-environment":t},...r&&{"ai-o11y-region":r},...a&&{"ai-o11y-request-id":a}}}},d=t=>new rF(t,{provider:"gateway",baseURL:l,headers:u,fetch:e.fetch,o11yHeaders:p()}),c=async()=>new rD({baseURL:l,headers:u,fetch:e.fetch}).getCredits().catch(async e=>{throw await rC(e,await rN(await u()))}),m=function(e){if(new.target)throw Error("The Gateway Provider model function cannot be called with the new keyword.");return d(e)};m.getAvailableModels=async()=>{var t,r,a;let p=null!=(a=null==(r=null==(t=e._internal)?void 0:t.currentDate)?void 0:r.call(t).getTime())?a:Date.now();return(!s||p-o>i)&&(o=p,s=new rD({baseURL:l,headers:u,fetch:e.fetch}).getAvailableModels().then(e=>(n=e,e)).catch(async e=>{throw await rC(e,await rN(await u()))})),n?Promise.resolve(n):s},m.getCredits=c,m.imageModel=t=>new rB(t,{provider:"gateway",baseURL:l,headers:u,fetch:e.fetch,o11yHeaders:p()}),m.languageModel=d,m.textEmbeddingModel=t=>new rU(t,{provider:"gateway",baseURL:l,headers:u,fetch:e.fetch,o11yHeaders:p()})}();var rQ="object"==typeof globalThis?globalThis:e.g,rJ="1.9.0",rH=/^(\d+)\.(\d+)\.(\d+)(-(.+))?$/,rY=function(e){var t=new Set([e]),r=new Set,a=e.match(rH);if(!a)return function(){return!1};var s={major:+a[1],minor:+a[2],patch:+a[3],prerelease:a[4]};if(null!=s.prerelease)return function(t){return t===e};function n(e){return r.add(e),!1}return function(e){if(t.has(e))return!0;if(r.has(e))return!1;var a=e.match(rH);if(!a)return n(e);var i={major:+a[1],minor:+a[2],patch:+a[3],prerelease:a[4]};if(null!=i.prerelease||s.major!==i.major)return n(e);if(0===s.major)return s.minor===i.minor&&s.patch<=i.patch?(t.add(e),!0):n(e);return s.minor<=i.minor?(t.add(e),!0):n(e)}}(rJ),rX=Symbol.for("opentelemetry.js.api."+rJ.split(".")[0]);function r0(e,t,r,a){void 0===a&&(a=!1);var s,n=rQ[rX]=null!=(s=rQ[rX])?s:{version:rJ};if(!a&&n[e]){var i=Error("@opentelemetry/api: Attempted duplicate registration of API: "+e);return r.error(i.stack||i.message),!1}if(n.version!==rJ){var i=Error("@opentelemetry/api: Registration of version v"+n.version+" for "+e+" does not match previously registered API v"+rJ);return r.error(i.stack||i.message),!1}return n[e]=t,r.debug("@opentelemetry/api: Registered a global for "+e+" v"+rJ+"."),!0}function r1(e){var t,r,a=null==(t=rQ[rX])?void 0:t.version;if(a&&rY(a))return null==(r=rQ[rX])?void 0:r[e]}function r2(e,t){t.debug("@opentelemetry/api: Unregistering a global for "+e+" v"+rJ+".");var r=rQ[rX];r&&delete r[e]}var r3=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var a,s,n=r.call(e),i=[];try{for(;!(a=n.next()).done;)i.push(a.value)}catch(e){s={error:e}}finally{try{a&&!a.done&&(r=n.return)&&r.call(n)}finally{if(s)throw s.error}}return i},r5=function(e,t,r){if(2==arguments.length)for(var a,s=0,n=t.length;s<n;s++)!a&&s in t||(a||(a=Array.prototype.slice.call(t,0,s)),a[s]=t[s]);return e.concat(a||Array.prototype.slice.call(t))},r4=function(){function e(e){this._namespace=e.namespace||"DiagComponentLogger"}return e.prototype.debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return r6("debug",this._namespace,e)},e.prototype.error=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return r6("error",this._namespace,e)},e.prototype.info=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return r6("info",this._namespace,e)},e.prototype.warn=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return r6("warn",this._namespace,e)},e.prototype.verbose=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return r6("verbose",this._namespace,e)},e}();function r6(e,t,r){var a=r1("diag");if(a)return r.unshift(t),a[e].apply(a,r5([],r3(r),!1))}(l6=u_||(u_={}))[l6.NONE=0]="NONE",l6[l6.ERROR=30]="ERROR",l6[l6.WARN=50]="WARN",l6[l6.INFO=60]="INFO",l6[l6.DEBUG=70]="DEBUG",l6[l6.VERBOSE=80]="VERBOSE",l6[l6.ALL=9999]="ALL";var r7=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var a,s,n=r.call(e),i=[];try{for(;!(a=n.next()).done;)i.push(a.value)}catch(e){s={error:e}}finally{try{a&&!a.done&&(r=n.return)&&r.call(n)}finally{if(s)throw s.error}}return i},r9=function(e,t,r){if(2==arguments.length)for(var a,s=0,n=t.length;s<n;s++)!a&&s in t||(a||(a=Array.prototype.slice.call(t,0,s)),a[s]=t[s]);return e.concat(a||Array.prototype.slice.call(t))},r8=function(){function e(){function e(e){return function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var a=r1("diag");if(a)return a[e].apply(a,r9([],r7(t),!1))}}var t=this;t.setLogger=function(e,r){if(void 0===r&&(r={logLevel:u_.INFO}),e===t){var a,s,n,i=Error("Cannot use diag as the logger for itself. Please use a DiagLogger implementation like ConsoleDiagLogger or a custom implementation");return t.error(null!=(a=i.stack)?a:i.message),!1}"number"==typeof r&&(r={logLevel:r});var o=r1("diag"),l=function(e,t){function r(r,a){var s=t[r];return"function"==typeof s&&e>=a?s.bind(t):function(){}}return e<u_.NONE?e=u_.NONE:e>u_.ALL&&(e=u_.ALL),t=t||{},{error:r("error",u_.ERROR),warn:r("warn",u_.WARN),info:r("info",u_.INFO),debug:r("debug",u_.DEBUG),verbose:r("verbose",u_.VERBOSE)}}(null!=(s=r.logLevel)?s:u_.INFO,e);if(o&&!r.suppressOverrideMessage){var u=null!=(n=Error().stack)?n:"<failed to generate stacktrace>";o.warn("Current logger will be overwritten from "+u),l.warn("Current logger will overwrite one already registered from "+u)}return r0("diag",l,t,!0)},t.disable=function(){r2("diag",t)},t.createComponentLogger=function(e){return new r4(e)},t.verbose=e("verbose"),t.debug=e("debug"),t.info=e("info"),t.warn=e("warn"),t.error=e("error")}return e.instance=function(){return this._instance||(this._instance=new e),this._instance},e}(),ae=new function e(t){var r=this;r._currentContext=t?new Map(t):new Map,r.getValue=function(e){return r._currentContext.get(e)},r.setValue=function(t,a){var s=new e(r._currentContext);return s._currentContext.set(t,a),s},r.deleteValue=function(t){var a=new e(r._currentContext);return a._currentContext.delete(t),a}},at=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var a,s,n=r.call(e),i=[];try{for(;!(a=n.next()).done;)i.push(a.value)}catch(e){s={error:e}}finally{try{a&&!a.done&&(r=n.return)&&r.call(n)}finally{if(s)throw s.error}}return i},ar=function(e,t,r){if(2==arguments.length)for(var a,s=0,n=t.length;s<n;s++)!a&&s in t||(a||(a=Array.prototype.slice.call(t,0,s)),a[s]=t[s]);return e.concat(a||Array.prototype.slice.call(t))},aa=function(){function e(){}return e.prototype.active=function(){return ae},e.prototype.with=function(e,t,r){for(var a=[],s=3;s<arguments.length;s++)a[s-3]=arguments[s];return t.call.apply(t,ar([r],at(a),!1))},e.prototype.bind=function(e,t){return t},e.prototype.enable=function(){return this},e.prototype.disable=function(){return this},e}(),as=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var a,s,n=r.call(e),i=[];try{for(;!(a=n.next()).done;)i.push(a.value)}catch(e){s={error:e}}finally{try{a&&!a.done&&(r=n.return)&&r.call(n)}finally{if(s)throw s.error}}return i},an=function(e,t,r){if(2==arguments.length)for(var a,s=0,n=t.length;s<n;s++)!a&&s in t||(a||(a=Array.prototype.slice.call(t,0,s)),a[s]=t[s]);return e.concat(a||Array.prototype.slice.call(t))},ai="context",ao=new aa,al=function(){function e(){}return e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.setGlobalContextManager=function(e){return r0(ai,e,r8.instance())},e.prototype.active=function(){return this._getContextManager().active()},e.prototype.with=function(e,t,r){for(var a,s=[],n=3;n<arguments.length;n++)s[n-3]=arguments[n];return(a=this._getContextManager()).with.apply(a,an([e,t,r],as(s),!1))},e.prototype.bind=function(e,t){return this._getContextManager().bind(e,t)},e.prototype._getContextManager=function(){return r1(ai)||ao},e.prototype.disable=function(){this._getContextManager().disable(),r2(ai,r8.instance())},e}();(l7=uI||(uI={}))[l7.NONE=0]="NONE",l7[l7.SAMPLED=1]="SAMPLED";var au="0000000000000000",ap="00000000000000000000000000000000",ad={traceId:ap,spanId:au,traceFlags:uI.NONE},ac=function(){function e(e){void 0===e&&(e=ad),this._spanContext=e}return e.prototype.spanContext=function(){return this._spanContext},e.prototype.setAttribute=function(e,t){return this},e.prototype.setAttributes=function(e){return this},e.prototype.addEvent=function(e,t){return this},e.prototype.addLink=function(e){return this},e.prototype.addLinks=function(e){return this},e.prototype.setStatus=function(e){return this},e.prototype.updateName=function(e){return this},e.prototype.end=function(e){},e.prototype.isRecording=function(){return!1},e.prototype.recordException=function(e,t){},e}(),am=Symbol.for("OpenTelemetry Context Key SPAN");function ag(e){return e.getValue(am)||void 0}function ah(){return ag(al.getInstance().active())}function af(e,t){return e.setValue(am,t)}function ay(e){return e.deleteValue(am)}function av(e,t){return af(e,new ac(t))}function ab(e){var t;return null==(t=ag(e))?void 0:t.spanContext()}var aw=/^([0-9a-f]{32})$/i,ak=/^[0-9a-f]{16}$/i;function a_(e){var t,r;return t=e.traceId,aw.test(t)&&t!==ap&&(r=e.spanId,ak.test(r)&&r!==au)}function aI(e){return new ac(e)}var aS=al.getInstance(),ax=function(){function e(){}return e.prototype.startSpan=function(e,t,r){if(void 0===r&&(r=aS.active()),null==t?void 0:t.root)return new ac;var a,s=r&&ab(r);return"object"==typeof(a=s)&&"string"==typeof a.spanId&&"string"==typeof a.traceId&&"number"==typeof a.traceFlags&&a_(s)?new ac(s):new ac},e.prototype.startActiveSpan=function(e,t,r,a){if(!(arguments.length<2)){2==arguments.length?i=t:3==arguments.length?(s=t,i=r):(s=t,n=r,i=a);var s,n,i,o=null!=n?n:aS.active(),l=this.startSpan(e,s,o),u=af(o,l);return aS.with(u,i,void 0,l)}},e}(),aT=new ax,aE=function(){function e(e,t,r,a){this._provider=e,this.name=t,this.version=r,this.options=a}return e.prototype.startSpan=function(e,t,r){return this._getTracer().startSpan(e,t,r)},e.prototype.startActiveSpan=function(e,t,r,a){var s=this._getTracer();return Reflect.apply(s.startActiveSpan,s,arguments)},e.prototype._getTracer=function(){if(this._delegate)return this._delegate;var e=this._provider.getDelegateTracer(this.name,this.version,this.options);return e?(this._delegate=e,this._delegate):aT},e}(),aA=new(function(){function e(){}return e.prototype.getTracer=function(e,t,r){return new ax},e}()),aO=function(){function e(){}return e.prototype.getTracer=function(e,t,r){var a;return null!=(a=this.getDelegateTracer(e,t,r))?a:new aE(this,e,t,r)},e.prototype.getDelegate=function(){var e;return null!=(e=this._delegate)?e:aA},e.prototype.setDelegate=function(e){this._delegate=e},e.prototype.getDelegateTracer=function(e,t,r){var a;return null==(a=this._delegate)?void 0:a.getTracer(e,t,r)},e}();(l9=uS||(uS={}))[l9.UNSET=0]="UNSET",l9[l9.OK=1]="OK",l9[l9.ERROR=2]="ERROR";var az="trace";(function(){function e(){this._proxyTracerProvider=new aO,this.wrapSpanContext=aI,this.isSpanContextValid=a_,this.deleteSpan=ay,this.getSpan=ag,this.getActiveSpan=ah,this.getSpanContext=ab,this.setSpan=af,this.setSpanContext=av}return e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.setGlobalTracerProvider=function(e){var t=r0(az,this._proxyTracerProvider,r8.instance());return t&&this._proxyTracerProvider.setDelegate(e),t},e.prototype.getTracerProvider=function(){return r1(az)||this._proxyTracerProvider},e.prototype.getTracer=function(e,t){return this.getTracerProvider().getTracer(e,t)},e.prototype.disable=function(){r2(az,r8.instance()),this._proxyTracerProvider=new aO},e})().getInstance();var aM=Object.defineProperty,aP=(Symbol.for("vercel.ai.error.AI_InvalidArgumentError"),"AI_NoObjectGeneratedError"),aR=`vercel.ai.error.${aP}`,aC=Symbol.for(aR),aj=class extends eW{constructor({message:e="No object generated.",cause:t,text:r,response:a,usage:s,finishReason:n}){super({name:aP,message:e,cause:t}),this[ux]=!0,this.text=r,this.response=a,this.usage=s,this.finishReason=n}static isInstance(e){return eW.hasMarker(e,aR)}};ux=aC,Symbol.for("vercel.ai.error.AI_InvalidDataContentError");var aN="AI_MessageConversionError",aL=`vercel.ai.error.${aN}`,aD=Symbol.for(aL),aq=class extends eW{constructor({originalMessage:e,message:t}){super({name:aN,message:t}),this[uT]=!0,this.originalMessage=e}static isInstance(e){return eW.hasMarker(e,aL)}};uT=aD,Symbol.for("vercel.ai.error.AI_DownloadError"),Symbol.for("vercel.ai.error.AI_RetryError");var a$=eU.z.union([eU.z.string(),eU.z.instanceof(Uint8Array),eU.z.instanceof(ArrayBuffer),eU.z.custom(e=>{var t,r;return null!=(r=null==(t=globalThis.Buffer)?void 0:t.isBuffer(e))&&r},{message:"Must be a Buffer"})]),aF=eU.z.lazy(()=>eU.z.union([eU.z.null(),eU.z.string(),eU.z.number(),eU.z.boolean(),eU.z.record(eU.z.string(),aF),eU.z.array(aF)])),aU=eU.z.record(eU.z.string(),eU.z.record(eU.z.string(),aF)),aZ=eU.z.object({type:eU.z.literal("text"),text:eU.z.string(),providerOptions:aU.optional()}),aB=eU.z.object({type:eU.z.literal("image"),image:eU.z.union([a$,eU.z.instanceof(URL)]),mediaType:eU.z.string().optional(),providerOptions:aU.optional()}),aV=eU.z.object({type:eU.z.literal("file"),data:eU.z.union([a$,eU.z.instanceof(URL)]),filename:eU.z.string().optional(),mediaType:eU.z.string(),providerOptions:aU.optional()}),aK=eU.z.object({type:eU.z.literal("reasoning"),text:eU.z.string(),providerOptions:aU.optional()}),aG=eU.z.object({type:eU.z.literal("tool-call"),toolCallId:eU.z.string(),toolName:eU.z.string(),input:eU.z.unknown(),providerOptions:aU.optional(),providerExecuted:eU.z.boolean().optional()}),aW=eU.z.discriminatedUnion("type",[eU.z.object({type:eU.z.literal("text"),value:eU.z.string()}),eU.z.object({type:eU.z.literal("json"),value:aF}),eU.z.object({type:eU.z.literal("error-text"),value:eU.z.string()}),eU.z.object({type:eU.z.literal("error-json"),value:aF}),eU.z.object({type:eU.z.literal("content"),value:eU.z.array(eU.z.union([eU.z.object({type:eU.z.literal("text"),text:eU.z.string()}),eU.z.object({type:eU.z.literal("media"),data:eU.z.string(),mediaType:eU.z.string()})]))})]),aQ=eU.z.object({type:eU.z.literal("tool-result"),toolCallId:eU.z.string(),toolName:eU.z.string(),output:aW,providerOptions:aU.optional()}),aJ=eU.z.object({role:eU.z.literal("system"),content:eU.z.string(),providerOptions:aU.optional()}),aH=eU.z.object({role:eU.z.literal("user"),content:eU.z.union([eU.z.string(),eU.z.array(eU.z.union([aZ,aB,aV]))]),providerOptions:aU.optional()}),aY=eU.z.object({role:eU.z.literal("assistant"),content:eU.z.union([eU.z.string(),eU.z.array(eU.z.union([aZ,aV,aK,aG,aQ]))]),providerOptions:aU.optional()}),aX=eU.z.object({role:eU.z.literal("tool"),content:eU.z.array(aQ),providerOptions:aU.optional()});function a0(e){return({steps:t})=>t.length===e}function a1({output:e,tool:t,errorMode:r}){return"text"===r?{type:"error-text",value:e3(e)}:"json"===r?{type:"error-json",value:a2(e)}:(null==t?void 0:t.toModelOutput)?t.toModelOutput(e):"string"==typeof e?{type:"text",value:e}:{type:"json",value:a2(e)}}function a2(e){return void 0===e?null:e}async function a3(e){if(void 0===e)return{value:void 0,state:"undefined-input"};let t=await tM({text:e});return t.success?{value:t.value,state:"successful-parse"}:(t=await tM({text:function(e){let t=["ROOT"],r=-1,a=null;function s(e,s,n){switch(e){case'"':r=s,t.pop(),t.push(n),t.push("INSIDE_STRING");break;case"f":case"t":case"n":r=s,a=s,t.pop(),t.push(n),t.push("INSIDE_LITERAL");break;case"-":t.pop(),t.push(n),t.push("INSIDE_NUMBER");break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":r=s,t.pop(),t.push(n),t.push("INSIDE_NUMBER");break;case"{":r=s,t.pop(),t.push(n),t.push("INSIDE_OBJECT_START");break;case"[":r=s,t.pop(),t.push(n),t.push("INSIDE_ARRAY_START")}}function n(e,a){switch(e){case",":t.pop(),t.push("INSIDE_OBJECT_AFTER_COMMA");break;case"}":r=a,t.pop()}}function i(e,a){switch(e){case",":t.pop(),t.push("INSIDE_ARRAY_AFTER_COMMA");break;case"]":r=a,t.pop()}}for(let o=0;o<e.length;o++){let l=e[o];switch(t[t.length-1]){case"ROOT":s(l,o,"FINISH");break;case"INSIDE_OBJECT_START":switch(l){case'"':t.pop(),t.push("INSIDE_OBJECT_KEY");break;case"}":r=o,t.pop()}break;case"INSIDE_OBJECT_AFTER_COMMA":'"'===l&&(t.pop(),t.push("INSIDE_OBJECT_KEY"));break;case"INSIDE_OBJECT_KEY":'"'===l&&(t.pop(),t.push("INSIDE_OBJECT_AFTER_KEY"));break;case"INSIDE_OBJECT_AFTER_KEY":":"===l&&(t.pop(),t.push("INSIDE_OBJECT_BEFORE_VALUE"));break;case"INSIDE_OBJECT_BEFORE_VALUE":s(l,o,"INSIDE_OBJECT_AFTER_VALUE");break;case"INSIDE_OBJECT_AFTER_VALUE":n(l,o);break;case"INSIDE_STRING":switch(l){case'"':t.pop(),r=o;break;case"\\":t.push("INSIDE_STRING_ESCAPE");break;default:r=o}break;case"INSIDE_ARRAY_START":"]"===l?(r=o,t.pop()):(r=o,s(l,o,"INSIDE_ARRAY_AFTER_VALUE"));break;case"INSIDE_ARRAY_AFTER_VALUE":switch(l){case",":t.pop(),t.push("INSIDE_ARRAY_AFTER_COMMA");break;case"]":r=o,t.pop();break;default:r=o}break;case"INSIDE_ARRAY_AFTER_COMMA":s(l,o,"INSIDE_ARRAY_AFTER_VALUE");break;case"INSIDE_STRING_ESCAPE":t.pop(),r=o;break;case"INSIDE_NUMBER":switch(l){case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":r=o;break;case"e":case"E":case"-":case".":break;case",":t.pop(),"INSIDE_ARRAY_AFTER_VALUE"===t[t.length-1]&&i(l,o),"INSIDE_OBJECT_AFTER_VALUE"===t[t.length-1]&&n(l,o);break;case"}":t.pop(),"INSIDE_OBJECT_AFTER_VALUE"===t[t.length-1]&&n(l,o);break;case"]":t.pop(),"INSIDE_ARRAY_AFTER_VALUE"===t[t.length-1]&&i(l,o);break;default:t.pop()}break;case"INSIDE_LITERAL":{let s=e.substring(a,o+1);"false".startsWith(s)||"true".startsWith(s)||"null".startsWith(s)?r=o:(t.pop(),"INSIDE_OBJECT_AFTER_VALUE"===t[t.length-1]?n(l,o):"INSIDE_ARRAY_AFTER_VALUE"===t[t.length-1]&&i(l,o))}}}let o=e.slice(0,r+1);for(let r=t.length-1;r>=0;r--)switch(t[r]){case"INSIDE_STRING":o+='"';break;case"INSIDE_OBJECT_KEY":case"INSIDE_OBJECT_AFTER_KEY":case"INSIDE_OBJECT_AFTER_COMMA":case"INSIDE_OBJECT_START":case"INSIDE_OBJECT_BEFORE_VALUE":case"INSIDE_OBJECT_AFTER_VALUE":o+="}";break;case"INSIDE_ARRAY_START":case"INSIDE_ARRAY_AFTER_COMMA":case"INSIDE_ARRAY_AFTER_VALUE":o+="]";break;case"INSIDE_LITERAL":{let t=e.substring(a,e.length);"true".startsWith(t)?o+="true".slice(t.length):"false".startsWith(t)?o+="false".slice(t.length):"null".startsWith(t)&&(o+="null".slice(t.length))}}return o}(e)})).success?{value:t.value,state:"repaired-parse"}:{value:void 0,state:"failed-parse"}}function a5(e){return e.type.startsWith("data-")}function a4(e){return"text"===e.type}function a6(e){return"file"===e.type}function a7(e){return"reasoning"===e.type}function a9(e){return e.type.startsWith("tool-")}function a8(e){return"dynamic-tool"===e.type}eU.z.union([aJ,aH,aY,aX]),td({prefix:"aitxt",size:24}),tE(()=>re(eU.z.union([eU.z.strictObject({type:eU.z.literal("text-start"),id:eU.z.string(),providerMetadata:aU.optional()}),eU.z.strictObject({type:eU.z.literal("text-delta"),id:eU.z.string(),delta:eU.z.string(),providerMetadata:aU.optional()}),eU.z.strictObject({type:eU.z.literal("text-end"),id:eU.z.string(),providerMetadata:aU.optional()}),eU.z.strictObject({type:eU.z.literal("error"),errorText:eU.z.string()}),eU.z.strictObject({type:eU.z.literal("tool-input-start"),toolCallId:eU.z.string(),toolName:eU.z.string(),providerExecuted:eU.z.boolean().optional(),dynamic:eU.z.boolean().optional()}),eU.z.strictObject({type:eU.z.literal("tool-input-delta"),toolCallId:eU.z.string(),inputTextDelta:eU.z.string()}),eU.z.strictObject({type:eU.z.literal("tool-input-available"),toolCallId:eU.z.string(),toolName:eU.z.string(),input:eU.z.unknown(),providerExecuted:eU.z.boolean().optional(),providerMetadata:aU.optional(),dynamic:eU.z.boolean().optional()}),eU.z.strictObject({type:eU.z.literal("tool-input-error"),toolCallId:eU.z.string(),toolName:eU.z.string(),input:eU.z.unknown(),providerExecuted:eU.z.boolean().optional(),providerMetadata:aU.optional(),dynamic:eU.z.boolean().optional(),errorText:eU.z.string()}),eU.z.strictObject({type:eU.z.literal("tool-output-available"),toolCallId:eU.z.string(),output:eU.z.unknown(),providerExecuted:eU.z.boolean().optional(),dynamic:eU.z.boolean().optional(),preliminary:eU.z.boolean().optional()}),eU.z.strictObject({type:eU.z.literal("tool-output-error"),toolCallId:eU.z.string(),errorText:eU.z.string(),providerExecuted:eU.z.boolean().optional(),dynamic:eU.z.boolean().optional()}),eU.z.strictObject({type:eU.z.literal("reasoning-start"),id:eU.z.string(),providerMetadata:aU.optional()}),eU.z.strictObject({type:eU.z.literal("reasoning-delta"),id:eU.z.string(),delta:eU.z.string(),providerMetadata:aU.optional()}),eU.z.strictObject({type:eU.z.literal("reasoning-end"),id:eU.z.string(),providerMetadata:aU.optional()}),eU.z.strictObject({type:eU.z.literal("source-url"),sourceId:eU.z.string(),url:eU.z.string(),title:eU.z.string().optional(),providerMetadata:aU.optional()}),eU.z.strictObject({type:eU.z.literal("source-document"),sourceId:eU.z.string(),mediaType:eU.z.string(),title:eU.z.string(),filename:eU.z.string().optional(),providerMetadata:aU.optional()}),eU.z.strictObject({type:eU.z.literal("file"),url:eU.z.string(),mediaType:eU.z.string(),providerMetadata:aU.optional()}),eU.z.strictObject({type:eU.z.custom(e=>"string"==typeof e&&e.startsWith("data-"),{message:'Type must start with "data-"'}),id:eU.z.string().optional(),data:eU.z.unknown(),transient:eU.z.boolean().optional()}),eU.z.strictObject({type:eU.z.literal("start-step")}),eU.z.strictObject({type:eU.z.literal("finish-step")}),eU.z.strictObject({type:eU.z.literal("start"),messageId:eU.z.string().optional(),messageMetadata:eU.z.unknown().optional()}),eU.z.strictObject({type:eU.z.literal("finish"),finishReason:eU.z.enum(["stop","length","content-filter","tool-calls","error","other","unknown"]).optional(),messageMetadata:eU.z.unknown().optional()}),eU.z.strictObject({type:eU.z.literal("abort")}),eU.z.strictObject({type:eU.z.literal("message-metadata"),messageMetadata:eU.z.unknown()})])));function se(e){return e.type.split("-").slice(1).join("-")}function st(e,t){let r=[];for(let s of((null==t?void 0:t.ignoreIncompleteToolCalls)&&(e=e.map(e=>({...e,parts:e.parts.filter(e=>!(a9(e)||a8(e))||"input-streaming"!==e.state&&"input-available"!==e.state)}))),e))switch(s.role){case"system":{let e=s.parts.filter(e=>"text"===e.type),t=e.reduce((e,t)=>null!=t.providerMetadata?{...e,...t.providerMetadata}:e,{});r.push({role:"system",content:e.map(e=>e.text).join(""),...Object.keys(t).length>0?{providerOptions:t}:{}});break}case"user":r.push({role:"user",content:s.parts.map(e=>{var r;return a4(e)?{type:"text",text:e.text,...null!=e.providerMetadata?{providerOptions:e.providerMetadata}:{}}:a6(e)?{type:"file",mediaType:e.mediaType,filename:e.filename,data:e.url,...null!=e.providerMetadata?{providerOptions:e.providerMetadata}:{}}:a5(e)?null==(r=null==t?void 0:t.convertDataPart)?void 0:r.call(t,e):void 0}).filter(e=>null!=e)});break;case"assistant":if(null!=s.parts){let e=function(){var e,a,s;if(0===n.length)return;let i=[];for(let r of n)if(a4(r))i.push({type:"text",text:r.text,...null!=r.providerMetadata?{providerOptions:r.providerMetadata}:{}});else if(a6(r))i.push({type:"file",mediaType:r.mediaType,filename:r.filename,data:r.url});else if(a7(r))i.push({type:"reasoning",text:r.text,providerOptions:r.providerMetadata});else if(a8(r)){let e=r.toolName;"input-streaming"!==r.state&&i.push({type:"tool-call",toolCallId:r.toolCallId,toolName:e,input:r.input,...null!=r.callProviderMetadata?{providerOptions:r.callProviderMetadata}:{}})}else if(a9(r)){let s=se(r);"input-streaming"!==r.state&&(i.push({type:"tool-call",toolCallId:r.toolCallId,toolName:s,input:"output-error"===r.state?null!=(e=r.input)?e:r.rawInput:r.input,providerExecuted:r.providerExecuted,...null!=r.callProviderMetadata?{providerOptions:r.callProviderMetadata}:{}}),!0===r.providerExecuted&&("output-available"===r.state||"output-error"===r.state)&&i.push({type:"tool-result",toolCallId:r.toolCallId,toolName:s,output:a1({output:"output-error"===r.state?r.errorText:r.output,tool:null==(a=null==t?void 0:t.tools)?void 0:a[s],errorMode:"output-error"===r.state?"json":"none"})}))}else if(a5(r)){let e=null==(s=null==t?void 0:t.convertDataPart)?void 0:s.call(t,r);null!=e&&i.push(e)}else throw Error(`Unsupported part: ${r}`);r.push({role:"assistant",content:i});let o=n.filter(e=>a9(e)&&!0!==e.providerExecuted||"dynamic-tool"===e.type);o.length>0&&r.push({role:"tool",content:o.map(e=>{var r;switch(e.state){case"output-error":case"output-available":{let a=a8(e)?e.toolName:se(e);return{type:"tool-result",toolCallId:e.toolCallId,toolName:a,output:a1({output:"output-error"===e.state?e.errorText:e.output,tool:null==(r=null==t?void 0:t.tools)?void 0:r[a],errorMode:"output-error"===e.state?"text":"none"})}}default:return null}}).filter(e=>null!=e)}),n=[]},n=[];for(let t of s.parts){var a;a4(t)||a7(t)||a6(t)||a9(a=t)||a8(a)||a5(t)?n.push(t):"step-start"===t.type&&e()}e()}break;default:{let e=s.role;throw new aq({originalMessage:s,message:`Unsupported role: ${e}`})}}return r}function sr(e,t){if(e===t)return!0;if(null==e||null==t)return!1;if("object"!=typeof e&&"object"!=typeof t)return e===t;if(e.constructor!==t.constructor)return!1;if(e instanceof Date&&t instanceof Date)return e.getTime()===t.getTime();if(Array.isArray(e)){if(e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(!sr(e[r],t[r]))return!1;return!0}let r=Object.keys(e),a=Object.keys(t);if(r.length!==a.length)return!1;for(let s of r)if(!a.includes(s)||!sr(e[s],t[s]))return!1;return!0}td({prefix:"aitxt",size:24}),td({prefix:"aiobj",size:24}),td({prefix:"aiobj",size:24});var sa={},ss={object:()=>so,text:()=>si};for(var sn in ss)aM(sa,sn,{get:ss[sn],enumerable:!0});var si=()=>({type:"text",responseFormat:{type:"text"},parsePartial:async({text:e})=>({partial:e}),parseOutput:async({text:e})=>e}),so=({schema:e})=>{let t=ra(e);return{type:"object",responseFormat:{type:"json",schema:t.jsonSchema},async parsePartial({text:e}){let t=await a3(e);switch(t.state){case"failed-parse":case"undefined-input":return;case"repaired-parse":case"successful-parse":return{partial:t.value};default:{let e=t.state;throw Error(`Unsupported parse state: ${e}`)}}},async parseOutput({text:e},r){let a=await tM({text:e});if(!a.success)throw new aj({message:"No object generated: could not parse the response.",cause:a.error,text:e,response:r.response,usage:r.usage,finishReason:r.finishReason});let s=await tO({value:a.value,schema:t});if(!s.success)throw new aj({message:"No object generated: response did not match schema.",cause:s.error,text:e,response:r.response,usage:r.usage,finishReason:r.finishReason});return s.value}}};tE(()=>re(eU.z.array(eU.z.object({id:eU.z.string(),role:eU.z.enum(["system","user","assistant"]),metadata:eU.z.unknown().optional(),parts:eU.z.array(eU.z.union([eU.z.object({type:eU.z.literal("text"),text:eU.z.string(),state:eU.z.enum(["streaming","done"]).optional(),providerMetadata:aU.optional()}),eU.z.object({type:eU.z.literal("reasoning"),text:eU.z.string(),state:eU.z.enum(["streaming","done"]).optional(),providerMetadata:aU.optional()}),eU.z.object({type:eU.z.literal("source-url"),sourceId:eU.z.string(),url:eU.z.string(),title:eU.z.string().optional(),providerMetadata:aU.optional()}),eU.z.object({type:eU.z.literal("source-document"),sourceId:eU.z.string(),mediaType:eU.z.string(),title:eU.z.string(),filename:eU.z.string().optional(),providerMetadata:aU.optional()}),eU.z.object({type:eU.z.literal("file"),mediaType:eU.z.string(),filename:eU.z.string().optional(),url:eU.z.string(),providerMetadata:aU.optional()}),eU.z.object({type:eU.z.literal("step-start")}),eU.z.object({type:eU.z.string().startsWith("data-"),id:eU.z.string().optional(),data:eU.z.unknown()}),eU.z.object({type:eU.z.literal("dynamic-tool"),toolName:eU.z.string(),toolCallId:eU.z.string(),state:eU.z.literal("input-streaming"),input:eU.z.unknown().optional(),providerExecuted:eU.z.boolean().optional(),output:eU.z.never().optional(),errorText:eU.z.never().optional()}),eU.z.object({type:eU.z.literal("dynamic-tool"),toolName:eU.z.string(),toolCallId:eU.z.string(),state:eU.z.literal("input-available"),input:eU.z.unknown(),providerExecuted:eU.z.boolean().optional(),output:eU.z.never().optional(),errorText:eU.z.never().optional(),callProviderMetadata:aU.optional()}),eU.z.object({type:eU.z.literal("dynamic-tool"),toolName:eU.z.string(),toolCallId:eU.z.string(),state:eU.z.literal("output-available"),input:eU.z.unknown(),providerExecuted:eU.z.boolean().optional(),output:eU.z.unknown(),errorText:eU.z.never().optional(),callProviderMetadata:aU.optional(),preliminary:eU.z.boolean().optional()}),eU.z.object({type:eU.z.literal("dynamic-tool"),toolName:eU.z.string(),toolCallId:eU.z.string(),state:eU.z.literal("output-error"),input:eU.z.unknown(),providerExecuted:eU.z.boolean().optional(),output:eU.z.never().optional(),errorText:eU.z.string(),callProviderMetadata:aU.optional()}),eU.z.object({type:eU.z.string().startsWith("tool-"),toolCallId:eU.z.string(),state:eU.z.literal("input-streaming"),providerExecuted:eU.z.boolean().optional(),input:eU.z.unknown().optional(),output:eU.z.never().optional(),errorText:eU.z.never().optional(),approval:eU.z.never().optional()}),eU.z.object({type:eU.z.string().startsWith("tool-"),toolCallId:eU.z.string(),state:eU.z.literal("input-available"),providerExecuted:eU.z.boolean().optional(),input:eU.z.unknown(),output:eU.z.never().optional(),errorText:eU.z.never().optional(),callProviderMetadata:aU.optional(),approval:eU.z.never().optional()}),eU.z.object({type:eU.z.string().startsWith("tool-"),toolCallId:eU.z.string(),state:eU.z.literal("approval-requested"),input:eU.z.unknown(),providerExecuted:eU.z.boolean().optional(),output:eU.z.never().optional(),errorText:eU.z.never().optional(),callProviderMetadata:aU.optional(),approval:eU.z.object({id:eU.z.string(),approved:eU.z.never().optional(),reason:eU.z.never().optional()})}),eU.z.object({type:eU.z.string().startsWith("tool-"),toolCallId:eU.z.string(),state:eU.z.literal("approval-responded"),input:eU.z.unknown(),providerExecuted:eU.z.boolean().optional(),output:eU.z.never().optional(),errorText:eU.z.never().optional(),callProviderMetadata:aU.optional(),approval:eU.z.object({id:eU.z.string(),approved:eU.z.boolean(),reason:eU.z.string().optional()})}),eU.z.object({type:eU.z.string().startsWith("tool-"),toolCallId:eU.z.string(),state:eU.z.literal("output-available"),providerExecuted:eU.z.boolean().optional(),input:eU.z.unknown(),output:eU.z.unknown(),errorText:eU.z.never().optional(),callProviderMetadata:aU.optional(),preliminary:eU.z.boolean().optional(),approval:eU.z.object({id:eU.z.string(),approved:eU.z.literal(!0),reason:eU.z.string().optional()}).optional()}),eU.z.object({type:eU.z.string().startsWith("tool-"),toolCallId:eU.z.string(),state:eU.z.literal("output-error"),providerExecuted:eU.z.boolean().optional(),input:eU.z.unknown(),output:eU.z.never().optional(),errorText:eU.z.string(),callProviderMetadata:aU.optional(),approval:eU.z.object({id:eU.z.string(),approved:eU.z.literal(!0),reason:eU.z.string().optional()}).optional()}),eU.z.object({type:eU.z.string().startsWith("tool-"),toolCallId:eU.z.string(),state:eU.z.literal("output-denied"),providerExecuted:eU.z.boolean().optional(),input:eU.z.unknown(),output:eU.z.never().optional(),errorText:eU.z.never().optional(),callProviderMetadata:aU.optional(),approval:eU.z.object({id:eU.z.string(),approved:eU.z.literal(!1),reason:eU.z.string().optional()})})])).nonempty("Message must contain at least one part")})).nonempty("Messages array must not be empty")));var sl=eL;e.i(688947);var su=class extends sl.MastraBase{listeningModel;speechModel;speaker;realtimeConfig;constructor({listeningModel:e,speechModel:t,speaker:r,realtimeConfig:a,name:s}={}){super({component:"VOICE",name:s}),this.listeningModel=e,this.speechModel=t,this.speaker=r,this.realtimeConfig=a}updateConfig(e){this.logger.warn("updateConfig not implemented by this voice provider")}connect(e){return this.logger.warn("connect not implemented by this voice provider"),Promise.resolve()}send(e){return this.logger.warn("relay not implemented by this voice provider"),Promise.resolve()}answer(e){return this.logger.warn("answer not implemented by this voice provider"),Promise.resolve()}addInstructions(e){}addTools(e){}close(){this.logger.warn("close not implemented by this voice provider")}on(e,t){this.logger.warn("on not implemented by this voice provider")}off(e,t){this.logger.warn("off not implemented by this voice provider")}getSpeakers(){return this.logger.warn("getSpeakers not implemented by this voice provider"),Promise.resolve([])}getListener(){return this.logger.warn("getListener not implemented by this voice provider"),Promise.resolve({enabled:!1})}},sp=class extends su{constructor(){super()}async speak(e){throw new eN.MastraError({id:"VOICE_DEFAULT_NO_SPEAK_PROVIDER",text:"No voice provider configured",domain:"MASTRA_VOICE",category:"USER"})}async listen(e){throw new eN.MastraError({id:"VOICE_DEFAULT_NO_LISTEN_PROVIDER",text:"No voice provider configured",domain:"MASTRA_VOICE",category:"USER"})}async getSpeakers(){throw new eN.MastraError({id:"VOICE_DEFAULT_NO_SPEAKERS_PROVIDER",text:"No voice provider configured",domain:"MASTRA_VOICE",category:"USER"})}async getListener(){throw new eN.MastraError({id:"VOICE_DEFAULT_NO_LISTENER_PROVIDER",text:"No voice provider configured",domain:"MASTRA_VOICE",category:"USER"})}},sd=Symbol("pubsub"),sc=Symbol("stream_format"),sm=e.i(637349),sg=eF,sh=e.i(850264),sf=Object.create,sy=Object.defineProperty,sv=Object.getOwnPropertyDescriptor,sb=Object.getOwnPropertyNames,sw=Object.getPrototypeOf,sk=Object.prototype.hasOwnProperty,s_=(r={"../../../node_modules/.pnpm/secure-json-parse@2.7.0/node_modules/secure-json-parse/index.js"(e,t){var r="u">typeof Buffer,a=/"(?:_|\\u005[Ff])(?:_|\\u005[Ff])(?:p|\\u0070)(?:r|\\u0072)(?:o|\\u006[Ff])(?:t|\\u0074)(?:o|\\u006[Ff])(?:_|\\u005[Ff])(?:_|\\u005[Ff])"\s*:/,s=/"(?:c|\\u0063)(?:o|\\u006[Ff])(?:n|\\u006[Ee])(?:s|\\u0073)(?:t|\\u0074)(?:r|\\u0072)(?:u|\\u0075)(?:c|\\u0063)(?:t|\\u0074)(?:o|\\u006[Ff])(?:r|\\u0072)"\s*:/;function n(e,t,n){null==n&&null!==t&&"object"==typeof t&&(n=t,t=void 0),r&&Buffer.isBuffer(e)&&(e=e.toString()),e&&65279===e.charCodeAt(0)&&(e=e.slice(1));let o=JSON.parse(e,t);if(null===o||"object"!=typeof o)return o;let l=n&&n.protoAction||"error",u=n&&n.constructorAction||"error";if("ignore"===l&&"ignore"===u)return o;if("ignore"!==l&&"ignore"!==u){if(!1===a.test(e)&&!1===s.test(e))return o}else if("ignore"!==l&&"ignore"===u){if(!1===a.test(e))return o}else if(!1===s.test(e))return o;return i(o,{protoAction:l,constructorAction:u,safe:n&&n.safe})}function i(e,{protoAction:t="error",constructorAction:r="error",safe:a}={}){let s=[e];for(;s.length;){let e=s;for(let n of(s=[],e)){if("ignore"!==t&&Object.prototype.hasOwnProperty.call(n,"__proto__")){if(!0===a)return null;if("error"===t)throw SyntaxError("Object contains forbidden prototype property");delete n.__proto__}if("ignore"!==r&&Object.prototype.hasOwnProperty.call(n,"constructor")&&Object.prototype.hasOwnProperty.call(n.constructor,"prototype")){if(!0===a)return null;if("error"===r)throw SyntaxError("Object contains forbidden prototype property");delete n.constructor}for(let e in n){let t=n[e];t&&"object"==typeof t&&s.push(t)}}}return e}function o(e,t,r){let a=Error.stackTraceLimit;Error.stackTraceLimit=0;try{return n(e,t,r)}finally{Error.stackTraceLimit=a}}t.exports=o,t.exports.default=o,t.exports.parse=o,t.exports.safeParse=function(e,t){let r=Error.stackTraceLimit;Error.stackTraceLimit=0;try{return n(e,t,{safe:!0})}catch(e){return null}finally{Error.stackTraceLimit=r}},t.exports.scan=i}},function(){return a||(0,r[sb(r)[0]])((a={exports:{}}).exports,a),a.exports}),sI="vercel.ai.error",sS=Symbol.for(sI),sx=class e extends Error{constructor({name:e,message:t,cause:r}){super(t),this[uE]=!0,this.name=e,this.cause=r}static isInstance(t){return e.hasMarker(t,sI)}static hasMarker(e,t){let r=Symbol.for(t);return null!=e&&"object"==typeof e&&r in e&&"boolean"==typeof e[r]&&!0===e[r]}};uE=sS;var sT=sx,sE="AI_APICallError",sA=`vercel.ai.error.${sE}`,sO=Symbol.for(sA),sz=class extends sT{constructor({message:e,url:t,requestBodyValues:r,statusCode:a,responseHeaders:s,responseBody:n,cause:i,isRetryable:o=null!=a&&(408===a||409===a||429===a||a>=500),data:l}){super({name:sE,message:e,cause:i}),this[uA]=!0,this.url=t,this.requestBodyValues=r,this.statusCode=a,this.responseHeaders=s,this.responseBody=n,this.isRetryable=o,this.data=l}static isInstance(e){return sT.hasMarker(e,sA)}};function sM(e){return null==e?"unknown error":"string"==typeof e?e:e instanceof Error?e.message:JSON.stringify(e)}uA=sO;var sP="AI_InvalidArgumentError",sR=`vercel.ai.error.${sP}`,sC=Symbol.for(sR),sj=class extends sT{constructor({message:e,cause:t,argument:r}){super({name:sP,message:e,cause:t}),this[uO]=!0,this.argument=r}static isInstance(e){return sT.hasMarker(e,sR)}};uO=sC;var sN="AI_InvalidPromptError",sL=`vercel.ai.error.${sN}`,sD=Symbol.for(sL),sq=class extends sT{constructor({prompt:e,message:t,cause:r}){super({name:sN,message:`Invalid prompt: ${t}`,cause:r}),this[uz]=!0,this.prompt=e}static isInstance(e){return sT.hasMarker(e,sL)}};uz=sD;var s$="AI_JSONParseError",sF=`vercel.ai.error.${s$}`,sU=Symbol.for(sF),sZ=class extends sT{constructor({text:e,cause:t}){super({name:s$,message:`JSON parsing failed: Text: ${e}.
Error message: ${sM(t)}`,cause:t}),this[uM]=!0,this.text=e}static isInstance(e){return sT.hasMarker(e,sF)}};uM=sU;var sB="AI_TypeValidationError",sV=`vercel.ai.error.${sB}`,sK=Symbol.for(sV),sG=class e extends sT{constructor({value:e,cause:t}){super({name:sB,message:`Type validation failed: Value: ${JSON.stringify(e)}.
Error message: ${sM(t)}`,cause:t}),this[uP]=!0,this.value=e}static isInstance(e){return sT.hasMarker(e,sV)}static wrap({value:t,cause:r}){return e.isInstance(r)&&r.value===t?r:new e({value:t,cause:r})}};uP=sK;var sW="AI_UnsupportedFunctionalityError",sQ=`vercel.ai.error.${sW}`,sJ=Symbol.for(sQ),sH=class extends sT{constructor({functionality:e,message:t=`'${e}' functionality not supported.`}){super({name:sW,message:t}),this[uR]=!0,this.functionality=e}static isInstance(e){return sT.hasMarker(e,sQ)}};function sY(e){return null===e||"string"==typeof e||"number"==typeof e||"boolean"==typeof e||(Array.isArray(e)?e.every(sY):"object"==typeof e&&Object.entries(e).every(([e,t])=>"string"==typeof e&&sY(t)))}function sX(e){return Array.isArray(e)&&e.every(sY)}function s0(e){return null!=e&&"object"==typeof e&&Object.entries(e).every(([e,t])=>"string"==typeof e&&sY(t))}uR=sJ;var s1=((e,t,r,a)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let s of sb(t))sk.call(e,s)||s===r||sy(e,s,{get:()=>t[s],enumerable:!(a=sv(t,s))||a.enumerable});return e})(sy(null!=(s=s_())?sf(sw(s)):{},"default",{value:s,enumerable:!0}),s);async function s2(e){return null==e?Promise.resolve():new Promise(t=>setTimeout(t,e))}var s3=({prefix:e,size:t=16,alphabet:r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",separator:a="-"}={})=>{let s=((e,t=21)=>(r=t)=>{let a="",s=0|r;for(;s--;)a+=e[Math.random()*e.length|0];return a})(r,t);if(null==e)return s;if(r.includes(a))throw new sj({argument:"separator",message:`The separator "${a}" must not be part of the alphabet "${r}".`});return t=>`${e}${a}${s(t)}`},s5=s3(),s4=Symbol.for("vercel.ai.validator");function s6({value:e,schema:t}){var r;let a="object"==typeof t&&null!==t&&s4 in t&&!0===t[s4]&&"validate"in t?t:(r=t,{[s4]:!0,validate:e=>{let t=r.safeParse(e);return t.success?{success:!0,value:t.data}:{success:!1,error:t.error}}});try{if(null==a.validate)return{success:!0,value:e};let t=a.validate(e);if(t.success)return t;return{success:!1,error:sG.wrap({value:e,cause:t.error})}}catch(t){return{success:!1,error:sG.wrap({value:e,cause:t})}}}function s7({text:e,schema:t}){try{let r=s1.default.parse(e);if(null==t)return{success:!0,value:r,rawValue:r};let a=s6({value:r,schema:t});return a.success?{...a,rawValue:r}:a}catch(t){return{success:!1,error:sZ.isInstance(t)?t:new sZ({text:e,cause:t})}}}var{btoa:s9,atob:s8}=globalThis;function ne(e){let t=s8(e.replace(/-/g,"+").replace(/_/g,"/"));return Uint8Array.from(t,e=>e.codePointAt(0))}function nt(e){let t="";for(let r=0;r<e.length;r++)t+=String.fromCodePoint(e[r]);return s9(t)}var nr=Symbol("Let zodToJsonSchema decide on which parser to use"),na={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",allowedAdditionalProperties:!0,rejectedAdditionalProperties:!1,definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref",openAiAnyTypeName:"OpenAiAnyType"};function ns(e,t,r,a){a?.errorMessages&&r&&(e.errorMessage={...e.errorMessage,[t]:r})}function nn(e,t,r,a,s){e[t]=r,ns(e,t,a,s)}var ni=(e,t)=>{let r=0;for(;r<e.length&&r<t.length&&e[r]===t[r];r++);return[(e.length-r).toString(),...t.slice(r)].join("/")};function no(e){if("openAi"!==e.target)return{};let t=[...e.basePath,e.definitionPath,e.openAiAnyTypeName];return e.flags.hasReferencedOpenAiAnyType=!0,{$ref:"relative"===e.$refStrategy?ni(t,e.currentPath):t.join("/")}}function nl(e,t){return nz(e.type._def,t)}var nu=void 0,np=/^[cC][^\s-]{8,}$/,nd=/^[0-9a-z]+$/,nc=/^[0-9A-HJKMNP-TV-Z]{26}$/,nm=/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,ng=()=>(void 0===nu&&(nu=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),nu),nh=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,nf=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,ny=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,nv=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,nb=/^[a-zA-Z0-9_-]{21}$/,nw=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/;function nk(e,t){let r={type:"string"};if(e.checks)for(let a of e.checks)switch(a.kind){case"min":nn(r,"minLength","number"==typeof r.minLength?Math.max(r.minLength,a.value):a.value,a.message,t);break;case"max":nn(r,"maxLength","number"==typeof r.maxLength?Math.min(r.maxLength,a.value):a.value,a.message,t);break;case"email":switch(t.emailStrategy){case"format:email":nS(r,"email",a.message,t);break;case"format:idn-email":nS(r,"idn-email",a.message,t);break;case"pattern:zod":nx(r,nm,a.message,t)}break;case"url":nS(r,"uri",a.message,t);break;case"uuid":nS(r,"uuid",a.message,t);break;case"regex":nx(r,a.regex,a.message,t);break;case"cuid":nx(r,np,a.message,t);break;case"cuid2":nx(r,nd,a.message,t);break;case"startsWith":nx(r,RegExp(`^${n_(a.value,t)}`),a.message,t);break;case"endsWith":nx(r,RegExp(`${n_(a.value,t)}$`),a.message,t);break;case"datetime":nS(r,"date-time",a.message,t);break;case"date":nS(r,"date",a.message,t);break;case"time":nS(r,"time",a.message,t);break;case"duration":nS(r,"duration",a.message,t);break;case"length":nn(r,"minLength","number"==typeof r.minLength?Math.max(r.minLength,a.value):a.value,a.message,t),nn(r,"maxLength","number"==typeof r.maxLength?Math.min(r.maxLength,a.value):a.value,a.message,t);break;case"includes":nx(r,RegExp(n_(a.value,t)),a.message,t);break;case"ip":"v6"!==a.version&&nS(r,"ipv4",a.message,t),"v4"!==a.version&&nS(r,"ipv6",a.message,t);break;case"base64url":nx(r,nv,a.message,t);break;case"jwt":nx(r,nw,a.message,t);break;case"cidr":"v6"!==a.version&&nx(r,nh,a.message,t),"v4"!==a.version&&nx(r,nf,a.message,t);break;case"emoji":nx(r,ng(),a.message,t);break;case"ulid":nx(r,nc,a.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":nS(r,"binary",a.message,t);break;case"contentEncoding:base64":nn(r,"contentEncoding","base64",a.message,t);break;case"pattern:zod":nx(r,ny,a.message,t)}break;case"nanoid":nx(r,nb,a.message,t)}return r}function n_(e,t){return"escape"===t.patternStrategy?function(e){let t="";for(let r=0;r<e.length;r++)nI.has(e[r])||(t+="\\"),t+=e[r];return t}(e):e}var nI=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function nS(e,t,r,a){e.format||e.anyOf?.some(e=>e.format)?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&a.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.anyOf.push({format:t,...r&&a.errorMessages&&{errorMessage:{format:r}}})):nn(e,"format",t,r,a)}function nx(e,t,r,a){e.pattern||e.allOf?.some(e=>e.pattern)?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&a.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.allOf.push({pattern:nT(t,a),...r&&a.errorMessages&&{errorMessage:{pattern:r}}})):nn(e,"pattern",nT(t,a),r,a)}function nT(e,t){if(!t.applyRegexFlags||!e.flags)return e.source;let r={i:e.flags.includes("i"),m:e.flags.includes("m"),s:e.flags.includes("s")},a=r.i?e.source.toLowerCase():e.source,s="",n=!1,i=!1,o=!1;for(let e=0;e<a.length;e++){if(n){s+=a[e],n=!1;continue}if(r.i){if(i){if(a[e].match(/[a-z]/)){o?(s+=a[e],s+=`${a[e-2]}-${a[e]}`.toUpperCase(),o=!1):"-"===a[e+1]&&a[e+2]?.match(/[a-z]/)?(s+=a[e],o=!0):s+=`${a[e]}${a[e].toUpperCase()}`;continue}}else if(a[e].match(/[a-z]/)){s+=`[${a[e]}${a[e].toUpperCase()}]`;continue}}if(r.m){if("^"===a[e]){s+=`(^|(?<=[\r
]))`;continue}else if("$"===a[e]){s+=`($|(?=[\r
]))`;continue}}if(r.s&&"."===a[e]){s+=i?`${a[e]}\r
`:`[${a[e]}\r
]`;continue}s+=a[e],"\\"===a[e]?n=!0:i&&"]"===a[e]?i=!1:i||"["!==a[e]||(i=!0)}return s}function nE(e,t){if("openAi"===t.target&&console.warn("Warning: OpenAI may not support records in schemas! Try an array of key-value pairs instead."),"openApi3"===t.target&&e.keyType?._def.typeName===sh.ZodFirstPartyTypeKind.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce((r,a)=>({...r,[a]:nz(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",a]})??no(t)}),{}),additionalProperties:t.rejectedAdditionalProperties};let r={type:"object",additionalProperties:nz(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??t.allowedAdditionalProperties};if("openApi3"===t.target)return r;if(e.keyType?._def.typeName===sh.ZodFirstPartyTypeKind.ZodString&&e.keyType._def.checks?.length){let{type:a,...s}=nk(e.keyType._def,t);return{...r,propertyNames:s}}if(e.keyType?._def.typeName===sh.ZodFirstPartyTypeKind.ZodEnum)return{...r,propertyNames:{enum:e.keyType._def.values}};if(e.keyType?._def.typeName===sh.ZodFirstPartyTypeKind.ZodBranded&&e.keyType._def.type._def.typeName===sh.ZodFirstPartyTypeKind.ZodString&&e.keyType._def.type._def.checks?.length){let{type:a,...s}=nl(e.keyType._def,t);return{...r,propertyNames:s}}return r}var nA={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"},nO=(e,t)=>{let r=(e.options instanceof Map?Array.from(e.options.values()):e.options).map((e,r)=>nz(e._def,{...t,currentPath:[...t.currentPath,"anyOf",`${r}`]})).filter(e=>!!e&&(!t.strictUnions||"object"==typeof e&&Object.keys(e).length>0));return r.length?{anyOf:r}:void 0};function nz(e,t,r=!1){let a=t.seen.get(e);if(t.override){let s=t.override?.(e,t,a,r);if(s!==nr)return s}if(a&&!r){let e=nM(a,t);if(void 0!==e)return e}let s={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,s);let n=((e,t,r)=>{switch(t){case sh.ZodFirstPartyTypeKind.ZodString:return nk(e,r);case sh.ZodFirstPartyTypeKind.ZodNumber:let a={type:"number"};if(!e.checks)return a;for(let t of e.checks)switch(t.kind){case"int":a.type="integer",ns(a,"type",t.message,r);break;case"min":"jsonSchema7"===r.target?t.inclusive?nn(a,"minimum",t.value,t.message,r):nn(a,"exclusiveMinimum",t.value,t.message,r):(t.inclusive||(a.exclusiveMinimum=!0),nn(a,"minimum",t.value,t.message,r));break;case"max":"jsonSchema7"===r.target?t.inclusive?nn(a,"maximum",t.value,t.message,r):nn(a,"exclusiveMaximum",t.value,t.message,r):(t.inclusive||(a.exclusiveMaximum=!0),nn(a,"maximum",t.value,t.message,r));break;case"multipleOf":nn(a,"multipleOf",t.value,t.message,r)}return a;case sh.ZodFirstPartyTypeKind.ZodObject:return function(e,t){let r="openAi"===t.target,a={type:"object",properties:{}},s=[],n=e.shape();for(let e in n){let i=n[e];if(void 0===i||void 0===i._def)continue;let o=function(e){try{return e.isOptional()}catch{return!0}}(i);o&&r&&("ZodOptional"===i._def.typeName&&(i=i._def.innerType),i.isNullable()||(i=i.nullable()),o=!1);let l=nz(i._def,{...t,currentPath:[...t.currentPath,"properties",e],propertyPath:[...t.currentPath,"properties",e]});void 0!==l&&(a.properties[e]=l,o||s.push(e))}s.length&&(a.required=s);let i=function(e,t){if("ZodNever"!==e.catchall._def.typeName)return nz(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]});switch(e.unknownKeys){case"passthrough":return t.allowedAdditionalProperties;case"strict":return t.rejectedAdditionalProperties;case"strip":return"strict"===t.removeAdditionalStrategy?t.allowedAdditionalProperties:t.rejectedAdditionalProperties}}(e,t);return void 0!==i&&(a.additionalProperties=i),a}(e,r);case sh.ZodFirstPartyTypeKind.ZodBigInt:let s={type:"integer",format:"int64"};if(!e.checks)return s;for(let t of e.checks)switch(t.kind){case"min":"jsonSchema7"===r.target?t.inclusive?nn(s,"minimum",t.value,t.message,r):nn(s,"exclusiveMinimum",t.value,t.message,r):(t.inclusive||(s.exclusiveMinimum=!0),nn(s,"minimum",t.value,t.message,r));break;case"max":"jsonSchema7"===r.target?t.inclusive?nn(s,"maximum",t.value,t.message,r):nn(s,"exclusiveMaximum",t.value,t.message,r):(t.inclusive||(s.exclusiveMaximum=!0),nn(s,"maximum",t.value,t.message,r));break;case"multipleOf":nn(s,"multipleOf",t.value,t.message,r)}return s;case sh.ZodFirstPartyTypeKind.ZodBoolean:return{type:"boolean"};case sh.ZodFirstPartyTypeKind.ZodDate:return function e(t,r,a){let s=a??r.dateStrategy;if(Array.isArray(s))return{anyOf:s.map((a,s)=>e(t,r,a))};switch(s){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":var n=t,i=r;let o={type:"integer",format:"unix-time"};if("openApi3"===i.target)return o;for(let e of n.checks)switch(e.kind){case"min":nn(o,"minimum",e.value,e.message,i);break;case"max":nn(o,"maximum",e.value,e.message,i)}return o}}(e,r);case sh.ZodFirstPartyTypeKind.ZodUndefined:return{not:no(r)};case sh.ZodFirstPartyTypeKind.ZodNull:return"openApi3"===r.target?{enum:["null"],nullable:!0}:{type:"null"};case sh.ZodFirstPartyTypeKind.ZodArray:let n;return n={type:"array"},e.type?._def&&e.type?._def?.typeName!==sh.ZodFirstPartyTypeKind.ZodAny&&(n.items=nz(e.type._def,{...r,currentPath:[...r.currentPath,"items"]})),e.minLength&&nn(n,"minItems",e.minLength.value,e.minLength.message,r),e.maxLength&&nn(n,"maxItems",e.maxLength.value,e.maxLength.message,r),e.exactLength&&(nn(n,"minItems",e.exactLength.value,e.exactLength.message,r),nn(n,"maxItems",e.exactLength.value,e.exactLength.message,r)),n;case sh.ZodFirstPartyTypeKind.ZodUnion:case sh.ZodFirstPartyTypeKind.ZodDiscriminatedUnion:if("openApi3"===r.target)return nO(e,r);let i=e.options instanceof Map?Array.from(e.options.values()):e.options;if(i.every(e=>e._def.typeName in nA&&(!e._def.checks||!e._def.checks.length))){let e=i.reduce((e,t)=>{let r=nA[t._def.typeName];return r&&!e.includes(r)?[...e,r]:e},[]);return{type:e.length>1?e:e[0]}}if(i.every(e=>"ZodLiteral"===e._def.typeName&&!e.description)){let e=i.reduce((e,t)=>{let r=typeof t._def.value;switch(r){case"string":case"number":case"boolean":return[...e,r];case"bigint":return[...e,"integer"];case"object":if(null===t._def.value)return[...e,"null"];default:return e}},[]);if(e.length===i.length){let t=e.filter((e,t,r)=>r.indexOf(e)===t);return{type:t.length>1?t:t[0],enum:i.reduce((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value],[])}}}else if(i.every(e=>"ZodEnum"===e._def.typeName))return{type:"string",enum:i.reduce((e,t)=>[...e,...t._def.values.filter(t=>!e.includes(t))],[])};return nO(e,r);case sh.ZodFirstPartyTypeKind.ZodIntersection:let o,l,u;return o=[nz(e.left._def,{...r,currentPath:[...r.currentPath,"allOf","0"]}),nz(e.right._def,{...r,currentPath:[...r.currentPath,"allOf","1"]})].filter(e=>!!e),l="jsonSchema2019-09"===r.target?{unevaluatedProperties:!1}:void 0,u=[],o.forEach(e=>{if((!("type"in e)||"string"!==e.type)&&"allOf"in e)u.push(...e.allOf),void 0===e.unevaluatedProperties&&(l=void 0);else{let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){let{additionalProperties:r,...a}=e;t=a}else l=void 0;u.push(t)}}),u.length?{allOf:u,...l}:void 0;case sh.ZodFirstPartyTypeKind.ZodTuple:return e.rest?{type:"array",minItems:e.items.length,items:e.items.map((e,t)=>nz(e._def,{...r,currentPath:[...r.currentPath,"items",`${t}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[]),additionalItems:nz(e.rest._def,{...r,currentPath:[...r.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map((e,t)=>nz(e._def,{...r,currentPath:[...r.currentPath,"items",`${t}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[])};case sh.ZodFirstPartyTypeKind.ZodRecord:return nE(e,r);case sh.ZodFirstPartyTypeKind.ZodLiteral:let p;return"bigint"!=(p=typeof e.value)&&"number"!==p&&"boolean"!==p&&"string"!==p?{type:Array.isArray(e.value)?"array":"object"}:"openApi3"===r.target?{type:"bigint"===p?"integer":p,enum:[e.value]}:{type:"bigint"===p?"integer":p,const:e.value};case sh.ZodFirstPartyTypeKind.ZodEnum:return{type:"string",enum:Array.from(e.values)};case sh.ZodFirstPartyTypeKind.ZodNativeEnum:let d,c,m;return d=e.values,{type:1===(m=Array.from(new Set((c=Object.keys(e.values).filter(e=>"number"!=typeof d[d[e]]).map(e=>d[e])).map(e=>typeof e)))).length?"string"===m[0]?"string":"number":["string","number"],enum:c};case sh.ZodFirstPartyTypeKind.ZodNullable:if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return"openApi3"===r.target?{type:nA[e.innerType._def.typeName],nullable:!0}:{type:[nA[e.innerType._def.typeName],"null"]};if("openApi3"===r.target){let t=nz(e.innerType._def,{...r,currentPath:[...r.currentPath]});return t&&"$ref"in t?{allOf:[t],nullable:!0}:t&&{...t,nullable:!0}}let g=nz(e.innerType._def,{...r,currentPath:[...r.currentPath,"anyOf","0"]});return g&&{anyOf:[g,{type:"null"}]};case sh.ZodFirstPartyTypeKind.ZodOptional:if(r.currentPath.toString()===r.propertyPath?.toString())return nz(e.innerType._def,r);let h=nz(e.innerType._def,{...r,currentPath:[...r.currentPath,"anyOf","1"]});return h?{anyOf:[{not:no(r)},h]}:no(r);case sh.ZodFirstPartyTypeKind.ZodMap:if("record"===r.mapStrategy)return nE(e,r);return{type:"array",maxItems:125,items:{type:"array",items:[nz(e.keyType._def,{...r,currentPath:[...r.currentPath,"items","items","0"]})||no(r),nz(e.valueType._def,{...r,currentPath:[...r.currentPath,"items","items","1"]})||no(r)],minItems:2,maxItems:2}};case sh.ZodFirstPartyTypeKind.ZodSet:let f;return f={type:"array",uniqueItems:!0,items:nz(e.valueType._def,{...r,currentPath:[...r.currentPath,"items"]})},e.minSize&&nn(f,"minItems",e.minSize.value,e.minSize.message,r),e.maxSize&&nn(f,"maxItems",e.maxSize.value,e.maxSize.message,r),f;case sh.ZodFirstPartyTypeKind.ZodLazy:return()=>e.getter()._def;case sh.ZodFirstPartyTypeKind.ZodPromise:return nz(e.type._def,r);case sh.ZodFirstPartyTypeKind.ZodNaN:case sh.ZodFirstPartyTypeKind.ZodNever:return"openAi"===r.target?void 0:{not:no({...r,currentPath:[...r.currentPath,"not"]})};case sh.ZodFirstPartyTypeKind.ZodEffects:return"input"===r.effectStrategy?nz(e.schema._def,r):no(r);case sh.ZodFirstPartyTypeKind.ZodAny:case sh.ZodFirstPartyTypeKind.ZodUnknown:return no(r);case sh.ZodFirstPartyTypeKind.ZodDefault:return{...nz(e.innerType._def,r),default:e.defaultValue()};case sh.ZodFirstPartyTypeKind.ZodBranded:return nl(e,r);case sh.ZodFirstPartyTypeKind.ZodReadonly:case sh.ZodFirstPartyTypeKind.ZodCatch:return nz(e.innerType._def,r);case sh.ZodFirstPartyTypeKind.ZodPipeline:if("input"===r.pipeStrategy)return nz(e.in._def,r);if("output"===r.pipeStrategy)return nz(e.out._def,r);let y=nz(e.in._def,{...r,currentPath:[...r.currentPath,"allOf","0"]}),v=nz(e.out._def,{...r,currentPath:[...r.currentPath,"allOf",y?"1":"0"]});return{allOf:[y,v].filter(e=>void 0!==e)};case sh.ZodFirstPartyTypeKind.ZodFunction:case sh.ZodFirstPartyTypeKind.ZodVoid:case sh.ZodFirstPartyTypeKind.ZodSymbol:default:return}})(e,e.typeName,t),i="function"==typeof n?nz(n(),t):n;if(i&&nP(e,t,i),t.postProcess){let r=t.postProcess(i,e,t);return s.jsonSchema=i,r}return s.jsonSchema=i,i}var nM=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"relative":return{$ref:ni(t.currentPath,e.path)};case"none":case"seen":if(e.path.length<t.currentPath.length&&e.path.every((e,r)=>t.currentPath[r]===e))return console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),no(t);return"seen"===t.$refStrategy?no(t):void 0}},nP=(e,t,r)=>(e.description&&(r.description=e.description,t.markdownDescription&&(r.markdownDescription=e.description)),r);function nR(e){if(void 0===e)return{value:void 0,state:"undefined-input"};let t=s7({text:e});return t.success?{value:t.value,state:"successful-parse"}:(t=s7({text:function(e){let t=["ROOT"],r=-1,a=null;function s(e,s,n){switch(e){case'"':r=s,t.pop(),t.push(n),t.push("INSIDE_STRING");break;case"f":case"t":case"n":r=s,a=s,t.pop(),t.push(n),t.push("INSIDE_LITERAL");break;case"-":t.pop(),t.push(n),t.push("INSIDE_NUMBER");break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":r=s,t.pop(),t.push(n),t.push("INSIDE_NUMBER");break;case"{":r=s,t.pop(),t.push(n),t.push("INSIDE_OBJECT_START");break;case"[":r=s,t.pop(),t.push(n),t.push("INSIDE_ARRAY_START")}}function n(e,a){switch(e){case",":t.pop(),t.push("INSIDE_OBJECT_AFTER_COMMA");break;case"}":r=a,t.pop()}}function i(e,a){switch(e){case",":t.pop(),t.push("INSIDE_ARRAY_AFTER_COMMA");break;case"]":r=a,t.pop()}}for(let o=0;o<e.length;o++){let l=e[o];switch(t[t.length-1]){case"ROOT":s(l,o,"FINISH");break;case"INSIDE_OBJECT_START":switch(l){case'"':t.pop(),t.push("INSIDE_OBJECT_KEY");break;case"}":r=o,t.pop()}break;case"INSIDE_OBJECT_AFTER_COMMA":'"'===l&&(t.pop(),t.push("INSIDE_OBJECT_KEY"));break;case"INSIDE_OBJECT_KEY":'"'===l&&(t.pop(),t.push("INSIDE_OBJECT_AFTER_KEY"));break;case"INSIDE_OBJECT_AFTER_KEY":":"===l&&(t.pop(),t.push("INSIDE_OBJECT_BEFORE_VALUE"));break;case"INSIDE_OBJECT_BEFORE_VALUE":s(l,o,"INSIDE_OBJECT_AFTER_VALUE");break;case"INSIDE_OBJECT_AFTER_VALUE":n(l,o);break;case"INSIDE_STRING":switch(l){case'"':t.pop(),r=o;break;case"\\":t.push("INSIDE_STRING_ESCAPE");break;default:r=o}break;case"INSIDE_ARRAY_START":"]"===l?(r=o,t.pop()):(r=o,s(l,o,"INSIDE_ARRAY_AFTER_VALUE"));break;case"INSIDE_ARRAY_AFTER_VALUE":switch(l){case",":t.pop(),t.push("INSIDE_ARRAY_AFTER_COMMA");break;case"]":r=o,t.pop();break;default:r=o}break;case"INSIDE_ARRAY_AFTER_COMMA":s(l,o,"INSIDE_ARRAY_AFTER_VALUE");break;case"INSIDE_STRING_ESCAPE":t.pop(),r=o;break;case"INSIDE_NUMBER":switch(l){case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":r=o;break;case"e":case"E":case"-":case".":break;case",":t.pop(),"INSIDE_ARRAY_AFTER_VALUE"===t[t.length-1]&&i(l,o),"INSIDE_OBJECT_AFTER_VALUE"===t[t.length-1]&&n(l,o);break;case"}":t.pop(),"INSIDE_OBJECT_AFTER_VALUE"===t[t.length-1]&&n(l,o);break;case"]":t.pop(),"INSIDE_ARRAY_AFTER_VALUE"===t[t.length-1]&&i(l,o);break;default:t.pop()}break;case"INSIDE_LITERAL":{let s=e.substring(a,o+1);"false".startsWith(s)||"true".startsWith(s)||"null".startsWith(s)?r=o:(t.pop(),"INSIDE_OBJECT_AFTER_VALUE"===t[t.length-1]?n(l,o):"INSIDE_ARRAY_AFTER_VALUE"===t[t.length-1]&&i(l,o))}}}let o=e.slice(0,r+1);for(let r=t.length-1;r>=0;r--)switch(t[r]){case"INSIDE_STRING":o+='"';break;case"INSIDE_OBJECT_KEY":case"INSIDE_OBJECT_AFTER_KEY":case"INSIDE_OBJECT_AFTER_COMMA":case"INSIDE_OBJECT_START":case"INSIDE_OBJECT_BEFORE_VALUE":case"INSIDE_OBJECT_AFTER_VALUE":o+="}";break;case"INSIDE_ARRAY_START":case"INSIDE_ARRAY_AFTER_COMMA":case"INSIDE_ARRAY_AFTER_VALUE":o+="]";break;case"INSIDE_LITERAL":{let t=e.substring(a,e.length);"true".startsWith(t)?o+="true".slice(t.length):"false".startsWith(t)?o+="false".slice(t.length):"null".startsWith(t)&&(o+="null".slice(t.length))}}return o}(e)})).success?{value:t.value,state:"repaired-parse"}:{value:void 0,state:"failed-parse"}}var nC=[{code:"0",name:"text",parse:e=>{if("string"!=typeof e)throw Error('"text" parts expect a string value.');return{type:"text",value:e}}},{code:"2",name:"data",parse:e=>{if(!Array.isArray(e))throw Error('"data" parts expect an array value.');return{type:"data",value:e}}},{code:"3",name:"error",parse:e=>{if("string"!=typeof e)throw Error('"error" parts expect a string value.');return{type:"error",value:e}}},{code:"8",name:"message_annotations",parse:e=>{if(!Array.isArray(e))throw Error('"message_annotations" parts expect an array value.');return{type:"message_annotations",value:e}}},{code:"9",name:"tool_call",parse:e=>{if(null==e||"object"!=typeof e||!("toolCallId"in e)||"string"!=typeof e.toolCallId||!("toolName"in e)||"string"!=typeof e.toolName||!("args"in e)||"object"!=typeof e.args)throw Error('"tool_call" parts expect an object with a "toolCallId", "toolName", and "args" property.');return{type:"tool_call",value:e}}},{code:"a",name:"tool_result",parse:e=>{if(null==e||"object"!=typeof e||!("toolCallId"in e)||"string"!=typeof e.toolCallId||!("result"in e))throw Error('"tool_result" parts expect an object with a "toolCallId" and a "result" property.');return{type:"tool_result",value:e}}},{code:"b",name:"tool_call_streaming_start",parse:e=>{if(null==e||"object"!=typeof e||!("toolCallId"in e)||"string"!=typeof e.toolCallId||!("toolName"in e)||"string"!=typeof e.toolName)throw Error('"tool_call_streaming_start" parts expect an object with a "toolCallId" and "toolName" property.');return{type:"tool_call_streaming_start",value:e}}},{code:"c",name:"tool_call_delta",parse:e=>{if(null==e||"object"!=typeof e||!("toolCallId"in e)||"string"!=typeof e.toolCallId||!("argsTextDelta"in e)||"string"!=typeof e.argsTextDelta)throw Error('"tool_call_delta" parts expect an object with a "toolCallId" and "argsTextDelta" property.');return{type:"tool_call_delta",value:e}}},{code:"d",name:"finish_message",parse:e=>{if(null==e||"object"!=typeof e||!("finishReason"in e)||"string"!=typeof e.finishReason)throw Error('"finish_message" parts expect an object with a "finishReason" property.');let t={finishReason:e.finishReason};return"usage"in e&&null!=e.usage&&"object"==typeof e.usage&&"promptTokens"in e.usage&&"completionTokens"in e.usage&&(t.usage={promptTokens:"number"==typeof e.usage.promptTokens?e.usage.promptTokens:NaN,completionTokens:"number"==typeof e.usage.completionTokens?e.usage.completionTokens:NaN}),{type:"finish_message",value:t}}},{code:"e",name:"finish_step",parse:e=>{if(null==e||"object"!=typeof e||!("finishReason"in e)||"string"!=typeof e.finishReason)throw Error('"finish_step" parts expect an object with a "finishReason" property.');let t={finishReason:e.finishReason,isContinued:!1};return"usage"in e&&null!=e.usage&&"object"==typeof e.usage&&"promptTokens"in e.usage&&"completionTokens"in e.usage&&(t.usage={promptTokens:"number"==typeof e.usage.promptTokens?e.usage.promptTokens:NaN,completionTokens:"number"==typeof e.usage.completionTokens?e.usage.completionTokens:NaN}),"isContinued"in e&&"boolean"==typeof e.isContinued&&(t.isContinued=e.isContinued),{type:"finish_step",value:t}}},{code:"f",name:"start_step",parse:e=>{if(null==e||"object"!=typeof e||!("messageId"in e)||"string"!=typeof e.messageId)throw Error('"start_step" parts expect an object with an "id" property.');return{type:"start_step",value:{messageId:e.messageId}}}},{code:"g",name:"reasoning",parse:e=>{if("string"!=typeof e)throw Error('"reasoning" parts expect a string value.');return{type:"reasoning",value:e}}},{code:"h",name:"source",parse:e=>{if(null==e||"object"!=typeof e)throw Error('"source" parts expect a Source object.');return{type:"source",value:e}}},{code:"i",name:"redacted_reasoning",parse:e=>{if(null==e||"object"!=typeof e||!("data"in e)||"string"!=typeof e.data)throw Error('"redacted_reasoning" parts expect an object with a "data" property.');return{type:"redacted_reasoning",value:{data:e.data}}}},{code:"j",name:"reasoning_signature",parse:e=>{if(null==e||"object"!=typeof e||!("signature"in e)||"string"!=typeof e.signature)throw Error('"reasoning_signature" parts expect an object with a "signature" property.');return{type:"reasoning_signature",value:{signature:e.signature}}}},{code:"k",name:"file",parse:e=>{if(null==e||"object"!=typeof e||!("data"in e)||"string"!=typeof e.data||!("mimeType"in e)||"string"!=typeof e.mimeType)throw Error('"file" parts expect an object with a "data" and "mimeType" property.');return{type:"file",value:e}}}];function nj(e,t){let r=nC.find(t=>t.name===e);if(!r)throw Error(`Invalid stream part type: ${e}`);return`${r.code}:${JSON.stringify(t)}
`}function nN(e,t){if(e===t)return!0;if(null==e||null==t)return!1;if("object"!=typeof e&&"object"!=typeof t)return e===t;if(e.constructor!==t.constructor)return!1;if(e instanceof Date&&t instanceof Date)return e.getTime()===t.getTime();if(Array.isArray(e)){if(e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(!nN(e[r],t[r]))return!1;return!0}let r=Object.keys(e),a=Object.keys(t);if(r.length!==a.length)return!1;for(let s of r)if(!a.includes(s)||!nN(e[s],t[s]))return!1;return!0}Object.fromEntries(nC.map(e=>[e.code,e])),Object.fromEntries(nC.map(e=>[e.name,e.code]));var nL=Symbol.for("vercel.ai.schema");function nD(e){var t;return"object"==typeof e&&null!==e&&nL in e&&!0===e[nL]&&"jsonSchema"in e&&"validate"in e?e:function(e,{validate:t}={}){return{[nL]:!0,_type:void 0,[s4]:!0,jsonSchema:e,validate:t}}(((e,t)=>{let r,a,s=(a=void 0!==(r="string"==typeof t?{...na,name:t}:{...na,...t}).name?[...r.basePath,r.definitionPath,r.name]:r.basePath,{...r,flags:{hasReferencedOpenAiAnyType:!1},currentPath:a,propertyPath:void 0,seen:new Map(Object.entries(r.definitions).map(([e,t])=>[t._def,{def:t._def,path:[...r.basePath,r.definitionPath,e],jsonSchema:void 0}]))}),n="object"==typeof t&&t.definitions?Object.entries(t.definitions).reduce((e,[t,r])=>({...e,[t]:nz(r._def,{...s,currentPath:[...s.basePath,s.definitionPath,t]},!0)??no(s)}),{}):void 0,i="string"==typeof t?t:t?.nameStrategy==="title"?void 0:t?.name,o=nz(e._def,void 0===i?s:{...s,currentPath:[...s.basePath,s.definitionPath,i]},!1)??no(s),l="object"==typeof t&&void 0!==t.name&&"title"===t.nameStrategy?t.name:void 0;void 0!==l&&(o.title=l),s.flags.hasReferencedOpenAiAnyType&&(n||(n={}),n[s.openAiAnyTypeName]||(n[s.openAiAnyTypeName]={type:["string","number","integer","boolean","array","null"],items:{$ref:"relative"===s.$refStrategy?"1":[...s.basePath,s.definitionPath,s.openAiAnyTypeName].join("/")}}));let u=void 0===i?n?{...o,[s.definitionPath]:n}:o:{$ref:[..."relative"===s.$refStrategy?[]:s.basePath,s.definitionPath,i].join("/"),[s.definitionPath]:{...n,[i]:o}};return"jsonSchema7"===s.target?u.$schema="http://json-schema.org/draft-07/schema#":("jsonSchema2019-09"===s.target||"openAi"===s.target)&&(u.$schema="https://json-schema.org/draft/2019-09/schema#"),"openAi"===s.target&&("anyOf"in u||"oneOf"in u||"allOf"in u||"type"in u&&Array.isArray(u.type))&&console.warn("Warning: OpenAI may not support schemas with unions as roots! Try wrapping it in an object property."),u})(t=e,{$refStrategy:"none",target:"jsonSchema7"}),{validate:e=>{let r=t.safeParse(e);return r.success?{success:!0,value:r.data}:{success:!1,error:r.error}}})}var nq="object"==typeof globalThis?globalThis:e.g,n$="1.9.0",nF=/^(\d+)\.(\d+)\.(\d+)(-(.+))?$/,nU=function(e){var t=new Set([e]),r=new Set,a=e.match(nF);if(!a)return function(){return!1};var s={major:+a[1],minor:+a[2],patch:+a[3],prerelease:a[4]};if(null!=s.prerelease)return function(t){return t===e};function n(e){return r.add(e),!1}return function(e){if(t.has(e))return!0;if(r.has(e))return!1;var a=e.match(nF);if(!a)return n(e);var i={major:+a[1],minor:+a[2],patch:+a[3],prerelease:a[4]};if(null!=i.prerelease||s.major!==i.major)return n(e);if(0===s.major)return s.minor===i.minor&&s.patch<=i.patch?(t.add(e),!0):n(e);return s.minor<=i.minor?(t.add(e),!0):n(e)}}(n$),nZ=Symbol.for("opentelemetry.js.api."+n$.split(".")[0]);function nB(e,t,r,a){void 0===a&&(a=!1);var s,n=nq[nZ]=null!=(s=nq[nZ])?s:{version:n$};if(!a&&n[e]){var i=Error("@opentelemetry/api: Attempted duplicate registration of API: "+e);return r.error(i.stack||i.message),!1}if(n.version!==n$){var i=Error("@opentelemetry/api: Registration of version v"+n.version+" for "+e+" does not match previously registered API v"+n$);return r.error(i.stack||i.message),!1}return n[e]=t,r.debug("@opentelemetry/api: Registered a global for "+e+" v"+n$+"."),!0}function nV(e){var t,r,a=null==(t=nq[nZ])?void 0:t.version;if(a&&nU(a))return null==(r=nq[nZ])?void 0:r[e]}function nK(e,t){t.debug("@opentelemetry/api: Unregistering a global for "+e+" v"+n$+".");var r=nq[nZ];r&&delete r[e]}var nG=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var a,s,n=r.call(e),i=[];try{for(;!(a=n.next()).done;)i.push(a.value)}catch(e){s={error:e}}finally{try{a&&!a.done&&(r=n.return)&&r.call(n)}finally{if(s)throw s.error}}return i},nW=function(e,t,r){if(2==arguments.length)for(var a,s=0,n=t.length;s<n;s++)!a&&s in t||(a||(a=Array.prototype.slice.call(t,0,s)),a[s]=t[s]);return e.concat(a||Array.prototype.slice.call(t))},nQ=function(){function e(e){this._namespace=e.namespace||"DiagComponentLogger"}return e.prototype.debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return nJ("debug",this._namespace,e)},e.prototype.error=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return nJ("error",this._namespace,e)},e.prototype.info=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return nJ("info",this._namespace,e)},e.prototype.warn=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return nJ("warn",this._namespace,e)},e.prototype.verbose=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return nJ("verbose",this._namespace,e)},e}();function nJ(e,t,r){var a=nV("diag");if(a)return r.unshift(t),a[e].apply(a,nW([],nG(r),!1))}(l8=uC||(uC={}))[l8.NONE=0]="NONE",l8[l8.ERROR=30]="ERROR",l8[l8.WARN=50]="WARN",l8[l8.INFO=60]="INFO",l8[l8.DEBUG=70]="DEBUG",l8[l8.VERBOSE=80]="VERBOSE",l8[l8.ALL=9999]="ALL";var nH=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var a,s,n=r.call(e),i=[];try{for(;!(a=n.next()).done;)i.push(a.value)}catch(e){s={error:e}}finally{try{a&&!a.done&&(r=n.return)&&r.call(n)}finally{if(s)throw s.error}}return i},nY=function(e,t,r){if(2==arguments.length)for(var a,s=0,n=t.length;s<n;s++)!a&&s in t||(a||(a=Array.prototype.slice.call(t,0,s)),a[s]=t[s]);return e.concat(a||Array.prototype.slice.call(t))},nX=function(){function e(){function e(e){return function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var a=nV("diag");if(a)return a[e].apply(a,nY([],nH(t),!1))}}var t=this;t.setLogger=function(e,r){if(void 0===r&&(r={logLevel:uC.INFO}),e===t){var a,s,n,i=Error("Cannot use diag as the logger for itself. Please use a DiagLogger implementation like ConsoleDiagLogger or a custom implementation");return t.error(null!=(a=i.stack)?a:i.message),!1}"number"==typeof r&&(r={logLevel:r});var o=nV("diag"),l=function(e,t){function r(r,a){var s=t[r];return"function"==typeof s&&e>=a?s.bind(t):function(){}}return e<uC.NONE?e=uC.NONE:e>uC.ALL&&(e=uC.ALL),t=t||{},{error:r("error",uC.ERROR),warn:r("warn",uC.WARN),info:r("info",uC.INFO),debug:r("debug",uC.DEBUG),verbose:r("verbose",uC.VERBOSE)}}(null!=(s=r.logLevel)?s:uC.INFO,e);if(o&&!r.suppressOverrideMessage){var u=null!=(n=Error().stack)?n:"<failed to generate stacktrace>";o.warn("Current logger will be overwritten from "+u),l.warn("Current logger will overwrite one already registered from "+u)}return nB("diag",l,t,!0)},t.disable=function(){nK("diag",t)},t.createComponentLogger=function(e){return new nQ(e)},t.verbose=e("verbose"),t.debug=e("debug"),t.info=e("info"),t.warn=e("warn"),t.error=e("error")}return e.instance=function(){return this._instance||(this._instance=new e),this._instance},e}(),n0=new function e(t){var r=this;r._currentContext=t?new Map(t):new Map,r.getValue=function(e){return r._currentContext.get(e)},r.setValue=function(t,a){var s=new e(r._currentContext);return s._currentContext.set(t,a),s},r.deleteValue=function(t){var a=new e(r._currentContext);return a._currentContext.delete(t),a}},n1=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var a,s,n=r.call(e),i=[];try{for(;!(a=n.next()).done;)i.push(a.value)}catch(e){s={error:e}}finally{try{a&&!a.done&&(r=n.return)&&r.call(n)}finally{if(s)throw s.error}}return i},n2=function(e,t,r){if(2==arguments.length)for(var a,s=0,n=t.length;s<n;s++)!a&&s in t||(a||(a=Array.prototype.slice.call(t,0,s)),a[s]=t[s]);return e.concat(a||Array.prototype.slice.call(t))},n3=function(){function e(){}return e.prototype.active=function(){return n0},e.prototype.with=function(e,t,r){for(var a=[],s=3;s<arguments.length;s++)a[s-3]=arguments[s];return t.call.apply(t,n2([r],n1(a),!1))},e.prototype.bind=function(e,t){return t},e.prototype.enable=function(){return this},e.prototype.disable=function(){return this},e}(),n5=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var a,s,n=r.call(e),i=[];try{for(;!(a=n.next()).done;)i.push(a.value)}catch(e){s={error:e}}finally{try{a&&!a.done&&(r=n.return)&&r.call(n)}finally{if(s)throw s.error}}return i},n4=function(e,t,r){if(2==arguments.length)for(var a,s=0,n=t.length;s<n;s++)!a&&s in t||(a||(a=Array.prototype.slice.call(t,0,s)),a[s]=t[s]);return e.concat(a||Array.prototype.slice.call(t))},n6="context",n7=new n3,n9=function(){function e(){}return e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.setGlobalContextManager=function(e){return nB(n6,e,nX.instance())},e.prototype.active=function(){return this._getContextManager().active()},e.prototype.with=function(e,t,r){for(var a,s=[],n=3;n<arguments.length;n++)s[n-3]=arguments[n];return(a=this._getContextManager()).with.apply(a,n4([e,t,r],n5(s),!1))},e.prototype.bind=function(e,t){return this._getContextManager().bind(e,t)},e.prototype._getContextManager=function(){return nV(n6)||n7},e.prototype.disable=function(){this._getContextManager().disable(),nK(n6,nX.instance())},e}();(ue=uj||(uj={}))[ue.NONE=0]="NONE",ue[ue.SAMPLED=1]="SAMPLED";var n8="0000000000000000",ie="00000000000000000000000000000000",it={traceId:ie,spanId:n8,traceFlags:uj.NONE},ir=function(){function e(e){void 0===e&&(e=it),this._spanContext=e}return e.prototype.spanContext=function(){return this._spanContext},e.prototype.setAttribute=function(e,t){return this},e.prototype.setAttributes=function(e){return this},e.prototype.addEvent=function(e,t){return this},e.prototype.addLink=function(e){return this},e.prototype.addLinks=function(e){return this},e.prototype.setStatus=function(e){return this},e.prototype.updateName=function(e){return this},e.prototype.end=function(e){},e.prototype.isRecording=function(){return!1},e.prototype.recordException=function(e,t){},e}(),ia=Symbol.for("OpenTelemetry Context Key SPAN");function is(e){return e.getValue(ia)||void 0}function ii(){return is(n9.getInstance().active())}function io(e,t){return e.setValue(ia,t)}function il(e){return e.deleteValue(ia)}function iu(e,t){return io(e,new ir(t))}function ip(e){var t;return null==(t=is(e))?void 0:t.spanContext()}var id=/^([0-9a-f]{32})$/i,ic=/^[0-9a-f]{16}$/i;function im(e){var t,r;return t=e.traceId,id.test(t)&&t!==ie&&(r=e.spanId,ic.test(r)&&r!==n8)}function ig(e){return new ir(e)}var ih=n9.getInstance(),iy=function(){function e(){}return e.prototype.startSpan=function(e,t,r){if(void 0===r&&(r=ih.active()),null==t?void 0:t.root)return new ir;var a,s=r&&ip(r);return"object"==typeof(a=s)&&"string"==typeof a.spanId&&"string"==typeof a.traceId&&"number"==typeof a.traceFlags&&im(s)?new ir(s):new ir},e.prototype.startActiveSpan=function(e,t,r,a){if(!(arguments.length<2)){2==arguments.length?i=t:3==arguments.length?(s=t,i=r):(s=t,n=r,i=a);var s,n,i,o=null!=n?n:ih.active(),l=this.startSpan(e,s,o),u=io(o,l);return ih.with(u,i,void 0,l)}},e}(),iv=new iy,ib=function(){function e(e,t,r,a){this._provider=e,this.name=t,this.version=r,this.options=a}return e.prototype.startSpan=function(e,t,r){return this._getTracer().startSpan(e,t,r)},e.prototype.startActiveSpan=function(e,t,r,a){var s=this._getTracer();return Reflect.apply(s.startActiveSpan,s,arguments)},e.prototype._getTracer=function(){if(this._delegate)return this._delegate;var e=this._provider.getDelegateTracer(this.name,this.version,this.options);return e?(this._delegate=e,this._delegate):iv},e}(),iw=new(function(){function e(){}return e.prototype.getTracer=function(e,t,r){return new iy},e}()),ik=function(){function e(){}return e.prototype.getTracer=function(e,t,r){var a;return null!=(a=this.getDelegateTracer(e,t,r))?a:new ib(this,e,t,r)},e.prototype.getDelegate=function(){var e;return null!=(e=this._delegate)?e:iw},e.prototype.setDelegate=function(e){this._delegate=e},e.prototype.getDelegateTracer=function(e,t,r){var a;return null==(a=this._delegate)?void 0:a.getTracer(e,t,r)},e}();(ut=uN||(uN={}))[ut.UNSET=0]="UNSET",ut[ut.OK=1]="OK",ut[ut.ERROR=2]="ERROR";var i_="trace",iI=(function(){function e(){this._proxyTracerProvider=new ik,this.wrapSpanContext=ig,this.isSpanContextValid=im,this.deleteSpan=il,this.getSpan=is,this.getActiveSpan=ii,this.getSpanContext=ip,this.setSpan=io,this.setSpanContext=iu}return e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.setGlobalTracerProvider=function(e){var t=nB(i_,this._proxyTracerProvider,nX.instance());return t&&this._proxyTracerProvider.setDelegate(e),t},e.prototype.getTracerProvider=function(){return nV(i_)||this._proxyTracerProvider},e.prototype.getTracer=function(e,t){return this.getTracerProvider().getTracer(e,t)},e.prototype.disable=function(){nK(i_,nX.instance()),this._proxyTracerProvider=new ik},e})().getInstance(),iS=Object.defineProperty,ix=(e,t)=>{for(var r in t)iS(e,r,{get:t[r],enumerable:!0})};function iT(e,{contentType:t,dataStreamVersion:r}){let a=new Headers(null!=e?e:{});return a.has("Content-Type")||a.set("Content-Type",t),void 0!==r&&a.set("X-Vercel-AI-Data-Stream",r),a}function iE(e,{contentType:t,dataStreamVersion:r}){let a={};if(null!=e)for(let[t,r]of Object.entries(e))a[t]=r;return null==a["Content-Type"]&&(a["Content-Type"]=t),void 0!==r&&(a["X-Vercel-AI-Data-Stream"]=r),a}function iA({response:e,status:t,statusText:r,headers:a,stream:s}){e.writeHead(null!=t?t:200,r,a);let n=s.getReader();(async()=>{try{for(;;){let{done:t,value:r}=await n.read();if(t)break;e.write(r)}}catch(e){throw e}finally{e.end()}})()}var iO=class extends sT{constructor(){super({name:"AI_UnsupportedModelVersionError",message:'Unsupported model version. AI SDK 4 only supports models that implement specification version "v1". Please upgrade to AI SDK 5 to use this model.'})}},iz="AI_InvalidArgumentError",iM=`vercel.ai.error.${iz}`,iP=Symbol.for(iM),iR=class extends sT{constructor({parameter:e,value:t,message:r}){super({name:iz,message:`Invalid argument for parameter ${e}: ${r}`}),this[uL]=!0,this.parameter=e,this.value=t}static isInstance(e){return sT.hasMarker(e,iM)}};uL=iP;var iC="AI_RetryError",ij=`vercel.ai.error.${iC}`,iN=Symbol.for(ij),iL=class extends sT{constructor({message:e,reason:t,errors:r}){super({name:iC,message:e}),this[uD]=!0,this.reason=t,this.errors=r,this.lastError=r[r.length-1]}static isInstance(e){return sT.hasMarker(e,ij)}};async function iD(e,{maxRetries:t,delayInMs:r,backoffFactor:a},s=[]){try{return await e()}catch(l){if(l instanceof Error&&("AbortError"===l.name||"TimeoutError"===l.name)||0===t)throw l;let n=null==l?"unknown error":"string"==typeof l?l:l instanceof Error?l.message:JSON.stringify(l),i=[...s,l],o=i.length;if(o>t)throw new iL({message:`Failed after ${o} attempts. Last error: ${n}`,reason:"maxRetriesExceeded",errors:i});if(l instanceof Error&&sz.isInstance(l)&&!0===l.isRetryable&&o<=t)return await s2(r),iD(e,{maxRetries:t,delayInMs:a*r,backoffFactor:a},i);if(1===o)throw l;throw new iL({message:`Failed after ${o} attempts with non-retryable error: '${n}'`,reason:"errorNotRetryable",errors:i})}}function iq({maxRetries:e}){if(null!=e){if(!Number.isInteger(e))throw new iR({parameter:"maxRetries",value:e,message:"maxRetries must be an integer"});if(e<0)throw new iR({parameter:"maxRetries",value:e,message:"maxRetries must be >= 0"})}let t=null!=e?e:2;return{maxRetries:t,retry:(({maxRetries:e=2,initialDelayInMs:t=2e3,backoffFactor:r=2}={})=>async a=>iD(a,{maxRetries:e,delayInMs:t,backoffFactor:r}))({maxRetries:t})}}function i$({operationId:e,telemetry:t}){return{"operation.name":`${e}${(null==t?void 0:t.functionId)!=null?` ${t.functionId}`:""}`,"resource.name":null==t?void 0:t.functionId,"ai.operationId":e,"ai.telemetry.functionId":null==t?void 0:t.functionId}}function iF({model:e,settings:t,telemetry:r,headers:a}){var s;return{"ai.model.provider":e.provider,"ai.model.id":e.modelId,...Object.entries(t).reduce((e,[t,r])=>(e[`ai.settings.${t}`]=r,e),{}),...Object.entries(null!=(s=null==r?void 0:r.metadata)?s:{}).reduce((e,[t,r])=>(e[`ai.telemetry.metadata.${t}`]=r,e),{}),...Object.entries(null!=a?a:{}).reduce((e,[t,r])=>(void 0!==r&&(e[`ai.request.headers.${t}`]=r),e),{})}}uD=iN;var iU={startSpan:()=>iZ,startActiveSpan:(e,t,r,a)=>"function"==typeof t?t(iZ):"function"==typeof r?r(iZ):"function"==typeof a?a(iZ):void 0},iZ={spanContext:()=>iB,setAttribute(){return this},setAttributes(){return this},addEvent(){return this},addLink(){return this},addLinks(){return this},setStatus(){return this},updateName(){return this},end(){return this},isRecording:()=>!1,recordException(){return this}},iB={traceId:"",spanId:"",traceFlags:0};function iV({isEnabled:e=!1,tracer:t}={}){return e?t||iI.getTracer("ai"):iU}function iK({name:e,tracer:t,attributes:r,fn:a,endWhenDone:s=!0}){return t.startActiveSpan(e,{attributes:r},async e=>{try{let t=await a(e);return s&&e.end(),t}catch(t){try{iG(e,t)}finally{e.end()}throw t}})}function iG(e,t){t instanceof Error?(e.recordException({name:t.name,message:t.message,stack:t.stack}),e.setStatus({code:uN.ERROR,message:t.message})):e.setStatus({code:uN.ERROR})}function iW({telemetry:e,attributes:t}){return(null==e?void 0:e.isEnabled)!==!0?{}:Object.entries(t).reduce((t,[r,a])=>{if(void 0===a)return t;if("object"==typeof a&&"input"in a&&"function"==typeof a.input){if((null==e?void 0:e.recordInputs)===!1)return t;let s=a.input();return void 0===s?t:{...t,[r]:s}}if("object"==typeof a&&"output"in a&&"function"==typeof a.output){if((null==e?void 0:e.recordOutputs)===!1)return t;let s=a.output();return void 0===s?t:{...t,[r]:s}}return{...t,[r]:a}},{})}var iQ=class{constructor({data:e,mimeType:t}){const r=e instanceof Uint8Array;this.base64Data=r?void 0:e,this.uint8ArrayData=r?e:void 0,this.mimeType=t}get base64(){return null==this.base64Data&&(this.base64Data=nt(this.uint8ArrayData)),this.base64Data}get uint8Array(){return null==this.uint8ArrayData&&(this.uint8ArrayData=ne(this.base64Data)),this.uint8ArrayData}},iJ=class extends iQ{constructor(e){super(e),this.type="file"}},iH=[{mimeType:"image/gif",bytesPrefix:[71,73,70],base64Prefix:"R0lG"},{mimeType:"image/png",bytesPrefix:[137,80,78,71],base64Prefix:"iVBORw"},{mimeType:"image/jpeg",bytesPrefix:[255,216],base64Prefix:"/9j/"},{mimeType:"image/webp",bytesPrefix:[82,73,70,70],base64Prefix:"UklGRg"},{mimeType:"image/bmp",bytesPrefix:[66,77],base64Prefix:"Qk"},{mimeType:"image/tiff",bytesPrefix:[73,73,42,0],base64Prefix:"SUkqAA"},{mimeType:"image/tiff",bytesPrefix:[77,77,0,42],base64Prefix:"TU0AKg"},{mimeType:"image/avif",bytesPrefix:[0,0,0,32,102,116,121,112,97,118,105,102],base64Prefix:"AAAAIGZ0eXBhdmlm"},{mimeType:"image/heic",bytesPrefix:[0,0,0,32,102,116,121,112,104,101,105,99],base64Prefix:"AAAAIGZ0eXBoZWlj"}],iY="AI_NoObjectGeneratedError",iX=`vercel.ai.error.${iY}`,i0=Symbol.for(iX),i1=class extends sT{constructor({message:e="No object generated.",cause:t,text:r,response:a,usage:s,finishReason:n}){super({name:iY,message:e,cause:t}),this[uq]=!0,this.text=r,this.response=a,this.usage=s,this.finishReason=n}static isInstance(e){return sT.hasMarker(e,iX)}};uq=i0;var i2="AI_DownloadError",i3=`vercel.ai.error.${i2}`,i5=Symbol.for(i3),i4=class extends sT{constructor({url:e,statusCode:t,statusText:r,cause:a,message:s=null==a?`Failed to download ${e}: ${t} ${r}`:`Failed to download ${e}: ${a}`}){super({name:i2,message:s,cause:a}),this[u$]=!0,this.url=e,this.statusCode=t,this.statusText=r}static isInstance(e){return sT.hasMarker(e,i3)}};async function i6({url:e}){var t;let r=e.toString();try{let e=await fetch(r);if(!e.ok)throw new i4({url:r,statusCode:e.status,statusText:e.statusText});return{data:new Uint8Array(await e.arrayBuffer()),mimeType:null!=(t=e.headers.get("content-type"))?t:void 0}}catch(e){if(i4.isInstance(e))throw e;throw new i4({url:r,cause:e})}}u$=i5;var i7="AI_InvalidDataContentError",i9=`vercel.ai.error.${i7}`,i8=Symbol.for(i9),oe=class extends sT{constructor({content:e,cause:t,message:r=`Invalid data content. Expected a base64 string, Uint8Array, ArrayBuffer, or Buffer, but got ${typeof e}.`}){super({name:i7,message:r,cause:t}),this[uF]=!0,this.content=e}static isInstance(e){return sT.hasMarker(e,i9)}};uF=i8;var ot=sg.union([sg.string(),sg.instanceof(Uint8Array),sg.instanceof(ArrayBuffer),sg.custom(e=>{var t,r;return null!=(r=null==(t=globalThis.Buffer)?void 0:t.isBuffer(e))&&r},{message:"Must be a Buffer"})]);function or(e){return"string"==typeof e?e:e instanceof ArrayBuffer?nt(new Uint8Array(e)):nt(e)}function oa(e){if(e instanceof Uint8Array)return e;if("string"==typeof e)try{return ne(e)}catch(t){throw new oe({message:"Invalid data content. Content string is not a base64-encoded media.",content:e,cause:t})}if(e instanceof ArrayBuffer)return new Uint8Array(e);throw new oe({content:e})}var os="AI_InvalidMessageRoleError",on=`vercel.ai.error.${os}`,oi=Symbol.for(on),oo=class extends sT{constructor({role:e,message:t=`Invalid message role: '${e}'. Must be one of: "system", "user", "assistant", "tool".`}){super({name:os,message:t}),this[uU]=!0,this.role=e}static isInstance(e){return sT.hasMarker(e,on)}};async function ol({prompt:e,modelSupportsImageUrls:t=!0,modelSupportsUrl:r=()=>!1,downloadImplementation:a=i6}){let s=await ou(e.messages,a,t,r);return[...null!=e.system?[{role:"system",content:e.system}]:[],...e.messages.map(e=>(function(e,t){var r,a,s,n,i,o;let l=e.role;switch(l){case"system":return{role:"system",content:e.content,providerMetadata:null!=(r=e.providerOptions)?r:e.experimental_providerMetadata};case"user":if("string"==typeof e.content)return{role:"user",content:[{type:"text",text:e.content}],providerMetadata:null!=(a=e.providerOptions)?a:e.experimental_providerMetadata};return{role:"user",content:e.content.map(e=>(function(e,t){var r,a,s,n;let i,o,l;if("text"===e.type)return{type:"text",text:e.text,providerMetadata:null!=(r=e.providerOptions)?r:e.experimental_providerMetadata};let u=e.mimeType,p=e.type;switch(p){case"image":i=e.image;break;case"file":i=e.data;break;default:throw Error(`Unsupported part type: ${p}`)}try{o="string"==typeof i?new URL(i):i}catch(e){o=i}if(o instanceof URL)if("data:"===o.protocol){let{mimeType:e,base64Content:t}=function(e){try{let[t,r]=e.split(",");return{mimeType:t.split(";")[0].split(":")[1],base64Content:r}}catch(e){return{mimeType:void 0,base64Content:void 0}}}(o.toString());if(null==e||null==t)throw Error(`Invalid data URL format in part ${p}`);u=e,l=oa(t)}else{let e=t[o.toString()];e?(l=e.data,null!=u||(u=e.mimeType)):l=o}else l=oa(o);switch(p){case"image":return l instanceof Uint8Array&&(u=null!=(a=function({data:e,signatures:t}){let r,a,s="string"==typeof e&&e.startsWith("SUQz")||"string"!=typeof e&&e.length>10&&73===e[0]&&68===e[1]&&51===e[2]?(a=(127&(r="string"==typeof e?ne(e):e)[6])<<21|(127&r[7])<<14|(127&r[8])<<7|127&r[9],r.slice(a+10)):e;for(let e of t)if("string"==typeof s?s.startsWith(e.base64Prefix):s.length>=e.bytesPrefix.length&&e.bytesPrefix.every((e,t)=>s[t]===e))return e.mimeType}({data:l,signatures:iH}))?a:u),{type:"image",image:l,mimeType:u,providerMetadata:null!=(s=e.providerOptions)?s:e.experimental_providerMetadata};case"file":if(null==u)throw Error("Mime type is missing for file part");return{type:"file",data:l instanceof Uint8Array?or(l):l,filename:e.filename,mimeType:u,providerMetadata:null!=(n=e.providerOptions)?n:e.experimental_providerMetadata}}})(e,t)).filter(e=>"text"!==e.type||""!==e.text),providerMetadata:null!=(s=e.providerOptions)?s:e.experimental_providerMetadata};case"assistant":if("string"==typeof e.content)return{role:"assistant",content:[{type:"text",text:e.content}],providerMetadata:null!=(n=e.providerOptions)?n:e.experimental_providerMetadata};return{role:"assistant",content:e.content.filter(e=>"text"!==e.type||""!==e.text).map(e=>{var t;let r=null!=(t=e.providerOptions)?t:e.experimental_providerMetadata;switch(e.type){case"file":return{type:"file",data:e.data instanceof URL?e.data:or(e.data),filename:e.filename,mimeType:e.mimeType,providerMetadata:r};case"reasoning":return{type:"reasoning",text:e.text,signature:e.signature,providerMetadata:r};case"redacted-reasoning":return{type:"redacted-reasoning",data:e.data,providerMetadata:r};case"text":return{type:"text",text:e.text,providerMetadata:r};case"tool-call":return{type:"tool-call",toolCallId:e.toolCallId,toolName:e.toolName,args:e.args,providerMetadata:r}}}),providerMetadata:null!=(i=e.providerOptions)?i:e.experimental_providerMetadata};case"tool":return{role:"tool",content:e.content.map(e=>{var t;return{type:"tool-result",toolCallId:e.toolCallId,toolName:e.toolName,result:e.result,content:e.experimental_content,isError:e.isError,providerMetadata:null!=(t=e.providerOptions)?t:e.experimental_providerMetadata}}),providerMetadata:null!=(o=e.providerOptions)?o:e.experimental_providerMetadata};default:throw new oo({role:l})}})(e,s))]}async function ou(e,t,r,a){let s=e.filter(e=>"user"===e.role).map(e=>e.content).filter(e=>Array.isArray(e)).flat().filter(e=>"image"===e.type||"file"===e.type).filter(e=>"image"!==e.type||!0!==r).map(e=>"image"===e.type?e.image:e.data).map(e=>"string"==typeof e&&(e.startsWith("http:")||e.startsWith("https:"))?new URL(e):e).filter(e=>e instanceof URL).filter(e=>!a(e));return Object.fromEntries((await Promise.all(s.map(async e=>({url:e,data:await t({url:e})})))).map(({url:e,data:t})=>[e.toString(),t]))}function op({maxTokens:e,temperature:t,topP:r,topK:a,presencePenalty:s,frequencyPenalty:n,stopSequences:i,seed:o}){if(null!=e){if(!Number.isInteger(e))throw new iR({parameter:"maxTokens",value:e,message:"maxTokens must be an integer"});if(e<1)throw new iR({parameter:"maxTokens",value:e,message:"maxTokens must be >= 1"})}if(null!=t&&"number"!=typeof t)throw new iR({parameter:"temperature",value:t,message:"temperature must be a number"});if(null!=r&&"number"!=typeof r)throw new iR({parameter:"topP",value:r,message:"topP must be a number"});if(null!=a&&"number"!=typeof a)throw new iR({parameter:"topK",value:a,message:"topK must be a number"});if(null!=s&&"number"!=typeof s)throw new iR({parameter:"presencePenalty",value:s,message:"presencePenalty must be a number"});if(null!=n&&"number"!=typeof n)throw new iR({parameter:"frequencyPenalty",value:n,message:"frequencyPenalty must be a number"});if(null!=o&&!Number.isInteger(o))throw new iR({parameter:"seed",value:o,message:"seed must be an integer"});return{maxTokens:e,temperature:null!=t?t:0,topP:r,topK:a,presencePenalty:s,frequencyPenalty:n,stopSequences:null!=i&&i.length>0?i:void 0,seed:o}}function od(e){var t,r,a;let s=[];for(let n of e){let e;try{e=new URL(n.url)}catch(e){throw Error(`Invalid URL: ${n.url}`)}switch(e.protocol){case"http:":case"https:":if(null==(t=n.contentType)?void 0:t.startsWith("image/"))s.push({type:"image",image:e});else{if(!n.contentType)throw Error("If the attachment is not an image, it must specify a content type");s.push({type:"file",data:e,mimeType:n.contentType})}break;case"data:":{let e,t,i;try{[e,t]=n.url.split(","),i=e.split(";")[0].split(":")[1]}catch(e){throw Error(`Error processing data URL: ${n.url}`)}if(null==i||null==t)throw Error(`Invalid data URL format: ${n.url}`);if(null==(r=n.contentType)?void 0:r.startsWith("image/"))s.push({type:"image",image:oa(t)});else if(null==(a=n.contentType)?void 0:a.startsWith("text/"))s.push({type:"text",text:function(e){try{return new TextDecoder().decode(e)}catch(e){throw Error("Error decoding Uint8Array to text")}}(oa(t))});else{if(!n.contentType)throw Error("If the attachment is not an image or text, it must specify a content type");s.push({type:"file",data:t,mimeType:n.contentType})}break}default:throw Error(`Unsupported URL protocol: ${e.protocol}`)}}return s}uU=oi;var oc="AI_MessageConversionError",om=`vercel.ai.error.${oc}`,og=Symbol.for(om),oh=class extends sT{constructor({originalMessage:e,message:t}){super({name:oc,message:t}),this[uZ]=!0,this.originalMessage=e}static isInstance(e){return sT.hasMarker(e,om)}};function of(e,t){var r,a;let s=null!=(r=null==t?void 0:t.tools)?r:{},n=[];for(let t=0;t<e.length;t++){let r=e[t],i=t===e.length-1,{role:o,content:l,experimental_attachments:u}=r;switch(o){case"system":n.push({role:"system",content:l});break;case"user":if(null==r.parts)n.push({role:"user",content:u?[{type:"text",text:l},...od(u)]:l});else{let e=r.parts.filter(e=>"text"===e.type).map(e=>({type:"text",text:e.text}));n.push({role:"user",content:u?[...e,...od(u)]:e})}break;case"assistant":{if(null!=r.parts){let e=function(){let e=[];for(let t of o)switch(t.type){case"file":case"text":e.push(t);break;case"reasoning":for(let r of t.details)switch(r.type){case"text":e.push({type:"reasoning",text:r.text,signature:r.signature});break;case"redacted":e.push({type:"redacted-reasoning",data:r.data})}break;case"tool-invocation":e.push({type:"tool-call",toolCallId:t.toolInvocation.toolCallId,toolName:t.toolInvocation.toolName,args:t.toolInvocation.args});break;default:throw Error(`Unsupported part: ${t}`)}n.push({role:"assistant",content:e});let a=o.filter(e=>"tool-invocation"===e.type).map(e=>e.toolInvocation);a.length>0&&n.push({role:"tool",content:a.map(e=>{if(!("result"in e))throw new oh({originalMessage:r,message:"ToolInvocation must have a result: "+JSON.stringify(e)});let{toolCallId:t,toolName:a,result:n}=e,i=s[a];return(null==i?void 0:i.experimental_toToolResultContent)!=null?{type:"tool-result",toolCallId:t,toolName:a,result:i.experimental_toToolResultContent(n),experimental_content:i.experimental_toToolResultContent(n)}:{type:"tool-result",toolCallId:t,toolName:a,result:n}})}),o=[],i=!1,t++},t=0,i=!1,o=[];for(let s of r.parts)switch(s.type){case"text":i&&e(),o.push(s);break;case"file":case"reasoning":o.push(s);break;case"tool-invocation":(null!=(a=s.toolInvocation.step)?a:0)!==t&&e(),o.push(s),i=!0}e();break}let e=r.toolInvocations;if(null==e||0===e.length){n.push({role:"assistant",content:l});break}let t=e.reduce((e,t)=>{var r;return Math.max(e,null!=(r=t.step)?r:0)},0);for(let a=0;a<=t;a++){let t=e.filter(e=>{var t;return(null!=(t=e.step)?t:0)===a});0!==t.length&&(n.push({role:"assistant",content:[...i&&l&&0===a?[{type:"text",text:l}]:[],...t.map(({toolCallId:e,toolName:t,args:r})=>({type:"tool-call",toolCallId:e,toolName:t,args:r}))]}),n.push({role:"tool",content:t.map(e=>{if(!("result"in e))throw new oh({originalMessage:r,message:"ToolInvocation must have a result: "+JSON.stringify(e)});let{toolCallId:t,toolName:a,result:n}=e,i=s[a];return(null==i?void 0:i.experimental_toToolResultContent)!=null?{type:"tool-result",toolCallId:t,toolName:a,result:i.experimental_toToolResultContent(n),experimental_content:i.experimental_toToolResultContent(n)}:{type:"tool-result",toolCallId:t,toolName:a,result:n}})}))}l&&!i&&n.push({role:"assistant",content:l});break}case"data":break;default:throw new oh({originalMessage:r,message:`Unsupported role: ${o}`})}}return n}uZ=og;var oy=sg.lazy(()=>sg.union([sg.null(),sg.string(),sg.number(),sg.boolean(),sg.record(sg.string(),oy),sg.array(oy)])),ov=sg.record(sg.string(),sg.record(sg.string(),oy)),ob=sg.array(sg.union([sg.object({type:sg.literal("text"),text:sg.string()}),sg.object({type:sg.literal("image"),data:sg.string(),mimeType:sg.string().optional()})])),ow=sg.object({type:sg.literal("text"),text:sg.string(),providerOptions:ov.optional(),experimental_providerMetadata:ov.optional()}),ok=sg.object({type:sg.literal("image"),image:sg.union([ot,sg.instanceof(URL)]),mimeType:sg.string().optional(),providerOptions:ov.optional(),experimental_providerMetadata:ov.optional()}),o_=sg.object({type:sg.literal("file"),data:sg.union([ot,sg.instanceof(URL)]),filename:sg.string().optional(),mimeType:sg.string(),providerOptions:ov.optional(),experimental_providerMetadata:ov.optional()}),oI=sg.object({type:sg.literal("reasoning"),text:sg.string(),providerOptions:ov.optional(),experimental_providerMetadata:ov.optional()}),oS=sg.object({type:sg.literal("redacted-reasoning"),data:sg.string(),providerOptions:ov.optional(),experimental_providerMetadata:ov.optional()}),ox=sg.object({type:sg.literal("tool-call"),toolCallId:sg.string(),toolName:sg.string(),args:sg.unknown(),providerOptions:ov.optional(),experimental_providerMetadata:ov.optional()}),oT=sg.object({type:sg.literal("tool-result"),toolCallId:sg.string(),toolName:sg.string(),result:sg.unknown(),content:ob.optional(),isError:sg.boolean().optional(),providerOptions:ov.optional(),experimental_providerMetadata:ov.optional()}),oE=sg.object({role:sg.literal("system"),content:sg.string(),providerOptions:ov.optional(),experimental_providerMetadata:ov.optional()}),oA=sg.object({role:sg.literal("user"),content:sg.union([sg.string(),sg.array(sg.union([ow,ok,o_]))]),providerOptions:ov.optional(),experimental_providerMetadata:ov.optional()}),oO=sg.object({role:sg.literal("assistant"),content:sg.union([sg.string(),sg.array(sg.union([ow,o_,oI,oS,ox]))]),providerOptions:ov.optional(),experimental_providerMetadata:ov.optional()}),oz=sg.object({role:sg.literal("tool"),content:sg.array(oT),providerOptions:ov.optional(),experimental_providerMetadata:ov.optional()}),oM=sg.union([oE,oA,oO,oz]);function oP({prompt:e,tools:t}){if(null==e.prompt&&null==e.messages)throw new sq({prompt:e,message:"prompt or messages must be defined"});if(null!=e.prompt&&null!=e.messages)throw new sq({prompt:e,message:"prompt and messages cannot be defined at the same time"});if(null!=e.system&&"string"!=typeof e.system)throw new sq({prompt:e,message:"system must be a string"});if(null!=e.prompt){if("string"!=typeof e.prompt)throw new sq({prompt:e,message:"prompt must be a string"});return{type:"prompt",system:e.system,messages:[{role:"user",content:e.prompt}]}}if(null!=e.messages){let r="ui-messages"===function(e){if(!Array.isArray(e))throw new sq({prompt:e,message:`messages must be an array of CoreMessage or UIMessage
Received non-array value: ${JSON.stringify(e)}`,cause:e});if(0===e.length)return"messages";let t=e.map(oR);if(t.some(e=>"has-ui-specific-parts"===e))return"ui-messages";let r=t.findIndex(e=>"has-core-specific-parts"!==e&&"message"!==e);if(-1===r)return"messages";throw new sq({prompt:e,message:`messages must be an array of CoreMessage or UIMessage
Received message of type: "${t[r]}" at index ${r}
messages[${r}]: ${JSON.stringify(e[r])}`,cause:e})}(e.messages)?of(e.messages,{tools:t}):e.messages;if(0===r.length)throw new sq({prompt:e,message:"messages must not be empty"});let a=s6({value:r,schema:sg.array(oM)});if(!a.success)throw new sq({prompt:e,message:`message must be a CoreMessage or a UI message
Validation error: ${a.error.message}`,cause:a.error});return{type:"messages",messages:r,system:e.system}}throw Error("unreachable")}function oR(e){return"object"==typeof e&&null!==e&&("function"===e.role||"data"===e.role||"toolInvocations"in e||"parts"in e||"experimental_attachments"in e)?"has-ui-specific-parts":"object"==typeof e&&null!==e&&"content"in e&&(Array.isArray(e.content)||"experimental_providerMetadata"in e||"providerOptions"in e)?"has-core-specific-parts":"object"==typeof e&&null!==e&&"role"in e&&"content"in e&&"string"==typeof e.content&&["system","user","assistant","tool"].includes(e.role)?"message":"other"}function oC({promptTokens:e,completionTokens:t}){return{promptTokens:e,completionTokens:t,totalTokens:e+t}}function oj(e,t){return{promptTokens:e.promptTokens+t.promptTokens,completionTokens:e.completionTokens+t.completionTokens,totalTokens:e.totalTokens+t.totalTokens}}function oN({prompt:e,schema:t,schemaPrefix:r=null!=t?"JSON schema:":void 0,schemaSuffix:a=null!=t?"You MUST answer with a JSON object that matches the JSON schema above.":"You MUST answer with JSON."}){return[null!=e&&e.length>0?e:void 0,null!=e&&e.length>0?"":void 0,r,null!=t?JSON.stringify(t):void 0,a].filter(e=>null!=e).join("\n")}function oL(e){let t=e.pipeThrough(new TransformStream);return t[Symbol.asyncIterator]=()=>{let e=t.getReader();return{async next(){let{done:t,value:r}=await e.read();return t?{done:!0,value:void 0}:{done:!1,value:r}}}},t}var oD={type:"no-schema",jsonSchema:void 0,validatePartialResult:({value:e,textDelta:t})=>({success:!0,value:{partial:e,textDelta:t}}),validateFinalResult:(e,t)=>void 0===e?{success:!1,error:new i1({message:"No object generated: response did not match schema.",text:t.text,response:t.response,usage:t.usage,finishReason:t.finishReason})}:{success:!0,value:e},createElementStream(){throw new sH({functionality:"element streams in no-schema mode"})}};function oq({output:e,schema:t,enumValues:r}){switch(e){case"object":let a;return{type:"object",jsonSchema:(a=nD(t)).jsonSchema,validatePartialResult:({value:e,textDelta:t})=>({success:!0,value:{partial:e,textDelta:t}}),validateFinalResult:e=>s6({value:e,schema:a}),createElementStream(){throw new sH({functionality:"element streams in object mode"})}};case"array":return(e=>{let{$schema:t,...r}=e.jsonSchema;return{type:"enum",jsonSchema:{$schema:"http://json-schema.org/draft-07/schema#",type:"object",properties:{elements:{type:"array",items:r}},required:["elements"],additionalProperties:!1},validatePartialResult({value:t,latestObject:r,isFirstDelta:a,isFinalDelta:s}){var n;if(!s0(t)||!sX(t.elements))return{success:!1,error:new sG({value:t,cause:"value must be an object that contains an array of elements"})};let i=t.elements,o=[];for(let t=0;t<i.length;t++){let r=s6({value:i[t],schema:e});if(t!==i.length-1||s){if(!r.success)return r;o.push(r.value)}}let l=null!=(n=null==r?void 0:r.length)?n:0,u="";return a&&(u+="["),l>0&&(u+=","),u+=o.slice(l).map(e=>JSON.stringify(e)).join(","),s&&(u+="]"),{success:!0,value:{partial:o,textDelta:u}}},validateFinalResult(t){if(!s0(t)||!sX(t.elements))return{success:!1,error:new sG({value:t,cause:"value must be an object that contains an array of elements"})};let r=t.elements;for(let t of r){let r=s6({value:t,schema:e});if(!r.success)return r}return{success:!0,value:r}},createElementStream(e){let t=0;return oL(e.pipeThrough(new TransformStream({transform(e,r){switch(e.type){case"object":{let a=e.object;for(;t<a.length;t++)r.enqueue(a[t]);break}case"text-delta":case"finish":case"error":break;default:throw Error(`Unsupported chunk type: ${e}`)}}})))}}})(nD(t));case"enum":return{type:"enum",jsonSchema:{$schema:"http://json-schema.org/draft-07/schema#",type:"object",properties:{result:{type:"string",enum:r}},required:["result"],additionalProperties:!1},validateFinalResult(e){if(!s0(e)||"string"!=typeof e.result)return{success:!1,error:new sG({value:e,cause:'value must be an object that contains a string in the "result" property.'})};let t=e.result;return r.includes(t)?{success:!0,value:t}:{success:!1,error:new sG({value:e,cause:"value must be a string in the enum"})}},validatePartialResult(){throw new sH({functionality:"partial results in enum mode"})},createElementStream(){throw new sH({functionality:"element streams in enum mode"})}};case"no-schema":return oD;default:throw Error(`Unsupported output: ${e}`)}}function o$({output:e,mode:t,schema:r,schemaName:a,schemaDescription:s,enumValues:n}){if(null!=e&&"object"!==e&&"array"!==e&&"enum"!==e&&"no-schema"!==e)throw new iR({parameter:"output",value:e,message:"Invalid output type."});if("no-schema"===e){if("auto"===t||"tool"===t)throw new iR({parameter:"mode",value:t,message:'Mode must be "json" for no-schema output.'});if(null!=r)throw new iR({parameter:"schema",value:r,message:"Schema is not supported for no-schema output."});if(null!=s)throw new iR({parameter:"schemaDescription",value:s,message:"Schema description is not supported for no-schema output."});if(null!=a)throw new iR({parameter:"schemaName",value:a,message:"Schema name is not supported for no-schema output."});if(null!=n)throw new iR({parameter:"enumValues",value:n,message:"Enum values are not supported for no-schema output."})}if("object"===e){if(null==r)throw new iR({parameter:"schema",value:r,message:"Schema is required for object output."});if(null!=n)throw new iR({parameter:"enumValues",value:n,message:"Enum values are not supported for object output."})}if("array"===e){if(null==r)throw new iR({parameter:"schema",value:r,message:"Element schema is required for array output."});if(null!=n)throw new iR({parameter:"enumValues",value:n,message:"Enum values are not supported for array output."})}if("enum"===e){if(null!=r)throw new iR({parameter:"schema",value:r,message:"Schema is not supported for enum output."});if(null!=s)throw new iR({parameter:"schemaDescription",value:s,message:"Schema description is not supported for enum output."});if(null!=a)throw new iR({parameter:"schemaName",value:a,message:"Schema name is not supported for enum output."});if(null==n)throw new iR({parameter:"enumValues",value:n,message:"Enum values are required for enum output."});for(let e of n)if("string"!=typeof e)throw new iR({parameter:"enumValues",value:e,message:"Enum values must be strings."})}}function oF(e){return JSON.stringify(e.map(e=>({...e,content:"string"==typeof e.content?e.content:e.content.map(oU)})))}function oU(e){return"image"===e.type?{...e,image:e.image instanceof Uint8Array?or(e.image):e.image}:e}var oZ=s3({prefix:"aiobj",size:24});async function oB({model:e,enum:t,schema:r,schemaName:a,schemaDescription:s,mode:n,output:i="object",system:o,prompt:l,messages:u,maxRetries:p,abortSignal:d,headers:c,experimental_repairText:m,experimental_telemetry:g,experimental_providerMetadata:h,providerOptions:f=h,_internal:{generateId:y=oZ,currentDate:v=()=>new Date}={},...b}){if("string"==typeof e||"v1"!==e.specificationVersion)throw new iO;o$({output:i,mode:n,schema:r,schemaName:a,schemaDescription:s,enumValues:t});let{maxRetries:w,retry:k}=iq({maxRetries:p}),_=oq({output:i,schema:r,enumValues:t});"no-schema"===_.type&&void 0===n&&(n="json");let I=iF({model:e,telemetry:g,headers:c,settings:{...b,maxRetries:w}}),S=iV(g);return iK({name:"ai.generateObject",attributes:iW({telemetry:g,attributes:{...i$({operationId:"ai.generateObject",telemetry:g}),...I,"ai.prompt":{input:()=>JSON.stringify({system:o,prompt:l,messages:u})},"ai.schema":null!=_.jsonSchema?{input:()=>JSON.stringify(_.jsonSchema)}:void 0,"ai.schema.name":a,"ai.schema.description":s,"ai.settings.output":_.type,"ai.settings.mode":n}}),tracer:S,fn:async t=>{var r,i,p,h;let w,x,T,E,A,O,z,M,P,R;switch(("auto"===n||null==n)&&(n=e.defaultObjectGenerationMode),n){case"json":{let t=oP({prompt:{system:null==_.jsonSchema?oN({prompt:o}):e.supportsStructuredOutputs?o:oN({prompt:o,schema:_.jsonSchema}),prompt:l,messages:u},tools:void 0}),p=await ol({prompt:t,modelSupportsImageUrls:e.supportsImageUrls,modelSupportsUrl:null==(r=e.supportsUrl)?void 0:r.bind(e)}),m=await k(()=>iK({name:"ai.generateObject.doGenerate",attributes:iW({telemetry:g,attributes:{...i$({operationId:"ai.generateObject.doGenerate",telemetry:g}),...I,"ai.prompt.format":{input:()=>t.type},"ai.prompt.messages":{input:()=>JSON.stringify(p)},"ai.settings.mode":n,"gen_ai.system":e.provider,"gen_ai.request.model":e.modelId,"gen_ai.request.frequency_penalty":b.frequencyPenalty,"gen_ai.request.max_tokens":b.maxTokens,"gen_ai.request.presence_penalty":b.presencePenalty,"gen_ai.request.temperature":b.temperature,"gen_ai.request.top_k":b.topK,"gen_ai.request.top_p":b.topP}}),tracer:S,fn:async r=>{var n,i,o,l,u,m;let h=await e.doGenerate({mode:{type:"object-json",schema:_.jsonSchema,name:a,description:s},...op(b),inputFormat:t.type,prompt:p,providerMetadata:f,abortSignal:d,headers:c}),w={id:null!=(i=null==(n=h.response)?void 0:n.id)?i:y(),timestamp:null!=(l=null==(o=h.response)?void 0:o.timestamp)?l:v(),modelId:null!=(m=null==(u=h.response)?void 0:u.modelId)?m:e.modelId};if(void 0===h.text)throw new i1({message:"No object generated: the model did not return a response.",response:w,usage:oC(h.usage),finishReason:h.finishReason});return r.setAttributes(iW({telemetry:g,attributes:{"ai.response.finishReason":h.finishReason,"ai.response.object":{output:()=>h.text},"ai.response.id":w.id,"ai.response.model":w.modelId,"ai.response.timestamp":w.timestamp.toISOString(),"ai.response.providerMetadata":JSON.stringify(h.providerMetadata),"ai.usage.promptTokens":h.usage.promptTokens,"ai.usage.completionTokens":h.usage.completionTokens,"gen_ai.response.finish_reasons":[h.finishReason],"gen_ai.response.id":w.id,"gen_ai.response.model":w.modelId,"gen_ai.usage.prompt_tokens":h.usage.promptTokens,"gen_ai.usage.completion_tokens":h.usage.completionTokens}})),{...h,objectText:h.text,responseData:w}}}));w=m.objectText,x=m.finishReason,T=m.usage,E=m.warnings,A=m.rawResponse,M=m.logprobs,P=m.providerMetadata,z=null!=(i=m.request)?i:{},O=m.responseData;break}case"tool":{let t=oP({prompt:{system:o,prompt:l,messages:u},tools:void 0}),r=await ol({prompt:t,modelSupportsImageUrls:e.supportsImageUrls,modelSupportsUrl:null==(p=e.supportsUrl)?void 0:p.bind(e)}),i=t.type,m=await k(()=>iK({name:"ai.generateObject.doGenerate",attributes:iW({telemetry:g,attributes:{...i$({operationId:"ai.generateObject.doGenerate",telemetry:g}),...I,"ai.prompt.format":{input:()=>i},"ai.prompt.messages":{input:()=>oF(r)},"ai.settings.mode":n,"gen_ai.system":e.provider,"gen_ai.request.model":e.modelId,"gen_ai.request.frequency_penalty":b.frequencyPenalty,"gen_ai.request.max_tokens":b.maxTokens,"gen_ai.request.presence_penalty":b.presencePenalty,"gen_ai.request.temperature":b.temperature,"gen_ai.request.top_k":b.topK,"gen_ai.request.top_p":b.topP}}),tracer:S,fn:async t=>{var n,o,l,u,p,m,h,w;let k=await e.doGenerate({mode:{type:"object-tool",tool:{type:"function",name:null!=a?a:"json",description:null!=s?s:"Respond with a JSON object.",parameters:_.jsonSchema}},...op(b),inputFormat:i,prompt:r,providerMetadata:f,abortSignal:d,headers:c}),I=null==(o=null==(n=k.toolCalls)?void 0:n[0])?void 0:o.args,S={id:null!=(u=null==(l=k.response)?void 0:l.id)?u:y(),timestamp:null!=(m=null==(p=k.response)?void 0:p.timestamp)?m:v(),modelId:null!=(w=null==(h=k.response)?void 0:h.modelId)?w:e.modelId};if(void 0===I)throw new i1({message:"No object generated: the tool was not called.",response:S,usage:oC(k.usage),finishReason:k.finishReason});return t.setAttributes(iW({telemetry:g,attributes:{"ai.response.finishReason":k.finishReason,"ai.response.object":{output:()=>I},"ai.response.id":S.id,"ai.response.model":S.modelId,"ai.response.timestamp":S.timestamp.toISOString(),"ai.response.providerMetadata":JSON.stringify(k.providerMetadata),"ai.usage.promptTokens":k.usage.promptTokens,"ai.usage.completionTokens":k.usage.completionTokens,"gen_ai.response.finish_reasons":[k.finishReason],"gen_ai.response.id":S.id,"gen_ai.response.model":S.modelId,"gen_ai.usage.input_tokens":k.usage.promptTokens,"gen_ai.usage.output_tokens":k.usage.completionTokens}})),{...k,objectText:I,responseData:S}}}));w=m.objectText,x=m.finishReason,T=m.usage,E=m.warnings,A=m.rawResponse,M=m.logprobs,P=m.providerMetadata,z=null!=(h=m.request)?h:{},O=m.responseData;break}case void 0:throw Error("Model does not have a default object generation mode.");default:{let e=n;throw Error(`Unsupported mode: ${e}`)}}function C(e){let t=s7({text:e});if(!t.success)throw new i1({message:"No object generated: could not parse the response.",cause:t.error,text:e,response:O,usage:oC(T),finishReason:x});let r=_.validateFinalResult(t.value,{text:e,response:O,usage:oC(T)});if(!r.success)throw new i1({message:"No object generated: response did not match schema.",cause:r.error,text:e,response:O,usage:oC(T),finishReason:x});return r.value}try{R=C(w)}catch(e){if(null!=m&&i1.isInstance(e)&&(sZ.isInstance(e.cause)||sG.isInstance(e.cause))){let t=await m({text:w,error:e.cause});if(null===t)throw e;R=C(t)}else throw e}return t.setAttributes(iW({telemetry:g,attributes:{"ai.response.finishReason":x,"ai.response.object":{output:()=>JSON.stringify(R)},"ai.usage.promptTokens":T.promptTokens,"ai.usage.completionTokens":T.completionTokens}})),new oV({object:R,finishReason:x,usage:oC(T),warnings:E,request:z,response:{...O,headers:null==A?void 0:A.headers,body:null==A?void 0:A.body},logprobs:M,providerMetadata:P})}})}var oV=class{constructor(e){this.object=e.object,this.finishReason=e.finishReason,this.usage=e.usage,this.warnings=e.warnings,this.providerMetadata=e.providerMetadata,this.experimental_providerMetadata=e.providerMetadata,this.response=e.response,this.request=e.request,this.logprobs=e.logprobs}toJsonResponse(e){var t;return new Response(JSON.stringify(this.object),{status:null!=(t=null==e?void 0:e.status)?t:200,headers:iT(null==e?void 0:e.headers,{contentType:"application/json; charset=utf-8"})})}},oK=class{constructor(){this.status={type:"pending"},this._resolve=void 0,this._reject=void 0}get value(){return this.promise||(this.promise=new Promise((e,t)=>{"resolved"===this.status.type?e(this.status.value):"rejected"===this.status.type&&t(this.status.error),this._resolve=e,this._reject=t})),this.promise}resolve(e){var t;this.status={type:"resolved",value:e},this.promise&&(null==(t=this._resolve)||t.call(this,e))}reject(e){var t;this.status={type:"rejected",error:e},this.promise&&(null==(t=this._reject)||t.call(this,e))}};function oG(){let e,t;return{promise:new Promise((r,a)=>{e=r,t=a}),resolve:e,reject:t}}function oW(){let e=[],t=null,r=!1,a=oG(),s=async()=>{if(r&&0===e.length){null==t||t.close();return}if(0===e.length)return a=oG(),await a.promise,s();try{let{value:a,done:n}=await e[0].read();n?(e.shift(),e.length>0?await s():r&&(null==t||t.close())):null==t||t.enqueue(a)}catch(a){null==t||t.error(a),e.shift(),r&&0===e.length&&(null==t||t.close())}};return{stream:new ReadableStream({start(e){t=e},pull:s,async cancel(){for(let t of e)await t.cancel();e=[],r=!0}}),addStream:t=>{if(r)throw Error("Cannot add inner stream: outer stream is closed");e.push(t.getReader()),a.resolve()},close:()=>{r=!0,a.resolve(),0===e.length&&(null==t||t.close())},terminate:()=>{r=!0,a.resolve(),e.forEach(e=>e.cancel()),e=[],null==t||t.close()}}}function oQ(){var e,t;return null!=(t=null==(e=null==globalThis?void 0:globalThis.performance)?void 0:e.now())?t:Date.now()}var oJ=s3({prefix:"aiobj",size:24}),oH=class{constructor({model:e,headers:t,telemetry:r,settings:a,maxRetries:s,abortSignal:n,outputStrategy:i,system:o,prompt:l,messages:u,schemaName:p,schemaDescription:d,providerOptions:c,mode:m,onError:g,onFinish:h,generateId:f,currentDate:y,now:v}){this.objectPromise=new oK,this.usagePromise=new oK,this.providerMetadataPromise=new oK,this.warningsPromise=new oK,this.requestPromise=new oK,this.responsePromise=new oK;const{maxRetries:b,retry:w}=iq({maxRetries:s}),k=iF({model:e,telemetry:r,headers:t,settings:{...a,maxRetries:b}}),_=iV(r),I=this,S=oW(),x=new TransformStream({transform(e,t){t.enqueue(e),"error"===e.type&&(null==g||g({error:e.error}))}});this.baseStream=S.stream.pipeThrough(x),iK({name:"ai.streamObject",attributes:iW({telemetry:r,attributes:{...i$({operationId:"ai.streamObject",telemetry:r}),...k,"ai.prompt":{input:()=>JSON.stringify({system:o,prompt:l,messages:u})},"ai.schema":null!=i.jsonSchema?{input:()=>JSON.stringify(i.jsonSchema)}:void 0,"ai.schema.name":p,"ai.schema.description":d,"ai.settings.output":i.type,"ai.settings.mode":m}}),tracer:_,endWhenDone:!1,fn:async s=>{var g,b;let x,T,E,A,O,z,M,P,R;switch(("auto"===m||null==m)&&(m=e.defaultObjectGenerationMode),m){case"json":{let r=oP({prompt:{system:null==i.jsonSchema?oN({prompt:o}):e.supportsStructuredOutputs?o:oN({prompt:o,schema:i.jsonSchema}),prompt:l,messages:u},tools:void 0});x={mode:{type:"object-json",schema:i.jsonSchema,name:p,description:d},...op(a),inputFormat:r.type,prompt:await ol({prompt:r,modelSupportsImageUrls:e.supportsImageUrls,modelSupportsUrl:null==(g=e.supportsUrl)?void 0:g.bind(e)}),providerMetadata:c,abortSignal:n,headers:t},T={transform:(e,t)=>{switch(e.type){case"text-delta":t.enqueue(e.textDelta);break;case"response-metadata":case"finish":case"error":t.enqueue(e)}}};break}case"tool":{let r=oP({prompt:{system:o,prompt:l,messages:u},tools:void 0});x={mode:{type:"object-tool",tool:{type:"function",name:null!=p?p:"json",description:null!=d?d:"Respond with a JSON object.",parameters:i.jsonSchema}},...op(a),inputFormat:r.type,prompt:await ol({prompt:r,modelSupportsImageUrls:e.supportsImageUrls,modelSupportsUrl:null==(b=e.supportsUrl)?void 0:b.bind(e)}),providerMetadata:c,abortSignal:n,headers:t},T={transform(e,t){switch(e.type){case"tool-call-delta":t.enqueue(e.argsTextDelta);break;case"response-metadata":case"finish":case"error":t.enqueue(e)}}};break}case void 0:throw Error("Model does not have a default object generation mode.");default:{let e=m;throw Error(`Unsupported mode: ${e}`)}}let{result:{stream:C,warnings:j,rawResponse:N,request:L},doStreamSpan:D,startTimestampMs:q}=await w(()=>iK({name:"ai.streamObject.doStream",attributes:iW({telemetry:r,attributes:{...i$({operationId:"ai.streamObject.doStream",telemetry:r}),...k,"ai.prompt.format":{input:()=>x.inputFormat},"ai.prompt.messages":{input:()=>oF(x.prompt)},"ai.settings.mode":m,"gen_ai.system":e.provider,"gen_ai.request.model":e.modelId,"gen_ai.request.frequency_penalty":a.frequencyPenalty,"gen_ai.request.max_tokens":a.maxTokens,"gen_ai.request.presence_penalty":a.presencePenalty,"gen_ai.request.temperature":a.temperature,"gen_ai.request.top_k":a.topK,"gen_ai.request.top_p":a.topP}}),tracer:_,endWhenDone:!1,fn:async t=>({startTimestampMs:v(),doStreamSpan:t,result:await e.doStream(x)})}));I.requestPromise.resolve(null!=L?L:{});let $="",F="",U={id:f(),timestamp:y(),modelId:e.modelId},Z=!0,B=!0,V=C.pipeThrough(new TransformStream(T)).pipeThrough(new TransformStream({async transform(e,t){var r,a,s;if(Z){let e=v()-q;Z=!1,D.addEvent("ai.stream.firstChunk",{"ai.stream.msToFirstChunk":e}),D.setAttributes({"ai.stream.msToFirstChunk":e})}if("string"==typeof e){$+=e,F+=e;let{value:r,state:a}=nR($);if(void 0!==r&&!nN(P,r)){let e=i.validatePartialResult({value:r,textDelta:F,latestObject:R,isFirstDelta:B,isFinalDelta:"successful-parse"===a});e.success&&!nN(R,e.value.partial)&&(P=r,R=e.value.partial,t.enqueue({type:"object",object:R}),t.enqueue({type:"text-delta",textDelta:e.value.textDelta}),F="",B=!1)}return}switch(e.type){case"response-metadata":U={id:null!=(r=e.id)?r:U.id,timestamp:null!=(a=e.timestamp)?a:U.timestamp,modelId:null!=(s=e.modelId)?s:U.modelId};break;case"finish":{""!==F&&t.enqueue({type:"text-delta",textDelta:F}),A=e.finishReason,E=oC(e.usage),O=e.providerMetadata,t.enqueue({...e,usage:E,response:U}),I.usagePromise.resolve(E),I.providerMetadataPromise.resolve(O),I.responsePromise.resolve({...U,headers:null==N?void 0:N.headers});let r=i.validateFinalResult(P,{text:$,response:U,usage:E});r.success?(z=r.value,I.objectPromise.resolve(z)):(M=new i1({message:"No object generated: response did not match schema.",cause:r.error,text:$,response:U,usage:E,finishReason:A}),I.objectPromise.reject(M));break}default:t.enqueue(e)}},async flush(e){try{let e=null!=E?E:{promptTokens:NaN,completionTokens:NaN,totalTokens:NaN};D.setAttributes(iW({telemetry:r,attributes:{"ai.response.finishReason":A,"ai.response.object":{output:()=>JSON.stringify(z)},"ai.response.id":U.id,"ai.response.model":U.modelId,"ai.response.timestamp":U.timestamp.toISOString(),"ai.response.providerMetadata":JSON.stringify(O),"ai.usage.promptTokens":e.promptTokens,"ai.usage.completionTokens":e.completionTokens,"gen_ai.response.finish_reasons":[A],"gen_ai.response.id":U.id,"gen_ai.response.model":U.modelId,"gen_ai.usage.input_tokens":e.promptTokens,"gen_ai.usage.output_tokens":e.completionTokens}})),D.end(),s.setAttributes(iW({telemetry:r,attributes:{"ai.usage.promptTokens":e.promptTokens,"ai.usage.completionTokens":e.completionTokens,"ai.response.object":{output:()=>JSON.stringify(z)},"ai.response.providerMetadata":JSON.stringify(O)}})),await (null==h?void 0:h({usage:e,object:z,error:M,response:{...U,headers:null==N?void 0:N.headers},warnings:j,providerMetadata:O,experimental_providerMetadata:O}))}catch(t){e.enqueue({type:"error",error:t})}finally{s.end()}}}));S.addStream(V)}}).catch(e=>{S.addStream(new ReadableStream({start(t){t.enqueue({type:"error",error:e}),t.close()}}))}).finally(()=>{S.close()}),this.outputStrategy=i}get object(){return this.objectPromise.value}get usage(){return this.usagePromise.value}get experimental_providerMetadata(){return this.providerMetadataPromise.value}get providerMetadata(){return this.providerMetadataPromise.value}get warnings(){return this.warningsPromise.value}get request(){return this.requestPromise.value}get response(){return this.responsePromise.value}get partialObjectStream(){return oL(this.baseStream.pipeThrough(new TransformStream({transform(e,t){switch(e.type){case"object":t.enqueue(e.object);break;case"text-delta":case"finish":case"error":break;default:throw Error(`Unsupported chunk type: ${e}`)}}})))}get elementStream(){return this.outputStrategy.createElementStream(this.baseStream)}get textStream(){return oL(this.baseStream.pipeThrough(new TransformStream({transform(e,t){switch(e.type){case"text-delta":t.enqueue(e.textDelta);break;case"object":case"finish":case"error":break;default:throw Error(`Unsupported chunk type: ${e}`)}}})))}get fullStream(){return oL(this.baseStream)}pipeTextStreamToResponse(e,t){iA({response:e,status:null==t?void 0:t.status,statusText:null==t?void 0:t.statusText,headers:iE(null==t?void 0:t.headers,{contentType:"text/plain; charset=utf-8"}),stream:this.textStream.pipeThrough(new TextEncoderStream)})}toTextStreamResponse(e){var t;return new Response(this.textStream.pipeThrough(new TextEncoderStream),{status:null!=(t=null==e?void 0:e.status)?t:200,headers:iT(null==e?void 0:e.headers,{contentType:"text/plain; charset=utf-8"})})}},oY="AI_NoOutputSpecifiedError",oX=`vercel.ai.error.${oY}`,o0=Symbol.for(oX),o1=class extends sT{constructor({message:e="No output specified."}={}){super({name:oY,message:e}),this[uB]=!0}static isInstance(e){return sT.hasMarker(e,oX)}};uB=o0;var o2="AI_ToolExecutionError",o3=`vercel.ai.error.${o2}`,o5=Symbol.for(o3),o4=class extends sT{constructor({toolArgs:e,toolName:t,toolCallId:r,cause:a,message:s=`Error executing tool ${t}: ${sM(a)}`}){super({name:o2,message:s,cause:a}),this[uV]=!0,this.toolArgs=e,this.toolName=t,this.toolCallId=r}static isInstance(e){return sT.hasMarker(e,o3)}};function o6({tools:e,toolChoice:t,activeTools:r}){return null!=e&&Object.keys(e).length>0?{tools:(null!=r?Object.entries(e).filter(([e])=>r.includes(e)):Object.entries(e)).map(([e,t])=>{let r=t.type;switch(r){case void 0:case"function":return{type:"function",name:e,description:t.description,parameters:nD(t.parameters).jsonSchema};case"provider-defined":return{type:"provider-defined",name:e,id:t.id,args:t.args};default:throw Error(`Unsupported tool type: ${r}`)}}),toolChoice:null==t?{type:"auto"}:"string"==typeof t?{type:t}:{type:"tool",toolName:t.toolName}}:{tools:void 0,toolChoice:void 0}}uV=o5;var o7=/^([\s\S]*?)(\s+)(\S*)$/;function o9(e){let t=e.match(o7);return t?{prefix:t[1],whitespace:t[2],suffix:t[3]}:void 0}var o8="AI_InvalidToolArgumentsError",le=`vercel.ai.error.${o8}`,lt=Symbol.for(le),lr=class extends sT{constructor({toolArgs:e,toolName:t,cause:r,message:a=`Invalid arguments for tool ${t}: ${sM(r)}`}){super({name:o8,message:a,cause:r}),this[uK]=!0,this.toolArgs=e,this.toolName=t}static isInstance(e){return sT.hasMarker(e,le)}};uK=lt;var la="AI_NoSuchToolError",ls=`vercel.ai.error.${la}`,ln=Symbol.for(ls),li=class extends sT{constructor({toolName:e,availableTools:t,message:r=`Model tried to call unavailable tool '${e}'. ${void 0===t?"No tools are available.":`Available tools: ${t.join(", ")}.`}`}){super({name:la,message:r}),this[uG]=!0,this.toolName=e,this.availableTools=t}static isInstance(e){return sT.hasMarker(e,ls)}};uG=ln;var lo="AI_ToolCallRepairError",ll=`vercel.ai.error.${lo}`,lu=Symbol.for(ll),lp=class extends sT{constructor({cause:e,originalError:t,message:r=`Error repairing tool call: ${sM(e)}`}){super({name:lo,message:r,cause:e}),this[uW]=!0,this.originalError=t}static isInstance(e){return sT.hasMarker(e,ll)}};async function ld({toolCall:e,tools:t,repairToolCall:r,system:a,messages:s}){if(null==t)throw new li({toolName:e.toolName});try{return await lc({toolCall:e,tools:t})}catch(i){if(null==r||!(li.isInstance(i)||lr.isInstance(i)))throw i;let n=null;try{n=await r({toolCall:e,tools:t,parameterSchema:({toolName:e})=>nD(t[e].parameters).jsonSchema,system:a,messages:s,error:i})}catch(e){throw new lp({cause:e,originalError:i})}if(null==n)throw i;return await lc({toolCall:n,tools:t})}}async function lc({toolCall:e,tools:t}){let r=e.toolName,a=t[r];if(null==a)throw new li({toolName:e.toolName,availableTools:Object.keys(t)});let s=nD(a.parameters),n=""===e.args.trim()?s6({value:{},schema:s}):s7({text:e.args,schema:s});if(!1===n.success)throw new lr({toolName:r,toolArgs:e.args,cause:n.error});return{type:"tool-call",toolCallId:e.toolCallId,toolName:r,args:n.value}}function lm(e){let t=e.filter(e=>"text"===e.type).map(e=>e.text).join("");return t.length>0?t:void 0}function lg({text:e="",files:t,reasoning:r,tools:a,toolCalls:s,toolResults:n,messageId:i,generateMessageId:o}){let l=[],u=[];return r.length>0&&u.push(...r.map(e=>"text"===e.type?{...e,type:"reasoning"}:{...e,type:"redacted-reasoning"})),t.length>0&&u.push(...t.map(e=>({type:"file",data:e.base64,mimeType:e.mimeType}))),e.length>0&&u.push({type:"text",text:e}),s.length>0&&u.push(...s),u.length>0&&l.push({role:"assistant",content:u,id:i}),n.length>0&&l.push({role:"tool",id:o(),content:n.map(e=>{let t=a[e.toolName];return(null==t?void 0:t.experimental_toToolResultContent)!=null?{type:"tool-result",toolCallId:e.toolCallId,toolName:e.toolName,result:t.experimental_toToolResultContent(e.result),experimental_content:t.experimental_toToolResultContent(e.result)}:{type:"tool-result",toolCallId:e.toolCallId,toolName:e.toolName,result:e.result}})}),l}uW=lu;var lh=s3({prefix:"aitxt",size:24}),lf=s3({prefix:"msg",size:24});async function ly({model:e,tools:t,toolChoice:r,system:a,prompt:s,messages:n,maxRetries:i,abortSignal:o,headers:l,maxSteps:u=1,experimental_generateMessageId:p=lf,experimental_output:d,experimental_continueSteps:c=!1,experimental_telemetry:m,experimental_providerMetadata:g,providerOptions:h=g,experimental_activeTools:f,experimental_prepareStep:y,experimental_repairToolCall:v,_internal:{generateId:b=lh,currentDate:w=()=>new Date}={},onStepFinish:k,..._}){var I;if("string"==typeof e||"v1"!==e.specificationVersion)throw new iO;if(u<1)throw new iR({parameter:"maxSteps",value:u,message:"maxSteps must be at least 1"});let{maxRetries:S,retry:x}=iq({maxRetries:i}),T=iF({model:e,telemetry:m,headers:l,settings:{..._,maxRetries:S}}),E=oP({prompt:{system:null!=(I=null==d?void 0:d.injectIntoSystemPrompt({system:a,model:e}))?I:a,prompt:s,messages:n},tools:t}),A=iV(m);return iK({name:"ai.generateText",attributes:iW({telemetry:m,attributes:{...i$({operationId:"ai.generateText",telemetry:m}),...T,"ai.model.provider":e.provider,"ai.model.id":e.modelId,"ai.prompt":{input:()=>JSON.stringify({system:a,prompt:s,messages:n})},"ai.settings.maxSteps":u}}),tracer:A,fn:async s=>{var n,i,g,I,S,O,z,M,P,R,C,j,N,L;let D,q=op(_),$=[],F=[],U=[],Z=0,B=[],V="",K=[],G=[],W={completionTokens:0,promptTokens:0,totalTokens:0},Q="initial";do{let s=0===Z?E.type:"messages",j=[...E.messages,...B],N=await (null==y?void 0:y({model:e,steps:G,maxSteps:u,stepNumber:Z})),L=null!=(n=null==N?void 0:N.toolChoice)?n:r,J=null!=(i=null==N?void 0:N.experimental_activeTools)?i:f,H=null!=(g=null==N?void 0:N.model)?g:e,Y=await ol({prompt:{system:E.system,messages:j},modelSupportsImageUrls:H.supportsImageUrls,modelSupportsUrl:null==(I=H.supportsUrl)?void 0:I.bind(H)}),X={type:"regular",...o6({tools:t,toolChoice:L,activeTools:J})};D=await x(()=>iK({name:"ai.generateText.doGenerate",attributes:iW({telemetry:m,attributes:{...i$({operationId:"ai.generateText.doGenerate",telemetry:m}),...T,"ai.model.provider":H.provider,"ai.model.id":H.modelId,"ai.prompt.format":{input:()=>s},"ai.prompt.messages":{input:()=>oF(Y)},"ai.prompt.tools":{input:()=>{var e;return null==(e=X.tools)?void 0:e.map(e=>JSON.stringify(e))}},"ai.prompt.toolChoice":{input:()=>null!=X.toolChoice?JSON.stringify(X.toolChoice):void 0},"gen_ai.system":H.provider,"gen_ai.request.model":H.modelId,"gen_ai.request.frequency_penalty":_.frequencyPenalty,"gen_ai.request.max_tokens":_.maxTokens,"gen_ai.request.presence_penalty":_.presencePenalty,"gen_ai.request.stop_sequences":_.stopSequences,"gen_ai.request.temperature":_.temperature,"gen_ai.request.top_k":_.topK,"gen_ai.request.top_p":_.topP}}),tracer:A,fn:async t=>{var r,a,n,i,u,p;let c=await H.doGenerate({mode:X,...q,inputFormat:s,responseFormat:null==d?void 0:d.responseFormat({model:e}),prompt:Y,providerMetadata:h,abortSignal:o,headers:l}),g={id:null!=(a=null==(r=c.response)?void 0:r.id)?a:b(),timestamp:null!=(i=null==(n=c.response)?void 0:n.timestamp)?i:w(),modelId:null!=(p=null==(u=c.response)?void 0:u.modelId)?p:H.modelId};return t.setAttributes(iW({telemetry:m,attributes:{"ai.response.finishReason":c.finishReason,"ai.response.text":{output:()=>c.text},"ai.response.toolCalls":{output:()=>JSON.stringify(c.toolCalls)},"ai.response.id":g.id,"ai.response.model":g.modelId,"ai.response.timestamp":g.timestamp.toISOString(),"ai.response.providerMetadata":JSON.stringify(c.providerMetadata),"ai.usage.promptTokens":c.usage.promptTokens,"ai.usage.completionTokens":c.usage.completionTokens,"gen_ai.response.finish_reasons":[c.finishReason],"gen_ai.response.id":g.id,"gen_ai.response.model":g.modelId,"gen_ai.usage.input_tokens":c.usage.promptTokens,"gen_ai.usage.output_tokens":c.usage.completionTokens}})),{...c,response:g}}})),$=await Promise.all((null!=(S=D.toolCalls)?S:[]).map(e=>ld({toolCall:e,tools:t,repairToolCall:v,system:a,messages:j}))),F=null==t?[]:await lv({toolCalls:$,tools:t,tracer:A,telemetry:m,messages:j,abortSignal:o});let ee=oC(D.usage);W=oj(W,ee);let et="done";++Z<u&&(c&&"length"===D.finishReason&&0===$.length?et="continue":$.length>0&&F.length===$.length&&(et="tool-result"));let er=null!=(O=D.text)?O:"",ea="continue"===Q&&V.trimEnd()!==V?er.trimStart():er,es="continue"===et?function(e){let t=o9(e);return t?t.prefix+t.whitespace:e}(ea):ea;if(V="continue"===et||"continue"===Q?V+es:es,U=lw(D.reasoning),K.push(...null!=(z=D.sources)?z:[]),"continue"===Q){let e=B[B.length-1];"string"==typeof e.content?e.content+=es:e.content.push({text:es,type:"text"})}else B.push(...lg({text:V,files:lk(D.files),reasoning:lw(D.reasoning),tools:null!=t?t:{},toolCalls:$,toolResults:F,messageId:p(),generateMessageId:p}));let en={stepType:Q,text:es,reasoning:lm(U),reasoningDetails:U,files:lk(D.files),sources:null!=(M=D.sources)?M:[],toolCalls:$,toolResults:F,finishReason:D.finishReason,usage:ee,warnings:D.warnings,logprobs:D.logprobs,request:null!=(P=D.request)?P:{},response:{...D.response,headers:null==(R=D.rawResponse)?void 0:R.headers,body:null==(C=D.rawResponse)?void 0:C.body,messages:structuredClone(B)},providerMetadata:D.providerMetadata,experimental_providerMetadata:D.providerMetadata,isContinued:"continue"===et};G.push(en),await (null==k?void 0:k(en)),Q=et}while("done"!==Q)return s.setAttributes(iW({telemetry:m,attributes:{"ai.response.finishReason":D.finishReason,"ai.response.text":{output:()=>D.text},"ai.response.toolCalls":{output:()=>JSON.stringify(D.toolCalls)},"ai.usage.promptTokens":D.usage.promptTokens,"ai.usage.completionTokens":D.usage.completionTokens,"ai.response.providerMetadata":JSON.stringify(D.providerMetadata)}})),new lb({text:V,files:lk(D.files),reasoning:lm(U),reasoningDetails:U,sources:K,outputResolver:()=>{if(null==d)throw new o1;return d.parseOutput({text:V},{response:D.response,usage:W,finishReason:D.finishReason})},toolCalls:$,toolResults:F,finishReason:D.finishReason,usage:W,warnings:D.warnings,request:null!=(j=D.request)?j:{},response:{...D.response,headers:null==(N=D.rawResponse)?void 0:N.headers,body:null==(L=D.rawResponse)?void 0:L.body,messages:B},logprobs:D.logprobs,steps:G,providerMetadata:D.providerMetadata})}})}async function lv({toolCalls:e,tools:t,tracer:r,telemetry:a,messages:s,abortSignal:n}){return(await Promise.all(e.map(async({toolCallId:e,toolName:i,args:o})=>{let l=t[i];if((null==l?void 0:l.execute)==null)return;let u=await iK({name:"ai.toolCall",attributes:iW({telemetry:a,attributes:{...i$({operationId:"ai.toolCall",telemetry:a}),"ai.toolCall.name":i,"ai.toolCall.id":e,"ai.toolCall.args":{output:()=>JSON.stringify(o)}}}),tracer:r,fn:async t=>{try{let r=await l.execute(o,{toolCallId:e,messages:s,abortSignal:n});try{t.setAttributes(iW({telemetry:a,attributes:{"ai.toolCall.result":{output:()=>JSON.stringify(r)}}}))}catch(e){}return r}catch(r){throw iG(t,r),new o4({toolCallId:e,toolName:i,toolArgs:o,cause:r})}}});return{type:"tool-result",toolCallId:e,toolName:i,args:o,result:u}}))).filter(e=>null!=e)}var lb=class{constructor(e){this.text=e.text,this.files=e.files,this.reasoning=e.reasoning,this.reasoningDetails=e.reasoningDetails,this.toolCalls=e.toolCalls,this.toolResults=e.toolResults,this.finishReason=e.finishReason,this.usage=e.usage,this.warnings=e.warnings,this.request=e.request,this.response=e.response,this.steps=e.steps,this.experimental_providerMetadata=e.providerMetadata,this.providerMetadata=e.providerMetadata,this.logprobs=e.logprobs,this.outputResolver=e.outputResolver,this.sources=e.sources}get experimental_output(){return this.outputResolver()}};function lw(e){return null==e?[]:"string"==typeof e?[{type:"text",text:e}]:e}function lk(e){var t;return null!=(t=null==e?void 0:e.map(e=>new iQ(e)))?t:[]}var l_={};ix(l_,{object:()=>lA,text:()=>lE});var lI="AI_InvalidStreamPartError",lS=`vercel.ai.error.${lI}`,lx=Symbol.for(lS),lT=class extends sT{constructor({chunk:e,message:t}){super({name:lI,message:t}),this[uQ]=!0,this.chunk=e}static isInstance(e){return sT.hasMarker(e,lS)}};uQ=lx;var lE=()=>({type:"text",responseFormat:()=>({type:"text"}),injectIntoSystemPrompt:({system:e})=>e,parsePartial:({text:e})=>({partial:e}),parseOutput:({text:e})=>e}),lA=({schema:e})=>{let t=nD(e);return{type:"object",responseFormat:({model:e})=>({type:"json",schema:e.supportsStructuredOutputs?t.jsonSchema:void 0}),injectIntoSystemPrompt:({system:e,model:r})=>r.supportsStructuredOutputs?e:oN({prompt:e,schema:t.jsonSchema}),parsePartial({text:e}){let t=nR(e);switch(t.state){case"failed-parse":case"undefined-input":return;case"repaired-parse":case"successful-parse":return{partial:t.value};default:{let e=t.state;throw Error(`Unsupported parse state: ${e}`)}}},parseOutput({text:e},r){let a=s7({text:e});if(!a.success)throw new i1({message:"No object generated: could not parse the response.",cause:a.error,text:e,response:r.response,usage:r.usage,finishReason:r.finishReason});let s=s6({value:a.value,schema:t});if(!s.success)throw new i1({message:"No object generated: response did not match schema.",cause:s.error,text:e,response:r.response,usage:r.usage,finishReason:r.finishReason});return s.value}}};async function lO({stream:e,onError:t}){let r=e.getReader();try{for(;;){let{done:e}=await r.read();if(e)break}}catch(e){null==t||t(e)}finally{r.releaseLock()}}function lz(e,t){let r,a,s=e.getReader(),n=t.getReader(),i=!1,o=!1;async function l(e){try{null==r&&(r=s.read());let t=await r;r=void 0,t.done?e.close():e.enqueue(t.value)}catch(t){e.error(t)}}async function u(e){try{null==a&&(a=n.read());let t=await a;a=void 0,t.done?e.close():e.enqueue(t.value)}catch(t){e.error(t)}}return new ReadableStream({async pull(e){try{if(i)return void await u(e);if(o)return void await l(e);null==r&&(r=s.read()),null==a&&(a=n.read());let{result:t,reader:p}=await Promise.race([r.then(e=>({result:e,reader:s})),a.then(e=>({result:e,reader:n}))]);t.done||e.enqueue(t.value),p===s?(r=void 0,t.done&&(await u(e),i=!0)):(a=void 0,t.done&&(o=!0,await l(e)))}catch(t){e.error(t)}},cancel(){s.cancel(),n.cancel()}})}var lM=s3({prefix:"aitxt",size:24}),lP=s3({prefix:"msg",size:24}),lR=class{constructor({model:e,telemetry:t,headers:r,settings:a,maxRetries:s,abortSignal:n,system:i,prompt:o,messages:l,tools:u,toolChoice:p,toolCallStreaming:d,transforms:c,activeTools:m,repairToolCall:g,maxSteps:h,output:f,continueSteps:y,providerOptions:v,now:b,currentDate:w,generateId:k,generateMessageId:_,onChunk:I,onError:S,onFinish:x,onStepFinish:T}){var E;let A,O,z,M;if(this.warningsPromise=new oK,this.usagePromise=new oK,this.finishReasonPromise=new oK,this.providerMetadataPromise=new oK,this.textPromise=new oK,this.reasoningPromise=new oK,this.reasoningDetailsPromise=new oK,this.sourcesPromise=new oK,this.filesPromise=new oK,this.toolCallsPromise=new oK,this.toolResultsPromise=new oK,this.requestPromise=new oK,this.responsePromise=new oK,this.stepsPromise=new oK,h<1)throw new iR({parameter:"maxSteps",value:h,message:"maxSteps must be at least 1"});this.output=f;let P="",R="",C="",j=[],N=[],L=[];const D=[],q={id:k(),timestamp:w(),modelId:e.modelId,messages:[]};let $=[],F=[],U="initial";const Z=[],B=new TransformStream({async transform(e,t){t.enqueue(e);let{part:r}=e;if(("text-delta"===r.type||"reasoning"===r.type||"source"===r.type||"tool-call"===r.type||"tool-result"===r.type||"tool-call-streaming-start"===r.type||"tool-call-delta"===r.type)&&await (null==I?void 0:I({chunk:r})),"error"===r.type&&await (null==S?void 0:S({error:r.error})),"text-delta"===r.type&&(P+=r.textDelta,R+=r.textDelta,C+=r.textDelta),"reasoning"===r.type&&(null==O?(O={type:"text",text:r.textDelta},j.push(O)):O.text+=r.textDelta),"reasoning-signature"===r.type){if(null==O)throw new sT({name:"InvalidStreamPart",message:"reasoning-signature without reasoning"});O.signature=r.signature,O=void 0}if("redacted-reasoning"===r.type&&j.push({type:"redacted",data:r.data}),"file"===r.type&&N.push(r),"source"===r.type&&(D.push(r.source),L.push(r.source)),"tool-call"===r.type&&$.push(r),"tool-result"===r.type&&F.push(r),"step-finish"===r.type){let e=lg({text:R,files:N,reasoning:j,tools:null!=u?u:{},toolCalls:$,toolResults:F,messageId:r.messageId,generateMessageId:_}),t=Z.length,a="done";t+1<h&&(y&&"length"===r.finishReason&&0===$.length?a="continue":$.length>0&&F.length===$.length&&(a="tool-result"));let s={stepType:U,text:P,reasoning:lm(j),reasoningDetails:j,files:N,sources:L,toolCalls:$,toolResults:F,finishReason:r.finishReason,usage:r.usage,warnings:r.warnings,logprobs:r.logprobs,request:r.request,response:{...r.response,messages:[...q.messages,...e]},providerMetadata:r.experimental_providerMetadata,experimental_providerMetadata:r.experimental_providerMetadata,isContinued:r.isContinued};await (null==T?void 0:T(s)),Z.push(s),$=[],F=[],P="",L=[],j=[],N=[],O=void 0,"done"!==a&&(U=a),"continue"!==a&&(q.messages.push(...e),R="")}"finish"===r.type&&(q.id=r.response.id,q.timestamp=r.response.timestamp,q.modelId=r.response.modelId,q.headers=r.response.headers,M=r.usage,z=r.finishReason)},async flush(e){var r;try{if(0===Z.length)return;let e=Z[Z.length-1];Y.warningsPromise.resolve(e.warnings),Y.requestPromise.resolve(e.request),Y.responsePromise.resolve(e.response),Y.toolCallsPromise.resolve(e.toolCalls),Y.toolResultsPromise.resolve(e.toolResults),Y.providerMetadataPromise.resolve(e.experimental_providerMetadata),Y.reasoningPromise.resolve(e.reasoning),Y.reasoningDetailsPromise.resolve(e.reasoningDetails);let a=null!=z?z:"unknown",s=null!=M?M:{completionTokens:NaN,promptTokens:NaN,totalTokens:NaN};Y.finishReasonPromise.resolve(a),Y.usagePromise.resolve(s),Y.textPromise.resolve(C),Y.sourcesPromise.resolve(D),Y.filesPromise.resolve(e.files),Y.stepsPromise.resolve(Z),await (null==x?void 0:x({finishReason:a,logprobs:void 0,usage:s,text:C,reasoning:e.reasoning,reasoningDetails:e.reasoningDetails,files:e.files,sources:e.sources,toolCalls:e.toolCalls,toolResults:e.toolResults,request:null!=(r=e.request)?r:{},response:e.response,warnings:e.warnings,providerMetadata:e.providerMetadata,experimental_providerMetadata:e.experimental_providerMetadata,steps:Z})),A.setAttributes(iW({telemetry:t,attributes:{"ai.response.finishReason":a,"ai.response.text":{output:()=>C},"ai.response.toolCalls":{output:()=>{var t;return(null==(t=e.toolCalls)?void 0:t.length)?JSON.stringify(e.toolCalls):void 0}},"ai.usage.promptTokens":s.promptTokens,"ai.usage.completionTokens":s.completionTokens,"ai.response.providerMetadata":JSON.stringify(e.providerMetadata)}}))}catch(t){e.error(t)}finally{A.end()}}}),V=oW();this.addStream=V.addStream,this.closeStream=V.close;let K=V.stream;for(const e of c)K=K.pipeThrough(e({tools:u,stopStream(){V.terminate()}}));this.baseStream=K.pipeThrough(function(e){if(!e)return new TransformStream({transform(e,t){t.enqueue({part:e,partialOutput:void 0})}});let t="",r="",a="";function s({controller:e,partialOutput:t}){e.enqueue({part:{type:"text-delta",textDelta:r},partialOutput:t}),r=""}return new TransformStream({transform(n,i){if("step-finish"===n.type&&s({controller:i}),"text-delta"!==n.type)return void i.enqueue({part:n,partialOutput:void 0});t+=n.textDelta,r+=n.textDelta;let o=e.parsePartial({text:t});if(null!=o){let e=JSON.stringify(o.partial);e!==a&&(s({controller:i,partialOutput:o.partial}),a=e)}},flush(e){r.length>0&&s({controller:e})}})}(f)).pipeThrough(B);const{maxRetries:G,retry:W}=iq({maxRetries:s}),Q=iV(t),J=iF({model:e,telemetry:t,headers:r,settings:{...a,maxRetries:G}}),H=oP({prompt:{system:null!=(E=null==f?void 0:f.injectIntoSystemPrompt({system:i,model:e}))?E:i,prompt:o,messages:l},tools:u}),Y=this;iK({name:"ai.streamText",attributes:iW({telemetry:t,attributes:{...i$({operationId:"ai.streamText",telemetry:t}),...J,"ai.prompt":{input:()=>JSON.stringify({system:i,prompt:o,messages:l})},"ai.settings.maxSteps":h}}),tracer:Q,endWhenDone:!1,fn:async s=>{async function o({currentStep:s,responseMessages:l,usage:c,stepType:I,previousStepText:S,hasLeadingWhitespace:x,messageId:T}){var E;let A,O,z,M=0===l.length?H.type:"messages",P=[...H.messages,...l],R=await ol({prompt:{system:H.system,messages:P},modelSupportsImageUrls:e.supportsImageUrls,modelSupportsUrl:null==(E=e.supportsUrl)?void 0:E.bind(e)}),C={type:"regular",...o6({tools:u,toolChoice:p,activeTools:m})},{result:{stream:j,warnings:N,rawResponse:L,request:D},doStreamSpan:q,startTimestampMs:$}=await W(()=>iK({name:"ai.streamText.doStream",attributes:iW({telemetry:t,attributes:{...i$({operationId:"ai.streamText.doStream",telemetry:t}),...J,"ai.prompt.format":{input:()=>M},"ai.prompt.messages":{input:()=>oF(R)},"ai.prompt.tools":{input:()=>{var e;return null==(e=C.tools)?void 0:e.map(e=>JSON.stringify(e))}},"ai.prompt.toolChoice":{input:()=>null!=C.toolChoice?JSON.stringify(C.toolChoice):void 0},"gen_ai.system":e.provider,"gen_ai.request.model":e.modelId,"gen_ai.request.frequency_penalty":a.frequencyPenalty,"gen_ai.request.max_tokens":a.maxTokens,"gen_ai.request.presence_penalty":a.presencePenalty,"gen_ai.request.stop_sequences":a.stopSequences,"gen_ai.request.temperature":a.temperature,"gen_ai.request.top_k":a.topK,"gen_ai.request.top_p":a.topP}}),tracer:Q,endWhenDone:!1,fn:async t=>({startTimestampMs:b(),doStreamSpan:t,result:await e.doStream({mode:C,...op(a),inputFormat:M,responseFormat:null==f?void 0:f.responseFormat({model:e}),prompt:R,providerMetadata:v,abortSignal:n,headers:r})})})),F=function({tools:e,generatorStream:t,toolCallStreaming:r,tracer:a,telemetry:s,system:n,messages:i,abortSignal:o,repairToolCall:l}){let u,p=null,d=new ReadableStream({start(e){p=e}}),c={},m=new Set,g=!1;function h(){g&&0===m.size&&(null!=u&&p.enqueue(u),p.close())}let f=new TransformStream({async transform(t,d){let g=t.type;switch(g){case"text-delta":case"reasoning":case"reasoning-signature":case"redacted-reasoning":case"source":case"response-metadata":case"error":d.enqueue(t);break;case"file":d.enqueue(new iJ({data:t.data,mimeType:t.mimeType}));break;case"tool-call-delta":r&&(c[t.toolCallId]||(d.enqueue({type:"tool-call-streaming-start",toolCallId:t.toolCallId,toolName:t.toolName}),c[t.toolCallId]=!0),d.enqueue({type:"tool-call-delta",toolCallId:t.toolCallId,toolName:t.toolName,argsTextDelta:t.argsTextDelta}));break;case"tool-call":try{let r=await ld({toolCall:t,tools:e,repairToolCall:l,system:n,messages:i});d.enqueue(r);let u=e[r.toolName];if(null!=u.execute){let e=s5();m.add(e),iK({name:"ai.toolCall",attributes:iW({telemetry:s,attributes:{...i$({operationId:"ai.toolCall",telemetry:s}),"ai.toolCall.name":r.toolName,"ai.toolCall.id":r.toolCallId,"ai.toolCall.args":{output:()=>JSON.stringify(r.args)}}}),tracer:a,fn:async t=>u.execute(r.args,{toolCallId:r.toolCallId,messages:i,abortSignal:o}).then(a=>{p.enqueue({...r,type:"tool-result",result:a}),m.delete(e),h();try{t.setAttributes(iW({telemetry:s,attributes:{"ai.toolCall.result":{output:()=>JSON.stringify(a)}}}))}catch(e){}},a=>{iG(t,a),p.enqueue({type:"error",error:new o4({toolCallId:r.toolCallId,toolName:r.toolName,toolArgs:r.args,cause:a})}),m.delete(e),h()})})}}catch(e){p.enqueue({type:"error",error:e})}break;case"finish":u={type:"finish",finishReason:t.finishReason,logprobs:t.logprobs,usage:oC(t.usage),experimental_providerMetadata:t.providerMetadata};break;default:throw Error(`Unhandled chunk type: ${g}`)}},flush(){g=!0,h()}});return new ReadableStream({start:async e=>Promise.all([t.pipeThrough(f).pipeTo(new WritableStream({write(t){e.enqueue(t)},close(){}})),d.pipeTo(new WritableStream({write(t){e.enqueue(t)},close(){e.close()}}))])})}({tools:u,generatorStream:j,toolCallStreaming:d,tracer:Q,telemetry:t,system:i,messages:P,repairToolCall:g,abortSignal:n}),U=null!=D?D:{},Z=[],B=[],V=[],K=[],G="unknown",X={promptTokens:0,completionTokens:0,totalTokens:0},ee=!0,et="",er="continue"===I?S:"",ea={id:k(),timestamp:w(),modelId:e.modelId},es="",en=!1,ei=!0,eo=!1;async function el({controller:e,chunk:t}){e.enqueue(t),et+=t.textDelta,er+=t.textDelta,en=!0,eo=t.textDelta.trimEnd()!==t.textDelta}Y.addStream(F.pipeThrough(new TransformStream({async transform(e,t){var r,a,s;if(ee){let e=b()-$;ee=!1,q.addEvent("ai.stream.firstChunk",{"ai.response.msToFirstChunk":e}),q.setAttributes({"ai.response.msToFirstChunk":e}),t.enqueue({type:"step-start",messageId:T,request:U,warnings:null!=N?N:[]})}if("text-delta"===e.type&&0===e.textDelta.length)return;let n=e.type;switch(n){case"text-delta":if(y){let r=ei&&x?e.textDelta.trimStart():e.textDelta;if(0===r.length)break;ei=!1;let a=o9(es+=r);null!=a&&(es=a.suffix,await el({controller:t,chunk:{type:"text-delta",textDelta:a.prefix+a.whitespace}}))}else await el({controller:t,chunk:e});break;case"reasoning":t.enqueue(e),null==z?(z={type:"text",text:e.textDelta},V.push(z)):z.text+=e.textDelta;break;case"reasoning-signature":if(t.enqueue(e),null==z)throw new lT({chunk:e,message:"reasoning-signature without reasoning"});z.signature=e.signature,z=void 0;break;case"redacted-reasoning":t.enqueue(e),V.push({type:"redacted",data:e.data});break;case"tool-call":t.enqueue(e),Z.push(e);break;case"tool-result":t.enqueue(e),B.push(e);break;case"response-metadata":ea={id:null!=(r=e.id)?r:ea.id,timestamp:null!=(a=e.timestamp)?a:ea.timestamp,modelId:null!=(s=e.modelId)?s:ea.modelId};break;case"finish":{X=e.usage,G=e.finishReason,A=e.experimental_providerMetadata,O=e.logprobs;let t=b()-$;q.addEvent("ai.stream.finish"),q.setAttributes({"ai.response.msToFinish":t,"ai.response.avgCompletionTokensPerSecond":1e3*X.completionTokens/t});break}case"file":K.push(e),t.enqueue(e);break;case"source":case"tool-call-streaming-start":case"tool-call-delta":t.enqueue(e);break;case"error":t.enqueue(e),G="error";break;default:throw Error(`Unknown chunk type: ${n}`)}},async flush(e){let r=Z.length>0?JSON.stringify(Z):void 0,a="done";s+1<h&&(y&&"length"===G&&0===Z.length?a="continue":Z.length>0&&B.length===Z.length&&(a="tool-result")),y&&es.length>0&&("continue"!==a||"continue"===I&&!en)&&(await el({controller:e,chunk:{type:"text-delta",textDelta:es}}),es="");try{q.setAttributes(iW({telemetry:t,attributes:{"ai.response.finishReason":G,"ai.response.text":{output:()=>et},"ai.response.toolCalls":{output:()=>r},"ai.response.id":ea.id,"ai.response.model":ea.modelId,"ai.response.timestamp":ea.timestamp.toISOString(),"ai.response.providerMetadata":JSON.stringify(A),"ai.usage.promptTokens":X.promptTokens,"ai.usage.completionTokens":X.completionTokens,"gen_ai.response.finish_reasons":[G],"gen_ai.response.id":ea.id,"gen_ai.response.model":ea.modelId,"gen_ai.usage.input_tokens":X.promptTokens,"gen_ai.usage.output_tokens":X.completionTokens}}))}catch(e){}finally{q.end()}e.enqueue({type:"step-finish",finishReason:G,usage:X,providerMetadata:A,experimental_providerMetadata:A,logprobs:O,request:U,response:{...ea,headers:null==L?void 0:L.headers},warnings:N,isContinued:"continue"===a,messageId:T});let n=oj(c,X);if("done"===a)e.enqueue({type:"finish",finishReason:G,usage:n,providerMetadata:A,experimental_providerMetadata:A,logprobs:O,response:{...ea,headers:null==L?void 0:L.headers}}),Y.closeStream();else{if("continue"===I){let e=l[l.length-1];"string"==typeof e.content?e.content+=et:e.content.push({text:et,type:"text"})}else l.push(...lg({text:et,files:K,reasoning:V,tools:null!=u?u:{},toolCalls:Z,toolResults:B,messageId:T,generateMessageId:_}));await o({currentStep:s+1,responseMessages:l,usage:n,stepType:a,previousStepText:er,hasLeadingWhitespace:eo,messageId:"continue"===a?T:_()})}}})))}A=s,await o({currentStep:0,responseMessages:[],usage:{promptTokens:0,completionTokens:0,totalTokens:0},previousStepText:"",stepType:"initial",hasLeadingWhitespace:!1,messageId:_()})}}).catch(e=>{Y.addStream(new ReadableStream({start(t){t.enqueue({type:"error",error:e}),t.close()}})),Y.closeStream()})}get warnings(){return this.warningsPromise.value}get usage(){return this.usagePromise.value}get finishReason(){return this.finishReasonPromise.value}get experimental_providerMetadata(){return this.providerMetadataPromise.value}get providerMetadata(){return this.providerMetadataPromise.value}get text(){return this.textPromise.value}get reasoning(){return this.reasoningPromise.value}get reasoningDetails(){return this.reasoningDetailsPromise.value}get sources(){return this.sourcesPromise.value}get files(){return this.filesPromise.value}get toolCalls(){return this.toolCallsPromise.value}get toolResults(){return this.toolResultsPromise.value}get request(){return this.requestPromise.value}get response(){return this.responsePromise.value}get steps(){return this.stepsPromise.value}teeStream(){let[e,t]=this.baseStream.tee();return this.baseStream=t,e}get textStream(){return oL(this.teeStream().pipeThrough(new TransformStream({transform({part:e},t){"text-delta"===e.type&&t.enqueue(e.textDelta)}})))}get fullStream(){return oL(this.teeStream().pipeThrough(new TransformStream({transform({part:e},t){t.enqueue(e)}})))}async consumeStream(e){var t;try{await lO({stream:this.fullStream,onError:null==e?void 0:e.onError})}catch(r){null==(t=null==e?void 0:e.onError)||t.call(e,r)}}get experimental_partialOutputStream(){if(null==this.output)throw new o1;return oL(this.teeStream().pipeThrough(new TransformStream({transform({partialOutput:e},t){null!=e&&t.enqueue(e)}})))}toDataStreamInternal({getErrorMessage:e=()=>"An error occurred.",sendUsage:t=!0,sendReasoning:r=!1,sendSources:a=!1,experimental_sendFinish:s=!0}){return this.fullStream.pipeThrough(new TransformStream({transform:async(n,i)=>{let o=n.type;switch(o){case"text-delta":i.enqueue(nj("text",n.textDelta));break;case"reasoning":r&&i.enqueue(nj("reasoning",n.textDelta));break;case"redacted-reasoning":r&&i.enqueue(nj("redacted_reasoning",{data:n.data}));break;case"reasoning-signature":r&&i.enqueue(nj("reasoning_signature",{signature:n.signature}));break;case"file":i.enqueue(nj("file",{mimeType:n.mimeType,data:n.base64}));break;case"source":a&&i.enqueue(nj("source",n.source));break;case"tool-call-streaming-start":i.enqueue(nj("tool_call_streaming_start",{toolCallId:n.toolCallId,toolName:n.toolName}));break;case"tool-call-delta":i.enqueue(nj("tool_call_delta",{toolCallId:n.toolCallId,argsTextDelta:n.argsTextDelta}));break;case"tool-call":i.enqueue(nj("tool_call",{toolCallId:n.toolCallId,toolName:n.toolName,args:n.args}));break;case"tool-result":i.enqueue(nj("tool_result",{toolCallId:n.toolCallId,result:n.result}));break;case"error":i.enqueue(nj("error",e(n.error)));break;case"step-start":i.enqueue(nj("start_step",{messageId:n.messageId}));break;case"step-finish":i.enqueue(nj("finish_step",{finishReason:n.finishReason,usage:t?{promptTokens:n.usage.promptTokens,completionTokens:n.usage.completionTokens}:void 0,isContinued:n.isContinued}));break;case"finish":s&&i.enqueue(nj("finish_message",{finishReason:n.finishReason,usage:t?{promptTokens:n.usage.promptTokens,completionTokens:n.usage.completionTokens}:void 0}));break;default:throw Error(`Unknown chunk type: ${o}`)}}}))}pipeDataStreamToResponse(e,{status:t,statusText:r,headers:a,data:s,getErrorMessage:n,sendUsage:i,sendReasoning:o,sendSources:l,experimental_sendFinish:u}={}){iA({response:e,status:t,statusText:r,headers:iE(a,{contentType:"text/plain; charset=utf-8",dataStreamVersion:"v1"}),stream:this.toDataStream({data:s,getErrorMessage:n,sendUsage:i,sendReasoning:o,sendSources:l,experimental_sendFinish:u})})}pipeTextStreamToResponse(e,t){iA({response:e,status:null==t?void 0:t.status,statusText:null==t?void 0:t.statusText,headers:iE(null==t?void 0:t.headers,{contentType:"text/plain; charset=utf-8"}),stream:this.textStream.pipeThrough(new TextEncoderStream)})}toDataStream(e){let t=this.toDataStreamInternal({getErrorMessage:null==e?void 0:e.getErrorMessage,sendUsage:null==e?void 0:e.sendUsage,sendReasoning:null==e?void 0:e.sendReasoning,sendSources:null==e?void 0:e.sendSources,experimental_sendFinish:null==e?void 0:e.experimental_sendFinish}).pipeThrough(new TextEncoderStream);return(null==e?void 0:e.data)?lz(null==e?void 0:e.data.stream,t):t}mergeIntoDataStream(e,t){e.merge(this.toDataStreamInternal({getErrorMessage:e.onError,sendUsage:null==t?void 0:t.sendUsage,sendReasoning:null==t?void 0:t.sendReasoning,sendSources:null==t?void 0:t.sendSources,experimental_sendFinish:null==t?void 0:t.experimental_sendFinish}))}toDataStreamResponse({headers:e,status:t,statusText:r,data:a,getErrorMessage:s,sendUsage:n,sendReasoning:i,sendSources:o,experimental_sendFinish:l}={}){return new Response(this.toDataStream({data:a,getErrorMessage:s,sendUsage:n,sendReasoning:i,sendSources:o,experimental_sendFinish:l}),{status:t,statusText:r,headers:iT(e,{contentType:"text/plain; charset=utf-8",dataStreamVersion:"v1"})})}toTextStreamResponse(e){var t;return new Response(this.textStream.pipeThrough(new TextEncoderStream),{status:null!=(t=null==e?void 0:e.status)?t:200,headers:iT(null==e?void 0:e.headers,{contentType:"text/plain; charset=utf-8"})})}},lC=sg.object({name:sg.string(),version:sg.string()}).passthrough(),lj=sg.object({_meta:sg.optional(sg.object({}).passthrough())}).passthrough(),lN=sg.object({method:sg.string(),params:sg.optional(lj)}),lL=sg.object({experimental:sg.optional(sg.object({}).passthrough()),logging:sg.optional(sg.object({}).passthrough()),prompts:sg.optional(sg.object({listChanged:sg.optional(sg.boolean())}).passthrough()),resources:sg.optional(sg.object({subscribe:sg.optional(sg.boolean()),listChanged:sg.optional(sg.boolean())}).passthrough()),tools:sg.optional(sg.object({listChanged:sg.optional(sg.boolean())}).passthrough())}).passthrough();lj.extend({protocolVersion:sg.string(),capabilities:lL,serverInfo:lC,instructions:sg.optional(sg.string())});var lD=lj.extend({nextCursor:sg.optional(sg.string())}),lq=sg.object({name:sg.string(),description:sg.optional(sg.string()),inputSchema:sg.object({type:sg.literal("object"),properties:sg.optional(sg.object({}).passthrough())}).passthrough()}).passthrough();lD.extend({tools:sg.array(lq)});var l$=sg.object({type:sg.literal("text"),text:sg.string()}).passthrough(),lF=sg.object({type:sg.literal("image"),data:sg.string().base64(),mimeType:sg.string()}).passthrough(),lU=sg.object({uri:sg.string(),mimeType:sg.optional(sg.string())}).passthrough(),lZ=lU.extend({text:sg.string()}),lB=lU.extend({blob:sg.string().base64()}),lV=sg.object({type:sg.literal("resource"),resource:sg.union([lZ,lB])}).passthrough();lj.extend({content:sg.array(sg.union([l$,lF,lV])),isError:sg.boolean().default(!1).optional()}).or(lj.extend({toolResult:sg.unknown()}));var lK=sg.object({jsonrpc:sg.literal("2.0"),id:sg.union([sg.string(),sg.number().int()])}).merge(lN).strict(),lG=sg.object({jsonrpc:sg.literal("2.0"),id:sg.union([sg.string(),sg.number().int()]),result:lj}).strict(),lW=sg.object({jsonrpc:sg.literal("2.0"),id:sg.union([sg.string(),sg.number().int()]),error:sg.object({code:sg.number().int(),message:sg.string(),data:sg.optional(sg.unknown())})}).strict(),lQ=sg.object({jsonrpc:sg.literal("2.0")}).merge(sg.object({method:sg.string(),params:sg.optional(lj)})).strict();function lJ(e={}){let t=new TextEncoder,r="";return new TransformStream({async start(){e.onStart&&await e.onStart()},async transform(a,s){s.enqueue(t.encode(a)),r+=a,e.onToken&&await e.onToken(a),e.onText&&"string"==typeof a&&await e.onText(a)},async flush(){e.onCompletion&&await e.onCompletion(r),e.onFinal&&await e.onFinal(r)}})}function lH(e,t){return e.pipeThrough(new TransformStream({transform:async(e,t)=>{var r;if("string"==typeof e)return void t.enqueue(e);if("event"in e){"on_chat_model_stream"===e.event&&l1(null==(r=e.data)?void 0:r.chunk,t);return}l1(e,t)}})).pipeThrough(lJ(t)).pipeThrough(new TextDecoderStream).pipeThrough(new TransformStream({transform:async(e,t)=>{t.enqueue(nj("text",e))}}))}function lY(e,t){return lH(e,t).pipeThrough(new TextEncoderStream)}function lX(e,t){var r;let a=lH(e,null==t?void 0:t.callbacks).pipeThrough(new TextEncoderStream),s=null==t?void 0:t.data,n=null==t?void 0:t.init;return new Response(s?lz(s.stream,a):a,{status:null!=(r=null==n?void 0:n.status)?r:200,statusText:null==n?void 0:n.statusText,headers:iT(null==n?void 0:n.headers,{contentType:"text/plain; charset=utf-8",dataStreamVersion:"v1"})})}function l0(e,t){t.dataStream.merge(lH(e,t.callbacks))}function l1(e,t){if("string"==typeof e.content)t.enqueue(e.content);else for(let r of e.content)"text"===r.type&&t.enqueue(r.text)}function l2(e,t){var r;let a,s=(a=!0,e=>(a&&(e=e.trimStart())&&(a=!1),e));return(r=e[Symbol.asyncIterator](),new ReadableStream({async pull(e){try{let{value:t,done:a}=await r.next();a?e.close():e.enqueue(t)}catch(t){e.error(t)}},cancel(){}})).pipeThrough(new TransformStream({async transform(e,t){t.enqueue(s(e.delta))}})).pipeThrough(lJ(t)).pipeThrough(new TextDecoderStream).pipeThrough(new TransformStream({transform:async(e,t)=>{t.enqueue(nj("text",e))}}))}function l3(e,t){return l2(e,t).pipeThrough(new TextEncoderStream)}function l5(e,t={}){var r;let{init:a,data:s,callbacks:n}=t,i=l2(e,n).pipeThrough(new TextEncoderStream);return new Response(s?lz(s.stream,i):i,{status:null!=(r=null==a?void 0:a.status)?r:200,statusText:null==a?void 0:a.statusText,headers:iT(null==a?void 0:a.headers,{contentType:"text/plain; charset=utf-8",dataStreamVersion:"v1"})})}function l4(e,t){t.dataStream.merge(l2(e,t.callbacks))}sg.union([lK,lQ,lG,lW]),ix({},{mergeIntoDataStream:()=>l0,toDataStream:()=>lY,toDataStreamResponse:()=>lX}),ix({},{mergeIntoDataStream:()=>l4,toDataStream:()=>l3,toDataStreamResponse:()=>l5});for(var l6,l7,l9,l8,ue,ut,ur,ua,us,un,ui,uo,ul,uu,up,ud,uc,um,ug,uh,uf,uy,uv,ub,uw,uk,u_,uI,uS,ux,uT,uE,uA,uO,uz,uM,uP,uR,uC,uj,uN,uL,uD,uq,u$,uF,uU,uZ,uB,uV,uK,uG,uW,uQ,uJ,uH=256,uY=[];uH--;)uY[uH]=(uH+256).toString(16).substring(1);var uX="vercel.ai.error",u0=Symbol.for(uX),u1=class e extends Error{constructor({name:e,message:t,cause:r}){super(t),this[E]=!0,this.name=e,this.cause=r}static isInstance(t){return e.hasMarker(t,uX)}static hasMarker(e,t){let r=Symbol.for(t);return null!=e&&"object"==typeof e&&r in e&&"boolean"==typeof e[r]&&!0===e[r]}};E=u0;var u2=u1,u3=(Symbol.for("vercel.ai.error.AI_APICallError"),Symbol.for("vercel.ai.error.AI_EmptyResponseBodyError"),"AI_InvalidArgumentError"),u5=`vercel.ai.error.${u3}`,u4=Symbol.for(u5),u6=class extends u2{constructor({message:e,cause:t,argument:r}){super({name:u3,message:e,cause:t}),this[A]=!0,this.argument=r}static isInstance(e){return u2.hasMarker(e,u5)}};A=u4,Symbol.for("vercel.ai.error.AI_InvalidPromptError"),Symbol.for("vercel.ai.error.AI_InvalidResponseDataError"),Symbol.for("vercel.ai.error.AI_JSONParseError"),Symbol.for("vercel.ai.error.AI_LoadAPIKeyError"),Symbol.for("vercel.ai.error.AI_LoadSettingError"),Symbol.for("vercel.ai.error.AI_NoContentGeneratedError"),Symbol.for("vercel.ai.error.AI_NoSuchModelError"),Symbol.for("vercel.ai.error.AI_TooManyEmbeddingValuesForCallError");var u7="AI_TypeValidationError",u9=`vercel.ai.error.${u7}`,u8=Symbol.for(u9),pe=class e extends u2{constructor({value:e,cause:t}){super({name:u7,message:`Type validation failed: Value: ${JSON.stringify(e)}.
Error message: ${function(e){return null==e?"unknown error":"string"==typeof e?e:e instanceof Error?e.message:JSON.stringify(e)}(t)}`,cause:t}),this[O]=!0,this.value=e}static isInstance(e){return u2.hasMarker(e,u9)}static wrap({value:t,cause:r}){return e.isInstance(r)&&r.value===t?r:new e({value:t,cause:r})}};O=u8,Symbol.for("vercel.ai.error.AI_UnsupportedFunctionalityError");class pt extends Error{constructor(e,t){super(e),this.name="ParseError",this.type=t.type,this.field=t.field,this.value=t.value,this.line=t.line}}function pr(e){}class pa extends TransformStream{constructor({onError:e,onRetry:t,onComment:r}={}){let a;super({start(s){a=function(e){if("function"==typeof e)throw TypeError("`callbacks` must be an object, got a function instead. Did you mean `{onEvent: fn}`?");let{onEvent:t=pr,onError:r=pr,onRetry:a=pr,onComment:s}=e,n="",i=!0,o,l="",u="";function p(e){if(""===e)return void(l.length>0&&t({id:o,event:u||void 0,data:l.endsWith(`
`)?l.slice(0,-1):l}),o=void 0,l="",u="");if(e.startsWith(":")){s&&s(e.slice(e.startsWith(": ")?2:1));return}let r=e.indexOf(":");if(-1!==r){let t=e.slice(0,r),a=" "===e[r+1]?2:1;d(t,e.slice(r+a),e);return}d(e,"",e)}function d(e,t,s){switch(e){case"event":u=t;break;case"data":l=`${l}${t}
`;break;case"id":o=t.includes("\0")?void 0:t;break;case"retry":/^\d+$/.test(t)?a(parseInt(t,10)):r(new pt(`Invalid \`retry\` value: "${t}"`,{type:"invalid-retry",value:t,line:s}));break;default:r(new pt(`Unknown field "${e.length>20?`${e.slice(0,20)}\u2026`:e}"`,{type:"unknown-field",field:e,value:t,line:s}))}}return{feed:function(e){let t=i?e.replace(/^\xEF\xBB\xBF/,""):e,[r,a]=function(e){let t=[],r="",a=0;for(;a<e.length;){let s=e.indexOf("\r",a),n=e.indexOf(`
`,a),i=-1;if(-1!==s&&-1!==n?i=Math.min(s,n):-1!==s?i=s===e.length-1?-1:s:-1!==n&&(i=n),-1===i){r=e.slice(a);break}{let r=e.slice(a,i);t.push(r),"\r"===e[(a=i+1)-1]&&e[a]===`
`&&a++}}return[t,r]}(`${n}${t}`);for(let e of r)p(e);n=a,i=!1},reset:function(e={}){n&&e.consume&&p(n),i=!0,o=void 0,l="",u="",n=""}}}({onEvent:e=>{s.enqueue(e)},onError(t){"terminate"===e?s.error(t):"function"==typeof e&&e(t)},onRetry:t,onComment:r})},transform(e){a.feed(e)}})}}function ps(e){return(e instanceof Error||e instanceof DOMException)&&("AbortError"===e.name||"ResponseAborted"===e.name||"TimeoutError"===e.name)}function pn({messages:e,schema:t,schemaPrefix:r,schemaSuffix:a}){var s,n;let i=(null==(s=e[0])?void 0:s.role)==="system"?{...e[0]}:{role:"system",content:""};return i.content=function({prompt:e,schema:t,schemaPrefix:r=null!=t?"JSON schema:":void 0,schemaSuffix:a=null!=t?"You MUST answer with a JSON object that matches the JSON schema above.":"You MUST answer with JSON."}){return[null!=e&&e.length>0?e:void 0,null!=e&&e.length>0?"":void 0,r,null!=t?JSON.stringify(t):void 0,a].filter(e=>null!=e).join("\n")}({prompt:i.content,schema:t,schemaPrefix:r,schemaSuffix:a}),[i,...(null==(n=e[0])?void 0:n.role)==="system"?e.slice(1):e]}(({prefix:e,size:t=16,alphabet:r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",separator:a="-"}={})=>{if(null!=e){if(r.includes(a))throw new u6({argument:"separator",message:`The separator "${a}" must not be part of the alphabet "${r}".`});return()=>`${e}${a}${(()=>{let e=r.length,a=Array(t);for(let s=0;s<t;s++)a[s]=r[Math.random()*e|0];return a.join("")})()}`}})(),Symbol.for("vercel.ai.validator");Symbol("Let zodToJsonSchema decide on which parser to use");Symbol.for("vercel.ai.schema");var{btoa:pi,atob:po}=globalThis;function pl(e){let t=po(e.replace(/-/g,"+").replace(/_/g,"/"));return Uint8Array.from(t,e=>e.codePointAt(0))}function pu(e){let t="";for(let r=0;r<e.length;r++)t+=String.fromCodePoint(e[r]);return pi(t)}var sg=eF,pp=class e{static isMastraDBMessage(e){return!!("content"in e&&e.content&&!Array.isArray(e.content)&&"string"!=typeof e.content&&"format"in e.content&&2===e.content.format)}static isMastraMessageV1(t){return!e.isMastraDBMessage(t)&&("threadId"in t||"resourceId"in t)}static isMastraMessage(t){return e.isMastraDBMessage(t)||e.isMastraMessageV1(t)}static isAIV4UIMessage(t){return!e.isMastraMessage(t)&&!e.isAIV4CoreMessage(t)&&"parts"in t&&!e.hasAIV5UIMessageCharacteristics(t)}static isAIV5UIMessage(t){return!e.isMastraMessage(t)&&!e.isAIV5CoreMessage(t)&&"parts"in t&&e.hasAIV5UIMessageCharacteristics(t)}static isAIV4CoreMessage(t){return!e.isMastraMessage(t)&&!("parts"in t)&&"content"in t&&!e.hasAIV5CoreMessageCharacteristics(t)}static isAIV5CoreMessage(t){return!e.isMastraMessage(t)&&!("parts"in t)&&"content"in t&&e.hasAIV5CoreMessageCharacteristics(t)}static hasAIV5UIMessageCharacteristics(e){if("toolInvocations"in e||"reasoning"in e||"experimental_attachments"in e||"data"in e||"annotations"in e||!e.parts)return!1;for(let t of e.parts){if("metadata"in t)return!0;if("toolInvocation"in t)break;if("toolCallId"in t)return!0;if("source"===t.type)break;if("source-url"===t.type)return!0;if("reasoning"===t.type){if("state"in t||"text"in t)return!0;if("reasoning"in t||"details"in t)break}if("file"===t.type&&"mediaType"in t)return!0}return!1}static hasAIV5CoreMessageCharacteristics(e){if("experimental_providerMetadata"in e)return!1;if("string"==typeof e.content)return!0;for(let t of e.content){if("tool-result"===t.type&&"output"in t||"tool-call"===t.type&&"input"in t)break;if("tool-result"===t.type&&"result"in t||"tool-call"===t.type&&"args"in t)return!1;if("mediaType"in t)break;if("mimeType"in t||"experimental_providerMetadata"in t||"reasoning"===t.type&&"signature"in t||"redacted-reasoning"===t.type)return!1}return!0}static getRole(e){if("assistant"===e.role||"tool"===e.role)return"assistant";if("user"===e.role)return"user";if("system"===e.role)return"system";throw Error(`BUG: add handling for message role ${e.role} in message ${JSON.stringify(e,null,2)}`)}};function pd(e){return"string"==typeof e?e:e instanceof ArrayBuffer?pu(new Uint8Array(e)):pu(e)}function pc(e){if(!e.startsWith("data:"))return{isDataUri:!1,base64Content:e};let t=e.indexOf(",");if(-1===t)return{isDataUri:!0,base64Content:e};let r=e.substring(5,t),a=e.substring(t+1),s=r.indexOf(";");return{isDataUri:!0,mimeType:(-1!==s?r.substring(0,s):r)||void 0,base64Content:a}}function pm(e,t="application/octet-stream"){return e.startsWith("data:")?e:`data:${t};base64,${e}`}function pg(e){return e instanceof URL?e.toString():"string"==typeof e?e.length:e instanceof Uint8Array||e instanceof ArrayBuffer?e.byteLength:e}function ph(e,t){let r=pc(e),a=r.isDataUri&&r.mimeType?r.mimeType:t;return r.isDataUri?{type:"dataUri",mimeType:a,data:e}:!function(e){try{return new URL(e),!0}catch{if(e.startsWith("//"))try{return new URL(`https:${e}`),!0}catch{}return!1}}(e)?{type:"raw",mimeType:a,data:e}:{type:"url",mimeType:a,data:e}}function pf(e){let t=[...e],r=t.findIndex(e=>"system"!==e.role);if(-1===r)throw new eN.MastraError({id:"NO_USER_OR_ASSISTANT_MESSAGES",domain:"AGENT",category:"USER",text:"This request does not contain any user or assistant messages. At least one user or assistant message is required to generate a response."});return t[r]?.role==="assistant"&&t.splice(r,0,{role:"user",content:"."}),t}function py(e,t){for(let r=e.length-1;r>=0;r--){let a=e[r];if(a&&"assistant"===a.role){if(a.content.parts){let e=a.content.parts.find(e=>"tool-invocation"===e.type&&e.toolInvocation.toolCallId===t);if(e&&"tool-invocation"===e.type)return e.toolInvocation.args||{}}if(a.content.toolInvocations){let e=a.content.toolInvocations.find(e=>e.toolCallId===t);if(e)return e.args||{}}}}return{}}sg.union([sg.string(),sg.instanceof(Uint8Array),sg.instanceof(ArrayBuffer),sg.custom(e=>globalThis.Buffer?.isBuffer(e)??!1,{message:"Must be a Buffer"})]);var pv=class{static toUIMessage(e){let t=e.content.experimental_attachments?[...e.content.experimental_attachments]:[],r="string"==typeof e.content.content&&""!==e.content.content?e.content.content:(e.content.parts??[]).reduce((e,t)=>"text"===t.type?t.text:e,""),a=[],s=e.content.parts??[];if(s.length)for(let e of s)if("file"===e.type){let r;r="string"==typeof e.data&&"raw"===ph(e.data,e.mimeType).type?pm(e.data,e.mimeType||"application/octet-stream"):e.data,t.push({contentType:e.mimeType,url:r})}else if("tool-invocation"===e.type&&("call"===e.toolInvocation.state||"partial-call"===e.toolInvocation.state))continue;else if("tool-invocation"===e.type){let t={...e.toolInvocation},r=-1,n=-1;for(let t of s)if("step-start"===t.type&&r++,"tool-invocation"===t.type&&t.toolInvocation.toolCallId===e.toolInvocation.toolCallId){n=r;break}if(n>=0){let e={step:n,...t};a.push({type:"tool-invocation",toolInvocation:e})}else a.push({type:"tool-invocation",toolInvocation:t})}else a.push(e);0===a.length&&t.length>0&&a.push({type:"text",text:""});let n=a.filter(e=>!e.type.startsWith("data-"));if("user"===e.role){let a={id:e.id,role:e.role,content:e.content.content||r,createdAt:e.createdAt,parts:n,experimental_attachments:t};return e.content.metadata&&(a.metadata=e.content.metadata),a}if("assistant"===e.role){let t=Array.isArray(e.content.content)&&1===e.content.content.length&&"text"===e.content.content[0].type,a={id:e.id,role:e.role,content:t?r:e.content.content||r,createdAt:e.createdAt,parts:n,reasoning:void 0,toolInvocations:"toolInvocations"in e.content?e.content.toolInvocations?.filter(e=>"result"===e.state):void 0};return e.content.metadata&&(a.metadata=e.content.metadata),a}let i={id:e.id,role:e.role,content:e.content.content||r,createdAt:e.createdAt,parts:n,experimental_attachments:t};return e.content.metadata&&(i.metadata=e.content.metadata),i}static systemToV4Core(e){if("system"!==e.role||!e.content.content)throw new eN.MastraError({id:"INVALID_SYSTEM_MESSAGE_FORMAT",domain:"AGENT",category:"USER",text:"Invalid system message format. System messages must include 'role' and 'content' properties. The content should be a string.",details:{receivedMessage:JSON.stringify(e,null,2)}});let t={role:"system",content:e.content.content};return e.content.providerMetadata&&(t.experimental_providerMetadata=e.content.providerMetadata),t}static fromUIMessage(e,t,r){let a={format:2,parts:e.parts};return e.toolInvocations&&(a.toolInvocations=e.toolInvocations),e.reasoning&&(a.reasoning=e.reasoning),e.annotations&&(a.annotations=e.annotations),e.experimental_attachments&&(a.experimental_attachments=e.experimental_attachments),"metadata"in e&&null!==e.metadata&&void 0!==e.metadata&&(a.metadata=e.metadata),{id:e.id||t.newMessageId(),role:pp.getRole(e),createdAt:t.generateCreatedAt(r,e.createdAt),threadId:t.memoryInfo?.threadId,resourceId:t.memoryInfo?.resourceId,content:a}}static fromCoreMessage(e,t,r){let a="id"in e?e.id:t.newMessageId(),s=[],n=[],i=[],o="response"===r&&Array.isArray(e.content)&&1===e.content.length&&e.content[0]&&"text"===e.content[0].type&&"text"in e.content[0]&&e.content[0].text;if(o&&"response"===r&&(e.content=o),"string"==typeof e.content)s.push({type:"text",text:e.content});else if(Array.isArray(e.content))for(let r of e.content)switch(r.type){case"text":{let t=s.at(-1);"assistant"===e.role&&t&&"tool-invocation"===t.type&&s.push({type:"step-start"});let a={type:"text",text:r.text};r.providerOptions&&(a.providerMetadata=r.providerOptions),s.push(a);break}case"tool-call":{let e={type:"tool-invocation",toolInvocation:{state:"call",toolCallId:r.toolCallId,toolName:r.toolName,args:r.args}};r.providerOptions&&(e.providerMetadata=r.providerOptions),s.push(e);break}case"tool-result":{let a={},n=e.content.find(e=>"tool-call"===e.type&&e.toolCallId===r.toolCallId);n&&"tool-call"===n.type&&(a=n.args),0===Object.keys(a).length&&t.dbMessages&&(a=py(t.dbMessages,r.toolCallId));let o={state:"result",toolCallId:r.toolCallId,toolName:r.toolName,result:r.result??"",args:a},l={type:"tool-invocation",toolInvocation:o};r.providerOptions&&(l.providerMetadata=r.providerOptions),s.push(l),i.push(o)}break;case"reasoning":{let e={type:"reasoning",reasoning:"",details:[{type:"text",text:r.text,signature:r.signature}]};r.providerOptions&&(e.providerMetadata=r.providerOptions),s.push(e)}break;case"redacted-reasoning":{let e={type:"reasoning",reasoning:"",details:[{type:"redacted",data:r.data}]};r.providerOptions&&(e.providerMetadata=r.providerOptions),s.push(e)}break;case"image":{var l;let e={type:"file",data:"string"==typeof(l=r.image)?l:l instanceof URL?l.toString():l instanceof Uint8Array||l instanceof ArrayBuffer||globalThis.Buffer&&Buffer.isBuffer(l)?pd(l):String(l),mimeType:r.mimeType};r.providerOptions&&(e.providerMetadata=r.providerOptions),s.push(e);break}case"file":if(r.data instanceof URL){let e={type:"file",data:r.data.toString(),mimeType:r.mimeType};r.providerOptions&&(e.providerMetadata=r.providerOptions),s.push(e)}else if("string"==typeof r.data){let e=ph(r.data,r.mimeType);if("url"===e.type||"dataUri"===e.type){let t={type:"file",data:r.data,mimeType:e.mimeType||"image/png"};r.providerOptions&&(t.providerMetadata=r.providerOptions),s.push(t)}else try{let t={type:"file",mimeType:e.mimeType||"image/png",data:pd(r.data)};r.providerOptions&&(t.providerMetadata=r.providerOptions),s.push(t)}catch(e){console.error(`Failed to convert binary data to base64 in CoreMessage file part: ${e}`,e)}}else try{let e={type:"file",mimeType:r.mimeType,data:pd(r.data)};r.providerOptions&&(e.providerMetadata=r.providerOptions),s.push(e)}catch(e){console.error(`Failed to convert binary data to base64 in CoreMessage file part: ${e}`,e)}}let u={format:2,parts:s};i.length&&(u.toolInvocations=i),"string"==typeof e.content&&(u.content=e.content),n.length&&(u.experimental_attachments=n),e.providerOptions?u.providerMetadata=e.providerOptions:"experimental_providerMetadata"in e&&e.experimental_providerMetadata&&(u.providerMetadata=e.experimental_providerMetadata),"metadata"in e&&null!==e.metadata&&void 0!==e.metadata&&(u.metadata=e.metadata);let p="metadata"in e&&e.metadata&&"object"==typeof e.metadata&&"createdAt"in e.metadata?e.metadata.createdAt:void 0;return{id:a,role:pp.getRole(e),createdAt:t.generateCreatedAt(r,p),threadId:t.memoryInfo?.threadId,resourceId:t.memoryInfo?.resourceId,content:u}}};function pb(e){return("object"==typeof e&&e&&"type"in e&&(e=e.type),"string"!=typeof e)?"unknown":"dynamic-tool"===e?"dynamic-tool":e.startsWith("tool-")?e.slice(5):e}var pw=class{static toUIMessage(e){let t=[],r={...e.content.metadata||{}};e.createdAt&&(r.createdAt=e.createdAt),e.threadId&&(r.threadId=e.threadId),e.resourceId&&(r.resourceId=e.resourceId),e.content.providerMetadata&&(r.providerMetadata=e.content.providerMetadata);let a=e.content.parts?.some(e=>"tool-invocation"===e.type);if(e.content.toolInvocations&&!a)for(let r of e.content.toolInvocations)"result"===r.state?t.push({type:`tool-${r.toolName}`,toolCallId:r.toolCallId,state:"output-available",input:r.args,output:r.result}):t.push({type:`tool-${r.toolName}`,toolCallId:r.toolCallId,state:"call"===r.state?"input-available":"input-streaming",input:r.args});let s=e.content.parts?.some(e=>"reasoning"===e.type),n=e.content.parts?.some(e=>"file"===e.type);e.content.reasoning&&!s&&t.push({type:"reasoning",text:e.content.reasoning});let i=new Set;if(e.content.experimental_attachments&&!n)for(let r of e.content.experimental_attachments)i.add(r.url),t.push({type:"file",url:r.url,mediaType:r.contentType||"unknown"});let o=!1;if(e.content.parts)for(let r of e.content.parts){if("tool-invocation"===r.type&&r.toolInvocation){let e=r.toolInvocation;"result"===e.state?t.push({type:`tool-${e.toolName}`,toolCallId:e.toolCallId,input:e.args,output:e.result,state:"output-available",callProviderMetadata:r.providerMetadata}):t.push({type:`tool-${e.toolName}`,toolCallId:e.toolCallId,input:e.args,state:"input-available",callProviderMetadata:r.providerMetadata});continue}if("reasoning"===r.type){let e=r.reasoning||(r.details?.reduce((e,t)=>"text"===t.type&&t.text?e+t.text:e,"")??"");if(e||r.details?.length){let a={type:"reasoning",text:e||"",state:"done"};r.providerMetadata&&(a.providerMetadata=r.providerMetadata),t.push(a)}continue}if(!("tool-invocation"===r.type||r.type.startsWith("tool-")))if("file"===r.type){if("string"==typeof r.data&&i.has(r.data))continue;let e="string"==typeof r.data?ph(r.data,r.mimeType):{type:"raw",mimeType:r.mimeType};if("url"===e.type&&"string"==typeof r.data){let a={type:"file",url:r.data,mediaType:e.mimeType||"image/png"};r.providerMetadata&&(a.providerMetadata=r.providerMetadata),t.push(a)}else{let e,a=r.mimeType;if("string"==typeof r.data){let t=pc(r.data);t.isDataUri?(e=t.base64Content,t.mimeType&&(a=a||t.mimeType)):e=r.data}else e=r.data;let s=a||"image/png",n={type:"file",url:"string"==typeof e&&e.startsWith("data:")?e:pm(e,s),mediaType:s};r.providerMetadata&&(n.providerMetadata=r.providerMetadata),t.push(n)}}else if("source"===r.type){let e={type:"source-url",url:r.source.url,sourceId:r.source.id,title:r.source.title};r.providerMetadata&&(e.providerMetadata=r.providerMetadata),t.push(e)}else if("text"===r.type){let e={type:"text",text:r.text};r.providerMetadata&&(e.providerMetadata=r.providerMetadata),t.push(e),o=!0}else t.push(r),o=!0}return e.content.content&&!o&&t.push({type:"text",text:e.content.content}),{id:e.id,role:e.role,metadata:r,parts:t}}static fromUIMessage(e){let t,r,a,s,{parts:n,metadata:i}=e,o=i||{},l=o.createdAt,u=l?"string"==typeof l?new Date(l):l instanceof Date?l:new Date:new Date,p=o.threadId,d=o.resourceId,c={...o};delete c.createdAt,delete c.threadId,delete c.resourceId;let m=n.filter(e=>a9(e)),g=n.filter(e=>"reasoning"===e.type),h=n.filter(e=>"file"===e.type),f=n.filter(e=>"text"===e.type);m.length>0&&(t=m.map(e=>{let t=pb(e);return"output-available"===e.state?{args:e.input,result:"object"==typeof e.output&&e.output&&"value"in e.output?e.output.value:e.output,toolCallId:e.toolCallId,toolName:t,state:"result"}:{args:e.input,toolCallId:e.toolCallId,toolName:t,state:"call"}})),g.length>0&&(r=g.map(e=>e.text).join("\n")),h.length>0&&(a=h.map(e=>({url:e.url||"",contentType:e.mediaType}))),f.length>0&&(s=f.map(e=>e.text).join(""));let y=n.map(e=>{if(a9(e)){let t=pb(e),r="callProviderMetadata"in e?e.callProviderMetadata:void 0;return"output-available"===e.state?{type:"tool-invocation",toolInvocation:{toolCallId:e.toolCallId,toolName:t,args:e.input,result:"object"==typeof e.output&&e.output&&"value"in e.output?e.output.value:e.output,state:"result"},providerMetadata:r}:{type:"tool-invocation",toolInvocation:{toolCallId:e.toolCallId,toolName:t,args:e.input,state:"call"},providerMetadata:r}}return"reasoning"===e.type?{type:"reasoning",reasoning:"",details:[{type:"text",text:e.text}],providerMetadata:e.providerMetadata}:"file"===e.type?{type:"file",mimeType:e.mediaType,data:e.url||"",providerMetadata:e.providerMetadata}:"source-url"===e.type?{type:"source",source:{url:e.url,sourceType:"url",id:e.url,providerMetadata:e.providerMetadata},providerMetadata:e.providerMetadata}:"text"===e.type?{type:"text",text:e.text,providerMetadata:e.providerMetadata}:"step-start"===e.type?e:"string"==typeof e.type&&e.type.startsWith("data-")?{type:e.type,data:"data"in e?e.data:void 0}:null}).filter(e=>null!==e);return{id:e.id,role:e.role,createdAt:u,threadId:p,resourceId:d,content:{format:2,parts:y,toolInvocations:t,reasoning:r,experimental_attachments:a,content:s,metadata:Object.keys(c).length>0?c:void 0}}}static getDataStringFromAIV5DataPart(e){let t,r;if("data"in e)t=e.mediaType||"application/octet-stream",r=e.data;else if("image"in e)t=e.mediaType||"image/jpeg",r=e.image;else throw new eN.MastraError({id:"MASTRA_AIV5_DATA_PART_INVALID",domain:"AGENT",category:"USER",text:"Invalid AIV5 data part in getDataStringFromAIV5DataPart",details:{part:e}});if(r instanceof URL)return r.toString();if(r instanceof Buffer){let e=r.toString("base64");return`data:${t};base64,${e}`}if("string"==typeof r)return r.startsWith("data:")||r.startsWith("http")?r:`data:${t};base64,${r}`;if(r instanceof Uint8Array){let e=Buffer.from(r).toString("base64");return`data:${t};base64,${e}`}{if(!(r instanceof ArrayBuffer))return"";let e=Buffer.from(r).toString("base64");return`data:${t};base64,${e}`}}static fromModelMessage(e,t){let r=Array.isArray(e.content)?e.content:[{type:"text",text:e.content}],a=[],s=[],n=[],i=[],o=!1;for(let e of r)if("text"===e.type){let t={type:"text",text:e.text};e.providerOptions&&(t.providerMetadata=e.providerOptions),a.push(t),o=!1}else if("tool-call"===e.type){let t={type:"tool-invocation",toolInvocation:{toolCallId:e.toolCallId,toolName:e.toolName,args:e.input,state:"call"}};e.providerOptions&&(t.providerMetadata=e.providerOptions),a.push(t),s.push({toolCallId:e.toolCallId,toolName:e.toolName,args:e.input,state:"call"}),o=!1}else if("tool-result"===e.type){let t=e,r=s.find(e=>e.toolCallId===t.toolCallId),n=a.find(e=>"tool-invocation"===e.type&&"toolInvocation"in e&&e.toolInvocation.toolCallId===t.toolCallId),i=(e,t)=>{t.state="result",t.result="object"==typeof e.output&&e.output&&"value"in e.output?e.output.value:e.output};if(r)i(t,r);else{let e={state:"call",toolCallId:t.toolCallId,toolName:t.toolName||"unknown",args:{}};i(t,e),s.push(e)}if(n&&"tool-invocation"===n.type)i(t,n.toolInvocation);else{let e={type:"tool-invocation",toolInvocation:{toolCallId:t.toolCallId,toolName:t.toolName||"unknown",args:{},state:"call"}};i(t,e.toolInvocation),a.push(e)}o=!0}else if("reasoning"===e.type){let t={type:"reasoning",reasoning:"",details:[{type:"text",text:e.text}]};e.providerOptions&&(t.providerMetadata=e.providerOptions),a.push(t),n.push(e.text),o=!1}else if("image"===e.type){let t=e.mediaType||"image/jpeg",r=this.getDataStringFromAIV5DataPart(e),s={type:"file",data:r,mimeType:t};e.providerOptions&&(s.providerMetadata=e.providerOptions),a.push(s),i.push({url:r,contentType:t}),o=!1}else if("file"===e.type){let t=e.mediaType||"application/octet-stream",r=this.getDataStringFromAIV5DataPart(e),s={type:"file",data:r,mimeType:t};e.providerOptions&&(s.providerMetadata=e.providerOptions),a.push(s),i.push({url:r,contentType:t}),o=!1}if("assistant"===e.role&&o&&a.length>0){let e=a[a.length-1];e&&"text"!==e.type&&a.push({type:"text",text:""})}let l=a.filter(e=>"text"===e.type).map(e=>e.text).join("\n"),u="metadata"in e&&null!==e.metadata&&void 0!==e.metadata?e.metadata:{},p={id:"id"in e&&"string"==typeof e.id?e.id:`msg-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,role:"tool"===e.role?"assistant":e.role,createdAt:new Date,content:{format:2,parts:a,toolInvocations:s.length>0?s:void 0,reasoning:n.length>0?n.join("\n"):void 0,experimental_attachments:i.length>0?i:void 0,content:l||void 0,metadata:Object.keys(u).length>0?u:void 0}};return e.providerOptions&&(p.content.providerMetadata=e.providerOptions),p}},pk=class e{static fromAIV4Parts(t){let r="";for(let a of t)r+=a.type,r+=e.fromAIV4Part(a);return r}static fromAIV4Part(e){let t="";if(("text"===e.type&&(t+=e.text),"tool-invocation"===e.type&&(t+=e.toolInvocation.toolCallId,t+=e.toolInvocation.state),"reasoning"===e.type)&&(t+=e.reasoning,t+=e.details.reduce((e,t)=>"text"===t.type?e+t.text.length+(t.signature?.length||0):e,0),e&&Object.hasOwn(e,"providerMetadata")&&e.providerMetadata&&Object.hasOwn(e.providerMetadata,"openai")&&e.providerMetadata.openai&&Object.hasOwn(e.providerMetadata.openai,"itemId"))){let r=e.providerMetadata.openai.itemId;t+=`|${r}`}return"file"===e.type&&(t+=e.data,t+=e.mimeType),t}static fromDBParts(t){let r="";for(let a of t)r+=a.type,a.type.startsWith("data-")?r+=JSON.stringify(a.data):r+=e.fromAIV4Part(a);return r}static fromAIV4CoreMessageContent(e){if("string"==typeof e)return e;let t="";for(let r of e)t+=r.type,"text"===r.type&&(t+=r.text.length),"reasoning"===r.type&&(t+=r.text.length),"tool-call"===r.type&&(t+=r.toolCallId,t+=r.toolName),"tool-result"===r.type&&(t+=r.toolCallId,t+=r.toolName),"file"===r.type&&(t+=r.filename,t+=r.mimeType),"image"===r.type&&(t+=pg(r.image),t+=r.mimeType),"redacted-reasoning"===r.type&&(t+=r.data.length);return t}static fromAIV5Parts(e){let t="";for(let r of e)t+=r.type,"text"===r.type&&(t+=r.text),(a9(r)||"dynamic-tool"===r.type)&&(t+=r.toolCallId,t+=r.state),"reasoning"===r.type&&(t+=r.text),"file"===r.type&&(t+=r.url.length,t+=r.mediaType,t+=r.filename||"");return t}static fromAIV5ModelMessageContent(e){if("string"==typeof e)return e;let t="";for(let r of e)t+=r.type,"text"===r.type&&(t+=r.text.length),"reasoning"===r.type&&(t+=r.text.length),"tool-call"===r.type&&(t+=r.toolCallId,t+=r.toolName),"tool-result"===r.type&&(t+=r.toolCallId,t+=r.toolName),"file"===r.type&&(t+=r.filename,t+=r.mediaType),"image"===r.type&&(t+=pg(r.image),t+=r.mediaType);return t}};function p_(e){if("system"===e.role)return e;if("string"==typeof e.content&&("assistant"===e.role||"user"===e.role))return{...e,content:[{type:"text",text:e.content}]};if("string"==typeof e.content)throw Error(`Saw text content for input CoreMessage, but the role is ${e.role}. This is only allowed for "system", "assistant", and "user" roles.`);let t={user:[],assistant:[],tool:[]},r=e.role;for(let a of e.content){let e=`Saw incompatible message content part type ${a.type} for message role ${r}`;switch(a.type){case"text":if("tool"===r)throw Error(e);t[r].push(a);break;case"redacted-reasoning":case"reasoning":if("assistant"!==r)throw Error(e);t[r].push(a);break;case"tool-call":if("tool"===r||"user"===r)throw Error(e);t[r].push(a);break;case"tool-result":if("assistant"===r||"user"===r)throw Error(e);t[r].push(a);break;case"image":{let s;if("tool"===r||"assistant"===r)throw Error(e);s=a.image instanceof URL||a.image instanceof Uint8Array?a.image:Buffer.isBuffer(a.image)||a.image instanceof ArrayBuffer?new Uint8Array(a.image):new URL("raw"===ph(a.image,a.mimeType).type?pm(a.image,a.mimeType||"image/png"):a.image),t[r].push({...a,image:s});break}case"file":if("tool"===r)throw Error(e);t[r].push({...a,data:a.data instanceof URL||"string"==typeof a.data?a.data:pd(a.data)})}}if("tool"===r||"user"===r||"assistant"===r)return{...e,content:t[r]};throw Error(`Encountered unknown role ${r} when converting V4 CoreMessage -> V4 LanguageModelV1Prompt, input message: ${JSON.stringify(e,null,2)}`)}function pI(e){if("system"===e.role)return e;if("string"==typeof e.content&&("assistant"===e.role||"user"===e.role))return{role:e.role,content:[{type:"text",text:e.content}],providerOptions:e.providerOptions};if("string"==typeof e.content)throw Error(`Saw text content for input ModelMessage, but the role is ${e.role}. This is only allowed for "system", "assistant", and "user" roles.`);let t={user:[],assistant:[],tool:[]},r=e.role;for(let a of e.content){let e=`Saw incompatible message content part type ${a.type} for message role ${r}`;switch(a.type){case"text":if("tool"===r)throw Error(e);t[r].push(a);break;case"reasoning":if("tool"===r||"user"===r)throw Error(e);t[r].push(a);break;case"tool-call":if("assistant"!==r)throw Error(e);t[r].push(a);break;case"tool-result":if("assistant"===r||"user"===r)throw Error(e);t[r].push(a);break;case"file":if("tool"===r)throw Error(e);t[r].push({...a,data:a.data instanceof ArrayBuffer?new Uint8Array(a.data):a.data});break;case"image":if("tool"===r)throw Error(e);t[r].push({...a,mediaType:a.mediaType||"image/unknown",type:"file",data:a.image instanceof ArrayBuffer?new Uint8Array(a.image):a.image})}}if("tool"===r||"user"===r||"assistant"===r)return{...e,content:t[r]};throw Error(`Encountered unknown role ${r} when converting V5 ModelMessage -> V5 LanguageModelV2Message, input message: ${JSON.stringify(e,null,2)}`)}function pS(e){return"string"==typeof e?e:e.reduce((e,t)=>("text"===t.type&&(e+=t.text),e),"")}function px(e,t){let r=pp.isAIV4UIMessage(e)&&e,a=pp.isAIV4UIMessage(t)&&t;if(r&&!a)return!1;if(r&&a)return pk.fromAIV4Parts(e.parts)===pk.fromAIV4Parts(t.parts);let s=pp.isAIV4CoreMessage(e)&&e,n=pp.isAIV4CoreMessage(t)&&t;if(s&&!n)return!1;if(s&&n)return pk.fromAIV4CoreMessageContent(s.content)===pk.fromAIV4CoreMessageContent(n.content);let i=pp.isMastraMessageV1(e)&&e,o=pp.isMastraMessageV1(t)&&t;if(i&&!o)return!1;if(i&&o)return i.id===o.id&&pk.fromAIV4CoreMessageContent(i.content)===pk.fromAIV4CoreMessageContent(o.content);let l=pp.isMastraDBMessage(e)&&e,u=pp.isMastraDBMessage(t)&&t;if(l&&!u)return!1;if(l&&u)return l.id===u.id&&pk.fromDBParts(l.content.parts)===pk.fromDBParts(u.content.parts);let p=pp.isAIV5UIMessage(e)&&e,d=pp.isAIV5UIMessage(t)&&t;if(p&&!d)return!1;if(p&&d)return pk.fromAIV5Parts(e.parts)===pk.fromAIV5Parts(t.parts);let c=pp.isAIV5CoreMessage(e)&&e,m=pp.isAIV5CoreMessage(t)&&t;return(!c||!!m)&&(!c||!m||pk.fromAIV5ModelMessageContent(c.content)===pk.fromAIV5ModelMessageContent(m.content))}function pT(e,t=!1){return e.map(e=>{if(0===e.parts.length)return!1;let r=e.parts.filter(e=>!a9(e)||(t?"output-available"===e.state||"output-error"===e.state:"input-streaming"!==e.state));return!!r.length&&{...e,parts:r.map(e=>a9(e)&&"output-available"===e.state?{...e,output:"object"==typeof e.output&&e.output&&"value"in e.output?e.output.value:e.output}:e)}}).filter(e=>!!e)}function pE(e){return of(e.map(e=>{if(0===e.parts.length)return!1;let t=e.parts.filter(e=>"tool-invocation"!==e.type||"call"!==e.toolInvocation.state&&"partial-call"!==e.toolInvocation.state);if(!t.length)return!1;let r={...e,parts:t};return"toolInvocations"in e&&e.toolInvocations&&(r.toolInvocations=e.toolInvocations.filter(e=>"result"===e.state)),r}).filter(e=>!!e))}function pA(e,t,r=!1){var a;let s=function(e){for(let t of e)if("assistant"===t.role)for(let[e,r]of t.parts.entries()){if(!a9(r))continue;let a=t.parts.at(e+1);a&&"step-start"!==a.type&&!a9(a)&&t.parts.splice(e+1,0,{type:"step-start"})}return e}(pT(e,r));return a=st(s).map((e,t)=>{let r=s[t];return r?.metadata&&"object"==typeof r.metadata&&"providerMetadata"in r.metadata&&r.metadata.providerMetadata?{...e,providerOptions:r.metadata.providerMetadata}:e}),a.map(e=>{var r,a;return r=e,a=t,"tool"===r.role&&Array.isArray(r.content)?{...r,content:r.content.map(e=>"tool-result"===e.type?{...e,input:py(a,e.toolCallId)}:e)}:r})}function pO(e,t,r,a){return pA(e.map(e=>pv.fromCoreMessage(e,r,t)).map(e=>pw.toUIMessage(e)),a)}var pz=class{base64Data;uint8ArrayData;mediaType;constructor({data:e,mediaType:t}){const r=e instanceof Uint8Array;this.base64Data=r?void 0:e,this.uint8ArrayData=r?e:void 0,this.mediaType=t}get base64(){return null==this.base64Data&&(this.base64Data=pu(this.uint8ArrayData)),this.base64Data}get uint8Array(){return null==this.uint8ArrayData&&(this.uint8ArrayData=pl(this.base64Data)),this.uint8ArrayData}},pM=class extends pz{type="file";constructor(e){super(e)}},pP=class e{static extractStepContent(t,r,a){let s=t.flatMap(e=>e.parts),n=[];return(s.forEach((e,t)=>{"step-start"===e.type&&n.push(t)}),-1===r)?e.extractLastStep(s,n,a):1===r?e.extractFirstStep(s,n,a):e.extractMiddleStep(s,n,r,a)}static extractLastStep(t,r,a){let s=t.filter(e=>e.type?.startsWith("tool-")),n=r.length>0;if(!n&&s.length>0){let r=s[s.length-1];if(!r)return[];let n=t.indexOf(r),i=s[s.length-2],o=i?t.indexOf(i):-1,l=t.slice(o+1,n+1);return e.convertPartsToContent(l,"last-step",a)}if(1===r.length+1&&!n)return e.convertPartsToContent(t,"last-step",a);let i=r[r.length-1];if(void 0===i)return[];let o=t.slice(i+1);return 0===o.length?[]:e.convertPartsToContent(o,"last-step",a)}static extractFirstStep(t,r,a){let s=r[0]??t.length;if(0===s)return[];let n=t.slice(0,s);return e.convertPartsToContent(n,"step-1",a)}static extractMiddleStep(t,r,a,s){let n=a-2;if(n<0||n>=r.length)return[];let i=(r[n]??0)+1,o=r[n+1]??t.length;if(i>=o)return[];let l=t.slice(i,o);return e.convertPartsToContent(l,`step-${a}`,s)}static convertPartsToContent(e,t,r){return st(pT([{id:t,role:"assistant",parts:e}])).flatMap(r)}static convertToStepContent(e,t,r){let a=e||r();return a?"string"==typeof a.content?[{type:"text",text:a.content}]:a.content.map(e=>"tool-result"===e.type?{type:"tool-result",input:py(t,e.toolCallId),output:e.output,toolCallId:e.toolCallId,toolName:e.toolName}:"file"===e.type?{type:"file",file:new pM({data:"string"==typeof e.data?pc(e.data).base64Content:e.data instanceof URL?e.data.toString():pd(e.data),mediaType:e.mediaType})}:"image"===e.type?{type:"file",file:new pM({data:"string"==typeof e.image?pc(e.image).base64Content:e.image instanceof URL?e.image.toString():pd(e.image),mediaType:e.mediaType||"unknown"})}:{...e}):[]}},pR=class e{static shouldMerge(e,t,r,a,s=!1){return!!e&&"assistant"===e.role&&"assistant"===t.role&&e.threadId===t.threadId&&"memory"!==r&&(!s||!a)}static merge(t,r){t.createdAt=r.createdAt||t.createdAt;let a=new Map,s=new Map;for(let[e,n]of r.content.parts.entries())if("tool-invocation"===n.type){let r=[...t.content.parts].reverse().find(e=>"tool-invocation"===e.type&&e.toolInvocation.toolCallId===n.toolInvocation.toolCallId);if(r&&"tool-invocation"===r.type){if("result"===n.toolInvocation.state){r.toolInvocation={...r.toolInvocation,step:n.toolInvocation.step,state:"result",result:n.toolInvocation.result,args:{...r.toolInvocation.args,...n.toolInvocation.args}},t.content.toolInvocations||(t.content.toolInvocations=[]);let e=t.content.toolInvocations.findIndex(e=>e.toolCallId===r.toolInvocation.toolCallId);-1===e?t.content.toolInvocations.push(r.toolInvocation):t.content.toolInvocations[e]=r.toolInvocation}let s=t.content.parts.findIndex(e=>e===r);a.set(e,s)}else s.set(e,n)}else s.set(e,n);e.addPartsToMessage({latestMessage:t,incomingMessage:r,anchorMap:a,partsToAdd:s}),t.createdAt.getTime()<r.createdAt.getTime()&&(t.createdAt=r.createdAt),!t.content.content&&r.content.content&&(t.content.content=r.content.content),t.content.content&&r.content.content&&t.content.content!==r.content.content&&(t.content.content=r.content.content)}static addPartsToMessage({latestMessage:t,incomingMessage:r,anchorMap:a,partsToAdd:s}){for(let n=0;n<r.content.parts.length;++n){let i=r.content.parts[n];if(!i)continue;let o=pk.fromDBParts([i]),l=s.get(n);if(o&&l)if(a.size>0){if(a.has(n))continue;let s=[...a.keys()].filter(e=>e<n).pop()??-1,o=[...a.keys()].find(e=>e>n)??-1,l=(-1!==s?a.get(s):0)+(-1===s?n:n-s),u=-1!==o?a.get(o):t.content.parts.length;if(l>=0&&l<=u&&!t.content.parts.slice(l,u).some(e=>pk.fromDBParts([e])===pk.fromDBParts([i])))for(let[s,n]of(e.pushNewPart({latestMessage:t,newMessage:r,part:i,insertAt:l}),a.entries()))n>=l&&a.set(s,n+1)}else e.pushNewPart({latestMessage:t,newMessage:r,part:i})}}static pushNewPart({latestMessage:e,newMessage:t,part:r,insertAt:a}){let s=pk.fromDBParts([r]);if(e.content.parts.filter(e=>pk.fromDBParts([e])===s).length<t.content.parts.filter(e=>pk.fromDBParts([e])===s).length){let s=t.content.parts.indexOf(r),n=s>0&&t.content.parts[s-1]?.type==="step-start",i="assistant"===e.role&&"text"===r.type&&!n&&e.content.parts.length>0&&e.content.parts.at(-1)?.type==="tool-invocation";"number"==typeof a?i?(e.content.parts.splice(a,0,{type:"step-start"}),e.content.parts.splice(a+1,0,r)):e.content.parts.splice(a,0,r):(i&&e.content.parts.push({type:"step-start"}),e.content.parts.push(r))}}},pC=[{mediaType:"image/gif",bytesPrefix:[71,73,70],base64Prefix:"R0lG"},{mediaType:"image/png",bytesPrefix:[137,80,78,71],base64Prefix:"iVBORw"},{mediaType:"image/jpeg",bytesPrefix:[255,216],base64Prefix:"/9j/"},{mediaType:"image/webp",bytesPrefix:[82,73,70,70],base64Prefix:"UklGRg"},{mediaType:"image/bmp",bytesPrefix:[66,77],base64Prefix:"Qk"},{mediaType:"image/tiff",bytesPrefix:[73,73,42,0],base64Prefix:"SUkqAA"},{mediaType:"image/tiff",bytesPrefix:[77,77,0,42],base64Prefix:"TU0AKg"},{mediaType:"image/avif",bytesPrefix:[0,0,0,32,102,116,121,112,97,118,105,102],base64Prefix:"AAAAIGZ0eXBhdmlm"},{mediaType:"image/heic",bytesPrefix:[0,0,0,32,102,116,121,112,104,101,105,99],base64Prefix:"AAAAIGZ0eXBoZWlj"}];function pj(e){let t=[];for(let r of e){let e,a=ph(r.url,r.contentType),s=r.url;"raw"===a.type&&(s=pm(r.url,r.contentType||"application/octet-stream"));try{e=new URL(s)}catch{throw Error(`Invalid URL: ${r.url}`)}switch(e.protocol){case"http:":case"https:":case"gs:":case"s3:":if(r.contentType?.startsWith("image/"))t.push({type:"image",image:e.toString(),mimeType:r.contentType});else{if(!r.contentType)throw Error("If the attachment is not an image, it must specify a content type");t.push({type:"file",data:e.toString(),mimeType:r.contentType})}break;case"data:":if(r.contentType?.startsWith("image/"))t.push({type:"image",image:s,mimeType:r.contentType});else if(r.contentType?.startsWith("text/"))t.push({type:"file",data:s,mimeType:r.contentType});else{if(!r.contentType)throw Error("If the attachment is not an image or text, it must specify a content type");t.push({type:"file",data:s,mimeType:r.contentType})}break;default:throw Error(`Unsupported URL protocol: ${e.protocol}`)}}return t}function pN(e){let t,r,a=[],s=(t=new Map,r=/__split-\d+$/,e=>{let s=a.at(-1);if(e.role===s?.role&&Array.isArray(s.content)&&Array.isArray(e.content)&&("assistant"!==e.role||"assistant"===e.role&&e.content.at(-1)?.type!=="tool-call"))for(let t of e.content)s.content.push(t);else{let s=e.id;if(r.test(s))return void a.push(e);let n=t.get(s)||0;n>0&&(e.id=`${s}__split-${n}`),t.set(s,n+1),a.push(e)}});for(let t=0;t<e.length;t++){let r=e[t],a=t===e.length-1;if(!r?.content)continue;let{content:n,experimental_attachments:i=[],parts:o}=r.content,{role:l}=r,u={id:r.id,createdAt:r.createdAt,resourceId:r.resourceId,threadId:r.threadId},p=[...i],d=[];for(let e of o)"file"===e.type?p.push({url:e.data,contentType:e.mimeType}):d.push(e);switch(l){case"user":if(null==d){let e=p?[{type:"text",text:n||""},...pj(p)]:{type:"text",text:n||""};s({role:"user",...u,type:"text",content:e})}else{let e=r.content.parts.filter(e=>"text"===e.type).map(e=>({type:"text",text:e.text})),t=p?[...e,...pj(p)]:e;s({role:"user",...u,type:"text",content:Array.isArray(t)&&1===t.length&&t[0]?.type==="text"&&void 0!==n?n:t})}break;case"assistant":{if(null!=r.content.parts){let e=function(){let e=[];for(let t of n)switch(t.type){case"file":case"text":e.push(t);break;case"reasoning":for(let r of t.details)switch(r.type){case"text":e.push({type:"reasoning",text:r.text,signature:r.signature});break;case"redacted":e.push({type:"redacted-reasoning",data:r.data})}break;case"tool-invocation":"updateWorkingMemory"!==t.toolInvocation.toolName&&e.push({type:"tool-call",toolCallId:t.toolInvocation.toolCallId,toolName:t.toolInvocation.toolName,args:t.toolInvocation.args})}s({role:"assistant",...u,type:e.some(e=>"tool-call"===e.type)?"tool-call":"text",content:Array.isArray(e)&&1===e.length&&e[0]?.type==="text"?e[0].text:e});let r=n.filter(e=>"type"in e&&"tool-invocation"===e.type).map(e=>e.toolInvocation).filter(e=>"updateWorkingMemory"!==e.toolName).filter(e=>"result"===e.state&&"result"in e);r.length>0&&s({role:"tool",...u,type:"tool-result",content:r.map(e=>{let{toolCallId:t,toolName:r,result:a}=e;return{type:"tool-result",toolCallId:t,toolName:r,result:a}})}),n=[],a=!1,t++},t=0,a=!1,n=[];for(let s of r.content.parts)switch(s.type){case"text":a&&e(),n.push(s);break;case"file":case"reasoning":n.push(s);break;case"tool-invocation":(n.some(e=>"text"===e.type||"file"===e.type||"reasoning"===e.type)||(s.toolInvocation.step??0)!==t)&&e(),n.push(s),a=!0}e();let i=r.content.toolInvocations;if(i&&i.length>0){let e=new Set;for(let t of r.content.parts)"tool-invocation"===t.type&&t.toolInvocation.toolCallId&&e.add(t.toolInvocation.toolCallId);let t=i.filter(t=>!e.has(t.toolCallId)&&"updateWorkingMemory"!==t.toolName);if(t.length>0){let e=new Map;for(let r of t){let t=r.step??0;e.has(t)||e.set(t,[]),e.get(t).push(r)}for(let t of Array.from(e.keys()).sort((e,t)=>e-t)){let r=e.get(t);s({role:"assistant",...u,type:"tool-call",content:[...r.map(({toolCallId:e,toolName:t,args:r})=>({type:"tool-call",toolCallId:e,toolName:t,args:r}))]});let a=r.filter(e=>"result"===e.state&&"result"in e);a.length>0&&s({role:"tool",...u,type:"tool-result",content:a.map(e=>{let{toolCallId:t,toolName:r,result:a}=e;return{type:"tool-result",toolCallId:t,toolName:r,result:a}})})}}}break}let e=r.content.toolInvocations;if(null==e||0===e.length){s({role:"assistant",...u,content:n||"",type:"text"});break}let t=e.reduce((e,t)=>Math.max(e,t.step??0),0);for(let r=0;r<=t;r++){let t=e.filter(e=>(e.step??0)===r&&"updateWorkingMemory"!==e.toolName);if(0===t.length)continue;s({role:"assistant",...u,type:"tool-call",content:[...a&&n&&0===r?[{type:"text",text:n}]:[],...t.map(({toolCallId:e,toolName:t,args:r})=>({type:"tool-call",toolCallId:e,toolName:t,args:r}))]});let i=t.filter(e=>"result"===e.state&&"result"in e);i.length>0&&s({role:"tool",...u,type:"tool-result",content:i.map(e=>{let{toolCallId:t,toolName:r,result:a}=e;return{type:"tool-result",toolCallId:t,toolName:r,result:a}})})}n&&!a&&s({role:"assistant",...u,type:"text",content:n||""})}}}return a}async function pL(e,t={},r=3){let a=0,s=null;for(;a<r;)try{let n=await fetch(e,t);if(!n.ok){if(n.status>=400&&n.status<500)throw Error(`Request failed with status: ${n.status} ${n.statusText}`);if(s=Error(`Request failed with status: ${n.status} ${n.statusText}`),++a>=r)throw s;let e=Math.min(1e3*Math.pow(2,a),1e4);await new Promise(t=>setTimeout(t,e));continue}return n}catch(t){if((s=t instanceof Error?t:Error(String(t))).message.includes("status: 4"))throw s;if(++a>=r)break;let e=Math.min(1e3*Math.pow(2,a),1e4);await new Promise(t=>setTimeout(t,e))}throw s||Error("Request failed after multiple retry attempts")}var pD=async({url:e,downloadRetries:t})=>{let r=e.toString();try{let e=await pL(r,{method:"GET"},t);if(!e.ok)throw new eN.MastraError({id:"DOWNLOAD_ASSETS_FAILED",text:"Failed to download asset",domain:"LLM",category:"USER"});return{data:new Uint8Array(await e.arrayBuffer()),mediaType:e.headers.get("content-type")??void 0}}catch(e){throw new eN.MastraError({id:"DOWNLOAD_ASSETS_FAILED",text:"Failed to download asset",domain:"LLM",category:"USER"},e)}};async function pq({messages:t,downloadConcurrency:r=10,downloadRetries:a=3,supportedUrls:s}){let n=(await e.A(147098)).default,i=t.filter(e=>"user"===e.role).map(e=>e.content).filter(e=>Array.isArray(e)).flat().filter(e=>"image"===e.type||"file"===e.type).map(e=>{let t=e.mediaType??("image"===e.type?"image/*":void 0),r="image"===e.type?e.image:e.data;if("string"==typeof r)try{r=new URL(r)}catch{}return{mediaType:t,data:r}}).filter(e=>e.data instanceof URL).map(e=>({url:e.data,isUrlSupportedByModel:null!=e.mediaType&&function({mediaType:e,url:t,supportedUrls:r}){return t=t.toLowerCase(),e=e.toLowerCase(),Object.entries(r).map(([e,t])=>{let r=e.toLowerCase();return"*"===r||"*/*"===r?{mediaTypePrefix:"",regexes:t}:{mediaTypePrefix:r.replace(/\*/,""),regexes:t}}).filter(({mediaTypePrefix:t})=>e.startsWith(t)).flatMap(({regexes:e})=>e).some(e=>e.test(t))}({url:e.data.toString(),mediaType:e.mediaType,supportedUrls:s??{}})}));return Object.fromEntries((await n(i,async e=>e.isUrlSupportedByModel?null:{url:e.url.toString(),...await pD({url:e.url,downloadRetries:a})},{concurrency:r})).filter(e=>e?.data!=null).map(({url:e,data:t,mediaType:r})=>[e,{data:t,mediaType:r}]))}function p$(e){return{...e,createdAt:e.createdAt.toUTCString()}}function pF(e){return{...e,createdAt:new Date(e.createdAt)}}var pU=class{memoryMessages=new Set;newUserMessages=new Set;newResponseMessages=new Set;userContextMessages=new Set;memoryMessagesPersisted=new Set;newUserMessagesPersisted=new Set;newResponseMessagesPersisted=new Set;userContextMessagesPersisted=new Set;addToSource(e,t){switch(t){case"memory":this.memoryMessages.add(e),this.memoryMessagesPersisted.add(e);break;case"response":this.newResponseMessages.add(e),this.newResponseMessagesPersisted.add(e),this.newUserMessages.has(e)&&this.newUserMessages.delete(e);break;case"input":case"user":this.newUserMessages.add(e),this.newUserMessagesPersisted.add(e);break;case"context":this.userContextMessages.add(e),this.userContextMessagesPersisted.add(e);break;default:throw Error(`Missing message source for message ${e}`)}}isMemoryMessage(e){return this.memoryMessages.has(e)}isUserMessage(e){return this.newUserMessages.has(e)}isResponseMessage(e){return this.newResponseMessages.has(e)}isContextMessage(e){return this.userContextMessages.has(e)}getMemoryMessages(){return this.memoryMessages}getUserMessages(){return this.newUserMessages}getResponseMessages(){return this.newResponseMessages}getContextMessages(){return this.userContextMessages}getMemoryMessagesPersisted(){return this.memoryMessagesPersisted}getUserMessagesPersisted(){return this.newUserMessagesPersisted}getResponseMessagesPersisted(){return this.newResponseMessagesPersisted}getContextMessagesPersisted(){return this.userContextMessagesPersisted}removeMessage(e){this.memoryMessages.delete(e),this.newUserMessages.delete(e),this.newResponseMessages.delete(e),this.userContextMessages.delete(e)}clearUserMessages(){this.newUserMessages.clear()}clearResponseMessages(){this.newResponseMessages.clear()}clearContextMessages(){this.userContextMessages.clear()}clearAll(){this.newUserMessages.clear(),this.newResponseMessages.clear(),this.userContextMessages.clear()}createSourceChecker(){let e={memory:new Set(Array.from(this.memoryMessages.values()).map(e=>e.id)),output:new Set(Array.from(this.newResponseMessages.values()).map(e=>e.id)),input:new Set(Array.from(this.newUserMessages.values()).map(e=>e.id)),context:new Set(Array.from(this.userContextMessages.values()).map(e=>e.id))};return{...e,getSource:t=>e.memory.has(t.id)?"memory":e.input.has(t.id)?"input":e.output.has(t.id)?"response":e.context.has(t.id)?"context":null}}isNewMessage(e){let t="string"==typeof e?e:e.id;return!!("string"!=typeof e&&(this.newUserMessages.has(e)||this.newResponseMessages.has(e)))||Array.from(this.newUserMessages).some(e=>e.id===t)||Array.from(this.newResponseMessages).some(e=>e.id===t)}serializeSourceTracking(){let e=e=>Array.from(e).map(e=>e.id);return{memoryMessages:e(this.memoryMessages),newUserMessages:e(this.newUserMessages),newResponseMessages:e(this.newResponseMessages),userContextMessages:e(this.userContextMessages),memoryMessagesPersisted:e(this.memoryMessagesPersisted),newUserMessagesPersisted:e(this.newUserMessagesPersisted),newResponseMessagesPersisted:e(this.newResponseMessagesPersisted),userContextMessagesPersisted:e(this.userContextMessagesPersisted)}}deserializeSourceTracking(e,t){let r=e=>new Set(e.map(e=>t.find(t=>t.id===e)).filter(Boolean));this.memoryMessages=r(e.memoryMessages),this.newUserMessages=r(e.newUserMessages),this.newResponseMessages=r(e.newResponseMessages),this.userContextMessages=r(e.userContextMessages),this.memoryMessagesPersisted=r(e.memoryMessagesPersisted),this.newUserMessagesPersisted=r(e.newUserMessagesPersisted),this.newResponseMessagesPersisted=r(e.newResponseMessagesPersisted),this.userContextMessagesPersisted=r(e.userContextMessagesPersisted)}serializeAll(e){return{messages:e.messages.map(p$),systemMessages:e.systemMessages,taggedSystemMessages:e.taggedSystemMessages,memoryInfo:e.memoryInfo,_agentNetworkAppend:e.agentNetworkAppend,...this.serializeSourceTracking()}}deserializeAll(e){let t=e.messages.map(pF);return this.deserializeSourceTracking({memoryMessages:e.memoryMessages,newUserMessages:e.newUserMessages,newResponseMessages:e.newResponseMessages,userContextMessages:e.userContextMessages,memoryMessagesPersisted:e.memoryMessagesPersisted,newUserMessagesPersisted:e.newUserMessagesPersisted,newResponseMessagesPersisted:e.newResponseMessagesPersisted,userContextMessagesPersisted:e.userContextMessagesPersisted},t),{messages:t,systemMessages:e.systemMessages,taggedSystemMessages:e.taggedSystemMessages,memoryInfo:e.memoryInfo,agentNetworkAppend:e._agentNetworkAppend}}},pZ=class{messages=[];systemMessages=[];taggedSystemMessages={};memoryInfo=null;stateManager=new pU;get memoryMessages(){return this.stateManager.getMemoryMessages()}get newUserMessages(){return this.stateManager.getUserMessages()}get newResponseMessages(){return this.stateManager.getResponseMessages()}get userContextMessages(){return this.stateManager.getContextMessages()}get memoryMessagesPersisted(){return this.stateManager.getMemoryMessagesPersisted()}get newUserMessagesPersisted(){return this.stateManager.getUserMessagesPersisted()}get newResponseMessagesPersisted(){return this.stateManager.getResponseMessagesPersisted()}get userContextMessagesPersisted(){return this.stateManager.getContextMessagesPersisted()}generateMessageId;_agentNetworkAppend=!1;isRecording=!1;recordedEvents=[];constructor({threadId:e,resourceId:t,generateMessageId:r,_agentNetworkAppend:a}={}){e&&(this.memoryInfo={threadId:e,resourceId:t}),this.generateMessageId=r,this._agentNetworkAppend=a||!1}startRecording(){this.isRecording=!0,this.recordedEvents=[]}stopRecording(){this.isRecording=!1;let e=[...this.recordedEvents];return this.recordedEvents=[],e}add(e,t){if("user"===t&&(t="input"),!e)return this;let r=Array.isArray(e)?e:[e];for(let e of(this.isRecording&&this.recordedEvents.push({type:"add",source:t,count:r.length}),r))this.addOne("string"==typeof e?{role:"user",content:e}:e,t);return this}serialize(){return this.stateManager.serializeAll({messages:this.messages,systemMessages:this.systemMessages,taggedSystemMessages:this.taggedSystemMessages,memoryInfo:this.memoryInfo,agentNetworkAppend:this._agentNetworkAppend})}deserialize(e){let t=this.stateManager.deserializeAll(e);return this.messages=t.messages,this.systemMessages=t.systemMessages,this.taggedSystemMessages=t.taggedSystemMessages,this.memoryInfo=t.memoryInfo,this._agentNetworkAppend=t.agentNetworkAppend,this}makeMessageSourceChecker(){return this.stateManager.createSourceChecker()}getLatestUserContent(){let e=this.all.core().filter(e=>"user"===e.role),t=e.at(-1)?.content;return t?pS(t):null}get get(){return{all:this.all,remembered:this.remembered,input:this.input,response:this.response}}get getPersisted(){return{remembered:this.rememberedPersisted,input:this.inputPersisted,taggedSystemMessages:this.taggedSystemMessages,response:this.responsePersisted}}get clear(){return{all:{db:()=>{let e=[...this.messages];return this.messages=[],this.stateManager.clearAll(),this.isRecording&&e.length>0&&this.recordedEvents.push({type:"clear",count:e.length}),e}},input:{db:()=>{let e=Array.from(this.stateManager.getUserMessages());return this.messages=this.messages.filter(e=>!this.stateManager.isUserMessage(e)),this.stateManager.clearUserMessages(),this.isRecording&&e.length>0&&this.recordedEvents.push({type:"clear",source:"input",count:e.length}),e}},response:{db:()=>{let e=Array.from(this.stateManager.getResponseMessages());return this.messages=this.messages.filter(e=>!this.stateManager.isResponseMessage(e)),this.stateManager.clearResponseMessages(),this.isRecording&&e.length>0&&this.recordedEvents.push({type:"clear",source:"response",count:e.length}),e}}}}removeByIds(e){let t=new Set(e),r=[];return this.messages=this.messages.filter(e=>!t.has(e.id)||(r.push(e),this.stateManager.removeMessage(e),!1)),this.isRecording&&r.length>0&&this.recordedEvents.push({type:"removeByIds",ids:e,count:r.length}),r}all={db:()=>this.messages,v1:()=>pN(this.all.db()),aiV5:{model:()=>pA(this.all.aiV5.ui(),this.messages),ui:()=>this.all.db().map(pw.toUIMessage),prompt:()=>pf([...pO([...this.systemMessages,...Object.values(this.taggedSystemMessages).flat()],"system",this.createAdapterContext(),this.messages),...pA(this.all.aiV5.ui(),this.messages,!0)]),llmPrompt:async(e={downloadConcurrency:10,downloadRetries:3})=>{let t=pA(this.all.aiV5.ui(),this.messages,!0),r=pO([...this.systemMessages,...Object.values(this.taggedSystemMessages).flat()],"system",this.createAdapterContext(),this.messages),a=await pq({messages:t,downloadConcurrency:e?.downloadConcurrency,downloadRetries:e?.downloadRetries,supportedUrls:e?.supportedUrls}),s=[...r,...t];return t.some(e=>"user"===e.role&&"string"!=typeof e.content&&e.content.some(e=>"image"===e.type||"file"===e.type))&&(s=s.map(e=>"user"===e.role?"string"==typeof e.content?{role:"user",content:[{type:"text",text:e.content}],providerOptions:e.providerOptions}:{role:"user",content:e.content.map(e=>"image"===e.type||"file"===e.type?function(e,t){let r,a=e.type;switch(a){case"image":r=e.image;break;case"file":r=e.data;break;default:throw Error(`Unsupported part type: ${a}`)}let{data:s,mediaType:n}=function(e){if(e instanceof Uint8Array)return{data:e,mediaType:void 0};if(e instanceof ArrayBuffer)return{data:new Uint8Array(e),mediaType:void 0};if("string"==typeof e)try{e=new URL(e)}catch{}if(e instanceof URL&&"data:"===e.protocol){let{mediaType:t,base64Content:r}=function(e){try{let[t,r]=e.split(",");return{mediaType:t?.split(";")[0]?.split(":")[1],base64Content:r}}catch{return{mediaType:void 0,base64Content:void 0}}}(e.toString());if(null==t||null==r)throw new eN.MastraError({id:"INVALID_DATA_URL_FORMAT",text:`Invalid data URL format in content ${e.toString()}`,domain:"LLM",category:"USER"});return{data:r,mediaType:t}}return{data:e,mediaType:void 0}}(r),i=n??e.mediaType,o=s;if(o instanceof URL&&t){let e=t[o.toString()];e&&(o=e.data,i??=e.mediaType)}switch(a){case"image":return(o instanceof Uint8Array||"string"==typeof o)&&(i=function({data:e,signatures:t}){let r,a,s="string"==typeof e&&e.startsWith("SUQz")||"string"!=typeof e&&e.length>10&&73===e[0]&&68===e[1]&&51===e[2]?(a=(127&(r="string"==typeof e?pl(e):e)[6])<<21|(127&r[7])<<14|(127&r[8])<<7|127&r[9],r.slice(a+10)):e;for(let e of t)if("string"==typeof s?s.startsWith(e.base64Prefix):s.length>=e.bytesPrefix.length&&e.bytesPrefix.every((e,t)=>s[t]===e))return e.mediaType}({data:o,signatures:pC})??i),{type:"file",mediaType:i??"image/*",filename:void 0,data:o,providerOptions:e.providerOptions};case"file":if(null==i)throw Error("Media type is missing for file part");return{type:"file",mediaType:i,filename:e.filename,data:o,providerOptions:e.providerOptions}}}(e,a):e).filter(e=>"text"!==e.type||""!==e.text),providerOptions:e.providerOptions}:e)),(s=pf(s)).map(pI)}},prompt:()=>this.all.aiV4.prompt(),ui:()=>this.all.db().map(pv.toUIMessage),core:()=>pE(this.all.aiV4.ui()),aiV4:{ui:()=>this.all.db().map(pv.toUIMessage),core:()=>pE(this.all.aiV4.ui()),prompt:()=>{let e=this.all.aiV4.core();return pf([...this.systemMessages,...Object.values(this.taggedSystemMessages).flat(),...e])},llmPrompt:()=>{let e=this.all.aiV4.core(),t=[...this.systemMessages,...Object.values(this.taggedSystemMessages).flat(),...e];return(t=pf(t)).map(p_)}}};remembered={db:()=>this.messages.filter(e=>this.memoryMessages.has(e)),v1:()=>pN(this.remembered.db()),aiV5:{model:()=>pA(this.remembered.aiV5.ui(),this.messages),ui:()=>this.remembered.db().map(pw.toUIMessage)},ui:()=>this.remembered.db().map(pv.toUIMessage),core:()=>pE(this.all.aiV4.ui()),aiV4:{ui:()=>this.remembered.db().map(pv.toUIMessage),core:()=>pE(this.all.aiV4.ui())}};rememberedPersisted={db:()=>this.all.db().filter(e=>this.memoryMessagesPersisted.has(e)),v1:()=>pN(this.rememberedPersisted.db()),aiV5:{model:()=>pA(this.rememberedPersisted.aiV5.ui(),this.messages),ui:()=>this.rememberedPersisted.db().map(pw.toUIMessage)},ui:()=>this.rememberedPersisted.db().map(pv.toUIMessage),core:()=>pE(this.rememberedPersisted.ui()),aiV4:{ui:()=>this.rememberedPersisted.db().map(pv.toUIMessage),core:()=>pE(this.rememberedPersisted.aiV4.ui())}};input={db:()=>this.messages.filter(e=>this.newUserMessages.has(e)),v1:()=>pN(this.input.db()),aiV5:{model:()=>pA(this.input.aiV5.ui(),this.messages),ui:()=>this.input.db().map(pw.toUIMessage)},ui:()=>this.input.db().map(pv.toUIMessage),core:()=>pE(this.input.ui()),aiV4:{ui:()=>this.input.db().map(pv.toUIMessage),core:()=>pE(this.input.aiV4.ui())}};inputPersisted={db:()=>this.messages.filter(e=>this.newUserMessagesPersisted.has(e)),v1:()=>pN(this.inputPersisted.db()),aiV5:{model:()=>pA(this.inputPersisted.aiV5.ui(),this.messages),ui:()=>this.inputPersisted.db().map(pw.toUIMessage)},ui:()=>this.inputPersisted.db().map(pv.toUIMessage),core:()=>pE(this.inputPersisted.ui()),aiV4:{ui:()=>this.inputPersisted.db().map(pv.toUIMessage),core:()=>pE(this.inputPersisted.aiV4.ui())}};response={db:()=>this.messages.filter(e=>this.newResponseMessages.has(e)),v1:()=>pN(this.response.db()),aiV5:{ui:()=>this.response.db().map(pw.toUIMessage),model:()=>pA(this.response.aiV5.ui(),this.messages).filter(e=>"tool"===e.role||"assistant"===e.role),modelContent:e=>"number"==typeof e?pP.extractStepContent(this.response.aiV5.ui(),e,this.response.aiV5.stepContent):this.response.aiV5.model().map(this.response.aiV5.stepContent).flat(),stepContent:e=>pP.convertToStepContent(e,this.messages,()=>this.response.aiV5.model().at(-1))},aiV4:{ui:()=>this.response.db().map(pv.toUIMessage),core:()=>pE(this.response.aiV4.ui())}};responsePersisted={db:()=>this.messages.filter(e=>this.newResponseMessagesPersisted.has(e)),aiV5:{model:()=>pA(this.responsePersisted.aiV5.ui(),this.messages),ui:()=>this.responsePersisted.db().map(pw.toUIMessage)},ui:()=>this.responsePersisted.db().map(pv.toUIMessage),aiV4:{ui:()=>this.responsePersisted.db().map(pv.toUIMessage),core:()=>pE(this.responsePersisted.aiV4.ui())}};drainUnsavedMessages(){let e=this.messages.filter(e=>this.newUserMessages.has(e)||this.newResponseMessages.has(e));return this.newUserMessages.clear(),this.newResponseMessages.clear(),e}getEarliestUnsavedMessageTimestamp(){let e=this.messages.filter(e=>this.newUserMessages.has(e)||this.newResponseMessages.has(e));if(0!==e.length)return Math.min(...e.map(e=>new Date(e.createdAt).getTime()))}isNewMessage(e){return this.stateManager.isNewMessage(e)}getSystemMessages(e){return e?this.taggedSystemMessages[e]||[]:this.systemMessages}getAllSystemMessages(){return[...this.systemMessages,...Object.values(this.taggedSystemMessages).flat()]}replaceAllSystemMessages(e){for(let t of(this.systemMessages=[],this.taggedSystemMessages={},e))"system"===t.role&&this.systemMessages.push(t);return this}addSystem(e,t){if(!e)return this;for(let r of Array.isArray(e)?e:[e])this.addOneSystem(r,t);return this}addOneSystem(e,t){let r=function(e){if("string"==typeof e)return{role:"system",content:e};if(pp.isAIV5CoreMessage(e)){let t=pw.fromModelMessage(e,"system");return pv.systemToV4Core(t)}return pp.isMastraDBMessage(e)?pv.systemToV4Core(e):e}(e);if("system"!==r.role)throw Error(`Expected role "system" but saw ${r.role} for message ${JSON.stringify(r,null,2)}`);t&&!this.isDuplicateSystem(r,t)?(this.taggedSystemMessages[t]||=[],this.taggedSystemMessages[t].push(r),this.isRecording&&this.recordedEvents.push({type:"addSystem",tag:t,message:r})):t||this.isDuplicateSystem(r)||(this.systemMessages.push(r),this.isRecording&&this.recordedEvents.push({type:"addSystem",message:r}))}isDuplicateSystem(e,t){return t?!!this.taggedSystemMessages[t]&&this.taggedSystemMessages[t].some(t=>pk.fromAIV4CoreMessageContent(t.content)===pk.fromAIV4CoreMessageContent(e.content)):this.systemMessages.some(t=>pk.fromAIV4CoreMessageContent(t.content)===pk.fromAIV4CoreMessageContent(e.content))}getMessageById(e){return this.messages.find(t=>t.id===e)}shouldReplaceMessage(e){if(!this.messages.length||!("id"in e)||!e?.id)return{exists:!1};let t=this.getMessageById(e.id);return t?{exists:!0,shouldReplace:!px(t,e),id:t.id}:{exists:!1}}addOne(e,t){if((!("content"in e)||!e.content&&"string"!=typeof e.content)&&(!("parts"in e)||!e.parts))throw new eN.MastraError({id:"INVALID_MESSAGE_CONTENT",domain:"AGENT",category:"USER",text:`Message with role "${e.role}" must have either a 'content' property (string or array) or a 'parts' property (array) that is not empty, null, or undefined. Received message: ${JSON.stringify(e,null,2)}`,details:{role:e.role,messageSource:t,hasContent:"content"in e,hasParts:"parts"in e}});if("system"===e.role){if("memory"===t)return null;if(pp.isAIV4CoreMessage(e)||pp.isAIV5CoreMessage(e)||pp.isMastraDBMessage(e))return this.addSystem(e);throw new eN.MastraError({id:"INVALID_SYSTEM_MESSAGE_FORMAT",domain:"AGENT",category:"USER",text:"Invalid system message format. System messages must be CoreMessage format with 'role' and 'content' properties. The content should be a string or valid content array.",details:{messageSource:t,receivedMessage:JSON.stringify(e,null,2)}})}let r=function(e,t,r){var a,s,n,i,o;if("memory"!==t&&"threadId"in e&&e.threadId&&r.memoryInfo&&e.threadId!==r.memoryInfo.threadId)throw Error(`Received input message with wrong threadId. Input ${e.threadId}, expected ${r.memoryInfo.threadId}`);if("resourceId"in e&&e.resourceId&&r.memoryInfo?.resourceId&&e.resourceId!==r.memoryInfo.resourceId)throw Error(`Received input message with wrong resourceId. Input ${e.resourceId}, expected ${r.memoryInfo.resourceId}`);if(pp.isMastraMessageV1(e)){let i;return a=e,s=t,n=r,i=pv.fromCoreMessage({content:a.content,role:a.role},n,s),{id:a.id,role:i.role,createdAt:n.generateCreatedAt(s,a.createdAt),threadId:a.threadId,resourceId:a.resourceId,content:i.content}}if(pp.isMastraDBMessage(e)){return i=e,o=r,i.id||(i.id=o.newMessageId()),i.createdAt instanceof Date||(i.createdAt=new Date(i.createdAt)),i.content.toolInvocations&&i.content.parts&&(i.content.toolInvocations=i.content.toolInvocations.map(e=>{if(!e.args||0===Object.keys(e.args).length){let t=i.content.parts.find(t=>"tool-invocation"===t.type&&t.toolInvocation&&t.toolInvocation.toolCallId===e.toolCallId&&t.toolInvocation.args&&Object.keys(t.toolInvocation.args).length>0);if(t&&"tool-invocation"===t.type)return{...e,args:t.toolInvocation.args}}return e})),!i.threadId&&o.memoryInfo?.threadId&&(i.threadId=o.memoryInfo.threadId,!i.resourceId&&o.memoryInfo?.resourceId&&(i.resourceId=o.memoryInfo.resourceId)),i}if(pp.isAIV4CoreMessage(e))return pv.fromCoreMessage(e,r,t);if(pp.isAIV4UIMessage(e))return pv.fromUIMessage(e,r,t);let l="id"in e&&"string"==typeof e.id?e.id:r.newMessageId();if(pp.isAIV5CoreMessage(e)){let a=pw.fromModelMessage(e,t),s="metadata"in e&&e.metadata&&"object"==typeof e.metadata&&"createdAt"in e.metadata?e.metadata.createdAt:void 0;return{...a,id:l,createdAt:r.generateCreatedAt(t,s),threadId:r.memoryInfo?.threadId,resourceId:r.memoryInfo?.resourceId}}if(pp.isAIV5UIMessage(e)){let a=pw.fromUIMessage(e),s="createdAt"in e?e.createdAt:void 0;return{...a,id:l,createdAt:r.generateCreatedAt(t,s),threadId:r.memoryInfo?.threadId,resourceId:r.memoryInfo?.resourceId}}throw Error(`Found unhandled message ${JSON.stringify(e)}`)}(e,t,this.createAdapterContext()),{exists:a,shouldReplace:s,id:n}=this.shouldReplaceMessage(r),i=this.messages.at(-1);if("memory"===t){for(let e of this.messages)if(px(e,r))return}let o=!!i&&this.memoryMessages.has(i);if(pR.shouldMerge(i,r,t,o,this._agentNetworkAppend)&&i)pR.merge(i,r),this.pushMessageToSource(i,t);else{let e=-1;s&&(e=this.messages.findIndex(e=>e.id===n));let i=-1!==e&&this.messages[e];s&&i?this.messages[e]=r:a||this.messages.push(r),this.pushMessageToSource(r,t)}return this.messages.sort((e,t)=>e.createdAt.getTime()-t.createdAt.getTime()),this}pushMessageToSource(e,t){this.stateManager.addToSource(e,t)}lastCreatedAt;generateCreatedAt(e,t){let r=t instanceof Date?t:"string"==typeof t||"number"==typeof t?new Date(t):void 0;if(r&&!this.lastCreatedAt)return this.lastCreatedAt=r.getTime(),r;if(r&&"memory"===e)return r;let a=new Date,s=r?.getTime()||a.getTime(),n=this.messages.reduce((e,t)=>t.createdAt.getTime()>e?t.createdAt.getTime():e,this.lastCreatedAt||0);if(s<=n){let e=new Date(n+1);return this.lastCreatedAt=e.getTime(),e}return this.lastCreatedAt=s,a}newMessageId(e){if(this.generateMessageId)return this.generateMessageId({idType:"message",source:"agent",threadId:this.memoryInfo?.threadId,resourceId:this.memoryInfo?.resourceId,role:e});var t,r=0,a="";if(!uJ||uH+16>256){for(uJ=Array(r=256);r--;)uJ[r]=256*Math.random()|0;r=uH=0}for(;r<16;r++)t=uJ[uH+r],6==r?a+=uY[15&t|64]:8==r?a+=uY[63&t|128]:a+=uY[t],1&r&&r>1&&r<11&&(a+="-");return uH++,a}createAdapterContext(){return{memoryInfo:this.memoryInfo,newMessageId:()=>this.newMessageId(),generateCreatedAt:(e,t)=>this.generateCreatedAt(e,t),dbMessages:this.messages}}},pB=((p=pB||{}).AGENT_RUN="agent_run",p.GENERIC="generic",p.MODEL_GENERATION="model_generation",p.MODEL_STEP="model_step",p.MODEL_CHUNK="model_chunk",p.MCP_TOOL_CALL="mcp_tool_call",p.PROCESSOR_RUN="processor_run",p.TOOL_CALL="tool_call",p.WORKFLOW_RUN="workflow_run",p.WORKFLOW_STEP="workflow_step",p.WORKFLOW_CONDITIONAL="workflow_conditional",p.WORKFLOW_CONDITIONAL_EVAL="workflow_conditional_eval",p.WORKFLOW_PARALLEL="workflow_parallel",p.WORKFLOW_LOOP="workflow_loop",p.WORKFLOW_SLEEP="workflow_sleep",p.WORKFLOW_WAIT_EVENT="workflow_wait_event",p),pV=((d=pV||{}).AGENT="agent",d.EVAL="eval",d.INPUT_PROCESSOR="input_processor",d.INPUT_STEP_PROCESSOR="input_step_processor",d.OUTPUT_PROCESSOR="output_processor",d.OUTPUT_STEP_PROCESSOR="output_step_processor",d.WORKFLOW_STEP="workflow_step",d.TOOL="tool",d.WORKFLOW_RUN="workflow_run",d),pK=((c=pK||{})[c.NONE=0]="NONE",c[c.WORKFLOW=1]="WORKFLOW",c[c.AGENT=2]="AGENT",c[c.TOOL=4]="TOOL",c[c.MODEL=8]="MODEL",c[c.ALL=15]="ALL",c),pG=((m=pG||{}).ALWAYS="always",m.NEVER="never",m.RATIO="ratio",m.CUSTOM="custom",m),pW=((g=pW||{}).SPAN_STARTED="span_started",g.SPAN_UPDATED="span_updated",g.SPAN_ENDED="span_ended",g);function pQ(e){let{type:t,attributes:r,tracingContext:a,requestContext:s,tracingOptions:n,...i}=e,o={...i.metadata??{},...n?.metadata??{}};if(a?.currentSpan)return a.currentSpan.createChildSpan({type:t,attributes:r,...i,metadata:o});let l=e.mastra?.observability?.getSelectedInstance({requestContext:s});return l?.startSpan({type:t,attributes:r,...i,metadata:o,requestContext:s,tracingOptions:n,traceId:n?.traceId,parentSpanId:n?.parentSpanId,customSamplerOptions:{requestContext:s,metadata:o}})}async function pJ(e){let{span:t,fn:r}=e;return t?.executeInContext?t.executeInContext(r):r()}function pH(e){let{span:t,fn:r}=e;return t?.executeInContextSync?t.executeInContextSync(r):r()}var pY=["getAgent","getAgentById"],pX=["generate","stream","generateLegacy","streamLegacy"],p0=["getWorkflow","getWorkflowById"],p1=["execute","createRun","createRun"];function p2(e){return"NoOpSpan"===e.constructor.name||!0===e.__isNoOp}function p3(e,t){let r,a;if(!t.currentSpan||p2(t.currentSpan)||(r=pY.every(t=>"function"==typeof e?.[t]),a=p0.every(t=>"function"==typeof e?.[t]),!r||!a))return e;try{return new Proxy(e,{get(e,r){try{if(pY.includes(r))return(...a)=>{var s=e[r](...a),n=t;if(!n.currentSpan||p2(n.currentSpan))return s;try{return new Proxy(s,{get(e,t){try{if(pX.includes(t))return(r,a={})=>e[t](r,{...a,tracingContext:n});let r=e[t];return"function"==typeof r?r.bind(e):r}catch(a){console.warn("Tracing: Failed to wrap agent method, falling back to original",a);let r=e[t];return"function"==typeof r?r.bind(e):r}}})}catch(e){return console.warn("Tracing: Failed to create agent proxy, using original instance",e),s}};if(p0.includes(r))return(...a)=>{var s=e[r](...a),n=t;if(!n.currentSpan||p2(n.currentSpan))return s;try{return new Proxy(s,{get(e,t){try{if(p1.includes(t)){if("createRun"===t||"createRun"===t)return async(r={})=>{let a=await e[t](r);return a?function(e,t){if(!t.currentSpan||p2(t.currentSpan))return e;try{return new Proxy(e,{get(e,r){try{if("start"===r)return (r={})=>e.start({...r,tracingContext:r.tracingContext??t});let a=e[r];return"function"==typeof a?a.bind(e):a}catch(a){console.warn("Tracing: Failed to wrap run method, falling back to original",a);let t=e[r];return"function"==typeof t?t.bind(e):t}}})}catch(t){return console.warn("Tracing: Failed to create run proxy, using original instance",t),e}}(a,n):a};return(r,a={})=>e[t](r,{...a,tracingContext:n})}let r=e[t];return"function"==typeof r?r.bind(e):r}catch(a){console.warn("Tracing: Failed to wrap workflow method, falling back to original",a);let r=e[t];return"function"==typeof r?r.bind(e):r}}})}catch(e){return console.warn("Tracing: Failed to create workflow proxy, using original instance",e),s}};let a=e[r];return"function"==typeof a?a.bind(e):a}catch(a){console.warn("Tracing: Failed to wrap method, falling back to original",a);let t=e[r];return"function"==typeof t?t.bind(e):t}}})}catch(t){return console.warn("Tracing: Failed to create proxy, using original Mastra instance",t),e}}function p5(e){return"object"==typeof e&&null!==e&&"_def"in e&&"parse"in e&&"function"==typeof e.parse&&"safeParse"in e&&"function"==typeof e.safeParse}function p4(e){if(e._def?.typeName)return e._def.typeName;let t=e._def?.type;if("string"==typeof t&&t)return"Zod"+t.charAt(0).toUpperCase()+t.slice(1)}function p6(e){return!!p5(e)&&"ZodArray"===p4(e)}function p7(e){return!!p5(e)&&"ZodObject"===p4(e)}function p9(e){return e._zod?.def??e._def}var sg=eF,p8={createdAt:sg.date().describe("Database record creation time"),updatedAt:sg.date().describe("Database record last update time").nullable()},de=sg.object({page:sg.coerce.number().int().min(0).optional().default(0).describe("Zero-indexed page number"),perPage:sg.coerce.number().int().min(1).max(100).optional().default(10).describe("Number of items per page")}).describe("Pagination options for list queries"),dt=sg.object({total:sg.number().describe("Total number of items available"),page:sg.number().describe("Current page"),perPage:sg.union([sg.number(),sg.literal(!1)]).describe("Number of items per page, or false if pagination is disabled"),hasMore:sg.boolean().describe("True if more pages are available")}),dr=sg.object({start:sg.coerce.date().optional().describe("Start of date range (inclusive by default)"),end:sg.coerce.date().optional().describe("End of date range (inclusive by default)"),startExclusive:sg.boolean().optional().describe("When true, excludes the start date from results (uses > instead of >=)"),endExclusive:sg.boolean().optional().describe("When true, excludes the end date from results (uses < instead of <=)")}).describe("Date range filter for timestamps"),da=sg.enum(["ASC","DESC"]).describe("Sort direction: 'ASC' | 'DESC'"),ds=sg.nativeEnum(pV).describe("Entity type (e.g., 'agent' | 'processor' | 'tool' | 'workflow')"),dn=sg.string().describe('ID of the entity (e.g., "weatherAgent", "orderWorkflow")'),di=sg.string().describe("Name of the entity"),dl=sg.string().describe("Human end-user who triggered execution"),du=sg.string().describe("Multi-tenant organization/account"),dp=sg.string().describe("Broader resource context (Mastra memory compatibility)"),dd=sg.string().describe("Unique execution run identifier"),dc=sg.string().describe("Session identifier for grouping traces"),dm=sg.string().describe("Conversation thread identifier"),dg=sg.string().describe("HTTP request ID for log correlation"),dh=sg.string().describe('Environment (e.g., "production" | "staging" | "development")'),df=sg.string().describe('Source of execution (e.g., "local" | "cloud" | "ci")'),dy=sg.string().describe("Name of the service"),dv=sg.enum(["LIVE","TEST"]),db=sg.enum(["AGENT","WORKFLOW",...Object.values(pB)]);sg.object({description:sg.string(),prompt:sg.string()});var dw=sg.record(sg.string(),sg.unknown()),dk=dw.optional(),d_=sg.object({runId:sg.string().optional(),input:sg.unknown().optional(),output:sg.unknown(),additionalContext:dk,requestContext:dk});sg.object({runId:sg.string().optional(),scorer:dw,input:sg.unknown(),output:sg.unknown(),metadata:dk,additionalContext:dk,source:dv,entity:dw,entityType:db,requestContext:dk,structuredOutput:sg.boolean().optional(),traceId:sg.string().optional(),spanId:sg.string().optional(),resourceId:sg.string().optional(),threadId:sg.string().optional()});var dI=sg.number();sg.object({result:dk,score:dI,prompt:sg.string().optional()}),d_.extend({runId:sg.string(),extractStepResult:dk,extractPrompt:sg.string().optional()}).extend({score:sg.number(),analyzeStepResult:dk,analyzePrompt:sg.string().optional()}).extend({reason:sg.string().optional(),reasonPrompt:sg.string().optional()});var dS=sg.object({id:sg.string(),scorerId:sg.string(),entityId:sg.string(),runId:sg.string(),input:sg.unknown().optional(),output:sg.unknown(),additionalContext:dk,requestContext:dk,extractStepResult:dk,extractPrompt:sg.string().optional(),score:sg.number(),analyzeStepResult:dk,analyzePrompt:sg.string().optional(),reason:sg.string().optional(),reasonPrompt:sg.string().optional(),scorer:dw,metadata:dk,source:dv,entity:dw,entityType:db.optional(),structuredOutput:sg.boolean().optional(),traceId:sg.string().optional(),spanId:sg.string().optional(),resourceId:sg.string().optional(),threadId:sg.string().optional(),preprocessStepResult:dk,preprocessPrompt:sg.string().optional(),generateScorePrompt:sg.string().optional(),generateReasonPrompt:sg.string().optional(),...p8});dS.omit({id:!0,createdAt:!0,updatedAt:!0}),sg.object({pagination:dt,scores:sg.array(dS)});var dx=e=>Object.fromEntries(Object.keys(e).map(e=>[e,!0])),dT=sg.string().describe("Unique trace identifier"),dE=sg.string().describe("Unique span identifier within a trace"),dA=sg.string().describe("Human-readable span name"),dO=sg.string().describe("Parent span reference (null = root span)"),dz=sg.nativeEnum(pB).describe("Span type (e.g., WORKFLOW_RUN, AGENT_RUN, TOOL_CALL, etc.)"),dM=sg.record(sg.unknown()).describe("Span-type specific attributes (e.g., model, tokens, tools)"),dP=sg.record(sg.unknown()).describe("User-defined metadata for custom filtering"),dR=sg.array(sg.string()).describe("Labels for filtering traces (only on the root span)"),dC=sg.record(sg.unknown()).describe('Arbitrary package/app version info (e.g., {"core": "1.0.0", "memory": "1.0.0", "gitSha": "abcd1234"})'),dj=sg.array(sg.unknown()).describe("References to related spans in other traces"),dN=sg.unknown().describe("Input data passed to the span"),dL=sg.unknown().describe("Output data returned from the span"),dD=sg.unknown().describe("Error info - presence indicates failure (status derived from this)"),dq=sg.boolean().describe("Whether this is an event (point-in-time) vs a span (duration)"),d$=sg.date().describe("When the span started"),dF=sg.date().describe("When the span ended (null = running, status derived from this)"),dU=((h=dU||{}).SUCCESS="success",h.ERROR="error",h.RUNNING="running",h),dZ=sg.nativeEnum(dU).describe("Current status of the trace"),dB=sg.preprocess(e=>"true"===e||"false"!==e&&e,sg.boolean()).describe("True if any span in the trace encountered an error"),dV={entityType:ds.nullish(),entityId:dn.nullish(),entityName:di.nullish(),userId:dl.nullish(),organizationId:du.nullish(),resourceId:dp.nullish(),runId:dd.nullish(),sessionId:dc.nullish(),threadId:dm.nullish(),requestId:dg.nullish(),environment:dh.nullish(),source:df.nullish(),serviceName:dy.nullish(),scope:dC.nullish(),metadata:dP.nullish(),tags:dR.nullish()},dK={traceId:dT,spanId:dE};sg.object({...dK});var dG=dx(p8),dW=dx(dK),dQ=sg.object({...dK,name:dA,spanType:dz,isEvent:dq,startedAt:d$,parentSpanId:dO.nullish(),...dV,attributes:dM.nullish(),links:dj.nullish(),input:dN.nullish(),output:dL.nullish(),error:dD.nullish(),endedAt:dF.nullish(),...p8}).describe("Span record data"),dJ=dQ.omit(dG);sg.object({span:dJ}).describe("Arguments for creating a single span"),sg.object({records:sg.array(dJ)}).describe("Arguments for batch creating spans"),sg.object({traceId:dT.min(1),spanId:dE.min(1)}).describe("Arguments for getting a single span"),sg.object({span:dQ}),sg.object({traceId:dT.min(1)}).describe("Arguments for getting a root span"),sg.object({span:dQ}),sg.object({traceId:dT.min(1)}).describe("Arguments for getting a single trace"),sg.object({traceId:dT,spans:sg.array(dQ)});var dH=sg.object({startedAt:dr.optional().describe("Filter by span start time range"),endedAt:dr.optional().describe("Filter by span end time range"),spanType:dz.optional(),...dV,status:dZ.optional(),hasChildError:dB.optional()}).describe("Filters for querying traces"),dY=sg.enum(["startedAt","endedAt"]).describe("Field to order by: 'startedAt' | 'endedAt'"),dX=sg.object({field:dY.default("startedAt").describe("Field to order by"),direction:da.default("DESC").describe("Sort direction")}).describe("Order by configuration");sg.object({filters:dH.optional().describe("Optional filters to apply"),pagination:de.default({}).describe("Pagination settings"),orderBy:dX.default({}).describe("Ordering configuration (defaults to startedAt desc)")}).describe("Arguments for listing traces"),sg.object({pagination:dt,spans:sg.array(dQ)});var d0=dJ.omit(dW);function d1(e,t){return"ZodNullable"===t||"ZodOptional"===t||"ZodDefault"===t?e._zod?.def?.innerType??e._def?.innerType:"ZodEffects"===t?e._zod?.def?.schema??e._def?.schema:"ZodBranded"===t?e._zod?.def?.type??e._def?.type:void 0}function d2(e){return e._zod?.def?.checks?e._zod.def.checks:e._def?.checks?e._def.checks:[]}sg.object({spanId:dE,traceId:dT,updates:d0.partial()}).describe("Arguments for updating a single span"),sg.object({records:sg.array(sg.object({traceId:dT,spanId:dE,updates:d0.partial()}))}).describe("Arguments for batch updating spans"),sg.object({traceIds:sg.array(dT)}).describe("Arguments for batch deleting traces"),sg.object({pagination:dt,scores:sg.array(dS)}),sg.object({scorerName:sg.string().min(1),targets:sg.array(sg.object({traceId:dT,spanId:dE.optional()})).min(1)}),sg.object({status:sg.string(),message:sg.string(),traceCount:sg.number()});var d3=dQ;let d5=d3.shape,d4={};for(let[e,t]of Object.entries(d5)){let{base:r,nullable:a}=function(e){let t=e,r=!1;for(;;){let e=p4(t);if("ZodNullable"===e){r=!0;let a=d1(t,e);if(a){t=a;continue}}if("ZodOptional"===e){r=!0;let a=d1(t,e);if(a){t=a;continue}}if("ZodDefault"===e){let r=d1(t,e);if(r){t=r;continue}}if("ZodEffects"===e){let r=d1(t,e);if(r){t=r;continue}}if("ZodBranded"===e){let r=d1(t,e);if(r){t=r;continue}}break}return{base:t,nullable:r}}(t);d4[e]={type:function(e){let t=p4(e);return"ZodString"===t?d2(e).some(e=>"uuid"===e.kind)?"uuid":"text":"ZodNativeEnum"===t||"ZodEnum"===t?"text":"ZodNumber"===t?d2(e).some(e=>"int"===e.kind)?"integer":"float":"ZodBigInt"===t?"bigint":"ZodDate"===t?"timestamp":"ZodBoolean"===t?"boolean":"jsonb"}(r),nullable:a}}eL.MastraBase,eL.MastraBase,eL.MastraBase;var d6=e.i(522734),d7=e.i(362562),d9=e.i(446786),d8=e.i(814747);let ce={get url(){return`file://${e.P("node_modules/.pnpm/@mastra+core@1.0.4_@standard-community+standard-json@0.3.5_@standard-schema+spec@1.1.0__e15fdfaf85d1846d1444fec06ecbe277/node_modules/@mastra/core/dist/chunk-32QR3BZQ.js")}`}};var ct={providers:{"privatemode-ai":{url:"http://localhost:8080/v1",apiKeyEnvVar:"PRIVATEMODE_API_KEY",apiKeyHeader:"Authorization",name:"Privatemode AI",models:["gemma-3-27b","gpt-oss-120b","qwen3-coder-30b-a3b","qwen3-embedding-4b","whisper-large-v3"],docUrl:"https://docs.privatemode.ai/api/overview",gateway:"models.dev"},"moonshotai-cn":{url:"https://api.moonshot.cn/v1",apiKeyEnvVar:"MOONSHOT_API_KEY",apiKeyHeader:"Authorization",name:"Moonshot AI (China)",models:["kimi-k2-0711-preview","kimi-k2-0905-preview","kimi-k2-thinking","kimi-k2-thinking-turbo","kimi-k2-turbo-preview"],docUrl:"https://platform.moonshot.cn/docs/api/chat",gateway:"models.dev"},firmware:{url:"https://app.firmware.ai/api/v1",apiKeyEnvVar:"FIRMWARE_API_KEY",apiKeyHeader:"Authorization",name:"Firmware",models:["claude-haiku-4-5-20251001","claude-opus-4-5","claude-sonnet-4-5-20250929","deepseek-chat","deepseek-coder","deepseek-reasoner","gemini-2.5-flash","gemini-2.5-pro","gemini-3-flash-preview","gemini-3-pro-preview","gpt-4o","gpt-5","gpt-5-mini","gpt-5-nano","gpt-5.2","grok-4-fast-non-reasoning","grok-4-fast-reasoning","grok-code-fast-1"],docUrl:"https://docs.firmware.ai",gateway:"models.dev"},lucidquery:{url:"https://lucidquery.com/api/v1",apiKeyEnvVar:"LUCIDQUERY_API_KEY",apiKeyHeader:"Authorization",name:"LucidQuery AI",models:["lucidnova-rf1-100b","lucidquery-nexus-coder"],docUrl:"https://lucidquery.com/api/docs",gateway:"models.dev"},moonshotai:{url:"https://api.moonshot.ai/v1",apiKeyEnvVar:"MOONSHOT_API_KEY",apiKeyHeader:"Authorization",name:"Moonshot AI",models:["kimi-k2-0711-preview","kimi-k2-0905-preview","kimi-k2-thinking","kimi-k2-thinking-turbo","kimi-k2-turbo-preview"],docUrl:"https://platform.moonshot.ai/docs/api/chat",gateway:"models.dev"},"zai-coding-plan":{url:"https://api.z.ai/api/coding/paas/v4",apiKeyEnvVar:"ZHIPU_API_KEY",apiKeyHeader:"Authorization",name:"Z.AI Coding Plan",models:["glm-4.5","glm-4.5-air","glm-4.5-flash","glm-4.5v","glm-4.6","glm-4.6v","glm-4.7","glm-4.7-flash"],docUrl:"https://docs.z.ai/devpack/overview",gateway:"models.dev"},"ollama-cloud":{url:"https://ollama.com/v1",apiKeyEnvVar:"OLLAMA_API_KEY",apiKeyHeader:"Authorization",name:"Ollama Cloud",models:["cogito-2.1:671b-cloud","deepseek-v3.1:671b-cloud","gemini-3-pro-preview:latest","glm-4.6:cloud","glm-4.7:cloud","gpt-oss:120b-cloud","gpt-oss:20b-cloud","kimi-k2-thinking:cloud","kimi-k2:1t-cloud","minimax-m2:cloud","qwen3-coder:480b-cloud","qwen3-vl-235b-cloud","qwen3-vl-235b-instruct-cloud"],docUrl:"https://docs.ollama.com/cloud",gateway:"models.dev"},xiaomi:{url:"https://api.xiaomimimo.com/v1",apiKeyEnvVar:"XIAOMI_API_KEY",apiKeyHeader:"Authorization",name:"Xiaomi",models:["mimo-v2-flash"],docUrl:"https://platform.xiaomimimo.com/#/docs",gateway:"models.dev"},alibaba:{url:"https://dashscope-intl.aliyuncs.com/compatible-mode/v1",apiKeyEnvVar:"DASHSCOPE_API_KEY",apiKeyHeader:"Authorization",name:"Alibaba",models:["qvq-max","qwen-flash","qwen-max","qwen-mt-plus","qwen-mt-turbo","qwen-omni-turbo","qwen-omni-turbo-realtime","qwen-plus","qwen-plus-character-ja","qwen-turbo","qwen-vl-max","qwen-vl-ocr","qwen-vl-plus","qwen2-5-14b-instruct","qwen2-5-32b-instruct","qwen2-5-72b-instruct","qwen2-5-7b-instruct","qwen2-5-omni-7b","qwen2-5-vl-72b-instruct","qwen2-5-vl-7b-instruct","qwen3-14b","qwen3-235b-a22b","qwen3-32b","qwen3-8b","qwen3-asr-flash","qwen3-coder-30b-a3b-instruct","qwen3-coder-480b-a35b-instruct","qwen3-coder-flash","qwen3-coder-plus","qwen3-livetranslate-flash-realtime","qwen3-max","qwen3-next-80b-a3b-instruct","qwen3-next-80b-a3b-thinking","qwen3-omni-flash","qwen3-omni-flash-realtime","qwen3-vl-235b-a22b","qwen3-vl-30b-a3b","qwen3-vl-plus","qwq-plus"],docUrl:"https://www.alibabacloud.com/help/en/model-studio/models",gateway:"models.dev"},xai:{apiKeyEnvVar:"XAI_API_KEY",name:"xAI",models:["grok-2","grok-2-1212","grok-2-latest","grok-2-vision","grok-2-vision-1212","grok-2-vision-latest","grok-3","grok-3-fast","grok-3-fast-latest","grok-3-latest","grok-3-mini","grok-3-mini-fast","grok-3-mini-fast-latest","grok-3-mini-latest","grok-4","grok-4-1-fast","grok-4-1-fast-non-reasoning","grok-4-fast","grok-4-fast-non-reasoning","grok-beta","grok-code-fast-1","grok-vision-beta"],docUrl:"https://docs.x.ai/docs/models",gateway:"models.dev"},vultr:{url:"https://api.vultrinference.com/v1",apiKeyEnvVar:"VULTR_API_KEY",apiKeyHeader:"Authorization",name:"Vultr",models:["deepseek-r1-distill-llama-70b","deepseek-r1-distill-qwen-32b","gpt-oss-120b","kimi-k2-instruct","qwen2.5-coder-32b-instruct"],docUrl:"https://api.vultrinference.com/",gateway:"models.dev"},nvidia:{url:"https://integrate.api.nvidia.com/v1",apiKeyEnvVar:"NVIDIA_API_KEY",apiKeyHeader:"Authorization",name:"Nvidia",models:["black-forest-labs/flux.1-dev","deepseek-ai/deepseek-coder-6.7b-instruct","deepseek-ai/deepseek-r1","deepseek-ai/deepseek-r1-0528","deepseek-ai/deepseek-v3.1","deepseek-ai/deepseek-v3.1-terminus","google/codegemma-1.1-7b","google/codegemma-7b","google/gemma-2-27b-it","google/gemma-2-2b-it","google/gemma-3-12b-it","google/gemma-3-1b-it","google/gemma-3-27b-it","google/gemma-3n-e2b-it","google/gemma-3n-e4b-it","meta/codellama-70b","meta/llama-3.1-405b-instruct","meta/llama-3.1-70b-instruct","meta/llama-3.2-11b-vision-instruct","meta/llama-3.2-1b-instruct","meta/llama-3.3-70b-instruct","meta/llama-4-maverick-17b-128e-instruct","meta/llama-4-scout-17b-16e-instruct","meta/llama3-70b-instruct","meta/llama3-8b-instruct","microsoft/phi-3-medium-128k-instruct","microsoft/phi-3-medium-4k-instruct","microsoft/phi-3-small-128k-instruct","microsoft/phi-3-small-8k-instruct","microsoft/phi-3-vision-128k-instruct","microsoft/phi-3.5-moe-instruct","microsoft/phi-3.5-vision-instruct","microsoft/phi-4-mini-instruct","minimaxai/minimax-m2","mistralai/codestral-22b-instruct-v0.1","mistralai/devstral-2-123b-instruct-2512","mistralai/mamba-codestral-7b-v0.1","mistralai/ministral-14b-instruct-2512","mistralai/mistral-large-2-instruct","mistralai/mistral-large-3-675b-instruct-2512","mistralai/mistral-small-3.1-24b-instruct-2503","moonshotai/kimi-k2-instruct","moonshotai/kimi-k2-instruct-0905","moonshotai/kimi-k2-thinking","nvidia/cosmos-nemotron-34b","nvidia/llama-3.1-nemotron-51b-instruct","nvidia/llama-3.1-nemotron-70b-instruct","nvidia/llama-3.1-nemotron-ultra-253b-v1","nvidia/llama-3.3-nemotron-super-49b-v1","nvidia/llama-3.3-nemotron-super-49b-v1.5","nvidia/llama-embed-nemotron-8b","nvidia/llama3-chatqa-1.5-70b","nvidia/nemoretriever-ocr-v1","nvidia/nemotron-3-nano-30b-a3b","nvidia/nemotron-4-340b-instruct","nvidia/nvidia-nemotron-nano-9b-v2","nvidia/parakeet-tdt-0.6b-v2","openai/gpt-oss-120b","openai/whisper-large-v3","qwen/qwen2.5-coder-32b-instruct","qwen/qwen2.5-coder-7b-instruct","qwen/qwen3-235b-a22b","qwen/qwen3-coder-480b-a35b-instruct","qwen/qwen3-next-80b-a3b-instruct","qwen/qwen3-next-80b-a3b-thinking","qwen/qwq-32b"],docUrl:"https://docs.api.nvidia.com/nim/",gateway:"models.dev"},upstage:{url:"https://api.upstage.ai/v1/solar",apiKeyEnvVar:"UPSTAGE_API_KEY",apiKeyHeader:"Authorization",name:"Upstage",models:["solar-mini","solar-pro2","solar-pro3"],docUrl:"https://developers.upstage.ai/docs/apis/chat",gateway:"models.dev"},groq:{url:"https://api.groq.com/openai/v1",apiKeyEnvVar:"GROQ_API_KEY",apiKeyHeader:"Authorization",name:"Groq",models:["llama-3.1-8b-instant","llama-3.3-70b-versatile","meta-llama/llama-4-maverick-17b-128e-instruct","meta-llama/llama-4-scout-17b-16e-instruct","meta-llama/llama-guard-4-12b","moonshotai/kimi-k2-instruct-0905","openai/gpt-oss-120b","openai/gpt-oss-20b","qwen/qwen3-32b"],docUrl:"https://console.groq.com/docs/models",gateway:"models.dev"},bailing:{url:"https://api.tbox.cn/api/llm/v1/chat/completions",apiKeyEnvVar:"BAILING_API_TOKEN",apiKeyHeader:"Authorization",name:"Bailing",models:["Ling-1T","Ring-1T"],docUrl:"https://alipaytbox.yuque.com/sxs0ba/ling/intro",gateway:"models.dev"},mistral:{url:"https://api.mistral.ai/v1",apiKeyEnvVar:"MISTRAL_API_KEY",name:"Mistral",models:["codestral-latest","devstral-2512","devstral-medium-2507","devstral-medium-latest","devstral-small-2505","devstral-small-2507","labs-devstral-small-2512","magistral-medium-latest","magistral-small","ministral-3b-latest","ministral-8b-latest","mistral-embed","mistral-large-2411","mistral-large-2512","mistral-large-latest","mistral-medium-2505","mistral-medium-2508","mistral-medium-latest","mistral-nemo","mistral-small-2506","mistral-small-latest","open-mistral-7b","open-mixtral-8x22b","open-mixtral-8x7b","pixtral-12b","pixtral-large-latest"],docUrl:"https://docs.mistral.ai/getting-started/models/",gateway:"models.dev"},abacus:{url:"https://routellm.abacus.ai/v1",apiKeyEnvVar:"ABACUS_API_KEY",apiKeyHeader:"Authorization",name:"Abacus",models:["Qwen/QwQ-32B","Qwen/Qwen2.5-72B-Instruct","Qwen/Qwen3-235B-A22B-Instruct-2507","Qwen/Qwen3-32B","Qwen/qwen3-coder-480b-a35b-instruct","claude-3-7-sonnet-20250219","claude-haiku-4-5-20251001","claude-opus-4-1-20250805","claude-opus-4-20250514","claude-opus-4-5-20251101","claude-sonnet-4-20250514","claude-sonnet-4-5-20250929","deepseek-ai/DeepSeek-R1","deepseek-ai/DeepSeek-V3.1-Terminus","deepseek-ai/DeepSeek-V3.2","deepseek/deepseek-v3.1","gemini-2.0-flash-001","gemini-2.0-pro-exp-02-05","gemini-2.5-flash","gemini-2.5-pro","gemini-3-flash-preview","gemini-3-pro-preview","gpt-4.1","gpt-4.1-mini","gpt-4.1-nano","gpt-4o-2024-11-20","gpt-4o-mini","gpt-5","gpt-5-mini","gpt-5-nano","gpt-5.1","gpt-5.1-chat-latest","gpt-5.2","gpt-5.2-chat-latest","grok-4-0709","grok-4-1-fast-non-reasoning","grok-4-fast-non-reasoning","grok-code-fast-1","kimi-k2-turbo-preview","llama-3.3-70b-versatile","meta-llama/Llama-4-Maverick-17B-128E-Instruct-FP8","meta-llama/Meta-Llama-3.1-405B-Instruct-Turbo","meta-llama/Meta-Llama-3.1-70B-Instruct","meta-llama/Meta-Llama-3.1-8B-Instruct","o3","o3-mini","o3-pro","o4-mini","openai/gpt-oss-120b","qwen-2.5-coder-32b","qwen3-max","route-llm","zai-org/glm-4.5","zai-org/glm-4.6","zai-org/glm-4.7"],docUrl:"https://abacus.ai/help/api",gateway:"models.dev"},vercel:{url:"https://ai-gateway.vercel.sh/v1",apiKeyEnvVar:"AI_GATEWAY_API_KEY",apiKeyHeader:"Authorization",name:"Vercel AI Gateway",models:["alibaba/qwen-3-14b","alibaba/qwen-3-235b","alibaba/qwen-3-30b","alibaba/qwen-3-32b","alibaba/qwen3-235b-a22b-thinking","alibaba/qwen3-coder","alibaba/qwen3-coder-30b-a3b","alibaba/qwen3-coder-plus","alibaba/qwen3-embedding-0.6b","alibaba/qwen3-embedding-4b","alibaba/qwen3-embedding-8b","alibaba/qwen3-max","alibaba/qwen3-max-preview","alibaba/qwen3-next-80b-a3b-instruct","alibaba/qwen3-next-80b-a3b-thinking","alibaba/qwen3-vl-instruct","alibaba/qwen3-vl-thinking","amazon/nova-2-lite","amazon/nova-lite","amazon/nova-micro","amazon/nova-pro","amazon/titan-embed-text-v2","anthropic/claude-3-haiku","anthropic/claude-3-opus","anthropic/claude-3.5-haiku","anthropic/claude-3.5-sonnet","anthropic/claude-3.5-sonnet-20240620","anthropic/claude-3.7-sonnet","anthropic/claude-haiku-4.5","anthropic/claude-opus-4","anthropic/claude-opus-4.1","anthropic/claude-opus-4.5","anthropic/claude-sonnet-4","anthropic/claude-sonnet-4.5","arcee-ai/trinity-mini","bfl/flux-kontext-max","bfl/flux-kontext-pro","bfl/flux-pro-1.0-fill","bfl/flux-pro-1.1","bfl/flux-pro-1.1-ultra","bytedance/seed-1.6","bytedance/seed-1.8","cohere/command-a","cohere/embed-v4.0","deepseek/deepseek-r1","deepseek/deepseek-v3","deepseek/deepseek-v3.1","deepseek/deepseek-v3.1-terminus","deepseek/deepseek-v3.2","deepseek/deepseek-v3.2-exp","deepseek/deepseek-v3.2-thinking","google/gemini-2.0-flash","google/gemini-2.0-flash-lite","google/gemini-2.5-flash","google/gemini-2.5-flash-image","google/gemini-2.5-flash-image-preview","google/gemini-2.5-flash-lite","google/gemini-2.5-flash-lite-preview-09-2025","google/gemini-2.5-flash-preview-09-2025","google/gemini-2.5-pro","google/gemini-3-flash","google/gemini-3-pro-image","google/gemini-3-pro-preview","google/gemini-embedding-001","google/imagen-4.0-fast-generate-001","google/imagen-4.0-generate-001","google/imagen-4.0-ultra-generate-001","google/text-embedding-005","google/text-multilingual-embedding-002","inception/mercury-coder-small","kwaipilot/kat-coder-pro-v1","meituan/longcat-flash-chat","meituan/longcat-flash-thinking","meta/llama-3.1-70b","meta/llama-3.1-8b","meta/llama-3.2-11b","meta/llama-3.2-1b","meta/llama-3.2-3b","meta/llama-3.2-90b","meta/llama-3.3-70b","meta/llama-4-maverick","meta/llama-4-scout","minimax/minimax-m2","minimax/minimax-m2.1","minimax/minimax-m2.1-lightning","mistral/codestral","mistral/codestral-embed","mistral/devstral-2","mistral/devstral-small","mistral/devstral-small-2","mistral/magistral-medium","mistral/magistral-small","mistral/ministral-14b","mistral/ministral-3b","mistral/ministral-8b","mistral/mistral-embed","mistral/mistral-large-3","mistral/mistral-medium","mistral/mistral-nemo","mistral/mistral-small","mistral/mixtral-8x22b-instruct","mistral/pixtral-12b","mistral/pixtral-large","moonshotai/kimi-k2-0905","moonshotai/kimi-k2-thinking","moonshotai/kimi-k2-thinking-turbo","moonshotai/kimi-k2-turbo","morph/morph-v3-fast","morph/morph-v3-large","nvidia/nemotron-3-nano-30b-a3b","nvidia/nemotron-nano-12b-v2-vl","nvidia/nemotron-nano-9b-v2","openai/codex-mini","openai/gpt-3.5-turbo","openai/gpt-3.5-turbo-instruct","openai/gpt-4-turbo","openai/gpt-4.1","openai/gpt-4.1-mini","openai/gpt-4.1-nano","openai/gpt-4o","openai/gpt-4o-mini","openai/gpt-5","openai/gpt-5-chat","openai/gpt-5-codex","openai/gpt-5-mini","openai/gpt-5-nano","openai/gpt-5-pro","openai/gpt-5.1-codex","openai/gpt-5.1-codex-max","openai/gpt-5.1-codex-mini","openai/gpt-5.1-instant","openai/gpt-5.1-thinking","openai/gpt-5.2","openai/gpt-5.2-chat","openai/gpt-5.2-codex","openai/gpt-5.2-pro","openai/gpt-oss-120b","openai/gpt-oss-20b","openai/gpt-oss-safeguard-20b","openai/o1","openai/o3","openai/o3-deep-research","openai/o3-mini","openai/o3-pro","openai/o4-mini","openai/text-embedding-3-large","openai/text-embedding-3-small","openai/text-embedding-ada-002","perplexity/sonar","perplexity/sonar-pro","perplexity/sonar-reasoning","perplexity/sonar-reasoning-pro","prime-intellect/intellect-3","recraft/recraft-v2","recraft/recraft-v3","vercel/v0-1.0-md","vercel/v0-1.5-md","voyage/voyage-3-large","voyage/voyage-3.5","voyage/voyage-3.5-lite","voyage/voyage-code-2","voyage/voyage-code-3","voyage/voyage-finance-2","voyage/voyage-law-2","xai/grok-2-vision","xai/grok-3","xai/grok-3-fast","xai/grok-3-mini","xai/grok-3-mini-fast","xai/grok-4","xai/grok-4-fast-non-reasoning","xai/grok-4-fast-reasoning","xai/grok-4.1-fast-non-reasoning","xai/grok-4.1-fast-reasoning","xai/grok-code-fast-1","xiaomi/mimo-v2-flash","zai/glm-4.5","zai/glm-4.5-air","zai/glm-4.5v","zai/glm-4.6","zai/glm-4.6v","zai/glm-4.6v-flash","zai/glm-4.7"],docUrl:"https://github.com/vercel/ai/tree/5eb85cc45a259553501f535b8ac79a77d0e79223/packages/gateway",gateway:"models.dev"},nebius:{url:"https://api.tokenfactory.nebius.com/v1",apiKeyEnvVar:"NEBIUS_API_KEY",apiKeyHeader:"Authorization",name:"Nebius Token Factory",models:["NousResearch/hermes-4-405b","NousResearch/hermes-4-70b","deepseek-ai/deepseek-v3","meta-llama/llama-3.3-70b-instruct-base","meta-llama/llama-3.3-70b-instruct-fast","meta-llama/llama-3_1-405b-instruct","moonshotai/kimi-k2-instruct","nvidia/llama-3_1-nemotron-ultra-253b-v1","openai/gpt-oss-120b","openai/gpt-oss-20b","qwen/qwen3-235b-a22b-instruct-2507","qwen/qwen3-235b-a22b-thinking-2507","qwen/qwen3-coder-480b-a35b-instruct","zai-org/glm-4.5","zai-org/glm-4.5-air"],docUrl:"https://docs.tokenfactory.nebius.com/",gateway:"models.dev"},deepseek:{url:"https://api.deepseek.com",apiKeyEnvVar:"DEEPSEEK_API_KEY",name:"DeepSeek",models:["deepseek-chat","deepseek-reasoner"],docUrl:"https://platform.deepseek.com/api-docs/pricing",gateway:"models.dev"},"alibaba-cn":{url:"https://dashscope.aliyuncs.com/compatible-mode/v1",apiKeyEnvVar:"DASHSCOPE_API_KEY",apiKeyHeader:"Authorization",name:"Alibaba (China)",models:["deepseek-r1","deepseek-r1-0528","deepseek-r1-distill-llama-70b","deepseek-r1-distill-llama-8b","deepseek-r1-distill-qwen-1-5b","deepseek-r1-distill-qwen-14b","deepseek-r1-distill-qwen-32b","deepseek-r1-distill-qwen-7b","deepseek-v3","deepseek-v3-1","deepseek-v3-2-exp","moonshot-kimi-k2-instruct","qvq-max","qwen-deep-research","qwen-doc-turbo","qwen-flash","qwen-long","qwen-math-plus","qwen-math-turbo","qwen-max","qwen-mt-plus","qwen-mt-turbo","qwen-omni-turbo","qwen-omni-turbo-realtime","qwen-plus","qwen-plus-character","qwen-turbo","qwen-vl-max","qwen-vl-ocr","qwen-vl-plus","qwen2-5-14b-instruct","qwen2-5-32b-instruct","qwen2-5-72b-instruct","qwen2-5-7b-instruct","qwen2-5-coder-32b-instruct","qwen2-5-coder-7b-instruct","qwen2-5-math-72b-instruct","qwen2-5-math-7b-instruct","qwen2-5-omni-7b","qwen2-5-vl-72b-instruct","qwen2-5-vl-7b-instruct","qwen3-14b","qwen3-235b-a22b","qwen3-32b","qwen3-8b","qwen3-asr-flash","qwen3-coder-30b-a3b-instruct","qwen3-coder-480b-a35b-instruct","qwen3-coder-flash","qwen3-coder-plus","qwen3-max","qwen3-next-80b-a3b-instruct","qwen3-next-80b-a3b-thinking","qwen3-omni-flash","qwen3-omni-flash-realtime","qwen3-vl-235b-a22b","qwen3-vl-30b-a3b","qwen3-vl-plus","qwq-32b","qwq-plus","tongyi-intent-detect-v3"],docUrl:"https://www.alibabacloud.com/help/en/model-studio/models",gateway:"models.dev"},"novita-ai":{url:"https://api.novita.ai/openai",apiKeyEnvVar:"NOVITA_API_KEY",apiKeyHeader:"Authorization",name:"NovitaAI",models:["baichuan/baichuan-m2-32b","baidu/ernie-4.5-21B-a3b","baidu/ernie-4.5-21B-a3b-thinking","baidu/ernie-4.5-300b-a47b-paddle","baidu/ernie-4.5-vl-28b-a3b","baidu/ernie-4.5-vl-28b-a3b-thinking","baidu/ernie-4.5-vl-424b-a47b","deepseek/deepseek-ocr","deepseek/deepseek-prover-v2-671b","deepseek/deepseek-r1-0528","deepseek/deepseek-r1-0528-qwen3-8b","deepseek/deepseek-r1-distill-llama-70b","deepseek/deepseek-r1-turbo","deepseek/deepseek-v3-0324","deepseek/deepseek-v3-turbo","deepseek/deepseek-v3.1","deepseek/deepseek-v3.1-terminus","deepseek/deepseek-v3.2","deepseek/deepseek-v3.2-exp","google/gemma-3-27b-it","gryphe/mythomax-l2-13b","kwaipilot/kat-coder","kwaipilot/kat-coder-pro","meta-llama/llama-3-70b-instruct","meta-llama/llama-3-8b-instruct","meta-llama/llama-3.1-8b-instruct","meta-llama/llama-3.3-70b-instruct","meta-llama/llama-4-maverick-17b-128e-instruct-fp8","meta-llama/llama-4-scout-17b-16e-instruct","microsoft/wizardlm-2-8x22b","minimax/minimax-m2","minimax/minimax-m2.1","minimaxai/minimax-m1-80k","mistralai/mistral-nemo","moonshotai/kimi-k2-0905","moonshotai/kimi-k2-instruct","moonshotai/kimi-k2-thinking","nousresearch/hermes-2-pro-llama-3-8b","openai/gpt-oss-120b","openai/gpt-oss-20b","paddlepaddle/paddleocr-vl","qwen/qwen-2.5-72b-instruct","qwen/qwen-mt-plus","qwen/qwen2.5-7b-instruct","qwen/qwen2.5-vl-72b-instruct","qwen/qwen3-235b-a22b-fp8","qwen/qwen3-235b-a22b-instruct-2507","qwen/qwen3-235b-a22b-thinking-2507","qwen/qwen3-30b-a3b-fp8","qwen/qwen3-32b-fp8","qwen/qwen3-4b-fp8","qwen/qwen3-8b-fp8","qwen/qwen3-coder-30b-a3b-instruct","qwen/qwen3-coder-480b-a35b-instruct","qwen/qwen3-max","qwen/qwen3-next-80b-a3b-instruct","qwen/qwen3-next-80b-a3b-thinking","qwen/qwen3-omni-30b-a3b-instruct","qwen/qwen3-omni-30b-a3b-thinking","qwen/qwen3-vl-235b-a22b-instruct","qwen/qwen3-vl-235b-a22b-thinking","qwen/qwen3-vl-30b-a3b-instruct","qwen/qwen3-vl-30b-a3b-thinking","qwen/qwen3-vl-8b-instruct","sao10k/L3-8B-Stheno-v3.2","sao10k/l3-70b-euryale-v2.1","sao10k/l3-8b-lunaris","sao10k/l31-70b-euryale-v2.2","skywork/r1v4-lite","xiaomimimo/mimo-v2-flash","zai-org/autoglm-phone-9b-multilingual","zai-org/glm-4.5","zai-org/glm-4.5-air","zai-org/glm-4.5v","zai-org/glm-4.6","zai-org/glm-4.6v","zai-org/glm-4.7"],docUrl:"https://novita.ai/docs/guides/introduction",gateway:"models.dev"},venice:{url:"https://api.venice.ai/api/v1",apiKeyEnvVar:"VENICE_API_KEY",apiKeyHeader:"Authorization",name:"Venice AI",models:["claude-opus-45","claude-sonnet-45","deepseek-v3.2","gemini-3-flash-preview","gemini-3-pro-preview","google-gemma-3-27b-it","grok-41-fast","grok-code-fast-1","hermes-3-llama-3.1-405b","kimi-k2-thinking","llama-3.2-3b","llama-3.3-70b","minimax-m21","mistral-31-24b","openai-gpt-52","openai-gpt-52-codex","openai-gpt-oss-120b","qwen3-235b-a22b-instruct-2507","qwen3-235b-a22b-thinking-2507","qwen3-4b","qwen3-coder-480b-a35b-instruct","qwen3-next-80b","qwen3-vl-235b-a22b","venice-uncensored","zai-org-glm-4.7"],docUrl:"https://docs.venice.ai",gateway:"models.dev"},"siliconflow-cn":{url:"https://api.siliconflow.cn/v1",apiKeyEnvVar:"SILICONFLOW_CN_API_KEY",apiKeyHeader:"Authorization",name:"SiliconFlow (China)",models:["ByteDance-Seed/Seed-OSS-36B-Instruct","Kwaipilot/KAT-Dev","MiniMaxAI/MiniMax-M1-80k","MiniMaxAI/MiniMax-M2","Qwen/QwQ-32B","Qwen/Qwen2.5-14B-Instruct","Qwen/Qwen2.5-32B-Instruct","Qwen/Qwen2.5-72B-Instruct","Qwen/Qwen2.5-72B-Instruct-128K","Qwen/Qwen2.5-7B-Instruct","Qwen/Qwen2.5-Coder-32B-Instruct","Qwen/Qwen2.5-VL-32B-Instruct","Qwen/Qwen2.5-VL-72B-Instruct","Qwen/Qwen2.5-VL-7B-Instruct","Qwen/Qwen3-14B","Qwen/Qwen3-235B-A22B","Qwen/Qwen3-235B-A22B-Instruct-2507","Qwen/Qwen3-235B-A22B-Thinking-2507","Qwen/Qwen3-30B-A3B","Qwen/Qwen3-30B-A3B-Instruct-2507","Qwen/Qwen3-30B-A3B-Thinking-2507","Qwen/Qwen3-32B","Qwen/Qwen3-8B","Qwen/Qwen3-Coder-30B-A3B-Instruct","Qwen/Qwen3-Coder-480B-A35B-Instruct","Qwen/Qwen3-Next-80B-A3B-Instruct","Qwen/Qwen3-Next-80B-A3B-Thinking","Qwen/Qwen3-Omni-30B-A3B-Captioner","Qwen/Qwen3-Omni-30B-A3B-Instruct","Qwen/Qwen3-Omni-30B-A3B-Thinking","Qwen/Qwen3-VL-235B-A22B-Instruct","Qwen/Qwen3-VL-235B-A22B-Thinking","Qwen/Qwen3-VL-30B-A3B-Instruct","Qwen/Qwen3-VL-30B-A3B-Thinking","Qwen/Qwen3-VL-32B-Instruct","Qwen/Qwen3-VL-32B-Thinking","Qwen/Qwen3-VL-8B-Instruct","Qwen/Qwen3-VL-8B-Thinking","THUDM/GLM-4-32B-0414","THUDM/GLM-4-9B-0414","THUDM/GLM-4.1V-9B-Thinking","THUDM/GLM-Z1-32B-0414","THUDM/GLM-Z1-9B-0414","ascend-tribe/pangu-pro-moe","baidu/ERNIE-4.5-300B-A47B","deepseek-ai/DeepSeek-R1","deepseek-ai/DeepSeek-R1-Distill-Qwen-14B","deepseek-ai/DeepSeek-R1-Distill-Qwen-32B","deepseek-ai/DeepSeek-R1-Distill-Qwen-7B","deepseek-ai/DeepSeek-V3","deepseek-ai/DeepSeek-V3.1-Terminus","deepseek-ai/DeepSeek-V3.2","deepseek-ai/deepseek-vl2","inclusionAI/Ling-flash-2.0","inclusionAI/Ling-mini-2.0","inclusionAI/Ring-flash-2.0","moonshotai/Kimi-Dev-72B","moonshotai/Kimi-K2-Instruct","moonshotai/Kimi-K2-Instruct-0905","moonshotai/Kimi-K2-Thinking","nex-agi/DeepSeek-V3.1-Nex-N1","openai/gpt-oss-120b","openai/gpt-oss-20b","stepfun-ai/step3","tencent/Hunyuan-A13B-Instruct","tencent/Hunyuan-MT-7B","zai-org/GLM-4.5","zai-org/GLM-4.5-Air","zai-org/GLM-4.5V","zai-org/GLM-4.6","zai-org/GLM-4.6V"],docUrl:"https://cloud.siliconflow.com/models",gateway:"models.dev"},vivgrid:{url:"https://api.vivgrid.com/v1",apiKeyEnvVar:"VIVGRID_API_KEY",apiKeyHeader:"Authorization",name:"Vivgrid",models:["gpt-5.1-codex"],docUrl:"https://docs.vivgrid.com/models",gateway:"models.dev"},chutes:{url:"https://llm.chutes.ai/v1",apiKeyEnvVar:"CHUTES_API_KEY",apiKeyHeader:"Authorization",name:"Chutes",models:["MiniMaxAI/MiniMax-M2.1-TEE","NousResearch/DeepHermes-3-Mistral-24B-Preview","NousResearch/Hermes-4-14B","NousResearch/Hermes-4-405B-FP8-TEE","NousResearch/Hermes-4-70B","NousResearch/Hermes-4.3-36B","OpenGVLab/InternVL3-78B-TEE","Qwen/Qwen2.5-72B-Instruct","Qwen/Qwen2.5-Coder-32B-Instruct","Qwen/Qwen2.5-VL-32B-Instruct","Qwen/Qwen2.5-VL-72B-Instruct-TEE","Qwen/Qwen3-14B","Qwen/Qwen3-235B-A22B","Qwen/Qwen3-235B-A22B-Instruct-2507-TEE","Qwen/Qwen3-235B-A22B-Thinking-2507","Qwen/Qwen3-30B-A3B","Qwen/Qwen3-30B-A3B-Instruct-2507","Qwen/Qwen3-32B","Qwen/Qwen3-Coder-480B-A35B-Instruct-FP8-TEE","Qwen/Qwen3-Next-80B-A3B-Instruct","Qwen/Qwen3-VL-235B-A22B-Instruct","Qwen/Qwen3Guard-Gen-0.6B","XiaomiMiMo/MiMo-V2-Flash","chutesai/Mistral-Small-3.1-24B-Instruct-2503","chutesai/Mistral-Small-3.2-24B-Instruct-2506","deepseek-ai/DeepSeek-R1-0528-TEE","deepseek-ai/DeepSeek-R1-Distill-Llama-70B","deepseek-ai/DeepSeek-R1-TEE","deepseek-ai/DeepSeek-V3","deepseek-ai/DeepSeek-V3-0324-TEE","deepseek-ai/DeepSeek-V3.1-TEE","deepseek-ai/DeepSeek-V3.1-Terminus-TEE","deepseek-ai/DeepSeek-V3.2-Speciale-TEE","deepseek-ai/DeepSeek-V3.2-TEE","miromind-ai/MiroThinker-v1.5-235B","mistralai/Devstral-2-123B-Instruct-2512","mistralai/Devstral-2-123B-Instruct-2512-TEE","moonshotai/Kimi-K2-Instruct-0905","moonshotai/Kimi-K2-Thinking-TEE","nvidia/NVIDIA-Nemotron-3-Nano-30B-A3B-BF16","openai/gpt-oss-120b-TEE","openai/gpt-oss-20b","rednote-hilab/dots.ocr","tngtech/DeepSeek-R1T-Chimera","tngtech/DeepSeek-TNG-R1T2-Chimera","tngtech/TNG-R1T-Chimera-TEE","unsloth/Mistral-Nemo-Instruct-2407","unsloth/Mistral-Small-24B-Instruct-2501","unsloth/gemma-3-12b-it","unsloth/gemma-3-27b-it","unsloth/gemma-3-4b-it","zai-org/GLM-4.5-Air","zai-org/GLM-4.5-TEE","zai-org/GLM-4.6-TEE","zai-org/GLM-4.6V","zai-org/GLM-4.7-TEE"],docUrl:"https://llm.chutes.ai/v1/models",gateway:"models.dev"},"kimi-for-coding":{url:"https://api.kimi.com/coding/v1",apiKeyEnvVar:"KIMI_API_KEY",apiKeyHeader:"Authorization",name:"Kimi For Coding",models:["kimi-k2-thinking"],docUrl:"https://www.kimi.com/coding/docs/en/third-party-agents.html",gateway:"models.dev"},cortecs:{url:"https://api.cortecs.ai/v1",apiKeyEnvVar:"CORTECS_API_KEY",apiKeyHeader:"Authorization",name:"Cortecs",models:["claude-4-5-sonnet","claude-sonnet-4","deepseek-v3-0324","devstral-2512","devstral-small-2512","gemini-2.5-pro","gpt-4.1","gpt-oss-120b","intellect-3","kimi-k2-instruct","kimi-k2-thinking","llama-3.1-405b-instruct","nova-pro-v1","qwen3-32b","qwen3-coder-480b-a35b-instruct","qwen3-next-80b-a3b-thinking"],docUrl:"https://api.cortecs.ai/v1/models",gateway:"models.dev"},"github-models":{url:"https://models.github.ai/inference",apiKeyEnvVar:"GITHUB_TOKEN",apiKeyHeader:"Authorization",name:"GitHub Models",models:["ai21-labs/ai21-jamba-1.5-large","ai21-labs/ai21-jamba-1.5-mini","cohere/cohere-command-a","cohere/cohere-command-r","cohere/cohere-command-r-08-2024","cohere/cohere-command-r-plus","cohere/cohere-command-r-plus-08-2024","core42/jais-30b-chat","deepseek/deepseek-r1","deepseek/deepseek-r1-0528","deepseek/deepseek-v3-0324","meta/llama-3.2-11b-vision-instruct","meta/llama-3.2-90b-vision-instruct","meta/llama-3.3-70b-instruct","meta/llama-4-maverick-17b-128e-instruct-fp8","meta/llama-4-scout-17b-16e-instruct","meta/meta-llama-3-70b-instruct","meta/meta-llama-3-8b-instruct","meta/meta-llama-3.1-405b-instruct","meta/meta-llama-3.1-70b-instruct","meta/meta-llama-3.1-8b-instruct","microsoft/mai-ds-r1","microsoft/phi-3-medium-128k-instruct","microsoft/phi-3-medium-4k-instruct","microsoft/phi-3-mini-128k-instruct","microsoft/phi-3-mini-4k-instruct","microsoft/phi-3-small-128k-instruct","microsoft/phi-3-small-8k-instruct","microsoft/phi-3.5-mini-instruct","microsoft/phi-3.5-moe-instruct","microsoft/phi-3.5-vision-instruct","microsoft/phi-4","microsoft/phi-4-mini-instruct","microsoft/phi-4-mini-reasoning","microsoft/phi-4-multimodal-instruct","microsoft/phi-4-reasoning","mistral-ai/codestral-2501","mistral-ai/ministral-3b","mistral-ai/mistral-large-2411","mistral-ai/mistral-medium-2505","mistral-ai/mistral-nemo","mistral-ai/mistral-small-2503","openai/gpt-4.1","openai/gpt-4.1-mini","openai/gpt-4.1-nano","openai/gpt-4o","openai/gpt-4o-mini","openai/o1","openai/o1-mini","openai/o1-preview","openai/o3","openai/o3-mini","openai/o4-mini","xai/grok-3","xai/grok-3-mini"],docUrl:"https://docs.github.com/en/github-models",gateway:"models.dev"},togetherai:{url:"https://api.together.xyz/v1",apiKeyEnvVar:"TOGETHER_API_KEY",apiKeyHeader:"Authorization",name:"Together AI",models:["Qwen/Qwen3-Coder-480B-A35B-Instruct-FP8","deepseek-ai/DeepSeek-R1","deepseek-ai/DeepSeek-V3","deepseek-ai/DeepSeek-V3-1","essentialai/Rnj-1-Instruct","meta-llama/Llama-3.3-70B-Instruct-Turbo","moonshotai/Kimi-K2-Instruct","moonshotai/Kimi-K2-Thinking","openai/gpt-oss-120b","zai-org/GLM-4.6"],docUrl:"https://docs.together.ai/docs/serverless-models",gateway:"models.dev"},baseten:{url:"https://inference.baseten.co/v1",apiKeyEnvVar:"BASETEN_API_KEY",apiKeyHeader:"Authorization",name:"Baseten",models:["Qwen/Qwen3-Coder-480B-A35B-Instruct","deepseek-ai/DeepSeek-V3.2","moonshotai/Kimi-K2-Instruct-0905","moonshotai/Kimi-K2-Thinking","zai-org/GLM-4.6","zai-org/GLM-4.7"],docUrl:"https://docs.baseten.co/development/model-apis/overview",gateway:"models.dev"},siliconflow:{url:"https://api.siliconflow.com/v1",apiKeyEnvVar:"SILICONFLOW_API_KEY",apiKeyHeader:"Authorization",name:"SiliconFlow",models:["ByteDance-Seed/Seed-OSS-36B-Instruct","MiniMaxAI/MiniMax-M1-80k","MiniMaxAI/MiniMax-M2","Qwen/QwQ-32B","Qwen/Qwen2.5-14B-Instruct","Qwen/Qwen2.5-32B-Instruct","Qwen/Qwen2.5-72B-Instruct","Qwen/Qwen2.5-72B-Instruct-128K","Qwen/Qwen2.5-7B-Instruct","Qwen/Qwen2.5-Coder-32B-Instruct","Qwen/Qwen2.5-VL-32B-Instruct","Qwen/Qwen2.5-VL-72B-Instruct","Qwen/Qwen2.5-VL-7B-Instruct","Qwen/Qwen3-14B","Qwen/Qwen3-235B-A22B","Qwen/Qwen3-235B-A22B-Instruct-2507","Qwen/Qwen3-235B-A22B-Thinking-2507","Qwen/Qwen3-30B-A3B","Qwen/Qwen3-30B-A3B-Instruct-2507","Qwen/Qwen3-30B-A3B-Thinking-2507","Qwen/Qwen3-32B","Qwen/Qwen3-8B","Qwen/Qwen3-Coder-30B-A3B-Instruct","Qwen/Qwen3-Coder-480B-A35B-Instruct","Qwen/Qwen3-Next-80B-A3B-Instruct","Qwen/Qwen3-Next-80B-A3B-Thinking","Qwen/Qwen3-Omni-30B-A3B-Captioner","Qwen/Qwen3-Omni-30B-A3B-Instruct","Qwen/Qwen3-Omni-30B-A3B-Thinking","Qwen/Qwen3-VL-235B-A22B-Instruct","Qwen/Qwen3-VL-235B-A22B-Thinking","Qwen/Qwen3-VL-30B-A3B-Instruct","Qwen/Qwen3-VL-30B-A3B-Thinking","Qwen/Qwen3-VL-32B-Instruct","Qwen/Qwen3-VL-32B-Thinking","Qwen/Qwen3-VL-8B-Instruct","Qwen/Qwen3-VL-8B-Thinking","THUDM/GLM-4-32B-0414","THUDM/GLM-4-9B-0414","THUDM/GLM-4.1V-9B-Thinking","THUDM/GLM-Z1-32B-0414","THUDM/GLM-Z1-9B-0414","baidu/ERNIE-4.5-300B-A47B","deepseek-ai/DeepSeek-R1","deepseek-ai/DeepSeek-R1-Distill-Qwen-14B","deepseek-ai/DeepSeek-R1-Distill-Qwen-32B","deepseek-ai/DeepSeek-R1-Distill-Qwen-7B","deepseek-ai/DeepSeek-V3","deepseek-ai/DeepSeek-V3.1","deepseek-ai/DeepSeek-V3.1-Terminus","deepseek-ai/DeepSeek-V3.2","deepseek-ai/DeepSeek-V3.2-Exp","deepseek-ai/deepseek-vl2","inclusionAI/Ling-flash-2.0","inclusionAI/Ling-mini-2.0","inclusionAI/Ring-flash-2.0","meta-llama/Meta-Llama-3.1-8B-Instruct","moonshotai/Kimi-Dev-72B","moonshotai/Kimi-K2-Instruct","moonshotai/Kimi-K2-Instruct-0905","moonshotai/Kimi-K2-Thinking","nex-agi/DeepSeek-V3.1-Nex-N1","openai/gpt-oss-120b","openai/gpt-oss-20b","stepfun-ai/step3","tencent/Hunyuan-A13B-Instruct","tencent/Hunyuan-MT-7B","zai-org/GLM-4.5","zai-org/GLM-4.5-Air","zai-org/GLM-4.5V","zai-org/GLM-4.6","zai-org/GLM-4.6V","zai-org/GLM-4.7"],docUrl:"https://cloud.siliconflow.com/models",gateway:"models.dev"},helicone:{url:"https://ai-gateway.helicone.ai/v1",apiKeyEnvVar:"HELICONE_API_KEY",apiKeyHeader:"Authorization",name:"Helicone",models:["chatgpt-4o-latest","claude-3-haiku-20240307","claude-3.5-haiku","claude-3.5-sonnet-v2","claude-3.7-sonnet","claude-4.5-haiku","claude-4.5-opus","claude-4.5-sonnet","claude-haiku-4-5-20251001","claude-opus-4","claude-opus-4-1","claude-opus-4-1-20250805","claude-sonnet-4","claude-sonnet-4-5-20250929","codex-mini-latest","deepseek-r1-distill-llama-70b","deepseek-reasoner","deepseek-tng-r1t2-chimera","deepseek-v3","deepseek-v3.1-terminus","deepseek-v3.2","ernie-4.5-21b-a3b-thinking","gemini-2.5-flash","gemini-2.5-flash-lite","gemini-2.5-pro","gemini-3-pro-preview","gemma-3-12b-it","gemma2-9b-it","glm-4.6","gpt-4.1","gpt-4.1-mini","gpt-4.1-mini-2025-04-14","gpt-4.1-nano","gpt-4o","gpt-4o-mini","gpt-5","gpt-5-chat-latest","gpt-5-codex","gpt-5-mini","gpt-5-nano","gpt-5-pro","gpt-5.1","gpt-5.1-chat-latest","gpt-5.1-codex","gpt-5.1-codex-mini","gpt-oss-120b","gpt-oss-20b","grok-3","grok-3-mini","grok-4","grok-4-1-fast-non-reasoning","grok-4-1-fast-reasoning","grok-4-fast-non-reasoning","grok-4-fast-reasoning","grok-code-fast-1","hermes-2-pro-llama-3-8b","kimi-k2-0711","kimi-k2-0905","kimi-k2-thinking","llama-3.1-8b-instant","llama-3.1-8b-instruct","llama-3.1-8b-instruct-turbo","llama-3.3-70b-instruct","llama-3.3-70b-versatile","llama-4-maverick","llama-4-scout","llama-guard-4","llama-prompt-guard-2-22m","llama-prompt-guard-2-86m","mistral-large-2411","mistral-nemo","mistral-small","o1","o1-mini","o3","o3-mini","o3-pro","o4-mini","qwen2.5-coder-7b-fast","qwen3-235b-a22b-thinking","qwen3-30b-a3b","qwen3-32b","qwen3-coder","qwen3-coder-30b-a3b-instruct","qwen3-next-80b-a3b-instruct","qwen3-vl-235b-a22b-instruct","sonar","sonar-deep-research","sonar-pro","sonar-reasoning","sonar-reasoning-pro"],docUrl:"https://helicone.ai/models",gateway:"models.dev"},huggingface:{url:"https://router.huggingface.co/v1",apiKeyEnvVar:"HF_TOKEN",apiKeyHeader:"Authorization",name:"Hugging Face",models:["MiniMaxAI/MiniMax-M2.1","Qwen/Qwen3-235B-A22B-Thinking-2507","Qwen/Qwen3-Coder-480B-A35B-Instruct","Qwen/Qwen3-Embedding-4B","Qwen/Qwen3-Embedding-8B","Qwen/Qwen3-Next-80B-A3B-Instruct","Qwen/Qwen3-Next-80B-A3B-Thinking","XiaomiMiMo/MiMo-V2-Flash","deepseek-ai/DeepSeek-R1-0528","deepseek-ai/DeepSeek-V3.2","moonshotai/Kimi-K2-Instruct","moonshotai/Kimi-K2-Instruct-0905","moonshotai/Kimi-K2-Thinking","zai-org/GLM-4.7","zai-org/GLM-4.7-Flash"],docUrl:"https://huggingface.co/docs/inference-providers",gateway:"models.dev"},opencode:{url:"https://opencode.ai/zen/v1",apiKeyEnvVar:"OPENCODE_API_KEY",apiKeyHeader:"Authorization",name:"OpenCode Zen",models:["alpha-gd4","alpha-glm-4.7","big-pickle","claude-3-5-haiku","claude-haiku-4-5","claude-opus-4-1","claude-opus-4-5","claude-sonnet-4","claude-sonnet-4-5","gemini-3-flash","gemini-3-pro","glm-4.6","glm-4.7-free","gpt-5","gpt-5-codex","gpt-5-nano","gpt-5.1","gpt-5.1-codex","gpt-5.1-codex-max","gpt-5.1-codex-mini","gpt-5.2","gpt-5.2-codex","grok-code","kimi-k2","kimi-k2-thinking","minimax-m2.1-free","qwen3-coder"],docUrl:"https://opencode.ai/docs/zen",gateway:"models.dev"},fastrouter:{url:"https://go.fastrouter.ai/api/v1",apiKeyEnvVar:"FASTROUTER_API_KEY",apiKeyHeader:"Authorization",name:"FastRouter",models:["anthropic/claude-opus-4.1","anthropic/claude-sonnet-4","deepseek-ai/deepseek-r1-distill-llama-70b","google/gemini-2.5-flash","google/gemini-2.5-pro","moonshotai/kimi-k2","openai/gpt-4.1","openai/gpt-5","openai/gpt-5-mini","openai/gpt-5-nano","openai/gpt-oss-120b","openai/gpt-oss-20b","qwen/qwen3-coder","x-ai/grok-4"],docUrl:"https://fastrouter.ai/models",gateway:"models.dev"},minimax:{url:"https://api.minimax.io/anthropic/v1",apiKeyEnvVar:"MINIMAX_API_KEY",apiKeyHeader:"Authorization",name:"MiniMax",models:["MiniMax-M2","MiniMax-M2.1"],docUrl:"https://platform.minimax.io/docs/guides/quickstart",gateway:"models.dev"},google:{apiKeyEnvVar:"GOOGLE_GENERATIVE_AI_API_KEY",name:"Google",models:["gemini-1.5-flash","gemini-1.5-flash-8b","gemini-1.5-pro","gemini-2.0-flash","gemini-2.0-flash-lite","gemini-2.5-flash","gemini-2.5-flash-image","gemini-2.5-flash-image-preview","gemini-2.5-flash-lite","gemini-2.5-flash-lite-preview-06-17","gemini-2.5-flash-lite-preview-09-2025","gemini-2.5-flash-preview-04-17","gemini-2.5-flash-preview-05-20","gemini-2.5-flash-preview-09-2025","gemini-2.5-flash-preview-tts","gemini-2.5-pro","gemini-2.5-pro-preview-05-06","gemini-2.5-pro-preview-06-05","gemini-2.5-pro-preview-tts","gemini-3-flash-preview","gemini-3-pro-preview","gemini-embedding-001","gemini-flash-latest","gemini-flash-lite-latest","gemini-live-2.5-flash","gemini-live-2.5-flash-preview-native-audio"],docUrl:"https://ai.google.dev/gemini-api/docs/pricing",gateway:"models.dev"},inception:{url:"https://api.inceptionlabs.ai/v1/",apiKeyEnvVar:"INCEPTION_API_KEY",apiKeyHeader:"Authorization",name:"Inception",models:["mercury","mercury-coder"],docUrl:"https://platform.inceptionlabs.ai/docs",gateway:"models.dev"},wandb:{url:"https://api.inference.wandb.ai/v1",apiKeyEnvVar:"WANDB_API_KEY",apiKeyHeader:"Authorization",name:"Weights & Biases",models:["Qwen/Qwen3-235B-A22B-Instruct-2507","Qwen/Qwen3-235B-A22B-Thinking-2507","Qwen/Qwen3-Coder-480B-A35B-Instruct","deepseek-ai/DeepSeek-R1-0528","deepseek-ai/DeepSeek-V3-0324","meta-llama/Llama-3.1-8B-Instruct","meta-llama/Llama-3.3-70B-Instruct","meta-llama/Llama-4-Scout-17B-16E-Instruct","microsoft/Phi-4-mini-instruct","moonshotai/Kimi-K2-Instruct"],docUrl:"https://weave-docs.wandb.ai/guides/integrations/inference/",gateway:"models.dev"},"cloudflare-ai-gateway":{url:"https://gateway.ai.cloudflare.com/v1/${CLOUDFLARE_ACCOUNT_ID}/${CLOUDFLARE_GATEWAY_ID}/compat/",apiKeyEnvVar:"CLOUDFLARE_API_TOKEN",apiKeyHeader:"Authorization",name:"Cloudflare AI Gateway",models:["anthropic/claude-3-5-haiku","anthropic/claude-3-haiku","anthropic/claude-3-opus","anthropic/claude-3-sonnet","anthropic/claude-3.5-haiku","anthropic/claude-3.5-sonnet","anthropic/claude-haiku-4-5","anthropic/claude-opus-4","anthropic/claude-opus-4-1","anthropic/claude-opus-4-5","anthropic/claude-sonnet-4","anthropic/claude-sonnet-4-5","openai/gpt-3.5-turbo","openai/gpt-4","openai/gpt-4-turbo","openai/gpt-4o","openai/gpt-4o-mini","openai/gpt-5.1","openai/gpt-5.1-codex","openai/gpt-5.2","openai/o1","openai/o3","openai/o3-mini","openai/o3-pro","openai/o4-mini","workers-ai/@cf/ai4bharat/indictrans2-en-indic-1B","workers-ai/@cf/aisingapore/gemma-sea-lion-v4-27b-it","workers-ai/@cf/baai/bge-base-en-v1.5","workers-ai/@cf/baai/bge-large-en-v1.5","workers-ai/@cf/baai/bge-m3","workers-ai/@cf/baai/bge-reranker-base","workers-ai/@cf/baai/bge-small-en-v1.5","workers-ai/@cf/deepgram/aura-2-en","workers-ai/@cf/deepgram/aura-2-es","workers-ai/@cf/deepgram/nova-3","workers-ai/@cf/deepseek-ai/deepseek-r1-distill-qwen-32b","workers-ai/@cf/facebook/bart-large-cnn","workers-ai/@cf/google/gemma-3-12b-it","workers-ai/@cf/huggingface/distilbert-sst-2-int8","workers-ai/@cf/ibm-granite/granite-4.0-h-micro","workers-ai/@cf/meta/llama-2-7b-chat-fp16","workers-ai/@cf/meta/llama-3-8b-instruct","workers-ai/@cf/meta/llama-3-8b-instruct-awq","workers-ai/@cf/meta/llama-3.1-8b-instruct","workers-ai/@cf/meta/llama-3.1-8b-instruct-awq","workers-ai/@cf/meta/llama-3.1-8b-instruct-fp8","workers-ai/@cf/meta/llama-3.2-11b-vision-instruct","workers-ai/@cf/meta/llama-3.2-1b-instruct","workers-ai/@cf/meta/llama-3.2-3b-instruct","workers-ai/@cf/meta/llama-3.3-70b-instruct-fp8-fast","workers-ai/@cf/meta/llama-4-scout-17b-16e-instruct","workers-ai/@cf/meta/llama-guard-3-8b","workers-ai/@cf/meta/m2m100-1.2b","workers-ai/@cf/mistral/mistral-7b-instruct-v0.1","workers-ai/@cf/mistralai/mistral-small-3.1-24b-instruct","workers-ai/@cf/myshell-ai/melotts","workers-ai/@cf/openai/gpt-oss-120b","workers-ai/@cf/openai/gpt-oss-20b","workers-ai/@cf/pfnet/plamo-embedding-1b","workers-ai/@cf/pipecat-ai/smart-turn-v2","workers-ai/@cf/qwen/qwen2.5-coder-32b-instruct","workers-ai/@cf/qwen/qwen3-30b-a3b-fp8","workers-ai/@cf/qwen/qwen3-embedding-0.6b","workers-ai/@cf/qwen/qwq-32b"],docUrl:"https://developers.cloudflare.com/ai-gateway/",gateway:"models.dev"},openai:{apiKeyEnvVar:"OPENAI_API_KEY",name:"OpenAI",models:["codex-mini-latest","gpt-3.5-turbo","gpt-4","gpt-4-turbo","gpt-4.1","gpt-4.1-mini","gpt-4.1-nano","gpt-4o","gpt-4o-2024-05-13","gpt-4o-2024-08-06","gpt-4o-2024-11-20","gpt-4o-mini","gpt-5","gpt-5-chat-latest","gpt-5-codex","gpt-5-mini","gpt-5-nano","gpt-5-pro","gpt-5.1","gpt-5.1-chat-latest","gpt-5.1-codex","gpt-5.1-codex-max","gpt-5.1-codex-mini","gpt-5.2","gpt-5.2-chat-latest","gpt-5.2-codex","gpt-5.2-pro","o1","o1-mini","o1-preview","o1-pro","o3","o3-deep-research","o3-mini","o3-pro","o4-mini","o4-mini-deep-research","text-embedding-3-large","text-embedding-3-small","text-embedding-ada-002"],docUrl:"https://platform.openai.com/docs/models",gateway:"models.dev"},"zhipuai-coding-plan":{url:"https://open.bigmodel.cn/api/coding/paas/v4",apiKeyEnvVar:"ZHIPU_API_KEY",apiKeyHeader:"Authorization",name:"Zhipu AI Coding Plan",models:["glm-4.5","glm-4.5-air","glm-4.5-flash","glm-4.5v","glm-4.6","glm-4.6v","glm-4.6v-flash","glm-4.7"],docUrl:"https://docs.bigmodel.cn/cn/coding-plan/overview",gateway:"models.dev"},"minimax-cn":{url:"https://api.minimaxi.com/anthropic/v1",apiKeyEnvVar:"MINIMAX_API_KEY",apiKeyHeader:"Authorization",name:"MiniMax (China)",models:["MiniMax-M2","MiniMax-M2.1"],docUrl:"https://platform.minimaxi.com/docs/guides/quickstart",gateway:"models.dev"},perplexity:{apiKeyEnvVar:"PERPLEXITY_API_KEY",name:"Perplexity",models:["sonar","sonar-pro","sonar-reasoning-pro"],docUrl:"https://docs.perplexity.ai",gateway:"models.dev"},openrouter:{url:"https://openrouter.ai/api/v1",apiKeyEnvVar:"OPENROUTER_API_KEY",name:"OpenRouter",models:["anthropic/claude-3.5-haiku","anthropic/claude-3.7-sonnet","anthropic/claude-haiku-4.5","anthropic/claude-opus-4","anthropic/claude-opus-4.1","anthropic/claude-opus-4.5","anthropic/claude-sonnet-4","anthropic/claude-sonnet-4.5","cognitivecomputations/dolphin3.0-mistral-24b","cognitivecomputations/dolphin3.0-r1-mistral-24b","deepseek/deepseek-chat-v3-0324","deepseek/deepseek-chat-v3.1","deepseek/deepseek-r1-0528-qwen3-8b:free","deepseek/deepseek-r1-0528:free","deepseek/deepseek-r1-distill-llama-70b","deepseek/deepseek-r1-distill-qwen-14b","deepseek/deepseek-r1:free","deepseek/deepseek-v3-base:free","deepseek/deepseek-v3.1-terminus","deepseek/deepseek-v3.1-terminus:exacto","deepseek/deepseek-v3.2","deepseek/deepseek-v3.2-speciale","featherless/qwerky-72b","google/gemini-2.0-flash-001","google/gemini-2.0-flash-exp:free","google/gemini-2.5-flash","google/gemini-2.5-flash-lite","google/gemini-2.5-flash-lite-preview-09-2025","google/gemini-2.5-flash-preview-09-2025","google/gemini-2.5-pro","google/gemini-2.5-pro-preview-05-06","google/gemini-2.5-pro-preview-06-05","google/gemini-3-flash-preview","google/gemini-3-pro-preview","google/gemma-2-9b-it:free","google/gemma-3-12b-it","google/gemma-3-27b-it","google/gemma-3n-e4b-it","google/gemma-3n-e4b-it:free","kwaipilot/kat-coder-pro:free","meta-llama/llama-3.2-11b-vision-instruct","meta-llama/llama-3.3-70b-instruct:free","meta-llama/llama-4-scout:free","microsoft/mai-ds-r1:free","minimax/minimax-01","minimax/minimax-m1","minimax/minimax-m2","minimax/minimax-m2.1","mistralai/codestral-2508","mistralai/devstral-2512","mistralai/devstral-2512:free","mistralai/devstral-medium-2507","mistralai/devstral-small-2505","mistralai/devstral-small-2505:free","mistralai/devstral-small-2507","mistralai/mistral-7b-instruct:free","mistralai/mistral-medium-3","mistralai/mistral-medium-3.1","mistralai/mistral-nemo:free","mistralai/mistral-small-3.1-24b-instruct","mistralai/mistral-small-3.2-24b-instruct","mistralai/mistral-small-3.2-24b-instruct:free","moonshotai/kimi-dev-72b:free","moonshotai/kimi-k2","moonshotai/kimi-k2-0905","moonshotai/kimi-k2-0905:exacto","moonshotai/kimi-k2-thinking","moonshotai/kimi-k2:free","nousresearch/deephermes-3-llama-3-8b-preview","nousresearch/hermes-4-405b","nousresearch/hermes-4-70b","nvidia/nemotron-nano-9b-v2","openai/gpt-4.1","openai/gpt-4.1-mini","openai/gpt-4o-mini","openai/gpt-5","openai/gpt-5-chat","openai/gpt-5-codex","openai/gpt-5-image","openai/gpt-5-mini","openai/gpt-5-nano","openai/gpt-5-pro","openai/gpt-5.1","openai/gpt-5.1-chat","openai/gpt-5.1-codex","openai/gpt-5.1-codex-max","openai/gpt-5.1-codex-mini","openai/gpt-5.2","openai/gpt-5.2-chat-latest","openai/gpt-5.2-codex","openai/gpt-5.2-pro","openai/gpt-oss-120b","openai/gpt-oss-120b:exacto","openai/gpt-oss-20b","openai/gpt-oss-safeguard-20b","openai/o4-mini","openrouter/sherlock-dash-alpha","openrouter/sherlock-think-alpha","qwen/qwen-2.5-coder-32b-instruct","qwen/qwen2.5-vl-32b-instruct:free","qwen/qwen2.5-vl-72b-instruct","qwen/qwen2.5-vl-72b-instruct:free","qwen/qwen3-14b:free","qwen/qwen3-235b-a22b-07-25","qwen/qwen3-235b-a22b-07-25:free","qwen/qwen3-235b-a22b-thinking-2507","qwen/qwen3-235b-a22b:free","qwen/qwen3-30b-a3b-instruct-2507","qwen/qwen3-30b-a3b-thinking-2507","qwen/qwen3-30b-a3b:free","qwen/qwen3-32b:free","qwen/qwen3-8b:free","qwen/qwen3-coder","qwen/qwen3-coder-30b-a3b-instruct","qwen/qwen3-coder-flash","qwen/qwen3-coder:exacto","qwen/qwen3-coder:free","qwen/qwen3-max","qwen/qwen3-next-80b-a3b-instruct","qwen/qwen3-next-80b-a3b-thinking","qwen/qwq-32b:free","rekaai/reka-flash-3","sarvamai/sarvam-m:free","thudm/glm-z1-32b:free","tngtech/deepseek-r1t2-chimera:free","x-ai/grok-3","x-ai/grok-3-beta","x-ai/grok-3-mini","x-ai/grok-3-mini-beta","x-ai/grok-4","x-ai/grok-4-fast","x-ai/grok-4.1-fast","x-ai/grok-code-fast-1","z-ai/glm-4.5","z-ai/glm-4.5-air","z-ai/glm-4.5-air:free","z-ai/glm-4.5v","z-ai/glm-4.6","z-ai/glm-4.6:exacto","z-ai/glm-4.7"],docUrl:"https://openrouter.ai/models",gateway:"models.dev"},zenmux:{url:"https://zenmux.ai/api/v1",apiKeyEnvVar:"ZENMUX_API_KEY",apiKeyHeader:"Authorization",name:"ZenMux",models:["anthropic/claude-haiku-4.5","anthropic/claude-opus-4","anthropic/claude-opus-4.1","anthropic/claude-opus-4.5","anthropic/claude-sonnet-4","anthropic/claude-sonnet-4.5","baidu/ernie-5.0-thinking-preview","deepseek/deepseek-chat","deepseek/deepseek-reasoner","deepseek/deepseek-v3.2","deepseek/deepseek-v3.2-exp","google/gemini-2.5-flash","google/gemini-2.5-flash-lite","google/gemini-2.5-pro","google/gemini-3-flash-preview","google/gemini-3-flash-preview-free","google/gemini-3-pro-preview","inclusionai/ling-1t","inclusionai/ring-1t","kuaishou/kat-coder-pro-v1","kuaishou/kat-coder-pro-v1-free","minimax/minimax-m2","minimax/minimax-m2.1","moonshotai/kimi-k2-0905","moonshotai/kimi-k2-thinking","moonshotai/kimi-k2-thinking-turbo","openai/gpt-5","openai/gpt-5-codex","openai/gpt-5.1","openai/gpt-5.1-chat","openai/gpt-5.1-codex","openai/gpt-5.1-codex-mini","openai/gpt-5.2","qwen/qwen3-coder-plus","stepfun/step-3","volcengine/doubao-seed-1.8","volcengine/doubao-seed-code","x-ai/grok-4","x-ai/grok-4-fast","x-ai/grok-4.1-fast","x-ai/grok-4.1-fast-non-reasoning","x-ai/grok-code-fast-1","xiaomi/mimo-v2-flash","xiaomi/mimo-v2-flash-free","z-ai/glm-4.5","z-ai/glm-4.5-air","z-ai/glm-4.6","z-ai/glm-4.6v","z-ai/glm-4.6v-flash","z-ai/glm-4.6v-flash-free","z-ai/glm-4.7"],docUrl:"https://docs.zenmux.ai",gateway:"models.dev"},ovhcloud:{url:"https://oai.endpoints.kepler.ai.cloud.ovh.net/v1",apiKeyEnvVar:"OVHCLOUD_API_KEY",apiKeyHeader:"Authorization",name:"OVHcloud AI Endpoints",models:["deepseek-r1-distill-llama-70b","gpt-oss-120b","gpt-oss-20b","llama-3.1-8b-instruct","llava-next-mistral-7b","meta-llama-3_1-70b-instruct","meta-llama-3_3-70b-instruct","mistral-7b-instruct-v0.3","mistral-nemo-instruct-2407","mistral-small-3.2-24b-instruct-2506","mixtral-8x7b-instruct-v0.1","qwen2.5-coder-32b-instruct","qwen2.5-vl-72b-instruct","qwen3-32b","qwen3-coder-30b-a3b-instruct"],docUrl:"https://www.ovhcloud.com/en/public-cloud/ai-endpoints/catalog//",gateway:"models.dev"},iflowcn:{url:"https://apis.iflow.cn/v1",apiKeyEnvVar:"IFLOW_API_KEY",apiKeyHeader:"Authorization",name:"iFlow",models:["deepseek-r1","deepseek-v3","deepseek-v3.2","glm-4.6","kimi-k2","kimi-k2-0905","qwen3-235b","qwen3-235b-a22b-instruct","qwen3-235b-a22b-thinking-2507","qwen3-32b","qwen3-coder-plus","qwen3-max","qwen3-max-preview","qwen3-vl-plus"],docUrl:"https://platform.iflow.cn/en/docs",gateway:"models.dev"},synthetic:{url:"https://api.synthetic.new/v1",apiKeyEnvVar:"SYNTHETIC_API_KEY",apiKeyHeader:"Authorization",name:"Synthetic",models:["hf:MiniMaxAI/MiniMax-M2","hf:MiniMaxAI/MiniMax-M2.1","hf:Qwen/Qwen2.5-Coder-32B-Instruct","hf:Qwen/Qwen3-235B-A22B-Instruct-2507","hf:Qwen/Qwen3-235B-A22B-Thinking-2507","hf:Qwen/Qwen3-Coder-480B-A35B-Instruct","hf:deepseek-ai/DeepSeek-R1","hf:deepseek-ai/DeepSeek-R1-0528","hf:deepseek-ai/DeepSeek-V3","hf:deepseek-ai/DeepSeek-V3-0324","hf:deepseek-ai/DeepSeek-V3.1","hf:deepseek-ai/DeepSeek-V3.1-Terminus","hf:deepseek-ai/DeepSeek-V3.2","hf:meta-llama/Llama-3.1-405B-Instruct","hf:meta-llama/Llama-3.1-70B-Instruct","hf:meta-llama/Llama-3.1-8B-Instruct","hf:meta-llama/Llama-3.3-70B-Instruct","hf:meta-llama/Llama-4-Maverick-17B-128E-Instruct-FP8","hf:meta-llama/Llama-4-Scout-17B-16E-Instruct","hf:moonshotai/Kimi-K2-Instruct-0905","hf:moonshotai/Kimi-K2-Thinking","hf:openai/gpt-oss-120b","hf:zai-org/GLM-4.5","hf:zai-org/GLM-4.6","hf:zai-org/GLM-4.7"],docUrl:"https://synthetic.new/pricing",gateway:"models.dev"},deepinfra:{url:"https://api.deepinfra.com/v1/openai",apiKeyEnvVar:"DEEPINFRA_API_KEY",apiKeyHeader:"Authorization",name:"Deep Infra",models:["MiniMaxAI/MiniMax-M2","MiniMaxAI/MiniMax-M2.1","Qwen/Qwen3-Coder-480B-A35B-Instruct","Qwen/Qwen3-Coder-480B-A35B-Instruct-Turbo","moonshotai/Kimi-K2-Instruct","moonshotai/Kimi-K2-Thinking","openai/gpt-oss-120b","openai/gpt-oss-20b","zai-org/GLM-4.7"],docUrl:"https://deepinfra.com/models",gateway:"models.dev"},zhipuai:{url:"https://open.bigmodel.cn/api/paas/v4",apiKeyEnvVar:"ZHIPU_API_KEY",apiKeyHeader:"Authorization",name:"Zhipu AI",models:["glm-4.5","glm-4.5-air","glm-4.5-flash","glm-4.5v","glm-4.6","glm-4.6v","glm-4.6v-flash","glm-4.7"],docUrl:"https://docs.z.ai/guides/overview/pricing",gateway:"models.dev"},submodel:{url:"https://llm.submodel.ai/v1",apiKeyEnvVar:"SUBMODEL_INSTAGEN_ACCESS_KEY",apiKeyHeader:"Authorization",name:"submodel",models:["Qwen/Qwen3-235B-A22B-Instruct-2507","Qwen/Qwen3-235B-A22B-Thinking-2507","Qwen/Qwen3-Coder-480B-A35B-Instruct-FP8","deepseek-ai/DeepSeek-R1-0528","deepseek-ai/DeepSeek-V3-0324","deepseek-ai/DeepSeek-V3.1","openai/gpt-oss-120b","zai-org/GLM-4.5-Air","zai-org/GLM-4.5-FP8"],docUrl:"https://submodel.gitbook.io",gateway:"models.dev"},"nano-gpt":{url:"https://nano-gpt.com/api/v1",apiKeyEnvVar:"NANO_GPT_API_KEY",apiKeyHeader:"Authorization",name:"NanoGPT",models:["deepseek/deepseek-r1","deepseek/deepseek-v3.2:thinking","meta-llama/llama-3.3-70b-instruct","meta-llama/llama-4-maverick","minimax/minimax-m2.1","mistralai/devstral-2-123b-instruct-2512","mistralai/ministral-14b-instruct-2512","mistralai/mistral-large-3-675b-instruct-2512","moonshotai/kimi-k2-instruct","moonshotai/kimi-k2-thinking","nousresearch/hermes-4-405b:thinking","nvidia/llama-3_3-nemotron-super-49b-v1_5","openai/gpt-oss-120b","qwen/qwen3-235b-a22b-thinking-2507","qwen/qwen3-coder","z-ai/glm-4.6","z-ai/glm-4.6:thinking","zai-org/glm-4.5-air","zai-org/glm-4.5-air:thinking","zai-org/glm-4.7","zai-org/glm-4.7:thinking"],docUrl:"https://docs.nano-gpt.com",gateway:"models.dev"},zai:{url:"https://api.z.ai/api/paas/v4",apiKeyEnvVar:"ZHIPU_API_KEY",apiKeyHeader:"Authorization",name:"Z.AI",models:["glm-4.5","glm-4.5-air","glm-4.5-flash","glm-4.5v","glm-4.6","glm-4.6v","glm-4.7"],docUrl:"https://docs.z.ai/guides/overview/pricing",gateway:"models.dev"},inference:{url:"https://inference.net/v1",apiKeyEnvVar:"INFERENCE_API_KEY",apiKeyHeader:"Authorization",name:"Inference",models:["google/gemma-3","meta/llama-3.1-8b-instruct","meta/llama-3.2-11b-vision-instruct","meta/llama-3.2-1b-instruct","meta/llama-3.2-3b-instruct","mistral/mistral-nemo-12b-instruct","osmosis/osmosis-structure-0.6b","qwen/qwen-2.5-7b-vision-instruct","qwen/qwen3-embedding-4b"],docUrl:"https://inference.net/models",gateway:"models.dev"},requesty:{url:"https://router.requesty.ai/v1",apiKeyEnvVar:"REQUESTY_API_KEY",apiKeyHeader:"Authorization",name:"Requesty",models:["anthropic/claude-3-7-sonnet","anthropic/claude-haiku-4-5","anthropic/claude-opus-4","anthropic/claude-opus-4-1","anthropic/claude-opus-4-5","anthropic/claude-sonnet-4","anthropic/claude-sonnet-4-5","google/gemini-2.5-flash","google/gemini-2.5-pro","google/gemini-3-flash-preview","google/gemini-3-pro-preview","openai/gpt-4.1","openai/gpt-4.1-mini","openai/gpt-4o-mini","openai/gpt-5","openai/gpt-5-mini","openai/gpt-5-nano","openai/o4-mini","xai/grok-4","xai/grok-4-fast"],docUrl:"https://requesty.ai/solution/llm-routing/models",gateway:"models.dev"},morph:{url:"https://api.morphllm.com/v1",apiKeyEnvVar:"MORPH_API_KEY",apiKeyHeader:"Authorization",name:"Morph",models:["auto","morph-v3-fast","morph-v3-large"],docUrl:"https://docs.morphllm.com/api-reference/introduction",gateway:"models.dev"},lmstudio:{url:"http://127.0.0.1:1234/v1",apiKeyEnvVar:"LMSTUDIO_API_KEY",apiKeyHeader:"Authorization",name:"LMStudio",models:["openai/gpt-oss-20b","qwen/qwen3-30b-a3b-2507","qwen/qwen3-coder-30b"],docUrl:"https://lmstudio.ai/models",gateway:"models.dev"},friendli:{url:"https://api.friendli.ai/serverless/v1",apiKeyEnvVar:"FRIENDLI_TOKEN",apiKeyHeader:"Authorization",name:"Friendli",models:["LGAI-EXAONE/EXAONE-4.0.1-32B","LGAI-EXAONE/K-EXAONE-236B-A23B","Qwen/Qwen3-235B-A22B-Instruct-2507","Qwen/Qwen3-235B-A22B-Thinking-2507","Qwen/Qwen3-30B-A3B","Qwen/Qwen3-32B","meta-llama-3.1-8b-instruct","meta-llama-3.3-70b-instruct","meta-llama/Llama-4-Maverick-17B-128E-Instruct","meta-llama/Llama-4-Scout-17B-16E-Instruct","zai-org/GLM-4.6"],docUrl:"https://friendli.ai/docs/guides/serverless_endpoints/introduction",gateway:"models.dev"},anthropic:{apiKeyEnvVar:"ANTHROPIC_API_KEY",name:"Anthropic",models:["claude-3-5-haiku-20241022","claude-3-5-haiku-latest","claude-3-5-sonnet-20240620","claude-3-5-sonnet-20241022","claude-3-7-sonnet-20250219","claude-3-7-sonnet-latest","claude-3-haiku-20240307","claude-3-opus-20240229","claude-3-sonnet-20240229","claude-haiku-4-5","claude-haiku-4-5-20251001","claude-opus-4-0","claude-opus-4-1","claude-opus-4-1-20250805","claude-opus-4-20250514","claude-opus-4-5","claude-opus-4-5-20251101","claude-sonnet-4-0","claude-sonnet-4-20250514","claude-sonnet-4-5","claude-sonnet-4-5-20250929"],docUrl:"https://docs.anthropic.com/en/docs/about-claude/models",gateway:"models.dev"},"fireworks-ai":{url:"https://api.fireworks.ai/inference/v1/",apiKeyEnvVar:"FIREWORKS_API_KEY",apiKeyHeader:"Authorization",name:"Fireworks AI",models:["accounts/fireworks/models/deepseek-r1-0528","accounts/fireworks/models/deepseek-v3-0324","accounts/fireworks/models/deepseek-v3p1","accounts/fireworks/models/deepseek-v3p2","accounts/fireworks/models/glm-4p5","accounts/fireworks/models/glm-4p5-air","accounts/fireworks/models/glm-4p6","accounts/fireworks/models/glm-4p7","accounts/fireworks/models/gpt-oss-120b","accounts/fireworks/models/gpt-oss-20b","accounts/fireworks/models/kimi-k2-instruct","accounts/fireworks/models/kimi-k2-thinking","accounts/fireworks/models/minimax-m2","accounts/fireworks/models/minimax-m2p1","accounts/fireworks/models/qwen3-235b-a22b","accounts/fireworks/models/qwen3-coder-480b-a35b-instruct"],docUrl:"https://fireworks.ai/docs/",gateway:"models.dev"},"io-net":{url:"https://api.intelligence.io.solutions/api/v1",apiKeyEnvVar:"IOINTELLIGENCE_API_KEY",apiKeyHeader:"Authorization",name:"IO.NET",models:["Intel/Qwen3-Coder-480B-A35B-Instruct-int4-mixed-ar","Qwen/Qwen2.5-VL-32B-Instruct","Qwen/Qwen3-235B-A22B-Thinking-2507","Qwen/Qwen3-Next-80B-A3B-Instruct","deepseek-ai/DeepSeek-R1-0528","meta-llama/Llama-3.2-90B-Vision-Instruct","meta-llama/Llama-3.3-70B-Instruct","meta-llama/Llama-4-Maverick-17B-128E-Instruct-FP8","mistralai/Devstral-Small-2505","mistralai/Magistral-Small-2506","mistralai/Mistral-Large-Instruct-2411","mistralai/Mistral-Nemo-Instruct-2407","moonshotai/Kimi-K2-Instruct-0905","moonshotai/Kimi-K2-Thinking","openai/gpt-oss-120b","openai/gpt-oss-20b","zai-org/GLM-4.6"],docUrl:"https://io.net/docs/guides/intelligence/io-intelligence",gateway:"models.dev"},modelscope:{url:"https://api-inference.modelscope.cn/v1",apiKeyEnvVar:"MODELSCOPE_API_KEY",apiKeyHeader:"Authorization",name:"ModelScope",models:["Qwen/Qwen3-235B-A22B-Instruct-2507","Qwen/Qwen3-235B-A22B-Thinking-2507","Qwen/Qwen3-30B-A3B-Instruct-2507","Qwen/Qwen3-30B-A3B-Thinking-2507","Qwen/Qwen3-Coder-30B-A3B-Instruct","ZhipuAI/GLM-4.5","ZhipuAI/GLM-4.6"],docUrl:"https://modelscope.cn/docs/model-service/API-Inference/intro",gateway:"models.dev"},llama:{url:"https://api.llama.com/compat/v1/",apiKeyEnvVar:"LLAMA_API_KEY",apiKeyHeader:"Authorization",name:"Llama",models:["cerebras-llama-4-maverick-17b-128e-instruct","cerebras-llama-4-scout-17b-16e-instruct","groq-llama-4-maverick-17b-128e-instruct","llama-3.3-70b-instruct","llama-3.3-8b-instruct","llama-4-maverick-17b-128e-instruct-fp8","llama-4-scout-17b-16e-instruct-fp8"],docUrl:"https://llama.developer.meta.com/docs/models",gateway:"models.dev"},scaleway:{url:"https://api.scaleway.ai/v1",apiKeyEnvVar:"SCALEWAY_API_KEY",apiKeyHeader:"Authorization",name:"Scaleway",models:["bge-multilingual-gemma2","deepseek-r1-distill-llama-70b","devstral-2-123b-instruct-2512","gemma-3-27b-it","gpt-oss-120b","llama-3.1-8b-instruct","llama-3.3-70b-instruct","mistral-nemo-instruct-2407","mistral-small-3.2-24b-instruct-2506","pixtral-12b-2409","qwen3-235b-a22b-instruct-2507","qwen3-coder-30b-a3b-instruct","voxtral-small-24b-2507","whisper-large-v3"],docUrl:"https://www.scaleway.com/en/docs/generative-apis/",gateway:"models.dev"},poe:{url:"https://api.poe.com/v1",apiKeyEnvVar:"POE_API_KEY",apiKeyHeader:"Authorization",name:"Poe",models:["anthropic/claude-haiku-3","anthropic/claude-haiku-3.5","anthropic/claude-haiku-3.5-search","anthropic/claude-haiku-4.5","anthropic/claude-opus-3","anthropic/claude-opus-4","anthropic/claude-opus-4-reasoning","anthropic/claude-opus-4-search","anthropic/claude-opus-4.1","anthropic/claude-opus-4.5","anthropic/claude-sonnet-3.5","anthropic/claude-sonnet-3.5-june","anthropic/claude-sonnet-3.7","anthropic/claude-sonnet-3.7-reasoning","anthropic/claude-sonnet-3.7-search","anthropic/claude-sonnet-4","anthropic/claude-sonnet-4-reasoning","anthropic/claude-sonnet-4-search","anthropic/claude-sonnet-4.5","cerebras/gpt-oss-120b-cs","cerebras/zai-glm-4.6-cs","elevenlabs/elevenlabs-music","elevenlabs/elevenlabs-v2.5-turbo","elevenlabs/elevenlabs-v3","google/gemini-2.0-flash","google/gemini-2.0-flash-lite","google/gemini-2.5-flash","google/gemini-2.5-flash-lite","google/gemini-2.5-pro","google/gemini-3-flash","google/gemini-3-pro","google/gemini-deep-research","google/imagen-3","google/imagen-3-fast","google/imagen-4","google/imagen-4-fast","google/imagen-4-ultra","google/lyria","google/nano-banana","google/nano-banana-pro","google/veo-2","google/veo-3","google/veo-3-fast","google/veo-3.1","google/veo-3.1-fast","ideogramai/ideogram","ideogramai/ideogram-v2","ideogramai/ideogram-v2a","ideogramai/ideogram-v2a-turbo","lumalabs/dream-machine","lumalabs/ray2","novita/glm-4.6","novita/glm-4.6v","novita/glm-4.7","novita/kat-coder-pro","novita/kimi-k2-thinking","novita/minimax-m2.1","openai/chatgpt-4o-latest","openai/dall-e-3","openai/gpt-3.5-turbo","openai/gpt-3.5-turbo-instruct","openai/gpt-3.5-turbo-raw","openai/gpt-4-classic","openai/gpt-4-classic-0314","openai/gpt-4-turbo","openai/gpt-4.1","openai/gpt-4.1-mini","openai/gpt-4.1-nano","openai/gpt-4o","openai/gpt-4o-aug","openai/gpt-4o-mini","openai/gpt-4o-mini-search","openai/gpt-4o-search","openai/gpt-5","openai/gpt-5-chat","openai/gpt-5-codex","openai/gpt-5-mini","openai/gpt-5-nano","openai/gpt-5-pro","openai/gpt-5.1","openai/gpt-5.1-codex","openai/gpt-5.1-codex-max","openai/gpt-5.1-codex-mini","openai/gpt-5.1-instant","openai/gpt-5.2","openai/gpt-5.2-instant","openai/gpt-5.2-pro","openai/gpt-image-1","openai/gpt-image-1-mini","openai/gpt-image-1.5","openai/o1","openai/o1-pro","openai/o3","openai/o3-deep-research","openai/o3-mini","openai/o3-mini-high","openai/o3-pro","openai/o4-mini","openai/o4-mini-deep-research","openai/sora-2","openai/sora-2-pro","poetools/claude-code","runwayml/runway","runwayml/runway-gen-4-turbo","stabilityai/stablediffusionxl","topazlabs-co/topazlabs","trytako/tako","xai/grok-3","xai/grok-3-mini","xai/grok-4","xai/grok-4-fast-non-reasoning","xai/grok-4-fast-reasoning","xai/grok-4.1-fast-non-reasoning","xai/grok-4.1-fast-reasoning","xai/grok-code-fast-1"],docUrl:"https://creator.poe.com/docs/external-applications/openai-compatible-api",gateway:"models.dev"},cerebras:{url:"https://api.cerebras.ai/v1",apiKeyEnvVar:"CEREBRAS_API_KEY",apiKeyHeader:"Authorization",name:"Cerebras",models:["gpt-oss-120b","qwen-3-235b-a22b-instruct-2507","zai-glm-4.6","zai-glm-4.7"],docUrl:"https://inference-docs.cerebras.ai/models/overview",gateway:"models.dev"},netlify:{apiKeyEnvVar:["NETLIFY_TOKEN","NETLIFY_SITE_ID"],apiKeyHeader:"Authorization",name:"Netlify",gateway:"netlify",models:["anthropic/claude-3-5-haiku-20241022","anthropic/claude-3-7-sonnet-20250219","anthropic/claude-3-haiku-20240307","anthropic/claude-haiku-4-5","anthropic/claude-haiku-4-5-20251001","anthropic/claude-opus-4-1-20250805","anthropic/claude-opus-4-20250514","anthropic/claude-opus-4-5","anthropic/claude-opus-4-5-20251101","anthropic/claude-sonnet-4-0","anthropic/claude-sonnet-4-20250514","anthropic/claude-sonnet-4-5","anthropic/claude-sonnet-4-5-20250929","gemini/gemini-2.0-flash","gemini/gemini-2.0-flash-lite","gemini/gemini-2.5-flash","gemini/gemini-2.5-flash-image","gemini/gemini-2.5-flash-image-preview","gemini/gemini-2.5-flash-lite","gemini/gemini-2.5-flash-lite-preview-09-2025","gemini/gemini-2.5-flash-preview-09-2025","gemini/gemini-2.5-pro","gemini/gemini-3-flash-preview","gemini/gemini-3-pro-image-preview","gemini/gemini-3-pro-preview","gemini/gemini-flash-latest","gemini/gemini-flash-lite-latest","openai/codex-mini-latest","openai/gpt-4.1","openai/gpt-4.1-mini","openai/gpt-4.1-nano","openai/gpt-4o","openai/gpt-4o-mini","openai/gpt-5","openai/gpt-5-2025-08-07","openai/gpt-5-codex","openai/gpt-5-mini","openai/gpt-5-mini-2025-08-07","openai/gpt-5-nano","openai/gpt-5-pro","openai/gpt-5.1","openai/gpt-5.1-2025-11-13","openai/gpt-5.1-codex","openai/gpt-5.1-codex-max","openai/gpt-5.1-codex-mini","openai/gpt-5.2","openai/gpt-5.2-2025-12-11","openai/gpt-5.2-codex","openai/gpt-5.2-pro","openai/gpt-5.2-pro-2025-12-11","openai/o3","openai/o3-mini","openai/o4-mini"],docUrl:"https://docs.netlify.com/build/ai-gateway/overview/"}},models:{"privatemode-ai":["gemma-3-27b","gpt-oss-120b","qwen3-coder-30b-a3b","qwen3-embedding-4b","whisper-large-v3"],"moonshotai-cn":["kimi-k2-0711-preview","kimi-k2-0905-preview","kimi-k2-thinking","kimi-k2-thinking-turbo","kimi-k2-turbo-preview"],firmware:["claude-haiku-4-5-20251001","claude-opus-4-5","claude-sonnet-4-5-20250929","deepseek-chat","deepseek-coder","deepseek-reasoner","gemini-2.5-flash","gemini-2.5-pro","gemini-3-flash-preview","gemini-3-pro-preview","gpt-4o","gpt-5","gpt-5-mini","gpt-5-nano","gpt-5.2","grok-4-fast-non-reasoning","grok-4-fast-reasoning","grok-code-fast-1"],lucidquery:["lucidnova-rf1-100b","lucidquery-nexus-coder"],moonshotai:["kimi-k2-0711-preview","kimi-k2-0905-preview","kimi-k2-thinking","kimi-k2-thinking-turbo","kimi-k2-turbo-preview"],"zai-coding-plan":["glm-4.5","glm-4.5-air","glm-4.5-flash","glm-4.5v","glm-4.6","glm-4.6v","glm-4.7","glm-4.7-flash"],"ollama-cloud":["cogito-2.1:671b-cloud","deepseek-v3.1:671b-cloud","gemini-3-pro-preview:latest","glm-4.6:cloud","glm-4.7:cloud","gpt-oss:120b-cloud","gpt-oss:20b-cloud","kimi-k2-thinking:cloud","kimi-k2:1t-cloud","minimax-m2:cloud","qwen3-coder:480b-cloud","qwen3-vl-235b-cloud","qwen3-vl-235b-instruct-cloud"],xiaomi:["mimo-v2-flash"],alibaba:["qvq-max","qwen-flash","qwen-max","qwen-mt-plus","qwen-mt-turbo","qwen-omni-turbo","qwen-omni-turbo-realtime","qwen-plus","qwen-plus-character-ja","qwen-turbo","qwen-vl-max","qwen-vl-ocr","qwen-vl-plus","qwen2-5-14b-instruct","qwen2-5-32b-instruct","qwen2-5-72b-instruct","qwen2-5-7b-instruct","qwen2-5-omni-7b","qwen2-5-vl-72b-instruct","qwen2-5-vl-7b-instruct","qwen3-14b","qwen3-235b-a22b","qwen3-32b","qwen3-8b","qwen3-asr-flash","qwen3-coder-30b-a3b-instruct","qwen3-coder-480b-a35b-instruct","qwen3-coder-flash","qwen3-coder-plus","qwen3-livetranslate-flash-realtime","qwen3-max","qwen3-next-80b-a3b-instruct","qwen3-next-80b-a3b-thinking","qwen3-omni-flash","qwen3-omni-flash-realtime","qwen3-vl-235b-a22b","qwen3-vl-30b-a3b","qwen3-vl-plus","qwq-plus"],xai:["grok-2","grok-2-1212","grok-2-latest","grok-2-vision","grok-2-vision-1212","grok-2-vision-latest","grok-3","grok-3-fast","grok-3-fast-latest","grok-3-latest","grok-3-mini","grok-3-mini-fast","grok-3-mini-fast-latest","grok-3-mini-latest","grok-4","grok-4-1-fast","grok-4-1-fast-non-reasoning","grok-4-fast","grok-4-fast-non-reasoning","grok-beta","grok-code-fast-1","grok-vision-beta"],vultr:["deepseek-r1-distill-llama-70b","deepseek-r1-distill-qwen-32b","gpt-oss-120b","kimi-k2-instruct","qwen2.5-coder-32b-instruct"],nvidia:["black-forest-labs/flux.1-dev","deepseek-ai/deepseek-coder-6.7b-instruct","deepseek-ai/deepseek-r1","deepseek-ai/deepseek-r1-0528","deepseek-ai/deepseek-v3.1","deepseek-ai/deepseek-v3.1-terminus","google/codegemma-1.1-7b","google/codegemma-7b","google/gemma-2-27b-it","google/gemma-2-2b-it","google/gemma-3-12b-it","google/gemma-3-1b-it","google/gemma-3-27b-it","google/gemma-3n-e2b-it","google/gemma-3n-e4b-it","meta/codellama-70b","meta/llama-3.1-405b-instruct","meta/llama-3.1-70b-instruct","meta/llama-3.2-11b-vision-instruct","meta/llama-3.2-1b-instruct","meta/llama-3.3-70b-instruct","meta/llama-4-maverick-17b-128e-instruct","meta/llama-4-scout-17b-16e-instruct","meta/llama3-70b-instruct","meta/llama3-8b-instruct","microsoft/phi-3-medium-128k-instruct","microsoft/phi-3-medium-4k-instruct","microsoft/phi-3-small-128k-instruct","microsoft/phi-3-small-8k-instruct","microsoft/phi-3-vision-128k-instruct","microsoft/phi-3.5-moe-instruct","microsoft/phi-3.5-vision-instruct","microsoft/phi-4-mini-instruct","minimaxai/minimax-m2","mistralai/codestral-22b-instruct-v0.1","mistralai/devstral-2-123b-instruct-2512","mistralai/mamba-codestral-7b-v0.1","mistralai/ministral-14b-instruct-2512","mistralai/mistral-large-2-instruct","mistralai/mistral-large-3-675b-instruct-2512","mistralai/mistral-small-3.1-24b-instruct-2503","moonshotai/kimi-k2-instruct","moonshotai/kimi-k2-instruct-0905","moonshotai/kimi-k2-thinking","nvidia/cosmos-nemotron-34b","nvidia/llama-3.1-nemotron-51b-instruct","nvidia/llama-3.1-nemotron-70b-instruct","nvidia/llama-3.1-nemotron-ultra-253b-v1","nvidia/llama-3.3-nemotron-super-49b-v1","nvidia/llama-3.3-nemotron-super-49b-v1.5","nvidia/llama-embed-nemotron-8b","nvidia/llama3-chatqa-1.5-70b","nvidia/nemoretriever-ocr-v1","nvidia/nemotron-3-nano-30b-a3b","nvidia/nemotron-4-340b-instruct","nvidia/nvidia-nemotron-nano-9b-v2","nvidia/parakeet-tdt-0.6b-v2","openai/gpt-oss-120b","openai/whisper-large-v3","qwen/qwen2.5-coder-32b-instruct","qwen/qwen2.5-coder-7b-instruct","qwen/qwen3-235b-a22b","qwen/qwen3-coder-480b-a35b-instruct","qwen/qwen3-next-80b-a3b-instruct","qwen/qwen3-next-80b-a3b-thinking","qwen/qwq-32b"],upstage:["solar-mini","solar-pro2","solar-pro3"],groq:["llama-3.1-8b-instant","llama-3.3-70b-versatile","meta-llama/llama-4-maverick-17b-128e-instruct","meta-llama/llama-4-scout-17b-16e-instruct","meta-llama/llama-guard-4-12b","moonshotai/kimi-k2-instruct-0905","openai/gpt-oss-120b","openai/gpt-oss-20b","qwen/qwen3-32b"],bailing:["Ling-1T","Ring-1T"],mistral:["codestral-latest","devstral-2512","devstral-medium-2507","devstral-medium-latest","devstral-small-2505","devstral-small-2507","labs-devstral-small-2512","magistral-medium-latest","magistral-small","ministral-3b-latest","ministral-8b-latest","mistral-embed","mistral-large-2411","mistral-large-2512","mistral-large-latest","mistral-medium-2505","mistral-medium-2508","mistral-medium-latest","mistral-nemo","mistral-small-2506","mistral-small-latest","open-mistral-7b","open-mixtral-8x22b","open-mixtral-8x7b","pixtral-12b","pixtral-large-latest"],abacus:["Qwen/QwQ-32B","Qwen/Qwen2.5-72B-Instruct","Qwen/Qwen3-235B-A22B-Instruct-2507","Qwen/Qwen3-32B","Qwen/qwen3-coder-480b-a35b-instruct","claude-3-7-sonnet-20250219","claude-haiku-4-5-20251001","claude-opus-4-1-20250805","claude-opus-4-20250514","claude-opus-4-5-20251101","claude-sonnet-4-20250514","claude-sonnet-4-5-20250929","deepseek-ai/DeepSeek-R1","deepseek-ai/DeepSeek-V3.1-Terminus","deepseek-ai/DeepSeek-V3.2","deepseek/deepseek-v3.1","gemini-2.0-flash-001","gemini-2.0-pro-exp-02-05","gemini-2.5-flash","gemini-2.5-pro","gemini-3-flash-preview","gemini-3-pro-preview","gpt-4.1","gpt-4.1-mini","gpt-4.1-nano","gpt-4o-2024-11-20","gpt-4o-mini","gpt-5","gpt-5-mini","gpt-5-nano","gpt-5.1","gpt-5.1-chat-latest","gpt-5.2","gpt-5.2-chat-latest","grok-4-0709","grok-4-1-fast-non-reasoning","grok-4-fast-non-reasoning","grok-code-fast-1","kimi-k2-turbo-preview","llama-3.3-70b-versatile","meta-llama/Llama-4-Maverick-17B-128E-Instruct-FP8","meta-llama/Meta-Llama-3.1-405B-Instruct-Turbo","meta-llama/Meta-Llama-3.1-70B-Instruct","meta-llama/Meta-Llama-3.1-8B-Instruct","o3","o3-mini","o3-pro","o4-mini","openai/gpt-oss-120b","qwen-2.5-coder-32b","qwen3-max","route-llm","zai-org/glm-4.5","zai-org/glm-4.6","zai-org/glm-4.7"],vercel:["alibaba/qwen-3-14b","alibaba/qwen-3-235b","alibaba/qwen-3-30b","alibaba/qwen-3-32b","alibaba/qwen3-235b-a22b-thinking","alibaba/qwen3-coder","alibaba/qwen3-coder-30b-a3b","alibaba/qwen3-coder-plus","alibaba/qwen3-embedding-0.6b","alibaba/qwen3-embedding-4b","alibaba/qwen3-embedding-8b","alibaba/qwen3-max","alibaba/qwen3-max-preview","alibaba/qwen3-next-80b-a3b-instruct","alibaba/qwen3-next-80b-a3b-thinking","alibaba/qwen3-vl-instruct","alibaba/qwen3-vl-thinking","amazon/nova-2-lite","amazon/nova-lite","amazon/nova-micro","amazon/nova-pro","amazon/titan-embed-text-v2","anthropic/claude-3-haiku","anthropic/claude-3-opus","anthropic/claude-3.5-haiku","anthropic/claude-3.5-sonnet","anthropic/claude-3.5-sonnet-20240620","anthropic/claude-3.7-sonnet","anthropic/claude-haiku-4.5","anthropic/claude-opus-4","anthropic/claude-opus-4.1","anthropic/claude-opus-4.5","anthropic/claude-sonnet-4","anthropic/claude-sonnet-4.5","arcee-ai/trinity-mini","bfl/flux-kontext-max","bfl/flux-kontext-pro","bfl/flux-pro-1.0-fill","bfl/flux-pro-1.1","bfl/flux-pro-1.1-ultra","bytedance/seed-1.6","bytedance/seed-1.8","cohere/command-a","cohere/embed-v4.0","deepseek/deepseek-r1","deepseek/deepseek-v3","deepseek/deepseek-v3.1","deepseek/deepseek-v3.1-terminus","deepseek/deepseek-v3.2","deepseek/deepseek-v3.2-exp","deepseek/deepseek-v3.2-thinking","google/gemini-2.0-flash","google/gemini-2.0-flash-lite","google/gemini-2.5-flash","google/gemini-2.5-flash-image","google/gemini-2.5-flash-image-preview","google/gemini-2.5-flash-lite","google/gemini-2.5-flash-lite-preview-09-2025","google/gemini-2.5-flash-preview-09-2025","google/gemini-2.5-pro","google/gemini-3-flash","google/gemini-3-pro-image","google/gemini-3-pro-preview","google/gemini-embedding-001","google/imagen-4.0-fast-generate-001","google/imagen-4.0-generate-001","google/imagen-4.0-ultra-generate-001","google/text-embedding-005","google/text-multilingual-embedding-002","inception/mercury-coder-small","kwaipilot/kat-coder-pro-v1","meituan/longcat-flash-chat","meituan/longcat-flash-thinking","meta/llama-3.1-70b","meta/llama-3.1-8b","meta/llama-3.2-11b","meta/llama-3.2-1b","meta/llama-3.2-3b","meta/llama-3.2-90b","meta/llama-3.3-70b","meta/llama-4-maverick","meta/llama-4-scout","minimax/minimax-m2","minimax/minimax-m2.1","minimax/minimax-m2.1-lightning","mistral/codestral","mistral/codestral-embed","mistral/devstral-2","mistral/devstral-small","mistral/devstral-small-2","mistral/magistral-medium","mistral/magistral-small","mistral/ministral-14b","mistral/ministral-3b","mistral/ministral-8b","mistral/mistral-embed","mistral/mistral-large-3","mistral/mistral-medium","mistral/mistral-nemo","mistral/mistral-small","mistral/mixtral-8x22b-instruct","mistral/pixtral-12b","mistral/pixtral-large","moonshotai/kimi-k2-0905","moonshotai/kimi-k2-thinking","moonshotai/kimi-k2-thinking-turbo","moonshotai/kimi-k2-turbo","morph/morph-v3-fast","morph/morph-v3-large","nvidia/nemotron-3-nano-30b-a3b","nvidia/nemotron-nano-12b-v2-vl","nvidia/nemotron-nano-9b-v2","openai/codex-mini","openai/gpt-3.5-turbo","openai/gpt-3.5-turbo-instruct","openai/gpt-4-turbo","openai/gpt-4.1","openai/gpt-4.1-mini","openai/gpt-4.1-nano","openai/gpt-4o","openai/gpt-4o-mini","openai/gpt-5","openai/gpt-5-chat","openai/gpt-5-codex","openai/gpt-5-mini","openai/gpt-5-nano","openai/gpt-5-pro","openai/gpt-5.1-codex","openai/gpt-5.1-codex-max","openai/gpt-5.1-codex-mini","openai/gpt-5.1-instant","openai/gpt-5.1-thinking","openai/gpt-5.2","openai/gpt-5.2-chat","openai/gpt-5.2-codex","openai/gpt-5.2-pro","openai/gpt-oss-120b","openai/gpt-oss-20b","openai/gpt-oss-safeguard-20b","openai/o1","openai/o3","openai/o3-deep-research","openai/o3-mini","openai/o3-pro","openai/o4-mini","openai/text-embedding-3-large","openai/text-embedding-3-small","openai/text-embedding-ada-002","perplexity/sonar","perplexity/sonar-pro","perplexity/sonar-reasoning","perplexity/sonar-reasoning-pro","prime-intellect/intellect-3","recraft/recraft-v2","recraft/recraft-v3","vercel/v0-1.0-md","vercel/v0-1.5-md","voyage/voyage-3-large","voyage/voyage-3.5","voyage/voyage-3.5-lite","voyage/voyage-code-2","voyage/voyage-code-3","voyage/voyage-finance-2","voyage/voyage-law-2","xai/grok-2-vision","xai/grok-3","xai/grok-3-fast","xai/grok-3-mini","xai/grok-3-mini-fast","xai/grok-4","xai/grok-4-fast-non-reasoning","xai/grok-4-fast-reasoning","xai/grok-4.1-fast-non-reasoning","xai/grok-4.1-fast-reasoning","xai/grok-code-fast-1","xiaomi/mimo-v2-flash","zai/glm-4.5","zai/glm-4.5-air","zai/glm-4.5v","zai/glm-4.6","zai/glm-4.6v","zai/glm-4.6v-flash","zai/glm-4.7"],nebius:["NousResearch/hermes-4-405b","NousResearch/hermes-4-70b","deepseek-ai/deepseek-v3","meta-llama/llama-3.3-70b-instruct-base","meta-llama/llama-3.3-70b-instruct-fast","meta-llama/llama-3_1-405b-instruct","moonshotai/kimi-k2-instruct","nvidia/llama-3_1-nemotron-ultra-253b-v1","openai/gpt-oss-120b","openai/gpt-oss-20b","qwen/qwen3-235b-a22b-instruct-2507","qwen/qwen3-235b-a22b-thinking-2507","qwen/qwen3-coder-480b-a35b-instruct","zai-org/glm-4.5","zai-org/glm-4.5-air"],deepseek:["deepseek-chat","deepseek-reasoner"],"alibaba-cn":["deepseek-r1","deepseek-r1-0528","deepseek-r1-distill-llama-70b","deepseek-r1-distill-llama-8b","deepseek-r1-distill-qwen-1-5b","deepseek-r1-distill-qwen-14b","deepseek-r1-distill-qwen-32b","deepseek-r1-distill-qwen-7b","deepseek-v3","deepseek-v3-1","deepseek-v3-2-exp","moonshot-kimi-k2-instruct","qvq-max","qwen-deep-research","qwen-doc-turbo","qwen-flash","qwen-long","qwen-math-plus","qwen-math-turbo","qwen-max","qwen-mt-plus","qwen-mt-turbo","qwen-omni-turbo","qwen-omni-turbo-realtime","qwen-plus","qwen-plus-character","qwen-turbo","qwen-vl-max","qwen-vl-ocr","qwen-vl-plus","qwen2-5-14b-instruct","qwen2-5-32b-instruct","qwen2-5-72b-instruct","qwen2-5-7b-instruct","qwen2-5-coder-32b-instruct","qwen2-5-coder-7b-instruct","qwen2-5-math-72b-instruct","qwen2-5-math-7b-instruct","qwen2-5-omni-7b","qwen2-5-vl-72b-instruct","qwen2-5-vl-7b-instruct","qwen3-14b","qwen3-235b-a22b","qwen3-32b","qwen3-8b","qwen3-asr-flash","qwen3-coder-30b-a3b-instruct","qwen3-coder-480b-a35b-instruct","qwen3-coder-flash","qwen3-coder-plus","qwen3-max","qwen3-next-80b-a3b-instruct","qwen3-next-80b-a3b-thinking","qwen3-omni-flash","qwen3-omni-flash-realtime","qwen3-vl-235b-a22b","qwen3-vl-30b-a3b","qwen3-vl-plus","qwq-32b","qwq-plus","tongyi-intent-detect-v3"],"novita-ai":["baichuan/baichuan-m2-32b","baidu/ernie-4.5-21B-a3b","baidu/ernie-4.5-21B-a3b-thinking","baidu/ernie-4.5-300b-a47b-paddle","baidu/ernie-4.5-vl-28b-a3b","baidu/ernie-4.5-vl-28b-a3b-thinking","baidu/ernie-4.5-vl-424b-a47b","deepseek/deepseek-ocr","deepseek/deepseek-prover-v2-671b","deepseek/deepseek-r1-0528","deepseek/deepseek-r1-0528-qwen3-8b","deepseek/deepseek-r1-distill-llama-70b","deepseek/deepseek-r1-turbo","deepseek/deepseek-v3-0324","deepseek/deepseek-v3-turbo","deepseek/deepseek-v3.1","deepseek/deepseek-v3.1-terminus","deepseek/deepseek-v3.2","deepseek/deepseek-v3.2-exp","google/gemma-3-27b-it","gryphe/mythomax-l2-13b","kwaipilot/kat-coder","kwaipilot/kat-coder-pro","meta-llama/llama-3-70b-instruct","meta-llama/llama-3-8b-instruct","meta-llama/llama-3.1-8b-instruct","meta-llama/llama-3.3-70b-instruct","meta-llama/llama-4-maverick-17b-128e-instruct-fp8","meta-llama/llama-4-scout-17b-16e-instruct","microsoft/wizardlm-2-8x22b","minimax/minimax-m2","minimax/minimax-m2.1","minimaxai/minimax-m1-80k","mistralai/mistral-nemo","moonshotai/kimi-k2-0905","moonshotai/kimi-k2-instruct","moonshotai/kimi-k2-thinking","nousresearch/hermes-2-pro-llama-3-8b","openai/gpt-oss-120b","openai/gpt-oss-20b","paddlepaddle/paddleocr-vl","qwen/qwen-2.5-72b-instruct","qwen/qwen-mt-plus","qwen/qwen2.5-7b-instruct","qwen/qwen2.5-vl-72b-instruct","qwen/qwen3-235b-a22b-fp8","qwen/qwen3-235b-a22b-instruct-2507","qwen/qwen3-235b-a22b-thinking-2507","qwen/qwen3-30b-a3b-fp8","qwen/qwen3-32b-fp8","qwen/qwen3-4b-fp8","qwen/qwen3-8b-fp8","qwen/qwen3-coder-30b-a3b-instruct","qwen/qwen3-coder-480b-a35b-instruct","qwen/qwen3-max","qwen/qwen3-next-80b-a3b-instruct","qwen/qwen3-next-80b-a3b-thinking","qwen/qwen3-omni-30b-a3b-instruct","qwen/qwen3-omni-30b-a3b-thinking","qwen/qwen3-vl-235b-a22b-instruct","qwen/qwen3-vl-235b-a22b-thinking","qwen/qwen3-vl-30b-a3b-instruct","qwen/qwen3-vl-30b-a3b-thinking","qwen/qwen3-vl-8b-instruct","sao10k/L3-8B-Stheno-v3.2","sao10k/l3-70b-euryale-v2.1","sao10k/l3-8b-lunaris","sao10k/l31-70b-euryale-v2.2","skywork/r1v4-lite","xiaomimimo/mimo-v2-flash","zai-org/autoglm-phone-9b-multilingual","zai-org/glm-4.5","zai-org/glm-4.5-air","zai-org/glm-4.5v","zai-org/glm-4.6","zai-org/glm-4.6v","zai-org/glm-4.7"],venice:["claude-opus-45","claude-sonnet-45","deepseek-v3.2","gemini-3-flash-preview","gemini-3-pro-preview","google-gemma-3-27b-it","grok-41-fast","grok-code-fast-1","hermes-3-llama-3.1-405b","kimi-k2-thinking","llama-3.2-3b","llama-3.3-70b","minimax-m21","mistral-31-24b","openai-gpt-52","openai-gpt-52-codex","openai-gpt-oss-120b","qwen3-235b-a22b-instruct-2507","qwen3-235b-a22b-thinking-2507","qwen3-4b","qwen3-coder-480b-a35b-instruct","qwen3-next-80b","qwen3-vl-235b-a22b","venice-uncensored","zai-org-glm-4.7"],"siliconflow-cn":["ByteDance-Seed/Seed-OSS-36B-Instruct","Kwaipilot/KAT-Dev","MiniMaxAI/MiniMax-M1-80k","MiniMaxAI/MiniMax-M2","Qwen/QwQ-32B","Qwen/Qwen2.5-14B-Instruct","Qwen/Qwen2.5-32B-Instruct","Qwen/Qwen2.5-72B-Instruct","Qwen/Qwen2.5-72B-Instruct-128K","Qwen/Qwen2.5-7B-Instruct","Qwen/Qwen2.5-Coder-32B-Instruct","Qwen/Qwen2.5-VL-32B-Instruct","Qwen/Qwen2.5-VL-72B-Instruct","Qwen/Qwen2.5-VL-7B-Instruct","Qwen/Qwen3-14B","Qwen/Qwen3-235B-A22B","Qwen/Qwen3-235B-A22B-Instruct-2507","Qwen/Qwen3-235B-A22B-Thinking-2507","Qwen/Qwen3-30B-A3B","Qwen/Qwen3-30B-A3B-Instruct-2507","Qwen/Qwen3-30B-A3B-Thinking-2507","Qwen/Qwen3-32B","Qwen/Qwen3-8B","Qwen/Qwen3-Coder-30B-A3B-Instruct","Qwen/Qwen3-Coder-480B-A35B-Instruct","Qwen/Qwen3-Next-80B-A3B-Instruct","Qwen/Qwen3-Next-80B-A3B-Thinking","Qwen/Qwen3-Omni-30B-A3B-Captioner","Qwen/Qwen3-Omni-30B-A3B-Instruct","Qwen/Qwen3-Omni-30B-A3B-Thinking","Qwen/Qwen3-VL-235B-A22B-Instruct","Qwen/Qwen3-VL-235B-A22B-Thinking","Qwen/Qwen3-VL-30B-A3B-Instruct","Qwen/Qwen3-VL-30B-A3B-Thinking","Qwen/Qwen3-VL-32B-Instruct","Qwen/Qwen3-VL-32B-Thinking","Qwen/Qwen3-VL-8B-Instruct","Qwen/Qwen3-VL-8B-Thinking","THUDM/GLM-4-32B-0414","THUDM/GLM-4-9B-0414","THUDM/GLM-4.1V-9B-Thinking","THUDM/GLM-Z1-32B-0414","THUDM/GLM-Z1-9B-0414","ascend-tribe/pangu-pro-moe","baidu/ERNIE-4.5-300B-A47B","deepseek-ai/DeepSeek-R1","deepseek-ai/DeepSeek-R1-Distill-Qwen-14B","deepseek-ai/DeepSeek-R1-Distill-Qwen-32B","deepseek-ai/DeepSeek-R1-Distill-Qwen-7B","deepseek-ai/DeepSeek-V3","deepseek-ai/DeepSeek-V3.1-Terminus","deepseek-ai/DeepSeek-V3.2","deepseek-ai/deepseek-vl2","inclusionAI/Ling-flash-2.0","inclusionAI/Ling-mini-2.0","inclusionAI/Ring-flash-2.0","moonshotai/Kimi-Dev-72B","moonshotai/Kimi-K2-Instruct","moonshotai/Kimi-K2-Instruct-0905","moonshotai/Kimi-K2-Thinking","nex-agi/DeepSeek-V3.1-Nex-N1","openai/gpt-oss-120b","openai/gpt-oss-20b","stepfun-ai/step3","tencent/Hunyuan-A13B-Instruct","tencent/Hunyuan-MT-7B","zai-org/GLM-4.5","zai-org/GLM-4.5-Air","zai-org/GLM-4.5V","zai-org/GLM-4.6","zai-org/GLM-4.6V"],vivgrid:["gpt-5.1-codex"],chutes:["MiniMaxAI/MiniMax-M2.1-TEE","NousResearch/DeepHermes-3-Mistral-24B-Preview","NousResearch/Hermes-4-14B","NousResearch/Hermes-4-405B-FP8-TEE","NousResearch/Hermes-4-70B","NousResearch/Hermes-4.3-36B","OpenGVLab/InternVL3-78B-TEE","Qwen/Qwen2.5-72B-Instruct","Qwen/Qwen2.5-Coder-32B-Instruct","Qwen/Qwen2.5-VL-32B-Instruct","Qwen/Qwen2.5-VL-72B-Instruct-TEE","Qwen/Qwen3-14B","Qwen/Qwen3-235B-A22B","Qwen/Qwen3-235B-A22B-Instruct-2507-TEE","Qwen/Qwen3-235B-A22B-Thinking-2507","Qwen/Qwen3-30B-A3B","Qwen/Qwen3-30B-A3B-Instruct-2507","Qwen/Qwen3-32B","Qwen/Qwen3-Coder-480B-A35B-Instruct-FP8-TEE","Qwen/Qwen3-Next-80B-A3B-Instruct","Qwen/Qwen3-VL-235B-A22B-Instruct","Qwen/Qwen3Guard-Gen-0.6B","XiaomiMiMo/MiMo-V2-Flash","chutesai/Mistral-Small-3.1-24B-Instruct-2503","chutesai/Mistral-Small-3.2-24B-Instruct-2506","deepseek-ai/DeepSeek-R1-0528-TEE","deepseek-ai/DeepSeek-R1-Distill-Llama-70B","deepseek-ai/DeepSeek-R1-TEE","deepseek-ai/DeepSeek-V3","deepseek-ai/DeepSeek-V3-0324-TEE","deepseek-ai/DeepSeek-V3.1-TEE","deepseek-ai/DeepSeek-V3.1-Terminus-TEE","deepseek-ai/DeepSeek-V3.2-Speciale-TEE","deepseek-ai/DeepSeek-V3.2-TEE","miromind-ai/MiroThinker-v1.5-235B","mistralai/Devstral-2-123B-Instruct-2512","mistralai/Devstral-2-123B-Instruct-2512-TEE","moonshotai/Kimi-K2-Instruct-0905","moonshotai/Kimi-K2-Thinking-TEE","nvidia/NVIDIA-Nemotron-3-Nano-30B-A3B-BF16","openai/gpt-oss-120b-TEE","openai/gpt-oss-20b","rednote-hilab/dots.ocr","tngtech/DeepSeek-R1T-Chimera","tngtech/DeepSeek-TNG-R1T2-Chimera","tngtech/TNG-R1T-Chimera-TEE","unsloth/Mistral-Nemo-Instruct-2407","unsloth/Mistral-Small-24B-Instruct-2501","unsloth/gemma-3-12b-it","unsloth/gemma-3-27b-it","unsloth/gemma-3-4b-it","zai-org/GLM-4.5-Air","zai-org/GLM-4.5-TEE","zai-org/GLM-4.6-TEE","zai-org/GLM-4.6V","zai-org/GLM-4.7-TEE"],"kimi-for-coding":["kimi-k2-thinking"],cortecs:["claude-4-5-sonnet","claude-sonnet-4","deepseek-v3-0324","devstral-2512","devstral-small-2512","gemini-2.5-pro","gpt-4.1","gpt-oss-120b","intellect-3","kimi-k2-instruct","kimi-k2-thinking","llama-3.1-405b-instruct","nova-pro-v1","qwen3-32b","qwen3-coder-480b-a35b-instruct","qwen3-next-80b-a3b-thinking"],"github-models":["ai21-labs/ai21-jamba-1.5-large","ai21-labs/ai21-jamba-1.5-mini","cohere/cohere-command-a","cohere/cohere-command-r","cohere/cohere-command-r-08-2024","cohere/cohere-command-r-plus","cohere/cohere-command-r-plus-08-2024","core42/jais-30b-chat","deepseek/deepseek-r1","deepseek/deepseek-r1-0528","deepseek/deepseek-v3-0324","meta/llama-3.2-11b-vision-instruct","meta/llama-3.2-90b-vision-instruct","meta/llama-3.3-70b-instruct","meta/llama-4-maverick-17b-128e-instruct-fp8","meta/llama-4-scout-17b-16e-instruct","meta/meta-llama-3-70b-instruct","meta/meta-llama-3-8b-instruct","meta/meta-llama-3.1-405b-instruct","meta/meta-llama-3.1-70b-instruct","meta/meta-llama-3.1-8b-instruct","microsoft/mai-ds-r1","microsoft/phi-3-medium-128k-instruct","microsoft/phi-3-medium-4k-instruct","microsoft/phi-3-mini-128k-instruct","microsoft/phi-3-mini-4k-instruct","microsoft/phi-3-small-128k-instruct","microsoft/phi-3-small-8k-instruct","microsoft/phi-3.5-mini-instruct","microsoft/phi-3.5-moe-instruct","microsoft/phi-3.5-vision-instruct","microsoft/phi-4","microsoft/phi-4-mini-instruct","microsoft/phi-4-mini-reasoning","microsoft/phi-4-multimodal-instruct","microsoft/phi-4-reasoning","mistral-ai/codestral-2501","mistral-ai/ministral-3b","mistral-ai/mistral-large-2411","mistral-ai/mistral-medium-2505","mistral-ai/mistral-nemo","mistral-ai/mistral-small-2503","openai/gpt-4.1","openai/gpt-4.1-mini","openai/gpt-4.1-nano","openai/gpt-4o","openai/gpt-4o-mini","openai/o1","openai/o1-mini","openai/o1-preview","openai/o3","openai/o3-mini","openai/o4-mini","xai/grok-3","xai/grok-3-mini"],togetherai:["Qwen/Qwen3-Coder-480B-A35B-Instruct-FP8","deepseek-ai/DeepSeek-R1","deepseek-ai/DeepSeek-V3","deepseek-ai/DeepSeek-V3-1","essentialai/Rnj-1-Instruct","meta-llama/Llama-3.3-70B-Instruct-Turbo","moonshotai/Kimi-K2-Instruct","moonshotai/Kimi-K2-Thinking","openai/gpt-oss-120b","zai-org/GLM-4.6"],baseten:["Qwen/Qwen3-Coder-480B-A35B-Instruct","deepseek-ai/DeepSeek-V3.2","moonshotai/Kimi-K2-Instruct-0905","moonshotai/Kimi-K2-Thinking","zai-org/GLM-4.6","zai-org/GLM-4.7"],siliconflow:["ByteDance-Seed/Seed-OSS-36B-Instruct","MiniMaxAI/MiniMax-M1-80k","MiniMaxAI/MiniMax-M2","Qwen/QwQ-32B","Qwen/Qwen2.5-14B-Instruct","Qwen/Qwen2.5-32B-Instruct","Qwen/Qwen2.5-72B-Instruct","Qwen/Qwen2.5-72B-Instruct-128K","Qwen/Qwen2.5-7B-Instruct","Qwen/Qwen2.5-Coder-32B-Instruct","Qwen/Qwen2.5-VL-32B-Instruct","Qwen/Qwen2.5-VL-72B-Instruct","Qwen/Qwen2.5-VL-7B-Instruct","Qwen/Qwen3-14B","Qwen/Qwen3-235B-A22B","Qwen/Qwen3-235B-A22B-Instruct-2507","Qwen/Qwen3-235B-A22B-Thinking-2507","Qwen/Qwen3-30B-A3B","Qwen/Qwen3-30B-A3B-Instruct-2507","Qwen/Qwen3-30B-A3B-Thinking-2507","Qwen/Qwen3-32B","Qwen/Qwen3-8B","Qwen/Qwen3-Coder-30B-A3B-Instruct","Qwen/Qwen3-Coder-480B-A35B-Instruct","Qwen/Qwen3-Next-80B-A3B-Instruct","Qwen/Qwen3-Next-80B-A3B-Thinking","Qwen/Qwen3-Omni-30B-A3B-Captioner","Qwen/Qwen3-Omni-30B-A3B-Instruct","Qwen/Qwen3-Omni-30B-A3B-Thinking","Qwen/Qwen3-VL-235B-A22B-Instruct","Qwen/Qwen3-VL-235B-A22B-Thinking","Qwen/Qwen3-VL-30B-A3B-Instruct","Qwen/Qwen3-VL-30B-A3B-Thinking","Qwen/Qwen3-VL-32B-Instruct","Qwen/Qwen3-VL-32B-Thinking","Qwen/Qwen3-VL-8B-Instruct","Qwen/Qwen3-VL-8B-Thinking","THUDM/GLM-4-32B-0414","THUDM/GLM-4-9B-0414","THUDM/GLM-4.1V-9B-Thinking","THUDM/GLM-Z1-32B-0414","THUDM/GLM-Z1-9B-0414","baidu/ERNIE-4.5-300B-A47B","deepseek-ai/DeepSeek-R1","deepseek-ai/DeepSeek-R1-Distill-Qwen-14B","deepseek-ai/DeepSeek-R1-Distill-Qwen-32B","deepseek-ai/DeepSeek-R1-Distill-Qwen-7B","deepseek-ai/DeepSeek-V3","deepseek-ai/DeepSeek-V3.1","deepseek-ai/DeepSeek-V3.1-Terminus","deepseek-ai/DeepSeek-V3.2","deepseek-ai/DeepSeek-V3.2-Exp","deepseek-ai/deepseek-vl2","inclusionAI/Ling-flash-2.0","inclusionAI/Ling-mini-2.0","inclusionAI/Ring-flash-2.0","meta-llama/Meta-Llama-3.1-8B-Instruct","moonshotai/Kimi-Dev-72B","moonshotai/Kimi-K2-Instruct","moonshotai/Kimi-K2-Instruct-0905","moonshotai/Kimi-K2-Thinking","nex-agi/DeepSeek-V3.1-Nex-N1","openai/gpt-oss-120b","openai/gpt-oss-20b","stepfun-ai/step3","tencent/Hunyuan-A13B-Instruct","tencent/Hunyuan-MT-7B","zai-org/GLM-4.5","zai-org/GLM-4.5-Air","zai-org/GLM-4.5V","zai-org/GLM-4.6","zai-org/GLM-4.6V","zai-org/GLM-4.7"],helicone:["chatgpt-4o-latest","claude-3-haiku-20240307","claude-3.5-haiku","claude-3.5-sonnet-v2","claude-3.7-sonnet","claude-4.5-haiku","claude-4.5-opus","claude-4.5-sonnet","claude-haiku-4-5-20251001","claude-opus-4","claude-opus-4-1","claude-opus-4-1-20250805","claude-sonnet-4","claude-sonnet-4-5-20250929","codex-mini-latest","deepseek-r1-distill-llama-70b","deepseek-reasoner","deepseek-tng-r1t2-chimera","deepseek-v3","deepseek-v3.1-terminus","deepseek-v3.2","ernie-4.5-21b-a3b-thinking","gemini-2.5-flash","gemini-2.5-flash-lite","gemini-2.5-pro","gemini-3-pro-preview","gemma-3-12b-it","gemma2-9b-it","glm-4.6","gpt-4.1","gpt-4.1-mini","gpt-4.1-mini-2025-04-14","gpt-4.1-nano","gpt-4o","gpt-4o-mini","gpt-5","gpt-5-chat-latest","gpt-5-codex","gpt-5-mini","gpt-5-nano","gpt-5-pro","gpt-5.1","gpt-5.1-chat-latest","gpt-5.1-codex","gpt-5.1-codex-mini","gpt-oss-120b","gpt-oss-20b","grok-3","grok-3-mini","grok-4","grok-4-1-fast-non-reasoning","grok-4-1-fast-reasoning","grok-4-fast-non-reasoning","grok-4-fast-reasoning","grok-code-fast-1","hermes-2-pro-llama-3-8b","kimi-k2-0711","kimi-k2-0905","kimi-k2-thinking","llama-3.1-8b-instant","llama-3.1-8b-instruct","llama-3.1-8b-instruct-turbo","llama-3.3-70b-instruct","llama-3.3-70b-versatile","llama-4-maverick","llama-4-scout","llama-guard-4","llama-prompt-guard-2-22m","llama-prompt-guard-2-86m","mistral-large-2411","mistral-nemo","mistral-small","o1","o1-mini","o3","o3-mini","o3-pro","o4-mini","qwen2.5-coder-7b-fast","qwen3-235b-a22b-thinking","qwen3-30b-a3b","qwen3-32b","qwen3-coder","qwen3-coder-30b-a3b-instruct","qwen3-next-80b-a3b-instruct","qwen3-vl-235b-a22b-instruct","sonar","sonar-deep-research","sonar-pro","sonar-reasoning","sonar-reasoning-pro"],huggingface:["MiniMaxAI/MiniMax-M2.1","Qwen/Qwen3-235B-A22B-Thinking-2507","Qwen/Qwen3-Coder-480B-A35B-Instruct","Qwen/Qwen3-Embedding-4B","Qwen/Qwen3-Embedding-8B","Qwen/Qwen3-Next-80B-A3B-Instruct","Qwen/Qwen3-Next-80B-A3B-Thinking","XiaomiMiMo/MiMo-V2-Flash","deepseek-ai/DeepSeek-R1-0528","deepseek-ai/DeepSeek-V3.2","moonshotai/Kimi-K2-Instruct","moonshotai/Kimi-K2-Instruct-0905","moonshotai/Kimi-K2-Thinking","zai-org/GLM-4.7","zai-org/GLM-4.7-Flash"],opencode:["alpha-gd4","alpha-glm-4.7","big-pickle","claude-3-5-haiku","claude-haiku-4-5","claude-opus-4-1","claude-opus-4-5","claude-sonnet-4","claude-sonnet-4-5","gemini-3-flash","gemini-3-pro","glm-4.6","glm-4.7-free","gpt-5","gpt-5-codex","gpt-5-nano","gpt-5.1","gpt-5.1-codex","gpt-5.1-codex-max","gpt-5.1-codex-mini","gpt-5.2","gpt-5.2-codex","grok-code","kimi-k2","kimi-k2-thinking","minimax-m2.1-free","qwen3-coder"],fastrouter:["anthropic/claude-opus-4.1","anthropic/claude-sonnet-4","deepseek-ai/deepseek-r1-distill-llama-70b","google/gemini-2.5-flash","google/gemini-2.5-pro","moonshotai/kimi-k2","openai/gpt-4.1","openai/gpt-5","openai/gpt-5-mini","openai/gpt-5-nano","openai/gpt-oss-120b","openai/gpt-oss-20b","qwen/qwen3-coder","x-ai/grok-4"],minimax:["MiniMax-M2","MiniMax-M2.1"],google:["gemini-1.5-flash","gemini-1.5-flash-8b","gemini-1.5-pro","gemini-2.0-flash","gemini-2.0-flash-lite","gemini-2.5-flash","gemini-2.5-flash-image","gemini-2.5-flash-image-preview","gemini-2.5-flash-lite","gemini-2.5-flash-lite-preview-06-17","gemini-2.5-flash-lite-preview-09-2025","gemini-2.5-flash-preview-04-17","gemini-2.5-flash-preview-05-20","gemini-2.5-flash-preview-09-2025","gemini-2.5-flash-preview-tts","gemini-2.5-pro","gemini-2.5-pro-preview-05-06","gemini-2.5-pro-preview-06-05","gemini-2.5-pro-preview-tts","gemini-3-flash-preview","gemini-3-pro-preview","gemini-embedding-001","gemini-flash-latest","gemini-flash-lite-latest","gemini-live-2.5-flash","gemini-live-2.5-flash-preview-native-audio"],inception:["mercury","mercury-coder"],wandb:["Qwen/Qwen3-235B-A22B-Instruct-2507","Qwen/Qwen3-235B-A22B-Thinking-2507","Qwen/Qwen3-Coder-480B-A35B-Instruct","deepseek-ai/DeepSeek-R1-0528","deepseek-ai/DeepSeek-V3-0324","meta-llama/Llama-3.1-8B-Instruct","meta-llama/Llama-3.3-70B-Instruct","meta-llama/Llama-4-Scout-17B-16E-Instruct","microsoft/Phi-4-mini-instruct","moonshotai/Kimi-K2-Instruct"],"cloudflare-ai-gateway":["anthropic/claude-3-5-haiku","anthropic/claude-3-haiku","anthropic/claude-3-opus","anthropic/claude-3-sonnet","anthropic/claude-3.5-haiku","anthropic/claude-3.5-sonnet","anthropic/claude-haiku-4-5","anthropic/claude-opus-4","anthropic/claude-opus-4-1","anthropic/claude-opus-4-5","anthropic/claude-sonnet-4","anthropic/claude-sonnet-4-5","openai/gpt-3.5-turbo","openai/gpt-4","openai/gpt-4-turbo","openai/gpt-4o","openai/gpt-4o-mini","openai/gpt-5.1","openai/gpt-5.1-codex","openai/gpt-5.2","openai/o1","openai/o3","openai/o3-mini","openai/o3-pro","openai/o4-mini","workers-ai/@cf/ai4bharat/indictrans2-en-indic-1B","workers-ai/@cf/aisingapore/gemma-sea-lion-v4-27b-it","workers-ai/@cf/baai/bge-base-en-v1.5","workers-ai/@cf/baai/bge-large-en-v1.5","workers-ai/@cf/baai/bge-m3","workers-ai/@cf/baai/bge-reranker-base","workers-ai/@cf/baai/bge-small-en-v1.5","workers-ai/@cf/deepgram/aura-2-en","workers-ai/@cf/deepgram/aura-2-es","workers-ai/@cf/deepgram/nova-3","workers-ai/@cf/deepseek-ai/deepseek-r1-distill-qwen-32b","workers-ai/@cf/facebook/bart-large-cnn","workers-ai/@cf/google/gemma-3-12b-it","workers-ai/@cf/huggingface/distilbert-sst-2-int8","workers-ai/@cf/ibm-granite/granite-4.0-h-micro","workers-ai/@cf/meta/llama-2-7b-chat-fp16","workers-ai/@cf/meta/llama-3-8b-instruct","workers-ai/@cf/meta/llama-3-8b-instruct-awq","workers-ai/@cf/meta/llama-3.1-8b-instruct","workers-ai/@cf/meta/llama-3.1-8b-instruct-awq","workers-ai/@cf/meta/llama-3.1-8b-instruct-fp8","workers-ai/@cf/meta/llama-3.2-11b-vision-instruct","workers-ai/@cf/meta/llama-3.2-1b-instruct","workers-ai/@cf/meta/llama-3.2-3b-instruct","workers-ai/@cf/meta/llama-3.3-70b-instruct-fp8-fast","workers-ai/@cf/meta/llama-4-scout-17b-16e-instruct","workers-ai/@cf/meta/llama-guard-3-8b","workers-ai/@cf/meta/m2m100-1.2b","workers-ai/@cf/mistral/mistral-7b-instruct-v0.1","workers-ai/@cf/mistralai/mistral-small-3.1-24b-instruct","workers-ai/@cf/myshell-ai/melotts","workers-ai/@cf/openai/gpt-oss-120b","workers-ai/@cf/openai/gpt-oss-20b","workers-ai/@cf/pfnet/plamo-embedding-1b","workers-ai/@cf/pipecat-ai/smart-turn-v2","workers-ai/@cf/qwen/qwen2.5-coder-32b-instruct","workers-ai/@cf/qwen/qwen3-30b-a3b-fp8","workers-ai/@cf/qwen/qwen3-embedding-0.6b","workers-ai/@cf/qwen/qwq-32b"],openai:["codex-mini-latest","gpt-3.5-turbo","gpt-4","gpt-4-turbo","gpt-4.1","gpt-4.1-mini","gpt-4.1-nano","gpt-4o","gpt-4o-2024-05-13","gpt-4o-2024-08-06","gpt-4o-2024-11-20","gpt-4o-mini","gpt-5","gpt-5-chat-latest","gpt-5-codex","gpt-5-mini","gpt-5-nano","gpt-5-pro","gpt-5.1","gpt-5.1-chat-latest","gpt-5.1-codex","gpt-5.1-codex-max","gpt-5.1-codex-mini","gpt-5.2","gpt-5.2-chat-latest","gpt-5.2-codex","gpt-5.2-pro","o1","o1-mini","o1-preview","o1-pro","o3","o3-deep-research","o3-mini","o3-pro","o4-mini","o4-mini-deep-research","text-embedding-3-large","text-embedding-3-small","text-embedding-ada-002"],"zhipuai-coding-plan":["glm-4.5","glm-4.5-air","glm-4.5-flash","glm-4.5v","glm-4.6","glm-4.6v","glm-4.6v-flash","glm-4.7"],"minimax-cn":["MiniMax-M2","MiniMax-M2.1"],perplexity:["sonar","sonar-pro","sonar-reasoning-pro"],openrouter:["anthropic/claude-3.5-haiku","anthropic/claude-3.7-sonnet","anthropic/claude-haiku-4.5","anthropic/claude-opus-4","anthropic/claude-opus-4.1","anthropic/claude-opus-4.5","anthropic/claude-sonnet-4","anthropic/claude-sonnet-4.5","cognitivecomputations/dolphin3.0-mistral-24b","cognitivecomputations/dolphin3.0-r1-mistral-24b","deepseek/deepseek-chat-v3-0324","deepseek/deepseek-chat-v3.1","deepseek/deepseek-r1-0528-qwen3-8b:free","deepseek/deepseek-r1-0528:free","deepseek/deepseek-r1-distill-llama-70b","deepseek/deepseek-r1-distill-qwen-14b","deepseek/deepseek-r1:free","deepseek/deepseek-v3-base:free","deepseek/deepseek-v3.1-terminus","deepseek/deepseek-v3.1-terminus:exacto","deepseek/deepseek-v3.2","deepseek/deepseek-v3.2-speciale","featherless/qwerky-72b","google/gemini-2.0-flash-001","google/gemini-2.0-flash-exp:free","google/gemini-2.5-flash","google/gemini-2.5-flash-lite","google/gemini-2.5-flash-lite-preview-09-2025","google/gemini-2.5-flash-preview-09-2025","google/gemini-2.5-pro","google/gemini-2.5-pro-preview-05-06","google/gemini-2.5-pro-preview-06-05","google/gemini-3-flash-preview","google/gemini-3-pro-preview","google/gemma-2-9b-it:free","google/gemma-3-12b-it","google/gemma-3-27b-it","google/gemma-3n-e4b-it","google/gemma-3n-e4b-it:free","kwaipilot/kat-coder-pro:free","meta-llama/llama-3.2-11b-vision-instruct","meta-llama/llama-3.3-70b-instruct:free","meta-llama/llama-4-scout:free","microsoft/mai-ds-r1:free","minimax/minimax-01","minimax/minimax-m1","minimax/minimax-m2","minimax/minimax-m2.1","mistralai/codestral-2508","mistralai/devstral-2512","mistralai/devstral-2512:free","mistralai/devstral-medium-2507","mistralai/devstral-small-2505","mistralai/devstral-small-2505:free","mistralai/devstral-small-2507","mistralai/mistral-7b-instruct:free","mistralai/mistral-medium-3","mistralai/mistral-medium-3.1","mistralai/mistral-nemo:free","mistralai/mistral-small-3.1-24b-instruct","mistralai/mistral-small-3.2-24b-instruct","mistralai/mistral-small-3.2-24b-instruct:free","moonshotai/kimi-dev-72b:free","moonshotai/kimi-k2","moonshotai/kimi-k2-0905","moonshotai/kimi-k2-0905:exacto","moonshotai/kimi-k2-thinking","moonshotai/kimi-k2:free","nousresearch/deephermes-3-llama-3-8b-preview","nousresearch/hermes-4-405b","nousresearch/hermes-4-70b","nvidia/nemotron-nano-9b-v2","openai/gpt-4.1","openai/gpt-4.1-mini","openai/gpt-4o-mini","openai/gpt-5","openai/gpt-5-chat","openai/gpt-5-codex","openai/gpt-5-image","openai/gpt-5-mini","openai/gpt-5-nano","openai/gpt-5-pro","openai/gpt-5.1","openai/gpt-5.1-chat","openai/gpt-5.1-codex","openai/gpt-5.1-codex-max","openai/gpt-5.1-codex-mini","openai/gpt-5.2","openai/gpt-5.2-chat-latest","openai/gpt-5.2-codex","openai/gpt-5.2-pro","openai/gpt-oss-120b","openai/gpt-oss-120b:exacto","openai/gpt-oss-20b","openai/gpt-oss-safeguard-20b","openai/o4-mini","openrouter/sherlock-dash-alpha","openrouter/sherlock-think-alpha","qwen/qwen-2.5-coder-32b-instruct","qwen/qwen2.5-vl-32b-instruct:free","qwen/qwen2.5-vl-72b-instruct","qwen/qwen2.5-vl-72b-instruct:free","qwen/qwen3-14b:free","qwen/qwen3-235b-a22b-07-25","qwen/qwen3-235b-a22b-07-25:free","qwen/qwen3-235b-a22b-thinking-2507","qwen/qwen3-235b-a22b:free","qwen/qwen3-30b-a3b-instruct-2507","qwen/qwen3-30b-a3b-thinking-2507","qwen/qwen3-30b-a3b:free","qwen/qwen3-32b:free","qwen/qwen3-8b:free","qwen/qwen3-coder","qwen/qwen3-coder-30b-a3b-instruct","qwen/qwen3-coder-flash","qwen/qwen3-coder:exacto","qwen/qwen3-coder:free","qwen/qwen3-max","qwen/qwen3-next-80b-a3b-instruct","qwen/qwen3-next-80b-a3b-thinking","qwen/qwq-32b:free","rekaai/reka-flash-3","sarvamai/sarvam-m:free","thudm/glm-z1-32b:free","tngtech/deepseek-r1t2-chimera:free","x-ai/grok-3","x-ai/grok-3-beta","x-ai/grok-3-mini","x-ai/grok-3-mini-beta","x-ai/grok-4","x-ai/grok-4-fast","x-ai/grok-4.1-fast","x-ai/grok-code-fast-1","z-ai/glm-4.5","z-ai/glm-4.5-air","z-ai/glm-4.5-air:free","z-ai/glm-4.5v","z-ai/glm-4.6","z-ai/glm-4.6:exacto","z-ai/glm-4.7"],zenmux:["anthropic/claude-haiku-4.5","anthropic/claude-opus-4","anthropic/claude-opus-4.1","anthropic/claude-opus-4.5","anthropic/claude-sonnet-4","anthropic/claude-sonnet-4.5","baidu/ernie-5.0-thinking-preview","deepseek/deepseek-chat","deepseek/deepseek-reasoner","deepseek/deepseek-v3.2","deepseek/deepseek-v3.2-exp","google/gemini-2.5-flash","google/gemini-2.5-flash-lite","google/gemini-2.5-pro","google/gemini-3-flash-preview","google/gemini-3-flash-preview-free","google/gemini-3-pro-preview","inclusionai/ling-1t","inclusionai/ring-1t","kuaishou/kat-coder-pro-v1","kuaishou/kat-coder-pro-v1-free","minimax/minimax-m2","minimax/minimax-m2.1","moonshotai/kimi-k2-0905","moonshotai/kimi-k2-thinking","moonshotai/kimi-k2-thinking-turbo","openai/gpt-5","openai/gpt-5-codex","openai/gpt-5.1","openai/gpt-5.1-chat","openai/gpt-5.1-codex","openai/gpt-5.1-codex-mini","openai/gpt-5.2","qwen/qwen3-coder-plus","stepfun/step-3","volcengine/doubao-seed-1.8","volcengine/doubao-seed-code","x-ai/grok-4","x-ai/grok-4-fast","x-ai/grok-4.1-fast","x-ai/grok-4.1-fast-non-reasoning","x-ai/grok-code-fast-1","xiaomi/mimo-v2-flash","xiaomi/mimo-v2-flash-free","z-ai/glm-4.5","z-ai/glm-4.5-air","z-ai/glm-4.6","z-ai/glm-4.6v","z-ai/glm-4.6v-flash","z-ai/glm-4.6v-flash-free","z-ai/glm-4.7"],ovhcloud:["deepseek-r1-distill-llama-70b","gpt-oss-120b","gpt-oss-20b","llama-3.1-8b-instruct","llava-next-mistral-7b","meta-llama-3_1-70b-instruct","meta-llama-3_3-70b-instruct","mistral-7b-instruct-v0.3","mistral-nemo-instruct-2407","mistral-small-3.2-24b-instruct-2506","mixtral-8x7b-instruct-v0.1","qwen2.5-coder-32b-instruct","qwen2.5-vl-72b-instruct","qwen3-32b","qwen3-coder-30b-a3b-instruct"],iflowcn:["deepseek-r1","deepseek-v3","deepseek-v3.2","glm-4.6","kimi-k2","kimi-k2-0905","qwen3-235b","qwen3-235b-a22b-instruct","qwen3-235b-a22b-thinking-2507","qwen3-32b","qwen3-coder-plus","qwen3-max","qwen3-max-preview","qwen3-vl-plus"],synthetic:["hf:MiniMaxAI/MiniMax-M2","hf:MiniMaxAI/MiniMax-M2.1","hf:Qwen/Qwen2.5-Coder-32B-Instruct","hf:Qwen/Qwen3-235B-A22B-Instruct-2507","hf:Qwen/Qwen3-235B-A22B-Thinking-2507","hf:Qwen/Qwen3-Coder-480B-A35B-Instruct","hf:deepseek-ai/DeepSeek-R1","hf:deepseek-ai/DeepSeek-R1-0528","hf:deepseek-ai/DeepSeek-V3","hf:deepseek-ai/DeepSeek-V3-0324","hf:deepseek-ai/DeepSeek-V3.1","hf:deepseek-ai/DeepSeek-V3.1-Terminus","hf:deepseek-ai/DeepSeek-V3.2","hf:meta-llama/Llama-3.1-405B-Instruct","hf:meta-llama/Llama-3.1-70B-Instruct","hf:meta-llama/Llama-3.1-8B-Instruct","hf:meta-llama/Llama-3.3-70B-Instruct","hf:meta-llama/Llama-4-Maverick-17B-128E-Instruct-FP8","hf:meta-llama/Llama-4-Scout-17B-16E-Instruct","hf:moonshotai/Kimi-K2-Instruct-0905","hf:moonshotai/Kimi-K2-Thinking","hf:openai/gpt-oss-120b","hf:zai-org/GLM-4.5","hf:zai-org/GLM-4.6","hf:zai-org/GLM-4.7"],deepinfra:["MiniMaxAI/MiniMax-M2","MiniMaxAI/MiniMax-M2.1","Qwen/Qwen3-Coder-480B-A35B-Instruct","Qwen/Qwen3-Coder-480B-A35B-Instruct-Turbo","moonshotai/Kimi-K2-Instruct","moonshotai/Kimi-K2-Thinking","openai/gpt-oss-120b","openai/gpt-oss-20b","zai-org/GLM-4.7"],zhipuai:["glm-4.5","glm-4.5-air","glm-4.5-flash","glm-4.5v","glm-4.6","glm-4.6v","glm-4.6v-flash","glm-4.7"],submodel:["Qwen/Qwen3-235B-A22B-Instruct-2507","Qwen/Qwen3-235B-A22B-Thinking-2507","Qwen/Qwen3-Coder-480B-A35B-Instruct-FP8","deepseek-ai/DeepSeek-R1-0528","deepseek-ai/DeepSeek-V3-0324","deepseek-ai/DeepSeek-V3.1","openai/gpt-oss-120b","zai-org/GLM-4.5-Air","zai-org/GLM-4.5-FP8"],"nano-gpt":["deepseek/deepseek-r1","deepseek/deepseek-v3.2:thinking","meta-llama/llama-3.3-70b-instruct","meta-llama/llama-4-maverick","minimax/minimax-m2.1","mistralai/devstral-2-123b-instruct-2512","mistralai/ministral-14b-instruct-2512","mistralai/mistral-large-3-675b-instruct-2512","moonshotai/kimi-k2-instruct","moonshotai/kimi-k2-thinking","nousresearch/hermes-4-405b:thinking","nvidia/llama-3_3-nemotron-super-49b-v1_5","openai/gpt-oss-120b","qwen/qwen3-235b-a22b-thinking-2507","qwen/qwen3-coder","z-ai/glm-4.6","z-ai/glm-4.6:thinking","zai-org/glm-4.5-air","zai-org/glm-4.5-air:thinking","zai-org/glm-4.7","zai-org/glm-4.7:thinking"],zai:["glm-4.5","glm-4.5-air","glm-4.5-flash","glm-4.5v","glm-4.6","glm-4.6v","glm-4.7"],inference:["google/gemma-3","meta/llama-3.1-8b-instruct","meta/llama-3.2-11b-vision-instruct","meta/llama-3.2-1b-instruct","meta/llama-3.2-3b-instruct","mistral/mistral-nemo-12b-instruct","osmosis/osmosis-structure-0.6b","qwen/qwen-2.5-7b-vision-instruct","qwen/qwen3-embedding-4b"],requesty:["anthropic/claude-3-7-sonnet","anthropic/claude-haiku-4-5","anthropic/claude-opus-4","anthropic/claude-opus-4-1","anthropic/claude-opus-4-5","anthropic/claude-sonnet-4","anthropic/claude-sonnet-4-5","google/gemini-2.5-flash","google/gemini-2.5-pro","google/gemini-3-flash-preview","google/gemini-3-pro-preview","openai/gpt-4.1","openai/gpt-4.1-mini","openai/gpt-4o-mini","openai/gpt-5","openai/gpt-5-mini","openai/gpt-5-nano","openai/o4-mini","xai/grok-4","xai/grok-4-fast"],morph:["auto","morph-v3-fast","morph-v3-large"],lmstudio:["openai/gpt-oss-20b","qwen/qwen3-30b-a3b-2507","qwen/qwen3-coder-30b"],friendli:["LGAI-EXAONE/EXAONE-4.0.1-32B","LGAI-EXAONE/K-EXAONE-236B-A23B","Qwen/Qwen3-235B-A22B-Instruct-2507","Qwen/Qwen3-235B-A22B-Thinking-2507","Qwen/Qwen3-30B-A3B","Qwen/Qwen3-32B","meta-llama-3.1-8b-instruct","meta-llama-3.3-70b-instruct","meta-llama/Llama-4-Maverick-17B-128E-Instruct","meta-llama/Llama-4-Scout-17B-16E-Instruct","zai-org/GLM-4.6"],anthropic:["claude-3-5-haiku-20241022","claude-3-5-haiku-latest","claude-3-5-sonnet-20240620","claude-3-5-sonnet-20241022","claude-3-7-sonnet-20250219","claude-3-7-sonnet-latest","claude-3-haiku-20240307","claude-3-opus-20240229","claude-3-sonnet-20240229","claude-haiku-4-5","claude-haiku-4-5-20251001","claude-opus-4-0","claude-opus-4-1","claude-opus-4-1-20250805","claude-opus-4-20250514","claude-opus-4-5","claude-opus-4-5-20251101","claude-sonnet-4-0","claude-sonnet-4-20250514","claude-sonnet-4-5","claude-sonnet-4-5-20250929"],"fireworks-ai":["accounts/fireworks/models/deepseek-r1-0528","accounts/fireworks/models/deepseek-v3-0324","accounts/fireworks/models/deepseek-v3p1","accounts/fireworks/models/deepseek-v3p2","accounts/fireworks/models/glm-4p5","accounts/fireworks/models/glm-4p5-air","accounts/fireworks/models/glm-4p6","accounts/fireworks/models/glm-4p7","accounts/fireworks/models/gpt-oss-120b","accounts/fireworks/models/gpt-oss-20b","accounts/fireworks/models/kimi-k2-instruct","accounts/fireworks/models/kimi-k2-thinking","accounts/fireworks/models/minimax-m2","accounts/fireworks/models/minimax-m2p1","accounts/fireworks/models/qwen3-235b-a22b","accounts/fireworks/models/qwen3-coder-480b-a35b-instruct"],"io-net":["Intel/Qwen3-Coder-480B-A35B-Instruct-int4-mixed-ar","Qwen/Qwen2.5-VL-32B-Instruct","Qwen/Qwen3-235B-A22B-Thinking-2507","Qwen/Qwen3-Next-80B-A3B-Instruct","deepseek-ai/DeepSeek-R1-0528","meta-llama/Llama-3.2-90B-Vision-Instruct","meta-llama/Llama-3.3-70B-Instruct","meta-llama/Llama-4-Maverick-17B-128E-Instruct-FP8","mistralai/Devstral-Small-2505","mistralai/Magistral-Small-2506","mistralai/Mistral-Large-Instruct-2411","mistralai/Mistral-Nemo-Instruct-2407","moonshotai/Kimi-K2-Instruct-0905","moonshotai/Kimi-K2-Thinking","openai/gpt-oss-120b","openai/gpt-oss-20b","zai-org/GLM-4.6"],modelscope:["Qwen/Qwen3-235B-A22B-Instruct-2507","Qwen/Qwen3-235B-A22B-Thinking-2507","Qwen/Qwen3-30B-A3B-Instruct-2507","Qwen/Qwen3-30B-A3B-Thinking-2507","Qwen/Qwen3-Coder-30B-A3B-Instruct","ZhipuAI/GLM-4.5","ZhipuAI/GLM-4.6"],llama:["cerebras-llama-4-maverick-17b-128e-instruct","cerebras-llama-4-scout-17b-16e-instruct","groq-llama-4-maverick-17b-128e-instruct","llama-3.3-70b-instruct","llama-3.3-8b-instruct","llama-4-maverick-17b-128e-instruct-fp8","llama-4-scout-17b-16e-instruct-fp8"],scaleway:["bge-multilingual-gemma2","deepseek-r1-distill-llama-70b","devstral-2-123b-instruct-2512","gemma-3-27b-it","gpt-oss-120b","llama-3.1-8b-instruct","llama-3.3-70b-instruct","mistral-nemo-instruct-2407","mistral-small-3.2-24b-instruct-2506","pixtral-12b-2409","qwen3-235b-a22b-instruct-2507","qwen3-coder-30b-a3b-instruct","voxtral-small-24b-2507","whisper-large-v3"],poe:["anthropic/claude-haiku-3","anthropic/claude-haiku-3.5","anthropic/claude-haiku-3.5-search","anthropic/claude-haiku-4.5","anthropic/claude-opus-3","anthropic/claude-opus-4","anthropic/claude-opus-4-reasoning","anthropic/claude-opus-4-search","anthropic/claude-opus-4.1","anthropic/claude-opus-4.5","anthropic/claude-sonnet-3.5","anthropic/claude-sonnet-3.5-june","anthropic/claude-sonnet-3.7","anthropic/claude-sonnet-3.7-reasoning","anthropic/claude-sonnet-3.7-search","anthropic/claude-sonnet-4","anthropic/claude-sonnet-4-reasoning","anthropic/claude-sonnet-4-search","anthropic/claude-sonnet-4.5","cerebras/gpt-oss-120b-cs","cerebras/zai-glm-4.6-cs","elevenlabs/elevenlabs-music","elevenlabs/elevenlabs-v2.5-turbo","elevenlabs/elevenlabs-v3","google/gemini-2.0-flash","google/gemini-2.0-flash-lite","google/gemini-2.5-flash","google/gemini-2.5-flash-lite","google/gemini-2.5-pro","google/gemini-3-flash","google/gemini-3-pro","google/gemini-deep-research","google/imagen-3","google/imagen-3-fast","google/imagen-4","google/imagen-4-fast","google/imagen-4-ultra","google/lyria","google/nano-banana","google/nano-banana-pro","google/veo-2","google/veo-3","google/veo-3-fast","google/veo-3.1","google/veo-3.1-fast","ideogramai/ideogram","ideogramai/ideogram-v2","ideogramai/ideogram-v2a","ideogramai/ideogram-v2a-turbo","lumalabs/dream-machine","lumalabs/ray2","novita/glm-4.6","novita/glm-4.6v","novita/glm-4.7","novita/kat-coder-pro","novita/kimi-k2-thinking","novita/minimax-m2.1","openai/chatgpt-4o-latest","openai/dall-e-3","openai/gpt-3.5-turbo","openai/gpt-3.5-turbo-instruct","openai/gpt-3.5-turbo-raw","openai/gpt-4-classic","openai/gpt-4-classic-0314","openai/gpt-4-turbo","openai/gpt-4.1","openai/gpt-4.1-mini","openai/gpt-4.1-nano","openai/gpt-4o","openai/gpt-4o-aug","openai/gpt-4o-mini","openai/gpt-4o-mini-search","openai/gpt-4o-search","openai/gpt-5","openai/gpt-5-chat","openai/gpt-5-codex","openai/gpt-5-mini","openai/gpt-5-nano","openai/gpt-5-pro","openai/gpt-5.1","openai/gpt-5.1-codex","openai/gpt-5.1-codex-max","openai/gpt-5.1-codex-mini","openai/gpt-5.1-instant","openai/gpt-5.2","openai/gpt-5.2-instant","openai/gpt-5.2-pro","openai/gpt-image-1","openai/gpt-image-1-mini","openai/gpt-image-1.5","openai/o1","openai/o1-pro","openai/o3","openai/o3-deep-research","openai/o3-mini","openai/o3-mini-high","openai/o3-pro","openai/o4-mini","openai/o4-mini-deep-research","openai/sora-2","openai/sora-2-pro","poetools/claude-code","runwayml/runway","runwayml/runway-gen-4-turbo","stabilityai/stablediffusionxl","topazlabs-co/topazlabs","trytako/tako","xai/grok-3","xai/grok-3-mini","xai/grok-4","xai/grok-4-fast-non-reasoning","xai/grok-4-fast-reasoning","xai/grok-4.1-fast-non-reasoning","xai/grok-4.1-fast-reasoning","xai/grok-code-fast-1"],cerebras:["gpt-oss-120b","qwen-3-235b-a22b-instruct-2507","zai-glm-4.6","zai-glm-4.7"],netlify:["anthropic/claude-3-5-haiku-20241022","anthropic/claude-3-7-sonnet-20250219","anthropic/claude-3-haiku-20240307","anthropic/claude-haiku-4-5","anthropic/claude-haiku-4-5-20251001","anthropic/claude-opus-4-1-20250805","anthropic/claude-opus-4-20250514","anthropic/claude-opus-4-5","anthropic/claude-opus-4-5-20251101","anthropic/claude-sonnet-4-0","anthropic/claude-sonnet-4-20250514","anthropic/claude-sonnet-4-5","anthropic/claude-sonnet-4-5-20250929","gemini/gemini-2.0-flash","gemini/gemini-2.0-flash-lite","gemini/gemini-2.5-flash","gemini/gemini-2.5-flash-image","gemini/gemini-2.5-flash-image-preview","gemini/gemini-2.5-flash-lite","gemini/gemini-2.5-flash-lite-preview-09-2025","gemini/gemini-2.5-flash-preview-09-2025","gemini/gemini-2.5-pro","gemini/gemini-3-flash-preview","gemini/gemini-3-pro-image-preview","gemini/gemini-3-pro-preview","gemini/gemini-flash-latest","gemini/gemini-flash-lite-latest","openai/codex-mini-latest","openai/gpt-4.1","openai/gpt-4.1-mini","openai/gpt-4.1-nano","openai/gpt-4o","openai/gpt-4o-mini","openai/gpt-5","openai/gpt-5-2025-08-07","openai/gpt-5-codex","openai/gpt-5-mini","openai/gpt-5-mini-2025-08-07","openai/gpt-5-nano","openai/gpt-5-pro","openai/gpt-5.1","openai/gpt-5.1-2025-11-13","openai/gpt-5.1-codex","openai/gpt-5.1-codex-max","openai/gpt-5.1-codex-mini","openai/gpt-5.2","openai/gpt-5.2-2025-12-11","openai/gpt-5.2-codex","openai/gpt-5.2-pro","openai/gpt-5.2-pro-2025-12-11","openai/o3","openai/o3-mini","openai/o4-mini"]},version:"1.0.0"},cr=null,ca=()=>d8.default.join(d9.default.homedir(),".cache","mastra"),cs=()=>d8.default.join(ca(),"gateway-refresh-time"),cn=()=>d8.default.join(ca(),"provider-registry.json"),ci=()=>d8.default.join(ca(),"provider-types.generated.d.ts"),co=!1;function cl(e,t,r="utf-8"){let a=Math.random().toString(36).substring(2,15),s=`${e}.${process.pid}.${Date.now()}.${a}.tmp`;try{d6.default.writeFileSync(s,t,r),d6.default.renameSync(s,e)}catch(e){try{d6.default.unlinkSync(s)}catch{}throw e}}function cu(){try{if(!d6.default.existsSync(cs()))return null;let e=d6.default.readFileSync(cs(),"utf-8").trim();return new Date(parseInt(e,10))}catch(e){return console.warn("[GatewayRegistry] Failed to read cache file:",e),co=!0,null}}function cp(){try{let e=(0,d7.createRequire)(ce.url||"file://").resolve("@mastra/core/package.json");return d8.default.dirname(e)}catch{return process.cwd()}}function cd(e){if(!e)return ct;if(!function(){try{let e=d6.default.existsSync(cn()),t=d6.default.existsSync(ci());if(!e&&!t)return;let r=cp(),a=d8.default.join(r,"dist","provider-registry.json"),s=d8.default.join(r,"dist","llm","model","provider-types.generated.d.ts");if(d6.default.mkdirSync(d8.default.dirname(a),{recursive:!0}),d6.default.mkdirSync(d8.default.dirname(s),{recursive:!0}),e){let e=d6.default.readFileSync(cn(),"utf-8");try{JSON.parse(e)}catch{console.warn(`[GatewayRegistry] Detected corrupted global cache at ${cn()}. Deleting corrupted file.`);try{d6.default.unlinkSync(cn())}catch{}return}let t=!0;if(d6.default.existsSync(a)){let r=d6.default.readFileSync(a,"utf-8");t=e!==r}t&&cl(a,e,"utf-8")}if(t){let e=d6.default.readFileSync(ci(),"utf-8"),t=!0;if(d6.default.existsSync(s)){let r=d6.default.readFileSync(s,"utf-8");t=e!==r}t&&cl(s,e,"utf-8")}}catch(e){console.warn("Failed to sync global cache to local:",e)}}(),cr)return cr;let t=cp(),r=[d8.default.join(t,"dist","provider-registry.json"),d8.default.join(t,"src","llm","model","provider-registry.json"),d8.default.join(process.cwd(),"packages/core/src/llm/model/provider-registry.json"),d8.default.join(process.cwd(),"src/llm/model/provider-registry.json")],a=[];for(let e of r)try{let t=d6.default.readFileSync(e,"utf-8");return cr=JSON.parse(t)}catch(n){let t=n instanceof Error?n.message:String(n);a.push(`${e}: ${t}`);let r=n instanceof Error&&"code"in n&&"ENOENT"===n.code,s=n instanceof SyntaxError;if(!r&&s){console.warn(`[GatewayRegistry] Detected corrupted provider-registry.json at ${e}. Deleting corrupted file and falling back to static registry.`);try{d6.default.unlinkSync(e)}catch{}return cr=ct}continue}return console.warn(`[GatewayRegistry] Could not load provider registry from any path. Falling back to static registry.
Tried paths:
${a.join("\n")}`),cr=ct}var cc=new Proxy({},{get:(e,t)=>cm.getInstance().getProviders()[t],ownKeys:()=>Object.keys(cm.getInstance().getProviders()),has:(e,t)=>t in cm.getInstance().getProviders(),getOwnPropertyDescriptor(e,t){if(t in cm.getInstance().getProviders())return{enumerable:!0,configurable:!0}}});new Proxy({},{get:(e,t)=>cm.getInstance().getModels()[t],ownKeys:()=>Object.keys(cm.getInstance().getModels()),has:(e,t)=>t in cm.getInstance().getModels(),getOwnPropertyDescriptor(e,t){if(t in cm.getInstance().getModels())return{enumerable:!0,configurable:!0}}});var cm=class t{static instance=null;lastRefreshTime=null;refreshInterval=null;isRefreshing=!1;useDynamicLoading;customGateways=[];constructor(e={}){const t="true"===process.env.MASTRA_DEV||"1"===process.env.MASTRA_DEV;this.useDynamicLoading=e.useDynamicLoading??t}static getInstance(e){return t.instance||(t.instance=new t(e)),t.instance}registerCustomGateways(e){this.customGateways=e}getCustomGateways(){return this.customGateways}async syncGateways(t=!1,r=!1){if((this.useDynamicLoading||r)&&(!this.isRefreshing||t)){this.isRefreshing=!0;try{let{ModelsDevGateway:t}=await e.A(137172),{NetlifyGateway:s}=await e.A(782160),{fetchProvidersFromGateways:n,writeRegistryFiles:i}=await e.A(477724),o=[new t({}),new s,...this.customGateways],{providers:l,models:u}=await n(o),p=cp();try{d6.default.mkdirSync(ca(),{recursive:!0}),await i(cn(),ci(),l,u)}catch(e){console.warn("[GatewayRegistry] Failed to write to global cache:",e)}let d=d8.default.join(p,"dist","provider-registry.json"),c=d8.default.join(p,"dist","llm","model","provider-types.generated.d.ts");if(await i(d,c,l,u),r){let e=d8.default.join(p,"src","llm","model","provider-registry.json"),t=d8.default.join(p,"src","llm","model","provider-types.generated.d.ts");await d6.default.promises.copyFile(d,e),await d6.default.promises.copyFile(c,t)}this.useDynamicLoading&&(cr=null),this.lastRefreshTime=new Date;var a=this.lastRefreshTime;try{d6.default.existsSync(ca())||d6.default.mkdirSync(ca(),{recursive:!0}),d6.default.writeFileSync(cs(),a.getTime().toString(),"utf-8")}catch(e){co=!0,console.warn("[GatewayRegistry] Failed to write cache file:",e)}}catch(e){throw console.error("[GatewayRegistry]  Gateway sync failed:",e),e}finally{this.isRefreshing=!1}}}getLastRefreshTime(){return this.lastRefreshTime||cu()}startAutoRefresh(e=36e5){if(!this.useDynamicLoading||this.refreshInterval)return;let t=cu(),r=Date.now();!co&&(!t||r-t.getTime()>e)&&this.syncGateways().catch(e=>{console.error("[GatewayRegistry] Initial auto-refresh failed:",e)}),this.refreshInterval=setInterval(()=>{if(co&&this.refreshInterval){clearInterval(this.refreshInterval),this.refreshInterval=null;return}this.syncGateways().catch(e=>{console.error("[GatewayRegistry] Auto-refresh failed:",e)})},e),this.refreshInterval.unref&&this.refreshInterval.unref()}stopAutoRefresh(){this.refreshInterval&&(clearInterval(this.refreshInterval),this.refreshInterval=null)}getProviderConfig(e){return cd(this.useDynamicLoading).providers[e]}isProviderRegistered(e){return e in cd(this.useDynamicLoading).providers}getProviders(){return cd(this.useDynamicLoading).providers}getModels(){return cd(this.useDynamicLoading).models}},cg="true"===process.env.MASTRA_DEV||"1"===process.env.MASTRA_DEV;("true"===process.env.MASTRA_AUTO_REFRESH_PROVIDERS||"false"!==process.env.MASTRA_AUTO_REFRESH_PROVIDERS&&cg)&&cm.getInstance({useDynamicLoading:cg}).startAutoRefresh();var ch=e.i(132434),cf=e.i(10519),cy=e.i(759555),cv=e.i(363890),cb=class extends cv.WritableStream{prefix;callId;name;runId;writeFn;constructor({prefix:e,callId:t,name:r,runId:a},s){super({async write(e){await n._write(e)}});const n=this;this.prefix=e,this.callId=t,this.name=r,this.runId=a,this.writeFn=s}async _write(e){this.writeFn&&await this.writeFn({type:`${this.prefix}-output`,runId:this.runId,from:"USER",payload:{output:e,..."workflow-step"===this.prefix?{runId:this.runId,stepName:this.name}:{[`${this.prefix}CallId`]:this.callId,[`${this.prefix}Name`]:this.name}}})}async write(e){await this._write(e)}async custom(e){this.writeFn&&await this.writeFn(e)}},cw="mastra__resourceId",ck="mastra__threadId",c_=class{registry=new Map;constructor(e){this.registry=new Map(e)}set(e,t){this.registry.set(e,t)}get(e){return this.registry.get(e)}has(e){return this.registry.has(e)}delete(e){return this.registry.delete(e)}clear(){this.registry.clear()}keys(){return this.registry.keys()}values(){return this.registry.values()}entries(){return this.registry.entries()}size(){return this.registry.size}forEach(e){this.registry.forEach(e)}toJSON(){return Object.fromEntries(this.registry)}};function cI(e,t=200){try{let r=JSON.stringify(e,null,2);if(r.length<=t)return r;return r.slice(0,t)+"... (truncated)"}catch{return"[Unable to serialize data]"}}function cS(e,t,r){if(!e||!("safeParse"in e))return{data:t};let a=e.safeParse(t);if(a.success)return{data:a.data};let s=a.error.issues.map(e=>`- ${e.path?.join(".")||"root"}: ${e.message}`).join("\n"),n={error:!0,message:`Tool suspension data validation failed${r?` for ${r}`:""}. Please fix the following errors and try again:
${s}

Provided arguments: ${cI(t)}`,validationErrors:a.error.format()};return{data:t,error:n}}function cx(e,t,r){if(!e||!("safeParse"in e))return{data:t};let a=null!=t?t:p6(e)?[]:p7(e)?{}:t;a=function e(t){if(void 0===t)return null;if(null===t||"object"!=typeof t)return t;if(Array.isArray(t))return t.map(e);if(!function(e){if(null===e||"object"!=typeof e)return!1;let t=Object.getPrototypeOf(e);return t===Object.prototype||null===t}(t))return t;let r={};for(let[a,s]of Object.entries(t))r[a]=e(s);return r}(a);let s=e.safeParse(a);if(s.success)return{data:s.data};let n=s.error.issues.map(e=>`- ${e.path?.join(".")||"root"}: ${e.message}`).join("\n"),i={error:!0,message:`Tool input validation failed${r?` for ${r}`:""}. Please fix the following errors and try again:
${n}

Provided arguments: ${cI(t)}`,validationErrors:s.error.format()};return{data:t,error:i}}function cT(e,t,r,a){if(!e||!("safeParse"in e)||a)return{data:t};let s=e.safeParse(t);if(s.success)return{data:s.data};let n=s.error.issues.map(e=>`- ${e.path?.join(".")||"root"}: ${e.message}`).join("\n"),i={error:!0,message:`Tool output validation failed${r?` for ${r}`:""}. The tool returned invalid output:
${n}

Returned output: ${cI(t)}`,validationErrors:s.error.format()};return{data:t,error:i}}var cE=class{id;description;inputSchema;outputSchema;suspendSchema;resumeSchema;execute;mastra;requireApproval;providerOptions;mcp;constructor(e){if(this.id=e.id,this.description=e.description,this.inputSchema=e.inputSchema,this.outputSchema=e.outputSchema,this.suspendSchema=e.suspendSchema,this.resumeSchema=e.resumeSchema,this.mastra=e.mastra,this.requireApproval=e.requireApproval||!1,this.providerOptions=e.providerOptions,this.mcp=e.mcp,e.execute){const t=e.execute;this.execute=async(e,r)=>{let{data:a,error:s}=cx(this.inputSchema,e,this.id);if(s)return s;let n=null,i=r?{...r,...r.suspend?{suspend:(e,t)=>(n=e,r.suspend?.(e,t))}:{}}:{},o=i;if(r){let e=i.toolCallId&&i.messages,t=!e&&(i.workflow||i.workflowId);if(e&&!i.agent){let{toolCallId:e,messages:t,suspend:r,resumeData:a,threadId:s,resourceId:n,writableStream:l,...u}=i;o={...u,agent:{toolCallId:e,messages:t,suspend:r,resumeData:a,threadId:s,resourceId:n,writableStream:l},requestContext:u.requestContext||new c_}}else if(t&&!i.workflow){let{workflowId:e,runId:t,state:r,setState:a,suspend:s,resumeData:n,...l}=i;o={...l,workflow:{workflowId:e,runId:t,state:r,setState:a,suspend:s,resumeData:n},requestContext:l.requestContext||new c_}}else o={...i,agent:i.agent?{...i.agent,suspend:(e,t)=>(n=e,i.agent?.suspend?.(e,t))}:i.agent,workflow:i.workflow?{...i.workflow,suspend:(e,t)=>(n=e,i.workflow?.suspend?.(e,t))}:i.workflow,requestContext:i.requestContext||new c_}}else o={requestContext:new c_,mastra:void 0};let l=o.agent?.resumeData??o.workflow?.resumeData??o?.resumeData;if(l){let e=cx(this.resumeSchema,l,this.id);if(e.error)return e.error}let u=await t(a,o);if(n){let e=cS(this.suspendSchema,n,this.id);if(e.error)return e.error}let p=!!(void 0===u&&n),d=cT(this.outputSchema,u,this.id,p);return d.error?d.error:d.data}}}};function cA(e){return!!(e&&!(e instanceof cE)&&("parameters"in e||"execute"in e&&"function"==typeof e.execute&&"inputSchema"in e))}var cO=eL,cz=e.i(254799);let cM=(e,t)=>e.anyOf.length?1===e.anyOf.length?cD(e.anyOf[0],{...t,path:[...t.path,"anyOf",0]}):`z.union([${e.anyOf.map((e,r)=>cD(e,{...t,path:[...t.path,"anyOf",r]})).join(", ")}])`:"z.any()",cP=Symbol("Original index");function cR(e,t){if(0===e.allOf.length)return"z.never()";if(1===e.allOf.length){let r=e.allOf[0];return cD(r,{...t,path:[...t.path,"allOf",r[cP]]})}{let r,[a,s]=[(r=(e=>{let t=[];for(let r=0;r<e.length;r++){let a=e[r];if("boolean"==typeof a)t.push(a?{[cP]:r}:{[cP]:r,not:{}});else{if(cP in a)return e;t.push({...a,[cP]:r})}}return t})(e.allOf)).slice(0,r.length/2),r.slice(r.length/2)];return`z.intersection(${cR({allOf:a},t)}, ${cR({allOf:s},t)})`}}function cC(e,t,r){let a=e[t],s="";if(void 0!==a){let n=r({value:a,json:JSON.stringify(a)});if(n){let r=n[0],a=3===n.length?n[1]:"",i=3===n.length?n[2]:n[1];s+=r,e.errorMessage?.[t]!==void 0&&(s+=a+JSON.stringify(e.errorMessage[t])),s+=i}}return s}let cj=(e,t)=>e.oneOf.length?1===e.oneOf.length?cD(e.oneOf[0],{...t,path:[...t.path,"oneOf",0]}):`z.any().superRefine((x, ctx) => {
    const schemas = [${e.oneOf.map((e,r)=>cD(e,{...t,path:[...t.path,"oneOf",r]})).join(", ")}];
    const errors = schemas.reduce<z.ZodError[]>(
      (errors, schema) =>
        ((result) =>
          result.error ? [...errors, result.error] : errors)(
          schema.safeParse(x),
        ),
      [],
    );
    if (schemas.length - errors.length !== 1) {
      ctx.addIssue({
        path: ctx.path,
        code: "invalid_union",
        unionErrors: errors,
        message: "Invalid input: Should pass single schema",
      });
    }
  })`:"z.any()",cN=e=>{let t=e.split("\n"),r=1===t.length?t[0]:`
${t.map(e=>`* ${e}`).join("\n")}
`;return`/**${r}*/
`},cL=(e,t)=>{let r=e.description;return r?`
${cN(r)}${t}`:t},cD=(e,t={seen:new Map,path:[]},r)=>{if("object"!=typeof e)return e?"z.any()":"z.never()";if(t.parserOverride){let r=t.parserOverride(e,t);if("string"==typeof r)return r}let a=t.seen.get(e);if(a){if(void 0!==a.r)return a.r;if(void 0===t.depth||a.n>=t.depth)return"z.any()";a.n+=1}else a={r:void 0,n:0},t.seen.set(e,a);let s=cU(e,t);return r||(t.withoutDescribes||(s=cq(e,s)),t.withoutDefaults||(s=c$(e,s)),s=cF(e,s)),a.r=s,s},cq=(e,t)=>(e.description&&(t+=`.describe(${JSON.stringify(e.description)})`),t),c$=(e,t)=>(void 0!==e.default&&(t+=`.default(${JSON.stringify(e.default)})`),t),cF=(e,t)=>(e.readOnly&&(t+=".readonly()"),t),cU=(e,t)=>{if(cZ.a.nullable(e))return`${cD(((e,...t)=>Object.keys(e).reduce((r,a)=>(t.includes(a)||(r[a]=e[a]),r),{}))(e,"nullable"),t,!0)}.nullable()`;if(cZ.an.object(e))return function(e,t){let r,a;e.properties&&(r=Object.keys(e.properties).length?"z.object({ "+Object.keys(e.properties).map(r=>{let a=e.properties[r],s=`${JSON.stringify(r)}: ${cD(a,{...t,path:[...t.path,"properties",r]})}`;t.withJsdocs&&"object"==typeof a&&(s=cL(a,s));let n="object"==typeof a&&void 0!==a.default,i=Array.isArray(e.required)?e.required.includes(r):"object"==typeof a&&!0===a.required;return n||i?s:`${s}.optional()`}).join(", ")+" })":"z.object({})");let s=void 0!==e.additionalProperties?cD(e.additionalProperties,{...t,path:[...t.path,"additionalProperties"]}):void 0;if(e.patternProperties){let n=Object.fromEntries(Object.entries(e.patternProperties).map(([e,r])=>[e,cD(r,{...t,path:[...t.path,"patternProperties",e]})],{}));for(let t in a="",r?s?a+=`.catchall(z.union([${[...Object.values(n),s].join(", ")}]))`:Object.keys(n).length>1?a+=`.catchall(z.union([${Object.values(n).join(", ")}]))`:a+=`.catchall(${Object.values(n)})`:s?a+=`z.record(z.union([${[...Object.values(n),s].join(", ")}]))`:Object.keys(n).length>1?a+=`z.record(z.union([${Object.values(n).join(", ")}]))`:a+=`z.record(${Object.values(n)})`,a+=".superRefine((value, ctx) => {\nfor (const key in value) {\n",s&&(e.properties?a+=`let evaluated = [${Object.keys(e.properties).map(e=>JSON.stringify(e)).join(", ")}].includes(key)
`:a+=`let evaluated = false
`),e.patternProperties)a+="if (key.match(new RegExp("+JSON.stringify(t)+"))) {\n",s&&(a+="evaluated = true\n"),a+="const result = "+n[t]+".safeParse(value[key])\nif (!result.success) {\n"+`ctx.addIssue({
          path: [...ctx.path, key],
          code: 'custom',
          message: \`Invalid input: Key matching regex /\${key}/ must match schema\`,
          params: {
            issues: result.error.issues
          }
        })
`+"}\n}\n";s&&(a+="if (!evaluated) {\n"+("const result = "+s+".safeParse(value[key])\n")+"if (!result.success) {\n"+`ctx.addIssue({
          path: [...ctx.path, key],
          code: 'custom',
          message: \`Invalid input: must match catchall schema\`,
          params: {
            issues: result.error.issues
          }
        })
`+"}\n}\n"),a+="}\n})"}let n=r?a?r+a:s?"z.never()"===s?r+".strict()":r+`.catchall(${s})`:r:a||(s?`z.record(${s})`:"z.record(z.any())");return cZ.an.anyOf(e)&&(n+=`.and(${cM({...e,anyOf:e.anyOf.map(e=>"object"==typeof e&&!e.type&&(e.properties||e.additionalProperties||e.patternProperties)?{...e,type:"object"}:e)},t)})`),cZ.a.oneOf(e)&&(n+=`.and(${cj({...e,oneOf:e.oneOf.map(e=>"object"==typeof e&&!e.type&&(e.properties||e.additionalProperties||e.patternProperties)?{...e,type:"object"}:e)},t)})`),cZ.an.allOf(e)&&(n+=`.and(${cR({...e,allOf:e.allOf.map(e=>"object"==typeof e&&!e.type&&(e.properties||e.additionalProperties||e.patternProperties)?{...e,type:"object"}:e)},t)})`),n}(e,t);if(cZ.an.array(e)){if(Array.isArray(e.items))return`z.tuple([${e.items.map((e,r)=>cD(e,{...t,path:[...t.path,"items",r]}))}])`;let r=e.items?`z.array(${cD(e.items,{...t,path:[...t.path,"items"]})})`:"z.array(z.any())";return r+=cC(e,"minItems",({json:e})=>[`.min(${e}`,", ",")"]),r+=cC(e,"maxItems",({json:e})=>[`.max(${e}`,", ",")"]),!0===e.uniqueItems&&(r+=cC(e,"uniqueItems",()=>[".unique(","",")"])),r}if(cZ.an.anyOf(e))return cM(e,t);if(cZ.an.allOf(e))return cR(e,t);else if(cZ.a.simpleDiscriminatedOneOf(e))return e.oneOf.length?1===e.oneOf.length?cD(e.oneOf[0],{...t,path:[...t.path,"oneOf",0]}):`z.discriminatedUnion("${e.discriminator.propertyName}", [${e.oneOf.map((e,r)=>cD(e,{...t,path:[...t.path,"oneOf",r]})).join(", ")}])`:"z.any()";else if(cZ.a.oneOf(e))return cj(e,t);else if(cZ.a.not(e))return`z.any().refine((value) => !${cD(e.not,{...t,path:[...t.path,"not"]})}.safeParse(value).success, "Invalid input: Should NOT be valid against schema")`;else if(cZ.an.enum(e))return 0===e.enum.length?"z.never()":1===e.enum.length?`z.literal(${JSON.stringify(e.enum[0])})`:e.enum.every(e=>"string"==typeof e)?`z.enum([${e.enum.map(e=>JSON.stringify(e))}])`:`z.union([${e.enum.map(e=>`z.literal(${JSON.stringify(e)})`).join(", ")}])`;else if(cZ.a.const(e))return`z.literal(${JSON.stringify(e.const)})`;else if(cZ.a.multipleType(e))return`z.union([${e.type.map(r=>cD({...e,type:r},{...t,withoutDefaults:!0})).join(", ")}])`;else if(cZ.a.primitive(e,"string")){let t,r;return t="z.string()"+cC(e,"format",({value:e})=>{switch(e){case"email":return[".email(",")"];case"ip":return[".ip(",")"];case"ipv4":return['.ip({ version: "v4"',", message: "," })"];case"ipv6":return['.ip({ version: "v6"',", message: "," })"];case"uri":return[".url(",")"];case"uuid":return[".uuid(",")"];case"date-time":return[".datetime({ offset: true",", message: "," })"];case"time":return[".time(",")"];case"date":return[".date(",")"];case"binary":return[".base64(",")"];case"duration":return[".duration(",")"]}})+cC(e,"pattern",({json:e})=>[`.regex(new RegExp(${e})`,", ",")"])+cC(e,"minLength",({json:e})=>[`.min(${e}`,", ",")"])+cC(e,"maxLength",({json:e})=>[`.max(${e}`,", ",")"])+cC(e,"contentEncoding",({value:e})=>{if("base64"===e)return[".base64(",")"]}),""!=(r=cC(e,"contentMediaType",({value:e})=>{if("application/json"===e)return['.transform((str, ctx) => { try { return JSON.parse(str); } catch (err) { ctx.addIssue({ code: "custom", message: "Invalid JSON" }); }}',", ",")"]}))&&(t+=r,t+=cC(e,"contentSchema",({value:e})=>{if(e&&e instanceof Object)return[`.pipe(${cD(e)}`,", ",")"]})),t}else if(cZ.a.primitive(e,"number")||cZ.a.primitive(e,"integer")){let t;return t="z.number()","integer"===e.type?t+=cC(e,"type",()=>[".int(",")"]):t+=cC(e,"format",({value:e})=>{if("int64"===e)return[".int(",")"]}),t+=cC(e,"multipleOf",({value:e,json:r})=>{if(1===e){if(t.startsWith("z.number().int("))return;return[".int(",")"]}return[`.multipleOf(${r}`,", ",")"]}),"number"==typeof e.minimum?!0===e.exclusiveMinimum?t+=cC(e,"minimum",({json:e})=>[`.gt(${e}`,", ",")"]):t+=cC(e,"minimum",({json:e})=>[`.gte(${e}`,", ",")"]):"number"==typeof e.exclusiveMinimum&&(t+=cC(e,"exclusiveMinimum",({json:e})=>[`.gt(${e}`,", ",")"])),"number"==typeof e.maximum?!0===e.exclusiveMaximum?t+=cC(e,"maximum",({json:e})=>[`.lt(${e}`,", ",")"]):t+=cC(e,"maximum",({json:e})=>[`.lte(${e}`,", ",")"]):"number"==typeof e.exclusiveMaximum&&(t+=cC(e,"exclusiveMaximum",({json:e})=>[`.lt(${e}`,", ",")"])),t}else{if(cZ.a.primitive(e,"boolean"))return"z.boolean()";if(cZ.a.primitive(e,"null"))return"z.null()";if(!cZ.a.conditional(e))return"z.any()";let r,a,s;return r=cD(e.if,{...t,path:[...t.path,"if"]}),a=cD(e.then,{...t,path:[...t.path,"then"]}),s=cD(e.else,{...t,path:[...t.path,"else"]}),`z.union([${a}, ${s}]).superRefine((value,ctx) => {
  const result = ${r}.safeParse(value).success
    ? ${a}.safeParse(value)
    : ${s}.safeParse(value);
  if (!result.success) {
    result.error.errors.forEach((error) => ctx.addIssue(error))
  }
})`}},cZ={an:{object:e=>"object"===e.type,array:e=>"array"===e.type,anyOf:e=>void 0!==e.anyOf,allOf:e=>void 0!==e.allOf,enum:e=>void 0!==e.enum},a:{nullable:e=>!0===e.nullable,multipleType:e=>Array.isArray(e.type),not:e=>void 0!==e.not,const:e=>void 0!==e.const,primitive:(e,t)=>e.type===t,conditional:e=>!!("if"in e&&e.if&&"then"in e&&"else"in e&&e.then&&e.else),simpleDiscriminatedOneOf:e=>{if(!e.oneOf||!Array.isArray(e.oneOf)||0===e.oneOf.length||!e.discriminator||"object"!=typeof e.discriminator||!("propertyName"in e.discriminator)||"string"!=typeof e.discriminator.propertyName)return!1;let t=e.discriminator.propertyName;return e.oneOf.every(e=>{if(!e||"object"!=typeof e||"object"!==e.type||!e.properties||"object"!=typeof e.properties||!(t in e.properties))return!1;let r=e.properties[t];return r&&"object"==typeof r&&"string"===r.type&&(void 0!==r.const||r.enum&&Array.isArray(r.enum)&&1===r.enum.length)&&Array.isArray(e.required)&&e.required.includes(t)})},oneOf:e=>void 0!==e.oneOf}};var cB=(e,t)=>{let r="",a=t.seen.get(e);if(cZ.an.anyOf(e)){let s=e.anyOf.every(e=>"object"==typeof e&&cZ.an.object(e)&&void 0!==e.properties);if(e.anyOf.length>1&&s){let s=e.anyOf.reduce((e,t)=>{if("object"==typeof t&&cZ.an.object(t)){let r=Object.entries(t.properties??{}).filter(([e,t])=>"object"==typeof t&&t?.const!==void 0);if(r?.length){let t=r.map(([e,t])=>e);e.push(t)}}return e},[]);if(s.length===e.anyOf.length){if(a){if(void 0!==a.r)return a.r;if(void 0===t.depth||a.n>=t.depth)return"z.any()";a.n+=1}else a={r:void 0,n:0},t.seen.set(e,a);let n=s.length>0&&s[0]?s.reduce((e,t)=>e.filter(e=>t.includes(e)),s[0]):[];if(n.length>0){let a=n[0];a&&(r=`z.discriminatedUnion("${a}", [${e.anyOf.map((e,r)=>cD(e,{...t,path:[...t.path,"anyOf",r]})).join(", ")}])`)}}}}else if(cZ.an.object(e)){if(a){if(void 0!==a.r)return a.r;if(void 0===t.depth||a.n>=t.depth)return"z.any()";a.n+=1}else a={r:void 0,n:0},t.seen.set(e,a);r=function(e,t){let r,a;e.properties&&(r=Object.keys(e.properties).length?"z.object({ "+Object.keys(e.properties).map(r=>{let a=e.properties[r],s=`${JSON.stringify(r)}: ${cD(a,{...t,path:[...t.path,"properties",r]})}`;t.withJsdocs&&"object"==typeof a&&(s=cL(a,s));let n="object"==typeof a&&void 0!==a.default,i=Array.isArray(e.required)?e.required.includes(r):"object"==typeof a&&!0===a.required;return n||i?s:`${s}.optional()`}).join(", ")+" })":"z.object({})");let s=void 0!==e.additionalProperties&&!1!==e.additionalProperties?cD(e.additionalProperties,{...t,path:[...t.path,"additionalProperties"]}):void 0;if(e.patternProperties){let n=Object.fromEntries(Object.entries(e.patternProperties).map(([e,r])=>[e,cD(r,{...t,path:[...t.path,"patternProperties",e]})],{}));for(let t in a="",r?s?a+=`.catchall(z.union([${[...Object.values(n),s].join(", ")}]))`:Object.keys(n).length>1?a+=`.catchall(z.union([${Object.values(n).join(", ")}]))`:a+=`.catchall(${Object.values(n)})`:s?a+=`z.record(z.union([${[...Object.values(n),s].join(", ")}]))`:Object.keys(n).length>1?a+=`z.record(z.union([${Object.values(n).join(", ")}]))`:a+=`z.record(${Object.values(n)})`,a+=".superRefine((value, ctx) => {\nfor (const key in value) {\n",s&&(e.properties?a+=`let evaluated = [${Object.keys(e.properties).map(e=>JSON.stringify(e)).join(", ")}].includes(key)
`:a+=`let evaluated = false
`),e.patternProperties)a+="if (key.match(new RegExp("+JSON.stringify(t)+"))) {\n",s&&(a+="evaluated = true\n"),a+="const result = "+n[t]+".safeParse(value[key])\nif (!result.success) {\n"+`ctx.addIssue({
          path: [...ctx.path, key],
          code: 'custom',
          message: \`Invalid input: Key matching regex /\${key}/ must match schema\`,
          params: {
            issues: result.error.issues
          }
        })
`+"}\n}\n";s&&(a+="if (!evaluated) {\n"+("const result = "+s+".safeParse(value[key])\n")+"if (!result.success) {\n"+`ctx.addIssue({
          path: [...ctx.path, key],
          code: 'custom',
          message: \`Invalid input: must match catchall schema\`,
          params: {
            issues: result.error.issues
          }
        })
`+"}\n}\n"),a+="}\n})"}let n=r?a?r+a:s?"z.never()"===s?r+".strict()":r+`.catchall(${s})`:r:a||(s?`z.record(${s})`:"z.record(z.any())");return cZ.an.anyOf(e)&&(n+=`.and(${cM({...e,anyOf:e.anyOf.map(e=>"object"==typeof e&&!e.type&&(e.properties||e.additionalProperties||e.patternProperties)?{...e,type:"object"}:e)},t)})`),cZ.a.oneOf(e)&&(n+=`.and(${cj({...e,oneOf:e.oneOf.map(e=>"object"==typeof e&&!e.type&&(e.properties||e.additionalProperties||e.patternProperties)?{...e,type:"object"}:e)},t)})`),cZ.an.allOf(e)&&(n+=`.and(${cR({...e,allOf:e.allOf.map(e=>"object"==typeof e&&!e.type&&(e.properties||e.additionalProperties||e.patternProperties)?{...e,type:"object"}:e)},t)})`),n}(e,t)}if(r)return t.withoutDescribes||(r=cV(e,r)),t.withoutDefaults||(r=cK(e,r)),r=cG(e,r),a&&(a.r=r),r},cV=(e,t)=>(e.description&&(t+=`.describe(${JSON.stringify(e.description)})`),t),cK=(e,t)=>(void 0!==e.default&&(t+=`.default(${JSON.stringify(e.default)})`),t),cG=(e,t)=>(e.readOnly&&(t+=".readonly()"),t),sg=eF;let cW=Symbol("Let zodToJsonSchema decide on which parser to use"),cQ={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",allowedAdditionalProperties:!0,rejectedAdditionalProperties:!1,definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref",openAiAnyTypeName:"OpenAiAnyType"};function cJ(e,t,r,a){a?.errorMessages&&r&&(e.errorMessage={...e.errorMessage,[t]:r})}function cH(e,t,r,a,s){e[t]=r,cJ(e,t,a,s)}let cY=(e,t)=>{let r=0;for(;r<e.length&&r<t.length&&e[r]===t[r];r++);return[(e.length-r).toString(),...t.slice(r)].join("/")};function cX(e){if("openAi"!==e.target)return{};let t=[...e.basePath,e.definitionPath,e.openAiAnyTypeName];return e.flags.hasReferencedOpenAiAnyType=!0,{$ref:"relative"===e.$refStrategy?cY(t,e.currentPath):t.join("/")}}function c0(e,t){return md(e.type._def,t)}let c1=/^[cC][^\s-]{8,}$/,c2=/^[0-9a-z]+$/,c3=/^[0-9A-HJKMNP-TV-Z]{26}$/,c5=/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,c4=()=>(void 0===n&&(n=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),n),c6=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,c7=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,c9=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,c8=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,me=/^[a-zA-Z0-9_-]{21}$/,mt=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/;function mr(e,t){let r={type:"string"};if(e.checks)for(let a of e.checks)switch(a.kind){case"min":cH(r,"minLength","number"==typeof r.minLength?Math.max(r.minLength,a.value):a.value,a.message,t);break;case"max":cH(r,"maxLength","number"==typeof r.maxLength?Math.min(r.maxLength,a.value):a.value,a.message,t);break;case"email":switch(t.emailStrategy){case"format:email":mn(r,"email",a.message,t);break;case"format:idn-email":mn(r,"idn-email",a.message,t);break;case"pattern:zod":mi(r,c5,a.message,t)}break;case"url":mn(r,"uri",a.message,t);break;case"uuid":mn(r,"uuid",a.message,t);break;case"regex":mi(r,a.regex,a.message,t);break;case"cuid":mi(r,c1,a.message,t);break;case"cuid2":mi(r,c2,a.message,t);break;case"startsWith":mi(r,RegExp(`^${ma(a.value,t)}`),a.message,t);break;case"endsWith":mi(r,RegExp(`${ma(a.value,t)}$`),a.message,t);break;case"datetime":mn(r,"date-time",a.message,t);break;case"date":mn(r,"date",a.message,t);break;case"time":mn(r,"time",a.message,t);break;case"duration":mn(r,"duration",a.message,t);break;case"length":cH(r,"minLength","number"==typeof r.minLength?Math.max(r.minLength,a.value):a.value,a.message,t),cH(r,"maxLength","number"==typeof r.maxLength?Math.min(r.maxLength,a.value):a.value,a.message,t);break;case"includes":mi(r,RegExp(ma(a.value,t)),a.message,t);break;case"ip":"v6"!==a.version&&mn(r,"ipv4",a.message,t),"v4"!==a.version&&mn(r,"ipv6",a.message,t);break;case"base64url":mi(r,c8,a.message,t);break;case"jwt":mi(r,mt,a.message,t);break;case"cidr":"v6"!==a.version&&mi(r,c6,a.message,t),"v4"!==a.version&&mi(r,c7,a.message,t);break;case"emoji":mi(r,c4(),a.message,t);break;case"ulid":mi(r,c3,a.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":mn(r,"binary",a.message,t);break;case"contentEncoding:base64":cH(r,"contentEncoding","base64",a.message,t);break;case"pattern:zod":mi(r,c9,a.message,t)}break;case"nanoid":mi(r,me,a.message,t)}return r}function ma(e,t){return"escape"===t.patternStrategy?function(e){let t="";for(let r=0;r<e.length;r++)ms.has(e[r])||(t+="\\"),t+=e[r];return t}(e):e}let ms=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function mn(e,t,r,a){e.format||e.anyOf?.some(e=>e.format)?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&a.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.anyOf.push({format:t,...r&&a.errorMessages&&{errorMessage:{format:r}}})):cH(e,"format",t,r,a)}function mi(e,t,r,a){e.pattern||e.allOf?.some(e=>e.pattern)?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&a.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.allOf.push({pattern:mo(t,a),...r&&a.errorMessages&&{errorMessage:{pattern:r}}})):cH(e,"pattern",mo(t,a),r,a)}function mo(e,t){if(!t.applyRegexFlags||!e.flags)return e.source;let r={i:e.flags.includes("i"),m:e.flags.includes("m"),s:e.flags.includes("s")},a=r.i?e.source.toLowerCase():e.source,s="",n=!1,i=!1,o=!1;for(let e=0;e<a.length;e++){if(n){s+=a[e],n=!1;continue}if(r.i){if(i){if(a[e].match(/[a-z]/)){o?(s+=a[e],s+=`${a[e-2]}-${a[e]}`.toUpperCase(),o=!1):"-"===a[e+1]&&a[e+2]?.match(/[a-z]/)?(s+=a[e],o=!0):s+=`${a[e]}${a[e].toUpperCase()}`;continue}}else if(a[e].match(/[a-z]/)){s+=`[${a[e]}${a[e].toUpperCase()}]`;continue}}if(r.m){if("^"===a[e]){s+=`(^|(?<=[\r
]))`;continue}else if("$"===a[e]){s+=`($|(?=[\r
]))`;continue}}if(r.s&&"."===a[e]){s+=i?`${a[e]}\r
`:`[${a[e]}\r
]`;continue}s+=a[e],"\\"===a[e]?n=!0:i&&"]"===a[e]?i=!1:i||"["!==a[e]||(i=!0)}try{new RegExp(s)}catch{return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),e.source}return s}function ml(e,t){if("openAi"===t.target&&console.warn("Warning: OpenAI may not support records in schemas! Try an array of key-value pairs instead."),"openApi3"===t.target&&e.keyType?._def.typeName===eZ.ZodFirstPartyTypeKind.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce((r,a)=>({...r,[a]:md(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",a]})??cX(t)}),{}),additionalProperties:t.rejectedAdditionalProperties};let r={type:"object",additionalProperties:md(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??t.allowedAdditionalProperties};if("openApi3"===t.target)return r;if(e.keyType?._def.typeName===eZ.ZodFirstPartyTypeKind.ZodString&&e.keyType._def.checks?.length){let{type:a,...s}=mr(e.keyType._def,t);return{...r,propertyNames:s}}if(e.keyType?._def.typeName===eZ.ZodFirstPartyTypeKind.ZodEnum)return{...r,propertyNames:{enum:e.keyType._def.values}};if(e.keyType?._def.typeName===eZ.ZodFirstPartyTypeKind.ZodBranded&&e.keyType._def.type._def.typeName===eZ.ZodFirstPartyTypeKind.ZodString&&e.keyType._def.type._def.checks?.length){let{type:a,...s}=c0(e.keyType._def,t);return{...r,propertyNames:s}}return r}let mu={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"},mp=(e,t)=>{let r=(e.options instanceof Map?Array.from(e.options.values()):e.options).map((e,r)=>md(e._def,{...t,currentPath:[...t.currentPath,"anyOf",`${r}`]})).filter(e=>!!e&&(!t.strictUnions||"object"==typeof e&&Object.keys(e).length>0));return r.length?{anyOf:r}:void 0};function md(e,t,r=!1){let a=t.seen.get(e);if(t.override){let s=t.override?.(e,t,a,r);if(s!==cW)return s}if(a&&!r){let e=mc(a,t);if(void 0!==e)return e}let s={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,s);let n=((e,t,r)=>{switch(t){case eZ.ZodFirstPartyTypeKind.ZodString:return mr(e,r);case eZ.ZodFirstPartyTypeKind.ZodNumber:let a={type:"number"};if(!e.checks)return a;for(let t of e.checks)switch(t.kind){case"int":a.type="integer",cJ(a,"type",t.message,r);break;case"min":"jsonSchema7"===r.target?t.inclusive?cH(a,"minimum",t.value,t.message,r):cH(a,"exclusiveMinimum",t.value,t.message,r):(t.inclusive||(a.exclusiveMinimum=!0),cH(a,"minimum",t.value,t.message,r));break;case"max":"jsonSchema7"===r.target?t.inclusive?cH(a,"maximum",t.value,t.message,r):cH(a,"exclusiveMaximum",t.value,t.message,r):(t.inclusive||(a.exclusiveMaximum=!0),cH(a,"maximum",t.value,t.message,r));break;case"multipleOf":cH(a,"multipleOf",t.value,t.message,r)}return a;case eZ.ZodFirstPartyTypeKind.ZodObject:return function(e,t){let r="openAi"===t.target,a={type:"object",properties:{}},s=[],n=e.shape();for(let e in n){let i=n[e];if(void 0===i||void 0===i._def)continue;let o=function(e){try{return e.isOptional()}catch{return!0}}(i);o&&r&&("ZodOptional"===i._def.typeName&&(i=i._def.innerType),i.isNullable()||(i=i.nullable()),o=!1);let l=md(i._def,{...t,currentPath:[...t.currentPath,"properties",e],propertyPath:[...t.currentPath,"properties",e]});void 0!==l&&(a.properties[e]=l,o||s.push(e))}s.length&&(a.required=s);let i=function(e,t){if("ZodNever"!==e.catchall._def.typeName)return md(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]});switch(e.unknownKeys){case"passthrough":return t.allowedAdditionalProperties;case"strict":return t.rejectedAdditionalProperties;case"strip":return"strict"===t.removeAdditionalStrategy?t.allowedAdditionalProperties:t.rejectedAdditionalProperties}}(e,t);return void 0!==i&&(a.additionalProperties=i),a}(e,r);case eZ.ZodFirstPartyTypeKind.ZodBigInt:let s={type:"integer",format:"int64"};if(!e.checks)return s;for(let t of e.checks)switch(t.kind){case"min":"jsonSchema7"===r.target?t.inclusive?cH(s,"minimum",t.value,t.message,r):cH(s,"exclusiveMinimum",t.value,t.message,r):(t.inclusive||(s.exclusiveMinimum=!0),cH(s,"minimum",t.value,t.message,r));break;case"max":"jsonSchema7"===r.target?t.inclusive?cH(s,"maximum",t.value,t.message,r):cH(s,"exclusiveMaximum",t.value,t.message,r):(t.inclusive||(s.exclusiveMaximum=!0),cH(s,"maximum",t.value,t.message,r));break;case"multipleOf":cH(s,"multipleOf",t.value,t.message,r)}return s;case eZ.ZodFirstPartyTypeKind.ZodBoolean:return{type:"boolean"};case eZ.ZodFirstPartyTypeKind.ZodDate:return function e(t,r,a){let s=a??r.dateStrategy;if(Array.isArray(s))return{anyOf:s.map((a,s)=>e(t,r,a))};switch(s){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":var n=t,i=r;let o={type:"integer",format:"unix-time"};if("openApi3"===i.target)return o;for(let e of n.checks)switch(e.kind){case"min":cH(o,"minimum",e.value,e.message,i);break;case"max":cH(o,"maximum",e.value,e.message,i)}return o}}(e,r);case eZ.ZodFirstPartyTypeKind.ZodUndefined:return{not:cX(r)};case eZ.ZodFirstPartyTypeKind.ZodNull:return"openApi3"===r.target?{enum:["null"],nullable:!0}:{type:"null"};case eZ.ZodFirstPartyTypeKind.ZodArray:let n;return n={type:"array"},e.type?._def&&e.type?._def?.typeName!==eZ.ZodFirstPartyTypeKind.ZodAny&&(n.items=md(e.type._def,{...r,currentPath:[...r.currentPath,"items"]})),e.minLength&&cH(n,"minItems",e.minLength.value,e.minLength.message,r),e.maxLength&&cH(n,"maxItems",e.maxLength.value,e.maxLength.message,r),e.exactLength&&(cH(n,"minItems",e.exactLength.value,e.exactLength.message,r),cH(n,"maxItems",e.exactLength.value,e.exactLength.message,r)),n;case eZ.ZodFirstPartyTypeKind.ZodUnion:case eZ.ZodFirstPartyTypeKind.ZodDiscriminatedUnion:if("openApi3"===r.target)return mp(e,r);let i=e.options instanceof Map?Array.from(e.options.values()):e.options;if(i.every(e=>e._def.typeName in mu&&(!e._def.checks||!e._def.checks.length))){let e=i.reduce((e,t)=>{let r=mu[t._def.typeName];return r&&!e.includes(r)?[...e,r]:e},[]);return{type:e.length>1?e:e[0]}}if(i.every(e=>"ZodLiteral"===e._def.typeName&&!e.description)){let e=i.reduce((e,t)=>{let r=typeof t._def.value;switch(r){case"string":case"number":case"boolean":return[...e,r];case"bigint":return[...e,"integer"];case"object":if(null===t._def.value)return[...e,"null"];default:return e}},[]);if(e.length===i.length){let t=e.filter((e,t,r)=>r.indexOf(e)===t);return{type:t.length>1?t:t[0],enum:i.reduce((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value],[])}}}else if(i.every(e=>"ZodEnum"===e._def.typeName))return{type:"string",enum:i.reduce((e,t)=>[...e,...t._def.values.filter(t=>!e.includes(t))],[])};return mp(e,r);case eZ.ZodFirstPartyTypeKind.ZodIntersection:let o,l,u;return o=[md(e.left._def,{...r,currentPath:[...r.currentPath,"allOf","0"]}),md(e.right._def,{...r,currentPath:[...r.currentPath,"allOf","1"]})].filter(e=>!!e),l="jsonSchema2019-09"===r.target?{unevaluatedProperties:!1}:void 0,u=[],o.forEach(e=>{if((!("type"in e)||"string"!==e.type)&&"allOf"in e)u.push(...e.allOf),void 0===e.unevaluatedProperties&&(l=void 0);else{let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){let{additionalProperties:r,...a}=e;t=a}else l=void 0;u.push(t)}}),u.length?{allOf:u,...l}:void 0;case eZ.ZodFirstPartyTypeKind.ZodTuple:return e.rest?{type:"array",minItems:e.items.length,items:e.items.map((e,t)=>md(e._def,{...r,currentPath:[...r.currentPath,"items",`${t}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[]),additionalItems:md(e.rest._def,{...r,currentPath:[...r.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map((e,t)=>md(e._def,{...r,currentPath:[...r.currentPath,"items",`${t}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[])};case eZ.ZodFirstPartyTypeKind.ZodRecord:return ml(e,r);case eZ.ZodFirstPartyTypeKind.ZodLiteral:let p;return"bigint"!=(p=typeof e.value)&&"number"!==p&&"boolean"!==p&&"string"!==p?{type:Array.isArray(e.value)?"array":"object"}:"openApi3"===r.target?{type:"bigint"===p?"integer":p,enum:[e.value]}:{type:"bigint"===p?"integer":p,const:e.value};case eZ.ZodFirstPartyTypeKind.ZodEnum:return{type:"string",enum:Array.from(e.values)};case eZ.ZodFirstPartyTypeKind.ZodNativeEnum:let d,c,m;return d=e.values,{type:1===(m=Array.from(new Set((c=Object.keys(e.values).filter(e=>"number"!=typeof d[d[e]]).map(e=>d[e])).map(e=>typeof e)))).length?"string"===m[0]?"string":"number":["string","number"],enum:c};case eZ.ZodFirstPartyTypeKind.ZodNullable:if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return"openApi3"===r.target?{type:mu[e.innerType._def.typeName],nullable:!0}:{type:[mu[e.innerType._def.typeName],"null"]};if("openApi3"===r.target){let t=md(e.innerType._def,{...r,currentPath:[...r.currentPath]});return t&&"$ref"in t?{allOf:[t],nullable:!0}:t&&{...t,nullable:!0}}let g=md(e.innerType._def,{...r,currentPath:[...r.currentPath,"anyOf","0"]});return g&&{anyOf:[g,{type:"null"}]};case eZ.ZodFirstPartyTypeKind.ZodOptional:if(r.currentPath.toString()===r.propertyPath?.toString())return md(e.innerType._def,r);let h=md(e.innerType._def,{...r,currentPath:[...r.currentPath,"anyOf","1"]});return h?{anyOf:[{not:cX(r)},h]}:cX(r);case eZ.ZodFirstPartyTypeKind.ZodMap:if("record"===r.mapStrategy)return ml(e,r);return{type:"array",maxItems:125,items:{type:"array",items:[md(e.keyType._def,{...r,currentPath:[...r.currentPath,"items","items","0"]})||cX(r),md(e.valueType._def,{...r,currentPath:[...r.currentPath,"items","items","1"]})||cX(r)],minItems:2,maxItems:2}};case eZ.ZodFirstPartyTypeKind.ZodSet:let f;return f={type:"array",uniqueItems:!0,items:md(e.valueType._def,{...r,currentPath:[...r.currentPath,"items"]})},e.minSize&&cH(f,"minItems",e.minSize.value,e.minSize.message,r),e.maxSize&&cH(f,"maxItems",e.maxSize.value,e.maxSize.message,r),f;case eZ.ZodFirstPartyTypeKind.ZodLazy:return()=>e.getter()._def;case eZ.ZodFirstPartyTypeKind.ZodPromise:return md(e.type._def,r);case eZ.ZodFirstPartyTypeKind.ZodNaN:case eZ.ZodFirstPartyTypeKind.ZodNever:return"openAi"===r.target?void 0:{not:cX({...r,currentPath:[...r.currentPath,"not"]})};case eZ.ZodFirstPartyTypeKind.ZodEffects:return"input"===r.effectStrategy?md(e.schema._def,r):cX(r);case eZ.ZodFirstPartyTypeKind.ZodAny:case eZ.ZodFirstPartyTypeKind.ZodUnknown:return cX(r);case eZ.ZodFirstPartyTypeKind.ZodDefault:return{...md(e.innerType._def,r),default:e.defaultValue()};case eZ.ZodFirstPartyTypeKind.ZodBranded:return c0(e,r);case eZ.ZodFirstPartyTypeKind.ZodReadonly:case eZ.ZodFirstPartyTypeKind.ZodCatch:return md(e.innerType._def,r);case eZ.ZodFirstPartyTypeKind.ZodPipeline:if("input"===r.pipeStrategy)return md(e.in._def,r);if("output"===r.pipeStrategy)return md(e.out._def,r);let y=md(e.in._def,{...r,currentPath:[...r.currentPath,"allOf","0"]}),v=md(e.out._def,{...r,currentPath:[...r.currentPath,"allOf",y?"1":"0"]});return{allOf:[y,v].filter(e=>void 0!==e)};case eZ.ZodFirstPartyTypeKind.ZodFunction:case eZ.ZodFirstPartyTypeKind.ZodVoid:case eZ.ZodFirstPartyTypeKind.ZodSymbol:default:return}})(e,e.typeName,t),i="function"==typeof n?md(n(),t):n;if(i&&mm(e,t,i),t.postProcess){let r=t.postProcess(i,e,t);return s.jsonSchema=i,r}return s.jsonSchema=i,i}let mc=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"relative":return{$ref:cY(t.currentPath,e.path)};case"none":case"seen":if(e.path.length<t.currentPath.length&&e.path.every((e,r)=>t.currentPath[r]===e))return console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),cX(t);return"seen"===t.$refStrategy?cX(t):void 0}},mm=(e,t,r)=>(e.description&&(r.description=e.description,t.markdownDescription&&(r.markdownDescription=e.description)),r);var mg=Symbol("__mastra_patched__");function mh(e,t="jsonSchema7",r="relative"){let a="toJSONSchema";return a in sg?(!function e(t){if(!t||"object"!=typeof t||t[mg])return t;t[mg]=!0;let r=t._zod?.def;if(r?.type==="record"&&r.keyType&&!r.valueType&&(r.valueType=r.keyType,r.keyType=sg.string()),!r)return t;if("object"===r.type&&r.shape){let t="function"==typeof r.shape?r.shape():r.shape;for(let r of Object.keys(t))e(t[r])}if("array"===r.type&&r.element&&e(r.element),"union"===r.type&&r.options&&r.options.forEach(e),"record"===r.type&&(r.keyType&&e(r.keyType),r.valueType&&e(r.valueType)),"intersection"===r.type&&(r.left&&e(r.left),r.right&&e(r.right)),"lazy"===r.type&&r.getter&&"function"==typeof r.getter){let t=r.getter;r.getter=function(){let r=t();return r&&e(r),r}}return r.innerType&&e(r.innerType),t}(e),function e(t){if("object"!=typeof t||null===t)return t;let r={...t};if(r.anyOf&&Array.isArray(r.anyOf)&&2===r.anyOf.length){let t=r.anyOf.find(e=>"object"==typeof e&&null!==e&&"null"===e.type),a=r.anyOf.find(e=>"object"==typeof e&&null!==e&&"null"!==e.type);if(t&&a&&"object"==typeof a&&a.type){let{anyOf:t,...s}=r,n=e(s),i=e(a);return{...n,...i,type:Array.isArray(i.type)?[...i.type,"null"]:[i.type,"null"]}}}return r.properties&&"object"==typeof r.properties&&!Array.isArray(r.properties)&&(r.properties=Object.fromEntries(Object.entries(r.properties).map(([t,r])=>"object"!=typeof r||null===r||Array.isArray(r)||0!==Object.keys(r).length?[t,e(r)]:[t,{type:["string","number","boolean","null"]}]))),r.items&&(Array.isArray(r.items)?r.items=r.items.map(t=>e(t)):r.items=e(r.items)),r.anyOf&&Array.isArray(r.anyOf)&&(r.anyOf=r.anyOf.map(t=>e(t))),r.oneOf&&Array.isArray(r.oneOf)&&(r.oneOf=r.oneOf.map(t=>e(t))),r.allOf&&Array.isArray(r.allOf)&&(r.allOf=r.allOf.map(t=>e(t))),r}(sg[a](e,{unrepresentable:"any",override:e=>{let t=e.zodSchema?._def||e.zodSchema?._zod?.def;t&&("ZodDate"===t.typeName||"date"===t.type)&&(e.jsonSchema.type="string",e.jsonSchema.format="date-time")}}))):((e,t)=>{let r,a,s=(a=void 0!==(r="string"==typeof t?{...cQ,name:t}:{...cQ,...t}).name?[...r.basePath,r.definitionPath,r.name]:r.basePath,{...r,flags:{hasReferencedOpenAiAnyType:!1},currentPath:a,propertyPath:void 0,seen:new Map(Object.entries(r.definitions).map(([e,t])=>[t._def,{def:t._def,path:[...r.basePath,r.definitionPath,e],jsonSchema:void 0}]))}),n="object"==typeof t&&t.definitions?Object.entries(t.definitions).reduce((e,[t,r])=>({...e,[t]:md(r._def,{...s,currentPath:[...s.basePath,s.definitionPath,t]},!0)??cX(s)}),{}):void 0,i="string"==typeof t?t:t?.nameStrategy==="title"?void 0:t?.name,o=md(e._def,void 0===i?s:{...s,currentPath:[...s.basePath,s.definitionPath,i]},!1)??cX(s),l="object"==typeof t&&void 0!==t.name&&"title"===t.nameStrategy?t.name:void 0;void 0!==l&&(o.title=l),s.flags.hasReferencedOpenAiAnyType&&(n||(n={}),n[s.openAiAnyTypeName]||(n[s.openAiAnyTypeName]={type:["string","number","integer","boolean","array","null"],items:{$ref:"relative"===s.$refStrategy?"1":[...s.basePath,s.definitionPath,s.openAiAnyTypeName].join("/")}}));let u=void 0===i?n?{...o,[s.definitionPath]:n}:o:{$ref:[..."relative"===s.$refStrategy?[]:s.basePath,s.definitionPath,i].join("/"),[s.definitionPath]:{...n,[i]:o}};return"jsonSchema7"===s.target?u.$schema="http://json-schema.org/draft-07/schema#":("jsonSchema2019-09"===s.target||"openAi"===s.target)&&(u.$schema="https://json-schema.org/draft/2019-09/schema#"),"openAi"===s.target&&("anyOf"in u||"oneOf"in u||"allOf"in u||"type"in u&&Array.isArray(u.type))&&console.warn("Warning: OpenAI may not support schemas with unions as roots! Try wrapping it in an object property."),u})(e,{$refStrategy:r,target:t})}var sg=eF,mf=e.i(293883),my=class{apply(e,t){if(!t.type)return;let r=new Set(Array.isArray(t.type)?t.type:[t.type]);if(r.has("string")||(e.string=!1),r.has("number")||r.has("integer")||(e.number=!1),r.has("boolean")||(e.boolean=!1),r.has("null")||(e.null=!1),r.has("array")||(e.array=!1),r.has("object")||(e.object=!1),r.has("integer")&&!1!==e.number){let t=e.number||eU.z.number();t instanceof eU.z.ZodNumber&&(e.number=t.int())}}},mv=class{apply(e,t){if(void 0===t.const)return;let r=t.const;e.string=!1,e.number=!1,e.boolean=!1,e.null=!1,e.array=!1,e.object=!1,"string"==typeof r?e.string=eU.z.literal(r):"number"==typeof r?e.number=eU.z.literal(r):"boolean"==typeof r?e.boolean=eU.z.literal(r):null===r?e.null=eU.z.null():Array.isArray(r)?e.array=void 0:"object"==typeof r&&(e.object=void 0)}},mb=class{apply(e,t){if(!t.enum)return;if(0===t.enum.length){t.type||(e.string=!1,e.number=!1,e.boolean=!1,e.null=!1,e.array=!1,e.object=!1);return}let r={string:t.enum.filter(e=>"string"==typeof e),number:t.enum.filter(e=>"number"==typeof e),boolean:t.enum.filter(e=>"boolean"==typeof e),null:t.enum.filter(e=>null===e),array:t.enum.filter(e=>Array.isArray(e)),object:t.enum.filter(e=>"object"==typeof e&&null!==e&&!Array.isArray(e))};e.string=this.createTypeSchema(r.string,"string"),e.number=this.createTypeSchema(r.number,"number"),e.boolean=this.createTypeSchema(r.boolean,"boolean"),e.null=r.null.length>0&&eU.z.null(),e.array=r.array.length>0&&void 0,e.object=r.object.length>0&&void 0}createTypeSchema(e,t){if(0===e.length)return!1;if(1===e.length)return eU.z.literal(e[0]);if("string"===t)return eU.z.enum(e);if("number"===t){let[t,r,...a]=e;return eU.z.union([eU.z.literal(t),eU.z.literal(r),...a.map(e=>eU.z.literal(e))])}return"boolean"===t&&eU.z.union([eU.z.literal(!0),eU.z.literal(!1)])}},mw=class{apply(e,t){if("string"===t.type&&"binary"===t.format&&"binary"===t.contentEncoding){let r=eU.z.file();void 0!==t.minLength&&(r=r.min(t.minLength)),void 0!==t.maxLength&&(r=r.max(t.maxLength)),void 0!==t.contentMediaType&&(r=r.mime(t.contentMediaType)),e.file=r,e.string=!1}}},mk=class{apply(e,t){void 0===t.type&&(void 0!==t.minLength||void 0!==t.maxLength||void 0!==t.pattern)&&void 0===e.string&&(e.string=eU.z.string())}},m_=class{apply(e,t){if(void 0!==t.minLength&&!1!==e.string){let r=e.string||eU.z.string();r instanceof eU.z.ZodString&&(e.string=r.refine(e=>Array.from(e).length>=t.minLength,{message:`String must be at least ${t.minLength} characters long`}))}}},mI=class{apply(e,t){if(void 0!==t.maxLength&&!1!==e.string){let r=e.string||eU.z.string();r instanceof eU.z.ZodString&&(e.string=r.refine(e=>Array.from(e).length<=t.maxLength,{message:`String must be at most ${t.maxLength} characters long`}))}}},mS=class{apply(e,t){if(t.pattern&&!1!==e.string){let r=e.string||eU.z.string();if(r instanceof eU.z.ZodString){let a=new RegExp(t.pattern);e.string=r.regex(a)}}}},mx=class{apply(e,t){if(void 0!==t.minimum&&!1!==e.number){let r=e.number||eU.z.number();r instanceof eU.z.ZodNumber&&(e.number=r.min(t.minimum))}}},mT=class{apply(e,t){if(void 0!==t.maximum&&!1!==e.number){let r=e.number||eU.z.number();r instanceof eU.z.ZodNumber&&(e.number=r.max(t.maximum))}}},mE=class{apply(e,t){if(void 0!==t.exclusiveMinimum&&!1!==e.number){let r=e.number||eU.z.number();r instanceof eU.z.ZodNumber&&("number"==typeof t.exclusiveMinimum?e.number=r.gt(t.exclusiveMinimum):e.number=!1)}}},mA=class{apply(e,t){if(void 0!==t.exclusiveMaximum&&!1!==e.number){let r=e.number||eU.z.number();r instanceof eU.z.ZodNumber&&("number"==typeof t.exclusiveMaximum?e.number=r.lt(t.exclusiveMaximum):e.number=!1)}}},mO=class{apply(e,t){if(void 0!==t.multipleOf&&!1!==e.number){let r=e.number||eU.z.number();r instanceof eU.z.ZodNumber&&(e.number=r.refine(e=>{if(0===t.multipleOf)return!1;let r=e/t.multipleOf,a=Math.round(r);return Math.abs(r-a)<=Math.min(Math.abs(e)*Number.EPSILON*10,Math.abs(t.multipleOf)*Number.EPSILON*10)/Math.abs(t.multipleOf)},{message:`Must be a multiple of ${t.multipleOf}`}))}}},mz=class{apply(e,t){void 0===t.type&&(void 0!==t.minItems||void 0!==t.maxItems||void 0!==t.items||void 0!==t.prefixItems)&&void 0===e.array&&(e.array=eU.z.array(eU.z.any()))}},mM=class{apply(e,t){void 0!==t.minItems&&!1!==e.array&&(e.array=(e.array||eU.z.array(eU.z.any())).min(t.minItems))}},mP=class{apply(e,t){void 0!==t.maxItems&&!1!==e.array&&(e.array=(e.array||eU.z.array(eU.z.any())).max(t.maxItems))}},mR=class{apply(e,t){if(!1!==e.array)if(Array.isArray(t.items))e.array=e.array||eU.z.array(eU.z.any());else if(t.items&&"boolean"!=typeof t.items&&!t.prefixItems){let r=m2(t.items),a=eU.z.array(r);if(e.array&&e.array instanceof eU.z.ZodArray){let t=e.array._def;t.checks&&t.checks.forEach(e=>{if(e._zod&&e._zod.def){let t=e._zod.def;"min_length"===t.check&&void 0!==t.minimum?a=a.min(t.minimum):"max_length"===t.check&&void 0!==t.maximum&&(a=a.max(t.maximum))}})}e.array=a}else"boolean"==typeof t.items&&!1===t.items?t.prefixItems?e.array=e.array||eU.z.array(eU.z.any()):e.array=eU.z.array(eU.z.any()).max(0):"boolean"==typeof t.items&&!0===t.items?e.array=e.array||eU.z.array(eU.z.any()):t.prefixItems&&(e.array=e.array||eU.z.array(eU.z.any()))}},mC=class{apply(e,t){let r;if("array"!==t.type||!Array.isArray(t.items)||!1===e.array)return;let a=t.items.map(e=>m2(e));r=0===a.length?eU.z.tuple([]):eU.z.tuple(a),void 0!==t.minItems&&t.minItems>a.length&&(r=!1),void 0!==t.maxItems&&t.maxItems<a.length&&(r=!1),e.tuple=r,e.array=!1}},mj=class{apply(e,t){!1!==e.object&&(t.properties||t.required||void 0!==t.additionalProperties)&&(e.object=e.object||eU.z.object({}).passthrough())}},mN=class{apply(e,t){void 0===t.type&&(void 0!==t.maxProperties||void 0!==t.minProperties)&&void 0===e.object&&(e.object=eU.z.object({}).passthrough())}},mL=class{apply(e,t){if(void 0!==t.maxProperties&&!1!==e.object){let r=e.object||eU.z.object({}).passthrough();e.object=r.refine(e=>Object.keys(e).length<=t.maxProperties,{message:`Object must have at most ${t.maxProperties} properties`})}}},mD=class{apply(e,t){if(void 0!==t.minProperties&&!1!==e.object){let r=e.object||eU.z.object({}).passthrough();e.object=r.refine(e=>Object.keys(e).length>=t.minProperties,{message:`Object must have at least ${t.minProperties} properties`})}}};function mq(e,t){if(e===t)return!0;if(null==e||null==t)return e===t;if(typeof e!=typeof t)return!1;if(Array.isArray(e)&&Array.isArray(t))return e.length===t.length&&e.every((e,r)=>mq(e,t[r]));if("object"==typeof e&&"object"==typeof t){let r=Object.keys(e),a=Object.keys(t);return r.length===a.length&&r.every(r=>a.includes(r)&&mq(e[r],t[r]))}return!1}function m$(e,t){return e.safeParse(t).success}var mF=class{apply(e,t){if(!t.not)return e;let r=m2(t.not);return e.refine(e=>!m$(r,e),{message:"Value must not match the 'not' schema"})}},mU=class{apply(e,t){return!0!==t.uniqueItems?e:e.refine(e=>{if(!Array.isArray(e))return!0;let t=[];return e.every(e=>!t.some(t=>mq(e,t))&&(t.push(e),!0))},{message:"Array items must be unique"})}},mZ=class{apply(e,t){return t.allOf&&0!==t.allOf.length?t.allOf.map(e=>m2(e)).reduce((e,t)=>eU.z.intersection(e,t),e):e}},mB=class{apply(e,t){if(!t.anyOf||0===t.anyOf.length)return e;let r=1===t.anyOf.length?m2(t.anyOf[0]):eU.z.union([m2(t.anyOf[0]),m2(t.anyOf[1]),...t.anyOf.slice(2).map(e=>m2(e))]);return eU.z.intersection(e,r)}},mV=class{apply(e,t){if(!t.oneOf||0===t.oneOf.length)return e;let r=t.oneOf.map(e=>m2(e));return e.refine(e=>{let t=0;for(let a of r)if(a.safeParse(e).success&&++t>1)return!1;return 1===t},{message:"Value must match exactly one of the oneOf schemas"})}},mK=class{apply(e,t){if(t.prefixItems&&Array.isArray(t.prefixItems)){let r=t.prefixItems.map(e=>m2(e));return e.refine(e=>{if(!Array.isArray(e))return!0;for(let t=0;t<Math.min(e.length,r.length);t++)if(!m$(r[t],e[t]))return!1;if(e.length>r.length){if("boolean"==typeof t.items&&!1===t.items)return!1;else if(t.items&&"object"==typeof t.items&&!Array.isArray(t.items)){let a=m2(t.items);for(let t=r.length;t<e.length;t++)if(!m$(a,e[t]))return!1}}return!0},{message:"Array does not match prefixItems schema"})}return e}},mG=class{apply(e,t){if(!t.properties&&!t.required&&!1!==t.additionalProperties)return e;if(e instanceof eU.z.ZodObject||e instanceof eU.z.ZodRecord){let e={};if(t.properties)for(let[r,a]of Object.entries(t.properties))void 0!==a&&(e[r]=m2(a));if(t.required&&Array.isArray(t.required)){let r=new Set(t.required);for(let t of Object.keys(e))r.has(t)||(e[t]=e[t].optional())}else for(let t of Object.keys(e))e[t]=e[t].optional();return!1===t.additionalProperties?eU.z.object(e):eU.z.object(e).passthrough()}return e.refine(e=>{if("object"!=typeof e||null===e||Array.isArray(e))return!0;if(t.properties){for(let[r,a]of Object.entries(t.properties))if(void 0!==a&&void 0!==Object.getOwnPropertyDescriptor(e,r)&&!m2(a).safeParse(e[r]).success)return!1}if(t.required&&Array.isArray(t.required)){for(let r of t.required)if(void 0===Object.getOwnPropertyDescriptor(e,r))return!1}if(!1===t.additionalProperties&&t.properties){let r=new Set(Object.keys(t.properties));for(let t in e)if(!r.has(t))return!1}return!0},{message:"Object constraints validation failed"})}},mW=class{apply(e,t){if(!t.enum||0===t.enum.length)return e;let r=t.enum.filter(e=>Array.isArray(e)||"object"==typeof e&&null!==e);return 0===r.length?e:e.refine(e=>"object"!=typeof e||null===e||r.some(t=>mq(e,t)),{message:"Value must match one of the enum values"})}},mQ=class{apply(e,t){if(void 0===t.const)return e;let r=t.const;return"object"!=typeof r||null===r?e:e.refine(e=>mq(e,r),{message:"Value must equal the const value"})}},mJ=class{apply(e,t){return t.description&&(e=e.describe(t.description)),e}},mH=class{apply(e,t){var r;return(null==(r=t.required)?void 0:r.includes("__proto__"))&&void 0===t.type?eU.z.any().refine(e=>this.validateRequired(e,t.required),{message:"Missing required properties"}):e}validateRequired(e,t){return!!("object"!=typeof e||null===e||Array.isArray(e))||t.every(t=>Object.prototype.hasOwnProperty.call(e,t))}},mY=class{apply(e,t){var r;if(void 0===t.contains)return e;let a=m2(t.contains),s=null!=(r=t.minContains)?r:1,n=t.maxContains;return e.refine(e=>{if(!Array.isArray(e))return!0;let t=0;for(let r of e)m$(a,r)&&t++;return!(t<s)&&(void 0===n||!(t>n))},{message:"Array must contain required items matching the schema"})}},mX=class{apply(e,t){let{default:r}=t;return void 0!==r&&e.safeParse(r).success?e.default(r):e}},m0=[new mv,new mb,new my,new mw,new mk,new mz,new mN,new m_,new mI,new mS,new mx,new mT,new mE,new mA,new mO,new mC,new mM,new mP,new mR,new mL,new mD,new mj],m1=[new mH,new mW,new mQ,new mZ,new mB,new mV,new mK,new mG,new mY,new mF,new mU,new mX,new mJ];function m2(e){let t;if("boolean"==typeof e)return e?eU.z.any():eU.z.never();let r={};for(let t of m0)t.apply(r,e);let a=[];if(!1!==r.string&&a.push(r.string||eU.z.string()),!1!==r.number&&a.push(r.number||eU.z.number()),!1!==r.boolean&&a.push(r.boolean||eU.z.boolean()),!1!==r.null&&a.push(r.null||eU.z.null()),!1!==r.array&&a.push(r.array||eU.z.array(eU.z.any())),!1!==r.tuple&&void 0!==r.tuple&&a.push(r.tuple),!1!==r.object)if(r.object)a.push(r.object);else{let e=eU.z.custom(e=>"object"==typeof e&&null!==e&&!Array.isArray(e),"Must be an object, not an array");a.push(e)}for(let s of(!1!==r.file&&void 0!==r.file&&a.push(r.file),t=0===a.length?eU.z.never():1===a.length?a[0]:Object.keys(e).some(e=>"$schema"!==e&&"title"!==e&&"description"!==e)?eU.z.union(a):eU.z.any(),m1))t=s.apply(t,e);return t}e.s([],172340),e.i(172340),(f=z||(z={})).assertEqual=e=>{},f.assertIs=function(e){},f.assertNever=function(e){throw Error()},f.arrayToEnum=e=>{let t={};for(let r of e)t[r]=r;return t},f.getValidEnumValues=e=>{let t=f.objectKeys(e).filter(t=>"number"!=typeof e[e[t]]),r={};for(let a of t)r[a]=e[a];return f.objectValues(r)},f.objectValues=e=>f.objectKeys(e).map(function(t){return e[t]}),f.objectKeys="function"==typeof Object.keys?e=>Object.keys(e):e=>{let t=[];for(let r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.push(r);return t},f.find=(e,t)=>{for(let r of e)if(t(r))return r},f.isInteger="function"==typeof Number.isInteger?e=>Number.isInteger(e):e=>"number"==typeof e&&Number.isFinite(e)&&Math.floor(e)===e,f.joinValues=function(e,t=" | "){return e.map(e=>"string"==typeof e?`'${e}'`:e).join(t)},f.jsonStringifyReplacer=(e,t)=>"bigint"==typeof t?t.toString():t,(M||(M={})).mergeShapes=(e,t)=>({...e,...t});let m3=z.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),m5=e=>{switch(typeof e){case"undefined":return m3.undefined;case"string":return m3.string;case"number":return Number.isNaN(e)?m3.nan:m3.number;case"boolean":return m3.boolean;case"function":return m3.function;case"bigint":return m3.bigint;case"symbol":return m3.symbol;case"object":if(Array.isArray(e))return m3.array;if(null===e)return m3.null;if(e.then&&"function"==typeof e.then&&e.catch&&"function"==typeof e.catch)return m3.promise;if("u">typeof Map&&e instanceof Map)return m3.map;if("u">typeof Set&&e instanceof Set)return m3.set;if("u">typeof Date&&e instanceof Date)return m3.date;return m3.object;default:return m3.unknown}};e.s(["ZodParsedType",0,m3,"getParsedType",0,m5,"objectUtil",()=>M,"util",()=>z],116013);let m4=z.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]),m6=e=>JSON.stringify(e,null,2).replace(/"([^"]+)":/g,"$1:");class m7 extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=e=>{this.issues=[...this.issues,e]},this.addIssues=(e=[])=>{this.issues=[...this.issues,...e]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){let t=e||function(e){return e.message},r={_errors:[]},a=e=>{for(let s of e.issues)if("invalid_union"===s.code)s.unionErrors.map(a);else if("invalid_return_type"===s.code)a(s.returnTypeError);else if("invalid_arguments"===s.code)a(s.argumentsError);else if(0===s.path.length)r._errors.push(t(s));else{let e=r,a=0;for(;a<s.path.length;){let r=s.path[a];a===s.path.length-1?(e[r]=e[r]||{_errors:[]},e[r]._errors.push(t(s))):e[r]=e[r]||{_errors:[]},e=e[r],a++}}};return a(this),r}static assert(e){if(!(e instanceof m7))throw Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,z.jsonStringifyReplacer,2)}get isEmpty(){return 0===this.issues.length}flatten(e=e=>e.message){let t={},r=[];for(let a of this.issues)if(a.path.length>0){let r=a.path[0];t[r]=t[r]||[],t[r].push(e(a))}else r.push(e(a));return{formErrors:r,fieldErrors:t}}get formErrors(){return this.flatten()}}m7.create=e=>new m7(e),e.s(["ZodError",()=>m7,"ZodIssueCode",0,m4,"quotelessJson",0,m6],332218);let m9=(e,t)=>{let r;switch(e.code){case m4.invalid_type:r=e.received===m3.undefined?"Required":`Expected ${e.expected}, received ${e.received}`;break;case m4.invalid_literal:r=`Invalid literal value, expected ${JSON.stringify(e.expected,z.jsonStringifyReplacer)}`;break;case m4.unrecognized_keys:r=`Unrecognized key(s) in object: ${z.joinValues(e.keys,", ")}`;break;case m4.invalid_union:r="Invalid input";break;case m4.invalid_union_discriminator:r=`Invalid discriminator value. Expected ${z.joinValues(e.options)}`;break;case m4.invalid_enum_value:r=`Invalid enum value. Expected ${z.joinValues(e.options)}, received '${e.received}'`;break;case m4.invalid_arguments:r="Invalid function arguments";break;case m4.invalid_return_type:r="Invalid function return type";break;case m4.invalid_date:r="Invalid date";break;case m4.invalid_string:"object"==typeof e.validation?"includes"in e.validation?(r=`Invalid input: must include "${e.validation.includes}"`,"number"==typeof e.validation.position&&(r=`${r} at one or more positions greater than or equal to ${e.validation.position}`)):"startsWith"in e.validation?r=`Invalid input: must start with "${e.validation.startsWith}"`:"endsWith"in e.validation?r=`Invalid input: must end with "${e.validation.endsWith}"`:z.assertNever(e.validation):r="regex"!==e.validation?`Invalid ${e.validation}`:"Invalid";break;case m4.too_small:r="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at least":"more than"} ${e.minimum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at least":"over"} ${e.minimum} character(s)`:"number"===e.type||"bigint"===e.type?`Number must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${e.minimum}`:"date"===e.type?`Date must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(e.minimum))}`:"Invalid input";break;case m4.too_big:r="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at most":"less than"} ${e.maximum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at most":"under"} ${e.maximum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"bigint"===e.type?`BigInt must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"date"===e.type?`Date must be ${e.exact?"exactly":e.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(e.maximum))}`:"Invalid input";break;case m4.custom:r="Invalid input";break;case m4.invalid_intersection_types:r="Intersection results could not be merged";break;case m4.not_multiple_of:r=`Number must be a multiple of ${e.multipleOf}`;break;case m4.not_finite:r="Number must be finite";break;default:r=t.defaultError,z.assertNever(e)}return{message:r}},m8=m9;function ge(e){m8=e}function gt(){return m8}e.s(["getErrorMap",()=>gt,"setErrorMap",()=>ge],913297),e.i(913297),e.s(["defaultErrorMap",0,m9,"getErrorMap",()=>gt,"setErrorMap",()=>ge],330523),e.i(330523);let gr=e=>{let{data:t,path:r,errorMaps:a,issueData:s}=e,n=[...r,...s.path||[]],i={...s,path:n};if(void 0!==s.message)return{...s,path:n,message:s.message};let o="";for(let e of a.filter(e=>!!e).slice().reverse())o=e(i,{data:t,defaultError:o}).message;return{...s,path:n,message:o}},ga=[];function gs(e,t){let r=m8,a=gr({issueData:t,data:e.data,path:e.path,errorMaps:[e.common.contextualErrorMap,e.schemaErrorMap,r,r===m9?void 0:m9].filter(e=>!!e)});e.common.issues.push(a)}class gn{constructor(){this.value="valid"}dirty(){"valid"===this.value&&(this.value="dirty")}abort(){"aborted"!==this.value&&(this.value="aborted")}static mergeArray(e,t){let r=[];for(let a of t){if("aborted"===a.status)return gi;"dirty"===a.status&&e.dirty(),r.push(a.value)}return{status:e.value,value:r}}static async mergeObjectAsync(e,t){let r=[];for(let e of t){let t=await e.key,a=await e.value;r.push({key:t,value:a})}return gn.mergeObjectSync(e,r)}static mergeObjectSync(e,t){let r={};for(let a of t){let{key:t,value:s}=a;if("aborted"===t.status||"aborted"===s.status)return gi;"dirty"===t.status&&e.dirty(),"dirty"===s.status&&e.dirty(),"__proto__"!==t.value&&(void 0!==s.value||a.alwaysSet)&&(r[t.value]=s.value)}return{status:e.value,value:r}}}let gi=Object.freeze({status:"aborted"}),go=e=>({status:"dirty",value:e}),gl=e=>({status:"valid",value:e}),gu=e=>"aborted"===e.status,gp=e=>"dirty"===e.status,gd=e=>"valid"===e.status,gc=e=>"u">typeof Promise&&e instanceof Promise;e.s(["DIRTY",0,go,"EMPTY_PATH",0,ga,"INVALID",0,gi,"OK",0,gl,"ParseStatus",()=>gn,"addIssueToContext",()=>gs,"isAborted",0,gu,"isAsync",0,gc,"isDirty",0,gp,"isValid",0,gd,"makeIssue",0,gr],506686),e.i(506686),e.s([],924389),e.i(924389),e.i(116013),(y=P||(P={})).errToObj=e=>"string"==typeof e?{message:e}:e||{},y.toString=e=>"string"==typeof e?e:e?.message;class gm{constructor(e,t,r,a){this._cachedPath=[],this.parent=e,this.data=t,this._path=r,this._key=a}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}let gg=(e,t)=>{if(gd(t))return{success:!0,data:t.value};if(!e.common.issues.length)throw Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;let t=new m7(e.common.issues);return this._error=t,this._error}}};function gh(e){if(!e)return{};let{errorMap:t,invalid_type_error:r,required_error:a,description:s}=e;if(t&&(r||a))throw Error('Can\'t use "invalid_type_error" or "required_error" in conjunction with custom error map.');return t?{errorMap:t,description:s}:{errorMap:(t,s)=>{let{message:n}=e;return"invalid_enum_value"===t.code?{message:n??s.defaultError}:void 0===s.data?{message:n??a??s.defaultError}:"invalid_type"!==t.code?{message:s.defaultError}:{message:n??r??s.defaultError}},description:s}}class gf{get description(){return this._def.description}_getType(e){return m5(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:m5(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new gn,ctx:{common:e.parent.common,data:e.data,parsedType:m5(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){let t=this._parse(e);if(gc(t))throw Error("Synchronous parse encountered promise.");return t}_parseAsync(e){return Promise.resolve(this._parse(e))}parse(e,t){let r=this.safeParse(e,t);if(r.success)return r.data;throw r.error}safeParse(e,t){let r={common:{issues:[],async:t?.async??!1,contextualErrorMap:t?.errorMap},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:m5(e)},a=this._parseSync({data:e,path:r.path,parent:r});return gg(r,a)}"~validate"(e){let t={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:m5(e)};if(!this["~standard"].async)try{let r=this._parseSync({data:e,path:[],parent:t});return gd(r)?{value:r.value}:{issues:t.common.issues}}catch(e){e?.message?.toLowerCase()?.includes("encountered")&&(this["~standard"].async=!0),t.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:t}).then(e=>gd(e)?{value:e.value}:{issues:t.common.issues})}async parseAsync(e,t){let r=await this.safeParseAsync(e,t);if(r.success)return r.data;throw r.error}async safeParseAsync(e,t){let r={common:{issues:[],contextualErrorMap:t?.errorMap,async:!0},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:m5(e)},a=this._parse({data:e,path:r.path,parent:r});return gg(r,await (gc(a)?a:Promise.resolve(a)))}refine(e,t){return this._refinement((r,a)=>{let s=e(r),n=()=>a.addIssue({code:m4.custom,..."string"==typeof t||void 0===t?{message:t}:"function"==typeof t?t(r):t});return"u">typeof Promise&&s instanceof Promise?s.then(e=>!!e||(n(),!1)):!!s||(n(),!1)})}refinement(e,t){return this._refinement((r,a)=>!!e(r)||(a.addIssue("function"==typeof t?t(r,a):t),!1))}_refinement(e){return new he({schema:this,typeName:R.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:e=>this["~validate"](e)}}optional(){return ht.create(this,this._def)}nullable(){return hr.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return gG.create(this)}promise(){return g8.create(this,this._def)}or(e){return gQ.create([this,e],this._def)}and(e){return gY.create(this,e,this._def)}transform(e){return new he({...gh(this._def),schema:this,typeName:R.ZodEffects,effect:{type:"transform",transform:e}})}default(e){return new ha({...gh(this._def),innerType:this,defaultValue:"function"==typeof e?e:()=>e,typeName:R.ZodDefault})}brand(){return new ho({typeName:R.ZodBranded,type:this,...gh(this._def)})}catch(e){return new hs({...gh(this._def),innerType:this,catchValue:"function"==typeof e?e:()=>e,typeName:R.ZodCatch})}describe(e){return new this.constructor({...this._def,description:e})}pipe(e){return hl.create(this,e)}readonly(){return hu.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}let gy=/^c[^\s-]{8,}$/i,gv=/^[0-9a-z]+$/,gb=/^[0-9A-HJKMNP-TV-Z]{26}$/i,gw=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,gk=/^[a-z0-9_-]{21}$/i,g_=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,gI=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,gS=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,gx=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,gT=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,gE=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,gA=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,gO=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,gz=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,gM="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",gP=RegExp(`^${gM}$`);function gR(e){let t="[0-5]\\d";e.precision?t=`${t}\\.\\d{${e.precision}}`:null==e.precision&&(t=`${t}(\\.\\d+)?`);let r=e.precision?"+":"?";return`([01]\\d|2[0-3]):[0-5]\\d(:${t})${r}`}function gC(e){let t=`${gM}T${gR(e)}`,r=[];return r.push(e.local?"Z?":"Z"),e.offset&&r.push("([+-]\\d{2}:?\\d{2})"),t=`${t}(${r.join("|")})`,RegExp(`^${t}$`)}class gj extends gf{_parse(e){var r,a,s,n;let i;if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==m3.string){let t=this._getOrReturnCtx(e);return gs(t,{code:m4.invalid_type,expected:m3.string,received:t.parsedType}),gi}let o=new gn;for(let l of this._def.checks)if("min"===l.kind)e.data.length<l.value&&(gs(i=this._getOrReturnCtx(e,i),{code:m4.too_small,minimum:l.value,type:"string",inclusive:!0,exact:!1,message:l.message}),o.dirty());else if("max"===l.kind)e.data.length>l.value&&(gs(i=this._getOrReturnCtx(e,i),{code:m4.too_big,maximum:l.value,type:"string",inclusive:!0,exact:!1,message:l.message}),o.dirty());else if("length"===l.kind){let t=e.data.length>l.value,r=e.data.length<l.value;(t||r)&&(i=this._getOrReturnCtx(e,i),t?gs(i,{code:m4.too_big,maximum:l.value,type:"string",inclusive:!0,exact:!0,message:l.message}):r&&gs(i,{code:m4.too_small,minimum:l.value,type:"string",inclusive:!0,exact:!0,message:l.message}),o.dirty())}else if("email"===l.kind)gS.test(e.data)||(gs(i=this._getOrReturnCtx(e,i),{validation:"email",code:m4.invalid_string,message:l.message}),o.dirty());else if("emoji"===l.kind)t||(t=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),t.test(e.data)||(gs(i=this._getOrReturnCtx(e,i),{validation:"emoji",code:m4.invalid_string,message:l.message}),o.dirty());else if("uuid"===l.kind)gw.test(e.data)||(gs(i=this._getOrReturnCtx(e,i),{validation:"uuid",code:m4.invalid_string,message:l.message}),o.dirty());else if("nanoid"===l.kind)gk.test(e.data)||(gs(i=this._getOrReturnCtx(e,i),{validation:"nanoid",code:m4.invalid_string,message:l.message}),o.dirty());else if("cuid"===l.kind)gy.test(e.data)||(gs(i=this._getOrReturnCtx(e,i),{validation:"cuid",code:m4.invalid_string,message:l.message}),o.dirty());else if("cuid2"===l.kind)gv.test(e.data)||(gs(i=this._getOrReturnCtx(e,i),{validation:"cuid2",code:m4.invalid_string,message:l.message}),o.dirty());else if("ulid"===l.kind)gb.test(e.data)||(gs(i=this._getOrReturnCtx(e,i),{validation:"ulid",code:m4.invalid_string,message:l.message}),o.dirty());else if("url"===l.kind)try{new URL(e.data)}catch{gs(i=this._getOrReturnCtx(e,i),{validation:"url",code:m4.invalid_string,message:l.message}),o.dirty()}else"regex"===l.kind?(l.regex.lastIndex=0,l.regex.test(e.data)||(gs(i=this._getOrReturnCtx(e,i),{validation:"regex",code:m4.invalid_string,message:l.message}),o.dirty())):"trim"===l.kind?e.data=e.data.trim():"includes"===l.kind?e.data.includes(l.value,l.position)||(gs(i=this._getOrReturnCtx(e,i),{code:m4.invalid_string,validation:{includes:l.value,position:l.position},message:l.message}),o.dirty()):"toLowerCase"===l.kind?e.data=e.data.toLowerCase():"toUpperCase"===l.kind?e.data=e.data.toUpperCase():"startsWith"===l.kind?e.data.startsWith(l.value)||(gs(i=this._getOrReturnCtx(e,i),{code:m4.invalid_string,validation:{startsWith:l.value},message:l.message}),o.dirty()):"endsWith"===l.kind?e.data.endsWith(l.value)||(gs(i=this._getOrReturnCtx(e,i),{code:m4.invalid_string,validation:{endsWith:l.value},message:l.message}),o.dirty()):"datetime"===l.kind?gC(l).test(e.data)||(gs(i=this._getOrReturnCtx(e,i),{code:m4.invalid_string,validation:"datetime",message:l.message}),o.dirty()):"date"===l.kind?gP.test(e.data)||(gs(i=this._getOrReturnCtx(e,i),{code:m4.invalid_string,validation:"date",message:l.message}),o.dirty()):"time"===l.kind?RegExp(`^${gR(l)}$`).test(e.data)||(gs(i=this._getOrReturnCtx(e,i),{code:m4.invalid_string,validation:"time",message:l.message}),o.dirty()):"duration"===l.kind?gI.test(e.data)||(gs(i=this._getOrReturnCtx(e,i),{validation:"duration",code:m4.invalid_string,message:l.message}),o.dirty()):"ip"===l.kind?(r=e.data,!(("v4"===(a=l.version)||!a)&&gx.test(r)||("v6"===a||!a)&&gE.test(r))&&1&&(gs(i=this._getOrReturnCtx(e,i),{validation:"ip",code:m4.invalid_string,message:l.message}),o.dirty())):"jwt"===l.kind?!function(e,t){if(!g_.test(e))return!1;try{let[r]=e.split(".");if(!r)return!1;let a=r.replace(/-/g,"+").replace(/_/g,"/").padEnd(r.length+(4-r.length%4)%4,"="),s=JSON.parse(atob(a));if("object"!=typeof s||null===s||"typ"in s&&s?.typ!=="JWT"||!s.alg||t&&s.alg!==t)return!1;return!0}catch{return!1}}(e.data,l.alg)&&(gs(i=this._getOrReturnCtx(e,i),{validation:"jwt",code:m4.invalid_string,message:l.message}),o.dirty()):"cidr"===l.kind?(s=e.data,!(("v4"===(n=l.version)||!n)&&gT.test(s)||("v6"===n||!n)&&gA.test(s))&&1&&(gs(i=this._getOrReturnCtx(e,i),{validation:"cidr",code:m4.invalid_string,message:l.message}),o.dirty())):"base64"===l.kind?gO.test(e.data)||(gs(i=this._getOrReturnCtx(e,i),{validation:"base64",code:m4.invalid_string,message:l.message}),o.dirty()):"base64url"===l.kind?gz.test(e.data)||(gs(i=this._getOrReturnCtx(e,i),{validation:"base64url",code:m4.invalid_string,message:l.message}),o.dirty()):z.assertNever(l);return{status:o.value,value:e.data}}_regex(e,t,r){return this.refinement(t=>e.test(t),{validation:t,code:m4.invalid_string,...P.errToObj(r)})}_addCheck(e){return new gj({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...P.errToObj(e)})}url(e){return this._addCheck({kind:"url",...P.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...P.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...P.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...P.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...P.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...P.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...P.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...P.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...P.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...P.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...P.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...P.errToObj(e)})}datetime(e){return"string"==typeof e?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:void 0===e?.precision?null:e?.precision,offset:e?.offset??!1,local:e?.local??!1,...P.errToObj(e?.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return"string"==typeof e?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:void 0===e?.precision?null:e?.precision,...P.errToObj(e?.message)})}duration(e){return this._addCheck({kind:"duration",...P.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...P.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t?.position,...P.errToObj(t?.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...P.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...P.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...P.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...P.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...P.errToObj(t)})}nonempty(e){return this.min(1,P.errToObj(e))}trim(){return new gj({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new gj({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new gj({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>"datetime"===e.kind)}get isDate(){return!!this._def.checks.find(e=>"date"===e.kind)}get isTime(){return!!this._def.checks.find(e=>"time"===e.kind)}get isDuration(){return!!this._def.checks.find(e=>"duration"===e.kind)}get isEmail(){return!!this._def.checks.find(e=>"email"===e.kind)}get isURL(){return!!this._def.checks.find(e=>"url"===e.kind)}get isEmoji(){return!!this._def.checks.find(e=>"emoji"===e.kind)}get isUUID(){return!!this._def.checks.find(e=>"uuid"===e.kind)}get isNANOID(){return!!this._def.checks.find(e=>"nanoid"===e.kind)}get isCUID(){return!!this._def.checks.find(e=>"cuid"===e.kind)}get isCUID2(){return!!this._def.checks.find(e=>"cuid2"===e.kind)}get isULID(){return!!this._def.checks.find(e=>"ulid"===e.kind)}get isIP(){return!!this._def.checks.find(e=>"ip"===e.kind)}get isCIDR(){return!!this._def.checks.find(e=>"cidr"===e.kind)}get isBase64(){return!!this._def.checks.find(e=>"base64"===e.kind)}get isBase64url(){return!!this._def.checks.find(e=>"base64url"===e.kind)}get minLength(){let e=null;for(let t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(let t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}gj.create=e=>new gj({checks:[],typeName:R.ZodString,coerce:e?.coerce??!1,...gh(e)});class gN extends gf{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){let t;if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==m3.number){let t=this._getOrReturnCtx(e);return gs(t,{code:m4.invalid_type,expected:m3.number,received:t.parsedType}),gi}let r=new gn;for(let a of this._def.checks)"int"===a.kind?z.isInteger(e.data)||(gs(t=this._getOrReturnCtx(e,t),{code:m4.invalid_type,expected:"integer",received:"float",message:a.message}),r.dirty()):"min"===a.kind?(a.inclusive?e.data<a.value:e.data<=a.value)&&(gs(t=this._getOrReturnCtx(e,t),{code:m4.too_small,minimum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),r.dirty()):"max"===a.kind?(a.inclusive?e.data>a.value:e.data>=a.value)&&(gs(t=this._getOrReturnCtx(e,t),{code:m4.too_big,maximum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),r.dirty()):"multipleOf"===a.kind?0!==function(e,t){let r=(e.toString().split(".")[1]||"").length,a=(t.toString().split(".")[1]||"").length,s=r>a?r:a;return Number.parseInt(e.toFixed(s).replace(".",""))%Number.parseInt(t.toFixed(s).replace(".",""))/10**s}(e.data,a.value)&&(gs(t=this._getOrReturnCtx(e,t),{code:m4.not_multiple_of,multipleOf:a.value,message:a.message}),r.dirty()):"finite"===a.kind?Number.isFinite(e.data)||(gs(t=this._getOrReturnCtx(e,t),{code:m4.not_finite,message:a.message}),r.dirty()):z.assertNever(a);return{status:r.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,P.toString(t))}gt(e,t){return this.setLimit("min",e,!1,P.toString(t))}lte(e,t){return this.setLimit("max",e,!0,P.toString(t))}lt(e,t){return this.setLimit("max",e,!1,P.toString(t))}setLimit(e,t,r,a){return new gN({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:P.toString(a)}]})}_addCheck(e){return new gN({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:P.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:P.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:P.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:P.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:P.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:P.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:P.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:P.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:P.toString(e)})}get minValue(){let e=null;for(let t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(let t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>"int"===e.kind||"multipleOf"===e.kind&&z.isInteger(e.value))}get isFinite(){let e=null,t=null;for(let r of this._def.checks)if("finite"===r.kind||"int"===r.kind||"multipleOf"===r.kind)return!0;else"min"===r.kind?(null===t||r.value>t)&&(t=r.value):"max"===r.kind&&(null===e||r.value<e)&&(e=r.value);return Number.isFinite(t)&&Number.isFinite(e)}}gN.create=e=>new gN({checks:[],typeName:R.ZodNumber,coerce:e?.coerce||!1,...gh(e)});class gL extends gf{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){let t;if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==m3.bigint)return this._getInvalidInput(e);let r=new gn;for(let a of this._def.checks)"min"===a.kind?(a.inclusive?e.data<a.value:e.data<=a.value)&&(gs(t=this._getOrReturnCtx(e,t),{code:m4.too_small,type:"bigint",minimum:a.value,inclusive:a.inclusive,message:a.message}),r.dirty()):"max"===a.kind?(a.inclusive?e.data>a.value:e.data>=a.value)&&(gs(t=this._getOrReturnCtx(e,t),{code:m4.too_big,type:"bigint",maximum:a.value,inclusive:a.inclusive,message:a.message}),r.dirty()):"multipleOf"===a.kind?e.data%a.value!==BigInt(0)&&(gs(t=this._getOrReturnCtx(e,t),{code:m4.not_multiple_of,multipleOf:a.value,message:a.message}),r.dirty()):z.assertNever(a);return{status:r.value,value:e.data}}_getInvalidInput(e){let t=this._getOrReturnCtx(e);return gs(t,{code:m4.invalid_type,expected:m3.bigint,received:t.parsedType}),gi}gte(e,t){return this.setLimit("min",e,!0,P.toString(t))}gt(e,t){return this.setLimit("min",e,!1,P.toString(t))}lte(e,t){return this.setLimit("max",e,!0,P.toString(t))}lt(e,t){return this.setLimit("max",e,!1,P.toString(t))}setLimit(e,t,r,a){return new gL({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:P.toString(a)}]})}_addCheck(e){return new gL({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:P.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:P.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:P.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:P.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:P.toString(t)})}get minValue(){let e=null;for(let t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(let t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}gL.create=e=>new gL({checks:[],typeName:R.ZodBigInt,coerce:e?.coerce??!1,...gh(e)});class gD extends gf{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==m3.boolean){let t=this._getOrReturnCtx(e);return gs(t,{code:m4.invalid_type,expected:m3.boolean,received:t.parsedType}),gi}return gl(e.data)}}gD.create=e=>new gD({typeName:R.ZodBoolean,coerce:e?.coerce||!1,...gh(e)});class gq extends gf{_parse(e){let t;if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==m3.date){let t=this._getOrReturnCtx(e);return gs(t,{code:m4.invalid_type,expected:m3.date,received:t.parsedType}),gi}if(Number.isNaN(e.data.getTime()))return gs(this._getOrReturnCtx(e),{code:m4.invalid_date}),gi;let r=new gn;for(let a of this._def.checks)"min"===a.kind?e.data.getTime()<a.value&&(gs(t=this._getOrReturnCtx(e,t),{code:m4.too_small,message:a.message,inclusive:!0,exact:!1,minimum:a.value,type:"date"}),r.dirty()):"max"===a.kind?e.data.getTime()>a.value&&(gs(t=this._getOrReturnCtx(e,t),{code:m4.too_big,message:a.message,inclusive:!0,exact:!1,maximum:a.value,type:"date"}),r.dirty()):z.assertNever(a);return{status:r.value,value:new Date(e.data.getTime())}}_addCheck(e){return new gq({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:P.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:P.toString(t)})}get minDate(){let e=null;for(let t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return null!=e?new Date(e):null}get maxDate(){let e=null;for(let t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return null!=e?new Date(e):null}}gq.create=e=>new gq({checks:[],coerce:e?.coerce||!1,typeName:R.ZodDate,...gh(e)});class g$ extends gf{_parse(e){if(this._getType(e)!==m3.symbol){let t=this._getOrReturnCtx(e);return gs(t,{code:m4.invalid_type,expected:m3.symbol,received:t.parsedType}),gi}return gl(e.data)}}g$.create=e=>new g$({typeName:R.ZodSymbol,...gh(e)});class gF extends gf{_parse(e){if(this._getType(e)!==m3.undefined){let t=this._getOrReturnCtx(e);return gs(t,{code:m4.invalid_type,expected:m3.undefined,received:t.parsedType}),gi}return gl(e.data)}}gF.create=e=>new gF({typeName:R.ZodUndefined,...gh(e)});class gU extends gf{_parse(e){if(this._getType(e)!==m3.null){let t=this._getOrReturnCtx(e);return gs(t,{code:m4.invalid_type,expected:m3.null,received:t.parsedType}),gi}return gl(e.data)}}gU.create=e=>new gU({typeName:R.ZodNull,...gh(e)});class gZ extends gf{constructor(){super(...arguments),this._any=!0}_parse(e){return gl(e.data)}}gZ.create=e=>new gZ({typeName:R.ZodAny,...gh(e)});class gB extends gf{constructor(){super(...arguments),this._unknown=!0}_parse(e){return gl(e.data)}}gB.create=e=>new gB({typeName:R.ZodUnknown,...gh(e)});class gV extends gf{_parse(e){let t=this._getOrReturnCtx(e);return gs(t,{code:m4.invalid_type,expected:m3.never,received:t.parsedType}),gi}}gV.create=e=>new gV({typeName:R.ZodNever,...gh(e)});class gK extends gf{_parse(e){if(this._getType(e)!==m3.undefined){let t=this._getOrReturnCtx(e);return gs(t,{code:m4.invalid_type,expected:m3.void,received:t.parsedType}),gi}return gl(e.data)}}gK.create=e=>new gK({typeName:R.ZodVoid,...gh(e)});class gG extends gf{_parse(e){let{ctx:t,status:r}=this._processInputParams(e),a=this._def;if(t.parsedType!==m3.array)return gs(t,{code:m4.invalid_type,expected:m3.array,received:t.parsedType}),gi;if(null!==a.exactLength){let e=t.data.length>a.exactLength.value,s=t.data.length<a.exactLength.value;(e||s)&&(gs(t,{code:e?m4.too_big:m4.too_small,minimum:s?a.exactLength.value:void 0,maximum:e?a.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:a.exactLength.message}),r.dirty())}if(null!==a.minLength&&t.data.length<a.minLength.value&&(gs(t,{code:m4.too_small,minimum:a.minLength.value,type:"array",inclusive:!0,exact:!1,message:a.minLength.message}),r.dirty()),null!==a.maxLength&&t.data.length>a.maxLength.value&&(gs(t,{code:m4.too_big,maximum:a.maxLength.value,type:"array",inclusive:!0,exact:!1,message:a.maxLength.message}),r.dirty()),t.common.async)return Promise.all([...t.data].map((e,r)=>a.type._parseAsync(new gm(t,e,t.path,r)))).then(e=>gn.mergeArray(r,e));let s=[...t.data].map((e,r)=>a.type._parseSync(new gm(t,e,t.path,r)));return gn.mergeArray(r,s)}get element(){return this._def.type}min(e,t){return new gG({...this._def,minLength:{value:e,message:P.toString(t)}})}max(e,t){return new gG({...this._def,maxLength:{value:e,message:P.toString(t)}})}length(e,t){return new gG({...this._def,exactLength:{value:e,message:P.toString(t)}})}nonempty(e){return this.min(1,e)}}gG.create=(e,t)=>new gG({type:e,minLength:null,maxLength:null,exactLength:null,typeName:R.ZodArray,...gh(t)});class gW extends gf{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(null!==this._cached)return this._cached;let e=this._def.shape(),t=z.objectKeys(e);return this._cached={shape:e,keys:t},this._cached}_parse(e){if(this._getType(e)!==m3.object){let t=this._getOrReturnCtx(e);return gs(t,{code:m4.invalid_type,expected:m3.object,received:t.parsedType}),gi}let{status:t,ctx:r}=this._processInputParams(e),{shape:a,keys:s}=this._getCached(),n=[];if(!(this._def.catchall instanceof gV&&"strip"===this._def.unknownKeys))for(let e in r.data)s.includes(e)||n.push(e);let i=[];for(let e of s){let t=a[e],s=r.data[e];i.push({key:{status:"valid",value:e},value:t._parse(new gm(r,s,r.path,e)),alwaysSet:e in r.data})}if(this._def.catchall instanceof gV){let e=this._def.unknownKeys;if("passthrough"===e)for(let e of n)i.push({key:{status:"valid",value:e},value:{status:"valid",value:r.data[e]}});else if("strict"===e)n.length>0&&(gs(r,{code:m4.unrecognized_keys,keys:n}),t.dirty());else if("strip"===e);else throw Error("Internal ZodObject error: invalid unknownKeys value.")}else{let e=this._def.catchall;for(let t of n){let a=r.data[t];i.push({key:{status:"valid",value:t},value:e._parse(new gm(r,a,r.path,t)),alwaysSet:t in r.data})}}return r.common.async?Promise.resolve().then(async()=>{let e=[];for(let t of i){let r=await t.key,a=await t.value;e.push({key:r,value:a,alwaysSet:t.alwaysSet})}return e}).then(e=>gn.mergeObjectSync(t,e)):gn.mergeObjectSync(t,i)}get shape(){return this._def.shape()}strict(e){return P.errToObj,new gW({...this._def,unknownKeys:"strict",...void 0!==e?{errorMap:(t,r)=>{let a=this._def.errorMap?.(t,r).message??r.defaultError;return"unrecognized_keys"===t.code?{message:P.errToObj(e).message??a}:{message:a}}}:{}})}strip(){return new gW({...this._def,unknownKeys:"strip"})}passthrough(){return new gW({...this._def,unknownKeys:"passthrough"})}extend(e){return new gW({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new gW({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:R.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new gW({...this._def,catchall:e})}pick(e){let t={};for(let r of z.objectKeys(e))e[r]&&this.shape[r]&&(t[r]=this.shape[r]);return new gW({...this._def,shape:()=>t})}omit(e){let t={};for(let r of z.objectKeys(this.shape))e[r]||(t[r]=this.shape[r]);return new gW({...this._def,shape:()=>t})}deepPartial(){return function e(t){if(t instanceof gW){let r={};for(let a in t.shape){let s=t.shape[a];r[a]=ht.create(e(s))}return new gW({...t._def,shape:()=>r})}if(t instanceof gG)return new gG({...t._def,type:e(t.element)});if(t instanceof ht)return ht.create(e(t.unwrap()));if(t instanceof hr)return hr.create(e(t.unwrap()));if(t instanceof gX)return gX.create(t.items.map(t=>e(t)));else return t}(this)}partial(e){let t={};for(let r of z.objectKeys(this.shape)){let a=this.shape[r];e&&!e[r]?t[r]=a:t[r]=a.optional()}return new gW({...this._def,shape:()=>t})}required(e){let t={};for(let r of z.objectKeys(this.shape))if(e&&!e[r])t[r]=this.shape[r];else{let e=this.shape[r];for(;e instanceof ht;)e=e._def.innerType;t[r]=e}return new gW({...this._def,shape:()=>t})}keyof(){return g6(z.objectKeys(this.shape))}}gW.create=(e,t)=>new gW({shape:()=>e,unknownKeys:"strip",catchall:gV.create(),typeName:R.ZodObject,...gh(t)}),gW.strictCreate=(e,t)=>new gW({shape:()=>e,unknownKeys:"strict",catchall:gV.create(),typeName:R.ZodObject,...gh(t)}),gW.lazycreate=(e,t)=>new gW({shape:e,unknownKeys:"strip",catchall:gV.create(),typeName:R.ZodObject,...gh(t)});class gQ extends gf{_parse(e){let{ctx:t}=this._processInputParams(e),r=this._def.options;if(t.common.async)return Promise.all(r.map(async e=>{let r={...t,common:{...t.common,issues:[]},parent:null};return{result:await e._parseAsync({data:t.data,path:t.path,parent:r}),ctx:r}})).then(function(e){for(let t of e)if("valid"===t.result.status)return t.result;for(let r of e)if("dirty"===r.result.status)return t.common.issues.push(...r.ctx.common.issues),r.result;let r=e.map(e=>new m7(e.ctx.common.issues));return gs(t,{code:m4.invalid_union,unionErrors:r}),gi});{let e,a=[];for(let s of r){let r={...t,common:{...t.common,issues:[]},parent:null},n=s._parseSync({data:t.data,path:t.path,parent:r});if("valid"===n.status)return n;"dirty"!==n.status||e||(e={result:n,ctx:r}),r.common.issues.length&&a.push(r.common.issues)}if(e)return t.common.issues.push(...e.ctx.common.issues),e.result;let s=a.map(e=>new m7(e));return gs(t,{code:m4.invalid_union,unionErrors:s}),gi}}get options(){return this._def.options}}gQ.create=(e,t)=>new gQ({options:e,typeName:R.ZodUnion,...gh(t)});let gJ=e=>{if(e instanceof g5)return gJ(e.schema);if(e instanceof he)return gJ(e.innerType());if(e instanceof g4)return[e.value];if(e instanceof g7)return e.options;if(e instanceof g9)return z.objectValues(e.enum);else if(e instanceof ha)return gJ(e._def.innerType);else if(e instanceof gF)return[void 0];else if(e instanceof gU)return[null];else if(e instanceof ht)return[void 0,...gJ(e.unwrap())];else if(e instanceof hr)return[null,...gJ(e.unwrap())];else if(e instanceof ho)return gJ(e.unwrap());else if(e instanceof hu)return gJ(e.unwrap());else if(e instanceof hs)return gJ(e._def.innerType);else return[]};class gH extends gf{_parse(e){let{ctx:t}=this._processInputParams(e);if(t.parsedType!==m3.object)return gs(t,{code:m4.invalid_type,expected:m3.object,received:t.parsedType}),gi;let r=this.discriminator,a=t.data[r],s=this.optionsMap.get(a);return s?t.common.async?s._parseAsync({data:t.data,path:t.path,parent:t}):s._parseSync({data:t.data,path:t.path,parent:t}):(gs(t,{code:m4.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[r]}),gi)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,r){let a=new Map;for(let r of t){let t=gJ(r.shape[e]);if(!t.length)throw Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(let s of t){if(a.has(s))throw Error(`Discriminator property ${String(e)} has duplicate value ${String(s)}`);a.set(s,r)}}return new gH({typeName:R.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:a,...gh(r)})}}class gY extends gf{_parse(e){let{status:t,ctx:r}=this._processInputParams(e),a=(e,a)=>{if(gu(e)||gu(a))return gi;let s=function e(t,r){let a=m5(t),s=m5(r);if(t===r)return{valid:!0,data:t};if(a===m3.object&&s===m3.object){let a=z.objectKeys(r),s=z.objectKeys(t).filter(e=>-1!==a.indexOf(e)),n={...t,...r};for(let a of s){let s=e(t[a],r[a]);if(!s.valid)return{valid:!1};n[a]=s.data}return{valid:!0,data:n}}if(a===m3.array&&s===m3.array){if(t.length!==r.length)return{valid:!1};let a=[];for(let s=0;s<t.length;s++){let n=e(t[s],r[s]);if(!n.valid)return{valid:!1};a.push(n.data)}return{valid:!0,data:a}}if(a===m3.date&&s===m3.date&&+t==+r)return{valid:!0,data:t};return{valid:!1}}(e.value,a.value);return s.valid?((gp(e)||gp(a))&&t.dirty(),{status:t.value,value:s.data}):(gs(r,{code:m4.invalid_intersection_types}),gi)};return r.common.async?Promise.all([this._def.left._parseAsync({data:r.data,path:r.path,parent:r}),this._def.right._parseAsync({data:r.data,path:r.path,parent:r})]).then(([e,t])=>a(e,t)):a(this._def.left._parseSync({data:r.data,path:r.path,parent:r}),this._def.right._parseSync({data:r.data,path:r.path,parent:r}))}}gY.create=(e,t,r)=>new gY({left:e,right:t,typeName:R.ZodIntersection,...gh(r)});class gX extends gf{_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==m3.array)return gs(r,{code:m4.invalid_type,expected:m3.array,received:r.parsedType}),gi;if(r.data.length<this._def.items.length)return gs(r,{code:m4.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),gi;!this._def.rest&&r.data.length>this._def.items.length&&(gs(r,{code:m4.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());let a=[...r.data].map((e,t)=>{let a=this._def.items[t]||this._def.rest;return a?a._parse(new gm(r,e,r.path,t)):null}).filter(e=>!!e);return r.common.async?Promise.all(a).then(e=>gn.mergeArray(t,e)):gn.mergeArray(t,a)}get items(){return this._def.items}rest(e){return new gX({...this._def,rest:e})}}gX.create=(e,t)=>{if(!Array.isArray(e))throw Error("You must pass an array of schemas to z.tuple([ ... ])");return new gX({items:e,typeName:R.ZodTuple,rest:null,...gh(t)})};class g0 extends gf{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==m3.object)return gs(r,{code:m4.invalid_type,expected:m3.object,received:r.parsedType}),gi;let a=[],s=this._def.keyType,n=this._def.valueType;for(let e in r.data)a.push({key:s._parse(new gm(r,e,r.path,e)),value:n._parse(new gm(r,r.data[e],r.path,e)),alwaysSet:e in r.data});return r.common.async?gn.mergeObjectAsync(t,a):gn.mergeObjectSync(t,a)}get element(){return this._def.valueType}static create(e,t,r){return new g0(t instanceof gf?{keyType:e,valueType:t,typeName:R.ZodRecord,...gh(r)}:{keyType:gj.create(),valueType:e,typeName:R.ZodRecord,...gh(t)})}}class g1 extends gf{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==m3.map)return gs(r,{code:m4.invalid_type,expected:m3.map,received:r.parsedType}),gi;let a=this._def.keyType,s=this._def.valueType,n=[...r.data.entries()].map(([e,t],n)=>({key:a._parse(new gm(r,e,r.path,[n,"key"])),value:s._parse(new gm(r,t,r.path,[n,"value"]))}));if(r.common.async){let e=new Map;return Promise.resolve().then(async()=>{for(let r of n){let a=await r.key,s=await r.value;if("aborted"===a.status||"aborted"===s.status)return gi;("dirty"===a.status||"dirty"===s.status)&&t.dirty(),e.set(a.value,s.value)}return{status:t.value,value:e}})}{let e=new Map;for(let r of n){let a=r.key,s=r.value;if("aborted"===a.status||"aborted"===s.status)return gi;("dirty"===a.status||"dirty"===s.status)&&t.dirty(),e.set(a.value,s.value)}return{status:t.value,value:e}}}}g1.create=(e,t,r)=>new g1({valueType:t,keyType:e,typeName:R.ZodMap,...gh(r)});class g2 extends gf{_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==m3.set)return gs(r,{code:m4.invalid_type,expected:m3.set,received:r.parsedType}),gi;let a=this._def;null!==a.minSize&&r.data.size<a.minSize.value&&(gs(r,{code:m4.too_small,minimum:a.minSize.value,type:"set",inclusive:!0,exact:!1,message:a.minSize.message}),t.dirty()),null!==a.maxSize&&r.data.size>a.maxSize.value&&(gs(r,{code:m4.too_big,maximum:a.maxSize.value,type:"set",inclusive:!0,exact:!1,message:a.maxSize.message}),t.dirty());let s=this._def.valueType;function n(e){let r=new Set;for(let a of e){if("aborted"===a.status)return gi;"dirty"===a.status&&t.dirty(),r.add(a.value)}return{status:t.value,value:r}}let i=[...r.data.values()].map((e,t)=>s._parse(new gm(r,e,r.path,t)));return r.common.async?Promise.all(i).then(e=>n(e)):n(i)}min(e,t){return new g2({...this._def,minSize:{value:e,message:P.toString(t)}})}max(e,t){return new g2({...this._def,maxSize:{value:e,message:P.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}g2.create=(e,t)=>new g2({valueType:e,minSize:null,maxSize:null,typeName:R.ZodSet,...gh(t)});class g3 extends gf{constructor(){super(...arguments),this.validate=this.implement}_parse(e){let{ctx:t}=this._processInputParams(e);if(t.parsedType!==m3.function)return gs(t,{code:m4.invalid_type,expected:m3.function,received:t.parsedType}),gi;function r(e,r){return gr({data:e,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,m8,m9].filter(e=>!!e),issueData:{code:m4.invalid_arguments,argumentsError:r}})}function a(e,r){return gr({data:e,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,m8,m9].filter(e=>!!e),issueData:{code:m4.invalid_return_type,returnTypeError:r}})}let s={errorMap:t.common.contextualErrorMap},n=t.data;if(this._def.returns instanceof g8){let e=this;return gl(async function(...t){let i=new m7([]),o=await e._def.args.parseAsync(t,s).catch(e=>{throw i.addIssue(r(t,e)),i}),l=await Reflect.apply(n,this,o);return await e._def.returns._def.type.parseAsync(l,s).catch(e=>{throw i.addIssue(a(l,e)),i})})}{let e=this;return gl(function(...t){let i=e._def.args.safeParse(t,s);if(!i.success)throw new m7([r(t,i.error)]);let o=Reflect.apply(n,this,i.data),l=e._def.returns.safeParse(o,s);if(!l.success)throw new m7([a(o,l.error)]);return l.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new g3({...this._def,args:gX.create(e).rest(gB.create())})}returns(e){return new g3({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,t,r){return new g3({args:e||gX.create([]).rest(gB.create()),returns:t||gB.create(),typeName:R.ZodFunction,...gh(r)})}}class g5 extends gf{get schema(){return this._def.getter()}_parse(e){let{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}g5.create=(e,t)=>new g5({getter:e,typeName:R.ZodLazy,...gh(t)});class g4 extends gf{_parse(e){if(e.data!==this._def.value){let t=this._getOrReturnCtx(e);return gs(t,{received:t.data,code:m4.invalid_literal,expected:this._def.value}),gi}return{status:"valid",value:e.data}}get value(){return this._def.value}}function g6(e,t){return new g7({values:e,typeName:R.ZodEnum,...gh(t)})}g4.create=(e,t)=>new g4({value:e,typeName:R.ZodLiteral,...gh(t)});class g7 extends gf{_parse(e){if("string"!=typeof e.data){let t=this._getOrReturnCtx(e),r=this._def.values;return gs(t,{expected:z.joinValues(r),received:t.parsedType,code:m4.invalid_type}),gi}if(this._cache||(this._cache=new Set(this._def.values)),!this._cache.has(e.data)){let t=this._getOrReturnCtx(e),r=this._def.values;return gs(t,{received:t.data,code:m4.invalid_enum_value,options:r}),gi}return gl(e.data)}get options(){return this._def.values}get enum(){let e={};for(let t of this._def.values)e[t]=t;return e}get Values(){let e={};for(let t of this._def.values)e[t]=t;return e}get Enum(){let e={};for(let t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return g7.create(e,{...this._def,...t})}exclude(e,t=this._def){return g7.create(this.options.filter(t=>!e.includes(t)),{...this._def,...t})}}g7.create=g6;class g9 extends gf{_parse(e){let t=z.getValidEnumValues(this._def.values),r=this._getOrReturnCtx(e);if(r.parsedType!==m3.string&&r.parsedType!==m3.number){let e=z.objectValues(t);return gs(r,{expected:z.joinValues(e),received:r.parsedType,code:m4.invalid_type}),gi}if(this._cache||(this._cache=new Set(z.getValidEnumValues(this._def.values))),!this._cache.has(e.data)){let e=z.objectValues(t);return gs(r,{received:r.data,code:m4.invalid_enum_value,options:e}),gi}return gl(e.data)}get enum(){return this._def.values}}g9.create=(e,t)=>new g9({values:e,typeName:R.ZodNativeEnum,...gh(t)});class g8 extends gf{unwrap(){return this._def.type}_parse(e){let{ctx:t}=this._processInputParams(e);return t.parsedType!==m3.promise&&!1===t.common.async?(gs(t,{code:m4.invalid_type,expected:m3.promise,received:t.parsedType}),gi):gl((t.parsedType===m3.promise?t.data:Promise.resolve(t.data)).then(e=>this._def.type.parseAsync(e,{path:t.path,errorMap:t.common.contextualErrorMap})))}}g8.create=(e,t)=>new g8({type:e,typeName:R.ZodPromise,...gh(t)});class he extends gf{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===R.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){let{status:t,ctx:r}=this._processInputParams(e),a=this._def.effect||null,s={addIssue:e=>{gs(r,e),e.fatal?t.abort():t.dirty()},get path(){return r.path}};if(s.addIssue=s.addIssue.bind(s),"preprocess"===a.type){let e=a.transform(r.data,s);if(r.common.async)return Promise.resolve(e).then(async e=>{if("aborted"===t.value)return gi;let a=await this._def.schema._parseAsync({data:e,path:r.path,parent:r});return"aborted"===a.status?gi:"dirty"===a.status||"dirty"===t.value?go(a.value):a});{if("aborted"===t.value)return gi;let a=this._def.schema._parseSync({data:e,path:r.path,parent:r});return"aborted"===a.status?gi:"dirty"===a.status||"dirty"===t.value?go(a.value):a}}if("refinement"===a.type){let e=e=>{let t=a.refinement(e,s);if(r.common.async)return Promise.resolve(t);if(t instanceof Promise)throw Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return e};if(!1!==r.common.async)return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(r=>"aborted"===r.status?gi:("dirty"===r.status&&t.dirty(),e(r.value).then(()=>({status:t.value,value:r.value}))));{let a=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});return"aborted"===a.status?gi:("dirty"===a.status&&t.dirty(),e(a.value),{status:t.value,value:a.value})}}if("transform"===a.type)if(!1!==r.common.async)return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(e=>gd(e)?Promise.resolve(a.transform(e.value,s)).then(e=>({status:t.value,value:e})):gi);else{let e=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});if(!gd(e))return gi;let n=a.transform(e.value,s);if(n instanceof Promise)throw Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:n}}z.assertNever(a)}}he.create=(e,t,r)=>new he({schema:e,typeName:R.ZodEffects,effect:t,...gh(r)}),he.createWithPreprocess=(e,t,r)=>new he({schema:t,effect:{type:"preprocess",transform:e},typeName:R.ZodEffects,...gh(r)});class ht extends gf{_parse(e){return this._getType(e)===m3.undefined?gl(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}ht.create=(e,t)=>new ht({innerType:e,typeName:R.ZodOptional,...gh(t)});class hr extends gf{_parse(e){return this._getType(e)===m3.null?gl(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}hr.create=(e,t)=>new hr({innerType:e,typeName:R.ZodNullable,...gh(t)});class ha extends gf{_parse(e){let{ctx:t}=this._processInputParams(e),r=t.data;return t.parsedType===m3.undefined&&(r=this._def.defaultValue()),this._def.innerType._parse({data:r,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}ha.create=(e,t)=>new ha({innerType:e,typeName:R.ZodDefault,defaultValue:"function"==typeof t.default?t.default:()=>t.default,...gh(t)});class hs extends gf{_parse(e){let{ctx:t}=this._processInputParams(e),r={...t,common:{...t.common,issues:[]}},a=this._def.innerType._parse({data:r.data,path:r.path,parent:{...r}});return gc(a)?a.then(e=>({status:"valid",value:"valid"===e.status?e.value:this._def.catchValue({get error(){return new m7(r.common.issues)},input:r.data})})):{status:"valid",value:"valid"===a.status?a.value:this._def.catchValue({get error(){return new m7(r.common.issues)},input:r.data})}}removeCatch(){return this._def.innerType}}hs.create=(e,t)=>new hs({innerType:e,typeName:R.ZodCatch,catchValue:"function"==typeof t.catch?t.catch:()=>t.catch,...gh(t)});class hn extends gf{_parse(e){if(this._getType(e)!==m3.nan){let t=this._getOrReturnCtx(e);return gs(t,{code:m4.invalid_type,expected:m3.nan,received:t.parsedType}),gi}return{status:"valid",value:e.data}}}hn.create=e=>new hn({typeName:R.ZodNaN,...gh(e)});let hi=Symbol("zod_brand");class ho extends gf{_parse(e){let{ctx:t}=this._processInputParams(e),r=t.data;return this._def.type._parse({data:r,path:t.path,parent:t})}unwrap(){return this._def.type}}class hl extends gf{_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.common.async)return(async()=>{let e=await this._def.in._parseAsync({data:r.data,path:r.path,parent:r});return"aborted"===e.status?gi:"dirty"===e.status?(t.dirty(),go(e.value)):this._def.out._parseAsync({data:e.value,path:r.path,parent:r})})();{let e=this._def.in._parseSync({data:r.data,path:r.path,parent:r});return"aborted"===e.status?gi:"dirty"===e.status?(t.dirty(),{status:"dirty",value:e.value}):this._def.out._parseSync({data:e.value,path:r.path,parent:r})}}static create(e,t){return new hl({in:e,out:t,typeName:R.ZodPipeline})}}class hu extends gf{_parse(e){let t=this._def.innerType._parse(e),r=e=>(gd(e)&&(e.value=Object.freeze(e.value)),e);return gc(t)?t.then(e=>r(e)):r(t)}unwrap(){return this._def.innerType}}function hp(e,t){let r="function"==typeof e?e(t):"string"==typeof e?{message:e}:e;return"string"==typeof r?{message:r}:r}function hd(e,t={},r){return e?gZ.create().superRefine((a,s)=>{let n=e(a);if(n instanceof Promise)return n.then(e=>{if(!e){let e=hp(t,a),n=e.fatal??r??!0;s.addIssue({code:"custom",...e,fatal:n})}});if(!n){let e=hp(t,a),n=e.fatal??r??!0;s.addIssue({code:"custom",...e,fatal:n})}}):gZ.create()}hu.create=(e,t)=>new hu({innerType:e,typeName:R.ZodReadonly,...gh(t)});let hc={object:gW.lazycreate};(v=R||(R={})).ZodString="ZodString",v.ZodNumber="ZodNumber",v.ZodNaN="ZodNaN",v.ZodBigInt="ZodBigInt",v.ZodBoolean="ZodBoolean",v.ZodDate="ZodDate",v.ZodSymbol="ZodSymbol",v.ZodUndefined="ZodUndefined",v.ZodNull="ZodNull",v.ZodAny="ZodAny",v.ZodUnknown="ZodUnknown",v.ZodNever="ZodNever",v.ZodVoid="ZodVoid",v.ZodArray="ZodArray",v.ZodObject="ZodObject",v.ZodUnion="ZodUnion",v.ZodDiscriminatedUnion="ZodDiscriminatedUnion",v.ZodIntersection="ZodIntersection",v.ZodTuple="ZodTuple",v.ZodRecord="ZodRecord",v.ZodMap="ZodMap",v.ZodSet="ZodSet",v.ZodFunction="ZodFunction",v.ZodLazy="ZodLazy",v.ZodLiteral="ZodLiteral",v.ZodEnum="ZodEnum",v.ZodEffects="ZodEffects",v.ZodNativeEnum="ZodNativeEnum",v.ZodOptional="ZodOptional",v.ZodNullable="ZodNullable",v.ZodDefault="ZodDefault",v.ZodCatch="ZodCatch",v.ZodPromise="ZodPromise",v.ZodBranded="ZodBranded",v.ZodPipeline="ZodPipeline",v.ZodReadonly="ZodReadonly";let hm=(e,t={message:`Input not instance of ${e.name}`})=>hd(t=>t instanceof e,t),hg=gj.create,hh=gN.create,hf=hn.create,hy=gL.create,hv=gD.create,hb=gq.create,hw=g$.create,hk=gF.create,h_=gU.create,hI=gZ.create,hS=gB.create,hx=gV.create,hT=gK.create,hE=gG.create,hA=gW.create,hO=gW.strictCreate,hz=gQ.create,hM=gH.create,hP=gY.create,hR=gX.create,hC=g0.create,hj=g1.create,hN=g2.create,hL=g3.create,hD=g5.create,hq=g4.create,h$=g7.create,hF=g9.create,hU=g8.create,hZ=he.create,hB=ht.create,hV=hr.create,hK=he.createWithPreprocess,hG=hl.create,hW=()=>hg().optional(),hQ=()=>hh().optional(),hJ=()=>hv().optional(),hH={string:e=>gj.create({...e,coerce:!0}),number:e=>gN.create({...e,coerce:!0}),boolean:e=>gD.create({...e,coerce:!0}),bigint:e=>gL.create({...e,coerce:!0}),date:e=>gq.create({...e,coerce:!0})};e.s(["BRAND",0,hi,"NEVER",0,gi,"Schema",()=>gf,"ZodAny",()=>gZ,"ZodArray",()=>gG,"ZodBigInt",()=>gL,"ZodBoolean",()=>gD,"ZodBranded",()=>ho,"ZodCatch",()=>hs,"ZodDate",()=>gq,"ZodDefault",()=>ha,"ZodDiscriminatedUnion",()=>gH,"ZodEffects",()=>he,"ZodEnum",()=>g7,"ZodFirstPartyTypeKind",()=>R,"ZodFunction",()=>g3,"ZodIntersection",()=>gY,"ZodLazy",()=>g5,"ZodLiteral",()=>g4,"ZodMap",()=>g1,"ZodNaN",()=>hn,"ZodNativeEnum",()=>g9,"ZodNever",()=>gV,"ZodNull",()=>gU,"ZodNullable",()=>hr,"ZodNumber",()=>gN,"ZodObject",()=>gW,"ZodOptional",()=>ht,"ZodPipeline",()=>hl,"ZodPromise",()=>g8,"ZodReadonly",()=>hu,"ZodRecord",()=>g0,"ZodSchema",()=>gf,"ZodSet",()=>g2,"ZodString",()=>gj,"ZodSymbol",()=>g$,"ZodTransformer",()=>he,"ZodTuple",()=>gX,"ZodType",()=>gf,"ZodUndefined",()=>gF,"ZodUnion",()=>gQ,"ZodUnknown",()=>gB,"ZodVoid",()=>gK,"any",()=>hI,"array",()=>hE,"bigint",()=>hy,"boolean",()=>hv,"coerce",0,hH,"custom",()=>hd,"date",()=>hb,"datetimeRegex",()=>gC,"discriminatedUnion",()=>hM,"effect",()=>hZ,"enum",()=>h$,"function",()=>hL,"instanceof",()=>hm,"intersection",()=>hP,"late",0,hc,"lazy",()=>hD,"literal",()=>hq,"map",()=>hj,"nan",()=>hf,"nativeEnum",()=>hF,"never",()=>hx,"null",()=>h_,"nullable",()=>hV,"number",()=>hh,"object",()=>hA,"oboolean",()=>hJ,"onumber",()=>hQ,"optional",()=>hB,"ostring",()=>hW,"pipeline",()=>hG,"preprocess",()=>hK,"promise",()=>hU,"record",()=>hC,"set",()=>hN,"strictObject",()=>hO,"string",()=>hg,"symbol",()=>hw,"transformer",()=>hZ,"tuple",()=>hR,"undefined",()=>hk,"union",()=>hz,"unknown",()=>hS,"void",()=>hT],291478),e.i(291478),e.i(332218),e.s(["BRAND",0,hi,"DIRTY",0,go,"EMPTY_PATH",0,ga,"INVALID",0,gi,"NEVER",0,gi,"OK",0,gl,"ParseStatus",()=>gn,"Schema",()=>gf,"ZodAny",()=>gZ,"ZodArray",()=>gG,"ZodBigInt",()=>gL,"ZodBoolean",()=>gD,"ZodBranded",()=>ho,"ZodCatch",()=>hs,"ZodDate",()=>gq,"ZodDefault",()=>ha,"ZodDiscriminatedUnion",()=>gH,"ZodEffects",()=>he,"ZodEnum",()=>g7,"ZodError",()=>m7,"ZodFirstPartyTypeKind",()=>R,"ZodFunction",()=>g3,"ZodIntersection",()=>gY,"ZodIssueCode",0,m4,"ZodLazy",()=>g5,"ZodLiteral",()=>g4,"ZodMap",()=>g1,"ZodNaN",()=>hn,"ZodNativeEnum",()=>g9,"ZodNever",()=>gV,"ZodNull",()=>gU,"ZodNullable",()=>hr,"ZodNumber",()=>gN,"ZodObject",()=>gW,"ZodOptional",()=>ht,"ZodParsedType",0,m3,"ZodPipeline",()=>hl,"ZodPromise",()=>g8,"ZodReadonly",()=>hu,"ZodRecord",()=>g0,"ZodSchema",()=>gf,"ZodSet",()=>g2,"ZodString",()=>gj,"ZodSymbol",()=>g$,"ZodTransformer",()=>he,"ZodTuple",()=>gX,"ZodType",()=>gf,"ZodUndefined",()=>gF,"ZodUnion",()=>gQ,"ZodUnknown",()=>gB,"ZodVoid",()=>gK,"addIssueToContext",()=>gs,"any",()=>hI,"array",()=>hE,"bigint",()=>hy,"boolean",()=>hv,"coerce",0,hH,"custom",()=>hd,"date",()=>hb,"datetimeRegex",()=>gC,"defaultErrorMap",0,m9,"discriminatedUnion",()=>hM,"effect",()=>hZ,"enum",()=>h$,"function",()=>hL,"getErrorMap",()=>gt,"getParsedType",0,m5,"instanceof",()=>hm,"intersection",()=>hP,"isAborted",0,gu,"isAsync",0,gc,"isDirty",0,gp,"isValid",0,gd,"late",0,hc,"lazy",()=>hD,"literal",()=>hq,"makeIssue",0,gr,"map",()=>hj,"nan",()=>hf,"nativeEnum",()=>hF,"never",()=>hx,"null",()=>h_,"nullable",()=>hV,"number",()=>hh,"object",()=>hA,"objectUtil",()=>M,"oboolean",()=>hJ,"onumber",()=>hQ,"optional",()=>hB,"ostring",()=>hW,"pipeline",()=>hG,"preprocess",()=>hK,"promise",()=>hU,"quotelessJson",0,m6,"record",()=>hC,"set",()=>hN,"setErrorMap",()=>ge,"strictObject",()=>hO,"string",()=>hg,"symbol",()=>hw,"transformer",()=>hZ,"tuple",()=>hR,"undefined",()=>hk,"union",()=>hz,"unknown",()=>hS,"util",()=>z,"void",()=>hT],747981);var hY=e.i(747981),hY=hY,hX=Object.create,h0=Object.defineProperty,h1=Object.getOwnPropertyDescriptor,h2=Object.getOwnPropertyNames,h3=Object.getPrototypeOf,h5=Object.prototype.hasOwnProperty,h4=(i={"../../../node_modules/.pnpm/secure-json-parse@2.7.0/node_modules/secure-json-parse/index.js"(e,t){var r="u">typeof Buffer,a=/"(?:_|\\u005[Ff])(?:_|\\u005[Ff])(?:p|\\u0070)(?:r|\\u0072)(?:o|\\u006[Ff])(?:t|\\u0074)(?:o|\\u006[Ff])(?:_|\\u005[Ff])(?:_|\\u005[Ff])"\s*:/,s=/"(?:c|\\u0063)(?:o|\\u006[Ff])(?:n|\\u006[Ee])(?:s|\\u0073)(?:t|\\u0074)(?:r|\\u0072)(?:u|\\u0075)(?:c|\\u0063)(?:t|\\u0074)(?:o|\\u006[Ff])(?:r|\\u0072)"\s*:/;function n(e,t,n){null==n&&null!==t&&"object"==typeof t&&(n=t,t=void 0),r&&Buffer.isBuffer(e)&&(e=e.toString()),e&&65279===e.charCodeAt(0)&&(e=e.slice(1));let o=JSON.parse(e,t);if(null===o||"object"!=typeof o)return o;let l=n&&n.protoAction||"error",u=n&&n.constructorAction||"error";if("ignore"===l&&"ignore"===u)return o;if("ignore"!==l&&"ignore"!==u){if(!1===a.test(e)&&!1===s.test(e))return o}else if("ignore"!==l&&"ignore"===u){if(!1===a.test(e))return o}else if(!1===s.test(e))return o;return i(o,{protoAction:l,constructorAction:u,safe:n&&n.safe})}function i(e,{protoAction:t="error",constructorAction:r="error",safe:a}={}){let s=[e];for(;s.length;){let e=s;for(let n of(s=[],e)){if("ignore"!==t&&Object.prototype.hasOwnProperty.call(n,"__proto__")){if(!0===a)return null;if("error"===t)throw SyntaxError("Object contains forbidden prototype property");delete n.__proto__}if("ignore"!==r&&Object.prototype.hasOwnProperty.call(n,"constructor")&&Object.prototype.hasOwnProperty.call(n.constructor,"prototype")){if(!0===a)return null;if("error"===r)throw SyntaxError("Object contains forbidden prototype property");delete n.constructor}for(let e in n){let t=n[e];t&&"object"==typeof t&&s.push(t)}}}return e}function o(e,t,r){let a=Error.stackTraceLimit;Error.stackTraceLimit=0;try{return n(e,t,r)}finally{Error.stackTraceLimit=a}}t.exports=o,t.exports.default=o,t.exports.parse=o,t.exports.safeParse=function(e,t){let r=Error.stackTraceLimit;Error.stackTraceLimit=0;try{return n(e,t,{safe:!0})}catch(e){return null}finally{Error.stackTraceLimit=r}},t.exports.scan=i}},function(){return o||(0,i[h2(i)[0]])((o={exports:{}}).exports,o),o.exports}),h6="vercel.ai.error",h7=Symbol.for(h6),h9=class e extends Error{constructor({name:e,message:t,cause:r}){super(t),this[C]=!0,this.name=e,this.cause=r}static isInstance(t){return e.hasMarker(t,h6)}static hasMarker(e,t){let r=Symbol.for(t);return null!=e&&"object"==typeof e&&r in e&&"boolean"==typeof e[r]&&!0===e[r]}};C=h7;var h8=h9;function fe(e){return null==e?"unknown error":"string"==typeof e?e:e instanceof Error?e.message:JSON.stringify(e)}var ft="AI_InvalidArgumentError",fr=`vercel.ai.error.${ft}`,fa=Symbol.for(fr),fs=class extends h8{constructor({message:e,cause:t,argument:r}){super({name:ft,message:e,cause:t}),this[j]=!0,this.argument=r}static isInstance(e){return h8.hasMarker(e,fr)}};j=fa;var fn="AI_JSONParseError",fi=`vercel.ai.error.${fn}`,fo=Symbol.for(fi),fl=class extends h8{constructor({text:e,cause:t}){super({name:fn,message:`JSON parsing failed: Text: ${e}.
Error message: ${fe(t)}`,cause:t}),this[N]=!0,this.text=e}static isInstance(e){return h8.hasMarker(e,fi)}};N=fo;var fu="AI_TypeValidationError",fp=`vercel.ai.error.${fu}`,fd=Symbol.for(fp),fc=class e extends h8{constructor({value:e,cause:t}){super({name:fu,message:`Type validation failed: Value: ${JSON.stringify(e)}.
Error message: ${fe(t)}`,cause:t}),this[L]=!0,this.value=e}static isInstance(e){return h8.hasMarker(e,fp)}static wrap({value:t,cause:r}){return e.isInstance(r)&&r.value===t?r:new e({value:t,cause:r})}};L=fd;var fm=((e,t,r,a)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let s of h2(t))h5.call(e,s)||s===r||h0(e,s,{get:()=>t[s],enumerable:!(a=h1(t,s))||a.enumerable});return e})(h0(null!=(l=h4())?hX(h3(l)):{},"default",{value:l,enumerable:!0}),l),fg=({prefix:e,size:t=16,alphabet:r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",separator:a="-"}={})=>{let s=((e,t=21)=>(r=t)=>{let a="",s=0|r;for(;s--;)a+=e[Math.random()*e.length|0];return a})(r,t);if(null==e)return s;if(r.includes(a))throw new fs({argument:"separator",message:`The separator "${a}" must not be part of the alphabet "${r}".`});return t=>`${e}${a}${s(t)}`};fg();var fh=Symbol.for("vercel.ai.validator");function ff({value:e,schema:t}){var r;let a="object"==typeof t&&null!==t&&fh in t&&!0===t[fh]&&"validate"in t?t:(r=t,{[fh]:!0,validate:e=>{let t=r.safeParse(e);return t.success?{success:!0,value:t.data}:{success:!1,error:t.error}}});try{if(null==a.validate)return{success:!0,value:e};let t=a.validate(e);if(t.success)return t;return{success:!1,error:fc.wrap({value:e,cause:t.error})}}catch(t){return{success:!1,error:fc.wrap({value:e,cause:t})}}}function fy({text:e,schema:t}){try{let r=fm.default.parse(e);if(null==t)return{success:!0,value:r,rawValue:r};let a=ff({value:r,schema:t});return a.success?{...a,rawValue:r}:a}catch(t){return{success:!1,error:fl.isInstance(t)?t:new fl({text:e,cause:t})}}}var fv=Symbol("Let zodToJsonSchema decide on which parser to use"),fb={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",allowedAdditionalProperties:!0,rejectedAdditionalProperties:!1,definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref",openAiAnyTypeName:"OpenAiAnyType"};function fw(e,t,r,a){a?.errorMessages&&r&&(e.errorMessage={...e.errorMessage,[t]:r})}function fk(e,t,r,a,s){e[t]=r,fw(e,t,a,s)}var f_=(e,t)=>{let r=0;for(;r<e.length&&r<t.length&&e[r]===t[r];r++);return[(e.length-r).toString(),...t.slice(r)].join("/")};function fI(e){if("openAi"!==e.target)return{};let t=[...e.basePath,e.definitionPath,e.openAiAnyTypeName];return e.flags.hasReferencedOpenAiAnyType=!0,{$ref:"relative"===e.$refStrategy?f_(t,e.currentPath):t.join("/")}}function fS(e,t){return fK(e.type._def,t)}var fx=void 0,fT=/^[cC][^\s-]{8,}$/,fE=/^[0-9a-z]+$/,fA=/^[0-9A-HJKMNP-TV-Z]{26}$/,fO=/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,fz=()=>(void 0===fx&&(fx=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),fx),fM=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,fP=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,fR=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,fC=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,fj=/^[a-zA-Z0-9_-]{21}$/,fN=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/;function fL(e,t){let r={type:"string"};if(e.checks)for(let a of e.checks)switch(a.kind){case"min":fk(r,"minLength","number"==typeof r.minLength?Math.max(r.minLength,a.value):a.value,a.message,t);break;case"max":fk(r,"maxLength","number"==typeof r.maxLength?Math.min(r.maxLength,a.value):a.value,a.message,t);break;case"email":switch(t.emailStrategy){case"format:email":f$(r,"email",a.message,t);break;case"format:idn-email":f$(r,"idn-email",a.message,t);break;case"pattern:zod":fF(r,fO,a.message,t)}break;case"url":f$(r,"uri",a.message,t);break;case"uuid":f$(r,"uuid",a.message,t);break;case"regex":fF(r,a.regex,a.message,t);break;case"cuid":fF(r,fT,a.message,t);break;case"cuid2":fF(r,fE,a.message,t);break;case"startsWith":fF(r,RegExp(`^${fD(a.value,t)}`),a.message,t);break;case"endsWith":fF(r,RegExp(`${fD(a.value,t)}$`),a.message,t);break;case"datetime":f$(r,"date-time",a.message,t);break;case"date":f$(r,"date",a.message,t);break;case"time":f$(r,"time",a.message,t);break;case"duration":f$(r,"duration",a.message,t);break;case"length":fk(r,"minLength","number"==typeof r.minLength?Math.max(r.minLength,a.value):a.value,a.message,t),fk(r,"maxLength","number"==typeof r.maxLength?Math.min(r.maxLength,a.value):a.value,a.message,t);break;case"includes":fF(r,RegExp(fD(a.value,t)),a.message,t);break;case"ip":"v6"!==a.version&&f$(r,"ipv4",a.message,t),"v4"!==a.version&&f$(r,"ipv6",a.message,t);break;case"base64url":fF(r,fC,a.message,t);break;case"jwt":fF(r,fN,a.message,t);break;case"cidr":"v6"!==a.version&&fF(r,fM,a.message,t),"v4"!==a.version&&fF(r,fP,a.message,t);break;case"emoji":fF(r,fz(),a.message,t);break;case"ulid":fF(r,fA,a.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":f$(r,"binary",a.message,t);break;case"contentEncoding:base64":fk(r,"contentEncoding","base64",a.message,t);break;case"pattern:zod":fF(r,fR,a.message,t)}break;case"nanoid":fF(r,fj,a.message,t)}return r}function fD(e,t){return"escape"===t.patternStrategy?function(e){let t="";for(let r=0;r<e.length;r++)fq.has(e[r])||(t+="\\"),t+=e[r];return t}(e):e}var fq=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function f$(e,t,r,a){e.format||e.anyOf?.some(e=>e.format)?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&a.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.anyOf.push({format:t,...r&&a.errorMessages&&{errorMessage:{format:r}}})):fk(e,"format",t,r,a)}function fF(e,t,r,a){e.pattern||e.allOf?.some(e=>e.pattern)?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&a.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.allOf.push({pattern:fU(t,a),...r&&a.errorMessages&&{errorMessage:{pattern:r}}})):fk(e,"pattern",fU(t,a),r,a)}function fU(e,t){if(!t.applyRegexFlags||!e.flags)return e.source;let r={i:e.flags.includes("i"),m:e.flags.includes("m"),s:e.flags.includes("s")},a=r.i?e.source.toLowerCase():e.source,s="",n=!1,i=!1,o=!1;for(let e=0;e<a.length;e++){if(n){s+=a[e],n=!1;continue}if(r.i){if(i){if(a[e].match(/[a-z]/)){o?(s+=a[e],s+=`${a[e-2]}-${a[e]}`.toUpperCase(),o=!1):"-"===a[e+1]&&a[e+2]?.match(/[a-z]/)?(s+=a[e],o=!0):s+=`${a[e]}${a[e].toUpperCase()}`;continue}}else if(a[e].match(/[a-z]/)){s+=`[${a[e]}${a[e].toUpperCase()}]`;continue}}if(r.m){if("^"===a[e]){s+=`(^|(?<=[\r
]))`;continue}else if("$"===a[e]){s+=`($|(?=[\r
]))`;continue}}if(r.s&&"."===a[e]){s+=i?`${a[e]}\r
`:`[${a[e]}\r
]`;continue}s+=a[e],"\\"===a[e]?n=!0:i&&"]"===a[e]?i=!1:i||"["!==a[e]||(i=!0)}return s}function fZ(e,t){if("openAi"===t.target&&console.warn("Warning: OpenAI may not support records in schemas! Try an array of key-value pairs instead."),"openApi3"===t.target&&e.keyType?._def.typeName===sh.ZodFirstPartyTypeKind.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce((r,a)=>({...r,[a]:fK(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",a]})??fI(t)}),{}),additionalProperties:t.rejectedAdditionalProperties};let r={type:"object",additionalProperties:fK(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??t.allowedAdditionalProperties};if("openApi3"===t.target)return r;if(e.keyType?._def.typeName===sh.ZodFirstPartyTypeKind.ZodString&&e.keyType._def.checks?.length){let{type:a,...s}=fL(e.keyType._def,t);return{...r,propertyNames:s}}if(e.keyType?._def.typeName===sh.ZodFirstPartyTypeKind.ZodEnum)return{...r,propertyNames:{enum:e.keyType._def.values}};if(e.keyType?._def.typeName===sh.ZodFirstPartyTypeKind.ZodBranded&&e.keyType._def.type._def.typeName===sh.ZodFirstPartyTypeKind.ZodString&&e.keyType._def.type._def.checks?.length){let{type:a,...s}=fS(e.keyType._def,t);return{...r,propertyNames:s}}return r}var fB={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"},fV=(e,t)=>{let r=(e.options instanceof Map?Array.from(e.options.values()):e.options).map((e,r)=>fK(e._def,{...t,currentPath:[...t.currentPath,"anyOf",`${r}`]})).filter(e=>!!e&&(!t.strictUnions||"object"==typeof e&&Object.keys(e).length>0));return r.length?{anyOf:r}:void 0};function fK(e,t,r=!1){let a=t.seen.get(e);if(t.override){let s=t.override?.(e,t,a,r);if(s!==fv)return s}if(a&&!r){let e=fG(a,t);if(void 0!==e)return e}let s={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,s);let n=((e,t,r)=>{switch(t){case sh.ZodFirstPartyTypeKind.ZodString:return fL(e,r);case sh.ZodFirstPartyTypeKind.ZodNumber:let a={type:"number"};if(!e.checks)return a;for(let t of e.checks)switch(t.kind){case"int":a.type="integer",fw(a,"type",t.message,r);break;case"min":"jsonSchema7"===r.target?t.inclusive?fk(a,"minimum",t.value,t.message,r):fk(a,"exclusiveMinimum",t.value,t.message,r):(t.inclusive||(a.exclusiveMinimum=!0),fk(a,"minimum",t.value,t.message,r));break;case"max":"jsonSchema7"===r.target?t.inclusive?fk(a,"maximum",t.value,t.message,r):fk(a,"exclusiveMaximum",t.value,t.message,r):(t.inclusive||(a.exclusiveMaximum=!0),fk(a,"maximum",t.value,t.message,r));break;case"multipleOf":fk(a,"multipleOf",t.value,t.message,r)}return a;case sh.ZodFirstPartyTypeKind.ZodObject:return function(e,t){let r="openAi"===t.target,a={type:"object",properties:{}},s=[],n=e.shape();for(let e in n){let i=n[e];if(void 0===i||void 0===i._def)continue;let o=function(e){try{return e.isOptional()}catch{return!0}}(i);o&&r&&("ZodOptional"===i._def.typeName&&(i=i._def.innerType),i.isNullable()||(i=i.nullable()),o=!1);let l=fK(i._def,{...t,currentPath:[...t.currentPath,"properties",e],propertyPath:[...t.currentPath,"properties",e]});void 0!==l&&(a.properties[e]=l,o||s.push(e))}s.length&&(a.required=s);let i=function(e,t){if("ZodNever"!==e.catchall._def.typeName)return fK(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]});switch(e.unknownKeys){case"passthrough":return t.allowedAdditionalProperties;case"strict":return t.rejectedAdditionalProperties;case"strip":return"strict"===t.removeAdditionalStrategy?t.allowedAdditionalProperties:t.rejectedAdditionalProperties}}(e,t);return void 0!==i&&(a.additionalProperties=i),a}(e,r);case sh.ZodFirstPartyTypeKind.ZodBigInt:let s={type:"integer",format:"int64"};if(!e.checks)return s;for(let t of e.checks)switch(t.kind){case"min":"jsonSchema7"===r.target?t.inclusive?fk(s,"minimum",t.value,t.message,r):fk(s,"exclusiveMinimum",t.value,t.message,r):(t.inclusive||(s.exclusiveMinimum=!0),fk(s,"minimum",t.value,t.message,r));break;case"max":"jsonSchema7"===r.target?t.inclusive?fk(s,"maximum",t.value,t.message,r):fk(s,"exclusiveMaximum",t.value,t.message,r):(t.inclusive||(s.exclusiveMaximum=!0),fk(s,"maximum",t.value,t.message,r));break;case"multipleOf":fk(s,"multipleOf",t.value,t.message,r)}return s;case sh.ZodFirstPartyTypeKind.ZodBoolean:return{type:"boolean"};case sh.ZodFirstPartyTypeKind.ZodDate:return function e(t,r,a){let s=a??r.dateStrategy;if(Array.isArray(s))return{anyOf:s.map((a,s)=>e(t,r,a))};switch(s){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":var n=t,i=r;let o={type:"integer",format:"unix-time"};if("openApi3"===i.target)return o;for(let e of n.checks)switch(e.kind){case"min":fk(o,"minimum",e.value,e.message,i);break;case"max":fk(o,"maximum",e.value,e.message,i)}return o}}(e,r);case sh.ZodFirstPartyTypeKind.ZodUndefined:return{not:fI(r)};case sh.ZodFirstPartyTypeKind.ZodNull:return"openApi3"===r.target?{enum:["null"],nullable:!0}:{type:"null"};case sh.ZodFirstPartyTypeKind.ZodArray:let n;return n={type:"array"},e.type?._def&&e.type?._def?.typeName!==sh.ZodFirstPartyTypeKind.ZodAny&&(n.items=fK(e.type._def,{...r,currentPath:[...r.currentPath,"items"]})),e.minLength&&fk(n,"minItems",e.minLength.value,e.minLength.message,r),e.maxLength&&fk(n,"maxItems",e.maxLength.value,e.maxLength.message,r),e.exactLength&&(fk(n,"minItems",e.exactLength.value,e.exactLength.message,r),fk(n,"maxItems",e.exactLength.value,e.exactLength.message,r)),n;case sh.ZodFirstPartyTypeKind.ZodUnion:case sh.ZodFirstPartyTypeKind.ZodDiscriminatedUnion:if("openApi3"===r.target)return fV(e,r);let i=e.options instanceof Map?Array.from(e.options.values()):e.options;if(i.every(e=>e._def.typeName in fB&&(!e._def.checks||!e._def.checks.length))){let e=i.reduce((e,t)=>{let r=fB[t._def.typeName];return r&&!e.includes(r)?[...e,r]:e},[]);return{type:e.length>1?e:e[0]}}if(i.every(e=>"ZodLiteral"===e._def.typeName&&!e.description)){let e=i.reduce((e,t)=>{let r=typeof t._def.value;switch(r){case"string":case"number":case"boolean":return[...e,r];case"bigint":return[...e,"integer"];case"object":if(null===t._def.value)return[...e,"null"];default:return e}},[]);if(e.length===i.length){let t=e.filter((e,t,r)=>r.indexOf(e)===t);return{type:t.length>1?t:t[0],enum:i.reduce((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value],[])}}}else if(i.every(e=>"ZodEnum"===e._def.typeName))return{type:"string",enum:i.reduce((e,t)=>[...e,...t._def.values.filter(t=>!e.includes(t))],[])};return fV(e,r);case sh.ZodFirstPartyTypeKind.ZodIntersection:let o,l,u;return o=[fK(e.left._def,{...r,currentPath:[...r.currentPath,"allOf","0"]}),fK(e.right._def,{...r,currentPath:[...r.currentPath,"allOf","1"]})].filter(e=>!!e),l="jsonSchema2019-09"===r.target?{unevaluatedProperties:!1}:void 0,u=[],o.forEach(e=>{if((!("type"in e)||"string"!==e.type)&&"allOf"in e)u.push(...e.allOf),void 0===e.unevaluatedProperties&&(l=void 0);else{let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){let{additionalProperties:r,...a}=e;t=a}else l=void 0;u.push(t)}}),u.length?{allOf:u,...l}:void 0;case sh.ZodFirstPartyTypeKind.ZodTuple:return e.rest?{type:"array",minItems:e.items.length,items:e.items.map((e,t)=>fK(e._def,{...r,currentPath:[...r.currentPath,"items",`${t}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[]),additionalItems:fK(e.rest._def,{...r,currentPath:[...r.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map((e,t)=>fK(e._def,{...r,currentPath:[...r.currentPath,"items",`${t}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[])};case sh.ZodFirstPartyTypeKind.ZodRecord:return fZ(e,r);case sh.ZodFirstPartyTypeKind.ZodLiteral:let p;return"bigint"!=(p=typeof e.value)&&"number"!==p&&"boolean"!==p&&"string"!==p?{type:Array.isArray(e.value)?"array":"object"}:"openApi3"===r.target?{type:"bigint"===p?"integer":p,enum:[e.value]}:{type:"bigint"===p?"integer":p,const:e.value};case sh.ZodFirstPartyTypeKind.ZodEnum:return{type:"string",enum:Array.from(e.values)};case sh.ZodFirstPartyTypeKind.ZodNativeEnum:let d,c,m;return d=e.values,{type:1===(m=Array.from(new Set((c=Object.keys(e.values).filter(e=>"number"!=typeof d[d[e]]).map(e=>d[e])).map(e=>typeof e)))).length?"string"===m[0]?"string":"number":["string","number"],enum:c};case sh.ZodFirstPartyTypeKind.ZodNullable:if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return"openApi3"===r.target?{type:fB[e.innerType._def.typeName],nullable:!0}:{type:[fB[e.innerType._def.typeName],"null"]};if("openApi3"===r.target){let t=fK(e.innerType._def,{...r,currentPath:[...r.currentPath]});return t&&"$ref"in t?{allOf:[t],nullable:!0}:t&&{...t,nullable:!0}}let g=fK(e.innerType._def,{...r,currentPath:[...r.currentPath,"anyOf","0"]});return g&&{anyOf:[g,{type:"null"}]};case sh.ZodFirstPartyTypeKind.ZodOptional:if(r.currentPath.toString()===r.propertyPath?.toString())return fK(e.innerType._def,r);let h=fK(e.innerType._def,{...r,currentPath:[...r.currentPath,"anyOf","1"]});return h?{anyOf:[{not:fI(r)},h]}:fI(r);case sh.ZodFirstPartyTypeKind.ZodMap:if("record"===r.mapStrategy)return fZ(e,r);return{type:"array",maxItems:125,items:{type:"array",items:[fK(e.keyType._def,{...r,currentPath:[...r.currentPath,"items","items","0"]})||fI(r),fK(e.valueType._def,{...r,currentPath:[...r.currentPath,"items","items","1"]})||fI(r)],minItems:2,maxItems:2}};case sh.ZodFirstPartyTypeKind.ZodSet:let f;return f={type:"array",uniqueItems:!0,items:fK(e.valueType._def,{...r,currentPath:[...r.currentPath,"items"]})},e.minSize&&fk(f,"minItems",e.minSize.value,e.minSize.message,r),e.maxSize&&fk(f,"maxItems",e.maxSize.value,e.maxSize.message,r),f;case sh.ZodFirstPartyTypeKind.ZodLazy:return()=>e.getter()._def;case sh.ZodFirstPartyTypeKind.ZodPromise:return fK(e.type._def,r);case sh.ZodFirstPartyTypeKind.ZodNaN:case sh.ZodFirstPartyTypeKind.ZodNever:return"openAi"===r.target?void 0:{not:fI({...r,currentPath:[...r.currentPath,"not"]})};case sh.ZodFirstPartyTypeKind.ZodEffects:return"input"===r.effectStrategy?fK(e.schema._def,r):fI(r);case sh.ZodFirstPartyTypeKind.ZodAny:case sh.ZodFirstPartyTypeKind.ZodUnknown:return fI(r);case sh.ZodFirstPartyTypeKind.ZodDefault:return{...fK(e.innerType._def,r),default:e.defaultValue()};case sh.ZodFirstPartyTypeKind.ZodBranded:return fS(e,r);case sh.ZodFirstPartyTypeKind.ZodReadonly:case sh.ZodFirstPartyTypeKind.ZodCatch:return fK(e.innerType._def,r);case sh.ZodFirstPartyTypeKind.ZodPipeline:if("input"===r.pipeStrategy)return fK(e.in._def,r);if("output"===r.pipeStrategy)return fK(e.out._def,r);let y=fK(e.in._def,{...r,currentPath:[...r.currentPath,"allOf","0"]}),v=fK(e.out._def,{...r,currentPath:[...r.currentPath,"allOf",y?"1":"0"]});return{allOf:[y,v].filter(e=>void 0!==e)};case sh.ZodFirstPartyTypeKind.ZodFunction:case sh.ZodFirstPartyTypeKind.ZodVoid:case sh.ZodFirstPartyTypeKind.ZodSymbol:default:return}})(e,e.typeName,t),i="function"==typeof n?fK(n(),t):n;if(i&&fW(e,t,i),t.postProcess){let r=t.postProcess(i,e,t);return s.jsonSchema=i,r}return s.jsonSchema=i,i}var fG=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"relative":return{$ref:f_(t.currentPath,e.path)};case"none":case"seen":if(e.path.length<t.currentPath.length&&e.path.every((e,r)=>t.currentPath[r]===e))return console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),fI(t);return"seen"===t.$refStrategy?fI(t):void 0}},fW=(e,t,r)=>(e.description&&(r.description=e.description,t.markdownDescription&&(r.markdownDescription=e.description)),r),fQ=[{code:"0",name:"text",parse:e=>{if("string"!=typeof e)throw Error('"text" parts expect a string value.');return{type:"text",value:e}}},{code:"2",name:"data",parse:e=>{if(!Array.isArray(e))throw Error('"data" parts expect an array value.');return{type:"data",value:e}}},{code:"3",name:"error",parse:e=>{if("string"!=typeof e)throw Error('"error" parts expect a string value.');return{type:"error",value:e}}},{code:"8",name:"message_annotations",parse:e=>{if(!Array.isArray(e))throw Error('"message_annotations" parts expect an array value.');return{type:"message_annotations",value:e}}},{code:"9",name:"tool_call",parse:e=>{if(null==e||"object"!=typeof e||!("toolCallId"in e)||"string"!=typeof e.toolCallId||!("toolName"in e)||"string"!=typeof e.toolName||!("args"in e)||"object"!=typeof e.args)throw Error('"tool_call" parts expect an object with a "toolCallId", "toolName", and "args" property.');return{type:"tool_call",value:e}}},{code:"a",name:"tool_result",parse:e=>{if(null==e||"object"!=typeof e||!("toolCallId"in e)||"string"!=typeof e.toolCallId||!("result"in e))throw Error('"tool_result" parts expect an object with a "toolCallId" and a "result" property.');return{type:"tool_result",value:e}}},{code:"b",name:"tool_call_streaming_start",parse:e=>{if(null==e||"object"!=typeof e||!("toolCallId"in e)||"string"!=typeof e.toolCallId||!("toolName"in e)||"string"!=typeof e.toolName)throw Error('"tool_call_streaming_start" parts expect an object with a "toolCallId" and "toolName" property.');return{type:"tool_call_streaming_start",value:e}}},{code:"c",name:"tool_call_delta",parse:e=>{if(null==e||"object"!=typeof e||!("toolCallId"in e)||"string"!=typeof e.toolCallId||!("argsTextDelta"in e)||"string"!=typeof e.argsTextDelta)throw Error('"tool_call_delta" parts expect an object with a "toolCallId" and "argsTextDelta" property.');return{type:"tool_call_delta",value:e}}},{code:"d",name:"finish_message",parse:e=>{if(null==e||"object"!=typeof e||!("finishReason"in e)||"string"!=typeof e.finishReason)throw Error('"finish_message" parts expect an object with a "finishReason" property.');let t={finishReason:e.finishReason};return"usage"in e&&null!=e.usage&&"object"==typeof e.usage&&"promptTokens"in e.usage&&"completionTokens"in e.usage&&(t.usage={promptTokens:"number"==typeof e.usage.promptTokens?e.usage.promptTokens:NaN,completionTokens:"number"==typeof e.usage.completionTokens?e.usage.completionTokens:NaN}),{type:"finish_message",value:t}}},{code:"e",name:"finish_step",parse:e=>{if(null==e||"object"!=typeof e||!("finishReason"in e)||"string"!=typeof e.finishReason)throw Error('"finish_step" parts expect an object with a "finishReason" property.');let t={finishReason:e.finishReason,isContinued:!1};return"usage"in e&&null!=e.usage&&"object"==typeof e.usage&&"promptTokens"in e.usage&&"completionTokens"in e.usage&&(t.usage={promptTokens:"number"==typeof e.usage.promptTokens?e.usage.promptTokens:NaN,completionTokens:"number"==typeof e.usage.completionTokens?e.usage.completionTokens:NaN}),"isContinued"in e&&"boolean"==typeof e.isContinued&&(t.isContinued=e.isContinued),{type:"finish_step",value:t}}},{code:"f",name:"start_step",parse:e=>{if(null==e||"object"!=typeof e||!("messageId"in e)||"string"!=typeof e.messageId)throw Error('"start_step" parts expect an object with an "id" property.');return{type:"start_step",value:{messageId:e.messageId}}}},{code:"g",name:"reasoning",parse:e=>{if("string"!=typeof e)throw Error('"reasoning" parts expect a string value.');return{type:"reasoning",value:e}}},{code:"h",name:"source",parse:e=>{if(null==e||"object"!=typeof e)throw Error('"source" parts expect a Source object.');return{type:"source",value:e}}},{code:"i",name:"redacted_reasoning",parse:e=>{if(null==e||"object"!=typeof e||!("data"in e)||"string"!=typeof e.data)throw Error('"redacted_reasoning" parts expect an object with a "data" property.');return{type:"redacted_reasoning",value:{data:e.data}}}},{code:"j",name:"reasoning_signature",parse:e=>{if(null==e||"object"!=typeof e||!("signature"in e)||"string"!=typeof e.signature)throw Error('"reasoning_signature" parts expect an object with a "signature" property.');return{type:"reasoning_signature",value:{signature:e.signature}}}},{code:"k",name:"file",parse:e=>{if(null==e||"object"!=typeof e||!("data"in e)||"string"!=typeof e.data||!("mimeType"in e)||"string"!=typeof e.mimeType)throw Error('"file" parts expect an object with a "data" and "mimeType" property.');return{type:"file",value:e}}}];function fJ(e,t){let r=fQ.find(t=>t.name===e);if(!r)throw Error(`Invalid stream part type: ${e}`);return`${r.code}:${JSON.stringify(t)}
`}Object.fromEntries(fQ.map(e=>[e.code,e])),Object.fromEntries(fQ.map(e=>[e.name,e.code]));var fH=Symbol.for("vercel.ai.schema");function fY(e,{validate:t}={}){return{[fH]:!0,_type:void 0,[fh]:!0,jsonSchema:e,validate:t}}var fX="object"==typeof globalThis?globalThis:e.g,f0="1.9.0",f1=/^(\d+)\.(\d+)\.(\d+)(-(.+))?$/,f2=function(e){var t=new Set([e]),r=new Set,a=e.match(f1);if(!a)return function(){return!1};var s={major:+a[1],minor:+a[2],patch:+a[3],prerelease:a[4]};if(null!=s.prerelease)return function(t){return t===e};function n(e){return r.add(e),!1}return function(e){if(t.has(e))return!0;if(r.has(e))return!1;var a=e.match(f1);if(!a)return n(e);var i={major:+a[1],minor:+a[2],patch:+a[3],prerelease:a[4]};if(null!=i.prerelease||s.major!==i.major)return n(e);if(0===s.major)return s.minor===i.minor&&s.patch<=i.patch?(t.add(e),!0):n(e);return s.minor<=i.minor?(t.add(e),!0):n(e)}}(f0),f3=Symbol.for("opentelemetry.js.api."+f0.split(".")[0]);function f5(e,t,r,a){void 0===a&&(a=!1);var s,n=fX[f3]=null!=(s=fX[f3])?s:{version:f0};if(!a&&n[e]){var i=Error("@opentelemetry/api: Attempted duplicate registration of API: "+e);return r.error(i.stack||i.message),!1}if(n.version!==f0){var i=Error("@opentelemetry/api: Registration of version v"+n.version+" for "+e+" does not match previously registered API v"+f0);return r.error(i.stack||i.message),!1}return n[e]=t,r.debug("@opentelemetry/api: Registered a global for "+e+" v"+f0+"."),!0}function f4(e){var t,r,a=null==(t=fX[f3])?void 0:t.version;if(a&&f2(a))return null==(r=fX[f3])?void 0:r[e]}function f6(e,t){t.debug("@opentelemetry/api: Unregistering a global for "+e+" v"+f0+".");var r=fX[f3];r&&delete r[e]}var f7=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var a,s,n=r.call(e),i=[];try{for(;!(a=n.next()).done;)i.push(a.value)}catch(e){s={error:e}}finally{try{a&&!a.done&&(r=n.return)&&r.call(n)}finally{if(s)throw s.error}}return i},f9=function(e,t,r){if(2==arguments.length)for(var a,s=0,n=t.length;s<n;s++)!a&&s in t||(a||(a=Array.prototype.slice.call(t,0,s)),a[s]=t[s]);return e.concat(a||Array.prototype.slice.call(t))},f8=function(){function e(e){this._namespace=e.namespace||"DiagComponentLogger"}return e.prototype.debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return ye("debug",this._namespace,e)},e.prototype.error=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return ye("error",this._namespace,e)},e.prototype.info=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return ye("info",this._namespace,e)},e.prototype.warn=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return ye("warn",this._namespace,e)},e.prototype.verbose=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return ye("verbose",this._namespace,e)},e}();function ye(e,t,r){var a=f4("diag");if(a)return r.unshift(t),a[e].apply(a,f9([],f7(r),!1))}(b=D||(D={}))[b.NONE=0]="NONE",b[b.ERROR=30]="ERROR",b[b.WARN=50]="WARN",b[b.INFO=60]="INFO",b[b.DEBUG=70]="DEBUG",b[b.VERBOSE=80]="VERBOSE",b[b.ALL=9999]="ALL";var yt=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var a,s,n=r.call(e),i=[];try{for(;!(a=n.next()).done;)i.push(a.value)}catch(e){s={error:e}}finally{try{a&&!a.done&&(r=n.return)&&r.call(n)}finally{if(s)throw s.error}}return i},yr=function(e,t,r){if(2==arguments.length)for(var a,s=0,n=t.length;s<n;s++)!a&&s in t||(a||(a=Array.prototype.slice.call(t,0,s)),a[s]=t[s]);return e.concat(a||Array.prototype.slice.call(t))},ya=function(){function e(){function e(e){return function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var a=f4("diag");if(a)return a[e].apply(a,yr([],yt(t),!1))}}var t=this;t.setLogger=function(e,r){if(void 0===r&&(r={logLevel:D.INFO}),e===t){var a,s,n,i=Error("Cannot use diag as the logger for itself. Please use a DiagLogger implementation like ConsoleDiagLogger or a custom implementation");return t.error(null!=(a=i.stack)?a:i.message),!1}"number"==typeof r&&(r={logLevel:r});var o=f4("diag"),l=function(e,t){function r(r,a){var s=t[r];return"function"==typeof s&&e>=a?s.bind(t):function(){}}return e<D.NONE?e=D.NONE:e>D.ALL&&(e=D.ALL),t=t||{},{error:r("error",D.ERROR),warn:r("warn",D.WARN),info:r("info",D.INFO),debug:r("debug",D.DEBUG),verbose:r("verbose",D.VERBOSE)}}(null!=(s=r.logLevel)?s:D.INFO,e);if(o&&!r.suppressOverrideMessage){var u=null!=(n=Error().stack)?n:"<failed to generate stacktrace>";o.warn("Current logger will be overwritten from "+u),l.warn("Current logger will overwrite one already registered from "+u)}return f5("diag",l,t,!0)},t.disable=function(){f6("diag",t)},t.createComponentLogger=function(e){return new f8(e)},t.verbose=e("verbose"),t.debug=e("debug"),t.info=e("info"),t.warn=e("warn"),t.error=e("error")}return e.instance=function(){return this._instance||(this._instance=new e),this._instance},e}(),ys=new function e(t){var r=this;r._currentContext=t?new Map(t):new Map,r.getValue=function(e){return r._currentContext.get(e)},r.setValue=function(t,a){var s=new e(r._currentContext);return s._currentContext.set(t,a),s},r.deleteValue=function(t){var a=new e(r._currentContext);return a._currentContext.delete(t),a}},yn=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var a,s,n=r.call(e),i=[];try{for(;!(a=n.next()).done;)i.push(a.value)}catch(e){s={error:e}}finally{try{a&&!a.done&&(r=n.return)&&r.call(n)}finally{if(s)throw s.error}}return i},yi=function(e,t,r){if(2==arguments.length)for(var a,s=0,n=t.length;s<n;s++)!a&&s in t||(a||(a=Array.prototype.slice.call(t,0,s)),a[s]=t[s]);return e.concat(a||Array.prototype.slice.call(t))},yo=function(){function e(){}return e.prototype.active=function(){return ys},e.prototype.with=function(e,t,r){for(var a=[],s=3;s<arguments.length;s++)a[s-3]=arguments[s];return t.call.apply(t,yi([r],yn(a),!1))},e.prototype.bind=function(e,t){return t},e.prototype.enable=function(){return this},e.prototype.disable=function(){return this},e}(),yl=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var a,s,n=r.call(e),i=[];try{for(;!(a=n.next()).done;)i.push(a.value)}catch(e){s={error:e}}finally{try{a&&!a.done&&(r=n.return)&&r.call(n)}finally{if(s)throw s.error}}return i},yu=function(e,t,r){if(2==arguments.length)for(var a,s=0,n=t.length;s<n;s++)!a&&s in t||(a||(a=Array.prototype.slice.call(t,0,s)),a[s]=t[s]);return e.concat(a||Array.prototype.slice.call(t))},yp="context",yd=new yo,yc=function(){function e(){}return e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.setGlobalContextManager=function(e){return f5(yp,e,ya.instance())},e.prototype.active=function(){return this._getContextManager().active()},e.prototype.with=function(e,t,r){for(var a,s=[],n=3;n<arguments.length;n++)s[n-3]=arguments[n];return(a=this._getContextManager()).with.apply(a,yu([e,t,r],yl(s),!1))},e.prototype.bind=function(e,t){return this._getContextManager().bind(e,t)},e.prototype._getContextManager=function(){return f4(yp)||yd},e.prototype.disable=function(){this._getContextManager().disable(),f6(yp,ya.instance())},e}();(w=q||(q={}))[w.NONE=0]="NONE",w[w.SAMPLED=1]="SAMPLED";var ym="0000000000000000",yg="00000000000000000000000000000000",yh={traceId:yg,spanId:ym,traceFlags:q.NONE},yf=function(){function e(e){void 0===e&&(e=yh),this._spanContext=e}return e.prototype.spanContext=function(){return this._spanContext},e.prototype.setAttribute=function(e,t){return this},e.prototype.setAttributes=function(e){return this},e.prototype.addEvent=function(e,t){return this},e.prototype.addLink=function(e){return this},e.prototype.addLinks=function(e){return this},e.prototype.setStatus=function(e){return this},e.prototype.updateName=function(e){return this},e.prototype.end=function(e){},e.prototype.isRecording=function(){return!1},e.prototype.recordException=function(e,t){},e}(),yy=Symbol.for("OpenTelemetry Context Key SPAN");function yv(e){return e.getValue(yy)||void 0}function yb(){return yv(yc.getInstance().active())}function yw(e,t){return e.setValue(yy,t)}function yk(e){return e.deleteValue(yy)}function y_(e,t){return yw(e,new yf(t))}function yI(e){var t;return null==(t=yv(e))?void 0:t.spanContext()}var yS=/^([0-9a-f]{32})$/i,yx=/^[0-9a-f]{16}$/i;function yT(e){var t,r;return t=e.traceId,yS.test(t)&&t!==yg&&(r=e.spanId,yx.test(r)&&r!==ym)}function yE(e){return new yf(e)}var yA=yc.getInstance(),yO=function(){function e(){}return e.prototype.startSpan=function(e,t,r){if(void 0===r&&(r=yA.active()),null==t?void 0:t.root)return new yf;var a,s=r&&yI(r);return"object"==typeof(a=s)&&"string"==typeof a.spanId&&"string"==typeof a.traceId&&"number"==typeof a.traceFlags&&yT(s)?new yf(s):new yf},e.prototype.startActiveSpan=function(e,t,r,a){if(!(arguments.length<2)){2==arguments.length?i=t:3==arguments.length?(s=t,i=r):(s=t,n=r,i=a);var s,n,i,o=null!=n?n:yA.active(),l=this.startSpan(e,s,o),u=yw(o,l);return yA.with(u,i,void 0,l)}},e}(),yz=new yO,yM=function(){function e(e,t,r,a){this._provider=e,this.name=t,this.version=r,this.options=a}return e.prototype.startSpan=function(e,t,r){return this._getTracer().startSpan(e,t,r)},e.prototype.startActiveSpan=function(e,t,r,a){var s=this._getTracer();return Reflect.apply(s.startActiveSpan,s,arguments)},e.prototype._getTracer=function(){if(this._delegate)return this._delegate;var e=this._provider.getDelegateTracer(this.name,this.version,this.options);return e?(this._delegate=e,this._delegate):yz},e}(),yP=new(function(){function e(){}return e.prototype.getTracer=function(e,t,r){return new yO},e}()),yR=function(){function e(){}return e.prototype.getTracer=function(e,t,r){var a;return null!=(a=this.getDelegateTracer(e,t,r))?a:new yM(this,e,t,r)},e.prototype.getDelegate=function(){var e;return null!=(e=this._delegate)?e:yP},e.prototype.setDelegate=function(e){this._delegate=e},e.prototype.getDelegateTracer=function(e,t,r){var a;return null==(a=this._delegate)?void 0:a.getTracer(e,t,r)},e}();(k=$||($={}))[k.UNSET=0]="UNSET",k[k.OK=1]="OK",k[k.ERROR=2]="ERROR";var yC="trace";(function(){function e(){this._proxyTracerProvider=new yR,this.wrapSpanContext=yE,this.isSpanContextValid=yT,this.deleteSpan=yk,this.getSpan=yv,this.getActiveSpan=yb,this.getSpanContext=yI,this.setSpan=yw,this.setSpanContext=y_}return e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.setGlobalTracerProvider=function(e){var t=f5(yC,this._proxyTracerProvider,ya.instance());return t&&this._proxyTracerProvider.setDelegate(e),t},e.prototype.getTracerProvider=function(){return f4(yC)||this._proxyTracerProvider},e.prototype.getTracer=function(e,t){return this.getTracerProvider().getTracer(e,t)},e.prototype.disable=function(){f6(yC,ya.instance()),this._proxyTracerProvider=new yR},e})().getInstance();var yj=Object.defineProperty,yN=(e,t)=>{for(var r in t)yj(e,r,{get:t[r],enumerable:!0})};function yL(e,{contentType:t,dataStreamVersion:r}){let a=new Headers(null!=e?e:{});return a.has("Content-Type")||a.set("Content-Type",t),a.set("X-Vercel-AI-Data-Stream",r),a}var yD="AI_NoObjectGeneratedError",yq=`vercel.ai.error.${yD}`,y$=Symbol.for(yq),yF=class extends h8{constructor({message:e="No object generated.",cause:t,text:r,response:a,usage:s,finishReason:n}){super({name:yD,message:e,cause:t}),this[F]=!0,this.text=r,this.response=a,this.usage=s,this.finishReason=n}static isInstance(e){return h8.hasMarker(e,yq)}};F=y$;var yU=sg.union([sg.string(),sg.instanceof(Uint8Array),sg.instanceof(ArrayBuffer),sg.custom(e=>{var t,r;return null!=(r=null==(t=globalThis.Buffer)?void 0:t.isBuffer(e))&&r},{message:"Must be a Buffer"})]),yZ=sg.lazy(()=>sg.union([sg.null(),sg.string(),sg.number(),sg.boolean(),sg.record(sg.string(),yZ),sg.array(yZ)])),yB=sg.record(sg.string(),sg.record(sg.string(),yZ)),yV=sg.array(sg.union([sg.object({type:sg.literal("text"),text:sg.string()}),sg.object({type:sg.literal("image"),data:sg.string(),mimeType:sg.string().optional()})])),yK=sg.object({type:sg.literal("text"),text:sg.string(),providerOptions:yB.optional(),experimental_providerMetadata:yB.optional()}),yG=sg.object({type:sg.literal("image"),image:sg.union([yU,sg.instanceof(URL)]),mimeType:sg.string().optional(),providerOptions:yB.optional(),experimental_providerMetadata:yB.optional()}),yW=sg.object({type:sg.literal("file"),data:sg.union([yU,sg.instanceof(URL)]),filename:sg.string().optional(),mimeType:sg.string(),providerOptions:yB.optional(),experimental_providerMetadata:yB.optional()}),yQ=sg.object({type:sg.literal("reasoning"),text:sg.string(),providerOptions:yB.optional(),experimental_providerMetadata:yB.optional()}),yJ=sg.object({type:sg.literal("redacted-reasoning"),data:sg.string(),providerOptions:yB.optional(),experimental_providerMetadata:yB.optional()}),yH=sg.object({type:sg.literal("tool-call"),toolCallId:sg.string(),toolName:sg.string(),args:sg.unknown(),providerOptions:yB.optional(),experimental_providerMetadata:yB.optional()}),yY=sg.object({type:sg.literal("tool-result"),toolCallId:sg.string(),toolName:sg.string(),result:sg.unknown(),content:yV.optional(),isError:sg.boolean().optional(),providerOptions:yB.optional(),experimental_providerMetadata:yB.optional()}),yX=sg.object({role:sg.literal("system"),content:sg.string(),providerOptions:yB.optional(),experimental_providerMetadata:yB.optional()}),y0=sg.object({role:sg.literal("user"),content:sg.union([sg.string(),sg.array(sg.union([yK,yG,yW]))]),providerOptions:yB.optional(),experimental_providerMetadata:yB.optional()}),y1=sg.object({role:sg.literal("assistant"),content:sg.union([sg.string(),sg.array(sg.union([yK,yW,yQ,yJ,yH]))]),providerOptions:yB.optional(),experimental_providerMetadata:yB.optional()}),y2=sg.object({role:sg.literal("tool"),content:sg.array(yY),providerOptions:yB.optional(),experimental_providerMetadata:yB.optional()});sg.union([yX,y0,y1,y2]),fg({prefix:"aiobj",size:24}),fg({prefix:"aiobj",size:24}),fg({prefix:"aitxt",size:24}),fg({prefix:"msg",size:24}),yN({},{object:()=>y5,text:()=>y3});var y3=()=>({type:"text",responseFormat:()=>({type:"text"}),injectIntoSystemPrompt:({system:e})=>e,parsePartial:({text:e})=>({partial:e}),parseOutput:({text:e})=>e}),y5=({schema:e})=>{var t;let r="object"==typeof e&&null!==e&&fH in e&&!0===e[fH]&&"jsonSchema"in e&&"validate"in e?e:fY(((e,t)=>{let r,a,s=(a=void 0!==(r="string"==typeof t?{...fb,name:t}:{...fb,...t}).name?[...r.basePath,r.definitionPath,r.name]:r.basePath,{...r,flags:{hasReferencedOpenAiAnyType:!1},currentPath:a,propertyPath:void 0,seen:new Map(Object.entries(r.definitions).map(([e,t])=>[t._def,{def:t._def,path:[...r.basePath,r.definitionPath,e],jsonSchema:void 0}]))}),n="object"==typeof t&&t.definitions?Object.entries(t.definitions).reduce((e,[t,r])=>({...e,[t]:fK(r._def,{...s,currentPath:[...s.basePath,s.definitionPath,t]},!0)??fI(s)}),{}):void 0,i="string"==typeof t?t:t?.nameStrategy==="title"?void 0:t?.name,o=fK(e._def,void 0===i?s:{...s,currentPath:[...s.basePath,s.definitionPath,i]},!1)??fI(s),l="object"==typeof t&&void 0!==t.name&&"title"===t.nameStrategy?t.name:void 0;void 0!==l&&(o.title=l),s.flags.hasReferencedOpenAiAnyType&&(n||(n={}),n[s.openAiAnyTypeName]||(n[s.openAiAnyTypeName]={type:["string","number","integer","boolean","array","null"],items:{$ref:"relative"===s.$refStrategy?"1":[...s.basePath,s.definitionPath,s.openAiAnyTypeName].join("/")}}));let u=void 0===i?n?{...o,[s.definitionPath]:n}:o:{$ref:[..."relative"===s.$refStrategy?[]:s.basePath,s.definitionPath,i].join("/"),[s.definitionPath]:{...n,[i]:o}};return"jsonSchema7"===s.target?u.$schema="http://json-schema.org/draft-07/schema#":("jsonSchema2019-09"===s.target||"openAi"===s.target)&&(u.$schema="https://json-schema.org/draft/2019-09/schema#"),"openAi"===s.target&&("anyOf"in u||"oneOf"in u||"allOf"in u||"type"in u&&Array.isArray(u.type))&&console.warn("Warning: OpenAI may not support schemas with unions as roots! Try wrapping it in an object property."),u})(t=e,{$refStrategy:"none",target:"jsonSchema7"}),{validate:e=>{let r=t.safeParse(e);return r.success?{success:!0,value:r.data}:{success:!1,error:r.error}}});return{type:"object",responseFormat:({model:e})=>({type:"json",schema:e.supportsStructuredOutputs?r.jsonSchema:void 0}),injectIntoSystemPrompt:({system:e,model:t})=>t.supportsStructuredOutputs?e:function({prompt:e,schema:t,schemaPrefix:r=null!=t?"JSON schema:":void 0,schemaSuffix:a=null!=t?"You MUST answer with a JSON object that matches the JSON schema above.":"You MUST answer with JSON."}){return[null!=e&&e.length>0?e:void 0,null!=e&&e.length>0?"":void 0,r,null!=t?JSON.stringify(t):void 0,a].filter(e=>null!=e).join("\n")}({prompt:e,schema:r.jsonSchema}),parsePartial({text:e}){let t=function(e){if(void 0===e)return{value:void 0,state:"undefined-input"};let t=fy({text:e});return t.success?{value:t.value,state:"successful-parse"}:(t=fy({text:function(e){let t=["ROOT"],r=-1,a=null;function s(e,s,n){switch(e){case'"':r=s,t.pop(),t.push(n),t.push("INSIDE_STRING");break;case"f":case"t":case"n":r=s,a=s,t.pop(),t.push(n),t.push("INSIDE_LITERAL");break;case"-":t.pop(),t.push(n),t.push("INSIDE_NUMBER");break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":r=s,t.pop(),t.push(n),t.push("INSIDE_NUMBER");break;case"{":r=s,t.pop(),t.push(n),t.push("INSIDE_OBJECT_START");break;case"[":r=s,t.pop(),t.push(n),t.push("INSIDE_ARRAY_START")}}function n(e,a){switch(e){case",":t.pop(),t.push("INSIDE_OBJECT_AFTER_COMMA");break;case"}":r=a,t.pop()}}function i(e,a){switch(e){case",":t.pop(),t.push("INSIDE_ARRAY_AFTER_COMMA");break;case"]":r=a,t.pop()}}for(let o=0;o<e.length;o++){let l=e[o];switch(t[t.length-1]){case"ROOT":s(l,o,"FINISH");break;case"INSIDE_OBJECT_START":switch(l){case'"':t.pop(),t.push("INSIDE_OBJECT_KEY");break;case"}":r=o,t.pop()}break;case"INSIDE_OBJECT_AFTER_COMMA":'"'===l&&(t.pop(),t.push("INSIDE_OBJECT_KEY"));break;case"INSIDE_OBJECT_KEY":'"'===l&&(t.pop(),t.push("INSIDE_OBJECT_AFTER_KEY"));break;case"INSIDE_OBJECT_AFTER_KEY":":"===l&&(t.pop(),t.push("INSIDE_OBJECT_BEFORE_VALUE"));break;case"INSIDE_OBJECT_BEFORE_VALUE":s(l,o,"INSIDE_OBJECT_AFTER_VALUE");break;case"INSIDE_OBJECT_AFTER_VALUE":n(l,o);break;case"INSIDE_STRING":switch(l){case'"':t.pop(),r=o;break;case"\\":t.push("INSIDE_STRING_ESCAPE");break;default:r=o}break;case"INSIDE_ARRAY_START":"]"===l?(r=o,t.pop()):(r=o,s(l,o,"INSIDE_ARRAY_AFTER_VALUE"));break;case"INSIDE_ARRAY_AFTER_VALUE":switch(l){case",":t.pop(),t.push("INSIDE_ARRAY_AFTER_COMMA");break;case"]":r=o,t.pop();break;default:r=o}break;case"INSIDE_ARRAY_AFTER_COMMA":s(l,o,"INSIDE_ARRAY_AFTER_VALUE");break;case"INSIDE_STRING_ESCAPE":t.pop(),r=o;break;case"INSIDE_NUMBER":switch(l){case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":r=o;break;case"e":case"E":case"-":case".":break;case",":t.pop(),"INSIDE_ARRAY_AFTER_VALUE"===t[t.length-1]&&i(l,o),"INSIDE_OBJECT_AFTER_VALUE"===t[t.length-1]&&n(l,o);break;case"}":t.pop(),"INSIDE_OBJECT_AFTER_VALUE"===t[t.length-1]&&n(l,o);break;case"]":t.pop(),"INSIDE_ARRAY_AFTER_VALUE"===t[t.length-1]&&i(l,o);break;default:t.pop()}break;case"INSIDE_LITERAL":{let s=e.substring(a,o+1);"false".startsWith(s)||"true".startsWith(s)||"null".startsWith(s)?r=o:(t.pop(),"INSIDE_OBJECT_AFTER_VALUE"===t[t.length-1]?n(l,o):"INSIDE_ARRAY_AFTER_VALUE"===t[t.length-1]&&i(l,o))}}}let o=e.slice(0,r+1);for(let r=t.length-1;r>=0;r--)switch(t[r]){case"INSIDE_STRING":o+='"';break;case"INSIDE_OBJECT_KEY":case"INSIDE_OBJECT_AFTER_KEY":case"INSIDE_OBJECT_AFTER_COMMA":case"INSIDE_OBJECT_START":case"INSIDE_OBJECT_BEFORE_VALUE":case"INSIDE_OBJECT_AFTER_VALUE":o+="}";break;case"INSIDE_ARRAY_START":case"INSIDE_ARRAY_AFTER_COMMA":case"INSIDE_ARRAY_AFTER_VALUE":o+="]";break;case"INSIDE_LITERAL":{let t=e.substring(a,e.length);"true".startsWith(t)?o+="true".slice(t.length):"false".startsWith(t)?o+="false".slice(t.length):"null".startsWith(t)&&(o+="null".slice(t.length))}}return o}(e)})).success?{value:t.value,state:"repaired-parse"}:{value:void 0,state:"failed-parse"}}(e);switch(t.state){case"failed-parse":case"undefined-input":return;case"repaired-parse":case"successful-parse":return{partial:t.value};default:{let e=t.state;throw Error(`Unsupported parse state: ${e}`)}}},parseOutput({text:e},t){let a=fy({text:e});if(!a.success)throw new yF({message:"No object generated: could not parse the response.",cause:a.error,text:e,response:t.response,usage:t.usage,finishReason:t.finishReason});let s=ff({value:a.value,schema:r});if(!s.success)throw new yF({message:"No object generated: response did not match schema.",cause:s.error,text:e,response:t.response,usage:t.usage,finishReason:t.finishReason});return s.value}}};function y4(e,t){let r,a,s=e.getReader(),n=t.getReader(),i=!1,o=!1;async function l(e){try{null==r&&(r=s.read());let t=await r;r=void 0,t.done?e.close():e.enqueue(t.value)}catch(t){e.error(t)}}async function u(e){try{null==a&&(a=n.read());let t=await a;a=void 0,t.done?e.close():e.enqueue(t.value)}catch(t){e.error(t)}}return new ReadableStream({async pull(e){try{if(i)return void await u(e);if(o)return void await l(e);null==r&&(r=s.read()),null==a&&(a=n.read());let{result:t,reader:p}=await Promise.race([r.then(e=>({result:e,reader:s})),a.then(e=>({result:e,reader:n}))]);t.done||e.enqueue(t.value),p===s?(r=void 0,t.done&&(await u(e),i=!0)):(a=void 0,t.done&&(o=!0,await l(e)))}catch(t){e.error(t)}},cancel(){s.cancel(),n.cancel()}})}fg({prefix:"aitxt",size:24}),fg({prefix:"msg",size:24});var y6=sg.object({name:sg.string(),version:sg.string()}).passthrough(),y7=sg.object({_meta:sg.optional(sg.object({}).passthrough())}).passthrough(),y9=sg.object({method:sg.string(),params:sg.optional(y7)}),y8=sg.object({experimental:sg.optional(sg.object({}).passthrough()),logging:sg.optional(sg.object({}).passthrough()),prompts:sg.optional(sg.object({listChanged:sg.optional(sg.boolean())}).passthrough()),resources:sg.optional(sg.object({subscribe:sg.optional(sg.boolean()),listChanged:sg.optional(sg.boolean())}).passthrough()),tools:sg.optional(sg.object({listChanged:sg.optional(sg.boolean())}).passthrough())}).passthrough();y7.extend({protocolVersion:sg.string(),capabilities:y8,serverInfo:y6,instructions:sg.optional(sg.string())});var ve=y7.extend({nextCursor:sg.optional(sg.string())}),vt=sg.object({name:sg.string(),description:sg.optional(sg.string()),inputSchema:sg.object({type:sg.literal("object"),properties:sg.optional(sg.object({}).passthrough())}).passthrough()}).passthrough();ve.extend({tools:sg.array(vt)});var vr=sg.object({type:sg.literal("text"),text:sg.string()}).passthrough(),va=sg.object({type:sg.literal("image"),data:sg.string().base64(),mimeType:sg.string()}).passthrough(),vs=sg.object({uri:sg.string(),mimeType:sg.optional(sg.string())}).passthrough(),vn=vs.extend({text:sg.string()}),vi=vs.extend({blob:sg.string().base64()}),vo=sg.object({type:sg.literal("resource"),resource:sg.union([vn,vi])}).passthrough();y7.extend({content:sg.array(sg.union([vr,va,vo])),isError:sg.boolean().default(!1).optional()}).or(y7.extend({toolResult:sg.unknown()}));var vl=sg.object({jsonrpc:sg.literal("2.0"),id:sg.union([sg.string(),sg.number().int()])}).merge(y9).strict(),vu=sg.object({jsonrpc:sg.literal("2.0"),id:sg.union([sg.string(),sg.number().int()]),result:y7}).strict(),vp=sg.object({jsonrpc:sg.literal("2.0"),id:sg.union([sg.string(),sg.number().int()]),error:sg.object({code:sg.number().int(),message:sg.string(),data:sg.optional(sg.unknown())})}).strict(),vd=sg.object({jsonrpc:sg.literal("2.0")}).merge(sg.object({method:sg.string(),params:sg.optional(y7)})).strict();function vc(e={}){let t=new TextEncoder,r="";return new TransformStream({async start(){e.onStart&&await e.onStart()},async transform(a,s){s.enqueue(t.encode(a)),r+=a,e.onToken&&await e.onToken(a),e.onText&&"string"==typeof a&&await e.onText(a)},async flush(){e.onCompletion&&await e.onCompletion(r),e.onFinal&&await e.onFinal(r)}})}function vm(e,t){return e.pipeThrough(new TransformStream({transform:async(e,t)=>{var r;if("string"==typeof e)return void t.enqueue(e);if("event"in e){"on_chat_model_stream"===e.event&&vy(null==(r=e.data)?void 0:r.chunk,t);return}vy(e,t)}})).pipeThrough(vc(t)).pipeThrough(new TextDecoderStream).pipeThrough(new TransformStream({transform:async(e,t)=>{t.enqueue(fJ("text",e))}}))}function vg(e,t){return vm(e,t).pipeThrough(new TextEncoderStream)}function vh(e,t){var r;let a=vm(e,null==t?void 0:t.callbacks).pipeThrough(new TextEncoderStream),s=null==t?void 0:t.data,n=null==t?void 0:t.init;return new Response(s?y4(s.stream,a):a,{status:null!=(r=null==n?void 0:n.status)?r:200,statusText:null==n?void 0:n.statusText,headers:yL(null==n?void 0:n.headers,{contentType:"text/plain; charset=utf-8",dataStreamVersion:"v1"})})}function vf(e,t){t.dataStream.merge(vm(e,t.callbacks))}function vy(e,t){if("string"==typeof e.content)t.enqueue(e.content);else for(let r of e.content)"text"===r.type&&t.enqueue(r.text)}function vv(e,t){var r;let a,s=(a=!0,e=>(a&&(e=e.trimStart())&&(a=!1),e));return(r=e[Symbol.asyncIterator](),new ReadableStream({async pull(e){try{let{value:t,done:a}=await r.next();a?e.close():e.enqueue(t)}catch(t){e.error(t)}},cancel(){}})).pipeThrough(new TransformStream({async transform(e,t){t.enqueue(s(e.delta))}})).pipeThrough(vc(t)).pipeThrough(new TextDecoderStream).pipeThrough(new TransformStream({transform:async(e,t)=>{t.enqueue(fJ("text",e))}}))}function vb(e,t){return vv(e,t).pipeThrough(new TextEncoderStream)}function vw(e,t={}){var r;let{init:a,data:s,callbacks:n}=t,i=vv(e,n).pipeThrough(new TextEncoderStream);return new Response(s?y4(s.stream,i):i,{status:null!=(r=null==a?void 0:a.status)?r:200,statusText:null==a?void 0:a.statusText,headers:yL(null==a?void 0:a.headers,{contentType:"text/plain; charset=utf-8",dataStreamVersion:"v1"})})}function vk(e,t){t.dataStream.merge(vv(e,t.callbacks))}function v_(e,t="jsonSchema7"){return fY(mh(e,t),{validate:t=>{let r=e.safeParse(t);return r.success?{success:!0,value:r.data}:{success:!1,error:r.error}}})}function vI(e){return"object"==typeof e&&null!==e&&("_def"in e||"_zod"in e)&&"parse"in e&&"function"==typeof e.parse&&"safeParse"in e&&"function"==typeof e.safeParse}function vS({schema:e,compatLayers:t,mode:r}){let a;for(let s of(a=vI(e)?e:function(e){if(vI(e))return e;{let t="jsonSchema"in e?e.jsonSchema:e;try{if("toJSONSchema"in sg)return m2(t);return function e(t){function r(e,t){return t.description&&(e=e.describe(t.description)),e}if(void 0!==t.const){if("string"==typeof t.const);else if("number"==typeof t.const);else if("boolean"==typeof t.const);else if(null===t.const)return r(hY.null(),t);return r(hY.literal(t.const),t)}if(t.type)switch(t.type){case"string":{if(t.enum){if(0===t.enum.length)return r(hY.string(),t);return r(hY.enum(t.enum),t)}let e=hY.string();if(void 0!==t.minLength&&(e=e.min(t.minLength)),void 0!==t.maxLength&&(e=e.max(t.maxLength)),void 0!==t.pattern){let r=new RegExp(t.pattern);e=e.regex(r)}return r(e,t)}case"number":case"integer":{if(t.enum){if(0===t.enum.length)return r(hY.number(),t);let e=t.enum.map(e=>hY.literal(e));if(1===e.length)return r(e[0],t);if(e.length>=2)return r(hY.union([e[0],e[1],...e.slice(2)]),t)}let e="integer"===t.type?hY.number().int():hY.number();return void 0!==t.minimum&&(e=e.min(t.minimum)),void 0!==t.maximum&&(e=e.max(t.maximum)),void 0!==t.exclusiveMinimum&&(e=e.gt(t.exclusiveMinimum)),void 0!==t.exclusiveMaximum&&(e=e.lt(t.exclusiveMaximum)),void 0!==t.multipleOf&&(e=e.multipleOf(t.multipleOf)),r(e,t)}case"boolean":if(t.enum){if(0===t.enum.length)return r(hY.boolean(),t);let e=t.enum.map(e=>hY.literal(e));if(1===e.length)return r(e[0],t);if(e.length>=2)return r(hY.union([e[0],e[1],...e.slice(2)]),t)}return r(hY.boolean(),t);case"null":return r(hY.null(),t);case"object":if(t.properties){let a={};for(let[r,s]of Object.entries(t.properties))a[r]=e(s);if(t.required&&Array.isArray(t.required)){let e=new Set(t.required);for(let t of Object.keys(a))e.has(t)||(a[t]=a[t].optional())}else for(let e of Object.keys(a))a[e]=a[e].optional();return r(!1!==t.additionalProperties?hY.object(a).passthrough():hY.object(a),t)}return r(hY.object({}),t);case"array":{let a;return a=t.items?hY.array(e(t.items)):hY.array(hY.any()),void 0!==t.minItems&&(a=a.min(t.minItems)),void 0!==t.maxItems&&(a=a.max(t.maxItems)),!0===t.uniqueItems&&(a=a.refine(e=>{let t=new Set;return e.every(e=>{if("string"==typeof e||"number"==typeof e||"boolean"==typeof e)return!t.has(e)&&(t.add(e),!0);let r=JSON.stringify(e);return!t.has(r)&&(t.add(r),!0)})},{message:"Array items must be unique"})),r(a,t)}}if(t.enum){if(0===t.enum.length)return r(hY.never(),t);if(t.enum.every(e=>"string"==typeof e))return r(hY.enum(t.enum),t);{let e=t.enum.map(e=>hY.literal(e));if(1===e.length)return r(e[0],t);if(e.length>=2)return r(hY.union([e[0],e[1],...e.slice(2)]),t)}}if(t.anyOf&&t.anyOf.length>=2){let a=t.anyOf.map(e);return r(hY.union([a[0],a[1],...a.slice(2)]),t)}if(t.allOf)return r(t.allOf.reduce((t,r)=>hY.intersection(t,e(r)),hY.object({})),t);if(t.oneOf&&t.oneOf.length>=2){let a=t.oneOf.map(e);return r(hY.union([a[0],a[1],...a.slice(2)]),t)}return r(hY.any(),t)}(t)}catch(r){let e=`[Schema Builder] Failed to convert schema parameters to Zod. Original schema: ${JSON.stringify(t)}`;throw console.error(e,r),Error(e+(r instanceof Error?`
${r.stack}`:"\nUnknown error object"))}}}(e),t))if(s.shouldApply())return"jsonSchema"===r?s.processToJSONSchema(a):s.processToAISDKSchema(a);return"jsonSchema"===r?mh(a,"jsonSchema7"):v_(a)}sg.union([vl,vd,vu,vp]),yN({},{mergeIntoDataStream:()=>vf,toDataStream:()=>vg,toDataStreamResponse:()=>vh}),yN({},{mergeIntoDataStream:()=>vk,toDataStream:()=>vb,toDataStreamResponse:()=>vw});var vx=["regex","emoji","email","url","uuid","cuid","min","max"],vT=["min","max","multipleOf"],vE=["min","max","length"],vA=["ZodIntersection","ZodNever","ZodNull","ZodTuple","ZodUndefined"],vO=["ZodObject","ZodArray","ZodUnion","ZodString","ZodNumber","ZodDate","ZodAny","ZodDefault","ZodNullable"];[...vO,...vA];var vz=class{model;parent;constructor(e,t){this.model=e,this.parent=t}getModel(){return this.model}getUnsupportedZodTypes(){return vA}isOptional(e){return e instanceof mf.ZodOptional}isObj(e){return e instanceof mf.ZodObject}isNull(e){return e instanceof mf.ZodNull}isArr(e){return e instanceof mf.ZodArray}isUnion(e){return e instanceof mf.ZodUnion}isString(e){return e instanceof mf.ZodString}isNumber(e){return e instanceof mf.ZodNumber}isDate(e){return e instanceof mf.ZodDate}isDefault(e){return e instanceof mf.ZodDefault}shouldApply(){return this.parent.shouldApply()}getSchemaTarget(){return this.parent.getSchemaTarget()}processZodType(e){return this.parent.processZodType(e)}defaultZodObjectHandler(e,t={passthrough:!0}){let r=Object.entries(e.shape).reduce((e,[t,r])=>(e[t]=this.processZodType(r),e),{}),a=sg.object(r);return"strict"===e._def.unknownKeys&&(a=a.strict()),!e._def.catchall||e._def.catchall instanceof sg.ZodNever||(a=a.catchall(e._def.catchall)),e.description&&(a=a.describe(e.description)),t.passthrough&&"passthrough"===e._def.unknownKeys&&(a=a.passthrough()),a}mergeParameterDescription(e,t){return t.length>0?(e?e+"\n":"")+`constraints: ${t.join(", ")}`:e}defaultUnsupportedZodTypeHandler(e,t=vA){if(t.includes(e._def?.typeName))throw Error(`${this.model.modelId} does not support zod type: ${e._def?.typeName}`);return e}defaultZodArrayHandler(e,t=vE){let r=e._def,a=this.processZodType(r.type),s=sg.array(a),n=[];r.minLength?.value!==void 0&&(t.includes("min")?n.push(`minimum length ${r.minLength.value}`):s=s.min(r.minLength.value)),r.maxLength?.value!==void 0&&(t.includes("max")?n.push(`maximum length ${r.maxLength.value}`):s=s.max(r.maxLength.value)),r.exactLength?.value!==void 0&&(t.includes("length")?n.push(`exact length ${r.exactLength.value}`):s=s.length(r.exactLength.value));let i=this.mergeParameterDescription(e.description,n);return i&&(s=s.describe(i)),s}defaultZodUnionHandler(e){let t=e._def.options.map(e=>this.processZodType(e));if(t.length<2)throw Error("Union must have at least 2 options");let r=sg.union(t);return e.description&&(r=r.describe(e.description)),r}defaultZodStringHandler(e,t=vx){let r=[],a=e._def.checks||[],s=[];for(let e of a)if("kind"in e)if(t.includes(e.kind))switch(e.kind){case"regex":r.push(`input must match this regex ${e.regex.source}`);break;case"emoji":case"email":case"url":case"uuid":case"cuid":r.push(`a valid ${e.kind}`);break;case"min":case"max":r.push(`${e.kind}imum length ${e.value}`)}else s.push(e);let n=sg.string();for(let e of s)n=n._addCheck(e);let i=this.mergeParameterDescription(e.description,r);return i&&(n=n.describe(i)),n}defaultZodNumberHandler(e,t=vT){let r=[],a=e._def.checks||[],s=[];for(let e of a)if("kind"in e)if(t.includes(e.kind))switch(e.kind){case"min":e.inclusive?r.push(`greater than or equal to ${e.value}`):r.push(`greater than ${e.value}`);break;case"max":e.inclusive?r.push(`lower than or equal to ${e.value}`):r.push(`lower than ${e.value}`);break;case"multipleOf":r.push(`multiple of ${e.value}`)}else s.push(e);let n=sg.number();for(let e of s)switch(e.kind){case"int":n=n.int();break;case"finite":n=n.finite();break;default:n=n._addCheck(e)}let i=this.mergeParameterDescription(e.description,r);return i&&(n=n.describe(i)),n}defaultZodDateHandler(e){let t=[];for(let r of e._def.checks||[])if("kind"in r)switch(r.kind){case"min":let e=new Date(r.value);isNaN(e.getTime())||t.push(`Date must be newer than ${e.toISOString()} (ISO)`);break;case"max":let a=new Date(r.value);isNaN(a.getTime())||t.push(`Date must be older than ${a.toISOString()} (ISO)`)}t.push("Date format is date-time");let r=sg.string().describe("date-time"),a=this.mergeParameterDescription(e.description,t);return a&&(r=r.describe(a)),r}defaultZodOptionalHandler(e,t=vO){return t.includes(e._def.innerType._def.typeName)?this.processZodType(e._def.innerType).optional():e}processToAISDKSchema(e){return v_(this.processZodType(e),this.getSchemaTarget())}processToJSONSchema(e){return this.processToAISDKSchema(e).jsonSchema}},vM=["regex","emoji","email","url","uuid","cuid","min_length","max_length","string_format"],vP=["greater_than","less_than","multiple_of"],vR=["min","max","length"],vC=["ZodIntersection","ZodNever","ZodNull","ZodTuple","ZodUndefined"],vj=["ZodObject","ZodArray","ZodUnion","ZodString","ZodNumber","ZodDate","ZodAny","ZodDefault","ZodNullable"],vN=class{model;parent;constructor(e,t){this.model=e,this.parent=t}getModel(){return this.model}getUnsupportedZodTypes(){return vC}isOptional(e){return e instanceof mf.ZodOptional}isObj(e){return e instanceof mf.ZodObject}isNull(e){return e instanceof mf.ZodNull}isNullable(e){return e instanceof mf.ZodNullable}isArr(e){return e instanceof mf.ZodArray}isUnion(e){return e instanceof mf.ZodUnion}isString(e){return e instanceof mf.ZodString}isNumber(e){return e instanceof mf.ZodNumber}isDate(e){return e instanceof mf.ZodDate}isDefault(e){return e instanceof mf.ZodDefault}shouldApply(){return this.parent.shouldApply()}getSchemaTarget(){return this.parent.getSchemaTarget()}processZodType(e){return this.parent.processZodType(e)}defaultZodObjectHandler(e,t={passthrough:!0}){let r=Object.entries(e.shape).reduce((e,[t,r])=>(e[t]=this.processZodType(r),e),{}),a=eU.z.object(r);return e._zod.def.catchall instanceof eU.z.ZodNever&&(a=eU.z.strictObject(r)),!e._zod.def.catchall||e._zod.def.catchall instanceof eU.z.ZodNever||(a=a.catchall(e._zod.def.catchall)),e.description&&(a=a.describe(e.description)),t.passthrough&&e._zod.def.catchall instanceof eU.z.ZodUnknown&&(a=eU.z.looseObject(r)),a}mergeParameterDescription(e,t){return t.length>0?(e?e+"\n":"")+`constraints: ${t.join(", ")}`:e}defaultUnsupportedZodTypeHandler(e,t=vC){if(t.includes(e.constructor.name))throw Error(`${this.model.modelId} does not support zod type: ${e.constructor.name}`);return e}defaultZodArrayHandler(e,t=vR){let r=e._zod.def,a=this.processZodType(r.element),s=eU.z.array(a),n=[];if(r.checks)for(let e of r.checks)"min_length"===e._zod.def.check&&(t.includes("min")?n.push(`minimum length ${e._zod.def.minimum}`):s=s.min(e._zod.def.minimum)),"max_length"===e._zod.def.check&&(t.includes("max")?n.push(`maximum length ${e._zod.def.maximum}`):s=s.max(e._zod.def.maximum)),"length_equals"===e._zod.def.check&&(t.includes("length")?n.push(`exact length ${e._zod.def.length}`):s=s.length(e._zod.def.length));let i=e.meta()?.description,o=e.description,l=this.mergeParameterDescription(i||o,n);return l&&(s=s.describe(l)),s}defaultZodUnionHandler(e){let t=e._zod.def.options.map(e=>this.processZodType(e));if(t.length<2)throw Error("Union must have at least 2 options");let r=eU.z.union(t);return e.description&&(r=r.describe(e.description)),r}defaultZodStringHandler(e,t=vM){let r=[],a=e._zod.def.checks||[],s=[];for(let e of a)if(t.includes(e._zod.def.check))switch(e._zod.def.check){case"min_length":r.push(`minimum length ${e._zod.def.minimum}`);break;case"max_length":r.push(`maximum length ${e._zod.def.maximum}`);break;case"string_format":switch(e._zod.def.format){case"email":case"url":case"emoji":case"uuid":case"cuid":r.push(`a valid ${e._zod.def.format}`);break;case"regex":r.push(`input must match this regex ${e._zod.def.pattern}`)}}else s.push(e);let n=eU.z.string();for(let e of s)n=n.check(e);let i=e.meta()?.description,o=e.description,l=this.mergeParameterDescription(i||o,r);return l&&(n=n.describe(l)),n}defaultZodNumberHandler(e,t=vP){let r=[],a=e._zod.def.checks||[],s=[];for(let e of a)if(t.includes(e._zod.def.check))switch(e._zod.def.check){case"greater_than":e._zod.def.inclusive?r.push(`greater than or equal to ${e._zod.def.value}`):r.push(`greater than ${e._zod.def.value}`);break;case"less_than":e._zod.def.inclusive?r.push(`lower than or equal to ${e._zod.def.value}`):r.push(`lower than ${e._zod.def.value}`);break;case"multiple_of":r.push(`multiple of ${e._zod.def.value}`)}else s.push(e);let n=eU.z.number();for(let e of s)"number_format"===e._zod.def.check?"safeint"===e._zod.def.format&&(n=n.int()):n=n.check(e);let i=this.mergeParameterDescription(e.description,r);return i&&(n=n.describe(i)),n}defaultZodDateHandler(e){let t=[];for(let r of e._zod.def.checks||[])switch(r._zod.def.check){case"less_than":let e=new Date(r._zod.def.value);isNaN(e.getTime())||t.push(`Date must be newer than ${e.toISOString()} (ISO)`);break;case"greater_than":let a=new Date(r._zod.def.value);isNaN(a.getTime())||t.push(`Date must be older than ${a.toISOString()} (ISO)`)}t.push("Date format is date-time");let r=eU.z.string().describe("date-time"),a=this.mergeParameterDescription(e.description,t);return a&&(r=r.describe(a)),r}defaultZodOptionalHandler(e,t=vj){return t.includes(e.constructor.name)?this.processZodType(e._zod.def.innerType).optional():e}processToAISDKSchema(e){return v_(this.processZodType(e),this.getSchemaTarget())}processToJSONSchema(e){return this.processToAISDKSchema(e).jsonSchema}},vL=class{model;v3Layer;v4Layer;constructor(e){this.model=e,this.v3Layer=new vz(e,this),this.v4Layer=new vN(e,this)}getModel(){return this.model}getUnsupportedZodTypes(e){return"_zod"in e?this.v4Layer.getUnsupportedZodTypes():this.v3Layer.getUnsupportedZodTypes()}isOptional(e){return"_zod"in e?this.v4Layer.isOptional(e):this.v3Layer.isOptional(e)}isObj(e){return"_zod"in e?this.v4Layer.isObj(e):this.v3Layer.isObj(e)}isNull(e){return"_zod"in e?this.v4Layer.isNull(e):this.v3Layer.isNull(e)}isArr(e){return"_zod"in e?this.v4Layer.isArr(e):this.v3Layer.isArr(e)}isUnion(e){return"_zod"in e?this.v4Layer.isUnion(e):this.v3Layer.isUnion(e)}isString(e){return"_zod"in e?this.v4Layer.isString(e):this.v3Layer.isString(e)}isNumber(e){return"_zod"in e?this.v4Layer.isNumber(e):this.v3Layer.isNumber(e)}isDate(e){return"_zod"in e?this.v4Layer.isDate(e):this.v3Layer.isDate(e)}isDefault(e){return"_zod"in e?this.v4Layer.isDefault(e):this.v3Layer.isDefault(e)}defaultZodObjectHandler(e,t={passthrough:!0}){return"_zod"in e?this.v4Layer.defaultZodObjectHandler(e,t):this.v3Layer.defaultZodObjectHandler(e,t)}mergeParameterDescription(e,t){return this.v3Layer.mergeParameterDescription(e,t)}defaultUnsupportedZodTypeHandler(e,t){return"_zod"in e?this.v4Layer.defaultUnsupportedZodTypeHandler(e,t??vC):this.v3Layer.defaultUnsupportedZodTypeHandler(e,t??vA)}defaultZodArrayHandler(e,t=vE){return"_zod"in e?this.v4Layer.defaultZodArrayHandler(e,t):this.v3Layer.defaultZodArrayHandler(e,t)}defaultZodUnionHandler(e){return"_zod"in e?this.v4Layer.defaultZodUnionHandler(e):this.v3Layer.defaultZodUnionHandler(e)}defaultZodStringHandler(e,t=vx){return"_zod"in e?this.v4Layer.defaultZodStringHandler(e):this.v3Layer.defaultZodStringHandler(e,t)}defaultZodNumberHandler(e,t=vT){return"_zod"in e?this.v4Layer.defaultZodNumberHandler(e):this.v3Layer.defaultZodNumberHandler(e,t)}defaultZodDateHandler(e){return"_zod"in e?this.v4Layer.defaultZodDateHandler(e):this.v3Layer.defaultZodDateHandler(e)}defaultZodOptionalHandler(e,t){return"_zod"in e?this.v4Layer.defaultZodOptionalHandler(e,t??vj):this.v3Layer.defaultZodOptionalHandler(e,t??vO)}processToAISDKSchema(e){return v_(this.processZodType(e),this.getSchemaTarget())}processToJSONSchema(e){return this.processToAISDKSchema(e).jsonSchema}};function vD(e){return t=>t instanceof e.ZodOptional}function vq(e){return t=>t instanceof e.ZodObject}function v$(e){return t=>t instanceof e.ZodArray}function vF(e){return t=>t instanceof e.ZodUnion}function vU(e){return t=>t instanceof e.ZodString}function vZ(e){return t=>t instanceof e.ZodNumber}function vB(e){return t=>t instanceof e.ZodDefault}function vV(e){return t=>t instanceof e.ZodNullable}var vK=class extends vL{constructor(e){super(e)}getSchemaTarget(){return"jsonSchema7"}shouldApply(){return this.getModel().modelId.includes("claude")}processZodType(e){if(vD(sg)(e)){let t=["ZodObject","ZodArray","ZodUnion","ZodNever","ZodUndefined","ZodTuple"];return this.getModel().modelId.includes("claude-3.5-haiku")&&t.push("ZodString"),this.defaultZodOptionalHandler(e,t)}if(vq(sg)(e))return this.defaultZodObjectHandler(e);if(v$(sg)(e))return this.defaultZodArrayHandler(e,[]);if(vF(sg)(e))return this.defaultZodUnionHandler(e);if(vU(sg)(e))if(this.getModel().modelId.includes("claude-3.5-haiku"))return this.defaultZodStringHandler(e,["max","min"]);else return e;return this.defaultUnsupportedZodTypeHandler(e,["ZodNever","ZodTuple","ZodUndefined"])}},vG=class extends vL{constructor(e){super(e)}getSchemaTarget(){return"jsonSchema7"}shouldApply(){return this.getModel().modelId.includes("deepseek")&&!this.getModel().modelId.includes("r1")}processZodType(e){if(vD(sg)(e))return this.defaultZodOptionalHandler(e,["ZodObject","ZodArray","ZodUnion","ZodString","ZodNumber"]);if(vq(sg)(e))return this.defaultZodObjectHandler(e);if(v$(sg)(e))return this.defaultZodArrayHandler(e,["min","max"]);if(vF(sg)(e))return this.defaultZodUnionHandler(e);if(vU(sg)(e))return this.defaultZodStringHandler(e);return e}},vW=class extends vL{constructor(e){super(e)}getSchemaTarget(){return"jsonSchema7"}shouldApply(){return this.getModel().provider.includes("google")||this.getModel().modelId.includes("google")}processZodType(e){var t;if(vD(sg)(e))return this.defaultZodOptionalHandler(e,["ZodObject","ZodArray","ZodUnion","ZodString","ZodNumber"]);if((t=sg,e=>e instanceof t.ZodNull)(e))return sg.any().refine(e=>null===e,{message:"must be null"}).describe(e.description||"must be null");if(vq(sg)(e))return this.defaultZodObjectHandler(e);if(v$(sg)(e))return this.defaultZodArrayHandler(e,[]);else if(vF(sg)(e))return this.defaultZodUnionHandler(e);else if(vU(sg)(e))return this.defaultZodStringHandler(e);else if(vZ(sg)(e))return this.defaultZodNumberHandler(e);return this.defaultUnsupportedZodTypeHandler(e)}},vQ=class extends vL{constructor(e){super(e)}getSchemaTarget(){return"jsonSchema7"}shouldApply(){return this.getModel().modelId.includes("meta")}processZodType(e){if(vD(sg)(e))return this.defaultZodOptionalHandler(e,["ZodObject","ZodArray","ZodUnion","ZodString","ZodNumber"]);if(vq(sg)(e))return this.defaultZodObjectHandler(e);if(v$(sg)(e))return this.defaultZodArrayHandler(e,["min","max"]);if(vF(sg)(e))return this.defaultZodUnionHandler(e);if(vZ(sg)(e))return this.defaultZodNumberHandler(e);else if(vU(sg)(e))return this.defaultZodStringHandler(e);return e}},vJ=class extends vL{constructor(e){super(e)}getSchemaTarget(){return"jsonSchema7"}shouldApply(){return!!(!this.getModel().supportsStructuredOutputs&&(this.getModel().provider.includes("openai")||this.getModel().modelId.includes("openai")))}processZodType(e){if(vD(sg)(e)){let t="_def"in e?e._def.innerType:e._zod?.def?.innerType;return t?vV(sg)(t)?this.processZodType(t).transform(e=>null===e?void 0:e):this.processZodType(t).nullable().transform(e=>null===e?void 0:e):e}if(vV(sg)(e)){let t="_def"in e?e._def.innerType:e._zod?.def?.innerType;if(t){if(vD(sg)(t)){let e="_def"in t?t._def.innerType:t._zod?.def?.innerType;if(e)return this.processZodType(e).nullable().transform(e=>null===e?void 0:e)}return this.processZodType(t).nullable()}return e}if(vB(sg)(e)){let t="_def"in e?e._def.innerType:e._zod?.def?.innerType,r="_def"in e?e._def.defaultValue:e._zod?.def?.defaultValue;return t?this.processZodType(t).nullable().transform(e=>null===e?"function"==typeof r?r():r:e):e}if(vq(sg)(e))return this.defaultZodObjectHandler(e);if(vF(sg)(e))return this.defaultZodUnionHandler(e);else if(v$(sg)(e))return this.defaultZodArrayHandler(e);else if(vU(sg)(e))return this.getModel().modelId.includes("gpt-4o-mini")?this.defaultZodStringHandler(e,["emoji","regex"]):this.defaultZodStringHandler(e,["emoji"]);return this.defaultUnsupportedZodTypeHandler(e,["ZodNever","ZodUndefined","ZodTuple"])}processToJSONSchema(e){let t=super.processToJSONSchema(e);return this.fixAdditionalProperties(t)}fixAdditionalProperties(e){if("object"!=typeof e||null===e)return e;let t={...e};return void 0===t.additionalProperties||"object"!=typeof t.additionalProperties||null===t.additionalProperties||Array.isArray(t.additionalProperties)||0!==Object.keys(t.additionalProperties).length||(t.additionalProperties=!0),t.properties&&(t.properties=Object.fromEntries(Object.entries(t.properties).map(([e,t])=>[e,this.fixAdditionalProperties(t)]))),t.items&&(Array.isArray(t.items)?t.items=t.items.map(e=>this.fixAdditionalProperties(e)):t.items=this.fixAdditionalProperties(t.items)),t.additionalProperties&&"object"==typeof t.additionalProperties&&!Array.isArray(t.additionalProperties)&&Object.keys(t.additionalProperties).length>0&&(t.additionalProperties=this.fixAdditionalProperties(t.additionalProperties)),t}},vH=class extends vL{constructor(e){super(e)}getSchemaTarget(){return"openApi3"}isReasoningModel(){return this.getModel().modelId.includes("o3")||this.getModel().modelId.includes("o4")||this.getModel().modelId.includes("o1")}shouldApply(){return!!(this.isReasoningModel()&&(this.getModel().provider.includes("openai")||this.getModel().modelId.includes("openai")))}processZodType(e){if(vD(sg)(e)){let t="_def"in e?e._def.innerType:e._zod?.def?.innerType;return t?vV(sg)(t)?this.processZodType(t).transform(e=>null===e?void 0:e):this.processZodType(t).nullable().transform(e=>null===e?void 0:e):e}if(vV(sg)(e)){let t="_def"in e?e._def.innerType:e._zod?.def?.innerType;if(t&&vD(sg)(t)){let e="_def"in t?t._def.innerType:t._zod?.def?.innerType;if(e)return this.processZodType(e).nullable().transform(e=>null===e?void 0:e)}return t?this.processZodType(t).nullable():e}if(vq(sg)(e))return this.defaultZodObjectHandler(e,{passthrough:!1});if(v$(sg)(e))return this.defaultZodArrayHandler(e);if(vF(sg)(e))return this.defaultZodUnionHandler(e);else if(vB(sg)(e)){let t=e._def,r=t.innerType,a="function"==typeof t.defaultValue?t.defaultValue():t.defaultValue,s=[];void 0!==a&&s.push(`the default value is ${a}`);let n=this.mergeParameterDescription(e.description,s),i=this.processZodType(r);return n&&(i=i.describe(n)),i}else{var t;if(vZ(sg)(e))return this.defaultZodNumberHandler(e);if(vU(sg)(e))return this.defaultZodStringHandler(e);if((t=sg,e=>e instanceof t.ZodDate)(e))return this.defaultZodDateHandler(e);if("ZodAny"===e.constructor.name)return sg.string().describe((e.description??"")+`
Argument was an "any" type, but you (the LLM) do not support "any", so it was cast to a "string" type`)}return this.defaultUnsupportedZodTypeHandler(e)}},vY=class extends cO.MastraBase{originalTool;options;logType;constructor(e){if(super({name:"CoreToolBuilder"}),this.originalTool=e.originalTool,this.options=e.options,this.logType=e.logType,!cA(this.originalTool)&&e.autoResumeSuspendedTools){let e=this.originalTool.inputSchema;"function"==typeof e&&(e=e()),e||(e=sg.object({})),p7(e)&&(this.originalTool.inputSchema=e.extend({suspendedToolRunId:sg.string().describe("The runId of the suspended tool").optional().default(""),resumeData:sg.any().describe("The resumeData object created from the resumeSchema of suspended tool").optional()}))}}getParameters=()=>{if(cA(this.originalTool)){let e=this.originalTool.parameters??("inputSchema"in this.originalTool?this.originalTool.inputSchema:void 0)??sg.object({});return"function"==typeof e&&(e=e()),e}let e=this.originalTool.inputSchema;return"function"==typeof e&&(e=e()),e};getOutputSchema=()=>{if("outputSchema"in this.originalTool){let e=this.originalTool.outputSchema;return"function"==typeof e&&(e=e()),e}return null};getResumeSchema=()=>{if("resumeSchema"in this.originalTool){let e=this.originalTool.resumeSchema;return"function"==typeof e&&(e=e()),e}return null};getSuspendSchema=()=>{if("suspendSchema"in this.originalTool){let e=this.originalTool.suspendSchema;return"function"==typeof e&&(e=e()),e}return null};buildProviderTool(e){if("type"in e&&("provider-defined"===e.type||"provider"===e.type)&&"id"in e&&"string"==typeof e.id&&e.id.includes(".")){let t,r,a="parameters"in e?e.parameters:"inputSchema"in e?e.inputSchema:void 0;"function"==typeof a&&(a=a());let s="outputSchema"in e?e.outputSchema:void 0;return"function"==typeof s&&(s=s()),null!=a&&(t="object"==typeof a&&"jsonSchema"in a?a:v_(a)),null!=s&&(r="object"==typeof s&&"jsonSchema"in s?s:v_(s)),{...r?{outputSchema:r}:{},type:"provider-defined",id:e.id,args:"args"in this.originalTool?this.originalTool.args:{},description:e.description,parameters:t,execute:this.originalTool.execute?this.createExecute(this.originalTool,{...this.options,description:this.originalTool.description},this.logType):void 0}}}createLogMessageOptions({agentName:e,toolName:t,type:r}){if(!e)return{start:`Executing tool ${t}`,error:"Failed tool execution"};let a=`[Agent:${e}]`,s="toolset"===r?"toolset":"tool";return{start:`${a} - Executing ${s} ${t}`,error:`${a} - Failed ${s} execution`}}createExecute(e,t,r,a){let{logger:s,mastra:n,memory:i,requestContext:o,model:l,...u}=t,p={modelId:l?.modelId,provider:l?.provider,specificationVersion:l?.specificationVersion},{start:d,error:c}=this.createLogMessageOptions({agentName:t.agentName,toolName:t.name,type:r}),m=async(a,n)=>{let i=n.tracingContext||t.tracingContext,o=i?.currentSpan?.createChildSpan({type:"tool_call",name:`tool: '${t.name}'`,input:a,entityType:"tool",entityName:t.name,attributes:{toolDescription:t.description,toolType:r||"tool"},tracingPolicy:t.tracingPolicy});try{let r,i=null;if(cA(e))r=await pJ({span:o,fn:async()=>e?.execute?.(a,n)});else{let l,u=t.mastra?p3(t.mastra,{currentSpan:o}):t.mastra,p=this.getResumeSchema(),d={threadId:t.threadId,resourceId:t.resourceId,mastra:u,memory:t.memory,runId:t.runId,requestContext:t.requestContext??new c_,writer:new cb({prefix:"tool",callId:n.toolCallId,name:t.name,runId:t.runId},t.outputWriter||n.outputWriter),tracingContext:{currentSpan:o},abortSignal:n.abortSignal,suspend:(e,t)=>{i=e;let r={...t??{},resumeSchema:t?.resumeSchema??(p?JSON.stringify(mh(p)):void 0)};return n.suspend?.(e,r)},resumeData:n.resumeData},c=n.toolCallId&&n.messages||t.agentName&&t.threadId&&!t.workflowId,m=!c&&(t.workflow||t.workflowId);if(c){let{suspend:e,resumeData:t,threadId:r,resourceId:a,...s}=d;l={...s,agent:{toolCallId:n.toolCallId||"",messages:n.messages||[],suspend:e,resumeData:t,threadId:r,resourceId:a,outputWriter:n.outputWriter}}}else if(m){let{suspend:e,resumeData:r,...a}=d;l={...a,workflow:t.workflow||{runId:t.runId,workflowId:t.workflowId,state:t.state,setState:t.setState,suspend:e,resumeData:r}}}else l=n.mcp?{...d,mcp:n.mcp}:d;let g=n.resumeData;if(g){let e=cx(p,g,t.name);if(e.error)return s?.warn(e.error.message),o?.end({output:e.error,attributes:{success:!1}}),e.error}r=await pJ({span:o,fn:async()=>e?.execute?.(a,l)})}if(i){let e=this.getSuspendSchema(),r=cS(e,i,t.name);if(r.error)return s?.warn(r.error.message),o?.end({output:r.error,attributes:{success:!1}}),r.error}if(void 0===r&&i)return o?.end({output:r,attributes:{success:!0}}),r;if(cA(e)){let e=this.getOutputSchema(),a=cT(e,r,t.name,!1);if(a.error)return s?.warn(a.error.message),o?.end({output:a.error,attributes:{success:!1}}),a.error;r=a.data}return o?.end({output:r,attributes:{success:!0}}),r}catch(e){throw o?.error({error:e,attributes:{success:!1}}),e}};return async(e,r)=>{let s=t.logger||this.logger;try{s.debug(d,{...u,model:p,args:e});let n=a||this.getParameters(),{data:i,error:o}=cx(n,e,t.name);if(o)return s.warn(o.message),o;return e=i,await new Promise((t,a)=>{setImmediate(async()=>{try{let a=await m(e,r);t(a)}catch(e){a(e)}})})}catch(r){let t=new eN.MastraError({id:"TOOL_EXECUTION_FAILED",domain:"TOOL",category:"USER",details:{errorMessage:String(c),argsJson:JSON.stringify(e),model:l?.modelId??""}},r);return s.trackException(t),s.error(c,{...u,model:p,error:t,args:e}),t}}}buildV5(){let e=this.build();if(!e.parameters)throw Error("Tool parameters are required");let t={...e,inputSchema:e.parameters,onInputStart:"onInputStart"in this.originalTool?this.originalTool.onInputStart:void 0,onInputDelta:"onInputDelta"in this.originalTool?this.originalTool.onInputDelta:void 0,onInputAvailable:"onInputAvailable"in this.originalTool?this.originalTool.onInputAvailable:void 0,onOutput:"onOutput"in this.originalTool?this.originalTool.onOutput:void 0};if("provider-defined"===e.type){let{execute:r,parameters:a,...s}=t,n=e.id.split(".")[1]||e.id;return{...s,type:e.type,id:e.id,name:n,args:e.args}}return t}build(){let e,t,r,a,s=this.buildProviderTool(this.originalTool);if(s)return s;let n=this.options.model,i=[];if(n){let e="supportsStructuredOutputs"in n&&(n.supportsStructuredOutputs??!1),t={modelId:n.modelId,supportsStructuredOutputs:e,provider:n.provider};i.push(new vH(t),new vJ(t),new vW(t),new vK(t),new vG(t),new vQ(t))}let o=this.getParameters(),l=i.find(e=>e.shouldApply());l&&o?(e=l.processZodType(o),t=vS({schema:o,compatLayers:i,mode:"aiSdkSchema"})):o?(e=o,t=vS({schema:o,compatLayers:i,mode:"aiSdkSchema"})):(e=void 0,t=void 0),this.getOutputSchema()&&(r=vS({schema:this.getOutputSchema(),compatLayers:[],mode:"aiSdkSchema"}));let u=this.options.requireApproval;if(cA(this.originalTool)&&"needsApproval"in this.originalTool){let e=this.originalTool.needsApproval;"boolean"==typeof e?u=e:"function"==typeof e&&(a=e,u=!0)}return{...{type:"function",description:this.originalTool.description,requireApproval:u,needsApprovalFn:a,hasSuspendSchema:!!this.getSuspendSchema(),execute:this.originalTool.execute?this.createExecute(this.originalTool,{...this.options,description:this.originalTool.description},this.logType,e):void 0},id:"id"in this.originalTool?this.originalTool.id:void 0,parameters:t??sg.object({}),outputSchema:r,providerOptions:"providerOptions"in this.originalTool?this.originalTool.providerOptions:void 0,mcp:"mcp"in this.originalTool?this.originalTool.mcp:void 0}}},vX=e=>new Promise(t=>setTimeout(t,e));function v0(e){return"object"==typeof e&&null!==e&&"_def"in e&&"parse"in e&&"function"==typeof e.parse&&"safeParse"in e&&"function"==typeof e.safeParse}function v1(e){return Object.keys(e).reduce((t,r)=>{let a=e?.[r];if(a){if("function"==typeof a&&!(a instanceof cE)&&!cA(a))throw new eN.MastraError({id:"TOOL_INVALID_FORMAT",domain:"TOOL",category:"USER",text:`Tool "${r}" is not a valid tool format. Tools must be created using createTool() or be a valid Vercel AI SDK tool. Received a function.`});if(cA(a)){var s,n;let e,i,o;t[r]=(e="inputSchema"in a?a.inputSchema:("function"==typeof(o=a.parameters??sg.object({}))&&(o=o()),v0(o)?o:(n=function(e,t={}){return((e,{module:t,name:r,type:a,noImport:s,...n}={})=>{if(a&&(!r||"esm"!==t))throw Error("Option `type` requires `name` to be set and `module` to be `esm`");let i=cD(e,{module:t,name:r,path:[],seen:new Map,...n}),o=n.withJsdocs&&"boolean"!=typeof e&&e.description?cN(e.description):"";if("cjs"===t?(i=`${o}module.exports = ${r?`{ ${JSON.stringify(r)}: ${i} }`:i}
`,s||(i=`${o}const { z } = require("zod")

${i}`)):"esm"===t?(i=`${o}export ${r?`const ${r} =`:"default"} ${i}
`,s||(i=`import { z } from "zod"

${i}`)):r&&(i=`${o}const ${r} = ${i}`),a&&r){let e="string"==typeof a?a:`${r[0].toUpperCase()}${r.substring(1)}`;i+=`export type ${e} = z.infer<typeof ${r}>
`}return i})(e,{...t,parserOverride:cB}).replace(/\.reduce<[^>]+>/g,".reduce")}(o),Function("z",`"use strict";return (${n});`)(sg))),i="id"in a?a.id:a.description?`tool-${s=a.description,(0,cz.createHash)("sha256").update(s).digest("hex").slice(0,8)}`:`tool-${Math.random().toString(36).substring(2,9)}`,{...a,id:i,inputSchema:e})}else t[r]=a}return t},{})}function v2(e,t,r,a){return new vY({originalTool:e,options:t,logType:r,autoResumeSuspendedTools:a}).build()}var v3=e=>Object.fromEntries(Object.entries(e).filter(([e,t])=>void 0!==t)),v5=eL;function v4(e){return e?{inputTokens:e.promptTokens,outputTokens:e.completionTokens}:{}}var v6=class extends v5.MastraBase{#e;#t;#r;constructor({model:e,mastra:t,options:r}){super({name:"aisdk"}),this.#e=e,this.#r=r,t&&(this.#t=t,t.getLogger()&&this.__setLogger(this.#t.getLogger()))}__registerPrimitives(e){e.logger&&this.__setLogger(e.logger)}__registerMastra(e){this.#t=e}getProvider(){return this.#e.provider}getModelId(){return this.#e.modelId}getModel(){return this.#e}_applySchemaCompat(e){let t=this.#e,r=[];if(t){let e={modelId:t.modelId,supportsStructuredOutputs:t.supportsStructuredOutputs??!1,provider:t.provider};r.push(new vH(e),new vJ(e),new vW(e),new vK(e),new vG(e),new vQ(e))}return vS({schema:e,compatLayers:r,mode:"aiSdkSchema"})}async __text({runId:e,messages:t,maxSteps:r=5,tools:a={},temperature:s,toolChoice:n="auto",onStepFinish:i,experimental_output:o,threadId:l,resourceId:u,requestContext:p,tracingContext:d,...c}){let m,g=this.#e;this.logger.debug("[LLM] - Generating text",{runId:e,messages:t,maxSteps:r,threadId:l,resourceId:u,tools:Object.keys(a)}),o&&(this.logger.debug("[LLM] - Using experimental output",{runId:e}),v0(o)?(p6(m=o)&&(m=p9(m).type),m=fY(mh(m,"jsonSchema7"))):m=fY(o));let h=d.currentSpan?.createChildSpan({name:`llm: '${g.modelId}'`,type:"model_generation",input:{messages:t,schema:m},attributes:{model:g.modelId,provider:g.provider,parameters:{temperature:s,maxOutputTokens:c.maxTokens,topP:c.topP,frequencyPenalty:c.frequencyPenalty,presencePenalty:c.presencePenalty},streaming:!1},metadata:{runId:e,threadId:l,resourceId:u},tracingPolicy:this.#r?.tracingPolicy}),f={...c,messages:t,model:g,temperature:s,tools:{...a},toolChoice:n,maxSteps:r,onStepFinish:async t=>{try{await i?.({...t,runId:e})}catch(r){throw new eN.MastraError({id:"LLM_TEXT_ON_STEP_FINISH_CALLBACK_EXECUTION_FAILED",domain:"LLM",category:"USER",details:{modelId:g.modelId,modelProvider:g.provider,runId:e??"unknown",threadId:l??"unknown",resourceId:u??"unknown",finishReason:t?.finishReason,toolCalls:t?.toolCalls?JSON.stringify(t.toolCalls):"",toolResults:t?.toolResults?JSON.stringify(t.toolResults):"",usage:t?.usage?JSON.stringify(t.usage):""}},r)}this.logger.debug("[LLM] - Text Step Change:",{text:t?.text,toolCalls:t?.toolCalls,toolResults:t?.toolResults,finishReason:t?.finishReason,usage:t?.usage,runId:e});let r=parseInt(t?.response?.headers?.["x-ratelimit-remaining-tokens"]??"",10);!isNaN(r)&&r>0&&r<2e3&&(this.logger.warn("Rate limit approaching, waiting 10 seconds",{runId:e}),await vX(1e4))},experimental_output:m?l_.object({schema:m}):void 0};try{let e=await pJ({span:h,fn:()=>ly(f)});return m&&"stop"===e.finishReason&&(e.object=e.experimental_output),h?.end({output:{text:e.text,object:e.object,reasoning:e.reasoningDetails,reasoningText:e.reasoning,files:e.files,sources:e.sources,warnings:e.warnings},attributes:{finishReason:e.finishReason,usage:v4(e.usage)}}),e}catch(r){let t=new eN.MastraError({id:"LLM_GENERATE_TEXT_AI_SDK_EXECUTION_FAILED",domain:"LLM",category:"THIRD_PARTY",details:{modelId:g.modelId,modelProvider:g.provider,runId:e??"unknown",threadId:l??"unknown",resourceId:u??"unknown"}},r);throw h?.error({error:t}),t}}async __textObject({messages:e,structuredOutput:t,runId:r,threadId:a,resourceId:s,requestContext:n,tracingContext:i,...o}){let l=this.#e;this.logger.debug("[LLM] - Generating a text object",{runId:r});let u=i.currentSpan?.createChildSpan({name:`llm: '${l.modelId}'`,type:"model_generation",input:{messages:e},attributes:{model:l.modelId,provider:l.provider,parameters:{temperature:o.temperature,maxOutputTokens:o.maxTokens,topP:o.topP,frequencyPenalty:o.frequencyPenalty,presencePenalty:o.presencePenalty},streaming:!1},metadata:{runId:r,threadId:a,resourceId:s},tracingPolicy:this.#r?.tracingPolicy});try{let n="object";p6(t)&&(n="array",t=p9(t).type);let i=this._applySchemaCompat(t);u?.update({input:{messages:e,schema:i}});let p={...o,messages:e,model:l,output:n,schema:i};try{let e=await oB(p);return u?.end({output:{object:e.object,warnings:e.warnings},attributes:{finishReason:e.finishReason,usage:v4(e.usage)}}),e}catch(t){let e=new eN.MastraError({id:"LLM_GENERATE_OBJECT_AI_SDK_EXECUTION_FAILED",domain:"LLM",category:"THIRD_PARTY",details:{modelId:l.modelId,modelProvider:l.provider,runId:r??"unknown",threadId:a??"unknown",resourceId:s??"unknown"}},t);throw u?.error({error:e}),e}}catch(t){if(t instanceof eN.MastraError)throw t;let e=new eN.MastraError({id:"LLM_GENERATE_OBJECT_AI_SDK_SCHEMA_CONVERSION_FAILED",domain:"LLM",category:"USER",details:{modelId:l.modelId,modelProvider:l.provider,runId:r??"unknown",threadId:a??"unknown",resourceId:s??"unknown"}},t);throw u?.error({error:e}),e}}__stream({messages:e,onStepFinish:t,onFinish:r,maxSteps:a=5,tools:s={},runId:n,temperature:i,toolChoice:o="auto",experimental_output:l,threadId:u,resourceId:p,requestContext:d,tracingContext:c,...m}){let g,h=this.#e;this.logger.debug("[LLM] - Streaming text",{runId:n,threadId:u,resourceId:p,messages:e,maxSteps:a,tools:Object.keys(s||{})}),l&&(this.logger.debug("[LLM] - Using experimental output",{runId:n}),"function"==typeof l.parse?p6(g=l)&&(g=p9(g).type):g=fY(l));let f=c.currentSpan?.createChildSpan({name:`llm: '${h.modelId}'`,type:"model_generation",input:{messages:e},attributes:{model:h.modelId,provider:h.provider,parameters:{temperature:i,maxOutputTokens:m.maxTokens,topP:m.topP,frequencyPenalty:m.frequencyPenalty,presencePenalty:m.presencePenalty},streaming:!0},metadata:{runId:n,threadId:u,resourceId:p},tracingPolicy:this.#r?.tracingPolicy}),y={model:h,temperature:i,tools:{...s},maxSteps:a,toolChoice:o,onStepFinish:async e=>{try{await t?.({...e,runId:n})}catch(r){let t=new eN.MastraError({id:"LLM_STREAM_ON_STEP_FINISH_CALLBACK_EXECUTION_FAILED",domain:"LLM",category:"USER",details:{modelId:h.modelId,modelProvider:h.provider,runId:n??"unknown",threadId:u??"unknown",resourceId:p??"unknown",finishReason:e?.finishReason,toolCalls:e?.toolCalls?JSON.stringify(e.toolCalls):"",toolResults:e?.toolResults?JSON.stringify(e.toolResults):"",usage:e?.usage?JSON.stringify(e.usage):""}},r);throw this.logger.trackException(t),f?.error({error:t}),t}this.logger.debug("[LLM] - Stream Step Change:",{text:e?.text,toolCalls:e?.toolCalls,toolResults:e?.toolResults,finishReason:e?.finishReason,usage:e?.usage,runId:n});let r=parseInt(e?.response?.headers?.["x-ratelimit-remaining-tokens"]??"",10);!isNaN(r)&&r>0&&r<2e3&&(this.logger.warn("Rate limit approaching, waiting 10 seconds",{runId:n}),await vX(1e4))},onFinish:async e=>{f?.end({output:{text:e?.text,reasoning:e?.reasoningDetails,reasoningText:e?.reasoning,files:e?.files,sources:e?.sources,warnings:e?.warnings},attributes:{finishReason:e?.finishReason,usage:v4(e?.usage)}});try{await r?.({...e,runId:n})}catch(r){let t=new eN.MastraError({id:"LLM_STREAM_ON_FINISH_CALLBACK_EXECUTION_FAILED",domain:"LLM",category:"USER",details:{modelId:h.modelId,modelProvider:h.provider,runId:n??"unknown",threadId:u??"unknown",resourceId:p??"unknown",finishReason:e?.finishReason,toolCalls:e?.toolCalls?JSON.stringify(e.toolCalls):"",toolResults:e?.toolResults?JSON.stringify(e.toolResults):"",usage:e?.usage?JSON.stringify(e.usage):""}},r);throw f?.error({error:t}),this.logger.trackException(t),t}this.logger.debug("[LLM] - Stream Finished:",{text:e?.text,toolCalls:e?.toolCalls,toolResults:e?.toolResults,finishReason:e?.finishReason,usage:e?.usage,runId:n,threadId:u,resourceId:p})},...m,messages:e,experimental_output:g?l_.object({schema:g}):void 0};try{return pH({span:f,fn:()=>(function({model:e,tools:t,toolChoice:r,system:a,prompt:s,messages:n,maxRetries:i,abortSignal:o,headers:l,maxSteps:u=1,experimental_generateMessageId:p=lP,experimental_output:d,experimental_continueSteps:c=!1,experimental_telemetry:m,experimental_providerMetadata:g,providerOptions:h=g,experimental_toolCallStreaming:f=!1,toolCallStreaming:y=f,experimental_activeTools:v,experimental_repairToolCall:b,experimental_transform:w,onChunk:k,onError:_,onFinish:I,onStepFinish:S,_internal:{now:x=oQ,generateId:T=lM,currentDate:E=()=>new Date}={},...A}){if("string"==typeof e||"v1"!==e.specificationVersion)throw new iO;return new lR({model:e,telemetry:m,headers:l,settings:A,maxRetries:i,abortSignal:o,system:a,prompt:s,messages:n,tools:t,toolChoice:r,toolCallStreaming:y,transforms:void 0===w?[]:Array.isArray(w)?w:[w],activeTools:v,repairToolCall:b,maxSteps:u,output:d,continueSteps:c,providerOptions:h,onChunk:k,onError:_,onFinish:I,onStepFinish:S,now:x,currentDate:E,generateId:T,generateMessageId:p})})(y)})}catch(t){let e=new eN.MastraError({id:"LLM_STREAM_TEXT_AI_SDK_EXECUTION_FAILED",domain:"LLM",category:"THIRD_PARTY",details:{modelId:h.modelId,modelProvider:h.provider,runId:n??"unknown",threadId:u??"unknown",resourceId:p??"unknown"}},t);throw f?.error({error:e}),e}}__streamObject({messages:e,runId:t,requestContext:r,threadId:a,resourceId:s,onFinish:n,structuredOutput:i,tracingContext:o,...l}){let u=this.#e;this.logger.debug("[LLM] - Streaming structured output",{runId:t,messages:e});let p=o.currentSpan?.createChildSpan({name:`llm: '${u.modelId}'`,type:"model_generation",input:{messages:e},attributes:{model:u.modelId,provider:u.provider,parameters:{temperature:l.temperature,maxOutputTokens:l.maxTokens,topP:l.topP,frequencyPenalty:l.frequencyPenalty,presencePenalty:l.presencePenalty},streaming:!0},metadata:{runId:t,threadId:a,resourceId:s},tracingPolicy:this.#r?.tracingPolicy});try{let r="object";p6(i)&&(r="array",i=p9(i).type);let o=this._applySchemaCompat(i);p?.update({input:{messages:e,schema:o}});let d={...l,model:u,onFinish:async e=>{p?.end({output:{text:e?.text,object:e?.object,reasoning:e?.reasoningDetails,reasoningText:e?.reasoning,files:e?.files,sources:e?.sources,warnings:e?.warnings},attributes:{finishReason:e?.finishReason,usage:e?.usage}});try{await n?.({...e,runId:t})}catch(n){let r=new eN.MastraError({id:"LLM_STREAM_OBJECT_ON_FINISH_CALLBACK_EXECUTION_FAILED",domain:"LLM",category:"USER",details:{modelId:u.modelId,modelProvider:u.provider,runId:t??"unknown",threadId:a??"unknown",resourceId:s??"unknown",toolCalls:"",toolResults:"",finishReason:"",usage:e?.usage?JSON.stringify(e.usage):""}},n);throw this.logger.trackException(r),p?.error({error:r}),r}this.logger.debug("[LLM] - Object Stream Finished:",{usage:e?.usage,runId:t,threadId:a,resourceId:s})},messages:e,output:r,schema:o};try{return function({model:e,schema:t,schemaName:r,schemaDescription:a,mode:s,output:n="object",system:i,prompt:o,messages:l,maxRetries:u,abortSignal:p,headers:d,experimental_telemetry:c,experimental_providerMetadata:m,providerOptions:g=m,onError:h,onFinish:f,_internal:{generateId:y=oJ,currentDate:v=()=>new Date,now:b=oQ}={},...w}){if("string"==typeof e||"v1"!==e.specificationVersion)throw new iO;o$({output:n,mode:s,schema:t,schemaName:r,schemaDescription:a});let k=oq({output:n,schema:t});return"no-schema"===k.type&&void 0===s&&(s="json"),new oH({model:e,telemetry:c,headers:d,settings:w,maxRetries:u,abortSignal:p,outputStrategy:k,system:i,prompt:o,messages:l,schemaName:r,schemaDescription:a,providerOptions:g,mode:s,onError:h,onFinish:f,generateId:y,currentDate:v,now:b})}(d)}catch(r){let e=new eN.MastraError({id:"LLM_STREAM_OBJECT_AI_SDK_EXECUTION_FAILED",domain:"LLM",category:"THIRD_PARTY",details:{modelId:u.modelId,modelProvider:u.provider,runId:t??"unknown",threadId:a??"unknown",resourceId:s??"unknown"}},r);throw p?.error({error:e}),e}}catch(r){if(r instanceof eN.MastraError)throw p?.error({error:r}),r;let e=new eN.MastraError({id:"LLM_STREAM_OBJECT_AI_SDK_SCHEMA_CONVERSION_FAILED",domain:"LLM",category:"USER",details:{modelId:u.modelId,modelProvider:u.provider,runId:t??"unknown",threadId:a??"unknown",resourceId:s??"unknown"}},r);throw p?.error({error:e}),e}}convertToMessages(e){return Array.isArray(e)?e.map(e=>"string"==typeof e?{role:"user",content:e}:e):[{role:"user",content:e}]}async generate(e,{output:t,...r}){let a=this.convertToMessages(e);if(!t){let{maxSteps:e,onStepFinish:t,...s}=r;return await this.__text({messages:a,maxSteps:e,onStepFinish:t,...s})}return await this.__textObject({messages:a,structuredOutput:t,...r})}stream(e,{maxSteps:t=5,output:r,onFinish:a,...s}){let n=this.convertToMessages(e);return r?this.__streamObject({messages:n,structuredOutput:r,onFinish:a,...s}):this.__stream({messages:n,maxSteps:t,onFinish:a,...s})}};function v7(e){return new ReadableStream({start(t){for(let r of(t.enqueue({type:"stream-start",warnings:e.warnings}),t.enqueue({type:"response-metadata",id:e.response?.id,modelId:e.response?.modelId,timestamp:e.response?.timestamp}),e.content))if("tool-call"===r.type)t.enqueue({type:"tool-input-start",id:r.toolCallId,toolName:r.toolName}),t.enqueue({type:"tool-input-delta",id:r.toolCallId,delta:r.input}),t.enqueue({type:"tool-input-end",id:r.toolCallId}),t.enqueue(r);else if("tool-result"===r.type)t.enqueue(r);else if("text"===r.type){let e=`msg_${(0,cz.randomUUID)()}`;t.enqueue({type:"text-start",id:e,providerMetadata:r.providerMetadata}),t.enqueue({type:"text-delta",id:e,delta:r.text}),t.enqueue({type:"text-end",id:e})}else if("reasoning"===r.type){let e=`reasoning_${(0,cz.randomUUID)()}`;t.enqueue({type:"reasoning-start",id:e,providerMetadata:r.providerMetadata}),t.enqueue({type:"reasoning-delta",id:e,delta:r.text,providerMetadata:r.providerMetadata}),t.enqueue({type:"reasoning-end",id:e,providerMetadata:r.providerMetadata})}else"file"===r.type?t.enqueue({type:"file",mediaType:r.mediaType,data:r.data}):"source"===r.type&&("url"===r.sourceType?t.enqueue({type:"source",id:r.id,sourceType:"url",url:r.url,title:r.title,providerMetadata:r.providerMetadata}):t.enqueue({type:"source",id:r.id,sourceType:"document",mediaType:r.mediaType,filename:r.filename,title:r.title,providerMetadata:r.providerMetadata}));t.enqueue({type:"finish",finishReason:e.finishReason,usage:e.usage,providerMetadata:e.providerMetadata}),t.close()}})}var v9=class{specificationVersion="v2";provider;modelId;supportedUrls;#e;constructor(e){this.#e=e,this.provider=this.#e.provider,this.modelId=this.#e.modelId,this.supportedUrls=this.#e.supportedUrls}async doGenerate(e){let t=await this.#e.doGenerate(e);return{request:t.request,response:t.response,stream:v7(t)}}async doStream(e){return await this.#e.doStream(e)}},v8=(e.i(665778),class{specificationVersion="v3";provider;modelId;supportedUrls;#e;constructor(e){this.#e=e,this.provider=this.#e.provider,this.modelId=this.#e.modelId,this.supportedUrls=this.#e.supportedUrls}async doGenerate(e){let t=await this.#e.doGenerate(e);return{request:t.request,response:t.response,stream:v7(t)}}async doStream(e){return await this.#e.doStream(e)}}),be=eU.z.object({error:eU.z.object({message:eU.z.string(),type:eU.z.string().nullish(),param:eU.z.any().nullish(),code:eU.z.union([eU.z.string(),eU.z.number()]).nullish()})}),bt=(0,cy.createJsonErrorResponseHandler)({errorSchema:be,errorToMessage:e=>e.error.message});function br({id:e,model:t,created:r}){return{id:null!=e?e:void 0,modelId:null!=t?t:void 0,timestamp:r?new Date(1e3*r):void 0}}function ba(e){switch(e){case"stop":return"stop";case"length":return"length";case"content_filter":return"content-filter";case"function_call":case"tool_calls":return"tool-calls";default:return"unknown"}}var bs=(0,cy.lazyValidator)(()=>(0,cy.zodSchema)(eU.z.object({id:eU.z.string().nullish(),created:eU.z.number().nullish(),model:eU.z.string().nullish(),choices:eU.z.array(eU.z.object({message:eU.z.object({role:eU.z.literal("assistant").nullish(),content:eU.z.string().nullish(),tool_calls:eU.z.array(eU.z.object({id:eU.z.string().nullish(),type:eU.z.literal("function"),function:eU.z.object({name:eU.z.string(),arguments:eU.z.string()})})).nullish(),annotations:eU.z.array(eU.z.object({type:eU.z.literal("url_citation"),start_index:eU.z.number(),end_index:eU.z.number(),url:eU.z.string(),title:eU.z.string()})).nullish()}),index:eU.z.number(),logprobs:eU.z.object({content:eU.z.array(eU.z.object({token:eU.z.string(),logprob:eU.z.number(),top_logprobs:eU.z.array(eU.z.object({token:eU.z.string(),logprob:eU.z.number()}))})).nullish()}).nullish(),finish_reason:eU.z.string().nullish()})),usage:eU.z.object({prompt_tokens:eU.z.number().nullish(),completion_tokens:eU.z.number().nullish(),total_tokens:eU.z.number().nullish(),prompt_tokens_details:eU.z.object({cached_tokens:eU.z.number().nullish()}).nullish(),completion_tokens_details:eU.z.object({reasoning_tokens:eU.z.number().nullish(),accepted_prediction_tokens:eU.z.number().nullish(),rejected_prediction_tokens:eU.z.number().nullish()}).nullish()}).nullish()}))),bn=(0,cy.lazyValidator)(()=>(0,cy.zodSchema)(eU.z.union([eU.z.object({id:eU.z.string().nullish(),created:eU.z.number().nullish(),model:eU.z.string().nullish(),choices:eU.z.array(eU.z.object({delta:eU.z.object({role:eU.z.enum(["assistant"]).nullish(),content:eU.z.string().nullish(),tool_calls:eU.z.array(eU.z.object({index:eU.z.number(),id:eU.z.string().nullish(),type:eU.z.literal("function").nullish(),function:eU.z.object({name:eU.z.string().nullish(),arguments:eU.z.string().nullish()})})).nullish(),annotations:eU.z.array(eU.z.object({type:eU.z.literal("url_citation"),start_index:eU.z.number(),end_index:eU.z.number(),url:eU.z.string(),title:eU.z.string()})).nullish()}).nullish(),logprobs:eU.z.object({content:eU.z.array(eU.z.object({token:eU.z.string(),logprob:eU.z.number(),top_logprobs:eU.z.array(eU.z.object({token:eU.z.string(),logprob:eU.z.number()}))})).nullish()}).nullish(),finish_reason:eU.z.string().nullish(),index:eU.z.number()})),usage:eU.z.object({prompt_tokens:eU.z.number().nullish(),completion_tokens:eU.z.number().nullish(),total_tokens:eU.z.number().nullish(),prompt_tokens_details:eU.z.object({cached_tokens:eU.z.number().nullish()}).nullish(),completion_tokens_details:eU.z.object({reasoning_tokens:eU.z.number().nullish(),accepted_prediction_tokens:eU.z.number().nullish(),rejected_prediction_tokens:eU.z.number().nullish()}).nullish()}).nullish()}),be]))),bi=(0,cy.lazyValidator)(()=>(0,cy.zodSchema)(eU.z.object({logitBias:eU.z.record(eU.z.coerce.number(),eU.z.number()).optional(),logprobs:eU.z.union([eU.z.boolean(),eU.z.number()]).optional(),parallelToolCalls:eU.z.boolean().optional(),user:eU.z.string().optional(),reasoningEffort:eU.z.enum(["none","minimal","low","medium","high"]).optional(),maxCompletionTokens:eU.z.number().optional(),store:eU.z.boolean().optional(),metadata:eU.z.record(eU.z.string().max(64),eU.z.string().max(512)).optional(),prediction:eU.z.record(eU.z.string(),eU.z.any()).optional(),structuredOutputs:eU.z.boolean().optional(),serviceTier:eU.z.enum(["auto","flex","priority","default"]).optional(),strictJsonSchema:eU.z.boolean().optional(),textVerbosity:eU.z.enum(["low","medium","high"]).optional(),promptCacheKey:eU.z.string().optional(),promptCacheRetention:eU.z.enum(["in_memory","24h"]).optional(),safetyIdentifier:eU.z.string().optional()}))),bo=class{constructor(e,t){this.specificationVersion="v2",this.supportedUrls={"image/*":[/^https?:\/\/.*$/]},this.modelId=e,this.config=t}get provider(){return this.config.provider}async getArgs({prompt:e,maxOutputTokens:t,temperature:r,topP:a,topK:s,frequencyPenalty:n,presencePenalty:i,stopSequences:o,responseFormat:l,seed:u,tools:p,toolChoice:d,providerOptions:c}){var m,g,h,f,y,v,b,w,k;let _=[],I=null!=(m=await (0,cy.parseProviderOptions)({provider:"openai",providerOptions:c,schema:bi}))?m:{},S=null==(g=I.structuredOutputs)||g;null!=s&&_.push({type:"unsupported-setting",setting:"topK"}),(null==l?void 0:l.type)!=="json"||null==l.schema||S||_.push({type:"unsupported-setting",setting:"responseFormat",details:"JSON response format schema is only supported with structuredOutputs"});let{messages:x,warnings:T}=function({prompt:e,systemMessageMode:t="system"}){let r=[],a=[];for(let{role:s,content:n}of e)switch(s){case"system":switch(t){case"system":r.push({role:"system",content:n});break;case"developer":r.push({role:"developer",content:n});break;case"remove":a.push({type:"other",message:"system messages are removed for this model"});break;default:throw Error(`Unsupported system message mode: ${t}`)}break;case"user":if(1===n.length&&"text"===n[0].type){r.push({role:"user",content:n[0].text});break}r.push({role:"user",content:n.map((e,t)=>{var r,a,s;switch(e.type){case"text":return{type:"text",text:e.text};case"file":if(e.mediaType.startsWith("image/")){let t="image/*"===e.mediaType?"image/jpeg":e.mediaType;return{type:"image_url",image_url:{url:e.data instanceof URL?e.data.toString():`data:${t};base64,${(0,cy.convertToBase64)(e.data)}`,detail:null==(a=null==(r=e.providerOptions)?void 0:r.openai)?void 0:a.imageDetail}}}if(e.mediaType.startsWith("audio/")){if(e.data instanceof URL)throw new cy.UnsupportedFunctionalityError({functionality:"audio file parts with URLs"});switch(e.mediaType){case"audio/wav":return{type:"input_audio",input_audio:{data:(0,cy.convertToBase64)(e.data),format:"wav"}};case"audio/mp3":case"audio/mpeg":return{type:"input_audio",input_audio:{data:(0,cy.convertToBase64)(e.data),format:"mp3"}};default:throw new cy.UnsupportedFunctionalityError({functionality:`audio content parts with media type ${e.mediaType}`})}}if("application/pdf"===e.mediaType){if(e.data instanceof URL)throw new cy.UnsupportedFunctionalityError({functionality:"PDF file parts with URLs"});return{type:"file",file:"string"==typeof e.data&&e.data.startsWith("file-")?{file_id:e.data}:{filename:null!=(s=e.filename)?s:`part-${t}.pdf`,file_data:`data:application/pdf;base64,${(0,cy.convertToBase64)(e.data)}`}}}else throw new cy.UnsupportedFunctionalityError({functionality:`file part media type ${e.mediaType}`})}})});break;case"assistant":{let e="",t=[];for(let r of n)switch(r.type){case"text":e+=r.text;break;case"tool-call":t.push({id:r.toolCallId,type:"function",function:{name:r.toolName,arguments:JSON.stringify(r.input)}})}r.push({role:"assistant",content:e,tool_calls:t.length>0?t:void 0});break}case"tool":for(let e of n){let t,a=e.output;switch(a.type){case"text":case"error-text":t=a.value;break;case"content":case"json":case"error-json":t=JSON.stringify(a.value)}r.push({role:"tool",tool_call_id:e.toolCallId,content:t})}break;default:throw Error(`Unsupported role: ${s}`)}return{messages:r,warnings:a}}({prompt:e,systemMessageMode:bl(y=this.modelId)?null!=(b=null==(v=bu[y])?void 0:v.systemMessageMode)?b:"developer":"system"});_.push(...T);let E=null!=(h=I.strictJsonSchema)&&h,A={model:this.modelId,logit_bias:I.logitBias,logprobs:!0===I.logprobs||"number"==typeof I.logprobs||void 0,top_logprobs:"number"==typeof I.logprobs?I.logprobs:"boolean"==typeof I.logprobs&&I.logprobs?0:void 0,user:I.user,parallel_tool_calls:I.parallelToolCalls,max_tokens:t,temperature:r,top_p:a,frequency_penalty:n,presence_penalty:i,response_format:(null==l?void 0:l.type)==="json"?S&&null!=l.schema?{type:"json_schema",json_schema:{schema:l.schema,strict:E,name:null!=(f=l.name)?f:"response",description:l.description}}:{type:"json_object"}:void 0,stop:o,seed:u,verbosity:I.textVerbosity,max_completion_tokens:I.maxCompletionTokens,store:I.store,metadata:I.metadata,prediction:I.prediction,reasoning_effort:I.reasoningEffort,service_tier:I.serviceTier,prompt_cache_key:I.promptCacheKey,prompt_cache_retention:I.promptCacheRetention,safety_identifier:I.safetyIdentifier,messages:x};bl(this.modelId)?(null!=A.temperature&&(A.temperature=void 0,_.push({type:"unsupported-setting",setting:"temperature",details:"temperature is not supported for reasoning models"})),null!=A.top_p&&(A.top_p=void 0,_.push({type:"unsupported-setting",setting:"topP",details:"topP is not supported for reasoning models"})),null!=A.frequency_penalty&&(A.frequency_penalty=void 0,_.push({type:"unsupported-setting",setting:"frequencyPenalty",details:"frequencyPenalty is not supported for reasoning models"})),null!=A.presence_penalty&&(A.presence_penalty=void 0,_.push({type:"unsupported-setting",setting:"presencePenalty",details:"presencePenalty is not supported for reasoning models"})),null!=A.logit_bias&&(A.logit_bias=void 0,_.push({type:"other",message:"logitBias is not supported for reasoning models"})),null!=A.logprobs&&(A.logprobs=void 0,_.push({type:"other",message:"logprobs is not supported for reasoning models"})),null!=A.top_logprobs&&(A.top_logprobs=void 0,_.push({type:"other",message:"topLogprobs is not supported for reasoning models"})),null!=A.max_tokens&&(null==A.max_completion_tokens&&(A.max_completion_tokens=A.max_tokens),A.max_tokens=void 0)):(this.modelId.startsWith("gpt-4o-search-preview")||this.modelId.startsWith("gpt-4o-mini-search-preview"))&&null!=A.temperature&&(A.temperature=void 0,_.push({type:"unsupported-setting",setting:"temperature",details:"temperature is not supported for the search preview models and has been removed."})),"flex"!==I.serviceTier||(w=this.modelId).startsWith("o3")||w.startsWith("o4-mini")||w.startsWith("gpt-5")&&!w.startsWith("gpt-5-chat")||(_.push({type:"unsupported-setting",setting:"serviceTier",details:"flex processing is only available for o3, o4-mini, and gpt-5 models"}),A.service_tier=void 0),"priority"!==I.serviceTier||(k=this.modelId).startsWith("gpt-4")||k.startsWith("gpt-5-mini")||k.startsWith("gpt-5")&&!k.startsWith("gpt-5-nano")&&!k.startsWith("gpt-5-chat")||k.startsWith("o3")||k.startsWith("o4-mini")||(_.push({type:"unsupported-setting",setting:"serviceTier",details:"priority processing is only available for supported models (gpt-4, gpt-5, gpt-5-mini, o3, o4-mini) and requires Enterprise access. gpt-5-nano is not supported"}),A.service_tier=void 0);let{tools:O,toolChoice:z,toolWarnings:M}=function({tools:e,toolChoice:t,structuredOutputs:r,strictJsonSchema:a}){e=(null==e?void 0:e.length)?e:void 0;let s=[];if(null==e)return{tools:void 0,toolChoice:void 0,toolWarnings:s};let n=[];for(let t of e)"function"===t.type?n.push({type:"function",function:{name:t.name,description:t.description,parameters:t.inputSchema,strict:r?a:void 0}}):s.push({type:"unsupported-tool",tool:t});if(null==t)return{tools:n,toolChoice:void 0,toolWarnings:s};let i=t.type;switch(i){case"auto":case"none":case"required":return{tools:n,toolChoice:i,toolWarnings:s};case"tool":return{tools:n,toolChoice:{type:"function",function:{name:t.toolName}},toolWarnings:s};default:throw new cy.UnsupportedFunctionalityError({functionality:`tool choice type: ${i}`})}}({tools:p,toolChoice:d,structuredOutputs:S,strictJsonSchema:E});return{args:{...A,tools:O,tool_choice:z},warnings:[..._,...M]}}async doGenerate(e){var t,r,a,s,n,i,o,l,u,p,d,c,m,g;let{args:h,warnings:f}=await this.getArgs(e),{responseHeaders:y,value:v,rawValue:b}=await (0,cy.postJsonToApi)({url:this.config.url({path:"/chat/completions",modelId:this.modelId}),headers:(0,cy.combineHeaders)(this.config.headers(),e.headers),body:h,failedResponseHandler:bt,successfulResponseHandler:(0,cy.createJsonResponseHandler)(bs),abortSignal:e.abortSignal,fetch:this.config.fetch}),w=v.choices[0],k=[],_=w.message.content;for(let e of(null!=_&&_.length>0&&k.push({type:"text",text:_}),null!=(t=w.message.tool_calls)?t:[]))k.push({type:"tool-call",toolCallId:null!=(r=e.id)?r:(0,cy.generateId)(),toolName:e.function.name,input:e.function.arguments});for(let e of null!=(a=w.message.annotations)?a:[])k.push({type:"source",sourceType:"url",id:(0,cy.generateId)(),url:e.url,title:e.title});let I=null==(s=v.usage)?void 0:s.completion_tokens_details,S=null==(n=v.usage)?void 0:n.prompt_tokens_details,x={openai:{}};return(null==I?void 0:I.accepted_prediction_tokens)!=null&&(x.openai.acceptedPredictionTokens=null==I?void 0:I.accepted_prediction_tokens),(null==I?void 0:I.rejected_prediction_tokens)!=null&&(x.openai.rejectedPredictionTokens=null==I?void 0:I.rejected_prediction_tokens),(null==(i=w.logprobs)?void 0:i.content)!=null&&(x.openai.logprobs=w.logprobs.content),{content:k,finishReason:ba(w.finish_reason),usage:{inputTokens:null!=(l=null==(o=v.usage)?void 0:o.prompt_tokens)?l:void 0,outputTokens:null!=(p=null==(u=v.usage)?void 0:u.completion_tokens)?p:void 0,totalTokens:null!=(c=null==(d=v.usage)?void 0:d.total_tokens)?c:void 0,reasoningTokens:null!=(m=null==I?void 0:I.reasoning_tokens)?m:void 0,cachedInputTokens:null!=(g=null==S?void 0:S.cached_tokens)?g:void 0},request:{body:h},response:{...br(v),headers:y,body:b},warnings:f,providerMetadata:x}}async doStream(e){let{args:t,warnings:r}=await this.getArgs(e),a={...t,stream:!0,stream_options:{include_usage:!0}},{responseHeaders:s,value:n}=await (0,cy.postJsonToApi)({url:this.config.url({path:"/chat/completions",modelId:this.modelId}),headers:(0,cy.combineHeaders)(this.config.headers(),e.headers),body:a,failedResponseHandler:bt,successfulResponseHandler:(0,cy.createEventSourceResponseHandler)(bn),abortSignal:e.abortSignal,fetch:this.config.fetch}),i=[],o="unknown",l={inputTokens:void 0,outputTokens:void 0,totalTokens:void 0},u=!1,p=!1,d={openai:{}};return{stream:n.pipeThrough(new TransformStream({start(e){e.enqueue({type:"stream-start",warnings:r})},transform(t,r){var a,s,n,c,m,g,h,f,y,v,b,w,k,_,I,S,x,T,E,A,O,z,M,P;if(e.includeRawChunks&&r.enqueue({type:"raw",rawValue:t.rawValue}),!t.success){o="error",r.enqueue({type:"error",error:t.error});return}let R=t.value;if("error"in R){o="error",r.enqueue({type:"error",error:R.error});return}!u&&Object.values(br(R)).some(Boolean)&&(u=!0,r.enqueue({type:"response-metadata",...br(R)})),null!=R.usage&&(l.inputTokens=null!=(a=R.usage.prompt_tokens)?a:void 0,l.outputTokens=null!=(s=R.usage.completion_tokens)?s:void 0,l.totalTokens=null!=(n=R.usage.total_tokens)?n:void 0,l.reasoningTokens=null!=(m=null==(c=R.usage.completion_tokens_details)?void 0:c.reasoning_tokens)?m:void 0,l.cachedInputTokens=null!=(h=null==(g=R.usage.prompt_tokens_details)?void 0:g.cached_tokens)?h:void 0,(null==(f=R.usage.completion_tokens_details)?void 0:f.accepted_prediction_tokens)!=null&&(d.openai.acceptedPredictionTokens=null==(y=R.usage.completion_tokens_details)?void 0:y.accepted_prediction_tokens),(null==(v=R.usage.completion_tokens_details)?void 0:v.rejected_prediction_tokens)!=null&&(d.openai.rejectedPredictionTokens=null==(b=R.usage.completion_tokens_details)?void 0:b.rejected_prediction_tokens));let C=R.choices[0];if((null==C?void 0:C.finish_reason)!=null&&(o=ba(C.finish_reason)),(null==(w=null==C?void 0:C.logprobs)?void 0:w.content)!=null&&(d.openai.logprobs=C.logprobs.content),(null==C?void 0:C.delta)==null)return;let j=C.delta;if(null!=j.content&&(p||(r.enqueue({type:"text-start",id:"0"}),p=!0),r.enqueue({type:"text-delta",id:"0",delta:j.content})),null!=j.tool_calls)for(let e of j.tool_calls){let t=e.index;if(null==i[t]){if("function"!==e.type)throw new cy.InvalidResponseDataError({data:e,message:"Expected 'function' type."});if(null==e.id)throw new cy.InvalidResponseDataError({data:e,message:"Expected 'id' to be a string."});if((null==(k=e.function)?void 0:k.name)==null)throw new cy.InvalidResponseDataError({data:e,message:"Expected 'function.name' to be a string."});r.enqueue({type:"tool-input-start",id:e.id,toolName:e.function.name}),i[t]={id:e.id,type:"function",function:{name:e.function.name,arguments:null!=(_=e.function.arguments)?_:""},hasFinished:!1};let a=i[t];(null==(I=a.function)?void 0:I.name)!=null&&(null==(S=a.function)?void 0:S.arguments)!=null&&(a.function.arguments.length>0&&r.enqueue({type:"tool-input-delta",id:a.id,delta:a.function.arguments}),(0,cy.isParsableJson)(a.function.arguments)&&(r.enqueue({type:"tool-input-end",id:a.id}),r.enqueue({type:"tool-call",toolCallId:null!=(x=a.id)?x:(0,cy.generateId)(),toolName:a.function.name,input:a.function.arguments}),a.hasFinished=!0));continue}let a=i[t];!a.hasFinished&&((null==(T=e.function)?void 0:T.arguments)!=null&&(a.function.arguments+=null!=(A=null==(E=e.function)?void 0:E.arguments)?A:""),r.enqueue({type:"tool-input-delta",id:a.id,delta:null!=(O=e.function.arguments)?O:""}),(null==(z=a.function)?void 0:z.name)!=null&&(null==(M=a.function)?void 0:M.arguments)!=null&&(0,cy.isParsableJson)(a.function.arguments)&&(r.enqueue({type:"tool-input-end",id:a.id}),r.enqueue({type:"tool-call",toolCallId:null!=(P=a.id)?P:(0,cy.generateId)(),toolName:a.function.name,input:a.function.arguments}),a.hasFinished=!0))}if(null!=j.annotations)for(let e of j.annotations)r.enqueue({type:"source",sourceType:"url",id:(0,cy.generateId)(),url:e.url,title:e.title})},flush(e){p&&e.enqueue({type:"text-end",id:"0"}),e.enqueue({type:"finish",finishReason:o,usage:l,...null!=d?{providerMetadata:d}:{}})}})),request:{body:a},response:{headers:s}}}};function bl(e){return(e.startsWith("o")||e.startsWith("gpt-5"))&&!e.startsWith("gpt-5-chat")}var bu={o3:{systemMessageMode:"developer"},"o3-2025-04-16":{systemMessageMode:"developer"},"o3-mini":{systemMessageMode:"developer"},"o3-mini-2025-01-31":{systemMessageMode:"developer"},"o4-mini":{systemMessageMode:"developer"},"o4-mini-2025-04-16":{systemMessageMode:"developer"}};function bp({id:e,model:t,created:r}){return{id:null!=e?e:void 0,modelId:null!=t?t:void 0,timestamp:null!=r?new Date(1e3*r):void 0}}function bd(e){switch(e){case"stop":return"stop";case"length":return"length";case"content_filter":return"content-filter";case"function_call":case"tool_calls":return"tool-calls";default:return"unknown"}}var bc=(0,cy.lazyValidator)(()=>(0,cy.zodSchema)(eU.z.object({id:eU.z.string().nullish(),created:eU.z.number().nullish(),model:eU.z.string().nullish(),choices:eU.z.array(eU.z.object({text:eU.z.string(),finish_reason:eU.z.string(),logprobs:eU.z.object({tokens:eU.z.array(eU.z.string()),token_logprobs:eU.z.array(eU.z.number()),top_logprobs:eU.z.array(eU.z.record(eU.z.string(),eU.z.number())).nullish()}).nullish()})),usage:eU.z.object({prompt_tokens:eU.z.number(),completion_tokens:eU.z.number(),total_tokens:eU.z.number()}).nullish()}))),bm=(0,cy.lazyValidator)(()=>(0,cy.zodSchema)(eU.z.union([eU.z.object({id:eU.z.string().nullish(),created:eU.z.number().nullish(),model:eU.z.string().nullish(),choices:eU.z.array(eU.z.object({text:eU.z.string(),finish_reason:eU.z.string().nullish(),index:eU.z.number(),logprobs:eU.z.object({tokens:eU.z.array(eU.z.string()),token_logprobs:eU.z.array(eU.z.number()),top_logprobs:eU.z.array(eU.z.record(eU.z.string(),eU.z.number())).nullish()}).nullish()})),usage:eU.z.object({prompt_tokens:eU.z.number(),completion_tokens:eU.z.number(),total_tokens:eU.z.number()}).nullish()}),be]))),bg=(0,cy.lazyValidator)(()=>(0,cy.zodSchema)(eU.z.object({echo:eU.z.boolean().optional(),logitBias:eU.z.record(eU.z.string(),eU.z.number()).optional(),suffix:eU.z.string().optional(),user:eU.z.string().optional(),logprobs:eU.z.union([eU.z.boolean(),eU.z.number()]).optional()}))),bh=class{constructor(e,t){this.specificationVersion="v2",this.supportedUrls={},this.modelId=e,this.config=t}get providerOptionsName(){return this.config.provider.split(".")[0].trim()}get provider(){return this.config.provider}async getArgs({prompt:e,maxOutputTokens:t,temperature:r,topP:a,topK:s,frequencyPenalty:n,presencePenalty:i,stopSequences:o,responseFormat:l,tools:u,toolChoice:p,seed:d,providerOptions:c}){let m=[],g={...await (0,cy.parseProviderOptions)({provider:"openai",providerOptions:c,schema:bg}),...await (0,cy.parseProviderOptions)({provider:this.providerOptionsName,providerOptions:c,schema:bg})};null!=s&&m.push({type:"unsupported-setting",setting:"topK"}),(null==u?void 0:u.length)&&m.push({type:"unsupported-setting",setting:"tools"}),null!=p&&m.push({type:"unsupported-setting",setting:"toolChoice"}),null!=l&&"text"!==l.type&&m.push({type:"unsupported-setting",setting:"responseFormat",details:"JSON response format is not supported."});let{prompt:h,stopSequences:f}=function({prompt:e,user:t="user",assistant:r="assistant"}){let a="";for(let{role:s,content:n}of("system"===e[0].role&&(a+=`${e[0].content}

`,e=e.slice(1)),e))switch(s){case"system":throw new cy.InvalidPromptError({message:"Unexpected system message in prompt: ${content}",prompt:e});case"user":{let e=n.map(e=>{if("text"===e.type)return e.text}).filter(Boolean).join("");a+=`${t}:
${e}

`;break}case"assistant":{let e=n.map(e=>{switch(e.type){case"text":return e.text;case"tool-call":throw new cy.UnsupportedFunctionalityError({functionality:"tool-call messages"})}}).join("");a+=`${r}:
${e}

`;break}case"tool":throw new cy.UnsupportedFunctionalityError({functionality:"tool messages"});default:throw Error(`Unsupported role: ${s}`)}return{prompt:a+=`${r}:
`,stopSequences:[`
${t}:`]}}({prompt:e}),y=[...null!=f?f:[],...null!=o?o:[]];return{args:{model:this.modelId,echo:g.echo,logit_bias:g.logitBias,logprobs:(null==g?void 0:g.logprobs)===!0?0:(null==g?void 0:g.logprobs)===!1||null==g?void 0:g.logprobs,suffix:g.suffix,user:g.user,max_tokens:t,temperature:r,top_p:a,frequency_penalty:n,presence_penalty:i,seed:d,prompt:h,stop:y.length>0?y:void 0},warnings:m}}async doGenerate(e){var t,r,a;let{args:s,warnings:n}=await this.getArgs(e),{responseHeaders:i,value:o,rawValue:l}=await (0,cy.postJsonToApi)({url:this.config.url({path:"/completions",modelId:this.modelId}),headers:(0,cy.combineHeaders)(this.config.headers(),e.headers),body:s,failedResponseHandler:bt,successfulResponseHandler:(0,cy.createJsonResponseHandler)(bc),abortSignal:e.abortSignal,fetch:this.config.fetch}),u=o.choices[0],p={openai:{}};return null!=u.logprobs&&(p.openai.logprobs=u.logprobs),{content:[{type:"text",text:u.text}],usage:{inputTokens:null==(t=o.usage)?void 0:t.prompt_tokens,outputTokens:null==(r=o.usage)?void 0:r.completion_tokens,totalTokens:null==(a=o.usage)?void 0:a.total_tokens},finishReason:bd(u.finish_reason),request:{body:s},response:{...bp(o),headers:i,body:l},providerMetadata:p,warnings:n}}async doStream(e){let{args:t,warnings:r}=await this.getArgs(e),a={...t,stream:!0,stream_options:{include_usage:!0}},{responseHeaders:s,value:n}=await (0,cy.postJsonToApi)({url:this.config.url({path:"/completions",modelId:this.modelId}),headers:(0,cy.combineHeaders)(this.config.headers(),e.headers),body:a,failedResponseHandler:bt,successfulResponseHandler:(0,cy.createEventSourceResponseHandler)(bm),abortSignal:e.abortSignal,fetch:this.config.fetch}),i="unknown",o={openai:{}},l={inputTokens:void 0,outputTokens:void 0,totalTokens:void 0},u=!0;return{stream:n.pipeThrough(new TransformStream({start(e){e.enqueue({type:"stream-start",warnings:r})},transform(t,r){if(e.includeRawChunks&&r.enqueue({type:"raw",rawValue:t.rawValue}),!t.success){i="error",r.enqueue({type:"error",error:t.error});return}let a=t.value;if("error"in a){i="error",r.enqueue({type:"error",error:a.error});return}u&&(u=!1,r.enqueue({type:"response-metadata",...bp(a)}),r.enqueue({type:"text-start",id:"0"})),null!=a.usage&&(l.inputTokens=a.usage.prompt_tokens,l.outputTokens=a.usage.completion_tokens,l.totalTokens=a.usage.total_tokens);let s=a.choices[0];(null==s?void 0:s.finish_reason)!=null&&(i=bd(s.finish_reason)),(null==s?void 0:s.logprobs)!=null&&(o.openai.logprobs=s.logprobs),(null==s?void 0:s.text)!=null&&s.text.length>0&&r.enqueue({type:"text-delta",id:"0",delta:s.text})},flush(e){u||e.enqueue({type:"text-end",id:"0"}),e.enqueue({type:"finish",finishReason:i,providerMetadata:o,usage:l})}})),request:{body:a},response:{headers:s}}}},bf=(0,cy.lazyValidator)(()=>(0,cy.zodSchema)(eU.z.object({dimensions:eU.z.number().optional(),user:eU.z.string().optional()}))),by=(0,cy.lazyValidator)(()=>(0,cy.zodSchema)(eU.z.object({data:eU.z.array(eU.z.object({embedding:eU.z.array(eU.z.number())})),usage:eU.z.object({prompt_tokens:eU.z.number()}).nullish()}))),bv=class{constructor(e,t){this.specificationVersion="v2",this.maxEmbeddingsPerCall=2048,this.supportsParallelCalls=!0,this.modelId=e,this.config=t}get provider(){return this.config.provider}async doEmbed({values:e,headers:t,abortSignal:r,providerOptions:a}){var s;if(e.length>this.maxEmbeddingsPerCall)throw new cy.TooManyEmbeddingValuesForCallError({provider:this.provider,modelId:this.modelId,maxEmbeddingsPerCall:this.maxEmbeddingsPerCall,values:e});let n=null!=(s=await (0,cy.parseProviderOptions)({provider:"openai",providerOptions:a,schema:bf}))?s:{},{responseHeaders:i,value:o,rawValue:l}=await (0,cy.postJsonToApi)({url:this.config.url({path:"/embeddings",modelId:this.modelId}),headers:(0,cy.combineHeaders)(this.config.headers(),t),body:{model:this.modelId,input:e,encoding_format:"float",dimensions:n.dimensions,user:n.user},failedResponseHandler:bt,successfulResponseHandler:(0,cy.createJsonResponseHandler)(by),abortSignal:r,fetch:this.config.fetch});return{embeddings:o.data.map(e=>e.embedding),usage:o.usage?{tokens:o.usage.prompt_tokens}:void 0,response:{headers:i,body:l}}}},bb=(0,cy.lazyValidator)(()=>(0,cy.zodSchema)(eU.z.object({data:eU.z.array(eU.z.object({b64_json:eU.z.string(),revised_prompt:eU.z.string().nullish()}))}))),bw={"dall-e-3":1,"dall-e-2":10,"gpt-image-1":10,"gpt-image-1-mini":10},bk=new Set(["gpt-image-1","gpt-image-1-mini"]),b_=class{constructor(e,t){this.modelId=e,this.config=t,this.specificationVersion="v2"}get maxImagesPerCall(){var e;return null!=(e=bw[this.modelId])?e:1}get provider(){return this.config.provider}async doGenerate({prompt:e,n:t,size:r,aspectRatio:a,seed:s,providerOptions:n,headers:i,abortSignal:o}){var l,u,p,d;let c=[];null!=a&&c.push({type:"unsupported-setting",setting:"aspectRatio",details:"This model does not support aspect ratio. Use `size` instead."}),null!=s&&c.push({type:"unsupported-setting",setting:"seed"});let m=null!=(p=null==(u=null==(l=this.config._internal)?void 0:l.currentDate)?void 0:u.call(l))?p:new Date,{value:g,responseHeaders:h}=await (0,cy.postJsonToApi)({url:this.config.url({path:"/images/generations",modelId:this.modelId}),headers:(0,cy.combineHeaders)(this.config.headers(),i),body:{model:this.modelId,prompt:e,n:t,size:r,...null!=(d=n.openai)?d:{},...!bk.has(this.modelId)?{response_format:"b64_json"}:{}},failedResponseHandler:bt,successfulResponseHandler:(0,cy.createJsonResponseHandler)(bb),abortSignal:o,fetch:this.config.fetch});return{images:g.data.map(e=>e.b64_json),warnings:c,response:{timestamp:m,modelId:this.modelId,headers:h},providerMetadata:{openai:{images:g.data.map(e=>e.revised_prompt?{revisedPrompt:e.revised_prompt}:null)}}}}},bI=(0,cy.lazyValidator)(()=>(0,cy.zodSchema)(eU.z.object({text:eU.z.string(),language:eU.z.string().nullish(),duration:eU.z.number().nullish(),words:eU.z.array(eU.z.object({word:eU.z.string(),start:eU.z.number(),end:eU.z.number()})).nullish(),segments:eU.z.array(eU.z.object({id:eU.z.number(),seek:eU.z.number(),start:eU.z.number(),end:eU.z.number(),text:eU.z.string(),tokens:eU.z.array(eU.z.number()),temperature:eU.z.number(),avg_logprob:eU.z.number(),compression_ratio:eU.z.number(),no_speech_prob:eU.z.number()})).nullish()}))),bS=(0,cy.lazyValidator)(()=>(0,cy.zodSchema)(eU.z.object({include:eU.z.array(eU.z.string()).optional(),language:eU.z.string().optional(),prompt:eU.z.string().optional(),temperature:eU.z.number().min(0).max(1).default(0).optional(),timestampGranularities:eU.z.array(eU.z.enum(["word","segment"])).default(["segment"]).optional()}))),bx={afrikaans:"af",arabic:"ar",armenian:"hy",azerbaijani:"az",belarusian:"be",bosnian:"bs",bulgarian:"bg",catalan:"ca",chinese:"zh",croatian:"hr",czech:"cs",danish:"da",dutch:"nl",english:"en",estonian:"et",finnish:"fi",french:"fr",galician:"gl",german:"de",greek:"el",hebrew:"he",hindi:"hi",hungarian:"hu",icelandic:"is",indonesian:"id",italian:"it",japanese:"ja",kannada:"kn",kazakh:"kk",korean:"ko",latvian:"lv",lithuanian:"lt",macedonian:"mk",malay:"ms",marathi:"mr",maori:"mi",nepali:"ne",norwegian:"no",persian:"fa",polish:"pl",portuguese:"pt",romanian:"ro",russian:"ru",serbian:"sr",slovak:"sk",slovenian:"sl",spanish:"es",swahili:"sw",swedish:"sv",tagalog:"tl",tamil:"ta",thai:"th",turkish:"tr",ukrainian:"uk",urdu:"ur",vietnamese:"vi",welsh:"cy"},bT=class{constructor(e,t){this.modelId=e,this.config=t,this.specificationVersion="v2"}get provider(){return this.config.provider}async getArgs({audio:e,mediaType:t,providerOptions:r}){let a=await (0,cy.parseProviderOptions)({provider:"openai",providerOptions:r,schema:bS}),s=new FormData,n=e instanceof Uint8Array?new Blob([e]):new Blob([(0,cy.convertBase64ToUint8Array)(e)]);s.append("model",this.modelId);let i=(0,cy.mediaTypeToExtension)(t);if(s.append("file",new File([n],"audio",{type:t}),`audio.${i}`),a){for(let[e,t]of Object.entries({include:a.include,language:a.language,prompt:a.prompt,response_format:["gpt-4o-transcribe","gpt-4o-mini-transcribe"].includes(this.modelId)?"json":"verbose_json",temperature:a.temperature,timestamp_granularities:a.timestampGranularities}))if(null!=t)if(Array.isArray(t))for(let r of t)s.append(`${e}[]`,String(r));else s.append(e,String(t))}return{formData:s,warnings:[]}}async doGenerate(e){var t,r,a,s,n,i,o,l;let u=null!=(a=null==(r=null==(t=this.config._internal)?void 0:t.currentDate)?void 0:r.call(t))?a:new Date,{formData:p,warnings:d}=await this.getArgs(e),{value:c,responseHeaders:m,rawValue:g}=await (0,cy.postFormDataToApi)({url:this.config.url({path:"/audio/transcriptions",modelId:this.modelId}),headers:(0,cy.combineHeaders)(this.config.headers(),e.headers),formData:p,failedResponseHandler:bt,successfulResponseHandler:(0,cy.createJsonResponseHandler)(bI),abortSignal:e.abortSignal,fetch:this.config.fetch}),h=null!=c.language&&c.language in bx?bx[c.language]:void 0;return{text:c.text,segments:null!=(o=null!=(i=null==(s=c.segments)?void 0:s.map(e=>({text:e.text,startSecond:e.start,endSecond:e.end})))?i:null==(n=c.words)?void 0:n.map(e=>({text:e.word,startSecond:e.start,endSecond:e.end})))?o:[],language:h,durationInSeconds:null!=(l=c.duration)?l:void 0,warnings:d,response:{timestamp:u,modelId:this.modelId,headers:m,body:g}}}},bE=(0,cy.lazyValidator)(()=>(0,cy.zodSchema)(eU.z.object({instructions:eU.z.string().nullish(),speed:eU.z.number().min(.25).max(4).default(1).nullish()}))),bA=class{constructor(e,t){this.modelId=e,this.config=t,this.specificationVersion="v2"}get provider(){return this.config.provider}async getArgs({text:e,voice:t="alloy",outputFormat:r="mp3",speed:a,instructions:s,language:n,providerOptions:i}){let o=[],l=await (0,cy.parseProviderOptions)({provider:"openai",providerOptions:i,schema:bE}),u={model:this.modelId,input:e,voice:t,response_format:"mp3",speed:a,instructions:s};if(r&&(["mp3","opus","aac","flac","wav","pcm"].includes(r)?u.response_format=r:o.push({type:"unsupported-setting",setting:"outputFormat",details:`Unsupported output format: ${r}. Using mp3 instead.`})),l){let e={};for(let t in e){let r=e[t];void 0!==r&&(u[t]=r)}}return n&&o.push({type:"unsupported-setting",setting:"language",details:`OpenAI speech models do not support language selection. Language parameter "${n}" was ignored.`}),{requestBody:u,warnings:o}}async doGenerate(e){var t,r,a;let s=null!=(a=null==(r=null==(t=this.config._internal)?void 0:t.currentDate)?void 0:r.call(t))?a:new Date,{requestBody:n,warnings:i}=await this.getArgs(e),{value:o,responseHeaders:l,rawValue:u}=await (0,cy.postJsonToApi)({url:this.config.url({path:"/audio/speech",modelId:this.modelId}),headers:(0,cy.combineHeaders)(this.config.headers(),e.headers),body:n,failedResponseHandler:bt,successfulResponseHandler:(0,cy.createBinaryResponseHandler)(),abortSignal:e.abortSignal,fetch:this.config.fetch});return{audio:o,warnings:i,request:{body:JSON.stringify(n)},response:{timestamp:s,modelId:this.modelId,headers:l,body:u}}}},bO=(0,cy.lazySchema)(()=>(0,cy.zodSchema)(eU.z.object({action:eU.z.object({type:eU.z.literal("exec"),command:eU.z.array(eU.z.string()),timeoutMs:eU.z.number().optional(),user:eU.z.string().optional(),workingDirectory:eU.z.string().optional(),env:eU.z.record(eU.z.string(),eU.z.string()).optional()})}))),bz=(0,cy.lazySchema)(()=>(0,cy.zodSchema)(eU.z.object({output:eU.z.string()})));function bM(e,t){return!!t&&t.some(t=>e.startsWith(t))}async function bP({prompt:e,systemMessageMode:t,fileIdPrefixes:r,store:a,hasLocalShellTool:s=!1}){var n,i,o,l;let u=[],p=[];for(let{role:d,content:c}of e)switch(d){case"system":switch(t){case"system":u.push({role:"system",content:c});break;case"developer":u.push({role:"developer",content:c});break;case"remove":p.push({type:"other",message:"system messages are removed for this model"});break;default:throw Error(`Unsupported system message mode: ${t}`)}break;case"user":u.push({role:"user",content:c.map((e,t)=>{var a,s,n;switch(e.type){case"text":return{type:"input_text",text:e.text};case"file":if(e.mediaType.startsWith("image/")){let t="image/*"===e.mediaType?"image/jpeg":e.mediaType;return{type:"input_image",...e.data instanceof URL?{image_url:e.data.toString()}:"string"==typeof e.data&&bM(e.data,r)?{file_id:e.data}:{image_url:`data:${t};base64,${(0,cy.convertToBase64)(e.data)}`},detail:null==(s=null==(a=e.providerOptions)?void 0:a.openai)?void 0:s.imageDetail}}if("application/pdf"===e.mediaType){if(e.data instanceof URL)return{type:"input_file",file_url:e.data.toString()};return{type:"input_file",..."string"==typeof e.data&&bM(e.data,r)?{file_id:e.data}:{filename:null!=(n=e.filename)?n:`part-${t}.pdf`,file_data:`data:application/pdf;base64,${(0,cy.convertToBase64)(e.data)}`}}}throw new cy.UnsupportedFunctionalityError({functionality:`file part media type ${e.mediaType}`})}})});break;case"assistant":{let e={};for(let t of c)switch(t.type){case"text":{let e=null==(i=null==(n=t.providerOptions)?void 0:n.openai)?void 0:i.itemId;if(a&&null!=e){u.push({type:"item_reference",id:e});break}u.push({role:"assistant",content:[{type:"output_text",text:t.text}],id:e});break}case"tool-call":{if(t.providerExecuted)break;let e=null==(l=null==(o=t.providerOptions)?void 0:o.openai)?void 0:l.itemId;if(a&&null!=e){u.push({type:"item_reference",id:e});break}if(s&&"local_shell"===t.toolName){let r=await (0,cy.validateTypes)({value:t.input,schema:bO});u.push({type:"local_shell_call",call_id:t.toolCallId,id:e,action:{type:"exec",command:r.action.command,timeout_ms:r.action.timeoutMs,user:r.action.user,working_directory:r.action.workingDirectory,env:r.action.env}});break}u.push({type:"function_call",call_id:t.toolCallId,name:t.toolName,arguments:JSON.stringify(t.input),id:e});break}case"tool-result":a?u.push({type:"item_reference",id:t.toolCallId}):p.push({type:"other",message:`Results for OpenAI tool ${t.toolName} are not sent to the API when store is false`});break;case"reasoning":{let r=await (0,cy.parseProviderOptions)({provider:"openai",providerOptions:t.providerOptions,schema:bR}),s=null==r?void 0:r.itemId;if(null!=s){let n=e[s];if(a)void 0===n&&(u.push({type:"item_reference",id:s}),e[s]={type:"reasoning",id:s,summary:[]});else{let a=[];t.text.length>0?a.push({type:"summary_text",text:t.text}):void 0!==n&&p.push({type:"other",message:`Cannot append empty reasoning part to existing reasoning sequence. Skipping reasoning part: ${JSON.stringify(t)}.`}),void 0===n?(e[s]={type:"reasoning",id:s,encrypted_content:null==r?void 0:r.reasoningEncryptedContent,summary:a},u.push(e[s])):(n.summary.push(...a),(null==r?void 0:r.reasoningEncryptedContent)!=null&&(n.encrypted_content=r.reasoningEncryptedContent))}}else p.push({type:"other",message:`Non-OpenAI reasoning parts are not supported. Skipping reasoning part: ${JSON.stringify(t)}.`})}}break}case"tool":for(let e of c){let t,r=e.output;if(s&&"local_shell"===e.toolName&&"json"===r.type){let t=await (0,cy.validateTypes)({value:r.value,schema:bz});u.push({type:"local_shell_call_output",call_id:e.toolCallId,output:t.output});break}switch(r.type){case"text":case"error-text":t=r.value;break;case"json":case"error-json":t=JSON.stringify(r.value);break;case"content":t=r.value.map(e=>{switch(e.type){case"text":return{type:"input_text",text:e.text};case"media":return e.mediaType.startsWith("image/")?{type:"input_image",image_url:`data:${e.mediaType};base64,${e.data}`}:{type:"input_file",filename:"data",file_data:`data:${e.mediaType};base64,${e.data}`}}})}u.push({type:"function_call_output",call_id:e.toolCallId,output:t})}break;default:throw Error(`Unsupported role: ${d}`)}return{input:u,warnings:p}}(0,cy.createProviderDefinedToolFactoryWithOutputSchema)({id:"openai.local_shell",name:"local_shell",inputSchema:bO,outputSchema:bz});var bR=eU.z.object({itemId:eU.z.string().nullish(),reasoningEncryptedContent:eU.z.string().nullish()});function bC({finishReason:e,hasFunctionCall:t}){switch(e){case void 0:case null:return t?"tool-calls":"stop";case"max_output_tokens":return"length";case"content_filter":return"content-filter";default:return t?"tool-calls":"unknown"}}var bj=(0,cy.lazyValidator)(()=>(0,cy.zodSchema)(eU.z.union([eU.z.object({type:eU.z.literal("response.output_text.delta"),item_id:eU.z.string(),delta:eU.z.string(),logprobs:eU.z.array(eU.z.object({token:eU.z.string(),logprob:eU.z.number(),top_logprobs:eU.z.array(eU.z.object({token:eU.z.string(),logprob:eU.z.number()}))})).nullish()}),eU.z.object({type:eU.z.enum(["response.completed","response.incomplete"]),response:eU.z.object({incomplete_details:eU.z.object({reason:eU.z.string()}).nullish(),usage:eU.z.object({input_tokens:eU.z.number(),input_tokens_details:eU.z.object({cached_tokens:eU.z.number().nullish()}).nullish(),output_tokens:eU.z.number(),output_tokens_details:eU.z.object({reasoning_tokens:eU.z.number().nullish()}).nullish()}),service_tier:eU.z.string().nullish()})}),eU.z.object({type:eU.z.literal("response.created"),response:eU.z.object({id:eU.z.string(),created_at:eU.z.number(),model:eU.z.string(),service_tier:eU.z.string().nullish()})}),eU.z.object({type:eU.z.literal("response.output_item.added"),output_index:eU.z.number(),item:eU.z.discriminatedUnion("type",[eU.z.object({type:eU.z.literal("message"),id:eU.z.string()}),eU.z.object({type:eU.z.literal("reasoning"),id:eU.z.string(),encrypted_content:eU.z.string().nullish()}),eU.z.object({type:eU.z.literal("function_call"),id:eU.z.string(),call_id:eU.z.string(),name:eU.z.string(),arguments:eU.z.string()}),eU.z.object({type:eU.z.literal("web_search_call"),id:eU.z.string(),status:eU.z.string()}),eU.z.object({type:eU.z.literal("computer_call"),id:eU.z.string(),status:eU.z.string()}),eU.z.object({type:eU.z.literal("file_search_call"),id:eU.z.string()}),eU.z.object({type:eU.z.literal("image_generation_call"),id:eU.z.string()}),eU.z.object({type:eU.z.literal("code_interpreter_call"),id:eU.z.string(),container_id:eU.z.string(),code:eU.z.string().nullable(),outputs:eU.z.array(eU.z.discriminatedUnion("type",[eU.z.object({type:eU.z.literal("logs"),logs:eU.z.string()}),eU.z.object({type:eU.z.literal("image"),url:eU.z.string()})])).nullable(),status:eU.z.string()})])}),eU.z.object({type:eU.z.literal("response.output_item.done"),output_index:eU.z.number(),item:eU.z.discriminatedUnion("type",[eU.z.object({type:eU.z.literal("message"),id:eU.z.string()}),eU.z.object({type:eU.z.literal("reasoning"),id:eU.z.string(),encrypted_content:eU.z.string().nullish()}),eU.z.object({type:eU.z.literal("function_call"),id:eU.z.string(),call_id:eU.z.string(),name:eU.z.string(),arguments:eU.z.string(),status:eU.z.literal("completed")}),eU.z.object({type:eU.z.literal("code_interpreter_call"),id:eU.z.string(),code:eU.z.string().nullable(),container_id:eU.z.string(),outputs:eU.z.array(eU.z.discriminatedUnion("type",[eU.z.object({type:eU.z.literal("logs"),logs:eU.z.string()}),eU.z.object({type:eU.z.literal("image"),url:eU.z.string()})])).nullable()}),eU.z.object({type:eU.z.literal("image_generation_call"),id:eU.z.string(),result:eU.z.string()}),eU.z.object({type:eU.z.literal("web_search_call"),id:eU.z.string(),status:eU.z.string(),action:eU.z.discriminatedUnion("type",[eU.z.object({type:eU.z.literal("search"),query:eU.z.string().nullish(),sources:eU.z.array(eU.z.discriminatedUnion("type",[eU.z.object({type:eU.z.literal("url"),url:eU.z.string()}),eU.z.object({type:eU.z.literal("api"),name:eU.z.string()})])).nullish()}),eU.z.object({type:eU.z.literal("open_page"),url:eU.z.string()}),eU.z.object({type:eU.z.literal("find"),url:eU.z.string(),pattern:eU.z.string()})])}),eU.z.object({type:eU.z.literal("file_search_call"),id:eU.z.string(),queries:eU.z.array(eU.z.string()),results:eU.z.array(eU.z.object({attributes:eU.z.record(eU.z.string(),eU.z.unknown()),file_id:eU.z.string(),filename:eU.z.string(),score:eU.z.number(),text:eU.z.string()})).nullish()}),eU.z.object({type:eU.z.literal("local_shell_call"),id:eU.z.string(),call_id:eU.z.string(),action:eU.z.object({type:eU.z.literal("exec"),command:eU.z.array(eU.z.string()),timeout_ms:eU.z.number().optional(),user:eU.z.string().optional(),working_directory:eU.z.string().optional(),env:eU.z.record(eU.z.string(),eU.z.string()).optional()})}),eU.z.object({type:eU.z.literal("computer_call"),id:eU.z.string(),status:eU.z.literal("completed")})])}),eU.z.object({type:eU.z.literal("response.function_call_arguments.delta"),item_id:eU.z.string(),output_index:eU.z.number(),delta:eU.z.string()}),eU.z.object({type:eU.z.literal("response.image_generation_call.partial_image"),item_id:eU.z.string(),output_index:eU.z.number(),partial_image_b64:eU.z.string()}),eU.z.object({type:eU.z.literal("response.code_interpreter_call_code.delta"),item_id:eU.z.string(),output_index:eU.z.number(),delta:eU.z.string()}),eU.z.object({type:eU.z.literal("response.code_interpreter_call_code.done"),item_id:eU.z.string(),output_index:eU.z.number(),code:eU.z.string()}),eU.z.object({type:eU.z.literal("response.output_text.annotation.added"),annotation:eU.z.discriminatedUnion("type",[eU.z.object({type:eU.z.literal("url_citation"),start_index:eU.z.number(),end_index:eU.z.number(),url:eU.z.string(),title:eU.z.string()}),eU.z.object({type:eU.z.literal("file_citation"),file_id:eU.z.string(),filename:eU.z.string().nullish(),index:eU.z.number().nullish(),start_index:eU.z.number().nullish(),end_index:eU.z.number().nullish(),quote:eU.z.string().nullish()})])}),eU.z.object({type:eU.z.literal("response.reasoning_summary_part.added"),item_id:eU.z.string(),summary_index:eU.z.number()}),eU.z.object({type:eU.z.literal("response.reasoning_summary_text.delta"),item_id:eU.z.string(),summary_index:eU.z.number(),delta:eU.z.string()}),eU.z.object({type:eU.z.literal("response.reasoning_summary_part.done"),item_id:eU.z.string(),summary_index:eU.z.number()}),eU.z.object({type:eU.z.literal("error"),sequence_number:eU.z.number(),error:eU.z.object({type:eU.z.string(),code:eU.z.string(),message:eU.z.string(),param:eU.z.string().nullish()})}),eU.z.object({type:eU.z.string()}).loose().transform(e=>({type:"unknown_chunk",message:e.type}))]))),bN=(0,cy.lazyValidator)(()=>(0,cy.zodSchema)(eU.z.object({id:eU.z.string().optional(),created_at:eU.z.number().optional(),error:eU.z.object({message:eU.z.string(),type:eU.z.string(),param:eU.z.string().nullish(),code:eU.z.string()}).nullish(),model:eU.z.string().optional(),output:eU.z.array(eU.z.discriminatedUnion("type",[eU.z.object({type:eU.z.literal("message"),role:eU.z.literal("assistant"),id:eU.z.string(),content:eU.z.array(eU.z.object({type:eU.z.literal("output_text"),text:eU.z.string(),logprobs:eU.z.array(eU.z.object({token:eU.z.string(),logprob:eU.z.number(),top_logprobs:eU.z.array(eU.z.object({token:eU.z.string(),logprob:eU.z.number()}))})).nullish(),annotations:eU.z.array(eU.z.discriminatedUnion("type",[eU.z.object({type:eU.z.literal("url_citation"),start_index:eU.z.number(),end_index:eU.z.number(),url:eU.z.string(),title:eU.z.string()}),eU.z.object({type:eU.z.literal("file_citation"),file_id:eU.z.string(),filename:eU.z.string().nullish(),index:eU.z.number().nullish(),start_index:eU.z.number().nullish(),end_index:eU.z.number().nullish(),quote:eU.z.string().nullish()}),eU.z.object({type:eU.z.literal("container_file_citation"),container_id:eU.z.string(),file_id:eU.z.string(),filename:eU.z.string().nullish(),start_index:eU.z.number().nullish(),end_index:eU.z.number().nullish(),index:eU.z.number().nullish()}),eU.z.object({type:eU.z.literal("file_path"),file_id:eU.z.string(),index:eU.z.number().nullish()})]))}))}),eU.z.object({type:eU.z.literal("web_search_call"),id:eU.z.string(),status:eU.z.string(),action:eU.z.discriminatedUnion("type",[eU.z.object({type:eU.z.literal("search"),query:eU.z.string().nullish(),sources:eU.z.array(eU.z.discriminatedUnion("type",[eU.z.object({type:eU.z.literal("url"),url:eU.z.string()}),eU.z.object({type:eU.z.literal("api"),name:eU.z.string()})])).nullish()}),eU.z.object({type:eU.z.literal("open_page"),url:eU.z.string()}),eU.z.object({type:eU.z.literal("find"),url:eU.z.string(),pattern:eU.z.string()})])}),eU.z.object({type:eU.z.literal("file_search_call"),id:eU.z.string(),queries:eU.z.array(eU.z.string()),results:eU.z.array(eU.z.object({attributes:eU.z.record(eU.z.string(),eU.z.union([eU.z.string(),eU.z.number(),eU.z.boolean()])),file_id:eU.z.string(),filename:eU.z.string(),score:eU.z.number(),text:eU.z.string()})).nullish()}),eU.z.object({type:eU.z.literal("code_interpreter_call"),id:eU.z.string(),code:eU.z.string().nullable(),container_id:eU.z.string(),outputs:eU.z.array(eU.z.discriminatedUnion("type",[eU.z.object({type:eU.z.literal("logs"),logs:eU.z.string()}),eU.z.object({type:eU.z.literal("image"),url:eU.z.string()})])).nullable()}),eU.z.object({type:eU.z.literal("image_generation_call"),id:eU.z.string(),result:eU.z.string()}),eU.z.object({type:eU.z.literal("local_shell_call"),id:eU.z.string(),call_id:eU.z.string(),action:eU.z.object({type:eU.z.literal("exec"),command:eU.z.array(eU.z.string()),timeout_ms:eU.z.number().optional(),user:eU.z.string().optional(),working_directory:eU.z.string().optional(),env:eU.z.record(eU.z.string(),eU.z.string()).optional()})}),eU.z.object({type:eU.z.literal("function_call"),call_id:eU.z.string(),name:eU.z.string(),arguments:eU.z.string(),id:eU.z.string()}),eU.z.object({type:eU.z.literal("computer_call"),id:eU.z.string(),status:eU.z.string().optional()}),eU.z.object({type:eU.z.literal("reasoning"),id:eU.z.string(),encrypted_content:eU.z.string().nullish(),summary:eU.z.array(eU.z.object({type:eU.z.literal("summary_text"),text:eU.z.string()}))})])).optional(),service_tier:eU.z.string().nullish(),incomplete_details:eU.z.object({reason:eU.z.string()}).nullish(),usage:eU.z.object({input_tokens:eU.z.number(),input_tokens_details:eU.z.object({cached_tokens:eU.z.number().nullish()}).nullish(),output_tokens:eU.z.number(),output_tokens_details:eU.z.object({reasoning_tokens:eU.z.number().nullish()}).nullish()}).optional()}))),bL=(0,cy.lazyValidator)(()=>(0,cy.zodSchema)(eU.z.object({conversation:eU.z.string().nullish(),include:eU.z.array(eU.z.enum(["reasoning.encrypted_content","file_search_call.results","message.output_text.logprobs"])).nullish(),instructions:eU.z.string().nullish(),logprobs:eU.z.union([eU.z.boolean(),eU.z.number().min(1).max(20)]).optional(),maxToolCalls:eU.z.number().nullish(),metadata:eU.z.any().nullish(),parallelToolCalls:eU.z.boolean().nullish(),previousResponseId:eU.z.string().nullish(),promptCacheKey:eU.z.string().nullish(),promptCacheRetention:eU.z.enum(["in_memory","24h"]).nullish(),reasoningEffort:eU.z.string().nullish(),reasoningSummary:eU.z.string().nullish(),safetyIdentifier:eU.z.string().nullish(),serviceTier:eU.z.enum(["auto","flex","priority","default"]).nullish(),store:eU.z.boolean().nullish(),strictJsonSchema:eU.z.boolean().nullish(),textVerbosity:eU.z.enum(["low","medium","high"]).nullish(),truncation:eU.z.enum(["auto","disabled"]).nullish(),user:eU.z.string().nullish()}))),bD=(0,cy.lazySchema)(()=>(0,cy.zodSchema)(eU.z.object({code:eU.z.string().nullish(),containerId:eU.z.string()}))),bq=(0,cy.lazySchema)(()=>(0,cy.zodSchema)(eU.z.object({outputs:eU.z.array(eU.z.discriminatedUnion("type",[eU.z.object({type:eU.z.literal("logs"),logs:eU.z.string()}),eU.z.object({type:eU.z.literal("image"),url:eU.z.string()})])).nullish()}))),b$=(0,cy.lazySchema)(()=>(0,cy.zodSchema)(eU.z.object({container:eU.z.union([eU.z.string(),eU.z.object({fileIds:eU.z.array(eU.z.string()).optional()})]).optional()}))),bF=(0,cy.createProviderDefinedToolFactoryWithOutputSchema)({id:"openai.code_interpreter",name:"code_interpreter",inputSchema:bD,outputSchema:bq}),bU=eU.z.object({key:eU.z.string(),type:eU.z.enum(["eq","ne","gt","gte","lt","lte"]),value:eU.z.union([eU.z.string(),eU.z.number(),eU.z.boolean()])}),bZ=eU.z.object({type:eU.z.enum(["and","or"]),filters:eU.z.array(eU.z.union([bU,eU.z.lazy(()=>bZ)]))}),bB=(0,cy.lazySchema)(()=>(0,cy.zodSchema)(eU.z.object({vectorStoreIds:eU.z.array(eU.z.string()),maxNumResults:eU.z.number().optional(),ranking:eU.z.object({ranker:eU.z.string().optional(),scoreThreshold:eU.z.number().optional()}).optional(),filters:eU.z.union([bU,bZ]).optional()}))),bV=(0,cy.lazySchema)(()=>(0,cy.zodSchema)(eU.z.object({queries:eU.z.array(eU.z.string()),results:eU.z.array(eU.z.object({attributes:eU.z.record(eU.z.string(),eU.z.unknown()),fileId:eU.z.string(),filename:eU.z.string(),score:eU.z.number(),text:eU.z.string()})).nullable()}))),bK=(0,cy.createProviderDefinedToolFactoryWithOutputSchema)({id:"openai.file_search",name:"file_search",inputSchema:eU.z.object({}),outputSchema:bV}),bG=(0,cy.lazySchema)(()=>(0,cy.zodSchema)(eU.z.object({externalWebAccess:eU.z.boolean().optional(),filters:eU.z.object({allowedDomains:eU.z.array(eU.z.string()).optional()}).optional(),searchContextSize:eU.z.enum(["low","medium","high"]).optional(),userLocation:eU.z.object({type:eU.z.literal("approximate"),country:eU.z.string().optional(),city:eU.z.string().optional(),region:eU.z.string().optional(),timezone:eU.z.string().optional()}).optional()}))),bW=(0,cy.lazySchema)(()=>(0,cy.zodSchema)(eU.z.object({}))),bQ=(0,cy.lazySchema)(()=>(0,cy.zodSchema)(eU.z.object({action:eU.z.discriminatedUnion("type",[eU.z.object({type:eU.z.literal("search"),query:eU.z.string().optional()}),eU.z.object({type:eU.z.literal("openPage"),url:eU.z.string()}),eU.z.object({type:eU.z.literal("find"),url:eU.z.string(),pattern:eU.z.string()})]),sources:eU.z.array(eU.z.discriminatedUnion("type",[eU.z.object({type:eU.z.literal("url"),url:eU.z.string()}),eU.z.object({type:eU.z.literal("api"),name:eU.z.string()})])).optional()})));(0,cy.createProviderDefinedToolFactoryWithOutputSchema)({id:"openai.web_search",name:"web_search",inputSchema:bW,outputSchema:bQ});var bJ=(0,cy.lazySchema)(()=>(0,cy.zodSchema)(eU.z.object({searchContextSize:eU.z.enum(["low","medium","high"]).optional(),userLocation:eU.z.object({type:eU.z.literal("approximate"),country:eU.z.string().optional(),city:eU.z.string().optional(),region:eU.z.string().optional(),timezone:eU.z.string().optional()}).optional()}))),bH=(0,cy.lazySchema)(()=>(0,cy.zodSchema)(eU.z.object({}))),bY=(0,cy.lazySchema)(()=>(0,cy.zodSchema)(eU.z.object({action:eU.z.discriminatedUnion("type",[eU.z.object({type:eU.z.literal("search"),query:eU.z.string().optional()}),eU.z.object({type:eU.z.literal("openPage"),url:eU.z.string()}),eU.z.object({type:eU.z.literal("find"),url:eU.z.string(),pattern:eU.z.string()})])}))),bX=(0,cy.createProviderDefinedToolFactoryWithOutputSchema)({id:"openai.web_search_preview",name:"web_search_preview",inputSchema:bH,outputSchema:bY}),b0=(0,cy.lazySchema)(()=>(0,cy.zodSchema)(eU.z.object({background:eU.z.enum(["auto","opaque","transparent"]).optional(),inputFidelity:eU.z.enum(["low","high"]).optional(),inputImageMask:eU.z.object({fileId:eU.z.string().optional(),imageUrl:eU.z.string().optional()}).optional(),model:eU.z.string().optional(),moderation:eU.z.enum(["auto"]).optional(),outputCompression:eU.z.number().int().min(0).max(100).optional(),outputFormat:eU.z.enum(["png","jpeg","webp"]).optional(),partialImages:eU.z.number().int().min(0).max(3).optional(),quality:eU.z.enum(["auto","low","medium","high"]).optional(),size:eU.z.enum(["1024x1024","1024x1536","1536x1024","auto"]).optional()}).strict())),b1=(0,cy.lazySchema)(()=>(0,cy.zodSchema)(eU.z.object({}))),b2=(0,cy.lazySchema)(()=>(0,cy.zodSchema)(eU.z.object({result:eU.z.string()}))),b3=(0,cy.createProviderDefinedToolFactoryWithOutputSchema)({id:"openai.image_generation",name:"image_generation",inputSchema:b1,outputSchema:b2});async function b5({tools:e,toolChoice:t,strictJsonSchema:r}){e=(null==e?void 0:e.length)?e:void 0;let a=[];if(null==e)return{tools:void 0,toolChoice:void 0,toolWarnings:a};let s=[];for(let t of e)switch(t.type){case"function":s.push({type:"function",name:t.name,description:t.description,parameters:t.inputSchema,strict:r});break;case"provider-defined":switch(t.id){case"openai.file_search":{let e=await (0,cy.validateTypes)({value:t.args,schema:bB});s.push({type:"file_search",vector_store_ids:e.vectorStoreIds,max_num_results:e.maxNumResults,ranking_options:e.ranking?{ranker:e.ranking.ranker,score_threshold:e.ranking.scoreThreshold}:void 0,filters:e.filters});break}case"openai.local_shell":s.push({type:"local_shell"});break;case"openai.web_search_preview":{let e=await (0,cy.validateTypes)({value:t.args,schema:bJ});s.push({type:"web_search_preview",search_context_size:e.searchContextSize,user_location:e.userLocation});break}case"openai.web_search":{let e=await (0,cy.validateTypes)({value:t.args,schema:bG});s.push({type:"web_search",filters:null!=e.filters?{allowed_domains:e.filters.allowedDomains}:void 0,external_web_access:e.externalWebAccess,search_context_size:e.searchContextSize,user_location:e.userLocation});break}case"openai.code_interpreter":{let e=await (0,cy.validateTypes)({value:t.args,schema:b$});s.push({type:"code_interpreter",container:null==e.container?{type:"auto",file_ids:void 0}:"string"==typeof e.container?e.container:{type:"auto",file_ids:e.container.fileIds}});break}case"openai.image_generation":{let e=await (0,cy.validateTypes)({value:t.args,schema:b0});s.push({type:"image_generation",background:e.background,input_fidelity:e.inputFidelity,input_image_mask:e.inputImageMask?{file_id:e.inputImageMask.fileId,image_url:e.inputImageMask.imageUrl}:void 0,model:e.model,size:e.size,quality:e.quality,moderation:e.moderation,output_format:e.outputFormat,output_compression:e.outputCompression})}}break;default:a.push({type:"unsupported-tool",tool:t})}if(null==t)return{tools:s,toolChoice:void 0,toolWarnings:a};let n=t.type;switch(n){case"auto":case"none":case"required":return{tools:s,toolChoice:n,toolWarnings:a};case"tool":return{tools:s,toolChoice:"code_interpreter"===t.toolName||"file_search"===t.toolName||"image_generation"===t.toolName||"web_search_preview"===t.toolName||"web_search"===t.toolName?{type:t.toolName}:{type:"function",name:t.toolName},toolWarnings:a};default:throw new cy.UnsupportedFunctionalityError({functionality:`tool choice type: ${n}`})}}var b4=class{constructor(e,t){this.specificationVersion="v2",this.supportedUrls={"image/*":[/^https?:\/\/.*$/],"application/pdf":[/^https?:\/\/.*$/]},this.modelId=e,this.config=t}get provider(){return this.config.provider}async getArgs({maxOutputTokens:e,temperature:t,stopSequences:r,topP:a,topK:s,presencePenalty:n,frequencyPenalty:i,seed:o,prompt:l,providerOptions:u,tools:p,toolChoice:d,responseFormat:c}){var m,g,h,f,y;let v,b=[],w=(v={systemMessageMode:"system",supportsFlexProcessing:(y=this.modelId).startsWith("o3")||y.startsWith("o4-mini")||y.startsWith("gpt-5")&&!y.startsWith("gpt-5-chat"),supportsPriorityProcessing:y.startsWith("gpt-4")||y.startsWith("gpt-5-mini")||y.startsWith("gpt-5")&&!y.startsWith("gpt-5-nano")&&!y.startsWith("gpt-5-chat")||y.startsWith("o3")||y.startsWith("o4-mini")},y.startsWith("gpt-5-chat")?{...v,isReasoningModel:!1}:y.startsWith("o")||y.startsWith("gpt-5")||y.startsWith("codex-")||y.startsWith("computer-use")?{...v,isReasoningModel:!0,systemMessageMode:"developer"}:{...v,isReasoningModel:!1});null!=s&&b.push({type:"unsupported-setting",setting:"topK"}),null!=o&&b.push({type:"unsupported-setting",setting:"seed"}),null!=n&&b.push({type:"unsupported-setting",setting:"presencePenalty"}),null!=i&&b.push({type:"unsupported-setting",setting:"frequencyPenalty"}),null!=r&&b.push({type:"unsupported-setting",setting:"stopSequences"});let k=await (0,cy.parseProviderOptions)({provider:"openai",providerOptions:u,schema:bL});(null==k?void 0:k.conversation)&&(null==k?void 0:k.previousResponseId)&&b.push({type:"unsupported-setting",setting:"conversation",details:"conversation and previousResponseId cannot be used together"});let{input:_,warnings:I}=await bP({prompt:l,systemMessageMode:w.systemMessageMode,fileIdPrefixes:this.config.fileIdPrefixes,store:null==(m=null==k?void 0:k.store)||m,hasLocalShellTool:E("openai.local_shell")});b.push(...I);let S=null!=(g=null==k?void 0:k.strictJsonSchema)&&g,x=null==k?void 0:k.include;function T(e){null==x?x=[e]:x.includes(e)||(x=[...x,e])}function E(e){return(null==p?void 0:p.find(t=>"provider-defined"===t.type&&t.id===e))!=null}let A="number"==typeof(null==k?void 0:k.logprobs)?null==k?void 0:k.logprobs:(null==k?void 0:k.logprobs)===!0?20:void 0;A&&T("message.output_text.logprobs");let O=null==(h=null==p?void 0:p.find(e=>"provider-defined"===e.type&&("openai.web_search"===e.id||"openai.web_search_preview"===e.id)))?void 0:h.name;O&&T("web_search_call.action.sources"),E("openai.code_interpreter")&&T("code_interpreter_call.outputs");let z=null==k?void 0:k.store;!1===z&&w.isReasoningModel&&T("reasoning.encrypted_content");let M={model:this.modelId,input:_,temperature:t,top_p:a,max_output_tokens:e,...((null==c?void 0:c.type)==="json"||(null==k?void 0:k.textVerbosity))&&{text:{...(null==c?void 0:c.type)==="json"&&{format:null!=c.schema?{type:"json_schema",strict:S,name:null!=(f=c.name)?f:"response",description:c.description,schema:c.schema}:{type:"json_object"}},...(null==k?void 0:k.textVerbosity)&&{verbosity:k.textVerbosity}}},conversation:null==k?void 0:k.conversation,max_tool_calls:null==k?void 0:k.maxToolCalls,metadata:null==k?void 0:k.metadata,parallel_tool_calls:null==k?void 0:k.parallelToolCalls,previous_response_id:null==k?void 0:k.previousResponseId,store:z,user:null==k?void 0:k.user,instructions:null==k?void 0:k.instructions,service_tier:null==k?void 0:k.serviceTier,include:x,prompt_cache_key:null==k?void 0:k.promptCacheKey,prompt_cache_retention:null==k?void 0:k.promptCacheRetention,safety_identifier:null==k?void 0:k.safetyIdentifier,top_logprobs:A,truncation:null==k?void 0:k.truncation,...w.isReasoningModel&&((null==k?void 0:k.reasoningEffort)!=null||(null==k?void 0:k.reasoningSummary)!=null)&&{reasoning:{...(null==k?void 0:k.reasoningEffort)!=null&&{effort:k.reasoningEffort},...(null==k?void 0:k.reasoningSummary)!=null&&{summary:k.reasoningSummary}}}};w.isReasoningModel?(null!=M.temperature&&(M.temperature=void 0,b.push({type:"unsupported-setting",setting:"temperature",details:"temperature is not supported for reasoning models"})),null!=M.top_p&&(M.top_p=void 0,b.push({type:"unsupported-setting",setting:"topP",details:"topP is not supported for reasoning models"}))):((null==k?void 0:k.reasoningEffort)!=null&&b.push({type:"unsupported-setting",setting:"reasoningEffort",details:"reasoningEffort is not supported for non-reasoning models"}),(null==k?void 0:k.reasoningSummary)!=null&&b.push({type:"unsupported-setting",setting:"reasoningSummary",details:"reasoningSummary is not supported for non-reasoning models"})),(null==k?void 0:k.serviceTier)!=="flex"||w.supportsFlexProcessing||(b.push({type:"unsupported-setting",setting:"serviceTier",details:"flex processing is only available for o3, o4-mini, and gpt-5 models"}),delete M.service_tier),(null==k?void 0:k.serviceTier)!=="priority"||w.supportsPriorityProcessing||(b.push({type:"unsupported-setting",setting:"serviceTier",details:"priority processing is only available for supported models (gpt-4, gpt-5, gpt-5-mini, o3, o4-mini) and requires Enterprise access. gpt-5-nano is not supported"}),delete M.service_tier);let{tools:P,toolChoice:R,toolWarnings:C}=await b5({tools:p,toolChoice:d,strictJsonSchema:S});return{webSearchToolName:O,args:{...M,tools:P,tool_choice:R},warnings:[...b,...C],store:z}}async doGenerate(e){var t,r,a,s,n,i,o,l,u,p,d,c,m,g,h,f,y,v,b;let{args:w,warnings:k,webSearchToolName:_}=await this.getArgs(e),I=this.config.url({path:"/responses",modelId:this.modelId}),{responseHeaders:S,value:x,rawValue:T}=await (0,cy.postJsonToApi)({url:I,headers:(0,cy.combineHeaders)(this.config.headers(),e.headers),body:w,failedResponseHandler:bt,successfulResponseHandler:(0,cy.createJsonResponseHandler)(bN),abortSignal:e.abortSignal,fetch:this.config.fetch});if(x.error)throw new cy.APICallError({message:x.error.message,url:I,requestBodyValues:w,statusCode:400,responseHeaders:S,responseBody:T,isRetryable:!1});let E=[],A=[],O=!1;for(let h of x.output)switch(h.type){case"reasoning":for(let e of(0===h.summary.length&&h.summary.push({type:"summary_text",text:""}),h.summary))E.push({type:"reasoning",text:e.text,providerMetadata:{openai:{itemId:h.id,reasoningEncryptedContent:null!=(t=h.encrypted_content)?t:null}}});break;case"image_generation_call":E.push({type:"tool-call",toolCallId:h.id,toolName:"image_generation",input:"{}",providerExecuted:!0}),E.push({type:"tool-result",toolCallId:h.id,toolName:"image_generation",result:{result:h.result},providerExecuted:!0});break;case"local_shell_call":E.push({type:"tool-call",toolCallId:h.call_id,toolName:"local_shell",input:JSON.stringify({action:h.action}),providerMetadata:{openai:{itemId:h.id}}});break;case"message":for(let t of h.content)for(let m of((null==(a=null==(r=e.providerOptions)?void 0:r.openai)?void 0:a.logprobs)&&t.logprobs&&A.push(t.logprobs),E.push({type:"text",text:t.text,providerMetadata:{openai:{itemId:h.id}}}),t.annotations))"url_citation"===m.type?E.push({type:"source",sourceType:"url",id:null!=(i=null==(n=(s=this.config).generateId)?void 0:n.call(s))?i:(0,cy.generateId)(),url:m.url,title:m.title}):"file_citation"===m.type&&E.push({type:"source",sourceType:"document",id:null!=(u=null==(l=(o=this.config).generateId)?void 0:l.call(o))?u:(0,cy.generateId)(),mediaType:"text/plain",title:null!=(d=null!=(p=m.quote)?p:m.filename)?d:"Document",filename:null!=(c=m.filename)?c:m.file_id,...m.file_id?{providerMetadata:{openai:{fileId:m.file_id}}}:{}});break;case"function_call":O=!0,E.push({type:"tool-call",toolCallId:h.call_id,toolName:h.name,input:h.arguments,providerMetadata:{openai:{itemId:h.id}}});break;case"web_search_call":E.push({type:"tool-call",toolCallId:h.id,toolName:null!=_?_:"web_search",input:JSON.stringify({}),providerExecuted:!0}),E.push({type:"tool-result",toolCallId:h.id,toolName:null!=_?_:"web_search",result:b9(h.action),providerExecuted:!0});break;case"computer_call":E.push({type:"tool-call",toolCallId:h.id,toolName:"computer_use",input:"",providerExecuted:!0}),E.push({type:"tool-result",toolCallId:h.id,toolName:"computer_use",result:{type:"computer_use_tool_result",status:h.status||"completed"},providerExecuted:!0});break;case"file_search_call":E.push({type:"tool-call",toolCallId:h.id,toolName:"file_search",input:"{}",providerExecuted:!0}),E.push({type:"tool-result",toolCallId:h.id,toolName:"file_search",result:{queries:h.queries,results:null!=(g=null==(m=h.results)?void 0:m.map(e=>({attributes:e.attributes,fileId:e.file_id,filename:e.filename,score:e.score,text:e.text})))?g:null},providerExecuted:!0});break;case"code_interpreter_call":E.push({type:"tool-call",toolCallId:h.id,toolName:"code_interpreter",input:JSON.stringify({code:h.code,containerId:h.container_id}),providerExecuted:!0}),E.push({type:"tool-result",toolCallId:h.id,toolName:"code_interpreter",result:{outputs:h.outputs},providerExecuted:!0})}let z={openai:{...null!=x.id?{responseId:x.id}:{}}};A.length>0&&(z.openai.logprobs=A),"string"==typeof x.service_tier&&(z.openai.serviceTier=x.service_tier);let M=x.usage;return{content:E,finishReason:bC({finishReason:null==(h=x.incomplete_details)?void 0:h.reason,hasFunctionCall:O}),usage:{inputTokens:M.input_tokens,outputTokens:M.output_tokens,totalTokens:M.input_tokens+M.output_tokens,reasoningTokens:null!=(y=null==(f=M.output_tokens_details)?void 0:f.reasoning_tokens)?y:void 0,cachedInputTokens:null!=(b=null==(v=M.input_tokens_details)?void 0:v.cached_tokens)?b:void 0},request:{body:w},response:{id:x.id,timestamp:new Date(1e3*x.created_at),modelId:x.model,headers:S,body:T},providerMetadata:z,warnings:k}}async doStream(e){let t,{args:r,warnings:a,webSearchToolName:s,store:n}=await this.getArgs(e),{responseHeaders:i,value:o}=await (0,cy.postJsonToApi)({url:this.config.url({path:"/responses",modelId:this.modelId}),headers:(0,cy.combineHeaders)(this.config.headers(),e.headers),body:{...r,stream:!0},failedResponseHandler:bt,successfulResponseHandler:(0,cy.createEventSourceResponseHandler)(bj),abortSignal:e.abortSignal,fetch:this.config.fetch}),l=this,u="unknown",p={inputTokens:void 0,outputTokens:void 0,totalTokens:void 0},d=[],c=null,m={},g=[],h=!1,f={};return{stream:o.pipeThrough(new TransformStream({start(e){e.enqueue({type:"stream-start",warnings:a})},transform(r,a){var i,o,y,v,b,w,k,_,I,S,x,T,E,A,O,z,M,P,R,C,j,N,L;if(e.includeRawChunks&&a.enqueue({type:"raw",rawValue:r.rawValue}),!r.success){u="error",a.enqueue({type:"error",error:r.error});return}let D=r.value;if(b7(D))"function_call"===D.item.type?(m[D.output_index]={toolName:D.item.name,toolCallId:D.item.call_id},a.enqueue({type:"tool-input-start",id:D.item.call_id,toolName:D.item.name})):"web_search_call"===D.item.type?(m[D.output_index]={toolName:null!=s?s:"web_search",toolCallId:D.item.id},a.enqueue({type:"tool-input-start",id:D.item.id,toolName:null!=s?s:"web_search",providerExecuted:!0}),a.enqueue({type:"tool-input-end",id:D.item.id}),a.enqueue({type:"tool-call",toolCallId:D.item.id,toolName:null!=s?s:"web_search",input:JSON.stringify({}),providerExecuted:!0})):"computer_call"===D.item.type?(m[D.output_index]={toolName:"computer_use",toolCallId:D.item.id},a.enqueue({type:"tool-input-start",id:D.item.id,toolName:"computer_use",providerExecuted:!0})):"code_interpreter_call"===D.item.type?(m[D.output_index]={toolName:"code_interpreter",toolCallId:D.item.id,codeInterpreter:{containerId:D.item.container_id}},a.enqueue({type:"tool-input-start",id:D.item.id,toolName:"code_interpreter",providerExecuted:!0}),a.enqueue({type:"tool-input-delta",id:D.item.id,delta:`{"containerId":"${D.item.container_id}","code":"`})):"file_search_call"===D.item.type?a.enqueue({type:"tool-call",toolCallId:D.item.id,toolName:"file_search",input:"{}",providerExecuted:!0}):"image_generation_call"===D.item.type?a.enqueue({type:"tool-call",toolCallId:D.item.id,toolName:"image_generation",input:"{}",providerExecuted:!0}):"message"===D.item.type?(g.splice(0,g.length),a.enqueue({type:"text-start",id:D.item.id,providerMetadata:{openai:{itemId:D.item.id}}})):b7(D)&&"reasoning"===D.item.type&&(f[D.item.id]={encryptedContent:D.item.encrypted_content,summaryParts:{0:"active"}},a.enqueue({type:"reasoning-start",id:`${D.item.id}:0`,providerMetadata:{openai:{itemId:D.item.id,reasoningEncryptedContent:null!=(i=D.item.encrypted_content)?i:null}}}));else if(b6(D)&&"message"!==D.item.type){if("function_call"===D.item.type)m[D.output_index]=void 0,h=!0,a.enqueue({type:"tool-input-end",id:D.item.call_id}),a.enqueue({type:"tool-call",toolCallId:D.item.call_id,toolName:D.item.name,input:D.item.arguments,providerMetadata:{openai:{itemId:D.item.id}}});else if("web_search_call"===D.item.type)m[D.output_index]=void 0,a.enqueue({type:"tool-result",toolCallId:D.item.id,toolName:null!=s?s:"web_search",result:b9(D.item.action),providerExecuted:!0});else if("computer_call"===D.item.type)m[D.output_index]=void 0,a.enqueue({type:"tool-input-end",id:D.item.id}),a.enqueue({type:"tool-call",toolCallId:D.item.id,toolName:"computer_use",input:"",providerExecuted:!0}),a.enqueue({type:"tool-result",toolCallId:D.item.id,toolName:"computer_use",result:{type:"computer_use_tool_result",status:D.item.status||"completed"},providerExecuted:!0});else if("file_search_call"===D.item.type)m[D.output_index]=void 0,a.enqueue({type:"tool-result",toolCallId:D.item.id,toolName:"file_search",result:{queries:D.item.queries,results:null!=(y=null==(o=D.item.results)?void 0:o.map(e=>({attributes:e.attributes,fileId:e.file_id,filename:e.filename,score:e.score,text:e.text})))?y:null},providerExecuted:!0});else if("code_interpreter_call"===D.item.type)m[D.output_index]=void 0,a.enqueue({type:"tool-result",toolCallId:D.item.id,toolName:"code_interpreter",result:{outputs:D.item.outputs},providerExecuted:!0});else if("image_generation_call"===D.item.type)a.enqueue({type:"tool-result",toolCallId:D.item.id,toolName:"image_generation",result:{result:D.item.result},providerExecuted:!0});else if("local_shell_call"===D.item.type)m[D.output_index]=void 0,a.enqueue({type:"tool-call",toolCallId:D.item.call_id,toolName:"local_shell",input:JSON.stringify({action:{type:"exec",command:D.item.action.command,timeoutMs:D.item.action.timeout_ms,user:D.item.action.user,workingDirectory:D.item.action.working_directory,env:D.item.action.env}}),providerMetadata:{openai:{itemId:D.item.id}}});else if("reasoning"===D.item.type){for(let e of Object.entries(f[D.item.id].summaryParts).filter(([e,t])=>"active"===t||"can-conclude"===t).map(([e])=>e))a.enqueue({type:"reasoning-end",id:`${D.item.id}:${e}`,providerMetadata:{openai:{itemId:D.item.id,reasoningEncryptedContent:null!=(v=D.item.encrypted_content)?v:null}}});delete f[D.item.id]}}else if("response.function_call_arguments.delta"===D.type){let e=m[D.output_index];null!=e&&a.enqueue({type:"tool-input-delta",id:e.toolCallId,delta:D.delta})}else if("response.code_interpreter_call_code.delta"===D.type){let e=m[D.output_index];null!=e&&a.enqueue({type:"tool-input-delta",id:e.toolCallId,delta:JSON.stringify(D.delta).slice(1,-1)})}else if("response.code_interpreter_call_code.done"===D.type){let e=m[D.output_index];null!=e&&(a.enqueue({type:"tool-input-delta",id:e.toolCallId,delta:'"}'}),a.enqueue({type:"tool-input-end",id:e.toolCallId}),a.enqueue({type:"tool-call",toolCallId:e.toolCallId,toolName:"code_interpreter",input:JSON.stringify({code:D.code,containerId:e.codeInterpreter.containerId}),providerExecuted:!0}))}else if("response.created"===D.type)c=D.response.id,a.enqueue({type:"response-metadata",id:D.response.id,timestamp:new Date(1e3*D.response.created_at),modelId:D.response.model});else if("response.output_text.delta"===D.type)a.enqueue({type:"text-delta",id:D.item_id,delta:D.delta}),(null==(w=null==(b=e.providerOptions)?void 0:b.openai)?void 0:w.logprobs)&&D.logprobs&&d.push(D.logprobs);else if("response.reasoning_summary_part.added"===D.type){if(D.summary_index>0){let e=f[D.item_id];for(let t of(e.summaryParts[D.summary_index]="active",Object.keys(e.summaryParts)))"can-conclude"===e.summaryParts[t]&&(a.enqueue({type:"reasoning-end",id:`${D.item_id}:${t}`,providerMetadata:{openai:{itemId:D.item_id}}}),e.summaryParts[t]="concluded");a.enqueue({type:"reasoning-start",id:`${D.item_id}:${D.summary_index}`,providerMetadata:{openai:{itemId:D.item_id,reasoningEncryptedContent:null!=(_=null==(k=f[D.item_id])?void 0:k.encryptedContent)?_:null}}})}}else{"response.reasoning_summary_text.delta"===D.type?a.enqueue({type:"reasoning-delta",id:`${D.item_id}:${D.summary_index}`,delta:D.delta,providerMetadata:{openai:{itemId:D.item_id}}}):"response.reasoning_summary_part.done"===D.type?n?(a.enqueue({type:"reasoning-end",id:`${D.item_id}:${D.summary_index}`,providerMetadata:{openai:{itemId:D.item_id}}}),f[D.item_id].summaryParts[D.summary_index]="concluded"):f[D.item_id].summaryParts[D.summary_index]="can-conclude":"response.completed"===(L=D).type||"response.incomplete"===L.type?(u=bC({finishReason:null==(I=D.response.incomplete_details)?void 0:I.reason,hasFunctionCall:h}),p.inputTokens=D.response.usage.input_tokens,p.outputTokens=D.response.usage.output_tokens,p.totalTokens=D.response.usage.input_tokens+D.response.usage.output_tokens,p.reasoningTokens=null!=(x=null==(S=D.response.usage.output_tokens_details)?void 0:S.reasoning_tokens)?x:void 0,p.cachedInputTokens=null!=(E=null==(T=D.response.usage.input_tokens_details)?void 0:T.cached_tokens)?E:void 0,"string"==typeof D.response.service_tier&&(t=D.response.service_tier)):"response.output_text.annotation.added"===D.type?(g.push(D.annotation),"url_citation"===D.annotation.type?a.enqueue({type:"source",sourceType:"url",id:null!=(z=null==(O=(A=l.config).generateId)?void 0:O.call(A))?z:(0,cy.generateId)(),url:D.annotation.url,title:D.annotation.title}):"file_citation"===D.annotation.type&&a.enqueue({type:"source",sourceType:"document",id:null!=(R=null==(P=(M=l.config).generateId)?void 0:P.call(M))?R:(0,cy.generateId)(),mediaType:"text/plain",title:null!=(j=null!=(C=D.annotation.quote)?C:D.annotation.filename)?j:"Document",filename:null!=(N=D.annotation.filename)?N:D.annotation.file_id,...D.annotation.file_id?{providerMetadata:{openai:{fileId:D.annotation.file_id}}}:{}})):b6(D)&&"message"===D.item.type?a.enqueue({type:"text-end",id:D.item.id,providerMetadata:{openai:{itemId:D.item.id,...g.length>0&&{annotations:g}}}}):"error"===D.type&&a.enqueue({type:"error",error:D})}},flush(e){let r={openai:{responseId:c}};d.length>0&&(r.openai.logprobs=d),void 0!==t&&(r.openai.serviceTier=t),e.enqueue({type:"finish",finishReason:u,usage:p,providerMetadata:r})}})),request:{body:r},response:{headers:i}}}};function b6(e){return"response.output_item.done"===e.type}function b7(e){return"response.output_item.added"===e.type}function b9(e){var t;switch(e.type){case"search":return{action:{type:"search",query:null!=(t=e.query)?t:void 0},...null!=e.sources&&{sources:e.sources}};case"open_page":return{action:{type:"openPage",url:e.url}};case"find":return{action:{type:"find",url:e.url,pattern:e.pattern}}}}var b8={codeInterpreter:(e={})=>bF(e),fileSearch:bK,imageGeneration:(e={})=>b3(e),webSearchPreview:bX};function we(e){return"v3"===e.specificationVersion}(function(e={}){var t;let r=()=>{let t={"api-key":(0,cy.loadApiKey)({apiKey:e.apiKey,environmentVariableName:"AZURE_API_KEY",description:"Azure OpenAI"}),...e.headers};return(0,cy.withUserAgentSuffix)(t,"ai-sdk/azure/2.0.74")},a=null!=(t=e.apiVersion)?t:"v1",s=({path:t,modelId:r})=>{var s;let n,i=null!=(s=e.baseURL)?s:`https://${(0,cy.loadSetting)({settingValue:e.resourceName,settingName:"resourceName",environmentVariableName:"AZURE_RESOURCE_NAME",description:"Azure OpenAI resource name"})}.openai.azure.com/openai`;return(n=new URL(e.useDeploymentBasedUrls?`${i}/deployments/${r}${t}`:`${i}/v1${t}`)).searchParams.set("api-version",a),n.toString()},n=t=>new bo(t,{provider:"azure.chat",url:s,headers:r,fetch:e.fetch}),i=t=>new bv(t,{provider:"azure.embeddings",headers:r,url:s,fetch:e.fetch}),o=t=>new b_(t,{provider:"azure.image",url:s,headers:r,fetch:e.fetch}),l=function(e){if(new.target)throw Error("The Azure OpenAI model function cannot be called with the new keyword.");return n(e)};l.languageModel=n,l.chat=n,l.completion=t=>new bh(t,{provider:"azure.completion",url:s,headers:r,fetch:e.fetch}),l.embedding=i,l.image=o,l.imageModel=o,l.textEmbedding=i,l.textEmbeddingModel=i,l.responses=t=>new b4(t,{provider:"azure.responses",url:s,headers:r,fetch:e.fetch,fileIdPrefixes:["assistant-"]}),l.transcription=t=>new bT(t,{provider:"azure.transcription",url:s,headers:r,fetch:e.fetch}),l.speech=t=>new bA(t,{provider:"azure.speech",url:s,headers:r,fetch:e.fetch}),l.tools=b8})(),cy.MastraModelGateway;var wt=[new cf.NetlifyGateway,new ch.ModelsDevGateway(Object.fromEntries(Object.entries(cc).filter(([e,t])=>"models.dev"===t.gateway)))],wr=class e{specificationVersion="v2";defaultObjectGenerationMode="json";supportsStructuredOutputs=!0;supportsImageUrls=!0;supportedUrls={};modelId;provider;config;gateway;constructor(e,t){let r;const a={...r="string"==typeof e?{id:e}:"providerId"in e&&"modelId"in e?{id:`${e.providerId}/${e.modelId}`,url:e.url,apiKey:e.apiKey,headers:e.headers}:{id:e.id,url:e.url,apiKey:e.apiKey,headers:e.headers},routerId:r.id};this.gateway=function(e,t){let r=t.find(t=>"models.dev"!==t.id&&(t.id===e||e.startsWith(`${t.id}/`)));if(r)return r;let a=t.find(e=>"models.dev"===e.id);if(a)return a;throw new eN.MastraError({id:"MODEL_ROUTER_NO_GATEWAY_FOUND",category:"USER",domain:"MODEL_ROUTER",text:`No Mastra model router gateway found for model id ${e}`})}(r.id,[...t||[],...wt]);const s="models.dev"===this.gateway.id?void 0:this.gateway.id,n=(0,ch.parseModelRouterId)(r.id,s);this.provider=n.providerId||"openai-compatible",n.providerId&&n.modelId!==r.id&&(a.id=n.modelId),this.modelId=a.id,this.config=a}async doGenerate(e){let t;try{t=this.config.url?this.config.apiKey||"":this.config.apiKey||await this.gateway.getApiKey(this.config.routerId)}catch(e){return{stream:new ReadableStream({start(t){t.enqueue({type:"error",error:e}),t.close()}})}}let r="models.dev"===this.gateway.id?void 0:this.gateway.id,a=await this.resolveLanguageModel({apiKey:t,headers:this.config.headers,...(0,ch.parseModelRouterId)(this.config.routerId,r)});return we(a)?new v8(a).doGenerate(e):new v9(a).doGenerate(e)}async doStream(e){let t;try{t=this.config.url?this.config.apiKey||"":this.config.apiKey||await this.gateway.getApiKey(this.config.routerId)}catch(e){return{stream:new ReadableStream({start(t){t.enqueue({type:"error",error:e}),t.close()}})}}let r="models.dev"===this.gateway.id?void 0:this.gateway.id,a=await this.resolveLanguageModel({apiKey:t,headers:this.config.headers,...(0,ch.parseModelRouterId)(this.config.routerId,r)});return we(a)?new v8(a).doStream(e):new v9(a).doStream(e)}async resolveLanguageModel({modelId:t,providerId:r,apiKey:a,headers:s}){let n=(0,cz.createHash)("sha256").update(this.gateway.id+t+r+a+(this.config.url||"")+(s?JSON.stringify(s):"")).digest("hex");if(e.modelInstances.has(n))return e.modelInstances.get(n);if(this.config.url){let s=(0,cy.createOpenAICompatible)({name:r,apiKey:a,baseURL:this.config.url,headers:this.config.headers,supportsStructuredOutputs:!0}).chatModel(t);return e.modelInstances.set(n,s),s}let i=await this.gateway.resolveLanguageModel({modelId:t,providerId:r,apiKey:a,headers:s});return e.modelInstances.set(n,i),i}static modelInstances=new Map};async function wa(e,t=new c_,r){var a;if("function"==typeof e&&(e=await e({requestContext:t,mastra:r})),e instanceof wr||e instanceof v9||e instanceof v8)return e;if("object"==typeof e&&"specificationVersion"in e)return"v2"===e.specificationVersion?new v9(e):"v3"===e.specificationVersion?new v8(e):e;let s=r?.listGateways(),n=s?Object.values(s):void 0;if("string"==typeof e||("object"!=typeof(a=e)||!("specificationVersion"in a))&&"object"==typeof a&&!("model"in a)&&("id"in a||"providerId"in a&&"modelId"in a))return new wr(e,n);throw Error("Invalid model configuration provided")}var ws=class{},wn=((_=wn||{}).ON_EVALUATION="onEvaluation",_.ON_GENERATION="onGeneration",_.ON_SCORER_RUN="onScorerRun",_),wi={all:I=I||new Map,on(e,t){let r=I.get(e);r?r.push(t):I.set(e,[t])},off(e,t){let r=I.get(e);r&&(t?r.splice(r.indexOf(t)>>>0,1):I.set(e,[]))},emit(e,t){let r=I.get(e);r&&r.slice().map(e=>{e(t)}),(r=I.get("*"))&&r.slice().map(r=>{r(e,t)})}},wo=eL;e.i(550809);var sg=eF,wl=cv,wu=e.i(427699);let wp=e=>{try{return Number(e)===e}catch{return!1}};var wd=e.i(193484),wc=Object.defineProperty,wm=class{specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(e,t){for(const[t,r]of(this.patStr=e.pat_str,Object.entries(e.bpe_ranks.split("\n").filter(Boolean).reduce((e,t)=>{let[r,a,...s]=t.split(" "),n=Number.parseInt(a,10);return s.forEach((t,r)=>e[t]=n+r),e},{})))){const e=wd.default.toByteArray(t);this.rankMap.set(e.join(","),r),this.textMap.set(r,e)}this.specialTokens={...e.special_tokens,...t},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((e,[t,r])=>(e[r]=this.textEncoder.encode(t),e),{})}encode(e,t=[],r="all"){let a=RegExp(this.patStr,"ug"),s=wm.specialTokenRegex(Object.keys(this.specialTokens)),n=[],i=new Set("all"===t?Object.keys(this.specialTokens):t),o=new Set("all"===r?Object.keys(this.specialTokens).filter(e=>!i.has(e)):r);if(o.size>0){let t=wm.specialTokenRegex([...o]),r=e.match(t);if(null!=r)throw Error(`The text contains a special token that is not allowed: ${r[0]}`)}let l=0;for(;;){let t=null,r=l;for(;s.lastIndex=r,!(null==(t=s.exec(e))||i.has(t[0]));)r=t.index+1;let o=t?.index??e.length;for(let t of e.substring(l,o).matchAll(a)){let e=this.textEncoder.encode(t[0]),r=this.rankMap.get(e.join(","));if(null!=r){n.push(r);continue}n.push(...function(e,t){return 1===e.length?[t.get(e.join(","))]:(function(e,t){let r=Array.from({length:e.length},(e,t)=>({start:t,end:t+1}));for(;r.length>1;){let a=null;for(let s=0;s<r.length-1;s++){let n=e.slice(r[s].start,r[s+1].end),i=t.get(n.join(","));null!=i&&(null==a||i<a[0])&&(a=[i,s])}if(null!=a){let e=a[1];r[e]={start:r[e].start,end:r[e+1].end},r.splice(e+1,1)}else break}return r})(e,t).map(r=>t.get(e.slice(r.start,r.end).join(","))).filter(e=>null!=e)}(e,this.rankMap))}if(null==t)break;let u=this.specialTokens[t[0]];n.push(u),l=t.index+t[0].length}return n}decode(e){let t=[],r=0;for(let a=0;a<e.length;++a){let s=e[a],n=this.textMap.get(s)??this.inverseSpecialTokens[s];null!=n&&(t.push(n),r+=n.length)}let a=new Uint8Array(r),s=0;for(let e of t)a.set(e,s),s+=e.length;return this.textDecoder.decode(a)}};S="specialTokenRegex",x=e=>RegExp(e.map(e=>e.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")).join("|"),"g"),(u="symbol"!=typeof S?S+"":S)in wm?wc(wm,u,{enumerable:!0,configurable:!0,writable:!0,value:x}):wm[u]=x;new Uint8Array([0,97,115,109,1,0,0,0,1,48,8,96,3,127,127,127,1,127,96,3,127,127,127,0,96,2,127,127,0,96,1,127,1,127,96,3,127,127,126,1,126,96,3,126,127,127,1,126,96,2,127,126,0,96,1,127,1,126,3,11,10,0,0,2,1,3,4,5,6,1,7,5,3,1,0,1,7,85,9,3,109,101,109,2,0,5,120,120,104,51,50,0,0,6,105,110,105,116,51,50,0,2,8,117,112,100,97,116,101,51,50,0,3,8,100,105,103,101,115,116,51,50,0,4,5,120,120,104,54,52,0,5,6,105,110,105,116,54,52,0,7,8,117,112,100,97,116,101,54,52,0,8,8,100,105,103,101,115,116,54,52,0,9,10,251,22,10,242,1,1,4,127,32,0,32,1,106,33,3,32,1,65,16,79,4,127,32,3,65,16,107,33,6,32,2,65,168,136,141,161,2,106,33,3,32,2,65,137,235,208,208,7,107,33,4,32,2,65,207,140,162,142,6,106,33,5,3,64,32,3,32,0,40,2,0,65,247,148,175,175,120,108,106,65,13,119,65,177,243,221,241,121,108,33,3,32,4,32,0,65,4,106,34,0,40,2,0,65,247,148,175,175,120,108,106,65,13,119,65,177,243,221,241,121,108,33,4,32,2,32,0,65,4,106,34,0,40,2,0,65,247,148,175,175,120,108,106,65,13,119,65,177,243,221,241,121,108,33,2,32,5,32,0,65,4,106,34,0,40,2,0,65,247,148,175,175,120,108,106,65,13,119,65,177,243,221,241,121,108,33,5,32,6,32,0,65,4,106,34,0,79,13,0,11,32,2,65,12,119,32,5,65,18,119,106,32,4,65,7,119,106,32,3,65,1,119,106,5,32,2,65,177,207,217,178,1,106,11,32,1,106,32,0,32,1,65,15,113,16,1,11,146,1,0,32,1,32,2,106,33,2,3,64,32,1,65,4,106,32,2,75,69,4,64,32,0,32,1,40,2,0,65,189,220,202,149,124,108,106,65,17,119,65,175,214,211,190,2,108,33,0,32,1,65,4,106,33,1,12,1,11,11,3,64,32,1,32,2,79,69,4,64,32,0,32,1,45,0,0,65,177,207,217,178,1,108,106,65,11,119,65,177,243,221,241,121,108,33,0,32,1,65,1,106,33,1,12,1,11,11,32,0,32,0,65,15,118,115,65,247,148,175,175,120,108,34,0,65,13,118,32,0,115,65,189,220,202,149,124,108,34,0,65,16,118,32,0,115,11,63,0,32,0,65,8,106,32,1,65,168,136,141,161,2,106,54,2,0,32,0,65,12,106,32,1,65,137,235,208,208,7,107,54,2,0,32,0,65,16,106,32,1,54,2,0,32,0,65,20,106,32,1,65,207,140,162,142,6,106,54,2,0,11,195,4,1,6,127,32,1,32,2,106,33,6,32,0,65,24,106,33,4,32,0,65,40,106,40,2,0,33,3,32,0,32,0,40,2,0,32,2,106,54,2,0,32,0,65,4,106,34,5,32,5,40,2,0,32,2,65,16,79,32,0,40,2,0,65,16,79,114,114,54,2,0,32,2,32,3,106,65,16,73,4,64,32,3,32,4,106,32,1,32,2,252,10,0,0,32,0,65,40,106,32,2,32,3,106,54,2,0,15,11,32,3,4,64,32,3,32,4,106,32,1,65,16,32,3,107,34,2,252,10,0,0,32,0,65,8,106,34,3,32,3,40,2,0,32,4,40,2,0,65,247,148,175,175,120,108,106,65,13,119,65,177,243,221,241,121,108,54,2,0,32,0,65,12,106,34,3,32,3,40,2,0,32,4,65,4,106,40,2,0,65,247,148,175,175,120,108,106,65,13,119,65,177,243,221,241,121,108,54,2,0,32,0,65,16,106,34,3,32,3,40,2,0,32,4,65,8,106,40,2,0,65,247,148,175,175,120,108,106,65,13,119,65,177,243,221,241,121,108,54,2,0,32,0,65,20,106,34,3,32,3,40,2,0,32,4,65,12,106,40,2,0,65,247,148,175,175,120,108,106,65,13,119,65,177,243,221,241,121,108,54,2,0,32,0,65,40,106,65,0,54,2,0,32,1,32,2,106,33,1,11,32,1,32,6,65,16,107,77,4,64,32,6,65,16,107,33,8,32,0,65,8,106,40,2,0,33,2,32,0,65,12,106,40,2,0,33,3,32,0,65,16,106,40,2,0,33,5,32,0,65,20,106,40,2,0,33,7,3,64,32,2,32,1,40,2,0,65,247,148,175,175,120,108,106,65,13,119,65,177,243,221,241,121,108,33,2,32,3,32,1,65,4,106,34,1,40,2,0,65,247,148,175,175,120,108,106,65,13,119,65,177,243,221,241,121,108,33,3,32,5,32,1,65,4,106,34,1,40,2,0,65,247,148,175,175,120,108,106,65,13,119,65,177,243,221,241,121,108,33,5,32,7,32,1,65,4,106,34,1,40,2,0,65,247,148,175,175,120,108,106,65,13,119,65,177,243,221,241,121,108,33,7,32,8,32,1,65,4,106,34,1,79,13,0,11,32,0,65,8,106,32,2,54,2,0,32,0,65,12,106,32,3,54,2,0,32,0,65,16,106,32,5,54,2,0,32,0,65,20,106,32,7,54,2,0,11,32,1,32,6,73,4,64,32,4,32,1,32,6,32,1,107,34,1,252,10,0,0,32,0,65,40,106,32,1,54,2,0,11,11,97,1,1,127,32,0,65,16,106,40,2,0,33,1,32,0,65,4,106,40,2,0,4,127,32,1,65,12,119,32,0,65,20,106,40,2,0,65,18,119,106,32,0,65,12,106,40,2,0,65,7,119,106,32,0,65,8,106,40,2,0,65,1,119,106,5,32,1,65,177,207,217,178,1,106,11,32,0,40,2,0,106,32,0,65,24,106,32,0,65,40,106,40,2,0,16,1,11,255,3,2,3,126,1,127,32,0,32,1,106,33,6,32,1,65,32,79,4,126,32,6,65,32,107,33,6,32,2,66,214,235,130,238,234,253,137,245,224,0,124,33,3,32,2,66,177,169,172,193,173,184,212,166,61,125,33,4,32,2,66,249,234,208,208,231,201,161,228,225,0,124,33,5,3,64,32,3,32,0,41,3,0,66,207,214,211,190,210,199,171,217,66,126,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,33,3,32,4,32,0,65,8,106,34,0,41,3,0,66,207,214,211,190,210,199,171,217,66,126,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,33,4,32,2,32,0,65,8,106,34,0,41,3,0,66,207,214,211,190,210,199,171,217,66,126,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,33,2,32,5,32,0,65,8,106,34,0,41,3,0,66,207,214,211,190,210,199,171,217,66,126,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,33,5,32,6,32,0,65,8,106,34,0,79,13,0,11,32,2,66,12,137,32,5,66,18,137,124,32,4,66,7,137,124,32,3,66,1,137,124,32,3,66,207,214,211,190,210,199,171,217,66,126,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,133,66,135,149,175,175,152,182,222,155,158,127,126,66,157,163,181,234,131,177,141,138,250,0,125,32,4,66,207,214,211,190,210,199,171,217,66,126,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,133,66,135,149,175,175,152,182,222,155,158,127,126,66,157,163,181,234,131,177,141,138,250,0,125,32,2,66,207,214,211,190,210,199,171,217,66,126,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,133,66,135,149,175,175,152,182,222,155,158,127,126,66,157,163,181,234,131,177,141,138,250,0,125,32,5,66,207,214,211,190,210,199,171,217,66,126,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,133,66,135,149,175,175,152,182,222,155,158,127,126,66,157,163,181,234,131,177,141,138,250,0,125,5,32,2,66,197,207,217,178,241,229,186,234,39,124,11,32,1,173,124,32,0,32,1,65,31,113,16,6,11,134,2,0,32,1,32,2,106,33,2,3,64,32,2,32,1,65,8,106,79,4,64,32,1,41,3,0,66,207,214,211,190,210,199,171,217,66,126,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,32,0,133,66,27,137,66,135,149,175,175,152,182,222,155,158,127,126,66,157,163,181,234,131,177,141,138,250,0,125,33,0,32,1,65,8,106,33,1,12,1,11,11,32,1,65,4,106,32,2,77,4,64,32,0,32,1,53,2,0,66,135,149,175,175,152,182,222,155,158,127,126,133,66,23,137,66,207,214,211,190,210,199,171,217,66,126,66,249,243,221,241,153,246,153,171,22,124,33,0,32,1,65,4,106,33,1,11,3,64,32,1,32,2,73,4,64,32,0,32,1,49,0,0,66,197,207,217,178,241,229,186,234,39,126,133,66,11,137,66,135,149,175,175,152,182,222,155,158,127,126,33,0,32,1,65,1,106,33,1,12,1,11,11,32,0,32,0,66,33,136,133,66,207,214,211,190,210,199,171,217,66,126,34,0,32,0,66,29,136,133,66,249,243,221,241,153,246,153,171,22,126,34,0,32,0,66,32,136,133,11,77,0,32,0,65,8,106,32,1,66,214,235,130,238,234,253,137,245,224,0,124,55,3,0,32,0,65,16,106,32,1,66,177,169,172,193,173,184,212,166,61,125,55,3,0,32,0,65,24,106,32,1,55,3,0,32,0,65,32,106,32,1,66,249,234,208,208,231,201,161,228,225,0,124,55,3,0,11,244,4,2,3,127,4,126,32,1,32,2,106,33,5,32,0,65,40,106,33,4,32,0,65,200,0,106,40,2,0,33,3,32,0,32,0,41,3,0,32,2,173,124,55,3,0,32,2,32,3,106,65,32,73,4,64,32,3,32,4,106,32,1,32,2,252,10,0,0,32,0,65,200,0,106,32,2,32,3,106,54,2,0,15,11,32,3,4,64,32,3,32,4,106,32,1,65,32,32,3,107,34,2,252,10,0,0,32,0,65,8,106,34,3,32,3,41,3,0,32,4,41,3,0,66,207,214,211,190,210,199,171,217,66,126,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,55,3,0,32,0,65,16,106,34,3,32,3,41,3,0,32,4,65,8,106,41,3,0,66,207,214,211,190,210,199,171,217,66,126,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,55,3,0,32,0,65,24,106,34,3,32,3,41,3,0,32,4,65,16,106,41,3,0,66,207,214,211,190,210,199,171,217,66,126,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,55,3,0,32,0,65,32,106,34,3,32,3,41,3,0,32,4,65,24,106,41,3,0,66,207,214,211,190,210,199,171,217,66,126,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,55,3,0,32,0,65,200,0,106,65,0,54,2,0,32,1,32,2,106,33,1,11,32,1,65,32,106,32,5,77,4,64,32,5,65,32,107,33,2,32,0,65,8,106,41,3,0,33,6,32,0,65,16,106,41,3,0,33,7,32,0,65,24,106,41,3,0,33,8,32,0,65,32,106,41,3,0,33,9,3,64,32,6,32,1,41,3,0,66,207,214,211,190,210,199,171,217,66,126,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,33,6,32,7,32,1,65,8,106,34,1,41,3,0,66,207,214,211,190,210,199,171,217,66,126,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,33,7,32,8,32,1,65,8,106,34,1,41,3,0,66,207,214,211,190,210,199,171,217,66,126,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,33,8,32,9,32,1,65,8,106,34,1,41,3,0,66,207,214,211,190,210,199,171,217,66,126,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,33,9,32,2,32,1,65,8,106,34,1,79,13,0,11,32,0,65,8,106,32,6,55,3,0,32,0,65,16,106,32,7,55,3,0,32,0,65,24,106,32,8,55,3,0,32,0,65,32,106,32,9,55,3,0,11,32,1,32,5,73,4,64,32,4,32,1,32,5,32,1,107,34,1,252,10,0,0,32,0,65,200,0,106,32,1,54,2,0,11,11,188,2,1,5,126,32,0,65,24,106,41,3,0,33,1,32,0,41,3,0,34,2,66,32,90,4,126,32,0,65,8,106,41,3,0,34,3,66,1,137,32,0,65,16,106,41,3,0,34,4,66,7,137,124,32,1,66,12,137,32,0,65,32,106,41,3,0,34,5,66,18,137,124,124,32,3,66,207,214,211,190,210,199,171,217,66,126,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,133,66,135,149,175,175,152,182,222,155,158,127,126,66,157,163,181,234,131,177,141,138,250,0,125,32,4,66,207,214,211,190,210,199,171,217,66,126,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,133,66,135,149,175,175,152,182,222,155,158,127,126,66,157,163,181,234,131,177,141,138,250,0,125,32,1,66,207,214,211,190,210,199,171,217,66,126,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,133,66,135,149,175,175,152,182,222,155,158,127,126,66,157,163,181,234,131,177,141,138,250,0,125,32,5,66,207,214,211,190,210,199,171,217,66,126,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,133,66,135,149,175,175,152,182,222,155,158,127,126,66,157,163,181,234,131,177,141,138,250,0,125,5,32,1,66,197,207,217,178,241,229,186,234,39,124,11,32,2,124,32,0,65,40,106,32,2,66,31,131,167,16,6,11]);let wg="object"==typeof performance&&performance&&"function"==typeof performance.now?performance:Date,wh=new Set,wf="object"==typeof process&&process?process:{},wy=(e,t,r,a)=>{"function"==typeof wf.emitWarning?wf.emitWarning(e,t,r,a):console.error(`[${r}] ${t}: ${e}`)},wv=globalThis.AbortController,wb=globalThis.AbortSignal;if(void 0===wv){wb=class{onabort;_onabort=[];reason;aborted=!1;addEventListener(e,t){this._onabort.push(t)}},wv=class{constructor(){t()}signal=new wb;abort(e){if(!this.signal.aborted){for(let t of(this.signal.reason=e,this.signal.aborted=!0,this.signal._onabort))t(e);this.signal.onabort?.(e)}}};let e=wf.env?.LRU_CACHE_IGNORE_AC_WARNING!=="1",t=()=>{e&&(e=!1,wy("AbortController is not defined. If using lru-cache in node 14, load an AbortController polyfill from the `node-abort-controller` package. A minimal polyfill is provided for use by LRUCache.fetch(), but it should not be relied upon in other contexts (eg, passing it to other APIs that use AbortController/AbortSignal might have undesirable effects). You may disable this with LRU_CACHE_IGNORE_AC_WARNING=1 in the env.","NO_ABORT_CONTROLLER","ENOTSUP",t))}}Symbol("type");let ww=e=>e&&e===Math.floor(e)&&e>0&&isFinite(e),wk=e=>ww(e)?e<=256?Uint8Array:e<=65536?Uint16Array:e<=0x100000000?Uint32Array:e<=Number.MAX_SAFE_INTEGER?w_:null:null;class w_ extends Array{constructor(e){super(e),this.fill(0)}}class wI{heap;length;static #a=!1;static create(e){let t=wk(e);if(!t)return[];wI.#a=!0;let r=new wI(e,t);return wI.#a=!1,r}constructor(e,t){if(!wI.#a)throw TypeError("instantiate Stack using Stack.create(n)");this.heap=new t(e),this.length=0}push(e){this.heap[this.length++]=e}pop(){return this.heap[--this.length]}}class wS{#s;#n;#i;#o;#l;#u;#p;#d;get perf(){return this.#d}ttl;ttlResolution;ttlAutopurge;updateAgeOnGet;updateAgeOnHas;allowStale;noDisposeOnSet;noUpdateTTL;maxEntrySize;sizeCalculation;noDeleteOnFetchRejection;noDeleteOnStaleGet;allowStaleOnFetchAbort;allowStaleOnFetchRejection;ignoreFetchAbort;#c;#m;#g;#h;#f;#y;#v;#b;#w;#k;#_;#I;#S;#x;#T;#E;#A;#O;#z;static unsafeExposeInternals(e){return{starts:e.#S,ttls:e.#x,autopurgeTimers:e.#T,sizes:e.#I,keyMap:e.#g,keyList:e.#h,valList:e.#f,next:e.#y,prev:e.#v,get head(){return e.#b},get tail(){return e.#w},free:e.#k,isBackgroundFetch:t=>e.#M(t),backgroundFetch:(t,r,a,s)=>e.#P(t,r,a,s),moveToTail:t=>e.#R(t),indexes:t=>e.#C(t),rindexes:t=>e.#j(t),isStale:t=>e.#N(t)}}get max(){return this.#s}get maxSize(){return this.#n}get calculatedSize(){return this.#m}get size(){return this.#c}get fetchMethod(){return this.#u}get memoMethod(){return this.#p}get dispose(){return this.#i}get onInsert(){return this.#o}get disposeAfter(){return this.#l}constructor(e){const{max:t=0,ttl:r,ttlResolution:a=1,ttlAutopurge:s,updateAgeOnGet:n,updateAgeOnHas:i,allowStale:o,dispose:l,onInsert:u,disposeAfter:p,noDisposeOnSet:d,noUpdateTTL:c,maxSize:m=0,maxEntrySize:g=0,sizeCalculation:h,fetchMethod:f,memoMethod:y,noDeleteOnFetchRejection:v,noDeleteOnStaleGet:b,allowStaleOnFetchRejection:w,allowStaleOnFetchAbort:k,ignoreFetchAbort:_,perf:I}=e;if(void 0!==I&&"function"!=typeof I?.now)throw TypeError("perf option must have a now() method if specified");if(this.#d=I??wg,0!==t&&!ww(t))throw TypeError("max option must be a nonnegative integer");const S=t?wk(t):Array;if(!S)throw Error("invalid max value: "+t);if(this.#s=t,this.#n=m,this.maxEntrySize=g||this.#n,this.sizeCalculation=h,this.sizeCalculation){if(!this.#n&&!this.maxEntrySize)throw TypeError("cannot set sizeCalculation without setting maxSize or maxEntrySize");if("function"!=typeof this.sizeCalculation)throw TypeError("sizeCalculation set to non-function")}if(void 0!==y&&"function"!=typeof y)throw TypeError("memoMethod must be a function if defined");if(this.#p=y,void 0!==f&&"function"!=typeof f)throw TypeError("fetchMethod must be a function if specified");if(this.#u=f,this.#A=!!f,this.#g=new Map,this.#h=Array(t).fill(void 0),this.#f=Array(t).fill(void 0),this.#y=new S(t),this.#v=new S(t),this.#b=0,this.#w=0,this.#k=wI.create(t),this.#c=0,this.#m=0,"function"==typeof l&&(this.#i=l),"function"==typeof u&&(this.#o=u),"function"==typeof p?(this.#l=p,this.#_=[]):(this.#l=void 0,this.#_=void 0),this.#E=!!this.#i,this.#z=!!this.#o,this.#O=!!this.#l,this.noDisposeOnSet=!!d,this.noUpdateTTL=!!c,this.noDeleteOnFetchRejection=!!v,this.allowStaleOnFetchRejection=!!w,this.allowStaleOnFetchAbort=!!k,this.ignoreFetchAbort=!!_,0!==this.maxEntrySize){if(0!==this.#n&&!ww(this.#n))throw TypeError("maxSize must be a positive integer if specified");if(!ww(this.maxEntrySize))throw TypeError("maxEntrySize must be a positive integer if specified");this.#L()}if(this.allowStale=!!o,this.noDeleteOnStaleGet=!!b,this.updateAgeOnGet=!!n,this.updateAgeOnHas=!!i,this.ttlResolution=ww(a)||0===a?a:1,this.ttlAutopurge=!!s,this.ttl=r||0,this.ttl){if(!ww(this.ttl))throw TypeError("ttl must be a positive integer if specified");this.#D()}if(0===this.#s&&0===this.ttl&&0===this.#n)throw TypeError("At least one of max, maxSize, or ttl is required");if(!this.ttlAutopurge&&!this.#s&&!this.#n){const e="LRU_CACHE_UNBOUNDED";wh.has(e)||(wh.add(e),wy("TTL caching without ttlAutopurge, max, or maxSize can result in unbounded memory consumption.","UnboundedCacheWarning",e,wS))}}getRemainingTTL(e){return this.#g.has(e)?1/0:0}#D(){let e=new w_(this.#s),t=new w_(this.#s);this.#x=e,this.#S=t;let r=this.ttlAutopurge?Array(this.#s):void 0;this.#T=r,this.#q=(a,s,n=this.#d.now())=>{if(t[a]=0!==s?n:0,e[a]=s,r?.[a]&&(clearTimeout(r[a]),r[a]=void 0),0!==s&&r){let e=setTimeout(()=>{this.#N(a)&&this.#$(this.#h[a],"expire")},s+1);e.unref&&e.unref(),r[a]=e}},this.#F=r=>{t[r]=0!==e[r]?this.#d.now():0},this.#U=(r,n)=>{if(e[n]){let i=e[n],o=t[n];if(!i||!o)return;r.ttl=i,r.start=o,r.now=a||s();let l=r.now-o;r.remainingTTL=i-l}};let a=0,s=()=>{let e=this.#d.now();if(this.ttlResolution>0){a=e;let t=setTimeout(()=>a=0,this.ttlResolution);t.unref&&t.unref()}return e};this.getRemainingTTL=r=>{let n=this.#g.get(r);if(void 0===n)return 0;let i=e[n],o=t[n];return i&&o?i-((a||s())-o):1/0},this.#N=r=>{let n=t[r],i=e[r];return!!i&&!!n&&(a||s())-n>i}}#F=()=>{};#U=()=>{};#q=()=>{};#N=()=>!1;#L(){let e=new w_(this.#s);this.#m=0,this.#I=e,this.#Z=t=>{this.#m-=e[t],e[t]=0},this.#B=(e,t,r,a)=>{if(this.#M(t))return 0;if(!ww(r))if(a){if("function"!=typeof a)throw TypeError("sizeCalculation must be a function");if(!ww(r=a(t,e)))throw TypeError("sizeCalculation return invalid (expect positive integer)")}else throw TypeError("invalid size value (must be positive integer). When maxSize or maxEntrySize is used, sizeCalculation or size must be set.");return r},this.#V=(t,r,a)=>{if(e[t]=r,this.#n){let r=this.#n-e[t];for(;this.#m>r;)this.#K(!0)}this.#m+=e[t],a&&(a.entrySize=r,a.totalCalculatedSize=this.#m)}}#Z=e=>{};#V=(e,t,r)=>{};#B=(e,t,r,a)=>{if(r||a)throw TypeError("cannot set size without setting maxSize or maxEntrySize on cache");return 0};*#C({allowStale:e=this.allowStale}={}){if(this.#c)for(let t=this.#w;this.#G(t)&&((e||!this.#N(t))&&(yield t),t!==this.#b);)t=this.#v[t]}*#j({allowStale:e=this.allowStale}={}){if(this.#c)for(let t=this.#b;this.#G(t)&&((e||!this.#N(t))&&(yield t),t!==this.#w);)t=this.#y[t]}#G(e){return void 0!==e&&this.#g.get(this.#h[e])===e}*entries(){for(let e of this.#C())void 0===this.#f[e]||void 0===this.#h[e]||this.#M(this.#f[e])||(yield[this.#h[e],this.#f[e]])}*rentries(){for(let e of this.#j())void 0===this.#f[e]||void 0===this.#h[e]||this.#M(this.#f[e])||(yield[this.#h[e],this.#f[e]])}*keys(){for(let e of this.#C()){let t=this.#h[e];void 0===t||this.#M(this.#f[e])||(yield t)}}*rkeys(){for(let e of this.#j()){let t=this.#h[e];void 0===t||this.#M(this.#f[e])||(yield t)}}*values(){for(let e of this.#C())void 0===this.#f[e]||this.#M(this.#f[e])||(yield this.#f[e])}*rvalues(){for(let e of this.#j())void 0===this.#f[e]||this.#M(this.#f[e])||(yield this.#f[e])}[Symbol.iterator](){return this.entries()}[Symbol.toStringTag]="LRUCache";find(e,t={}){for(let r of this.#C()){let a=this.#f[r],s=this.#M(a)?a.__staleWhileFetching:a;if(void 0!==s&&e(s,this.#h[r],this))return this.get(this.#h[r],t)}}forEach(e,t=this){for(let r of this.#C()){let a=this.#f[r],s=this.#M(a)?a.__staleWhileFetching:a;void 0!==s&&e.call(t,s,this.#h[r],this)}}rforEach(e,t=this){for(let r of this.#j()){let a=this.#f[r],s=this.#M(a)?a.__staleWhileFetching:a;void 0!==s&&e.call(t,s,this.#h[r],this)}}purgeStale(){let e=!1;for(let t of this.#j({allowStale:!0}))this.#N(t)&&(this.#$(this.#h[t],"expire"),e=!0);return e}info(e){let t=this.#g.get(e);if(void 0===t)return;let r=this.#f[t],a=this.#M(r)?r.__staleWhileFetching:r;if(void 0===a)return;let s={value:a};if(this.#x&&this.#S){let e=this.#x[t],r=this.#S[t];e&&r&&(s.ttl=e-(this.#d.now()-r),s.start=Date.now())}return this.#I&&(s.size=this.#I[t]),s}dump(){let e=[];for(let t of this.#C({allowStale:!0})){let r=this.#h[t],a=this.#f[t],s=this.#M(a)?a.__staleWhileFetching:a;if(void 0===s||void 0===r)continue;let n={value:s};if(this.#x&&this.#S){n.ttl=this.#x[t];let e=this.#d.now()-this.#S[t];n.start=Math.floor(Date.now()-e)}this.#I&&(n.size=this.#I[t]),e.unshift([r,n])}return e}load(e){for(let[t,r]of(this.clear(),e)){if(r.start){let e=Date.now()-r.start;r.start=this.#d.now()-e}this.set(t,r.value,r)}}set(e,t,r={}){if(void 0===t)return this.delete(e),this;let{ttl:a=this.ttl,start:s,noDisposeOnSet:n=this.noDisposeOnSet,sizeCalculation:i=this.sizeCalculation,status:o}=r,{noUpdateTTL:l=this.noUpdateTTL}=r,u=this.#B(e,t,r.size||0,i);if(this.maxEntrySize&&u>this.maxEntrySize)return o&&(o.set="miss",o.maxEntrySizeExceeded=!0),this.#$(e,"set"),this;let p=0===this.#c?void 0:this.#g.get(e);if(void 0===p)p=0===this.#c?this.#w:0!==this.#k.length?this.#k.pop():this.#c===this.#s?this.#K(!1):this.#c,this.#h[p]=e,this.#f[p]=t,this.#g.set(e,p),this.#y[this.#w]=p,this.#v[p]=this.#w,this.#w=p,this.#c++,this.#V(p,u,o),o&&(o.set="add"),l=!1,this.#z&&this.#o?.(t,e,"add");else{this.#R(p);let r=this.#f[p];if(t!==r){if(this.#A&&this.#M(r)){r.__abortController.abort(Error("replaced"));let{__staleWhileFetching:t}=r;void 0!==t&&!n&&(this.#E&&this.#i?.(t,e,"set"),this.#O&&this.#_?.push([t,e,"set"]))}else!n&&(this.#E&&this.#i?.(r,e,"set"),this.#O&&this.#_?.push([r,e,"set"]));if(this.#Z(p),this.#V(p,u,o),this.#f[p]=t,o){o.set="replace";let e=r&&this.#M(r)?r.__staleWhileFetching:r;void 0!==e&&(o.oldValue=e)}}else o&&(o.set="update");this.#z&&this.onInsert?.(t,e,t===r?"update":"replace")}if(0===a||this.#x||this.#D(),this.#x&&(l||this.#q(p,a,s),o&&this.#U(o,p)),!n&&this.#O&&this.#_){let e,t=this.#_;for(;e=t?.shift();)this.#l?.(...e)}return this}pop(){try{for(;this.#c;){let e=this.#f[this.#b];if(this.#K(!0),this.#M(e)){if(e.__staleWhileFetching)return e.__staleWhileFetching}else if(void 0!==e)return e}}finally{if(this.#O&&this.#_){let e,t=this.#_;for(;e=t?.shift();)this.#l?.(...e)}}}#K(e){let t=this.#b,r=this.#h[t],a=this.#f[t];return this.#A&&this.#M(a)?a.__abortController.abort(Error("evicted")):(this.#E||this.#O)&&(this.#E&&this.#i?.(a,r,"evict"),this.#O&&this.#_?.push([a,r,"evict"])),this.#Z(t),this.#T?.[t]&&(clearTimeout(this.#T[t]),this.#T[t]=void 0),e&&(this.#h[t]=void 0,this.#f[t]=void 0,this.#k.push(t)),1===this.#c?(this.#b=this.#w=0,this.#k.length=0):this.#b=this.#y[t],this.#g.delete(r),this.#c--,t}has(e,t={}){let{updateAgeOnHas:r=this.updateAgeOnHas,status:a}=t,s=this.#g.get(e);if(void 0!==s){let e=this.#f[s];if(this.#M(e)&&void 0===e.__staleWhileFetching)return!1;if(!this.#N(s))return r&&this.#F(s),a&&(a.has="hit",this.#U(a,s)),!0;a&&(a.has="stale",this.#U(a,s))}else a&&(a.has="miss");return!1}peek(e,t={}){let{allowStale:r=this.allowStale}=t,a=this.#g.get(e);if(void 0===a||!r&&this.#N(a))return;let s=this.#f[a];return this.#M(s)?s.__staleWhileFetching:s}#P(e,t,r,a){let s=void 0===t?void 0:this.#f[t];if(this.#M(s))return s;let n=new wv,{signal:i}=r;i?.addEventListener("abort",()=>n.abort(i.reason),{signal:n.signal});let o={signal:n.signal,options:r,context:a},l=(a,s=!1)=>{let{aborted:i}=n.signal,l=r.ignoreFetchAbort&&void 0!==a,p=r.ignoreFetchAbort||!!(r.allowStaleOnFetchAbort&&void 0!==a);if(r.status&&(i&&!s?(r.status.fetchAborted=!0,r.status.fetchError=n.signal.reason,l&&(r.status.fetchAbortIgnored=!0)):r.status.fetchResolved=!0),i&&!l&&!s)return u(n.signal.reason,p);let c=this.#f[t];return(c===d||l&&s&&void 0===c)&&(void 0===a?void 0!==d.__staleWhileFetching?this.#f[t]=d.__staleWhileFetching:this.#$(e,"fetch"):(r.status&&(r.status.fetchUpdated=!0),this.set(e,a,o.options))),a},u=(a,s)=>{let{aborted:i}=n.signal,o=i&&r.allowStaleOnFetchAbort,l=o||r.allowStaleOnFetchRejection,u=l||r.noDeleteOnFetchRejection;if(this.#f[t]===d&&(u&&(s||void 0!==d.__staleWhileFetching)?o||(this.#f[t]=d.__staleWhileFetching):this.#$(e,"fetch")),l)return r.status&&void 0!==d.__staleWhileFetching&&(r.status.returnedStale=!0),d.__staleWhileFetching;if(d.__returned===d)throw a},p=(t,a)=>{let i=this.#u?.(e,s,o);i&&i instanceof Promise&&i.then(e=>t(void 0===e?void 0:e),a),n.signal.addEventListener("abort",()=>{(!r.ignoreFetchAbort||r.allowStaleOnFetchAbort)&&(t(void 0),r.allowStaleOnFetchAbort&&(t=e=>l(e,!0)))})};r.status&&(r.status.fetchDispatched=!0);let d=new Promise(p).then(l,e=>(r.status&&(r.status.fetchRejected=!0,r.status.fetchError=e),u(e,!1))),c=Object.assign(d,{__abortController:n,__staleWhileFetching:s,__returned:void 0});return void 0===t?(this.set(e,c,{...o.options,status:void 0}),t=this.#g.get(e)):this.#f[t]=c,c}#M(e){return!!this.#A&&!!e&&e instanceof Promise&&e.hasOwnProperty("__staleWhileFetching")&&e.__abortController instanceof wv}async fetch(e,t={}){let{allowStale:r=this.allowStale,updateAgeOnGet:a=this.updateAgeOnGet,noDeleteOnStaleGet:s=this.noDeleteOnStaleGet,ttl:n=this.ttl,noDisposeOnSet:i=this.noDisposeOnSet,size:o=0,sizeCalculation:l=this.sizeCalculation,noUpdateTTL:u=this.noUpdateTTL,noDeleteOnFetchRejection:p=this.noDeleteOnFetchRejection,allowStaleOnFetchRejection:d=this.allowStaleOnFetchRejection,ignoreFetchAbort:c=this.ignoreFetchAbort,allowStaleOnFetchAbort:m=this.allowStaleOnFetchAbort,context:g,forceRefresh:h=!1,status:f,signal:y}=t;if(!this.#A)return f&&(f.fetch="get"),this.get(e,{allowStale:r,updateAgeOnGet:a,noDeleteOnStaleGet:s,status:f});let v={allowStale:r,updateAgeOnGet:a,noDeleteOnStaleGet:s,ttl:n,noDisposeOnSet:i,size:o,sizeCalculation:l,noUpdateTTL:u,noDeleteOnFetchRejection:p,allowStaleOnFetchRejection:d,allowStaleOnFetchAbort:m,ignoreFetchAbort:c,status:f,signal:y},b=this.#g.get(e);if(void 0===b){f&&(f.fetch="miss");let t=this.#P(e,b,v,g);return t.__returned=t}{let t=this.#f[b];if(this.#M(t)){let e=r&&void 0!==t.__staleWhileFetching;return f&&(f.fetch="inflight",e&&(f.returnedStale=!0)),e?t.__staleWhileFetching:t.__returned=t}let s=this.#N(b);if(!h&&!s)return f&&(f.fetch="hit"),this.#R(b),a&&this.#F(b),f&&this.#U(f,b),t;let n=this.#P(e,b,v,g),i=void 0!==n.__staleWhileFetching&&r;return f&&(f.fetch=s?"stale":"refresh",i&&s&&(f.returnedStale=!0)),i?n.__staleWhileFetching:n.__returned=n}}async forceFetch(e,t={}){let r=await this.fetch(e,t);if(void 0===r)throw Error("fetch() returned undefined");return r}memo(e,t={}){let r=this.#p;if(!r)throw Error("no memoMethod provided to constructor");let{context:a,forceRefresh:s,...n}=t,i=this.get(e,n);if(!s&&void 0!==i)return i;let o=r(e,i,{options:n,context:a});return this.set(e,o,n),o}get(e,t={}){let{allowStale:r=this.allowStale,updateAgeOnGet:a=this.updateAgeOnGet,noDeleteOnStaleGet:s=this.noDeleteOnStaleGet,status:n}=t,i=this.#g.get(e);if(void 0!==i){let t=this.#f[i],o=this.#M(t);return(n&&this.#U(n,i),this.#N(i))?(n&&(n.get="stale"),o)?(n&&r&&void 0!==t.__staleWhileFetching&&(n.returnedStale=!0),r?t.__staleWhileFetching:void 0):(s||this.#$(e,"expire"),n&&r&&(n.returnedStale=!0),r?t:void 0):(n&&(n.get="hit"),o)?t.__staleWhileFetching:(this.#R(i),a&&this.#F(i),t)}n&&(n.get="miss")}#W(e,t){this.#v[t]=e,this.#y[e]=t}#R(e){e!==this.#w&&(e===this.#b?this.#b=this.#y[e]:this.#W(this.#v[e],this.#y[e]),this.#W(this.#w,e),this.#w=e)}delete(e){return this.#$(e,"delete")}#$(e,t){let r=!1;if(0!==this.#c){let a=this.#g.get(e);if(void 0!==a)if(this.#T?.[a]&&(clearTimeout(this.#T?.[a]),this.#T[a]=void 0),r=!0,1===this.#c)this.#Q(t);else{this.#Z(a);let r=this.#f[a];if(this.#M(r)?r.__abortController.abort(Error("deleted")):(this.#E||this.#O)&&(this.#E&&this.#i?.(r,e,t),this.#O&&this.#_?.push([r,e,t])),this.#g.delete(e),this.#h[a]=void 0,this.#f[a]=void 0,a===this.#w)this.#w=this.#v[a];else if(a===this.#b)this.#b=this.#y[a];else{let e=this.#v[a];this.#y[e]=this.#y[a];let t=this.#y[a];this.#v[t]=this.#v[a]}this.#c--,this.#k.push(a)}}if(this.#O&&this.#_?.length){let e,t=this.#_;for(;e=t?.shift();)this.#l?.(...e)}return r}clear(){return this.#Q("delete")}#Q(e){for(let t of this.#j({allowStale:!0})){let r=this.#f[t];if(this.#M(r))r.__abortController.abort(Error("deleted"));else{let a=this.#h[t];this.#E&&this.#i?.(r,a,e),this.#O&&this.#_?.push([r,a,e])}}if(this.#g.clear(),this.#f.fill(void 0),this.#h.fill(void 0),this.#x&&this.#S){for(let e of(this.#x.fill(0),this.#S.fill(0),this.#T??[]))void 0!==e&&clearTimeout(e);this.#T?.fill(void 0)}if(this.#I&&this.#I.fill(0),this.#b=0,this.#w=0,this.#k.length=0,this.#m=0,this.#c=0,this.#O&&this.#_){let e,t=this.#_;for(;e=t?.shift();)this.#l?.(...e)}}}var wx=(0,sm.__commonJS)({"../../node_modules/.pnpm/fast-deep-equal@3.1.3/node_modules/fast-deep-equal/index.js"(e,t){t.exports=function e(t,r){if(t===r)return!0;if(t&&r&&"object"==typeof t&&"object"==typeof r){if(t.constructor!==r.constructor)return!1;if(Array.isArray(t)){if((a=t.length)!=r.length)return!1;for(s=a;0!=s--;)if(!e(t[s],r[s]))return!1;return!0}if(t.constructor===RegExp)return t.source===r.source&&t.flags===r.flags;if(t.valueOf!==Object.prototype.valueOf)return t.valueOf()===r.valueOf();if(t.toString!==Object.prototype.toString)return t.toString()===r.toString();if((a=(n=Object.keys(t)).length)!==Object.keys(r).length)return!1;for(s=a;0!=s--;)if(!Object.prototype.hasOwnProperty.call(r,n[s]))return!1;for(s=a;0!=s--;){var a,s,n,i=n[s];if(!e(t[i],r[i]))return!1}return!0}return t!=t&&r!=r}}}),wT=((T=wT||{}).AGENT="AGENT",T.USER="USER",T.SYSTEM="SYSTEM",T.WORKFLOW="WORKFLOW",T.NETWORK="NETWORK",T),wE=class extends wl.ReadableStream{#J={inputTokens:0,outputTokens:0,totalTokens:0,cachedInputTokens:0,reasoningTokens:0};#H;#Y;#X=null;#ee=null;#et;runId;constructor({createStream:e,run:t}){const r={promise:null,resolve:null,reject:null};r.promise=new Promise((e,t)=>{r.resolve=e,r.reject=t});const a={promise:null,resolve:null,reject:null};a.promise=new Promise((e,t)=>{a.resolve=e,a.reject=t});let s=null;const n=e=>{this.#J.inputTokens+=parseInt(e?.inputTokens?.toString()??"0",10),this.#J.outputTokens+=parseInt(e?.outputTokens?.toString()??"0",10),this.#J.totalTokens+=parseInt(e?.totalTokens?.toString()??"0",10),this.#J.reasoningTokens+=parseInt(e?.reasoningTokens?.toString()??"0",10),this.#J.cachedInputTokens+=parseInt(e?.cachedInputTokens?.toString()??"0",10)};super({start:async t=>{try{let i=new WritableStream({write:e=>{if("step-output"===e.type&&e.payload?.output?.from==="AGENT"&&e.payload?.output?.type==="finish"||"step-output"===e.type&&e.payload?.output?.from==="WORKFLOW"&&e.payload?.output?.type==="finish"){let t=e.payload?.output;if(t&&"payload"in t&&t.payload){let e=t.payload;if("usage"in e&&e.usage)n(e.usage);else if("output"in e&&e.output){let t=e.output;"usage"in t&&t.usage&&n(t.usage)}}}t.enqueue(e)}}),o=await e(i),l=e=>"workflow-step-output"===e.type?l(e.payload.output):e,u=!1;for await(let e of o)if("workflow-step-output"===e.type){let r=l(e);if(("routing-agent-end"===r.type||"agent-execution-end"===r.type||"workflow-execution-end"===r.type)&&r.payload?.usage&&n(r.payload.usage),"network-object"===r.type)s&&s.enqueue(r.payload?.object),t.enqueue(r);else if("network-object-result"===r.type)!u&&(u=!0,a.resolve(r.payload?.object),s&&s.close()),t.enqueue(r);else if("network-execution-event-finish"===r.type){let e={...r.payload,usage:this.#J};t.enqueue({...r,payload:e})}else t.enqueue(r)}!u&&(a.resolve(void 0),s&&s.close()),t.close(),r.resolve()}catch(e){t.error(e),r.reject(e),a.reject(e),s&&s.error(e)}}}),this.#et=t,this.#H=r,this.runId=t.runId,this.#Y=a,this.#ee=new wl.ReadableStream({start:e=>{s=e,this.#X=e}})}get status(){return this.#H.promise.then(()=>this.#et._getExecutionResults()).then(e=>e.status)}get result(){return this.#H.promise.then(()=>this.#et._getExecutionResults())}get usage(){return this.#H.promise.then(()=>this.#J)}get object(){return this.#Y.promise}get objectStream(){return this.#ee}};async function wA({value:e,schema:t}){try{if(!t.validate)return{success:!0,value:e};let r=await t.validate(e);if(!r.success)return{success:!1,error:new pe({value:e,cause:"Validation failed"})};return{success:!0,value:r.value}}catch(e){return{success:!1,error:e instanceof Error?e:Error(String(e))}}}var wO=class{status={type:"pending"};_promise;_resolve=void 0;_reject=void 0;get promise(){return this._promise||(this._promise=new Promise((e,t)=>{"resolved"===this.status.type?e(this.status.value):"rejected"===this.status.type&&t(this.status.error),this._resolve=e,this._reject=t})),this._promise}resolve(e){this.status={type:"resolved",value:e},this._promise&&this._resolve?.(e)}reject(e){this.status={type:"rejected",error:e},this._promise&&this._reject?.(e)}};function wz(e){return e.split(".").slice(1).join(".")}async function wM({stream:e,onError:t,logger:r}){let a=e.getReader();try{for(;;){let{done:e}=await a.read();if(e)break}}catch(e){r?.error("consumeStream error",e),t?.(e)}finally{a.releaseLock()}}var wP="structured-output",wR=class{id=wP;name="Structured Output";schema;structuringAgent;errorStrategy;fallbackValue;isStructuringAgentStreamStarted=!1;jsonPromptInjection;providerOptions;logger;constructor(e){if(!e.schema)throw new eN.MastraError({id:"STRUCTURED_OUTPUT_PROCESSOR_SCHEMA_REQUIRED",domain:"AGENT",category:"USER",text:"StructuredOutputProcessor requires a schema to be provided"});if(!e.model)throw new eN.MastraError({id:"STRUCTURED_OUTPUT_PROCESSOR_MODEL_REQUIRED",domain:"AGENT",category:"USER",text:"StructuredOutputProcessor requires a model to be provided either in options or as fallback"});this.schema=e.schema,this.errorStrategy=e.errorStrategy??"strict",this.fallbackValue=e.fallbackValue,this.jsonPromptInjection=e.jsonPromptInjection,this.providerOptions=e.providerOptions,this.logger=e.logger,this.structuringAgent=new _g({id:"structured-output-structurer",name:"structured-output-structurer",instructions:e.instructions||this.generateInstructions(),model:e.model})}async processOutputStream(e){let{part:t,state:r,streamParts:a,abort:s,tracingContext:n}=e,i=r.controller;return"finish"===t.type&&await this.processAndEmitStructuredOutput(a,i,s,n),t}async processAndEmitStructuredOutput(e,t,r,a){if(!this.isStructuringAgentStreamStarted){this.isStructuringAgentStreamStarted=!0;try{let s=this.buildStructuringPrompt(e),n=`Extract and structure the key information from the following text according to the specified schema. Keep the original meaning and details:

${s}`,i=await this.structuringAgent.stream(n,{structuredOutput:{schema:this.schema,jsonPromptInjection:this.jsonPromptInjection},providerOptions:this.providerOptions,tracingContext:a}),o=["start","finish","text-start","text-delta","text-end","step-start","step-finish"];for await(let e of i.fullStream){if(o.includes(e.type)||e.type.startsWith("data-"))continue;if("error"===e.type){if(this.handleError("Structuring failed","Internal agent did not generate structured output",r),"warn"===this.errorStrategy)break;if("fallback"===this.errorStrategy&&void 0!==this.fallbackValue){let r={runId:e.runId,from:"AGENT",type:"object-result",object:this.fallbackValue,metadata:{from:"structured-output",fallback:!0}};t.enqueue(r);break}}let a={...e,metadata:{from:"structured-output"}};t.enqueue(a)}}catch(e){this.handleError("Structured output processing failed",e instanceof Error?e.message:"Unknown error",r)}}}buildStructuringPrompt(e){let t=[],r=[],a=[],s=[];for(let n of e)switch(n.type){case"text-delta":t.push(n.payload.text);break;case"reasoning-delta":r.push(n.payload.text);break;case"tool-call":a.push(n);break;case"tool-result":s.push(n)}let n=[];if(r.length>0&&n.push(`# Assistant Reasoning
${r.join("")}`),a.length>0){let e=a.map(e=>{let t="object"==typeof e.payload.args?JSON.stringify(e.payload.args,null):e.payload.args,r=void 0!==e.payload.output?`${"object"==typeof e.payload.output?JSON.stringify(e.payload.output,null):e.payload.output}`:"";return`## ${e.payload.toolName}
### Input: ${t}
### Output: ${r}`}).join("\n");n.push(`# Tool Calls
${e}`)}if(s.length>0){let e=s.map(e=>{let t=e.payload.result;return null==t?`${e.payload.toolName}: null`:`${e.payload.toolName}: ${"object"==typeof t?JSON.stringify(t,null,2):t}`}).join("\n");n.push(`# Tool Results
${e}`)}return t.length>0&&n.push(`# Assistant Response
${t.join("")}`),n.join("\n\n")}generateInstructions(){return`You are a data structuring specialist. Your job is to convert unstructured text into a specific JSON format.

TASK: Convert the provided unstructured text into valid JSON that matches the following schema:

REQUIREMENTS:
- Return ONLY valid JSON, no additional text or explanation
- Extract relevant information from the input text
- If information is missing, use reasonable defaults or null values
- Maintain data types as specified in the schema
- Be consistent and accurate in your conversions

The input text may be in any format (sentences, bullet points, paragraphs, etc.). Extract the relevant data and structure it according to the schema.`}handleError(e,t,r){let a=`[StructuredOutputProcessor] ${e}: ${t}`;switch(this.errorStrategy){case"strict":this.logger?.error(a),r(a);break;case"warn":this.logger?.warn(a);break;case"fallback":this.logger?.info(`${a} (using fallback)`)}}},wC=["v2","v3"];async function wj(e,t,r){if(!r.structuredOutput?.schema)throw new eN.MastraError({id:"STRUCTURED_OUTPUT_OPTIONS_REQUIRED",domain:"AGENT",category:"USER",text:"structuredOutput is required to use tryGenerateWithJsonFallback"});try{return await e.generate(t,r)}catch(a){return console.warn("Error in tryGenerateWithJsonFallback. Attempting fallback.",a),await e.generate(t,{...r,structuredOutput:{...r.structuredOutput,jsonPromptInjection:!0}})}}function wN(e){if(e?.memory?.thread){if("string"==typeof e.memory.thread)return{id:e.memory.thread};if("object"==typeof e.memory.thread&&e.memory.thread.id)return e.memory.thread}if(e?.threadId)return{id:e.threadId}}var wL=class{accumulatedText="";customState={};streamParts=[];span;constructor(e){if(!e?.createSpan||!e.processorName)return;const t=e.tracingContext?.currentSpan,r=t?.findParent("agent_run")||t?.parent||t;this.span=r?.createChildSpan({type:"processor_run",name:`output stream processor: ${e.processorName}`,entityType:"output_processor",entityName:e.processorName,attributes:{processorExecutor:"legacy",processorIndex:e.processorIndex??0},input:{streamParts:[],state:{},totalChunks:0}})}addPart(e){"text-delta"===e.type&&(this.accumulatedText+=e.payload.text),this.streamParts.push(e),this.span&&(this.span.input={streamParts:this.streamParts,state:this.customState,totalChunks:this.streamParts.length,accumulatedText:this.accumulatedText})}},wD=class e{inputProcessors;outputProcessors;logger;agentName;constructor({inputProcessors:e,outputProcessors:t,logger:r,agentName:a}){this.inputProcessors=e??[],this.outputProcessors=t??[],this.logger=r,this.agentName=a}async executeWorkflowAsProcessor(e,t,r,a){let s=await e.createRun(),n=await s.start({inputData:t,tracingContext:r,requestContext:a});if("tripwire"===n.status){let t=n.tripwire;throw new wG(t?.reason||`Tripwire triggered in workflow ${e.id}`,{retry:t?.retry,metadata:t?.metadata},t?.processorId||e.id)}if("success"!==n.status)throw new eN.MastraError({category:"USER",domain:"AGENT",id:"PROCESSOR_WORKFLOW_FAILED",text:`Processor workflow ${e.id} failed with status: ${n.status}`});let i=n.result;if(!i||"object"!=typeof i)return t;if(!("phase"in i)||!("messages"in i||"part"in i||"messageList"in i))throw new eN.MastraError({category:"USER",domain:"AGENT",id:"PROCESSOR_WORKFLOW_INVALID_OUTPUT",text:`Processor workflow ${e.id} returned invalid output format. Expected ProcessorStepOutput.`});return i}async runOutputProcessors(e,t,r,a=0){for(let[s,n]of this.outputProcessors.entries()){let i=[...e.get.response.db()],o=i.map(e=>e.id),l=e.makeMessageSourceChecker();if(_h(n)){await this.executeWorkflowAsProcessor(n,{phase:"outputResult",messages:i,messageList:e,retryCount:a},t,r);continue}let u=n,p=(e,t)=>{throw new wG(e||`Tripwire triggered by ${u.id}`,t,u.id)},d=u.processOutputResult?.bind(u);if(!d)continue;let c=t?.currentSpan,m=c?.findParent("agent_run")||c?.parent||c,g=m?.createChildSpan({type:"processor_run",name:`output processor: ${u.id}`,entityType:"output_processor",entityId:u.id,entityName:u.name,attributes:{processorExecutor:"legacy",processorIndex:s},input:i});e.startRecording();let h=await d({messages:i,messageList:e,abort:p,tracingContext:{currentSpan:g},requestContext:r,retryCount:a}),f=e.stopRecording();if(h instanceof pZ){if(h!==e)throw new eN.MastraError({category:"USER",domain:"AGENT",id:"PROCESSOR_RETURNED_EXTERNAL_MESSAGE_LIST",text:`Processor ${u.id} returned a MessageList instance other than the one that was passed in as an argument. New external message list instances are not supported. Use the messageList argument instead.`});f.length>0&&(i=h.get.response.db())}else if(h){let t=o.filter(e=>!h.some(t=>t.id===e));for(let r of(t.length&&e.removeByIds(t),i=h||[],h))e.removeByIds([r.id]),e.add(r,l.getSource(r)||"response")}g?.end({output:i,attributes:f.length>0?{messageListMutations:f}:void 0})}return e}async processPart(e,t,r,a,s,n=0){if(!this.outputProcessors.length)return{part:e,blocked:!1};try{let i=e,o="finish"===e.type;for(let[e,o]of this.outputProcessors.entries()){if(_h(o)){if(!i)continue;let e=o.id,l=t.get(e);l||(l=new wL,t.set(e,l)),l.addPart(i);try{let e=await this.executeWorkflowAsProcessor(o,{phase:"outputStream",part:i,streamParts:l.streamParts,state:l.customState,messageList:s,retryCount:n},r,a);"part"in e&&(i=e.part)}catch(t){if(t instanceof wG)return{part:null,blocked:!0,reason:t.message,tripwireOptions:t.options,processorId:t.processorId||e};this.logger.error(`[Agent:${this.agentName}] - Output processor workflow ${e} failed:`,t)}continue}let l=o;try{if(l.processOutputStream&&i){let o=t.get(l.id);o||(o=new wL({processorName:l.name??l.id,tracingContext:r,processorIndex:e,createSpan:!0}),t.set(l.id,o)),o.addPart(i);let u=await l.processOutputStream({part:i,streamParts:o.streamParts,state:o.customState,abort:(e,t)=>{throw new wG(e||`Stream part blocked by ${l.id}`,t,l.id)},tracingContext:{currentSpan:o.span},requestContext:a,messageList:s,retryCount:n});o.span&&!o.span.isEvent&&(o.span.output=u),i=u}}catch(r){if(r instanceof wG){let e=t.get(l.id);return e?.span?.end({metadata:{blocked:!0,reason:r.message,retry:r.options?.retry}}),{part:null,blocked:!0,reason:r.message,tripwireOptions:r.options,processorId:l.id}}let e=t.get(l.id);e?.span?.error({error:r,endSpan:!0}),this.logger.error(`[Agent:${this.agentName}] - Output processor ${l.id} failed:`,r)}}if(o){for(let e of t.values())if(e.span){let t={...e.span.output,totalChunks:e.streamParts.length,finalState:e.customState};e.span.end({output:t})}}return{part:i,blocked:!1}}catch(r){for(let e of(this.logger.error(`[Agent:${this.agentName}] - Stream part processing failed:`,r),t.values()))e.span?.error({error:r,endSpan:!0});return{part:e,blocked:!1}}}async runOutputProcessorsForStream(e,t){return new ReadableStream({start:async r=>{let a=e.fullStream.getReader(),s=new Map;try{for(;;){let{done:e,value:n}=await a.read();if(e){r.close();break}let{part:i,blocked:o,reason:l,tripwireOptions:u,processorId:p}=await this.processPart(n,s,t);if(o){this.logger.debug(`[Agent:${this.agentName}] - Stream part blocked by output processor`,{reason:l,originalPart:n}),r.enqueue({type:"tripwire",payload:{reason:l||"Output processor blocked content",retry:u?.retry,metadata:u?.metadata,processorId:p}}),r.close();break}null!==i&&r.enqueue(i)}}catch(e){r.error(e)}}})}async runInputProcessors(e,t,r,a=0){for(let[s,n]of this.inputProcessors.entries()){let i,o=e.get.input.db(),l=o.map(e=>e.id),u=e.makeMessageSourceChecker();if(_h(n)){let s=e.getAllSystemMessages();await this.executeWorkflowAsProcessor(n,{phase:"input",messages:o,messageList:e,systemMessages:s,retryCount:a},t,r);continue}let p=n,d=(e,t)=>{throw new wG(e||`Tripwire triggered by ${p.id}`,t,p.id)},c=p.processInput?.bind(p);if(!c)continue;let m=t?.currentSpan,g=m?.findParent("agent_run")||m?.parent||m,h=g?.createChildSpan({type:"processor_run",name:`input processor: ${p.id}`,entityType:"input_processor",entityId:p.id,entityName:p.name,attributes:{processorExecutor:"legacy",processorIndex:s},input:o});e.startRecording();let f=e.getAllSystemMessages(),y=await c({messages:o,systemMessages:f,abort:d,tracingContext:{currentSpan:h},messageList:e,requestContext:r,retryCount:a});if(y instanceof pZ){if(y!==e)throw new eN.MastraError({category:"USER",domain:"AGENT",id:"PROCESSOR_RETURNED_EXTERNAL_MESSAGE_LIST",text:`Processor ${p.id} returned a MessageList instance other than the one that was passed in as an argument. New external message list instances are not supported. Use the messageList argument instead.`});(i=e.stopRecording()).length>0&&(o=e.get.input.db())}else if(this.isProcessInputResultWithSystemMessages(y)){i=e.stopRecording(),e.replaceAllSystemMessages(y.systemMessages);let t=y.messages;if(t){let r=l.filter(e=>!t.some(t=>t.id===e));r.length&&e.removeByIds(r);let a=t.filter(e=>"system"===e.role),s=t.filter(e=>"system"!==e.role);for(let t of a){let r=t.content.content??t.content.parts?.map(e=>"text"===e.type?e.text:"").join("\n")??"";e.addSystem(r)}if(s.length>0)for(let t of s)e.removeByIds([t.id]),e.add(t,u.getSource(t)||"input")}o=e.get.input.db()}else if(i=e.stopRecording(),y){let t=l.filter(e=>!y.some(t=>t.id===e));t.length&&e.removeByIds(t);let r=y.filter(e=>"system"===e.role),a=y.filter(e=>"system"!==e.role);for(let t of r){let r=t.content.content??t.content.parts?.map(e=>"text"===e.type?e.text:"").join("\n")??"";e.addSystem(r)}if(a.length>0)for(let t of a)e.removeByIds([t.id]),e.add(t,u.getSource(t)||"input");o=e.get.input.db()}h?.end({output:o,attributes:i.length>0?{messageListMutations:i}:void 0})}return e}async runProcessInputStep(t){let{messageList:r,stepNumber:a,steps:s,tracingContext:n,requestContext:i}=t,o={tools:t.tools,toolChoice:t.toolChoice,model:t.model,activeTools:t.activeTools,providerOptions:t.providerOptions,modelSettings:t.modelSettings,structuredOutput:t.structuredOutput,retryCount:t.retryCount??0};for(let[l,u]of this.inputProcessors.entries()){let p=r.get.all.db(),d=p.map(e=>e.id),c=r.makeMessageSourceChecker();if(_h(u)){let e=r.getAllSystemMessages(),t=await this.executeWorkflowAsProcessor(u,{phase:"inputStep",messages:p,messageList:r,stepNumber:a,systemMessages:e,...o},n,i);Object.assign(o,t);continue}let m=u,g=m.processInputStep?.bind(m);if(!g)continue;let h=(e,t)=>{throw new wG(e||`Tripwire triggered by ${m.id}`,t,m.id)},f={messages:p,stepNumber:a,steps:s,systemMessages:r.getAllSystemMessages(),tools:o.tools,toolChoice:o.toolChoice,model:o.model,activeTools:o.activeTools,providerOptions:o.providerOptions,modelSettings:o.modelSettings,structuredOutput:o.structuredOutput,requestContext:i},y=n?.currentSpan,v=y?.createChildSpan({type:"processor_run",name:`input step processor: ${m.id}`,entityType:"input_step_processor",entityId:m.id,entityName:m.name,attributes:{processorExecutor:"legacy",processorIndex:l},input:{...f,model:{id:f.model.modelId,provider:f.model.provider,specificationVersion:f.model.specificationVersion}}});r.startRecording();try{let{messages:s,systemMessages:n,...i}=await e.validateAndFormatProcessInputStepResult(await g({messageList:r,...f,abort:h,tracingContext:{currentSpan:v},retryCount:t.retryCount??0}),{messageList:r,processor:m,stepNumber:a});s&&e.applyMessagesToMessageList(s,r,d,c),n&&r.replaceAllSystemMessages(n),Object.assign(o,i);let l=r.stopRecording();v?.end({output:{...o,messages:r.get.all.db(),systemMessages:r.getAllSystemMessages(),model:o.model?{modelId:o.model.modelId,provider:o.model.provider,specificationVersion:o.model.specificationVersion}:void 0},attributes:l.length>0?{messageListMutations:l}:void 0})}catch(e){if(r.stopRecording(),e instanceof wG)throw v?.end({metadata:{blocked:!0,reason:e.message}}),e;throw v?.error({error:e,endSpan:!0}),this.logger.error(`[Agent:${this.agentName}] - Input step processor ${m.id} failed:`,e),e}}return o}isProcessInputResultWithSystemMessages(e){return null!==e&&"object"==typeof e&&"messages"in e&&"systemMessages"in e&&Array.isArray(e.messages)&&Array.isArray(e.systemMessages)}async runProcessOutputStep(e){let{steps:t,messageList:r,stepNumber:a,finishReason:s,toolCalls:n,text:i,tracingContext:o,requestContext:l,retryCount:u=0}=e;for(let[e,p]of this.outputProcessors.entries()){let d=r.get.all.db(),c=d.map(e=>e.id),m=r.makeMessageSourceChecker();if(_h(p)){let e=r.getAllSystemMessages();await this.executeWorkflowAsProcessor(p,{phase:"outputStep",messages:d,messageList:r,stepNumber:a,finishReason:s,toolCalls:n,text:i,systemMessages:e,steps:t,retryCount:u},o,l);continue}let g=p,h=g.processOutputStep?.bind(g);if(!h)continue;let f=(e,t)=>{throw new wG(e||`Tripwire triggered by ${g.id}`,t,g.id)},y=o?.currentSpan,v=y?.findParent("agent_run")||y?.parent||y,b=v?.createChildSpan({type:"processor_run",name:`output step processor: ${g.id}`,entityType:"output_step_processor",entityId:g.id,entityName:g.name,attributes:{processorExecutor:"legacy",processorIndex:e},input:{messages:d,stepNumber:a,finishReason:s,toolCalls:n,text:i}});r.startRecording();let w=r.getAllSystemMessages();try{let e=await h({messages:d,messageList:r,stepNumber:a,finishReason:s,toolCalls:n,text:i,systemMessages:w,steps:t,abort:f,tracingContext:{currentSpan:b},requestContext:l,retryCount:u}),o=r.stopRecording();if(e instanceof pZ){if(e!==r)throw new eN.MastraError({category:"USER",domain:"AGENT",id:"PROCESSOR_RETURNED_EXTERNAL_MESSAGE_LIST",text:`Processor ${g.id} returned a MessageList instance other than the one that was passed in as an argument. New external message list instances are not supported. Use the messageList argument instead.`})}else if(e){let t=c.filter(t=>!e.some(e=>e.id===t));for(let a of(t.length&&r.removeByIds(t),e))if(r.removeByIds([a.id]),"system"===a.role){let e=a.content.content??a.content.parts?.map(e=>"text"===e.type?e.text:"").join("\n")??"";r.addSystem(e)}else r.add(a,m.getSource(a)||"response")}b?.end({output:r.get.all.db(),attributes:o.length>0?{messageListMutations:o}:void 0})}catch(e){if(r.stopRecording(),e instanceof wG)throw b?.end({metadata:{blocked:!0,reason:e.message,retry:e.options?.retry,metadata:e.options?.metadata}}),e;throw b?.error({error:e,endSpan:!0}),this.logger.error(`[Agent:${this.agentName}] - Output step processor ${g.id} failed:`,e),e}}return r}static applyMessagesToMessageList(e,t,r,a,s="input"){let n=r.filter(t=>!e.some(e=>e.id===t));for(let r of(n.length&&t.removeByIds(n),e))if(t.removeByIds([r.id]),"system"===r.role){let e=r.content.content??r.content.parts?.map(e=>"text"===e.type?e.text:"").join("\n")??"";t.addSystem(e)}else t.add(r,a.getSource(r)||s)}static async validateAndFormatProcessInputStepResult(e,{messageList:t,processor:r,stepNumber:a}){if(e instanceof pZ){if(e!==t)throw new eN.MastraError({category:"USER",domain:"AGENT",id:"PROCESSOR_RETURNED_EXTERNAL_MESSAGE_LIST",text:`Processor ${r.id} returned a MessageList instance other than the one that was passed in as an argument. New external message list instances are not supported. Use the messageList argument instead.`});return{messageList:e}}if(Array.isArray(e))return{messages:e};if(e){if(e.messageList&&e.messageList!==t)throw new eN.MastraError({category:"USER",domain:"AGENT",id:"PROCESSOR_RETURNED_EXTERNAL_MESSAGE_LIST",text:`Processor ${r.id} returned a MessageList instance other than the one that was passed in as an argument. New external message list instances are not supported. Use the messageList argument instead.`});if(e.messages&&e.messageList)throw new eN.MastraError({category:"USER",domain:"AGENT",id:"PROCESSOR_RETURNED_MESSAGES_AND_MESSAGE_LIST",text:`Processor ${r.id} returned both messages and messageList. Only one of these is allowed.`});let{model:s,...n}=e;if(e.model){let t=await wa(e.model);if(!wC.includes(t.specificationVersion))throw new eN.MastraError({category:"USER",domain:"AGENT",id:"PROCESSOR_RETURNED_UNSUPPORTED_MODEL",text:`Processor ${r.id} returned an unsupported model version ${t.specificationVersion} in step ${a}. Only ${wC.join(", ")} models are supported in processInputStep.`});return{model:t,...n}}return n}return{}}};function wq(e){let t;if(!(t=function(e){if(e)return!e||"object"!=typeof e||e.safeParse||e.jsonSchema?vI(e)?mh(e):e.jsonSchema?e.jsonSchema:ra(e).jsonSchema:e}(e)))return;let{$schema:r,...a}=t;return"array"===a.type?{jsonSchema:{$schema:r,type:"object",properties:{elements:{type:"array",items:a.items}},required:["elements"],additionalProperties:!1},outputFormat:"array"}:a.enum&&Array.isArray(a.enum)?{jsonSchema:{$schema:r,type:"object",properties:{result:{type:a.type||"string",enum:a.enum}},required:["result"],additionalProperties:!1},outputFormat:"enum"}:{jsonSchema:t,outputFormat:t.type}}var w$=class{schema;validatePartialChunks=!1;partialSchema;constructor(e,t={}){this.schema=e,t.validatePartialChunks&&this.isZodSchema(e)&&"partial"in e&&"function"==typeof e.partial&&(this.partialSchema=e.partial(),this.validatePartialChunks=!0)}isZodSchema(e){return vI(e)}async validateValue(e){if(!this.schema)return{success:!0,value:e};if(this.isZodSchema(this.schema))try{let t=this.schema.safeParse(e);if(t.success)return{success:!0,value:t.data};return{success:!1,error:new eN.MastraError({domain:"AGENT",category:"SYSTEM",id:"STRUCTURED_OUTPUT_SCHEMA_VALIDATION_FAILED",text:`Structured output validation failed
${eq.default.prettifyError(t.error)}
`,details:{value:"object"==typeof e?JSON.stringify(e):String(e)}},t.error)}}catch(e){return{success:!1,error:e instanceof Error?e:Error("Zod validation failed",{cause:e})}}try{if("object"==typeof this.schema&&!this.schema.jsonSchema)return await wA({value:e,schema:rr(this.schema)});if(this.schema.jsonSchema)return await wA({value:e,schema:this.schema});return{success:!0,value:e}}catch(e){return{success:!1,error:e instanceof Error?e:Error("Validation failed",{cause:e})}}}preprocessText(e){let t=e;if(t.includes("<|message|>")){let e=t.match(/<\|message\|>([\s\S]+)$/);e&&e[1]&&(t=e[1])}if(t.includes("```json")){let e=t.match(/```json\s*\n?([\s\S]*?)\n?\s*```/);t=e&&e[1]?e[1].trim():t.replace(/^```json\s*\n?/,"")}var r=t;let a="",s=!1,n=0;for(;n<r.length;){let e=r[n];if("\\"===e&&n+1<r.length){a+=e+r[n+1],n+=2;continue}if('"'===e){s=!s,a+=e,n++;continue}if(s){if("\n"===e){a+="\\n",n++;continue}if("\r"===e){a+="\\r",n++;continue}if("	"===e){a+="\\t",n++;continue}}a+=e,n++}return a}},wF=class extends w${type="object";async processPartialChunk({accumulatedText:e,previousObject:t}){let r=this.preprocessText(e),{value:a,state:s}=await a3(r);if(this.validatePartialChunks&&this.partialSchema){let e=this.partialSchema?.safeParse(a);return e.success&&e.data&&void 0!==e.data&&!sr(t,e.data)?{shouldEmit:!0,emitValue:e.data,newPreviousResult:e.data}:{shouldEmit:!1}}return null==a||"object"!=typeof a||sr(t,a)?{shouldEmit:!1}:{shouldEmit:["successful-parse","repaired-parse"].includes(s),emitValue:a,newPreviousResult:a}}async validateAndTransformFinal(e){if(!e)return{success:!1,error:Error("No object generated: could not parse the response.")};let t=this.preprocessText(e),{value:r}=await a3(t);return this.validateValue(r)}},wU=class extends w${type="array";textPreviousFilteredArray=[];hasEmittedInitialArray=!1;async processPartialChunk({accumulatedText:e,previousObject:t}){let r=this.preprocessText(e),{value:a,state:s}=await a3(r);if(void 0!==a&&!sr(t,a)){let e=a?.elements||[],t=[];for(let r=0;r<e.length;r++){let a=e[r];e.length,a&&"object"==typeof a&&Object.keys(a).length>0&&t.push(a)}if(!this.hasEmittedInitialArray&&(this.hasEmittedInitialArray=!0,0===t.length))return this.textPreviousFilteredArray=[],{shouldEmit:!0,emitValue:[],newPreviousResult:a};if(!sr(this.textPreviousFilteredArray,t))return this.textPreviousFilteredArray=[...t],{shouldEmit:!0,emitValue:t,newPreviousResult:a}}return{shouldEmit:!1}}async validateAndTransformFinal(e){let t=this.textPreviousFilteredArray;return t?this.validateValue(t):{success:!1,error:Error("No object generated: could not parse the response.")}}},wZ=class extends w${type="enum";textPreviousEnumResult;findBestEnumMatch(e){let t;if(!this.schema)return;if(this.isZodSchema(this.schema)){let e=mh(this.schema);t=e?.enum}else if("object"!=typeof this.schema||this.schema.jsonSchema)t=this.schema.jsonSchema?.enum;else{let e=rr(this.schema);t=e.jsonSchema?.enum}if(!t)return;let r=t.filter(e=>"string"==typeof e).filter(t=>t.startsWith(e));if(0===r.length)return;let a=r[0];return 1===r.length&&void 0!==a?a:e}async processPartialChunk({accumulatedText:e,previousObject:t}){let r=this.preprocessText(e),{value:a}=await a3(r);if(null!=a&&"object"==typeof a&&!Array.isArray(a)&&"result"in a&&"string"==typeof a.result&&!sr(t,a)){let e=a.result,t=this.findBestEnumMatch(e);if(e.length>0&&t&&t!==this.textPreviousEnumResult)return this.textPreviousEnumResult=t,{shouldEmit:!0,emitValue:t,newPreviousResult:a}}return{shouldEmit:!1}}async validateAndTransformFinal(e){let t=this.preprocessText(e),{value:r}=await a3(t);return"object"==typeof r&&null!==r&&"result"in r&&r&&"object"==typeof r&&"string"==typeof r.result?this.validateValue(r.result):{success:!1,error:Error("Invalid enum format: expected object with result property")}}},wB=class extends wo.MastraBase{#er="running";#ea;#es;#en=[];#ei=!1;#eo=new wu.EventEmitter;#el=[];#eu={};#ep={text:"",reasoning:[],sources:[],files:[],toolCalls:[],toolResults:[],dynamicToolCalls:[],dynamicToolResults:[],staticToolCalls:[],staticToolResults:[],content:[],usage:{inputTokens:void 0,outputTokens:void 0,totalTokens:void 0},warnings:[],request:{},response:{id:"",timestamp:new Date,modelId:"",messages:[],uiMessages:[]},reasoningText:"",providerMetadata:void 0,finishReason:void 0};#ed=[];#ec;#em={};#eg=[];#eh=[];#ef=[];#ey={};#ev={};#eb=[];#ew=[];#ek=[];#e_=void 0;#eI={};#J={inputTokens:void 0,outputTokens:void 0,totalTokens:void 0};#eS=void 0;#ex={suspendPayload:new wO,object:new wO,finishReason:new wO,usage:new wO,warnings:new wO,providerMetadata:new wO,response:new wO,request:new wO,text:new wO,reasoning:new wO,reasoningText:new wO,sources:new wO,files:new wO,toolCalls:new wO,toolResults:new wO,steps:new wO,totalUsage:new wO,content:new wO};#eT=!1;#eE=!1;#eA=void 0;#e;runId;#r;processorRunner;messageList;traceId;messageId;constructor({model:e,stream:t,messageList:r,options:a,messageId:s,initialState:n}){super({component:"LLM",name:"MastraModelOutput"}),this.#r=a,this.#eE=!!a.returnScorerData,this.runId=a.runId,this.traceId=a.tracingContext?.currentSpan?.externalTraceId,this.#e=e,this.messageId=s,a.structuredOutput?.schema&&(this.#eA=a.structuredOutput.model?"processor":"direct"),a.outputProcessors?.length&&(this.processorRunner=new wD({inputProcessors:[],outputProcessors:a.outputProcessors,logger:this.logger,agentName:"MastraModelOutput"})),this.messageList=r;const i=this;let o=t;const l=this.processorRunner;if(l&&a.isLLMExecutionStep){const e=a.processorStates||new Map;o=t.pipeThrough(new wl.TransformStream({async transform(t,r){if("finish"===t.type&&t.payload?.stepResult?.reason==="tool-calls")return void r.enqueue(t);{if(e.has(wP)){let t=e.get(wP);t&&(t.customState.controller=r)}else{let t=l.outputProcessors.findIndex(e=>e.name===wP);if(-1!==t){let s=new wL({processorName:wP,tracingContext:a.tracingContext,processorIndex:t,createSpan:!0});s.customState={controller:r},e.set(wP,s)}}let{part:s,blocked:n,reason:o,tripwireOptions:u,processorId:p}=await l.processPart(t,e,a.tracingContext,a.requestContext,i.messageList);if(n)return void r.enqueue({type:"tripwire",payload:{reason:o||"Output processor blocked content",retry:u?.retry,metadata:u?.metadata,processorId:p}});s&&r.enqueue(s)}}}))}"direct"===i.#eA&&i.#r.isLLMExecutionStep&&(o=o.pipeThrough(function({structuredOutput:e,logger:t}){let r,a,s,n=function({schema:e}){let t=wq(e);switch(t?.outputFormat){case"array":return new wU(e);case"enum":return new wZ(e);default:return new wF(e)}}({schema:e?.schema}),i="";return new wl.TransformStream({async transform(e,t){if(e.runId&&(r=e.runId),"text-delta"===e.type&&"string"==typeof e.payload?.text){i+=e.payload.text;let r=await n.processPartialChunk({accumulatedText:i,previousObject:s});if(r.shouldEmit){s=r.newPreviousResult??s;let a={from:e.from,runId:e.runId,type:"object",object:r.emitValue};t.enqueue(a)}}if("text-end"===e.type){t.enqueue(e),i?.trim()&&!a&&(a=await n.validateAndTransformFinal(i)).success&&t.enqueue({from:"AGENT",runId:r??"",type:"object-result",object:a.value});return}t.enqueue(e)},async flush(e){a&&!a.success&&o(a.error,e),i?.trim()&&!a&&((a=await n.validateAndTransformFinal(i)).success?e.enqueue({from:"AGENT",runId:r??"",type:"object-result",object:a.value}):o(a.error,e))}});function o(a,s){e?.errorStrategy==="warn"?t?.warn(a.message):e?.errorStrategy==="fallback"?s.enqueue({from:"AGENT",runId:r??"",type:"object-result",object:e?.fallbackValue}):s.enqueue({from:"AGENT",runId:r??"",type:"error",payload:{error:a}})}}({structuredOutput:i.#r.structuredOutput,logger:i.logger}))),this.#es=o.pipeThrough(new wl.TransformStream({transform:async(e,t)=>{switch(e.type){case"tool-call-suspended":case"tool-call-approval":i.#er="suspended",i.#ex.suspendPayload.resolve(e.payload);break;case"raw":if(!i.#r.includeRawChunks)return;break;case"object-result":i.#ec=e.object,"pending"===i.#ex.object.status.type&&i.#ex.object.resolve(e.object);break;case"source":i.#eg.push(e),i.#ep.sources.push(e);break;case"text-delta":if(i.#ed.push(e.payload.text),i.#ep.text+=e.payload.text,e.payload.id){let t=i.#em[e.payload.id]??[];t.push(e.payload.text),i.#em[e.payload.id]=t}break;case"tool-call-input-streaming-start":i.#ev[e.payload.toolCallId]=e.payload.toolName;break;case"tool-call-delta":i.#ey[e.payload.toolCallId]||(i.#ey[e.payload.toolCallId]=[]),i.#ey?.[e.payload.toolCallId]?.push(e.payload.argsTextDelta),e.payload.toolName||=i.#ev[e.payload.toolCallId];break;case"file":i.#ef.push(e),i.#ep.files.push(e);break;case"reasoning-start":i.#eu[e.payload.id]={type:"reasoning",runId:e.runId,from:e.from,payload:{id:e.payload.id,providerMetadata:e.payload.providerMetadata,text:""}};break;case"reasoning-delta":{i.#eh.push({type:"reasoning",runId:e.runId,from:e.from,payload:e.payload}),i.#ep.reasoning.push({type:"reasoning",runId:e.runId,from:e.from,payload:e.payload});let t=i.#eu[e.payload.id];t&&(t.payload.text+=e.payload.text,e.payload.providerMetadata&&(t.payload.providerMetadata=e.payload.providerMetadata));break}case"reasoning-end":{let t=i.#eu[e.payload.id];e.payload.providerMetadata&&t&&(t.payload.providerMetadata=e.payload.providerMetadata);break}case"tool-call":i.#eb.push(e),i.#ep.toolCalls.push(e);let s=e.payload;if(s?.output?.from==="AGENT"&&s?.output?.type==="finish"){let e=s.output.payload;e?.usage&&i.updateUsageCount(e.usage)}break;case"tool-result":i.#ew.push(e),i.#ep.toolResults.push(e);break;case"step-finish":{i.updateUsageCount(e.payload.output.usage),i.#ek=e.payload.stepResult.warnings||[],e.payload.metadata.request&&(i.#eI=e.payload.metadata.request);let{providerMetadata:t,request:s,...n}=e.payload.metadata,o=e.payload.output?.steps||[],l=o[o.length-1],u=l?.tripwire,p=u?"":i.#ep.text,d={stepType:0===i.#el.length?"initial":"tool-result",sources:i.#ep.sources,files:i.#ep.files,toolCalls:i.#ep.toolCalls,toolResults:i.#ep.toolResults,content:r.get.response.aiV5.modelContent(-1),text:p,tripwire:u,reasoningText:i.#eh.map(e=>e.payload.text).join(""),reasoning:Object.values(i.#eu),get staticToolCalls(){return i.#ep.toolCalls.filter(e=>"tool-call"===e.type&&e.payload?.dynamic===!1)},get dynamicToolCalls(){return i.#ep.toolCalls.filter(e=>"tool-call"===e.type&&e.payload?.dynamic===!0)},get staticToolResults(){return i.#ep.toolResults.filter(e=>"tool-result"===e.type&&e.payload?.dynamic===!1)},get dynamicToolResults(){return i.#ep.toolResults.filter(e=>"tool-result"===e.type&&e.payload?.dynamic===!0)},finishReason:e.payload.stepResult.reason,usage:e.payload.output.usage,warnings:i.#ek,request:s||{},response:{id:e.payload.id||"",timestamp:e.payload.metadata?.timestamp||new Date,modelId:e.payload.metadata?.modelId||e.payload.metadata?.model||"",...n,messages:e.payload.messages?.nonUser||[],uiMessages:r.get.response.aiV5.ui()},providerMetadata:t};await a?.onStepFinish?.({...i.#e.modelId&&i.#e.provider&&i.#e.version?{model:i.#e}:{},...d}),i.#el.push(d),i.#ep={text:"",reasoning:[],sources:[],files:[],toolCalls:[],toolResults:[],dynamicToolCalls:[],dynamicToolResults:[],staticToolCalls:[],staticToolResults:[],content:[],usage:{inputTokens:void 0,outputTokens:void 0,totalTokens:void 0},warnings:[],request:{},response:{id:"",timestamp:new Date,modelId:"",messages:[],uiMessages:[]},reasoningText:"",providerMetadata:void 0,finishReason:void 0};break}case"tripwire":i.#eS={reason:e.payload?.reason||"Content blocked",retry:e.payload?.retry,metadata:e.payload?.metadata,processorId:e.payload?.processorId},i.#e_="other",i.#ei=!0,i.resolvePromises({text:i.#ed.join(""),finishReason:"other",object:void 0,usage:i.#J,warnings:i.#ek,providerMetadata:void 0,response:{},request:{},reasoning:[],reasoningText:void 0,sources:[],files:[],toolCalls:[],toolResults:[],steps:i.#el,totalUsage:i.#J,content:[],suspendPayload:void 0}),i.#eO(e),t.enqueue(e),i.#eo.emit("finish"),t.terminate();return;case"finish":if(i.#er="success",e.payload.stepResult.reason&&(i.#e_=e.payload.stepResult.reason),"tripwire"===e.payload.stepResult.reason){let t=e.payload.output?.steps,r=t?.[t?.length-1],a=r?.tripwire;i.#eS={reason:a?.reason||"Processor tripwire triggered",retry:a?.retry,metadata:a?.metadata,processorId:a?.processorId}}if(void 0!==i.#ec){let e=[...r.get.response.db()].reverse().find(e=>"assistant"===e.role);e&&(e.content.metadata||(e.content.metadata={}),e.content.metadata.structuredOutput=i.#ec)}let n={};if(e.payload.metadata){let{providerMetadata:t,request:a,...s}=e.payload.metadata;n={...s,messages:r.get.response.aiV5.model(),uiMessages:r.get.response.aiV5.ui()}}this.populateUsageCount(e.payload.output.usage),e.payload.output.usage={inputTokens:i.#J.inputTokens??0,outputTokens:i.#J.outputTokens??0,totalTokens:i.#J.totalTokens??0,...void 0!==i.#J.reasoningTokens&&{reasoningTokens:i.#J.reasoningTokens},...void 0!==i.#J.cachedInputTokens&&{cachedInputTokens:i.#J.cachedInputTokens}};try{if(i.processorRunner&&!i.#r.isLLMExecutionStep){let t=i.#el[i.#el.length-1],s=t?.text||"";i.messageList=await i.processorRunner.runOutputProcessors(i.messageList,a.tracingContext,i.#r.requestContext);let o=i.messageList.get.response.aiV4.core(),l=o[o.length-1],u=l?pS(l.content):"";if(t&&u&&u!==s&&(t.text=u),this.resolvePromises({text:u||s,finishReason:i.#e_}),e.payload.metadata){let{providerMetadata:t,request:a,...s}=e.payload.metadata;n={...s,messages:r.get.response.aiV5.model(),uiMessages:r.get.response.aiV5.ui()}}e.payload.response=n}else i.#r.isLLMExecutionStep||this.resolvePromises({text:i.#ed.join(""),finishReason:i.#e_})}catch(e){e instanceof wG?(i.#eS={reason:e.message,retry:e.options?.retry,metadata:e.options?.metadata,processorId:e.processorId},i.resolvePromises({finishReason:"other",text:""})):(i.#ea=(0,eN.getErrorFromUnknown)(e,{fallbackMessage:"Unknown error in stream"}),i.resolvePromises({finishReason:"error",text:""})),"resolved"!==i.#ex.object.status.type&&i.#ex.object.resolve(void 0)}let o=i.#eh.length>0?i.#eh.map(e=>e.payload.text).join(""):void 0;this.resolvePromises({usage:i.#J,warnings:i.#ek,providerMetadata:e.payload.metadata?.providerMetadata,response:n,request:i.#eI||{},reasoningText:o,reasoning:Object.values(i.#eu||{}),sources:i.#eg,files:i.#ef,toolCalls:i.#eb,toolResults:i.#ew,steps:i.#el,totalUsage:i.#ez(),content:r.get.response.aiV5.stepContent(),suspendPayload:void 0});let l=i.#el[i.#el.length-1];if(l){let t={providerMetadata:l.providerMetadata,text:i.#ed.join(""),warnings:l.warnings??[],finishReason:e.payload.stepResult.reason,content:r.get.response.aiV5.stepContent(),request:await i.request,error:i.error,reasoning:await i.reasoning,reasoningText:await i.reasoningText,sources:await i.sources,files:await i.files,steps:i.#el,response:{...await i.response,...l.response,messages:r.get.response.aiV5.model()},usage:e.payload.output.usage,totalUsage:i.#ez(),toolCalls:await i.toolCalls,toolResults:await i.toolResults,staticToolCalls:(await i.toolCalls).filter(e=>e?.payload?.dynamic===!1),staticToolResults:(await i.toolResults).filter(e=>e?.payload?.dynamic===!1),dynamicToolCalls:(await i.toolCalls).filter(e=>e?.payload?.dynamic===!0),dynamicToolResults:(await i.toolResults).filter(e=>e?.payload?.dynamic===!0),...i.#e.modelId&&i.#e.provider&&i.#e.version?{model:i.#e}:{},object:"rejected"===i.#ex.object.status.type?void 0:"resolved"===i.#ex.object.status.type?i.#ex.object.status.value:"direct"===i.#eA&&l.text?(()=>{try{return JSON.parse(l.text)}catch{return}})():void 0};await a?.onFinish?.(t)}break;case"error":i.#ea=(0,eN.getErrorFromUnknown)(e.payload.error,{fallbackMessage:"Unknown error chunk in stream"}),i.#er="failed",i.#ei=!0,Object.values(i.#ex).forEach(e=>{"pending"===e.status.type&&e.reject(i.#ea)})}i.#eO(e),t.enqueue(e)},flush:()=>{if("pending"===i.#ex.object.status.type&&i.#ex.object.resolve(void 0),"suspended"===i.#er){let e=i.#eh.length>0?i.#eh.map(e=>e.payload.text).join(""):void 0;i.resolvePromises({toolResults:i.#ew,toolCalls:i.#eb,text:i.#ed.join(""),reasoning:Object.values(i.#eu||{}),reasoningText:e,sources:i.#eg,files:i.#ef,steps:i.#el,usage:i.#J,totalUsage:i.#ez(),warnings:i.#ek,finishReason:"suspended",content:i.messageList.get.response.aiV5.stepContent(),object:void 0,request:i.#eI,response:{},providerMetadata:void 0})}Object.entries(i.#ex).forEach(([e,t])=>{"pending"===t.status.type&&t.reject(Error(`promise '${e}' was not resolved or rejected when stream finished`))}),i.#ei=!0,i.#eo.emit("finish")}})),n&&this.deserializeState(n)}resolvePromise(e,t){if(!(e in this.#ex))throw new eN.MastraError({id:"MASTRA_MODEL_OUTPUT_INVALID_PROMISE_KEY",domain:"LLM",category:"SYSTEM",text:`Attempted to resolve invalid promise key '${e}' with value '${"object"==typeof t?JSON.stringify(t,null,2):t}'`});this.#ex[e].resolve(t)}resolvePromises(e){for(let t in e)this.resolvePromise(t,e[t])}#eM(e){return this.#eT||this.consumeStream(),e.promise}get text(){return this.#eM(this.#ex.text)}get reasoning(){return this.#eM(this.#ex.reasoning)}get reasoningText(){return this.#eM(this.#ex.reasoningText)}get sources(){return this.#eM(this.#ex.sources)}get files(){return this.#eM(this.#ex.files)}get steps(){return this.#eM(this.#ex.steps)}get suspendPayload(){return this.#eM(this.#ex.suspendPayload)}get fullStream(){return this.#eP()}get finishReason(){return this.#eM(this.#ex.finishReason)}get toolCalls(){return this.#eM(this.#ex.toolCalls)}get toolResults(){return this.#eM(this.#ex.toolResults)}get usage(){return this.#eM(this.#ex.usage)}get warnings(){return this.#eM(this.#ex.warnings)}get providerMetadata(){return this.#eM(this.#ex.providerMetadata)}get response(){return this.#eM(this.#ex.response)}get request(){return this.#eM(this.#ex.request)}get error(){return this.#ea}updateUsageCount(e){e&&(void 0!==e.inputTokens&&(this.#J.inputTokens=(this.#J.inputTokens??0)+e.inputTokens),void 0!==e.outputTokens&&(this.#J.outputTokens=(this.#J.outputTokens??0)+e.outputTokens),void 0!==e.totalTokens&&(this.#J.totalTokens=(this.#J.totalTokens??0)+e.totalTokens),void 0!==e.reasoningTokens&&(this.#J.reasoningTokens=(this.#J.reasoningTokens??0)+e.reasoningTokens),void 0!==e.cachedInputTokens&&(this.#J.cachedInputTokens=(this.#J.cachedInputTokens??0)+e.cachedInputTokens))}populateUsageCount(e){e&&(void 0!==e.inputTokens&&void 0===this.#J.inputTokens&&(this.#J.inputTokens=e.inputTokens),void 0!==e.outputTokens&&void 0===this.#J.outputTokens&&(this.#J.outputTokens=e.outputTokens),void 0!==e.totalTokens&&void 0===this.#J.totalTokens&&(this.#J.totalTokens=e.totalTokens),void 0!==e.reasoningTokens&&void 0===this.#J.reasoningTokens&&(this.#J.reasoningTokens=e.reasoningTokens),void 0!==e.cachedInputTokens&&void 0===this.#J.cachedInputTokens&&(this.#J.cachedInputTokens=e.cachedInputTokens))}async consumeStream(e){if(!this.#eT){this.#eT=!0;try{await wM({stream:this.#es,onError:e?.onError,logger:this.logger})}catch(t){e?.onError?.(t)}}}async getFullOutput(){let e;await this.consumeStream({onError:e=>{throw this.logger.error("Error consuming stream",e),e}}),this.#eE&&(e={input:{inputMessages:this.messageList.getPersisted.input.db(),rememberedMessages:this.messageList.getPersisted.remembered.db(),systemMessages:this.messageList.getSystemMessages(),taggedSystemMessages:this.messageList.getPersisted.taggedSystemMessages},output:this.messageList.getPersisted.response.db()});let t=await this.steps;return{text:t.map(e=>e.text||"").join(""),usage:await this.usage,steps:t,finishReason:await this.finishReason,warnings:await this.warnings,providerMetadata:await this.providerMetadata,request:await this.request,reasoning:await this.reasoning,reasoningText:await this.reasoningText,toolCalls:await this.toolCalls,toolResults:await this.toolResults,sources:await this.sources,files:await this.files,response:await this.response,totalUsage:await this.totalUsage,object:await this.object,error:this.error,tripwire:this.#eS,...e?{scoringData:e}:{},traceId:this.traceId,runId:this.runId,suspendPayload:await this.suspendPayload,messages:this.messageList.get.all.db(),rememberedMessages:this.messageList.get.remembered.db()}}get tripwire(){return this.#eS}get totalUsage(){return this.#eM(this.#ex.totalUsage)}get content(){return this.#eM(this.#ex.content)}get objectStream(){return this.#eP().pipeThrough(new wl.TransformStream({transform(e,t){"object"===e.type&&t.enqueue(e.object)}}))}get elementStream(){let e=0;return this.#eP().pipeThrough(new wl.TransformStream({transform(t,r){if("object"===t.type&&Array.isArray(t.object))for(;e<t.object.length;e++)r.enqueue(t.object[e])}}))}get textStream(){if("direct"===this.#eA){let t=wq(this.#r.structuredOutput?.schema);if(t?.outputFormat==="array"){var e;let t,r,a,s;return this.#eP().pipeThrough((e=this.#r.structuredOutput?.schema,t=0,r=!1,a=0,s=wq(e),new wl.TransformStream({transform(e,n){if("object"===e.type&&e.object)if(s?.outputFormat==="array"&&Array.isArray(e.object)){if(1==++a&&e.object.length>0){n.enqueue(JSON.stringify(e.object)),t=e.object.length,r=!0;return}r||(n.enqueue("["),r=!0);for(let r=t;r<e.object.length;r++){let t=JSON.stringify(e.object[r]);r>0?n.enqueue(","+t):n.enqueue(t)}t=e.object.length}else n.enqueue(JSON.stringify(e.object))},flush(e){r&&s?.outputFormat==="array"&&a>1&&e.enqueue("]")}})))}}return this.#eP().pipeThrough(new wl.TransformStream({transform(e,t){"text-delta"===e.type&&t.enqueue(e.payload.text)}}))}get object(){return this.processorRunner||this.#r.structuredOutput?.schema||"pending"!==this.#ex.object.status.type||this.#ex.object.resolve(void 0),this.#eM(this.#ex.object)}_getImmediateToolCalls(){return this.#eb}_getImmediateToolResults(){return this.#ew}_getImmediateText(){return this.#ed.join("")}_getImmediateObject(){return this.#ec}_getImmediateUsage(){return this.#J}_getImmediateWarnings(){return this.#ek}_getImmediateFinishReason(){return this.#e_}_getBaseStream(){return this.#es}#ez(){let e=this.#J.totalTokens;return void 0===e&&(e=(this.#J.inputTokens??0)+(this.#J.outputTokens??0)+(this.#J.reasoningTokens??0)),{inputTokens:this.#J.inputTokens,outputTokens:this.#J.outputTokens,totalTokens:e,reasoningTokens:this.#J.reasoningTokens,cachedInputTokens:this.#J.cachedInputTokens}}#eO(e){this.#en.push(e),this.#eo.emit("chunk",e)}#eP(){let e=this;return new wl.ReadableStream({start(t){if(e.#en.forEach(e=>{t.enqueue(e)}),e.#ei)return void t.close();let r=e=>{t.enqueue(e)},a=()=>{e.#eo.off("chunk",r),e.#eo.off("finish",a),t.close()};e.#eo.on("chunk",r),e.#eo.on("finish",a)},pull(t){e.#eT||e.consumeStream()},cancel(){e.#eo.removeAllListeners()}})}get status(){return this.#er}serializeState(){return{status:this.#er,bufferedSteps:this.#el,bufferedReasoningDetails:this.#eu,bufferedByStep:this.#ep,bufferedText:this.#ed,bufferedTextChunks:this.#em,bufferedSources:this.#eg,bufferedReasoning:this.#eh,bufferedFiles:this.#ef,toolCallArgsDeltas:this.#ey,toolCallDeltaIdNameMap:this.#ev,toolCalls:this.#eb,toolResults:this.#ew,warnings:this.#ek,finishReason:this.#e_,request:this.#eI,usageCount:this.#J,tripwire:this.#eS,messageList:this.messageList.serialize()}}deserializeState(e){this.#er=e.status,this.#el=e.bufferedSteps,this.#eu=e.bufferedReasoningDetails,this.#ep=e.bufferedByStep,this.#ed=e.bufferedText,this.#em=e.bufferedTextChunks,this.#eg=e.bufferedSources,this.#eh=e.bufferedReasoning,this.#ef=e.bufferedFiles,this.#ey=e.toolCallArgsDeltas,this.#ev=e.toolCallDeltaIdNameMap,this.#eb=e.toolCalls,this.#ew=e.toolResults,this.#ek=e.warnings,this.#e_=e.finishReason,this.#eI=e.request,this.#J=e.usageCount,this.#eS=e.tripwire,this.messageList=this.messageList.deserialize(e.messageList)}};async function wV({stream:e,onError:t}){let r=e.getReader();try{for(;;){let{done:e}=await r.read();if(e)break}}catch(e){null==t||t(e)}finally{r.releaseLock()}}var wK=class{#er="running";#eR;#J={inputTokens:0,outputTokens:0,totalTokens:0,cachedInputTokens:0,reasoningTokens:0};#eT=!1;#es;#eo=new wu.default;#en=[];#ei=!1;#eC;#ex={usage:new wO,result:new wO};runId;workflowId;constructor({runId:e,workflowId:t,stream:r}){const a=this;this.runId=e,this.workflowId=t,this.#es=r,r.pipeTo(new wl.WritableStream({start(){let e={type:"workflow-start",runId:a.runId,from:"WORKFLOW",payload:{workflowId:a.workflowId}};a.#en.push(e),a.#eo.emit("chunk",e)},write(e){if("workflow-step-finish"!==e.type&&(a.#en.push(e),a.#eo.emit("chunk",e)),"workflow-step-output"===e.type){if("output"in e.payload&&e.payload.output){let t=e.payload.output;if("finish"===t.type){if(t.payload&&"usage"in t.payload&&t.payload.usage)a.#ej(t.payload.usage);else if(t.payload&&"output"in t.payload&&t.payload.output){let e=t.payload.output;"usage"in e&&e.usage&&a.#ej(e.usage)}}}}else"workflow-canceled"===e.type?a.#er="canceled":"workflow-step-suspended"===e.type?a.#er="suspended":"workflow-step-result"===e.type&&"failed"===e.payload.status?e.payload.tripwire?(a.#er="tripwire",a.#eR=e.payload.tripwire):a.#er="failed":"workflow-paused"===e.type&&(a.#er="paused")},close(){"running"===a.#er&&(a.#er="success"),a.#eo.emit("chunk",{type:"workflow-finish",runId:a.runId,from:"WORKFLOW",payload:{workflowStatus:a.#er,metadata:a.#eC?{error:a.#eC,errorMessage:a.#eC?.message}:{},output:{usage:a.#J},..."tripwire"===a.#er&&a.#eR?{tripwire:a.#eR}:{}}}),a.#ex.usage.resolve(a.#J),Object.entries(a.#ex).forEach(([e,t])=>{"pending"===t.status.type&&t.reject(Error(`promise '${e}' was not resolved or rejected when stream finished`))}),a.#ei=!0,a.#eo.emit("finish")}})).catch(e=>{console.log(" something went wrong",e)})}#eM(e){return this.#eT||this.consumeStream(),e.promise}#ej(e){let t={inputTokens:this.#J.inputTokens??0,outputTokens:this.#J.outputTokens??0,totalTokens:this.#J.totalTokens??0,reasoningTokens:this.#J.reasoningTokens??0,cachedInputTokens:this.#J.cachedInputTokens??0};"inputTokens"in e?(t.inputTokens+=parseInt(e?.inputTokens?.toString()??"0",10),t.outputTokens+=parseInt(e?.outputTokens?.toString()??"0",10)):"promptTokens"in e&&(t.inputTokens+=parseInt(e?.promptTokens?.toString()??"0",10),t.outputTokens+=parseInt(e?.completionTokens?.toString()??"0",10)),t.totalTokens+=parseInt(e?.totalTokens?.toString()??"0",10),t.reasoningTokens+=parseInt(e?.reasoningTokens?.toString()??"0",10),t.cachedInputTokens+=parseInt(e?.cachedInputTokens?.toString()??"0",10),this.#J=t}updateResults(e){this.#ex.result.resolve(e)}rejectResults(e){this.#ex.result.reject(e),this.#er="failed",this.#eC=e}resume(e){this.#es=e,this.#ei=!1,this.#eT=!1,this.#er="running",this.#ex={usage:new wO,result:new wO};let t=this;e.pipeTo(new wl.WritableStream({start(){let e={type:"workflow-start",runId:t.runId,from:"WORKFLOW",payload:{workflowId:t.workflowId}};t.#en.push(e),t.#eo.emit("chunk",e)},write(e){if("workflow-step-finish"!==e.type&&(t.#en.push(e),t.#eo.emit("chunk",e)),"workflow-step-output"===e.type){if("output"in e.payload&&e.payload.output){let r=e.payload.output;if("finish"===r.type){if(r.payload&&"usage"in r.payload&&r.payload.usage)t.#ej(r.payload.usage);else if(r.payload&&"output"in r.payload&&r.payload.output){let e=r.payload.output;"usage"in e&&e.usage&&t.#ej(e.usage)}}}}else"workflow-canceled"===e.type?t.#er="canceled":"workflow-step-suspended"===e.type?t.#er="suspended":"workflow-step-result"===e.type&&"failed"===e.payload.status?e.payload.tripwire?(t.#er="tripwire",t.#eR=e.payload.tripwire):t.#er="failed":"workflow-paused"===e.type&&(t.#er="paused")},close(){"running"===t.#er&&(t.#er="success"),t.#eo.emit("chunk",{type:"workflow-finish",runId:t.runId,from:"WORKFLOW",payload:{workflowStatus:t.#er,metadata:t.#eC?{error:t.#eC,errorMessage:t.#eC?.message}:{},output:{usage:t.#J},..."tripwire"===t.#er&&t.#eR?{tripwire:t.#eR}:{}}}),t.#ei=!0,t.#eo.emit("finish")}})).catch(e=>{console.log(" something went wrong",e)})}async consumeStream(e){if(!this.#eT){this.#eT=!0;try{await wV({stream:this.#es,onError:e?.onError})}catch(t){e?.onError?.(t)}}}get fullStream(){let e=this;return new wl.ReadableStream({start(t){if(e.#en.forEach(e=>{t.enqueue(e)}),e.#ei)return void t.close();let r=e=>{t.enqueue(e)},a=()=>{e.#eo.off("chunk",r),e.#eo.off("finish",a),t.close()};e.#eo.on("chunk",r),e.#eo.on("finish",a)},pull(t){e.#eT||e.consumeStream()},cancel(){e.#eo.removeAllListeners()}})}get status(){return this.#er}get result(){return this.#eM(this.#ex.result)}get usage(){return this.#eM(this.#ex.usage)}get locked(){return console.warn("WorkflowRunOutput.locked is deprecated. Use fullStream.locked instead."),this.fullStream.locked}cancel(e){return console.warn("WorkflowRunOutput.cancel() is deprecated. Use fullStream.cancel() instead."),this.fullStream.cancel(e)}getReader(e){return console.warn("WorkflowRunOutput.getReader() is deprecated. Use fullStream.getReader() instead."),this.fullStream.getReader(e)}pipeThrough(e,t){return console.warn("WorkflowRunOutput.pipeThrough() is deprecated. Use fullStream.pipeThrough() instead."),this.fullStream.pipeThrough(e,t)}pipeTo(e,t){return console.warn("WorkflowRunOutput.pipeTo() is deprecated. Use fullStream.pipeTo() instead."),this.fullStream.pipeTo(e,t)}tee(){return console.warn("WorkflowRunOutput.tee() is deprecated. Use fullStream.tee() instead."),this.fullStream.tee()}[Symbol.asyncIterator](){return console.warn("WorkflowRunOutput[Symbol.asyncIterator]() is deprecated. Use fullStream[Symbol.asyncIterator]() instead."),this.fullStream[Symbol.asyncIterator]()}toReadableStream(){return console.warn("WorkflowRunOutput.toReadableStream() is deprecated. Use fullStream directly instead."),this.fullStream}},wG=class extends Error{options;processorId;constructor(e,t={},r){super(e),this.options=t,this.processorId=r,Object.setPrototypeOf(this,new.target.prototype)}},wW=async({tripwire:e,runId:t,tracingContext:r,options:a,model:s,messageList:n})=>{let i=new wl.ReadableStream({start(r){r.enqueue({type:"tripwire",runId:t,from:"AGENT",payload:{reason:e.reason||"",retry:e.retry,metadata:e.metadata,processorId:e.processorId}}),r.close()}});return new wB({model:{modelId:s.modelId,provider:s.provider,version:s.specificationVersion},stream:i,messageList:n,options:{runId:t,structuredOutput:a.structuredOutput,tracingContext:r,onFinish:a.onFinish,onStepFinish:a.onStepFinish,returnScorerData:a.returnScorerData,requestContext:a.requestContext},messageId:(0,cz.randomUUID)()})};function wQ({runId:e,scorerId:t,scorerObject:r,input:a,output:s,requestContext:n,entity:i,structuredOutput:o,source:l,entityType:u,threadId:p,resourceId:d,tracingContext:c}){let m=!1;if(r?.sampling&&r?.sampling?.type!=="none"||(m=!0),r?.sampling?.type&&(m=r?.sampling?.type!=="ratio"||Math.random()<r?.sampling?.rate),!m)return;let g={scorer:{id:r.scorer?.id||t,name:r.scorer?.name,description:r.scorer.description},input:a,output:s,requestContext:Object.fromEntries(n.entries()),runId:e,source:l,entity:i,structuredOutput:o,entityType:u,threadId:p,resourceId:d,tracingContext:c};setImmediate(()=>{wi.emit("onScorerRun",g)})}var wJ=class extends ws{emitter;constructor(e){super(),this.emitter=e??new wu.default}async publish(e,t){let r=crypto.randomUUID(),a=new Date;this.emitter.emit(e,{...t,id:r,createdAt:a})}async subscribe(e,t){this.emitter.on(e,t)}async unsubscribe(e,t){this.emitter.off(e,t)}async flush(){}async close(){this.emitter.removeAllListeners()}},wH=sg.object({type:sg.literal("text"),text:sg.string()}).passthrough(),wY=sg.object({type:sg.literal("image"),image:sg.union([sg.string(),sg.instanceof(URL),sg.instanceof(Uint8Array)]),mimeType:sg.string().optional()}).passthrough(),wX=sg.object({type:sg.literal("file"),data:sg.union([sg.string(),sg.instanceof(URL),sg.instanceof(Uint8Array)]),mimeType:sg.string()}).passthrough(),w0=sg.object({type:sg.literal("tool-invocation"),toolInvocation:sg.object({toolCallId:sg.string(),toolName:sg.string(),args:sg.unknown(),state:sg.enum(["partial-call","call","result"]),result:sg.unknown().optional()})}).passthrough(),w1=sg.object({type:sg.literal("reasoning"),reasoning:sg.string(),details:sg.array(sg.object({type:sg.enum(["text","redacted"]),text:sg.string().optional(),data:sg.string().optional()}))}).passthrough(),w2=sg.object({type:sg.literal("source"),source:sg.object({sourceType:sg.string(),id:sg.string(),url:sg.string().optional(),title:sg.string().optional()})}).passthrough(),w3=sg.object({type:sg.literal("step-start")}).passthrough(),w5=sg.object({type:sg.string().refine(e=>e.startsWith("data-"),{message:'Type must start with "data-"'}),id:sg.string().optional(),data:sg.unknown()}).passthrough(),w4=sg.union([wH,wY,wX,w0,w1,w2,w3,w5]);sg.object({format:sg.literal(2),parts:sg.array(w4),content:sg.string().optional(),metadata:sg.record(sg.unknown()).optional(),providerMetadata:sg.record(sg.unknown()).optional()});var w6=sg.object({format:sg.literal(2),parts:sg.array(w4),content:sg.string().optional(),metadata:sg.record(sg.unknown()).optional(),providerMetadata:sg.record(sg.unknown()).optional()}).passthrough(),w7=sg.object({id:sg.string(),role:sg.enum(["user","assistant","system","tool"]),createdAt:sg.coerce.date(),threadId:sg.string().optional(),resourceId:sg.string().optional(),type:sg.string().optional(),content:w6}).passthrough(),w9=sg.custom(),w8=sg.array(w7),ke=sg.object({type:sg.literal("text"),text:sg.string()}).passthrough();sg.object({role:sg.literal("system"),content:sg.union([sg.string(),sg.array(ke)]),experimental_providerMetadata:sg.record(sg.unknown()).optional()}).passthrough();var kt=sg.object({role:sg.enum(["system","user","assistant","tool"]),content:sg.unknown()}).passthrough(),kr=sg.array(kt),ka=sg.object({toolName:sg.string(),toolCallId:sg.string(),args:sg.unknown()}),ks=sg.number().optional(),kn=sg.object({phase:sg.literal("input"),messages:w8,messageList:w9,systemMessages:kr.optional(),retryCount:ks}),ki=sg.object({phase:sg.literal("inputStep"),messages:w8,messageList:w9,stepNumber:sg.number().describe("The current step number (0-indexed)"),systemMessages:kr.optional(),retryCount:ks,model:sg.custom().optional().describe("Current model for this step"),tools:sg.custom().optional().describe("Current tools available for this step"),toolChoice:sg.custom().optional().describe("Current tool choice setting"),activeTools:sg.array(sg.string()).optional().describe("Currently active tools"),providerOptions:sg.custom().optional().describe("Provider-specific options"),modelSettings:sg.custom().optional().describe("Model settings (temperature, etc.)"),structuredOutput:sg.custom().optional().describe("Structured output configuration"),steps:sg.custom().optional().describe("Results from previous steps")}),ko=sg.object({phase:sg.literal("outputStream"),part:sg.unknown().nullable().describe("The current chunk being processed. Can be null to skip."),streamParts:sg.array(sg.unknown()).describe("All chunks seen so far"),state:sg.record(sg.unknown()).describe("Mutable state object that persists across chunks"),messageList:w9.optional(),retryCount:ks}),kl=sg.object({phase:sg.literal("outputResult"),messages:w8,messageList:w9,retryCount:ks}),ku=sg.object({phase:sg.literal("outputStep"),messages:w8,messageList:w9,stepNumber:sg.number().describe("The current step number (0-indexed)"),finishReason:sg.string().optional().describe("The finish reason from the LLM (stop, tool-use, length, etc.)"),toolCalls:sg.array(ka).optional().describe("Tool calls made in this step (if any)"),text:sg.string().optional().describe("Generated text from this step"),systemMessages:kr.optional(),retryCount:ks}),kp=sg.discriminatedUnion("phase",[kn,ki,ko,kl,ku]),kd=sg.object({phase:sg.enum(["input","inputStep","outputStream","outputResult","outputStep"]),messages:w8.optional(),messageList:w9.optional(),systemMessages:kr.optional(),stepNumber:sg.number().optional(),part:sg.unknown().nullable().optional(),streamParts:sg.array(sg.unknown()).optional(),state:sg.record(sg.unknown()).optional(),finishReason:sg.string().optional(),toolCalls:sg.array(ka).optional(),text:sg.string().optional(),retryCount:sg.number().optional(),model:sg.custom().optional(),tools:sg.custom().optional(),toolChoice:sg.custom().optional(),activeTools:sg.array(sg.string()).optional(),providerOptions:sg.custom().optional(),modelSettings:sg.custom().optional(),structuredOutput:sg.custom().optional(),steps:sg.custom().optional()}),kc=class extends wo.MastraBase{mastra;options;constructor({mastra:e,options:t}){super({name:"ExecutionEngine",component:eD.RegisteredLogger.WORKFLOW}),this.mastra=e,this.options=t}__registerMastra(e){this.mastra=e}getLogger(){return this.logger}async invokeLifecycleCallbacks(e){let{onFinish:t,onError:r}=this.options,a={runId:e.runId,workflowId:e.workflowId,resourceId:e.resourceId,getInitData:()=>e.input,mastra:this.mastra,requestContext:e.requestContext,logger:this.logger,state:e.state};if(t)try{await Promise.resolve(t({status:e.status,result:e.result,error:e.error,steps:e.steps,tripwire:e.tripwire,...a}))}catch(e){this.logger.error("Error in onFinish callback",{error:e})}if(r&&("failed"===e.status||"tripwire"===e.status))try{await Promise.resolve(r({status:e.status,error:e.error,steps:e.steps,tripwire:e.tripwire,...a}))}catch(e){this.logger.error("Error in onError callback",{error:e})}}},km=(e,t)=>{let r;if("string"==typeof t)r=e[t];else{if(!t?.id)return null;r=e[t.id]}return r?.status==="success"?r.output:null};function kg(e){return e.issues}async function kh({prevOutput:e,step:t,validateInputs:r}){let a,s=e;if(r&&v0(t.inputSchema)){let r=t.inputSchema,n=await r.safeParseAsync(e);if(n.success)s=(e=>{if(!0===e||!1===e||null==e)return!0;if(wp(e))return 0===e;if("[object Date]"===Object.prototype.toString.call(e))return isNaN(e.getTime());if(e&&e.constructor&&e.call&&e.apply||e&&e.constructor===Symbol)return!1;let t=e.length;if(wp(t))return 0===t;let r=e.size;return wp(r)?0===r:0===Object.keys(e).length})(n.data)?e:n.data;else{let e=kg(n.error).map(e=>`- ${e.path?.join(".")}: ${e.message}`).join("\n");a=new eN.MastraError({id:"WORKFLOW_STEP_INPUT_VALIDATION_FAILED",domain:"MASTRA_WORKFLOW",category:"USER",text:"Step input validation failed: \n"+e},n.error)}}return{inputData:s,validationError:a}}async function kf({resumeData:e,step:t}){let r;if(!e)return{resumeData:void 0,validationError:void 0};let a=t.resumeSchema;if(a&&v0(a)){let t=await a.safeParseAsync(e);if(t.success)e=t.data;else{let e=kg(t.error).map(e=>`- ${e.path?.join(".")}: ${e.message}`).join("\n");r=new eN.MastraError({id:"WORKFLOW_STEP_RESUME_DATA_VALIDATION_FAILED",domain:"MASTRA_WORKFLOW",category:"USER",text:"Step resume data validation failed: \n"+e},t.error)}}return{resumeData:e,validationError:r}}async function ky({suspendData:e,step:t,validateInputs:r}){let a;if(!e)return{suspendData:void 0,validationError:void 0};let s=t.suspendSchema;if(s&&r&&v0(s)){let t=await s.safeParseAsync(e);if(t.success)e=t.data;else{let e=kg(t.error).map(e=>`- ${e.path?.join(".")}: ${e.message}`).join("\n");a=new eN.MastraError({id:"WORKFLOW_STEP_SUSPEND_DATA_VALIDATION_FAILED",domain:"MASTRA_WORKFLOW",category:"USER",text:"Step suspend data validation failed: \n"+e},t.error)}}return{suspendData:e,validationError:a}}async function kv({stateData:e,step:t,validateInputs:r}){let a;if(!e)return{stateData:void 0,validationError:void 0};let s=t.stateSchema;if(s&&r&&v0(s)){let t=await s.safeParseAsync(e);t.success?e=t.data:a=Error("Step state data validation failed: \n"+kg(t.error).map(e=>`- ${e.path?.join(".")}: ${e.message}`).join("\n"))}return{stateData:e,validationError:a}}var kb="Warning: 'runCount' is deprecated and will be removed on November 4th, 2025. Please use 'retryCount' instead.",kw=new Set;function kk(e,{paramName:t,deprecationMessage:r,logger:a}){return new Proxy(e,{get:(e,s,n)=>(s!==t||kw.has(t)||(kw.add(t),a?a.warn("\x1b[33m%s\x1b[0m",r):console.warn("\x1b[33m%s\x1b[0m",r)),Reflect.get(e,s,n))})}var k_=e=>"step"===e.type||"foreach"===e.type||"loop"===e.type?[e.step.id]:"parallel"===e.type||"conditional"===e.type?e.steps.map(e=>e.step.id):"sleep"===e.type||"sleepUntil"===e.type?[e.id]:[];async function kI(e,t){let r,{workflowId:a,runId:s,resourceId:n,entry:i,prevStep:o,serializedStepGraph:l,stepResults:u,resume:p,restart:d,timeTravel:c,executionContext:m,tracingContext:g,pubsub:h,abortController:f,requestContext:y,outputWriter:v,disableScorers:b,perStep:w}=t,k=await e.createChildSpan({parentSpan:g.currentSpan,operationId:`workflow.${a}.run.${s}.parallel.${m.executionPath.join("-")}.span.start`,options:{type:"workflow_parallel",name:`parallel: '${i.steps.length} branches'`,input:e.getStepOutput(u,o),attributes:{branchCount:i.steps.length,parallelSteps:i.steps.map(e=>"step"===e.type?e.step.id:`control-${e.type}`)}},executionContext:m}),_=e.getStepOutput(u,o);for(let[e,t]of i.steps.entries()){let r=!0;if(d&&(r=!!d.activeStepsPath[t.step.id]),c&&c.executionPath.length>0&&(r=c.steps[0]===t.step.id),!r)break;let a=p?.steps[0]===t.step.id?void 0:Date.now(),s=p?.steps[0]===t.step.id?Date.now():void 0;if(u[t.step.id]={...u[t.step.id],status:"running",...s?{resumePayload:p?.resumePayload}:{payload:_},...a?{startedAt:a}:{},...s?{resumedAt:s}:{}},m.activeStepsPath[t.step.id]=[...m.executionPath,e],w)break}c&&c.executionPath.length>0&&c.executionPath.shift();let I=await Promise.all(i.steps.map(async(t,r)=>{let i=u[t.step.id];if(i&&"running"!==i.status)return i;if(!i&&(w||c))return{};let o=await e.executeStep({workflowId:a,runId:s,resourceId:n,step:t.step,prevOutput:_,stepResults:u,serializedStepGraph:l,restart:d,timeTravel:c,resume:p,executionContext:{activeStepsPath:m.activeStepsPath,workflowId:a,runId:s,executionPath:[...m.executionPath,r],suspendedPaths:m.suspendedPaths,resumeLabels:m.resumeLabels,retryConfig:m.retryConfig,state:m.state,tracingIds:m.tracingIds},tracingContext:{currentSpan:k},pubsub:h,abortController:f,requestContext:y,outputWriter:v,disableScorers:b,perStep:w});return e.applyMutableContext(m,o.mutableContext),Object.assign(u,o.stepResults),o.result})),S=I.find(e=>"failed"===e.status),x=I.find(e=>"suspended"===e.status);return"failed"===(r=S?{status:"failed",error:S.error,tripwire:S.tripwire}:x?{status:"suspended",suspendPayload:x.suspendPayload,...x.suspendOutput?{suspendOutput:x.suspendOutput}:{}}:f?.signal?.aborted?{status:"canceled"}:{status:"success",output:I.reduce((e,t,r)=>("success"===t.status&&(e[i.steps[r].step.id]=t.output),e),{})}).status?await e.errorChildSpan({span:k,operationId:`workflow.${a}.run.${s}.parallel.${m.executionPath.join("-")}.span.error`,errorOptions:{error:r.error}}):await e.endChildSpan({span:k,operationId:`workflow.${a}.run.${s}.parallel.${m.executionPath.join("-")}.span.end`,endOptions:{output:r.output||r}}),r}async function kS(e,t){let r,{workflowId:a,runId:s,resourceId:n,entry:i,prevOutput:o,serializedStepGraph:l,stepResults:u,resume:p,restart:d,timeTravel:c,executionContext:m,tracingContext:g,pubsub:h,abortController:f,requestContext:y,outputWriter:v,disableScorers:b,perStep:w}=t,k=await e.createChildSpan({parentSpan:g.currentSpan,operationId:`workflow.${a}.run.${s}.conditional.${m.executionPath.join("-")}.span.start`,options:{type:"workflow_conditional",name:`conditional: '${i.conditions.length} conditions'`,input:o,attributes:{conditionCount:i.conditions.length}},executionContext:m}),_=(await Promise.all(i.conditions.map(async(t,r)=>{let n=await e.createChildSpan({parentSpan:k,operationId:`workflow.${a}.run.${s}.conditional.${m.executionPath.join("-")}.eval.${r}.span.start`,options:{type:"workflow_conditional_eval",name:`condition '${r}'`,input:o,attributes:{conditionIndex:r}},executionContext:m}),i=`workflow.${a}.conditional.${r}`,l=kk({runId:s,workflowId:a,mastra:e.mastra,requestContext:y,inputData:o,state:m.state,retryCount:-1,tracingContext:{currentSpan:n},getInitData:()=>u?.input,getStepResult:km.bind(null,u),bail:()=>{},abort:()=>{f?.abort()},[sd]:h,[sc]:m.format,engine:e.getEngineContext(),abortSignal:f?.signal,writer:new cb({prefix:"workflow-step",callId:(0,cz.randomUUID)(),name:"conditional",runId:s},v)},{paramName:"runCount",deprecationMessage:kb,logger:e.getLogger()});try{let o=await e.evaluateCondition(t,r,l,i);return await e.endChildSpan({span:n,operationId:`workflow.${a}.run.${s}.conditional.${m.executionPath.join("-")}.eval.${r}.span.end`,endOptions:{output:null!==o,attributes:{result:null!==o}}}),o}catch(o){let t=(0,eN.getErrorFromUnknown)(o,{serializeStack:!1}),i=new eN.MastraError({id:"WORKFLOW_CONDITION_EVALUATION_FAILED",domain:"MASTRA_WORKFLOW",category:"USER",details:{workflowId:a,runId:s}},t);return e.getLogger()?.trackException(i),e.getLogger()?.error("Error evaluating condition: "+t.stack),await e.errorChildSpan({span:n,operationId:`workflow.${a}.run.${s}.conditional.${m.executionPath.join("-")}.eval.${r}.span.error`,errorOptions:{error:i,attributes:{result:!1}}}),null}}))).filter(e=>null!==e),I=i.steps.filter((e,t)=>_.includes(t));if(w||c&&c.executionPath.length>0){let e=I.filter(e=>{let t=u[e.step.id];return c&&c.executionPath.length>0?c.steps[0]===e.step.id:!t}),t=e?.[0];I=t?[t]:I}k?.update({attributes:{truthyIndexes:_,selectedSteps:I.map(e=>"step"===e.type?e.step.id:`control-${e.type}`)}});let S=await Promise.all(I.map(async(t,r)=>{let i=u[t.step.id],g=d?!!d.activeStepsPath[t.step.id]:void 0;if(i&&c&&c.executionPath.length>0&&c.steps[0]!==t.step.id||i&&["success","failed"].includes(i.status)&&void 0===g)return i;let _=await e.executeStep({workflowId:a,runId:s,resourceId:n,step:t.step,prevOutput:o,stepResults:u,serializedStepGraph:l,resume:p,restart:d,timeTravel:c,executionContext:{workflowId:a,runId:s,executionPath:[...m.executionPath,r],activeStepsPath:m.activeStepsPath,suspendedPaths:m.suspendedPaths,resumeLabels:m.resumeLabels,retryConfig:m.retryConfig,state:m.state,tracingIds:m.tracingIds},tracingContext:{currentSpan:k},pubsub:h,abortController:f,requestContext:y,outputWriter:v,disableScorers:b,perStep:w});return e.applyMutableContext(m,_.mutableContext),Object.assign(u,_.stepResults),_.result})),x=S.find(e=>"failed"===e.status),T=S.find(e=>"suspended"===e.status);return"failed"===(r=x?{status:"failed",error:x.error,tripwire:x.tripwire}:T?{status:"suspended",suspendPayload:T.suspendPayload,...T.suspendOutput?{suspendOutput:T.suspendOutput}:{},suspendedAt:T.suspendedAt}:f?.signal?.aborted?{status:"canceled"}:{status:"success",output:S.reduce((e,t,r)=>("success"===t.status&&(e[I[r].step.id]=t.output),e),{})}).status?await e.errorChildSpan({span:k,operationId:`workflow.${a}.run.${s}.conditional.${m.executionPath.join("-")}.span.error`,errorOptions:{error:r.error}}):await e.endChildSpan({span:k,operationId:`workflow.${a}.run.${s}.conditional.${m.executionPath.join("-")}.span.end`,endOptions:{output:r.output||r}}),r}async function kx(e,t){let{workflowId:r,runId:a,resourceId:s,entry:n,prevOutput:i,stepResults:o,resume:l,restart:u,timeTravel:p,executionContext:d,tracingContext:c,pubsub:m,abortController:g,requestContext:h,outputWriter:f,disableScorers:y,serializedStepGraph:v,perStep:b}=t,{step:w,condition:k}=n,_=await e.createChildSpan({parentSpan:c.currentSpan,operationId:`workflow.${r}.run.${a}.loop.${d.executionPath.join("-")}.span.start`,options:{type:"workflow_loop",name:`loop: '${n.loopType}'`,input:i,attributes:{loopType:n.loopType}},executionContext:d}),I=!0,S=o[w.id]?.metadata?.iterationCount,x=S?S-1:0,T={status:"success",output:o[w.id]?.payload??i},E=l,A=u,O=p;do{let t=await e.executeStep({workflowId:r,runId:a,resourceId:s,step:w,stepResults:o,executionContext:d,restart:A,resume:E,timeTravel:O,prevOutput:T.output,tracingContext:{currentSpan:_},pubsub:m,abortController:g,requestContext:h,outputWriter:f,disableScorers:y,serializedStepGraph:v,iterationCount:x+1,perStep:b});if(e.applyMutableContext(d,t.mutableContext),Object.assign(o,t.stepResults),T=t.result,A=void 0,O=void 0,E&&"suspended"!==T.status&&(E=void 0),"success"!==T.status)return await e.endChildSpan({span:_,operationId:`workflow.${r}.run.${a}.loop.${d.executionPath.join("-")}.span.end.early`,endOptions:{attributes:{totalIterations:x}}}),T;let i=await e.createChildSpan({parentSpan:_,operationId:`workflow.${r}.run.${a}.loop.${d.executionPath.join("-")}.eval.${x}.span.start`,options:{type:"workflow_conditional_eval",name:`condition: '${n.loopType}'`,input:function(e,t){if(!e||"object"!=typeof e)return e;let r={};for(let s of t){var a;let t=(a=e,s.split(".").reduce((e,t)=>e&&"object"==typeof e?e[t]:void 0,a));void 0!==t&&function(e,t,r){let a=t.split("."),s=a.pop();s&&(a.reduce((e,t)=>(e[t]&&"object"==typeof e[t]||(e[t]={}),e[t]),e)[s]=r)}(r,s,t)}return r}(T.output,["stepResult","output.text","output.object","messages"]),attributes:{conditionIndex:x}},executionContext:d});I=await k(kk({workflowId:r,runId:a,mastra:e.mastra,requestContext:h,inputData:T.output,state:d.state,retryCount:-1,tracingContext:{currentSpan:i},iterationCount:x+1,getInitData:()=>o?.input,getStepResult:km.bind(null,o),bail:()=>{},abort:()=>{g?.abort()},[sd]:m,[sc]:d.format,engine:e.getEngineContext(),abortSignal:g?.signal,writer:new cb({prefix:"workflow-step",callId:(0,cz.randomUUID)(),name:"loop",runId:a},f)},{paramName:"runCount",deprecationMessage:kb,logger:e.getLogger()})),await e.endChildSpan({span:i,operationId:`workflow.${r}.run.${a}.loop.${d.executionPath.join("-")}.eval.${x}.span.end`,endOptions:{output:I}}),x++}while("dowhile"===n.loopType?I:!I)return await e.endChildSpan({span:_,operationId:`workflow.${r}.run.${a}.loop.${d.executionPath.join("-")}.span.end`,endOptions:{output:T.output,attributes:{totalIterations:x}}}),T}async function kT(e,t){var r,a;let{workflowId:s,runId:n,resourceId:i,entry:o,prevOutput:l,stepResults:u,restart:p,resume:d,timeTravel:c,executionContext:m,tracingContext:g,pubsub:h,abortController:f,requestContext:y,outputWriter:v,disableScorers:b,serializedStepGraph:w,perStep:k}=t,{step:_,opts:I}=o,S=[],x=I.concurrency,T=d?.steps[0]===_.id?void 0:Date.now(),E=d?.steps[0]===_.id?Date.now():void 0,A={...u[_.id],...d?.steps[0]===_.id?{resumePayload:d?.resumePayload}:{payload:l},...T?{startedAt:T}:{},...E?{resumedAt:E}:{}},O=await e.createChildSpan({parentSpan:g.currentSpan,operationId:`workflow.${s}.run.${n}.foreach.${m.executionPath.join("-")}.span.start`,options:{type:"workflow_loop",name:"loop: 'foreach'",input:l,attributes:{loopType:"foreach",concurrency:x}},executionContext:m});await h.publish(`workflow.events.v2.${n}`,{type:"watch",runId:n,data:{type:"workflow-step-start",payload:{id:_.id,...A,status:"running"}}});let z=u[_.id],M={},P=z?.status==="suspended"&&z?.suspendPayload?.__workflow_meta?.foreachIndex||0,R=z?.suspendPayload?.__workflow_meta?.foreachOutput||[],C=(r=z?.suspendPayload?.__workflow_meta?.resumeLabels||{},a=_.id,Object.entries(r).filter(([e,t])=>t.stepId===a).reduce((e,[t,r])=>(e[t]=r,e),{}));for(let t=0;t<l.length;t+=x){let r=l.slice(t,t+x);for(let[a,o]of(await Promise.all(r.map(async(r,a)=>{let o,l=t+a,g=R[l];if(g?.status==="success"||g?.status==="suspended"&&d?.forEachIndex!==l&&d?.forEachIndex!==void 0)return g;d?.forEachIndex!==void 0?o=d.forEachIndex===l?d:void 0:(g?.status==="suspended"||P===l)&&(o=d);let I=await e.executeStep({workflowId:s,runId:n,resourceId:i,step:_,stepResults:u,restart:p,timeTravel:c,executionContext:{...m,foreachIndex:l},resume:o,prevOutput:r,tracingContext:{currentSpan:O},pubsub:h,abortController:f,requestContext:y,skipEmits:!0,outputWriter:v,disableScorers:b,serializedStepGraph:w,perStep:k});return e.applyMutableContext(m,I.mutableContext),Object.assign(u,I.stepResults),I.result}))).entries()){if("success"!==o.status){let{status:e,error:r,suspendPayload:s,suspendedAt:i,endedAt:l,output:u}=o,p={status:e,error:r,suspendPayload:s,suspendedAt:i,endedAt:l,output:u};if("suspended"!==p.status)return await h.publish(`workflow.events.v2.${n}`,{type:"watch",runId:n,data:{type:"workflow-step-result",payload:{id:_.id,...p}}}),await h.publish(`workflow.events.v2.${n}`,{type:"watch",runId:n,data:{type:"workflow-step-finish",payload:{id:_.id,metadata:{}}}}),o;M[t+a]=p}else{let e=Object.keys(C).find(e=>C[e]?.foreachIndex===t+a);delete C[e]}o?.output&&(S[t+a]=o?.output),R[t+a]={...o,suspendPayload:{}}}if(Object.keys(M).length>0){let e=Object.keys(M).map(Number)[0];return await h.publish(`workflow.events.v2.${n}`,{type:"watch",runId:n,data:{type:"workflow-step-suspended",payload:{id:_.id,...M[e]}}}),m.suspendedPaths[_.id]=m.executionPath,m.resumeLabels={...C,...m.resumeLabels},{...A,suspendedAt:Date.now(),status:"suspended",...M[e].suspendOutput?{suspendOutput:M[e].suspendOutput}:{},suspendPayload:{...M[e].suspendPayload,__workflow_meta:{...M[e].suspendPayload?.__workflow_meta,foreachIndex:e,foreachOutput:R,resumeLabels:m.resumeLabels}}}}}return await h.publish(`workflow.events.v2.${n}`,{type:"watch",runId:n,data:{type:"workflow-step-result",payload:{id:_.id,status:"success",output:S,endedAt:Date.now()}}}),await h.publish(`workflow.events.v2.${n}`,{type:"watch",runId:n,data:{type:"workflow-step-finish",payload:{id:_.id,metadata:{}}}}),await e.endChildSpan({span:O,operationId:`workflow.${s}.run.${n}.foreach.${m.executionPath.join("-")}.span.end`,endOptions:{output:S}}),{...A,status:"success",output:S,endedAt:Date.now()}}async function kE(e,t){let{workflowId:r,runId:a,resourceId:s,stepResults:n,serializedStepGraph:i,executionContext:o,workflowStatus:l,result:u,error:p,requestContext:d}=t,c=`workflow.${r}.run.${a}.path.${JSON.stringify(o.executionPath)}.stepUpdate`;await e.wrapDurableOperation(c,async()=>{if(!e.options?.shouldPersistSnapshot?.({stepResults:n,workflowStatus:l}))return;let t={};d.forEach((e,r)=>{t[r]=e});let c=await e.mastra?.getStorage()?.getStore("workflows");await c?.persistWorkflowSnapshot({workflowName:r,runId:a,resourceId:s,snapshot:{runId:a,status:l,value:o.state,context:n,activePaths:o.executionPath,activeStepsPath:o.activeStepsPath,serializedStepGraph:i,suspendedPaths:o.suspendedPaths,waitingPaths:{},resumeLabels:o.resumeLabels,result:u,error:p,requestContext:t,timestamp:Date.now()}})})}async function kA(e,t){let r,a,{workflowId:s,runId:n,resourceId:i,entry:o,prevStep:l,serializedStepGraph:u,stepResults:p,restart:d,timeTravel:c,resume:m,executionContext:g,tracingContext:h,pubsub:f,abortController:y,requestContext:v,outputWriter:b,disableScorers:w,perStep:k}=t,_=e.getStepOutput(p,l);if("step"===o.type){let{step:t}=o,l=await e.executeStep({workflowId:s,runId:n,resourceId:i,step:t,stepResults:p,executionContext:g,timeTravel:c,restart:d,resume:m,prevOutput:_,tracingContext:h,pubsub:f,abortController:y,requestContext:v,outputWriter:b,disableScorers:w,serializedStepGraph:u,perStep:k});r=l.result,e.applyMutableContext(g,l.mutableContext),Object.assign(p,l.stepResults),a=l.requestContext}else if(m?.resumePath?.length&&"parallel"===o.type){let t=m.resumePath.shift(),a=await kA(e,{workflowId:s,runId:n,resourceId:i,entry:o.steps[t],prevStep:l,serializedStepGraph:u,stepResults:p,resume:m,executionContext:{workflowId:s,runId:n,executionPath:[...g.executionPath,t],suspendedPaths:g.suspendedPaths,resumeLabels:g.resumeLabels,retryConfig:g.retryConfig,activeStepsPath:g.activeStepsPath,state:g.state},tracingContext:h,pubsub:f,abortController:y,requestContext:v,outputWriter:b,disableScorers:w,perStep:k});if(e.applyMutableContext(g,a.mutableContext),Object.assign(p,a.stepResults),o.steps.every(e=>{if("step"===e.type){let t=p[e.step.id];return t&&"success"===t.status}return!0}))r={status:"success",output:o.steps.reduce((e,t)=>{if("step"===t.type){let r=p[t.step.id];r&&"success"===r.status&&(e[t.step.id]=r.output)}return e},{})};else{let e=o.steps.find(e=>{if("step"===e.type){let t=p[e.step.id];return t&&"suspended"===t.status}return!1});r={status:"suspended",payload:e&&"step"===e.type?p[e.step.id]?.suspendPayload:{}}}return"suspended"===r.status&&o.steps.forEach((e,t)=>{if("step"===e.type){let r=p[e.step.id];r&&"suspended"===r.status&&(g.suspendedPaths[e.step.id]=[...g.executionPath,t])}}),{result:r,stepResults:p,mutableContext:e.buildMutableContext(g),requestContext:a.requestContext}}else if("parallel"===o.type)r=await e.executeParallel({workflowId:s,runId:n,entry:o,prevStep:l,stepResults:p,serializedStepGraph:u,timeTravel:c,restart:d,resume:m,executionContext:g,tracingContext:h,pubsub:f,abortController:y,requestContext:v,outputWriter:b,disableScorers:w,perStep:k});else if("conditional"===o.type)r=await e.executeConditional({workflowId:s,runId:n,entry:o,prevOutput:_,stepResults:p,serializedStepGraph:u,timeTravel:c,restart:d,resume:m,executionContext:g,tracingContext:h,pubsub:f,abortController:y,requestContext:v,outputWriter:b,disableScorers:w,perStep:k});else if("loop"===o.type)r=await e.executeLoop({workflowId:s,runId:n,entry:o,prevStep:l,prevOutput:_,stepResults:p,timeTravel:c,restart:d,resume:m,executionContext:g,tracingContext:h,pubsub:f,abortController:y,requestContext:v,outputWriter:b,disableScorers:w,serializedStepGraph:u,perStep:k});else if("foreach"===o.type)r=await e.executeForeach({workflowId:s,runId:n,entry:o,prevStep:l,prevOutput:_,stepResults:p,timeTravel:c,restart:d,resume:m,executionContext:g,tracingContext:h,pubsub:f,abortController:y,requestContext:v,outputWriter:b,disableScorers:w,serializedStepGraph:u,perStep:k});else if("sleep"===o.type){let t=Date.now(),a=`workflow.${s}.run.${n}.sleep.${o.id}.waiting_ev`;await e.wrapDurableOperation(a,async()=>{await f.publish(`workflow.events.v2.${n}`,{type:"watch",runId:n,data:{type:"workflow-step-waiting",payload:{id:o.id,payload:_,startedAt:t,status:"waiting"}}})}),p[o.id]={status:"waiting",payload:_,startedAt:t},g.activeStepsPath[o.id]=g.executionPath,await e.persistStepUpdate({workflowId:s,runId:n,resourceId:i,serializedStepGraph:u,stepResults:p,executionContext:g,workflowStatus:"waiting",requestContext:v}),await e.executeSleep({workflowId:s,runId:n,entry:o,prevStep:l,prevOutput:_,stepResults:p,serializedStepGraph:u,resume:m,executionContext:g,tracingContext:h,pubsub:f,abortController:y,requestContext:v,outputWriter:b}),delete g.activeStepsPath[o.id],await e.persistStepUpdate({workflowId:s,runId:n,resourceId:i,serializedStepGraph:u,stepResults:p,executionContext:g,workflowStatus:"running",requestContext:v});let d=Date.now(),c={payload:_,startedAt:t,endedAt:d};r={...c,status:"success",output:_},p[o.id]={...c,status:"success",output:_};let w=`workflow.${s}.run.${n}.sleep.${o.id}.result_ev`;await e.wrapDurableOperation(w,async()=>{await f.publish(`workflow.events.v2.${n}`,{type:"watch",runId:n,data:{type:"workflow-step-result",payload:{id:o.id,endedAt:d,status:"success",output:_}}}),await f.publish(`workflow.events.v2.${n}`,{type:"watch",runId:n,data:{type:"workflow-step-finish",payload:{id:o.id,metadata:{}}}})})}else if("sleepUntil"===o.type){let t=Date.now(),a=`workflow.${s}.run.${n}.sleepUntil.${o.id}.waiting_ev`;await e.wrapDurableOperation(a,async()=>{await f.publish(`workflow.events.v2.${n}`,{type:"watch",runId:n,data:{type:"workflow-step-waiting",payload:{id:o.id,payload:_,startedAt:t,status:"waiting"}}})}),p[o.id]={status:"waiting",payload:_,startedAt:t},g.activeStepsPath[o.id]=g.executionPath,await e.persistStepUpdate({workflowId:s,runId:n,resourceId:i,serializedStepGraph:u,stepResults:p,executionContext:g,workflowStatus:"waiting",requestContext:v}),await e.executeSleepUntil({workflowId:s,runId:n,entry:o,prevStep:l,prevOutput:_,stepResults:p,serializedStepGraph:u,resume:m,executionContext:g,tracingContext:h,pubsub:f,abortController:y,requestContext:v,outputWriter:b}),delete g.activeStepsPath[o.id],await e.persistStepUpdate({workflowId:s,runId:n,resourceId:i,serializedStepGraph:u,stepResults:p,executionContext:g,workflowStatus:"running",requestContext:v});let d=Date.now(),c={payload:_,startedAt:t,endedAt:d};r={...c,status:"success",output:_},p[o.id]={...c,status:"success",output:_};let w=`workflow.${s}.run.${n}.sleepUntil.${o.id}.result_ev`;await e.wrapDurableOperation(w,async()=>{await f.publish(`workflow.events.v2.${n}`,{type:"watch",runId:n,data:{type:"workflow-step-result",payload:{id:o.id,endedAt:d,status:"success",output:_}}}),await f.publish(`workflow.events.v2.${n}`,{type:"watch",runId:n,data:{type:"workflow-step-finish",payload:{id:o.id,metadata:{}}}})})}return("step"===o.type||"loop"===o.type||"foreach"===o.type)&&(p[o.step.id]=r),y?.signal?.aborted&&(r={...r,status:"canceled"}),await e.persistStepUpdate({workflowId:s,runId:n,resourceId:i,serializedStepGraph:u,stepResults:p,executionContext:g,workflowStatus:"success"===r.status?"running":r.status,requestContext:v}),"canceled"===r.status&&await f.publish(`workflow.events.v2.${n}`,{type:"watch",runId:n,data:{type:"workflow-canceled",payload:{}}}),{result:r,stepResults:p,mutableContext:e.buildMutableContext(g),requestContext:a??e.serializeRequestContext(v)}}async function kO(e,t){let{workflowId:r,runId:a,entry:s,prevOutput:n,stepResults:i,pubsub:o,abortController:l,requestContext:u,executionContext:p,outputWriter:d,tracingContext:c}=t,{duration:m,fn:g}=s,h=await e.createChildSpan({parentSpan:c.currentSpan,operationId:`workflow.${r}.run.${a}.sleep.${s.id}.span.start`,options:{type:"workflow_sleep",name:`sleep: ${m?`${m}ms`:"dynamic"}`,attributes:{durationMs:m,sleepType:g?"dynamic":"fixed"}},executionContext:p});if(g){let t=(0,cz.randomUUID)();m=await e.wrapDurableOperation(`workflow.${r}.sleep.${s.id}`,async()=>g({runId:a,workflowId:r,mastra:e.mastra,requestContext:u,inputData:n,state:p.state,setState:async e=>{p.state=e},retryCount:-1,tracingContext:{currentSpan:h},getInitData:()=>i?.input,getStepResult:km.bind(null,i),suspend:async e=>{},bail:()=>{},abort:()=>{l?.abort()},[sd]:o,[sc]:p.format,engine:e.getEngineContext(),abortSignal:l?.signal,writer:new cb({prefix:"workflow-step",callId:t,name:"sleep",runId:a},d)})),h?.update({attributes:{durationMs:m}})}try{await e.executeSleepDuration(!m||m<0?0:m,s.id,r),await e.endChildSpan({span:h,operationId:`workflow.${r}.run.${a}.sleep.${s.id}.span.end`})}catch(t){throw await e.errorChildSpan({span:h,operationId:`workflow.${r}.run.${a}.sleep.${s.id}.span.error`,errorOptions:{error:t}}),t}}async function kz(e,t){let{workflowId:r,runId:a,entry:s,prevOutput:n,stepResults:i,pubsub:o,abortController:l,requestContext:u,executionContext:p,outputWriter:d,tracingContext:c}=t,{date:m,fn:g}=s,h=await e.createChildSpan({parentSpan:c.currentSpan,operationId:`workflow.${r}.run.${a}.sleepUntil.${s.id}.span.start`,options:{type:"workflow_sleep",name:`sleepUntil: ${m?m.toISOString():"dynamic"}`,attributes:{untilDate:m,durationMs:m?Math.max(0,m.getTime()-Date.now()):void 0,sleepType:g?"dynamic":"fixed"}},executionContext:p});if(g){let t=(0,cz.randomUUID)(),c=await e.wrapDurableOperation(`workflow.${r}.sleepUntil.${s.id}`,async()=>g({runId:a,workflowId:r,mastra:e.mastra,requestContext:u,inputData:n,state:p.state,setState:async e=>{p.state=e},retryCount:-1,tracingContext:{currentSpan:h},getInitData:()=>i?.input,getStepResult:km.bind(null,i),suspend:async e=>{},bail:()=>{},abort:()=>{l?.abort()},[sd]:o,[sc]:p.format,engine:e.getEngineContext(),abortSignal:l?.signal,writer:new cb({prefix:"workflow-step",callId:t,name:"sleepUntil",runId:a},d)})),f=(m=c instanceof Date?c:new Date(c))?m.getTime()-Date.now():0;h?.update({attributes:{durationMs:Math.max(0,f)}})}if(!m)return void await e.endChildSpan({span:h,operationId:`workflow.${r}.run.${a}.sleepUntil.${s.id}.span.end.nodate`});try{await e.executeSleepUntilDate(m,s.id,r),await e.endChildSpan({span:h,operationId:`workflow.${r}.run.${a}.sleepUntil.${s.id}.span.end`})}catch(t){throw await e.errorChildSpan({span:h,operationId:`workflow.${r}.run.${a}.sleepUntil.${s.id}.span.error`,errorOptions:{error:t}}),t}}async function kM(e,t){let r,a,{workflowId:s,runId:n,resourceId:i,step:o,stepResults:l,executionContext:u,restart:p,resume:d,timeTravel:c,prevOutput:m,pubsub:g,abortController:h,requestContext:f,skipEmits:y=!1,outputWriter:v,disableScorers:b,serializedStepGraph:w,tracingContext:k,iterationCount:_,perStep:I}=t,S=(0,cz.randomUUID)(),{inputData:x,validationError:T}=await kh({prevOutput:m,step:o,validateInputs:e.options?.validateInputs??!0}),{resumeData:E,validationError:A}=await kf({resumeData:c?.stepResults[o.id]?.status==="suspended"?c?.resumeData:void 0,step:o});E&&!A?r=E:E&&A?e.getLogger().warn("Time travel resume data validation failed",{stepId:o.id,error:A.message}):d?.steps[0]===o.id&&(r=d?.resumePayload);let O=l[o.id]?.status==="suspended"?l[o.id]?.suspendPayload:void 0;if(O&&"__workflow_meta"in O){let{__workflow_meta:e,...t}=O;O=t}let z=r?void 0:Date.now(),M=r?Date.now():void 0,P={...l[o.id],...r?{resumePayload:r}:{payload:x},...z?{startedAt:z}:{},...M?{resumedAt:M}:{},status:"running",..._?{metadata:{iterationCount:_}}:{}};u.activeStepsPath[o.id]=u.executionPath;let R=await e.createStepSpan({parentSpan:k.currentSpan,stepId:o.id,operationId:`workflow.${s}.run.${n}.step.${o.id}.span.start`,options:{name:`workflow step: '${o.id}'`,type:"workflow_step",entityType:"workflow_step",entityId:o.id,input:x,tracingPolicy:e.options?.tracingPolicy},executionContext:u}),C=`workflow.${s}.run.${n}.step.${o.id}.running_ev`;if(await e.onStepExecutionStart({step:o,inputData:x,pubsub:g,executionContext:u,stepCallId:S,stepInfo:P,operationId:C,skipEmits:y}),await e.persistStepUpdate({workflowId:s,runId:n,resourceId:i,serializedStepGraph:w,stepResults:{...l,[o.id]:P},executionContext:u,workflowStatus:"running",requestContext:f}),e.isNestedWorkflowStep(o)){let t=await e.executeWorkflowStep({step:o,stepResults:l,executionContext:u,resume:d,timeTravel:c,prevOutput:m,inputData:x,pubsub:g,startedAt:z??Date.now(),abortController:h,requestContext:f,tracingContext:k,outputWriter:v,stepSpan:R,perStep:I});if(null!==t){if(R)if("failed"===t.status)await e.errorStepSpan({span:R,operationId:`workflow.${s}.run.${n}.step.${o.id}.span.error`,errorOptions:{error:t.error instanceof Error?t.error:Error(String(t.error)),attributes:{status:"failed"}}});else{let r="success"===t.status?t.output:t.suspendOutput;await e.endStepSpan({span:R,operationId:`workflow.${s}.run.${n}.step.${o.id}.span.end`,endOptions:{output:r,attributes:{status:t.status}}})}let r={...P,...t};return{result:r,stepResults:{[o.id]:r},mutableContext:e.buildMutableContext(u),requestContext:e.serializeRequestContext(f)}}}let j=async t=>{let r=kk(t,{paramName:"runCount",deprecationMessage:kb,logger:e.getLogger()});return o.execute(r)},N=o.retries??u.retryConfig.attempts??0,L=u.retryConfig.delay??0,D=await e.executeStepWithRetry(`workflow.${s}.step.${o.id}`,async()=>{let t,a;if(T)throw T;let m=e.getOrGenerateRetryCount(o.id),y=[];c&&c.steps.length>0&&(y=c.steps[0]===o.id?c.steps.slice(1):[]);let w={suspendedPaths:{},resumeLabels:{},stateUpdate:null,requestContextUpdate:null},k="WORKFLOW"===o.component,_=e.mastra?k?e.mastra:p3(e.mastra,{currentSpan:R}):void 0,E=await j({runId:n,resourceId:i,workflowId:s,mastra:_,requestContext:f,inputData:x,state:u.state,setState:async t=>{let{stateData:r,validationError:a}=await kv({stateData:t,step:o,validateInputs:e.options?.validateInputs??!0});if(a)throw a;w.stateUpdate=r},retryCount:m,resumeData:r,suspendData:O,tracingContext:{currentSpan:R},getInitData:()=>l?.input,getStepResult:km.bind(null,l),suspend:async(r,a)=>{let{suspendData:s,validationError:n}=await ky({suspendData:r,step:o,validateInputs:e.options?.validateInputs??!0});if(n)throw n;if(w.suspendedPaths[o.id]=u.executionPath,u.suspendedPaths[o.id]=u.executionPath,a?.resumeLabel)for(let e of Array.isArray(a.resumeLabel)?a.resumeLabel:[a.resumeLabel]){let t={stepId:o.id,foreachIndex:u.foreachIndex};w.resumeLabels[e]=t,u.resumeLabels[e]=t}t={payload:s}},bail:e=>{a={payload:e}},abort:()=>{h?.abort()},resume:l[o.id]?.status==="suspended"?{steps:d?.steps?.slice(1)||[],resumePayload:d?.resumePayload,runId:l[o.id]?.suspendPayload?.__workflow_meta?.runId,label:d?.label,forEachIndex:d?.forEachIndex}:void 0,restart:!!p?.activeStepsPath?.[o.id],timeTravel:y.length>0?{inputData:c?.inputData,steps:y,nestedStepResults:c?.nestedStepResults,resumeData:c?.resumeData}:void 0,[sd]:g,[sc]:u.format,engine:e.getEngineContext(),abortSignal:h?.signal,writer:new cb({prefix:"workflow-step",callId:S,name:o.id,runId:n},v),outputWriter:v,scorers:!1===b?void 0:o.scorers,validateInputs:e.options?.validateInputs,perStep:I});e.requiresDurableContextSerialization()&&(w.requestContextUpdate=e.serializeRequestContext(f));let A="WORKFLOW"===o.component&&I;return{output:E,suspended:t,bailed:a,contextMutations:w,nestedWflowStepPaused:A}},{retries:N,delay:L,stepSpan:R,workflowId:s,runId:n});if(D.ok){let{result:t}=D;if(Object.assign(u.suspendedPaths,t.contextMutations.suspendedPaths),Object.assign(u.resumeLabels,t.contextMutations.resumeLabels),e.requiresDurableContextSerialization()&&t.contextMutations.requestContextUpdate)for(let[e,r]of(f.clear(),Object.entries(t.contextMutations.requestContextUpdate)))f.set(e,r);o.scorers&&await kP({engine:e,scorers:o.scorers,runId:n,input:x,output:t.output,workflowId:s,stepId:o.id,requestContext:f,disableScorers:b,tracingContext:{currentSpan:R}}),a=t.suspended?{status:"suspended",suspendPayload:t.suspended.payload,...t.output?{suspendOutput:t.output}:{},suspendedAt:Date.now()}:t.bailed?{status:"bailed",output:t.bailed.payload,endedAt:Date.now()}:t.nestedWflowStepPaused?{status:"paused"}:{status:"success",output:t.output,endedAt:Date.now()}}else a=D.error;if(delete u.activeStepsPath[o.id],!y){let t=`workflow.${s}.run.${n}.step.${o.id}.emit_result`;await e.wrapDurableOperation(t,async()=>{await kR({stepId:o.id,stepCallId:S,execResults:{...P,...a},pubsub:g,runId:n})})}"failed"!=a.status&&await e.endStepSpan({span:R,operationId:`workflow.${s}.run.${n}.step.${o.id}.span.end`,endOptions:{output:a.output,attributes:{status:a.status}}});let q={...P,...a};return{result:q,stepResults:{[o.id]:q},mutableContext:e.buildMutableContext({...u,state:D.ok?D.result.contextMutations.stateUpdate??u.state:u.state}),requestContext:e.serializeRequestContext(f)}}async function kP(e){let{engine:t,scorers:r,runId:a,input:s,output:n,workflowId:i,stepId:o,requestContext:l,disableScorers:u,tracingContext:p}=e,d=r;if("function"==typeof d)try{d=await d({requestContext:l})}catch(s){let e=(0,eN.getErrorFromUnknown)(s,{serializeStack:!1}),r=new eN.MastraError({id:"WORKFLOW_FAILED_TO_FETCH_SCORERS",domain:"MASTRA_WORKFLOW",category:"USER",details:{runId:a,workflowId:i,stepId:o}},e);t.getLogger()?.trackException(r),t.getLogger()?.error("Error fetching scorers: "+e?.stack)}if(!u&&d&&Object.keys(d||{}).length>0)for(let[e,t]of Object.entries(d||{}))wQ({scorerId:t.name,scorerObject:t,runId:a,input:s,output:n,requestContext:l,entity:{id:i,stepId:o},structuredOutput:!0,source:"LIVE",entityType:"WORKFLOW",tracingContext:p})}async function kR(e){let{stepId:t,stepCallId:r,execResults:a,pubsub:s,runId:n}=e,i=r?{id:t,stepCallId:r}:{id:t};"suspended"===a.status?await s.publish(`workflow.events.v2.${n}`,{type:"watch",runId:n,data:{type:"workflow-step-suspended",payload:{...i,...a}}}):(await s.publish(`workflow.events.v2.${n}`,{type:"watch",runId:n,data:{type:"workflow-step-result",payload:{...i,...a}}}),await s.publish(`workflow.events.v2.${n}`,{type:"watch",runId:n,data:{type:"workflow-step-finish",payload:{...i,metadata:{}}}}))}var kC=class extends kc{retryCounts=new Map;getOrGenerateRetryCount(e){if(this.retryCounts.has(e)){let t=this.retryCounts.get(e)+1;return this.retryCounts.set(e,t),t}return this.retryCounts.set(e,0),0}isNestedWorkflowStep(e){return!1}async executeSleepDuration(e,t,r){await new Promise(t=>setTimeout(t,e<0?0:e))}async executeSleepUntilDate(e,t,r){let a=e.getTime()-Date.now();await new Promise(e=>setTimeout(e,a<0?0:a))}async wrapDurableOperation(e,t){return t()}getEngineContext(){return{}}async evaluateCondition(e,t,r,a){return this.wrapDurableOperation(a,async()=>await e(r)?t:null)}async onStepExecutionStart(e){return this.wrapDurableOperation(e.operationId,async()=>{let t=Date.now();return e.skipEmits||await e.pubsub.publish(`workflow.events.v2.${e.executionContext.runId}`,{type:"watch",runId:e.executionContext.runId,data:{type:"workflow-step-start",payload:{id:e.step.id,stepCallId:e.stepCallId,...e.stepInfo}}}),t})}async executeWorkflowStep(e){return null}async createStepSpan(e){return e.parentSpan?.createChildSpan(e.options)}async endStepSpan(e){e.span?.end(e.endOptions)}async errorStepSpan(e){e.span?.error(e.errorOptions)}async createChildSpan(e){return e.parentSpan?.createChildSpan(e.options)}async endChildSpan(e){e.span?.end(e.endOptions)}async errorChildSpan(e){e.span?.error(e.errorOptions)}async executeStepWithRetry(e,t,r){for(let a=0;a<r.retries+1;a++){a>0&&r.delay&&await new Promise(e=>setTimeout(e,r.delay));try{let r=await this.wrapDurableOperation(e,t);return{ok:!0,result:r}}catch(t){if(a===r.retries){let a=(0,eN.getErrorFromUnknown)(t,{serializeStack:!1,fallbackMessage:"Unknown step execution error"}),s=new eN.MastraError({id:"WORKFLOW_STEP_INVOKE_FAILED",domain:"MASTRA_WORKFLOW",category:"USER",details:{workflowId:r.workflowId,runId:r.runId,stepId:e}},a);return this.logger?.trackException(s),this.logger?.error(`Error executing step ${e}: `+a?.stack),r.stepSpan?.error({error:s,attributes:{status:"failed"}}),{ok:!1,error:{status:"failed",error:a,endedAt:Date.now(),tripwire:t instanceof wG?{reason:t.message,retry:t.options?.retry,metadata:t.options?.metadata,processorId:t.processorId}:void 0}}}}}return{ok:!1,error:{status:"failed",error:Error("Unknown error"),endedAt:Date.now()}}}formatResultError(e,t){let r=t?.error;return(0,eN.getErrorFromUnknown)(e||r,{serializeStack:!1,fallbackMessage:"Unknown workflow error"}).toJSON()}async fmtReturnValue(e,t,r,a){let s={status:r.status,steps:t,input:t.input};if("success"===r.status)s.result=r.output;else if("failed"===r.status){let e=r?.tripwire;e instanceof wG?(s.status="tripwire",s.tripwire={reason:e.message,retry:e.options?.retry,metadata:e.options?.metadata,processorId:e.processorId}):e&&"object"==typeof e&&"reason"in e?(s.status="tripwire",s.tripwire=e):s.error=this.formatResultError(a,r)}else if("suspended"===r.status){let e={};s.suspended=Object.entries(t).flatMap(([t,r])=>{if(r?.status==="suspended"){let{__workflow_meta:a,...s}=r?.suspendPayload??{};e[t]=s;let n=a?.path;return n?[[t,...n]]:[[t]]}return[]}),s.suspendPayload=e}return s}serializeRequestContext(e){let t={};return e.forEach((e,r)=>{t[r]=e}),t}deserializeRequestContext(e){return new Map(Object.entries(e))}requiresDurableContextSerialization(){return!1}buildMutableContext(e){return{state:e.state,suspendedPaths:e.suspendedPaths,resumeLabels:e.resumeLabels}}applyMutableContext(e,t){Object.assign(e.state,t.state),Object.assign(e.suspendedPaths,t.suspendedPaths),Object.assign(e.resumeLabels,t.resumeLabels)}async execute(e){let t,r,{workflowId:a,runId:s,resourceId:n,graph:i,input:o,initialState:l,resume:u,retryConfig:p,workflowSpan:d,disableScorers:c,restart:m,timeTravel:g,perStep:h}=e,{attempts:f=0,delay:y=0}=p??{},v=i.steps;if(this.retryCounts.clear(),0===v.length){let e=new eN.MastraError({id:"WORKFLOW_EXECUTE_EMPTY_GRAPH",text:"Workflow must have at least one step",domain:"MASTRA_WORKFLOW",category:"USER"});throw d?.error({error:e}),e}let b=0;g?(b=g.executionPath[0],g.executionPath.shift()):m?(b=m.activePaths[0],m.activePaths.shift()):u?.resumePath&&(b=u.resumePath[0],u.resumePath.shift());let w=g?.stepResults||m?.stepResults||u?.stepResults||{input:o},k=g?.state??m?.state??l??{},_=e.requestContext;for(let i=b;i<v.length;i++){let p=v[i],b={workflowId:a,runId:s,executionPath:[i],activeStepsPath:{},suspendedPaths:{},resumeLabels:{},retryConfig:{attempts:f,delay:y},format:e.format,state:k??l,tracingIds:e.tracingIds};if(r=b,t=await this.executeEntry({workflowId:a,runId:s,resourceId:n,entry:p,executionContext:b,serializedStepGraph:e.serializedStepGraph,prevStep:v[i-1],stepResults:w,resume:u,timeTravel:g,restart:m,tracingContext:{currentSpan:d},abortController:e.abortController,pubsub:e.pubsub,requestContext:_,outputWriter:e.outputWriter,disableScorers:c,perStep:h}),this.applyMutableContext(b,t.mutableContext),k=t.mutableContext.state,this.requiresDurableContextSerialization()&&t.requestContext&&(_=this.deserializeRequestContext(t.requestContext)),"success"!==t.result.status){"bailed"===t.result.status&&(t.result.status="success");let r=await this.fmtReturnValue(e.pubsub,w,t.result);return await this.persistStepUpdate({workflowId:a,runId:s,resourceId:n,stepResults:t.stepResults,serializedStepGraph:e.serializedStepGraph,executionContext:b,workflowStatus:r.status,result:r.result,error:r.error,requestContext:_}),r.error?d?.error({error:r.error,attributes:{status:r.status}}):d?.end({output:r.result,attributes:{status:r.status}}),"paused"!==t.result.status&&await this.invokeLifecycleCallbacks({status:r.status,result:r.result,error:r.error,steps:r.steps,tripwire:r.tripwire,runId:s,workflowId:a,resourceId:n,input:o,requestContext:_,state:k}),"paused"===t.result.status&&await e.pubsub.publish(`workflow.events.v2.${s}`,{type:"watch",runId:s,data:{type:"workflow-paused",payload:{}}}),{...r,..."suspended"===t.result.status&&e.outputOptions?.includeResumeLabels?{resumeLabels:t.mutableContext.resumeLabels}:{},...e.outputOptions?.includeState?{state:k}:{}}}if(h){let i=await this.fmtReturnValue(e.pubsub,w,t.result);return await this.persistStepUpdate({workflowId:a,runId:s,resourceId:n,stepResults:t.stepResults,serializedStepGraph:e.serializedStepGraph,executionContext:r,workflowStatus:"paused",requestContext:_}),await e.pubsub.publish(`workflow.events.v2.${s}`,{type:"watch",runId:s,data:{type:"workflow-paused",payload:{}}}),d?.end({attributes:{status:"paused"}}),delete i.result,{...i,status:"paused",...e.outputOptions?.includeState?{state:k}:{}}}}let I=await this.fmtReturnValue(e.pubsub,w,t.result);return(await this.persistStepUpdate({workflowId:a,runId:s,resourceId:n,stepResults:t.stepResults,serializedStepGraph:e.serializedStepGraph,executionContext:r,workflowStatus:I.status,result:I.result,error:I.error,requestContext:_}),d?.end({output:I.result,attributes:{status:I.status}}),await this.invokeLifecycleCallbacks({status:I.status,result:I.result,error:I.error,steps:I.steps,tripwire:I.tripwire,runId:s,workflowId:a,resourceId:n,input:o,requestContext:_,state:k}),e.outputOptions?.includeState)?{...I,state:k}:I}getStepOutput(e,t){if(!t)return e.input;if("step"===t.type)return e[t.step.id]?.output;if("sleep"===t.type||"sleepUntil"===t.type)return e[t.id]?.output;if("parallel"===t.type||"conditional"===t.type)return t.steps.reduce((t,r)=>(t[r.step.id]=e[r.step.id]?.output,t),{});if("loop"===t.type)return e[t.step.id]?.output;else if("foreach"===t.type)return e[t.step.id]?.output}async executeSleep(e){return kO(this,e)}async executeSleepUntil(e){return kz(this,e)}async executeStep(e){return kM(this,e)}async executeParallel(e){return kI(this,e)}async executeConditional(e){return kS(this,e)}async executeLoop(e){return kx(this,e)}async executeForeach(e){return kT(this,e)}async persistStepUpdate(e){return kE(this,e)}async executeEntry(e){return kA(this,e)}};function kj(e,t){if(e instanceof _g)return function(e,t){let r=t??{},a=r?.structuredOutput?.schema??sg.object({text:sg.string()}),{retries:s,scorers:n,...i}=r??{};return{id:e.id,description:e.getDescription(),inputSchema:sg.object({prompt:sg.string()}),outputSchema:a,retries:s,scorers:n,execute:async({inputData:t,runId:r,[sd]:a,[sc]:s,requestContext:n,tracingContext:o,abortSignal:l,abort:u,writer:p})=>{let d,c={};c.promise=new Promise((e,t)=>{c.resolve=e,c.reject=t});let m=null,g={name:e.name,args:t};if("v1"===(await e.getModel()).specificationVersion){let{fullStream:r}=await e.streamLegacy(t.prompt,{...i,requestContext:n,tracingContext:o,onFinish:e=>{i?.structuredOutput?.schema&&e.object&&(m=e.object),c.resolve(e.text),i?.onFinish?.(e)},abortSignal:l});d=r}else d=(await e.stream(t.prompt,{...i,requestContext:n,tracingContext:o,onFinish:e=>{i?.structuredOutput?.schema&&e.object&&(m=e.object),c.resolve(e.text),i?.onFinish?.(e)},abortSignal:l})).fullStream;let h=null;if("legacy"===s){for await(let e of(await a.publish(`workflow.events.v2.${r}`,{type:"watch",runId:r,data:{type:"tool-call-streaming-start",...g??{}}}),d)){if("tripwire"===e.type){h=e;break}"text-delta"===e.type&&await a.publish(`workflow.events.v2.${r}`,{type:"watch",runId:r,data:{type:"tool-call-delta",...g??{},argsTextDelta:e.textDelta}})}await a.publish(`workflow.events.v2.${r}`,{type:"watch",runId:r,data:{type:"tool-call-streaming-finish",...g??{}}})}else for await(let e of d)if(await p.write(e),"tripwire"===e.type){h=e;break}if(h)throw new wG(h.payload?.reason||"Agent tripwire triggered",{retry:h.payload?.retry,metadata:h.payload?.metadata},h.payload?.processorId);return l.aborted?u():null!==m?m:{text:await c.promise}},component:e.component}}(e,t);if(e instanceof cE){var r,a,s=e,n=t;if(!s.inputSchema||!s.outputSchema)throw Error("Tool must have input and output schemas defined");return{id:s.id,description:s.description,inputSchema:s.inputSchema,outputSchema:s.outputSchema,resumeSchema:s.resumeSchema,suspendSchema:s.suspendSchema,retries:n?.retries,scorers:n?.scorers,execute:async({inputData:e,mastra:t,requestContext:r,tracingContext:a,suspend:n,resumeData:i,runId:o,workflowId:l,state:u,setState:p})=>s.execute(e,{mastra:t,requestContext:r,tracingContext:a,resumeData:i,workflow:{runId:o,suspend:n,resumeData:i,workflowId:l,state:u,setState:p}}),component:"TOOL"}}if(null!==e&&"object"==typeof e&&"id"in e&&"execute"in e&&!(e instanceof _g)&&!(e instanceof cE)){return{id:(r=e).id,description:r.description,inputSchema:r.inputSchema,stateSchema:r.stateSchema,outputSchema:r.outputSchema,resumeSchema:r.resumeSchema,suspendSchema:r.suspendSchema,scorers:r.scorers,retries:r.retries,execute:r.execute.bind(r)}}if(kN(e)){return a=e,{id:`processor:${a.id}`,description:a.name??`Processor ${a.id}`,inputSchema:kp,outputSchema:kd,execute:async({inputData:e,requestContext:t,tracingContext:r})=>{let{phase:s,messages:n,messageList:i,stepNumber:o,systemMessages:l,part:u,streamParts:p,state:d,finishReason:c,toolCalls:m,text:g,retryCount:h,model:f,tools:y,toolChoice:v,activeTools:b,providerOptions:w,modelSettings:k,structuredOutput:_,steps:I}=e;if(!(e=>{switch(e){case"input":return!!a.processInput;case"inputStep":return!!a.processInputStep;case"outputStream":return!!a.processOutputStream;case"outputResult":return!!a.processOutputResult;case"outputStep":return!!a.processOutputStep;default:return!1}})(s))return e;let S=r?.currentSpan,x="inputStep"===s||"outputStep"===s?S?.findParent("model_step")||S:S?.findParent("agent_run")||S,T="outputStream"!==s?x?.createChildSpan({type:"processor_run",name:`${(e=>{switch(e){case"input":return"input processor";case"inputStep":return"input step processor";case"outputStream":return"output stream processor";case"outputResult":return"output processor";case"outputStep":return"output step processor";default:return"processor"}})(s)}: ${a.id}`,entityType:(e=>{switch(e){case"input":return"input_processor";case"inputStep":return"input_step_processor";case"outputStream":case"outputResult":default:return"output_processor";case"outputStep":return"output_step_processor"}})(s),entityId:a.id,entityName:a.name??a.id,input:{phase:s,messageCount:n?.length},attributes:{processorExecutor:"workflow",processorIndex:a.processorIndex}}):void 0,E={abort:(e,t)=>{throw new wG(e||`Tripwire triggered by ${a.id}`,t,a.id)},retryCount:h??0,requestContext:t,tracingContext:T?{currentSpan:T}:r},A={phase:s,messageList:i??(Array.isArray(n)?new pZ().add(n,"input").addSystem(l??[]):void 0),stepNumber:o,systemMessages:l,streamParts:p,state:d,finishReason:c,toolCalls:m,text:g,retryCount:h,model:f,tools:y,toolChoice:v,activeTools:b,providerOptions:w,modelSettings:k,structuredOutput:_,steps:I};return(async e=>{try{let t=await e();return T?.end({output:t}),t}catch(e){throw e instanceof wG?T?.end({output:{tripwire:e.message}}):T?.error({error:e,endSpan:!0}),e}})(async()=>{switch(s){case"input":if(a.processInput){if(!A.messageList)throw new eN.MastraError({category:"USER",domain:"MASTRA_WORKFLOW",id:"PROCESSOR_MISSING_MESSAGE_LIST",text:`Processor ${a.id} requires messageList or messages for processInput phase`});let e=n.map(e=>e.id),t=A.messageList.makeMessageSourceChecker(),r=await a.processInput({...E,messages:n,messageList:A.messageList,systemMessages:l??[]});if(r instanceof pZ){if(r!==A.messageList)throw new eN.MastraError({category:"USER",domain:"MASTRA_WORKFLOW",id:"PROCESSOR_RETURNED_EXTERNAL_MESSAGE_LIST",text:`Processor ${a.id} returned a MessageList instance other than the one passed in. Use the messageList argument instead.`});return{...A,messages:r.get.all.db(),systemMessages:r.getAllSystemMessages()}}if(Array.isArray(r))return wD.applyMessagesToMessageList(r,A.messageList,e,t,"input"),{...A,messages:r};if(r&&"messages"in r&&"systemMessages"in r)return wD.applyMessagesToMessageList(r.messages,A.messageList,e,t,"input"),A.messageList.replaceAllSystemMessages(r.systemMessages),{...A,messages:r.messages,systemMessages:r.systemMessages}}return{...A,messages:n};case"inputStep":if(a.processInputStep){if(!A.messageList)throw new eN.MastraError({category:"USER",domain:"MASTRA_WORKFLOW",id:"PROCESSOR_MISSING_MESSAGE_LIST",text:`Processor ${a.id} requires messageList or messages for processInputStep phase`});let e=n.map(e=>e.id),t=A.messageList.makeMessageSourceChecker(),r=await a.processInputStep({...E,messages:n,messageList:A.messageList,stepNumber:o??0,systemMessages:l??[],model:f,tools:y,toolChoice:v,activeTools:b,providerOptions:w,modelSettings:k,structuredOutput:_,steps:I??[]}),s=await wD.validateAndFormatProcessInputStepResult(r,{messageList:A.messageList,processor:a,stepNumber:o??0});return s.messages&&wD.applyMessagesToMessageList(s.messages,A.messageList,e,t),s.systemMessages&&A.messageList.replaceAllSystemMessages(s.systemMessages),{...A,messages:n,...s}}return{...A,messages:n};case"outputStream":if(a.processOutputStream){let e,t=`__outputStreamSpan_${a.id}`,r=d??{},n=r[t];!n&&x&&(n=x.createChildSpan({type:"processor_run",name:`output stream processor: ${a.id}`,entityType:"output_processor",entityId:a.id,entityName:a.name??a.id,input:{phase:s,streamParts:[]},attributes:{processorExecutor:"workflow",processorIndex:a.processorIndex}}),r[t]=n),n&&(n.input={phase:s,streamParts:p??[],totalChunks:(p??[]).length});let i=n?{currentSpan:n}:E.tracingContext;try{e=await a.processOutputStream({...E,tracingContext:i,part:u,streamParts:p??[],state:r,messageList:A.messageList}),u&&"finish"===u.type&&(n?.end({output:e}),delete r[t])}catch(e){throw e instanceof wG?n?.end({output:{tripwire:e.message}}):n?.error({error:e,endSpan:!0}),delete r[t],e}return{...A,state:r,part:e}}return{...A,part:u};case"outputResult":if(a.processOutputResult){if(!A.messageList)throw new eN.MastraError({category:"USER",domain:"MASTRA_WORKFLOW",id:"PROCESSOR_MISSING_MESSAGE_LIST",text:`Processor ${a.id} requires messageList or messages for processOutputResult phase`});let e=n.map(e=>e.id),t=A.messageList.makeMessageSourceChecker(),r=await a.processOutputResult({...E,messages:n,messageList:A.messageList});if(r instanceof pZ){if(r!==A.messageList)throw new eN.MastraError({category:"USER",domain:"MASTRA_WORKFLOW",id:"PROCESSOR_RETURNED_EXTERNAL_MESSAGE_LIST",text:`Processor ${a.id} returned a MessageList instance other than the one passed in. Use the messageList argument instead.`});return{...A,messages:r.get.all.db(),systemMessages:r.getAllSystemMessages()}}if(Array.isArray(r))return wD.applyMessagesToMessageList(r,A.messageList,e,t,"response"),{...A,messages:r};if(r&&"messages"in r&&"systemMessages"in r)return wD.applyMessagesToMessageList(r.messages,A.messageList,e,t,"response"),A.messageList.replaceAllSystemMessages(r.systemMessages),{...A,messages:r.messages,systemMessages:r.systemMessages}}return{...A,messages:n};case"outputStep":if(a.processOutputStep){if(!A.messageList)throw new eN.MastraError({category:"USER",domain:"MASTRA_WORKFLOW",id:"PROCESSOR_MISSING_MESSAGE_LIST",text:`Processor ${a.id} requires messageList or messages for processOutputStep phase`});let e=n.map(e=>e.id),t=A.messageList.makeMessageSourceChecker(),r=await a.processOutputStep({...E,messages:n,messageList:A.messageList,stepNumber:o??0,finishReason:c,toolCalls:m,text:g,systemMessages:l??[],steps:I??[]});if(r instanceof pZ){if(r!==A.messageList)throw new eN.MastraError({category:"USER",domain:"MASTRA_WORKFLOW",id:"PROCESSOR_RETURNED_EXTERNAL_MESSAGE_LIST",text:`Processor ${a.id} returned a MessageList instance other than the one passed in. Use the messageList argument instead.`});return{...A,messages:r.get.all.db(),systemMessages:r.getAllSystemMessages()}}if(Array.isArray(r))return wD.applyMessagesToMessageList(r,A.messageList,e,t,"response"),{...A,messages:r};if(r&&"messages"in r&&"systemMessages"in r)return wD.applyMessagesToMessageList(r.messages,A.messageList,e,t,"response"),A.messageList.replaceAllSystemMessages(r.systemMessages),{...A,messages:r.messages,systemMessages:r.systemMessages}}return{...A,messages:n};default:return{...A,messages:n}}})},component:"PROCESSOR"}}throw Error("Invalid input: expected StepParams, Agent, ToolStep, or Processor")}function kN(e){return null!==e&&"object"==typeof e&&"id"in e&&"string"==typeof e.id&&!(e instanceof _g)&&!(e instanceof cE)&&("function"==typeof e.processInput||"function"==typeof e.processInputStep||"function"==typeof e.processOutputStream||"function"==typeof e.processOutputResult||"function"==typeof e.processOutputStep)}function kL(e){return new kD(e)}var kD=class extends wo.MastraBase{id;description;inputSchema;outputSchema;stateSchema;steps;stepDefs;engineType="default";type="default";#eN;committed=!1;stepFlow;serializedStepFlow;executionEngine;executionGraph;#r;retryConfig;#t;#eL=new Map;constructor({mastra:e,id:t,inputSchema:r,outputSchema:a,stateSchema:s,description:n,executionEngine:i,retryConfig:o,steps:l,options:u={},type:p}){super({name:t,component:eD.RegisteredLogger.WORKFLOW}),this.id=t,this.description=n,this.inputSchema=r,this.outputSchema=a,this.stateSchema=s,this.retryConfig=o??{attempts:0,delay:0},this.executionGraph=this.buildExecutionGraph(),this.stepFlow=[],this.serializedStepFlow=[],this.#t=e,this.steps={},this.stepDefs=l,this.type=p??"default",this.#r={validateInputs:u.validateInputs??!0,shouldPersistSnapshot:u.shouldPersistSnapshot??(()=>!0),tracingPolicy:u.tracingPolicy,onFinish:u.onFinish,onError:u.onError},i?this.executionEngine=i:this.executionEngine=new kC({mastra:this.#t,options:this.#r}),this.engineType="default",this.#eL=new Map}get runs(){return this.#eL}get mastra(){return this.#t}get options(){return this.#r}__registerMastra(e){this.#t=e,this.executionEngine.__registerMastra(e)}__registerPrimitives(e){e.logger&&this.__setLogger(e.logger)}setStepFlow(e){this.stepFlow=e}then(e){return this.stepFlow.push({type:"step",step:e}),this.serializedStepFlow.push({type:"step",step:{id:e.id,description:e.description,component:e.component,serializedStepFlow:e.serializedStepFlow,canSuspend:!!(e.suspendSchema||e.resumeSchema)}}),this.steps[e.id]=e,this}sleep(e){let t=`sleep_${this.#t?.generateId({idType:"step",source:"workflow",entityId:this.id,stepType:"sleep"})||(0,cz.randomUUID)()}`,r="function"==typeof e?{type:"sleep",id:t,fn:e}:{type:"sleep",id:t,duration:e},a="function"==typeof e?{type:"sleep",id:t,fn:e.toString()}:{type:"sleep",id:t,duration:e};return this.stepFlow.push(r),this.serializedStepFlow.push(a),this.steps[t]=kj({id:t,inputSchema:sg.object({}),outputSchema:sg.object({}),execute:async()=>({})}),this}sleepUntil(e){let t=`sleep_${this.#t?.generateId({idType:"step",source:"workflow",entityId:this.id,stepType:"sleep-until"})||(0,cz.randomUUID)()}`,r="function"==typeof e?{type:"sleepUntil",id:t,fn:e}:{type:"sleepUntil",id:t,date:e},a="function"==typeof e?{type:"sleepUntil",id:t,fn:e.toString()}:{type:"sleepUntil",id:t,date:e};return this.stepFlow.push(r),this.serializedStepFlow.push(a),this.steps[t]=kj({id:t,inputSchema:sg.object({}),outputSchema:sg.object({}),execute:async()=>({})}),this}waitForEvent(e,t,r){throw new eN.MastraError({id:"WORKFLOW_WAIT_FOR_EVENT_REMOVED",domain:"MASTRA_WORKFLOW",category:"USER",text:"waitForEvent has been removed. Please use suspend & resume flow instead. See https://mastra.ai/en/docs/workflows/suspend-and-resume for more details."})}map(e,t){if("function"==typeof e){let r=kj({id:t?.id||`mapping_${this.#t?.generateId({idType:"step",source:"workflow",entityId:this.id,stepType:"mapping"})||(0,cz.randomUUID)()}`,inputSchema:sg.any(),outputSchema:sg.any(),execute:e});return this.stepFlow.push({type:"step",step:r}),this.serializedStepFlow.push({type:"step",step:{id:r.id,mapConfig:e.toString()?.length>1e3?e.toString().slice(0,1e3)+"...\n}":e.toString()}}),this}let r=Object.entries(e).reduce((e,[t,r])=>(void 0!==r.value?e[t]=r:void 0!==r.fn?e[t]={fn:r.fn.toString(),schema:r.schema}:r.requestContextPath?e[t]={requestContextPath:r.requestContextPath,schema:r.schema}:e[t]=r,e),{}),a=kj({id:t?.id||`mapping_${this.#t?.generateId({idType:"step",source:"workflow",entityId:this.id,stepType:"mapping"})||(0,cz.randomUUID)()}`,inputSchema:sg.any(),outputSchema:sg.any(),execute:async t=>{let{getStepResult:r,getInitData:a,requestContext:s}=t,n={};for(let[i,o]of Object.entries(e)){if(void 0!==o.value){n[i]=o.value;continue}if(void 0!==o.fn){n[i]=await o.fn(t);continue}if(o.requestContextPath){n[i]=s.get(o.requestContextPath);continue}let e=o.initData?a():r(Array.isArray(o.step)?o.step.find(e=>{let t=r(e);return"object"==typeof t&&null!==t?Object.keys(t).length>0:t}):o.step);if("."===o.path){n[i]=e;continue}let l=o.path.split("."),u=e;for(let e of l)if("object"==typeof u&&null!==u)u=u[e];else throw Error(`Invalid path ${o.path} in step ${o?.step?.id??"initData"}`);n[i]=u}return n}});return this.stepFlow.push({type:"step",step:a}),this.serializedStepFlow.push({type:"step",step:{id:a.id,mapConfig:JSON.stringify(r,null,2)?.length>1e3?JSON.stringify(r,null,2).slice(0,1e3)+"...\n}":JSON.stringify(r,null,2)}}),this}parallel(e){return this.stepFlow.push({type:"parallel",steps:e.map(e=>({type:"step",step:e}))}),this.serializedStepFlow.push({type:"parallel",steps:e.map(e=>({type:"step",step:{id:e.id,description:e.description,component:e.component,serializedStepFlow:e.serializedStepFlow,canSuspend:!!(e.suspendSchema||e.resumeSchema)}}))}),e.forEach(e=>{this.steps[e.id]=e}),this}branch(e){return this.stepFlow.push({type:"conditional",steps:e.map(([e,t])=>({type:"step",step:t})),conditions:e.map(([e])=>e),serializedConditions:e.map(([e,t])=>({id:`${t.id}-condition`,fn:e.toString()}))}),this.serializedStepFlow.push({type:"conditional",steps:e.map(([e,t])=>({type:"step",step:{id:t.id,description:t.description,component:t.component,serializedStepFlow:t.serializedStepFlow,canSuspend:!!(t.suspendSchema||t.resumeSchema)}})),serializedConditions:e.map(([e,t])=>({id:`${t.id}-condition`,fn:e.toString()}))}),e.forEach(([e,t])=>{this.steps[t.id]=t}),this}dowhile(e,t){return this.stepFlow.push({type:"loop",step:e,condition:t,loopType:"dowhile",serializedCondition:{id:`${e.id}-condition`,fn:t.toString()}}),this.serializedStepFlow.push({type:"loop",step:{id:e.id,description:e.description,component:e.component,serializedStepFlow:e.serializedStepFlow,canSuspend:!!(e.suspendSchema||e.resumeSchema)},serializedCondition:{id:`${e.id}-condition`,fn:t.toString()},loopType:"dowhile"}),this.steps[e.id]=e,this}dountil(e,t){return this.stepFlow.push({type:"loop",step:e,condition:t,loopType:"dountil",serializedCondition:{id:`${e.id}-condition`,fn:t.toString()}}),this.serializedStepFlow.push({type:"loop",step:{id:e.id,description:e.description,component:e.component,serializedStepFlow:e.serializedStepFlow,canSuspend:!!(e.suspendSchema||e.resumeSchema)},serializedCondition:{id:`${e.id}-condition`,fn:t.toString()},loopType:"dountil"}),this.steps[e.id]=e,this}foreach(e,t){return this.stepFlow.push({type:"foreach",step:e,opts:t??{concurrency:1}}),this.serializedStepFlow.push({type:"foreach",step:{id:e.id,description:e.description,component:e.component,serializedStepFlow:e.serializedStepFlow,canSuspend:!!(e.suspendSchema||e.resumeSchema)},opts:t??{concurrency:1}}),this.steps[e.id]=e,this}buildExecutionGraph(){return{id:this.id,steps:this.stepFlow}}commit(){return this.executionGraph=this.buildExecutionGraph(),this.committed=!0,this}get stepGraph(){return this.stepFlow}get serializedStepGraph(){return this.serializedStepFlow}async createRun(e){if(0===this.stepFlow.length)throw Error("Execution flow of workflow is not defined. Add steps to the workflow via .then(), .branch(), etc.");if(!this.executionGraph.steps)throw Error("Uncommitted step flow changes detected. Call .commit() to register the steps.");let t=e?.runId||this.#t?.generateId({idType:"run",source:"workflow",entityId:this.id,resourceId:e?.resourceId})||(0,cz.randomUUID)(),r=this.#eL.get(t)??new kq({workflowId:this.id,stateSchema:this.stateSchema,inputSchema:this.inputSchema,runId:t,resourceId:e?.resourceId,executionEngine:this.executionEngine,executionGraph:this.executionGraph,mastra:this.#t,retryConfig:this.retryConfig,serializedStepGraph:this.serializedStepGraph,disableScorers:e?.disableScorers,cleanup:()=>this.#eL.delete(t),tracingPolicy:this.#r?.tracingPolicy,workflowSteps:this.steps,validateInputs:this.#r?.validateInputs,workflowEngineType:this.engineType});this.#eL.set(t,r);let a=this.#r.shouldPersistSnapshot({workflowStatus:r.workflowRunStatus,stepResults:{}}),s=await this.getWorkflowRunById(t,{withNestedWorkflows:!1}),n=s&&!s.isFromInMemory;if(n&&s.status&&(r.workflowRunStatus=s.status),!n&&a){let r=await this.mastra?.getStorage()?.getStore("workflows");await r?.persistWorkflowSnapshot({workflowName:this.id,runId:t,resourceId:e?.resourceId,snapshot:{runId:t,status:"pending",value:{},context:this.#eN?{input:this.#eN}:{},activePaths:[],activeStepsPath:{},serializedStepGraph:this.serializedStepGraph,suspendedPaths:{},resumeLabels:{},waitingPaths:{},result:void 0,error:void 0,timestamp:Date.now()}})}return r}async listScorers({requestContext:e=new c_}={}){let t=this.steps;if(!t||0===Object.keys(t).length)return{};let r={};for(let a of Object.values(t))if(a.scorers){let t=a.scorers;for(let[a,s]of("function"==typeof t&&(t=await t({requestContext:e})),Object.entries(t)))r[a]=s}return r}async execute({runId:e,inputData:t,resumeData:r,state:a,setState:s,suspend:n,restart:i,resume:o,timeTravel:l,[sd]:u,mastra:p,requestContext:d,abort:c,abortSignal:m,retryCount:g,tracingContext:h,outputWriter:f,validateInputs:y,perStep:v}){let b;this.__registerMastra(p);let w=y??this.#r.validateInputs??!0;this.#r={...this.#r||{},validateInputs:w},this.executionEngine.options={...this.executionEngine.options||{},validateInputs:w};let k=!!(o?.steps&&o.steps.length>0)||!!o?.label||!!(o?.steps&&0===o.steps.length&&(!g||0===g));i||k||(this.#eN=t);let _=!!(l&&l.steps.length>0),I=k?await this.createRun({runId:o.runId}):await this.createRun({runId:e}),S=()=>{c()};I.abortController.signal.addEventListener("abort",S),m.addEventListener("abort",async()=>{I.abortController.signal.removeEventListener("abort",S),await I.cancel()});let x=I.watch(e=>{u.publish("nested-watch",{type:"nested-watch",runId:I.runId,data:{event:e,workflowId:this.id}})});g&&g>0&&k&&d&&d.set("__mastraWorflowInputData",t),b=_?await I.timeTravel({inputData:l?.inputData,resumeData:l?.resumeData,initialState:a,step:l?.steps,context:l?.nestedStepResults?.[this.id]??{},nestedStepsContext:l?.nestedStepResults,requestContext:d,tracingContext:h,outputWriter:f,outputOptions:{includeState:!0,includeResumeLabels:!0},perStep:v}):i?await I.restart({requestContext:d,tracingContext:h,outputWriter:f}):k?await I.resume({resumeData:r,step:o.steps?.length>0?o.steps:void 0,requestContext:d,tracingContext:h,outputWriter:f,outputOptions:{includeState:!0,includeResumeLabels:!0},label:o.label,perStep:v}):await I.start({inputData:t,requestContext:d,tracingContext:h,outputWriter:f,initialState:a,outputOptions:{includeState:!0,includeResumeLabels:!0},perStep:v}),x();let T=Object.entries(b.steps).filter(([e,t])=>t?.status==="suspended");if(b.state&&await s(b.state),T?.length)for(let[e,t]of T){let r=[e,...t?.suspendPayload?.__workflow_meta?.path??[]];await n({...t?.suspendPayload,__workflow_meta:{runId:I.runId,path:r}},{resumeLabel:Object.keys(b.resumeLabels??{})})}if("failed"===b.status)throw b.error;return"success"===b.status?b.result:void 0}async listWorkflowRuns(e){let t=this.#t?.getStorage();if(!t)return this.logger.debug("Cannot get workflow runs. Mastra storage is not initialized"),{runs:[],total:0};let r=await t.getStore("workflows");return r?r.listWorkflowRuns({workflowName:this.id,...e??{}}):(this.logger.debug("Cannot get workflow runs. Workflows storage domain is not available"),{runs:[],total:0})}async listActiveWorkflowRuns(){let e=await this.listWorkflowRuns({status:"running"}),t=await this.listWorkflowRuns({status:"waiting"});return{runs:[...e.runs,...t.runs],total:e.total+t.total}}async restartAllActiveWorkflowRuns(){if("default"!==this.engineType)return void this.logger.debug(`Cannot restart active workflow runs for ${this.engineType} engine`);let e=await this.listActiveWorkflowRuns();for(let t of(e.runs.length>0&&this.logger.debug(`Restarting ${e.runs.length} active workflow run${e.runs.length>1?"s":""}`),e.runs))try{let e=await this.createRun({runId:t.runId});await e.restart(),this.logger.debug(`Restarted ${this.id} workflow run ${t.runId}`)}catch(e){this.logger.error(`Failed to restart ${this.id} workflow run ${t.runId}: ${e}`)}}async deleteWorkflowRunById(e){let t=this.#t?.getStorage();if(!t)return void this.logger.debug("Cannot delete workflow run by ID. Mastra storage is not initialized");let r=await t.getStore("workflows");r?(await r.deleteWorkflowRunById({runId:e,workflowName:this.id}),this.#eL.delete(e)):this.logger.debug("Cannot delete workflow run. Workflows storage domain is not available")}async getWorkflowRunSteps({runId:e,workflowId:t}){let r=this.#t?.getStorage();if(!r)return this.logger.debug("Cannot get workflow run steps. Mastra storage is not initialized"),{};let a=await r.getStore("workflows");if(!a)return this.logger.debug("Cannot get workflow run steps. Workflows storage domain is not available"),{};let s=await a.getWorkflowRunById({runId:e,workflowName:t}),n=s?.snapshot;if(!n)return{};if("string"==typeof n)try{n=JSON.parse(n)}catch(e){return this.logger.debug("Cannot get workflow run execution result. Snapshot is not a valid JSON string",e),{}}let{serializedStepGraph:i,context:o}=n,{input:l,...u}=o,p={};for(let t of Object.keys(u)){let r=i.find(e=>e?.step?.id===t);if(p[t]=u[t],r&&r?.step?.component==="WORKFLOW"){let r=await this.getWorkflowRunSteps({runId:e,workflowId:t});if(r){let e=Object.entries(r).reduce((e,[r,a])=>(e[`${t}.${r}`]=a,e),{});p={...p,...e}}}}return p}#eD(e){let t=this.#eL.get(e);return t?{runId:e,workflowName:this.id,resourceId:t.resourceId,createdAt:new Date,updatedAt:new Date,isFromInMemory:!0,status:t.workflowRunStatus,steps:{}}:null}async getWorkflowRunById(e,t={}){let{withNestedWorkflows:r=!0,fields:a}=t,s=this.#t?.getStorage();if(!s)return this.logger.debug("Cannot get workflow run. Mastra storage is not initialized"),this.#eD(e);let n=await s.getStore("workflows");if(!n)return this.logger.debug("Cannot get workflow run. Workflows storage domain is not available"),this.#eD(e);let i=await n.getWorkflowRunById({runId:e,workflowName:this.id});if(!i)return this.#eD(e);let o=i.snapshot;if("string"==typeof o)try{o=JSON.parse(o)}catch(e){return this.logger.debug("Cannot parse workflow run snapshot. Snapshot is not valid JSON",e),null}let l=o,u=!a||0===a.length,p=new Set(a??[]),d={};if(u||p.has("steps"))if(r)d=await this.getWorkflowRunSteps({runId:e,workflowId:this.id});else{let{input:e,...t}=l.context||{};d=t}let c={runId:i.runId,workflowName:i.workflowName,resourceId:i.resourceId,createdAt:i.createdAt,updatedAt:i.updatedAt,status:l.status,initialState:Object.keys(l.value).length>0?l.value:void 0,result:u||p.has("result")?l.result:void 0,error:u||p.has("error")?l.error:void 0,payload:u||p.has("payload")?l.context?.input:void 0,steps:d,activeStepsPath:u||p.has("activeStepsPath")?l.activeStepsPath:void 0,serializedStepGraph:u||p.has("serializedStepGraph")?l.serializedStepGraph:void 0};return a&&a.length>0&&(void 0===c.initialState&&delete c.initialState,void 0===c.result&&delete c.result,void 0===c.error&&delete c.error,void 0===c.payload&&delete c.payload,p.has("steps")||delete c.steps,void 0===c.activeStepsPath&&delete c.activeStepsPath,void 0===c.serializedStepGraph&&delete c.serializedStepGraph),c}},kq=class{#eq;pubsub;workflowId;runId;resourceId;disableScorers;tracingPolicy;validateInputs;state={};executionEngine;executionGraph;serializedStepGraph;workflowSteps;workflowRunStatus;workflowEngineType;#t;#e$=[];get mastra(){return this.#t}streamOutput;closeStreamAction;executionResults;stateSchema;inputSchema;cleanup;retryConfig;constructor(e){this.workflowId=e.workflowId,this.runId=e.runId,this.resourceId=e.resourceId,this.serializedStepGraph=e.serializedStepGraph,this.executionEngine=e.executionEngine,this.executionGraph=e.executionGraph,this.#t=e.mastra,this.pubsub=new wJ,this.retryConfig=e.retryConfig,this.cleanup=e.cleanup,this.disableScorers=e.disableScorers,this.tracingPolicy=e.tracingPolicy,this.workflowSteps=e.workflowSteps,this.validateInputs=e.validateInputs,this.stateSchema=e.stateSchema,this.inputSchema=e.inputSchema,this.workflowRunStatus="pending",this.workflowEngineType=e.workflowEngineType}get abortController(){return this.#eq||(this.#eq=new AbortController),this.#eq}async cancel(){this.abortController.abort(),this.workflowRunStatus="canceled";try{let e=await this.mastra?.getStorage()?.getStore("workflows");await e?.updateWorkflowState({workflowName:this.workflowId,runId:this.runId,opts:{status:"canceled"}})}catch{}}async _validateInput(e){let t=e;if(this.validateInputs&&this.inputSchema&&v0(this.inputSchema)){let r=await this.inputSchema.safeParseAsync(e);if(!r.success)throw Error("Invalid input data: \n"+kg(r.error).map(e=>`- ${e.path?.join(".")}: ${e.message}`).join("\n"));t=r.data}return t}async _validateInitialState(e){let t=e;if(this.validateInputs){let r=this.stateSchema;if(r&&v0(r)){let a=await r.safeParseAsync(e);if(!a.success)throw Error("Invalid initial state: \n"+kg(a.error).map(e=>`- ${e.path?.join(".")}: ${e.message}`).join("\n"));t=a.data}}return t}async _validateResumeData(e,t){let r=e;if(t&&t.resumeSchema&&this.validateInputs&&v0(t.resumeSchema)){let a=t.resumeSchema,s=await a.safeParseAsync(e);if(!s.success)throw Error("Invalid resume data: \n"+kg(s.error).map(e=>`- ${e.path?.join(".")}: ${e.message}`).join("\n"));r=s.data}return r}async _validateTimetravelInputData(e,t){let r=e;if(t&&t.inputSchema&&this.validateInputs&&v0(t.inputSchema)){let a=t.inputSchema,s=await a.safeParseAsync(e);if(!s.success)throw Error("Invalid inputData: \n"+kg(s.error).map(e=>`- ${e.path?.join(".")}: ${e.message}`).join("\n"));r=s.data}return r}async _start({inputData:e,initialState:t,requestContext:r,outputWriter:a,tracingContext:s,tracingOptions:n,format:i,outputOptions:o,perStep:l}){let u=pQ({type:"workflow_run",name:`workflow run: '${this.workflowId}'`,entityType:"workflow_run",entityId:this.workflowId,input:e,metadata:{resourceId:this.resourceId,runId:this.runId},tracingPolicy:this.tracingPolicy,tracingOptions:n,tracingContext:s,requestContext:r,mastra:this.#t}),p=u?.externalTraceId,d=await this._validateInput(e),c=await this._validateInitialState(t??{}),m=await this.executionEngine.execute({workflowId:this.workflowId,runId:this.runId,resourceId:this.resourceId,disableScorers:this.disableScorers,graph:this.executionGraph,serializedStepGraph:this.serializedStepGraph,input:d,initialState:c,pubsub:this.pubsub,retryConfig:this.retryConfig,requestContext:r??new c_,abortController:this.abortController,outputWriter:a,workflowSpan:u,format:i,outputOptions:o,perStep:l});return"suspended"!==m.status&&this.cleanup?.(),m.traceId=p,m}async start(e){return this._start(e)}async startAsync(e){return this._start(e).catch(e=>{this.mastra?.getLogger()?.error(`[Workflow ${this.workflowId}] Background execution failed:`,e)}),{runId:this.runId}}streamLegacy({inputData:e,requestContext:t,onChunk:r,tracingContext:a,tracingOptions:s}={}){if(this.closeStreamAction)return{stream:this.observeStreamLegacy().stream,getWorkflowState:()=>this.executionResults};let{readable:n,writable:i}=new wl.TransformStream,o=i.getWriter(),l=this.watch(async e=>{try{let t={...e,type:e.type.replace("workflow-","")};await o.write(t),r&&await r(t)}catch{}});return this.closeStreamAction=async()=>{await this.pubsub.publish(`workflow.events.v2.${this.runId}`,{type:"watch",runId:this.runId,data:{type:"workflow-finish",payload:{runId:this.runId}}}),l(),await Promise.all(this.#e$.map(e=>e())),this.#e$=[];try{await o.close()}catch(e){this.mastra?.getLogger()?.error("Error closing stream:",e)}finally{o.releaseLock()}},this.pubsub.publish(`workflow.events.v2.${this.runId}`,{type:"watch",runId:this.runId,data:{type:"workflow-start",payload:{runId:this.runId}}}),this.executionResults=this._start({inputData:e,requestContext:t,format:"legacy",tracingContext:a,tracingOptions:s}).then(e=>("suspended"!==e.status&&this.closeStreamAction?.().catch(()=>{}),e)),{stream:n,getWorkflowState:()=>this.executionResults}}observeStreamLegacy(){let{readable:e,writable:t}=new wl.TransformStream,r=t.getWriter(),a=this.watch(async e=>{try{let t={...e,type:e.type.replace("workflow-","")};await r.write(t)}catch{}});return this.#e$.push(async()=>{a();try{await r.close()}catch(e){this.mastra?.getLogger()?.error("Error closing stream:",e)}finally{r.releaseLock()}}),{stream:e}}observeStream(){return this.streamOutput?this.streamOutput.fullStream:new wl.ReadableStream({pull(e){e.close()},cancel(e){e.close()}})}stream({inputData:e,requestContext:t,tracingContext:r,tracingOptions:a,closeOnSuspend:s=!0,initialState:n,outputOptions:i,perStep:o}){if(this.closeStreamAction&&this.streamOutput)return this.streamOutput;this.closeStreamAction=async()=>{};let l=this,u=new wl.ReadableStream({async start(u){let p,d=l.watch(async e=>{let{type:t,from:r="WORKFLOW",payload:a,data:s,...n}=e;void 0!==s&&void 0===a?u.enqueue({type:t,runId:l.runId,from:r,data:s,...n}):u.enqueue({type:t,runId:l.runId,from:r,payload:{stepName:a?.id,...a}})});l.closeStreamAction=async()=>{d();try{null!==u.desiredSize&&u.close()}catch(e){l.mastra?.getLogger()?.error("Error closing stream:",e)}};let c=l._start({inputData:e,requestContext:t,tracingContext:r,tracingOptions:a,initialState:n,outputOptions:i,outputWriter:async e=>{l.pubsub.publish(`workflow.events.v2.${l.runId}`,{type:"watch",runId:l.runId,data:e})},perStep:o});try{p=await c,s?l.closeStreamAction?.().catch(()=>{}):"suspended"!==p.status&&l.closeStreamAction?.().catch(()=>{}),l.streamOutput&&l.streamOutput.updateResults(p)}catch(e){l.streamOutput?.rejectResults(e),l.closeStreamAction?.().catch(()=>{})}}});return this.streamOutput=new wK({runId:this.runId,workflowId:this.workflowId,stream:u}),this.streamOutput}resumeStream({step:e,resumeData:t,requestContext:r,tracingContext:a,tracingOptions:s,forEachIndex:n,outputOptions:i,perStep:o}={}){this.closeStreamAction=async()=>{};let l=this,u=new wl.ReadableStream({async start(u){let p,d=l.watch(async e=>{let{type:t,from:r="WORKFLOW",payload:a,data:s,...n}=e;void 0!==s&&void 0===a?u.enqueue({type:t,runId:l.runId,from:r,data:s,...n}):u.enqueue({type:t,runId:l.runId,from:r,payload:{stepName:a?.id,...a}})});l.closeStreamAction=async()=>{d();try{null!==u.desiredSize&&u.close()}catch(e){l.mastra?.getLogger()?.error("Error closing stream:",e)}};let c=l._resume({resumeData:t,step:e,requestContext:r,tracingContext:a,tracingOptions:s,outputWriter:async e=>{u.enqueue(e)},isVNext:!0,forEachIndex:n,outputOptions:i,perStep:o});l.executionResults=c;try{p=await c,l.closeStreamAction?.().catch(()=>{}),l.streamOutput&&l.streamOutput.updateResults(p)}catch(e){l.streamOutput?.rejectResults(e),l.closeStreamAction?.().catch(()=>{})}}});return this.streamOutput=new wK({runId:this.runId,workflowId:this.workflowId,stream:u}),this.streamOutput}watch(e){let t=t=>{t.runId===this.runId&&e(t.data)},r=e=>{if(e.runId===this.runId){let{event:t,workflowId:r}=e.data;t.type.startsWith("data-")&&void 0!==t.data?this.pubsub.publish(`workflow.events.v2.${this.runId}`,{type:"watch",runId:this.runId,data:t}):this.pubsub.publish(`workflow.events.v2.${this.runId}`,{type:"watch",runId:this.runId,data:{...t,...t.payload?.id?{payload:{...t.payload,id:`${r}.${t.payload.id}`}}:{}}})}};return this.pubsub.subscribe(`workflow.events.v2.${this.runId}`,t),this.pubsub.subscribe("nested-watch",r),()=>{this.pubsub.unsubscribe(`workflow.events.v2.${this.runId}`,t),this.pubsub.unsubscribe("nested-watch",r)}}async watchAsync(e){return this.watch(e)}async resume(e){return this._resume(e)}async restart(e={}){return this._restart(e)}async _resume(e){let t,r,a=await this.#t?.getStorage()?.getStore("workflows"),s=await a?.loadWorkflowSnapshot({workflowName:this.workflowId,runId:this.runId});if(!s)throw Error("No snapshot found for this workflow run: "+this.workflowId+" "+this.runId);if("suspended"!==s.status)throw Error("This workflow run was not suspended");let n=e.label?s?.resumeLabels?.[e.label]:void 0,i=n?.stepId??e.step;if(i){let e=i;"string"==typeof i&&(e=i.split(".")),t=(Array.isArray(e)?e:[e]).map(e=>"string"==typeof e?e:e?.id)}else{let e=[];if(Object.entries(s?.suspendedPaths??{}).forEach(([t,r])=>{let a=s?.context?.[t];if(a&&"object"==typeof a&&"status"in a&&"suspended"===a.status){let r=a.suspendPayload?.__workflow_meta?.path;r&&Array.isArray(r)?e.push([t,...r]):e.push([t])}}),0===e.length)throw Error("No suspended steps found in this workflow run");if(1===e.length)t=e[0];else{let t=e.map(e=>`[${e.join(", ")}]`);throw Error(`Multiple suspended steps found: ${t.join(", ")}. Please specify which step to resume using the "step" parameter.`)}}if(!e.retryCount){let e=Object.keys(s?.suspendedPaths??{});if(!e.includes(t?.[0]??""))throw Error(`This workflow step "${t?.[0]}" was not suspended. Available suspended steps: [${e.join(", ")}]`)}let o=this.workflowSteps[t?.[0]??""],l=await this._validateResumeData(e.resumeData,o);e.retryCount&&e.retryCount>0&&e.requestContext&&(r=e.requestContext.get("__mastraWorflowInputData"),e.requestContext.delete("__mastraWorflowInputData"));let u={...s?.context??{},input:r??s?.context?.input},p=e.requestContext??new c_;Object.entries(s?.requestContext??{}).forEach(([e,t])=>{p.has(e)||p.set(e,t)});let d=pQ({type:"workflow_run",name:`workflow run: '${this.workflowId}'`,entityType:"workflow_run",entityId:this.workflowId,input:l,metadata:{resourceId:this.resourceId,runId:this.runId},tracingPolicy:this.tracingPolicy,tracingOptions:e.tracingOptions,tracingContext:e.tracingContext,requestContext:p,mastra:this.#t}),c=d?.externalTraceId,m=this.executionEngine.execute({workflowId:this.workflowId,runId:this.runId,resourceId:this.resourceId,graph:this.executionGraph,serializedStepGraph:this.serializedStepGraph,input:s?.context?.input,initialState:s?.value??{},resume:{steps:t,stepResults:u,resumePayload:l,resumePath:s?.suspendedPaths?.[t?.[0]],forEachIndex:e.forEachIndex??n?.foreachIndex,label:e.label},format:e.format,pubsub:this.pubsub,requestContext:p,abortController:this.abortController,workflowSpan:d,outputOptions:e.outputOptions,outputWriter:e.outputWriter,perStep:e.perStep}).then(t=>(e.isVNext||"suspended"===t.status||this.closeStreamAction?.().catch(()=>{}),t.traceId=c,t));return this.executionResults=m,m.then(e=>(this.streamOutput?.updateResults(e),e))}async _restart({requestContext:e,outputWriter:t,tracingContext:r,tracingOptions:a}){if("default"!==this.workflowEngineType)throw Error(`restart() is not supported on ${this.workflowEngineType} workflows`);let s=await this.#t?.getStorage()?.getStore("workflows"),n=await s?.loadWorkflowSnapshot({workflowName:this.workflowId,runId:this.runId}),i=!1;if(!n)throw Error(`Snapshot not found for run ${this.runId}`);if("running"!==n.status&&"waiting"!==n.status)if("pending"===n.status&&n.context.input)i=!0;else throw Error("This workflow run was not active");let o={},l=this.executionGraph.steps[0];"step"===l.type||"foreach"===l.type||"loop"===l.type?o={[l.step.id]:[0]}:"sleep"===l.type||"sleepUntil"===l.type?o={[l.id]:[0]}:("conditional"===l.type||"parallel"===l.type)&&(o=l.steps.reduce((e,t)=>(e[t.step.id]=[0],e),{}));let u={activePaths:i?[0]:n.activePaths,activeStepsPath:i?o:n.activeStepsPath,stepResults:n.context,state:n.value},p=e??new c_;for(let[e,t]of Object.entries(n.requestContext??{}))p.has(e)||p.set(e,t);let d=pQ({type:"workflow_run",name:`workflow run: '${this.workflowId}'`,entityType:"workflow_run",entityId:this.workflowId,metadata:{resourceId:this.resourceId,runId:this.runId},tracingPolicy:this.tracingPolicy,tracingOptions:a,tracingContext:r,requestContext:p,mastra:this.#t}),c=d?.externalTraceId,m=await this.executionEngine.execute({workflowId:this.workflowId,runId:this.runId,resourceId:this.resourceId,disableScorers:this.disableScorers,graph:this.executionGraph,serializedStepGraph:this.serializedStepGraph,restart:u,pubsub:this.pubsub,retryConfig:this.retryConfig,requestContext:p,abortController:this.abortController,outputWriter:t,workflowSpan:d});return"suspended"!==m.status&&this.cleanup?.(),m.traceId=c,m}async _timeTravel({inputData:e,resumeData:t,initialState:r,step:a,context:s,nestedStepsContext:n,requestContext:i,outputWriter:o,tracingContext:l,tracingOptions:u,outputOptions:p,perStep:d}){let c;if(!a||Array.isArray(a)&&0===a.length)throw Error("Step is required and must be a valid step or array of steps");let m=await this.#t?.getStorage()?.getStore("workflows"),g=await m?.loadWorkflowSnapshot({workflowName:this.workflowId,runId:this.runId});if(!g)throw Error(`Snapshot not found for run ${this.runId}`);if("running"===g.status)throw Error("This workflow run is still running, cannot time travel");let h=a;"string"==typeof a&&(h=a.split(".")),c=(Array.isArray(h)?h:[h]).map(e=>"string"==typeof e?e:e?.id);let f=e;f&&1===c.length&&(f=await this._validateTimetravelInputData(e,this.workflowSteps[c[0]]));let y=(e=>{let{steps:t,inputData:r,resumeData:a,context:s,nestedStepsContext:n,snapshot:i,initialState:o,graph:l,perStep:u}=e,p=t[0],d=[],c={},m=i.context;for(let[e,n]of l.steps.entries()){let i,o,g=d.length;if(g>0&&!a)break;let h=k_(n);h.includes(p)&&(d=[e,...h?.length>1?[h?.findIndex(e=>e===p)]:[]]);let f=l.steps[e-1];if(f){let e=k_(f);e.length>0&&(i=1===e.length?c?.[e[0]]?.output??{}:e.reduce((e,t)=>(e[t]=c?.[t]?.output??{},e),{}))}0===e&&h.includes(p)?c.input=s?.[p]?.payload??r??m?.input:0===e&&(c.input=h?.reduce((e,t)=>e||(s?.[t]?.payload??m?.[t]?.payload),null)??m?.input??{});let y=l.steps[e+1];if(y){let e=k_(y);e.length>0&&r&&e.includes(p)&&1===t.length&&(o=r)}h.forEach(e=>{let r,a=s?.[e]??m[e],n=t?.includes(e)?"running":"success",l=["failed","canceled"].includes(a?.status)?n:a?.status??n,p=["success","failed","canceled"].includes(l);if(r={status:l,payload:s?.[e]?.payload??i??m[e]?.payload??{},output:p?s?.[e]?.output??o??m[e]?.output??{}:void 0,resumePayload:a?.resumePayload,suspendPayload:a?.suspendPayload,suspendOutput:a?.suspendOutput,startedAt:a?.startedAt??Date.now(),endedAt:p?a?.endedAt??Date.now():void 0,suspendedAt:a?.suspendedAt,resumedAt:a?.resumedAt},!((u?d.length:g)>0)||t?.includes(e)||s?.[e]||m[e]&&(!m[e]||"suspended"===m[e].status)||(r=void 0),r){let t=v3(r);c[e]=t}})}if(!d.length)throw Error(`Time travel target step not found in execution graph: '${t?.join(".")}'. Verify the step id/path.`);return{inputData:r,executionPath:d,steps:t,stepResults:c,nestedStepResults:n,state:o??i.value??{},resumeData:a}})({steps:c,inputData:f,resumeData:t,context:s,nestedStepsContext:n,snapshot:g,initialState:r,graph:this.executionGraph,perStep:d}),v=i??new c_;for(let[e,t]of Object.entries(g.requestContext??{}))v.has(e)||v.set(e,t);let b=pQ({type:"workflow_run",name:`workflow run: '${this.workflowId}'`,input:e,entityType:"workflow_run",entityId:this.workflowId,metadata:{resourceId:this.resourceId,runId:this.runId},tracingPolicy:this.tracingPolicy,tracingOptions:u,tracingContext:l,requestContext:v,mastra:this.#t}),w=b?.externalTraceId,k=await this.executionEngine.execute({workflowId:this.workflowId,runId:this.runId,resourceId:this.resourceId,disableScorers:this.disableScorers,graph:this.executionGraph,timeTravel:y,serializedStepGraph:this.serializedStepGraph,pubsub:this.pubsub,retryConfig:this.retryConfig,requestContext:v,abortController:this.abortController,outputWriter:o,workflowSpan:b,outputOptions:p,perStep:d});return"suspended"!==k.status&&this.cleanup?.(),k.traceId=w,k}async timeTravel(e){return this._timeTravel(e)}timeTravelStream({inputData:e,resumeData:t,initialState:r,step:a,context:s,nestedStepsContext:n,requestContext:i,tracingContext:o,tracingOptions:l,outputOptions:u,perStep:p}){this.closeStreamAction=async()=>{};let d=this,c=new wl.ReadableStream({async start(c){let m,g=d.watch(async({type:e,from:t="WORKFLOW",payload:r})=>{c.enqueue({type:e,runId:d.runId,from:t,payload:{stepName:r.id,...r}})});d.closeStreamAction=async()=>{g();try{null!==c.desiredSize&&c.close()}catch(e){d.mastra?.getLogger()?.error("Error closing stream:",e)}};let h=d._timeTravel({inputData:e,step:a,context:s,nestedStepsContext:n,resumeData:t,initialState:r,requestContext:i,tracingContext:o,tracingOptions:l,outputWriter:async e=>{c.enqueue(e)},outputOptions:u,perStep:p});d.executionResults=h;try{m=await h,d.closeStreamAction?.().catch(()=>{}),d.streamOutput&&d.streamOutput.updateResults(m)}catch(e){d.streamOutput?.rejectResults(e),d.closeStreamAction?.().catch(()=>{})}}});return this.streamOutput=new wK({runId:this.runId,workflowId:this.workflowId,stream:c}),this.streamOutput}_getExecutionResults(){return this.executionResults??this.streamOutput?.result}},k$=eF.object({inputTokens:eF.number().optional(),outputTokens:eF.number().optional(),totalTokens:eF.number().optional(),reasoningTokens:eF.number().optional(),cachedInputTokens:eF.number().optional()}),kF=eF.object({reason:eF.string(),warnings:eF.array(eF.any()),isContinued:eF.boolean(),logprobs:eF.any().optional(),totalUsage:k$.optional(),headers:eF.record(eF.string()).optional(),messageId:eF.string().optional(),request:eF.record(eF.any()).optional()}),kU=eF.object({messageId:eF.string(),messages:eF.object({all:eF.array(eF.any()),user:eF.array(eF.any()),nonUser:eF.array(eF.any())}),output:eF.object({text:eF.string().optional(),reasoning:eF.array(eF.any()).optional(),reasoningText:eF.string().optional(),files:eF.array(eF.any()).optional(),toolCalls:eF.array(eF.any()).optional(),toolResults:eF.array(eF.any()).optional(),sources:eF.array(eF.any()).optional(),staticToolCalls:eF.array(eF.any()).optional(),dynamicToolCalls:eF.array(eF.any()).optional(),staticToolResults:eF.array(eF.any()).optional(),dynamicToolResults:eF.array(eF.any()).optional(),usage:k$,steps:eF.array(eF.any())}),metadata:eF.object({id:eF.string().optional(),model:eF.string().optional(),modelId:eF.string().optional(),modelMetadata:eF.object({modelId:eF.string(),modelVersion:eF.string(),modelProvider:eF.string()}).optional(),timestamp:eF.date().optional(),providerMetadata:eF.record(eF.any()).optional(),headers:eF.record(eF.string()).optional(),request:eF.record(eF.any()).optional()}),stepResult:kF,processorRetryCount:eF.number().optional(),processorRetryFeedback:eF.string().optional()}),kZ=eF.object({toolCallId:eF.string(),toolName:eF.string(),args:eF.record(eF.any()),providerMetadata:eF.record(eF.any()).optional(),providerExecuted:eF.boolean().optional(),output:eF.any().optional()}),kB=kZ.extend({result:eF.any(),error:eF.any().optional()}),kV=class{id="prepare-step";name="Prepare Step Processor";prepareStep;constructor(e){this.prepareStep=e.prepareStep}async processInputStep(e){return this.prepareStep(e)}},kK=class extends wo.MastraBase{initialize({runId:e,createStream:t,onResult:r}){let a=this;return new ReadableStream({async start(s){try{let n=await t();r({warnings:n.warnings,request:n.request,rawResponse:n.rawResponse||n.response||{}}),await a.transform({runId:e,stream:n.stream,controller:s}),s.close()}catch(e){s.error(e)}}})}},kG=class extends kK{#eF;constructor({component:e,name:t,generateId:r}){super({component:e,name:t}),this.#eF=r??tc}async transform({runId:e,stream:t,controller:r}){let a=new Map;for await(let n of t){"stream-start"===n.type&&a.clear();let t=function(e,t){switch(e.type){case"response-metadata":return{type:"response-metadata",runId:t.runId,from:"AGENT",payload:{...e}};case"text-start":return{type:"text-start",runId:t.runId,from:"AGENT",payload:{id:e.id,providerMetadata:e.providerMetadata}};case"text-delta":if(e.delta)return{type:"text-delta",runId:t.runId,from:"AGENT",payload:{id:e.id,providerMetadata:e.providerMetadata,text:e.delta}};break;case"text-end":return{type:"text-end",runId:t.runId,from:"AGENT",payload:e};case"reasoning-start":return{type:"reasoning-start",runId:t.runId,from:"AGENT",payload:{id:e.id,providerMetadata:e.providerMetadata}};case"reasoning-delta":return{type:"reasoning-delta",runId:t.runId,from:"AGENT",payload:{id:e.id,providerMetadata:e.providerMetadata,text:e.delta}};case"reasoning-end":return{type:"reasoning-end",runId:t.runId,from:"AGENT",payload:{id:e.id,providerMetadata:e.providerMetadata}};case"source":return{type:"source",runId:t.runId,from:"AGENT",payload:{id:e.id,sourceType:e.sourceType,title:e.title||"",mimeType:"document"===e.sourceType?e.mediaType:void 0,filename:"document"===e.sourceType?e.filename:void 0,url:"url"===e.sourceType?e.url:void 0,providerMetadata:e.providerMetadata}};case"file":return{type:"file",runId:t.runId,from:"AGENT",payload:{data:e.data,base64:"string"==typeof e.data?e.data:void 0,mimeType:e.mediaType}};case"tool-call":{let r;if(e.input)try{r=JSON.parse(e.input)}catch(t){console.error("Error converting tool call input to JSON",{error:t,input:e.input}),r=void 0}return{type:"tool-call",runId:t.runId,from:"AGENT",payload:{toolCallId:e.toolCallId,toolName:e.toolName,args:r,providerExecuted:e.providerExecuted,providerMetadata:e.providerMetadata}}}case"tool-result":return{type:"tool-result",runId:t.runId,from:"AGENT",payload:{toolCallId:e.toolCallId,toolName:e.toolName,result:e.result,isError:e.isError,providerExecuted:e.providerExecuted,providerMetadata:e.providerMetadata}};case"tool-input-start":return{type:"tool-call-input-streaming-start",runId:t.runId,from:"AGENT",payload:{toolCallId:e.id,toolName:e.toolName,providerExecuted:e.providerExecuted,providerMetadata:e.providerMetadata}};case"tool-input-delta":if(e.delta)return{type:"tool-call-delta",runId:t.runId,from:"AGENT",payload:{argsTextDelta:e.delta,toolCallId:e.id,providerMetadata:e.providerMetadata}};break;case"tool-input-end":return{type:"tool-call-input-streaming-end",runId:t.runId,from:"AGENT",payload:{toolCallId:e.id,providerMetadata:e.providerMetadata}};case"finish":let{finishReason:r,usage:a,providerMetadata:s,messages:n,...i}=e;return{type:"finish",runId:t.runId,from:"AGENT",payload:{stepResult:{reason:function(e){return e?"tripwire"===e||"retry"===e?e:"object"==typeof e&&null!==e&&"unified"in e?e.unified:"unknown"===e?"other":e:"other"}(e.finishReason)},output:{usage:function(e){if(!e)return{inputTokens:void 0,outputTokens:void 0,totalTokens:void 0,reasoningTokens:void 0,cachedInputTokens:void 0,raw:void 0};if(e&&"object"==typeof e&&"object"==typeof e.inputTokens&&null!==e.inputTokens&&"total"in e.inputTokens&&"object"==typeof e.outputTokens&&null!==e.outputTokens&&"total"in e.outputTokens){let t=e.inputTokens.total,r=e.outputTokens.total;return{inputTokens:t,outputTokens:r,totalTokens:(t??0)+(r??0),reasoningTokens:e.outputTokens.reasoning,cachedInputTokens:e.inputTokens.cacheRead,raw:e}}return{inputTokens:e.inputTokens,outputTokens:e.outputTokens,totalTokens:e.totalTokens??(e.inputTokens??0)+(e.outputTokens??0),reasoningTokens:e.reasoningTokens,cachedInputTokens:e.cachedInputTokens,raw:e}}(e.usage)},metadata:{providerMetadata:e.providerMetadata},messages:n,...i}};case"error":return{type:"error",runId:t.runId,from:"AGENT",payload:e};case"raw":return{type:"raw",runId:t.runId,from:"AGENT",payload:e.rawValue}}}(n,{runId:e});if(t){var s;if(("text-start"===t.type||"text-delta"===t.type||"text-end"===t.type)&&t.payload?.id&&(s=t.payload.id,/^\d+$/.test(s))){let e=t.payload.id;a.has(e)||a.set(e,this.#eF()),t.payload.id=a.get(e)}r.enqueue(t)}}}},kW=class{content;finishReason;usage;warnings;request;response;providerMetadata;tripwire;constructor({content:e,finishReason:t,usage:r,warnings:a,request:s,response:n,providerMetadata:i,tripwire:o}){this.content=e,this.finishReason=t,this.usage=r,this.warnings=a,this.request=s,this.response=n,this.providerMetadata=i,this.tripwire=o}get text(){return this.tripwire?"":this.content.filter(e=>"text"===e.type).map(e=>e.text).join("")}get reasoning(){return this.content.filter(e=>"reasoning"===e.type)}get reasoningText(){return 0===this.reasoning.length?void 0:this.reasoning.map(e=>e.text).join("")}get files(){return this.content.filter(e=>"file"===e.type).map(e=>e.file)}get sources(){return this.content.filter(e=>"source"===e.type)}get toolCalls(){return this.content.filter(e=>"tool-call"===e.type)}get staticToolCalls(){return this.toolCalls.filter(e=>!1===e.dynamic)}get dynamicToolCalls(){return this.toolCalls.filter(e=>!0===e.dynamic)}get toolResults(){return this.content.filter(e=>"tool-result"===e.type)}get staticToolResults(){return this.toolResults.filter(e=>!1===e.dynamic)}get dynamicToolResults(){return this.toolResults.filter(e=>!0===e.dynamic)}},kQ=class{#eU;constructor({_internal:e,model:t}){this.#eU={responseMetadata:{id:e?.generateId?.(),timestamp:e?.currentDate?.(),modelId:t.modelId,modelVersion:t.specificationVersion,modelProvider:t.provider,headers:void 0},modelMetadata:{modelId:t.modelId,modelVersion:t.specificationVersion,modelProvider:t.provider},isReasoning:!1,isStreaming:!1,providerOptions:void 0,hasToolCallStreaming:!1,hasErrored:!1,reasoningDeltas:[],textDeltas:[],stepResult:void 0}}setState(e){this.#eU={...this.#eU,...e}}get state(){return this.#eU}};async function kJ({tools:e,messageId:t,messageList:r,outputStream:a,runState:s,options:n,controller:i,responseFromModel:o,includeRawChunks:l,logger:u}){for await(let p of a._getBaseStream())if(p){if("object"==p.type||"object-result"==p.type){i.enqueue(p);continue}if("text-delta"!==p.type&&"tool-call"!==p.type&&"response-metadata"!==p.type&&s.state.isStreaming){if(s.state.textDeltas.length){let e=p.payload.providerMetadata??s.state.providerOptions,a={id:t,role:"assistant",content:{format:2,parts:[{type:"text",text:s.state.textDeltas.join(""),...e?{providerMetadata:e}:{}}]},createdAt:new Date};r.add(a,"response")}s.setState({isStreaming:!1,textDeltas:[]})}switch("reasoning-start"!==p.type&&"reasoning-delta"!==p.type&&"reasoning-end"!==p.type&&"redacted-reasoning"!==p.type&&"reasoning-signature"!==p.type&&"response-metadata"!==p.type&&"text-start"!==p.type&&s.state.isReasoning&&s.setState({isReasoning:!1,reasoningDeltas:[]}),p.type){case"response-metadata":s.setState({responseMetadata:{id:p.payload.id,timestamp:p.payload.timestamp,modelId:p.payload.modelId,headers:p.payload.headers}});break;case"text-start":p.payload.providerMetadata&&s.setState({providerOptions:p.payload.providerMetadata}),kH(i)&&i.enqueue(p);break;case"text-delta":{let e=s.state.textDeltas;e.push(p.payload.text),s.setState({textDeltas:e,isStreaming:!0}),kH(i)&&i.enqueue(p);break}case"text-end":s.setState({providerOptions:void 0}),kH(i)&&i.enqueue(p);break;case"tool-call-input-streaming-start":{let t=e?.[p.payload.toolName]||Object.values(e||{})?.find(e=>"id"in e&&e.id===p.payload.toolName);if(t&&"onInputStart"in t)try{await t?.onInputStart?.({toolCallId:p.payload.toolCallId,messages:r.get.input.aiV5.model(),abortSignal:n?.abortSignal})}catch(e){u?.error("Error calling onInputStart",e)}kH(i)&&i.enqueue(p);break}case"tool-call-delta":{let t=e?.[p.payload.toolName||""]||Object.values(e||{})?.find(e=>"id"in e&&e.id===p.payload.toolName);if(t&&"onInputDelta"in t)try{await t?.onInputDelta?.({inputTextDelta:p.payload.argsTextDelta,toolCallId:p.payload.toolCallId,messages:r.get.input.aiV5.model(),abortSignal:n?.abortSignal})}catch(e){u?.error("Error calling onInputDelta",e)}kH(i)&&i.enqueue(p);break}case"reasoning-start":if(s.setState({isReasoning:!0,reasoningDeltas:[],providerOptions:p.payload.providerMetadata??s.state.providerOptions}),Object.values(p.payload.providerMetadata||{}).find(e=>e?.redactedData)){let e={id:t,role:"assistant",content:{format:2,parts:[{type:"reasoning",reasoning:"",details:[{type:"redacted",data:""}],providerMetadata:p.payload.providerMetadata??s.state.providerOptions}]},createdAt:new Date};r.add(e,"response"),kH(i)&&i.enqueue(p);break}kH(i)&&i.enqueue(p);break;case"reasoning-delta":{let e=s.state.reasoningDeltas;e.push(p.payload.text),s.setState({isReasoning:!0,reasoningDeltas:e,providerOptions:p.payload.providerMetadata??s.state.providerOptions}),kH(i)&&i.enqueue(p);break}case"reasoning-end":{let e={id:t,role:"assistant",content:{format:2,parts:[{type:"reasoning",reasoning:"",details:[{type:"text",text:s.state.reasoningDeltas.join("")}],providerMetadata:p.payload.providerMetadata??s.state.providerOptions}]},createdAt:new Date};r.add(e,"response"),s.setState({isReasoning:!1,reasoningDeltas:[],providerOptions:void 0}),kH(i)&&i.enqueue(p);break}case"file":{let e={id:t,role:"assistant",content:{format:2,parts:[{type:"file",data:p.payload.data,mimeType:p.payload.mimeType}]},createdAt:new Date};r.add(e,"response"),i.enqueue(p)}break;case"source":{let e={id:t,role:"assistant",content:{format:2,parts:[{type:"source",source:{sourceType:"url",id:p.payload.id,url:p.payload.url||"",title:p.payload.title,providerMetadata:p.payload.providerMetadata}}]},createdAt:new Date};r.add(e,"response"),i.enqueue(p)}break;case"finish":s.setState({providerOptions:p.payload.metadata.providerMetadata,stepResult:{reason:p.payload.reason,logprobs:p.payload.logprobs,warnings:o.warnings,totalUsage:p.payload.totalUsage,headers:o.rawResponse?.headers,messageId:t,isContinued:!["stop","error"].includes(p.payload.stepResult.reason),request:o.request}});break;case"error":if(ps(p.payload.error)&&n?.abortSignal?.aborted)break;s.setState({hasErrored:!0}),s.setState({stepResult:{isContinued:!1,reason:"error"}});let a=(0,eN.getErrorFromUnknown)(p.payload.error,{fallbackMessage:"Unknown error in agent stream"});i.enqueue({...p,payload:{...p.payload,error:a}}),await n?.onError?.({error:a});break;default:kH(i)&&i.enqueue(p)}if(["text-delta","reasoning-delta","source","tool-call","tool-call-input-streaming-start","tool-call-delta","raw"].includes(p.type)){if("raw"===p.type&&!l)continue;await n?.onChunk?.(p)}if(s.state.hasErrored)break}}function kH(e){return 0!==e.desiredSize&&null!==e.desiredSize}async function kY(e,t){let r=Date.now();try{let a=await e.run({runId:t.runId,input:t,output:t.primitiveResult,requestContext:t.customContext}),s="number"==typeof a.score?a.score:0,n="string"==typeof a.reason?a.reason:void 0;return{score:s,passed:1===s,reason:n,scorerId:e.id,scorerName:e.name??e.id,duration:Date.now()-r}}catch(t){return{score:0,passed:!1,reason:`Scorer threw an error: ${t.message}`,scorerId:e.id,scorerName:e.name??e.id,duration:Date.now()-r}}}async function kX(e,t,r){let a=r?.strategy??"all",s=r?.parallel??!0,n=r?.timeout??6e5,i=Date.now(),o=[],l=!1,u=new Promise(e=>{setTimeout(()=>e("timeout"),n)});if(s){let r=e.map(e=>kY(e,t)),a=await Promise.race([Promise.all(r),u]);if("timeout"===a)for(let e of(l=!0,await Promise.allSettled(r)))"fulfilled"===e.status&&o.push(e.value);else o.push(...a)}else for(let r of e){if(Date.now()-i>n){l=!0;break}let e=await kY(r,t);if(o.push(e),"all"===a&&!e.passed||"any"===a&&e.passed)break}let p="all"===a?o.length===e.length&&o.every(e=>e.passed):o.some(e=>e.passed),d=o.find(e=>e.passed)||o[0];return{complete:p,completionReason:d?.reason,scorers:o,totalDuration:Date.now()-i,timedOut:l}}async function k0(e,t){let r=await kX(e.scorers||[],t,{strategy:e.strategy,parallel:e.parallel,timeout:e.timeout});return await e.onComplete?.(r),r}var k1=sg.object({isComplete:sg.boolean().describe("Whether the task is complete"),completionReason:sg.string().describe("Explanation of why the task is or is not complete"),finalResult:sg.string().optional().describe("The final result text to return to the user. omit if primitive result is sufficient")});async function k2(e,t,r){let a=Date.now(),s=t.messages.map(e=>{try{if("string"==typeof e.content)return null;let t=e.content.parts?.[0]?.type==="text"?e.content.parts?.[0]?.text:null;if(t?.includes('"isNetwork":true')){let e=JSON.parse(t);if(e.isNetwork)return`${e.primitiveType} "${e.primitiveId}"`}}catch{}return null}).filter(Boolean),n=s.length>0?`

Primitives already executed: ${s.join(", ")}`:"",i=`
    The ${t.selectedPrimitive.type} ${t.selectedPrimitive.id} has contributed to the task.
    This is the result: ${JSON.stringify(t.primitiveResult)}
    
    ${n}

    You need to evaluate if the task is complete. Pay very close attention to the SYSTEM INSTRUCTIONS for when the task is considered complete. 
    Only return true if the task is complete according to the system instructions.
    Original task: ${t.originalTask}

    If no primitive (type = 'none'), the task is complete because we can't run any primitive to further task completion.

    Also, if the ${t.selectedPrimitive.type} ${t.selectedPrimitive.id} has declined the tool call in its response, then the task is complete as the primitive tool-call was declined by the user.

    IMPORTANT: If the above result is from an AGENT PRIMITIVE and it is a suitable final result itself considering the original task, then finalResult should be an empty string or undefined.
    
    If the task is complete and the result is not from an AGENT PRIMITIVE, always generate a finalResult.
    IF the task is complete and the result is from an AGENT PRIMITIVE, but the AGENT PRIMITIVE response is not comprehensive enough to accomplish the user's original task, then generate a finalResult.

    IMPORTANT: The generated finalResult should not be the exact primitive result. You should craft a comprehensive response based on the message history.
    The finalResult field should be written in natural language.

    You must return this JSON shape:
    {
      "isComplete": boolean,
      "completionReason": string,
      "finalResult": string,
    }
  `;try{let t=await e.stream(i,{maxSteps:1,structuredOutput:{schema:k1}}),s="",n=0,{writer:o,stepId:l,runId:u}=r??{},p=o&&l&&u;for await(let e of(p&&await o.write({type:"routing-agent-text-start",payload:{runId:l},from:"NETWORK",runId:u}),t.objectStream))if(e?.finalResult&&(s=e.finalResult),p){let t=s.slice(n);e?.isComplete&&t.length&&(await o.write({type:"routing-agent-text-delta",payload:{text:t},from:"NETWORK",runId:u}),n=s.length)}let d=(await t.getFullOutput()).object;return{score:+!!d?.isComplete,passed:d?.isComplete??!1,reason:d?.completionReason,finalResult:d?.finalResult,scorerId:"default-completion",scorerName:"Default LLM Completion",duration:Date.now()-a}}catch(e){return{score:0,passed:!1,reason:`LLM completion check failed: ${e.message}`,scorerId:"default-completion",scorerName:"Default LLM Completion",duration:Date.now()-a}}}var k3=sg.object({finalResult:sg.string().optional().describe("The final result text to return to the user, omit if primitive result is sufficient")});async function k5(e,t,r){let a=`
    The task has been completed successfully.
    Original task: ${t.originalTask}

    The ${t.selectedPrimitive.type} ${t.selectedPrimitive.id} produced this result:
    ${JSON.stringify(t.primitiveResult)}

    IMPORTANT: If the above result is from an AGENT PRIMITIVE and it is a suitable final result itself considering the original task, then finalResult should be an empty string or undefined.
    You should evaluate if the above result is comprehensive enough to accomplish the user's original task.
    Otherwise, generate the finalResult object. If the result is not from an AGENT PRIMITIVE, always generate a finalResult.

    The generated finalResult should not be the exact primitive result. You should craft a comprehensive response based on the message history.
    The response should be written in natural language.

    Return JSON:
    {
      "finalResult": string,
    }
  `,s=await e.stream(a,{maxSteps:1,structuredOutput:{schema:k3}}),n="",i=0,{writer:o,stepId:l,runId:u}=r??{},p=o&&l&&u;for await(let e of(p&&await o.write({type:"routing-agent-text-start",payload:{runId:l},from:"NETWORK",runId:u}),s.objectStream))if(e?.finalResult&&(n=e.finalResult),p){let e=n.slice(i);e.length&&(await o.write({type:"routing-agent-text-delta",payload:{text:e},from:"NETWORK",runId:u}),i=n.length)}let d=await s.getFullOutput();return d.object?.finalResult}async function k4(e,t,r,a){let s=`
    The task has been completed successfully.
    Original task: ${t.originalTask}

    The ${t.selectedPrimitive.type} ${t.selectedPrimitive.id} produced this result:
    ${JSON.stringify(t.primitiveResult)}

    Based on the task and result above, generate a structured response according to the provided schema.
    Use the conversation history and primitive results to craft the response.
  `,n=await e.stream(s,{maxSteps:1,structuredOutput:r}),{writer:i,stepId:o,runId:l}=a??{},u=i&&o&&l;for await(let e of n.objectStream)u&&e&&await i.write({type:"network-object",payload:{object:e},from:"NETWORK",runId:l});let p=(await n.getFullOutput()).object;return u&&p&&await i.write({type:"network-object-result",payload:{object:p},from:"NETWORK",runId:l}),{text:p?JSON.stringify(p):void 0,object:p}}var k6=class extends wo.MastraBase{#eZ;#t;#r;#eB;constructor({mastra:e,models:t,options:r}){if(super({name:"aisdk"}),this.#r=r,e&&(this.#t=e,e.getLogger()&&this.__setLogger(this.#t.getLogger())),0!==t.length&&t[0])this.#eZ=t,this.#eB=t[0];else{const e=new eN.MastraError({id:"LLM_LOOP_MODELS_EMPTY",domain:"LLM",category:"USER"});throw this.logger.trackException(e),this.logger.error(e.toString()),e}}__registerPrimitives(e){e.logger&&this.__setLogger(e.logger)}__registerMastra(e){this.#t=e}getProvider(){return this.#eB.model.provider}getModelId(){return this.#eB.model.modelId}getModel(){return this.#eB.model}_applySchemaCompat(e){let t=this.#eB.model,r=[];if(t){let e={modelId:t.modelId,supportsStructuredOutputs:!0,provider:t.provider};r.push(new vH(e),new vJ(e),new vW(e),new vK(e),new vG(e),new vQ(e))}return vS({schema:e,compatLayers:r,mode:"aiSdkSchema"})}convertToMessages(e){return Array.isArray(e)?e.map(e=>"string"==typeof e?{role:"user",content:e}:e):[{role:"user",content:e}]}stream({resumeContext:t,runId:r,stopWhen:a=a0(5),maxSteps:s,tools:n={},modelSettings:i,toolChoice:o="auto",threadId:l,resourceId:u,structuredOutput:p,options:d,inputProcessors:c,outputProcessors:m,returnScorerData:g,providerOptions:h,tracingContext:f,messageList:y,requireToolApproval:v,toolCallConcurrency:b,_internal:w,agentId:k,agentName:_,toolCallId:I,requestContext:S,methodType:x,includeRawChunks:T,autoResumeSuspendedTools:E,maxProcessorRetries:A}){let O;O=s&&"number"==typeof s?a0(s):a;let z=y.get.all.aiV5.model(),M=this.#eB.model;this.logger.debug("[LLM] - Streaming text",{runId:r,threadId:l,resourceId:u,messages:z,tools:Object.keys(n||{})});let P=f?.currentSpan?.createChildSpan({name:`llm: '${M.modelId}'`,type:"model_generation",input:{messages:[...y.getSystemMessages(),...z]},attributes:{model:M.modelId,provider:M.provider,streaming:!0,parameters:i},metadata:{runId:r,threadId:l,resourceId:u},tracingPolicy:this.#r?.tracingPolicy}),R=P?.createTracker();try{let a={mastra:this.#t,resumeContext:t,runId:r,toolCallId:I,messageList:y,models:this.#eZ,tools:n,stopWhen:O,toolChoice:o,modelSettings:i,providerOptions:h,_internal:w,structuredOutput:p,inputProcessors:c,outputProcessors:m,returnScorerData:g,modelSpanTracker:R,requireToolApproval:v,toolCallConcurrency:b,agentId:k,agentName:_,requestContext:S,methodType:x,includeRawChunks:T,autoResumeSuspendedTools:E,maxProcessorRetries:A,options:{...d,onStepFinish:async e=>{try{await d?.onStepFinish?.({...e,runId:r})}catch(a){let t=new eN.MastraError({id:"LLM_STREAM_ON_STEP_FINISH_CALLBACK_EXECUTION_FAILED",domain:"LLM",category:"USER",details:{modelId:e.model?.modelId,modelProvider:e.model?.provider,runId:r??"unknown",threadId:l??"unknown",resourceId:u??"unknown",finishReason:e?.finishReason,toolCalls:e?.toolCalls?JSON.stringify(e.toolCalls):"",toolResults:e?.toolResults?JSON.stringify(e.toolResults):"",usage:e?.usage?JSON.stringify(e.usage):""}},a);throw R?.reportGenerationError({error:t}),this.logger.trackException(t),t}this.logger.debug("[LLM] - Stream Step Change:",{text:e?.text,toolCalls:e?.toolCalls,toolResults:e?.toolResults,finishReason:e?.finishReason,usage:e?.usage,runId:r});let t=parseInt(e?.response?.headers?.["x-ratelimit-remaining-tokens"]??"",10);!isNaN(t)&&t>0&&t<2e3&&(this.logger.warn("Rate limit approaching, waiting 10 seconds",{runId:r}),await vX(1e4))},onFinish:async e=>{R?.endGeneration({output:{files:e?.files,object:e?.object,reasoning:e?.reasoning,reasoningText:e?.reasoningText,sources:e?.sources,text:e?.text,warnings:e?.warnings},attributes:{finishReason:e?.finishReason,responseId:e?.response.id,responseModel:e?.response.modelId},usage:e?.totalUsage,providerMetadata:e?.providerMetadata});try{await d?.onFinish?.({...e,runId:r})}catch(a){let t=new eN.MastraError({id:"LLM_STREAM_ON_FINISH_CALLBACK_EXECUTION_FAILED",domain:"LLM",category:"USER",details:{modelId:e.model?.modelId,modelProvider:e.model?.provider,runId:r??"unknown",threadId:l??"unknown",resourceId:u??"unknown",finishReason:e?.finishReason,toolCalls:e?.toolCalls?JSON.stringify(e.toolCalls):"",toolResults:e?.toolResults?JSON.stringify(e.toolResults):"",usage:e?.usage?JSON.stringify(e.usage):""}},a);throw R?.reportGenerationError({error:t}),this.logger.trackException(t),t}this.logger.debug("[LLM] - Stream Finished:",{text:e?.text,toolCalls:e?.toolCalls,toolResults:e?.toolResults,finishReason:e?.finishReason,usage:e?.usage,runId:r,threadId:l,resourceId:u})}}};return function({resumeContext:t,models:r,logger:a,runId:s,idGenerator:n,messageList:i,includeRawChunks:o,modelSettings:l,tools:u,_internal:p,outputProcessors:d,returnScorerData:c,requireToolApproval:m,agentId:g,toolCallConcurrency:h,...f}){let y,v,b=a||new eD.ConsoleLogger({level:"debug"});if(0===r.length||!r[0]){let e=new eN.MastraError({id:"LOOP_MODELS_EMPTY",domain:"LLM",category:"USER"});throw b.trackException(e),b.error(e.toString()),e}let w=r[0],k=s;k||(k=n?.({idType:"run",source:"agent",entityId:g,threadId:p?.threadId,resourceId:p?.resourceId})||crypto.randomUUID());let _={now:p?.now||(()=>Date.now()),generateId:p?.generateId||(()=>tc()),currentDate:p?.currentDate||(()=>new Date),saveQueueManager:p?.saveQueueManager,memoryConfig:p?.memoryConfig,threadId:p?.threadId,resourceId:p?.resourceId,memory:p?.memory,threadExists:p?.threadExists},I=_.now?.(),S=f.experimental_generateMessageId?.()||_.generateId?.(),x=d&&d.length>0?new Map:void 0,T={resumeContext:t,models:r,runId:k,logger:b,startTimestamp:I,messageList:i,includeRawChunks:!!o,_internal:_,tools:u,modelSettings:l,outputProcessors:d,messageId:S,agentId:g,requireToolApproval:m,toolCallConcurrency:h,streamState:{serialize:()=>y?.serializeState(),deserialize:e=>{y?.deserializeState(e)}},processorStates:x,...f},E=t?.snapshot;if(E)for(let e in E?.context){let t=E?.context[e];if(t&&"suspended"===t.status&&t.suspendPayload?.__streamState){v=t.suspendPayload?.__streamState;break}}let A=function({resumeContext:t,requireToolApproval:r,models:a,toolChoice:s,modelSettings:n,_internal:i,messageId:o,runId:l,messageList:u,startTimestamp:p,streamState:d,agentId:c,toolCallId:m,toolCallConcurrency:g,...h}){return new wl.ReadableStream({start:async f=>{let y=async e=>{if(e.type.startsWith("data-")&&o){let t={id:o,role:"assistant",content:{format:2,parts:[{type:e.type,data:"data"in e?e.data:void 0}]},createdAt:new Date,threadId:i?.threadId,resourceId:i?.resourceId};u.add(t,"response")}f.enqueue(e)},v=function(t){let{models:r,_internal:a,messageId:s,runId:n,toolChoice:i,messageList:o,modelSettings:l,controller:u,outputWriter:p,...d}=t,c=[],m=0,g=function({models:t,_internal:r,...a}){let s=function({models:t,_internal:r,messageId:a,runId:s,tools:n,toolChoice:i,activeTools:o,messageList:l,includeRawChunks:u,modelSettings:p,providerOptions:d,options:c,toolCallStreaming:m,controller:g,structuredOutput:h,outputProcessors:f,inputProcessors:y,logger:v,agentId:b,downloadRetries:w,downloadConcurrency:k,processorStates:_,requestContext:I,methodType:S,modelSpanTracker:x,autoResumeSuspendedTools:T,maxProcessorRetries:E}){let A=l.getAllSystemMessages();return kj({id:"llm-execution",inputSchema:kU,outputSchema:kU,execute:async({inputData:O,bail:z,tracingContext:M})=>{let P,R,C,j;x?.startStep();let{outputStream:N,callBail:L,runState:D,stepTools:q}=await (async e=>{let r,a=0,s=!1;for(let n of t){a++;let i=n.maxRetries||0,o=0;if(s)break;for(;o<=i;)try{let l=o===i&&a===t.length;r=await e(n,l),s=!0;break}catch(t){if(t instanceof wG)throw t;if(o++,v?.error(`Error executing model ${n.model.modelId}, attempt ${o}====`,t),o>i)break;let e=Math.min(1e3*Math.pow(2,o-1),1e4);await new Promise(t=>setTimeout(t,e))}}if(void 0===r)throw v?.error("Exhausted all fallback models and reached the maximum number of retries."),Error("Exhausted all fallback models and reached the maximum number of retries.");return r})(async(t,E)=>{let z,N=t.model,L=t.headers;A&&l.replaceAllSystemMessages(A),O.processorRetryFeedback&&l.addSystem(O.processorRetryFeedback,"processor-retry-feedback");let D={model:N,tools:n,toolChoice:i,activeTools:o,providerOptions:d,modelSettings:p,structuredOutput:h},q=[...y||[],...c?.prepareStep?[new kV({prepareStep:c.prepareStep})]:[]];if(q&&q.length>0){let e=new wD({inputProcessors:q,outputProcessors:[],logger:v||new eD.ConsoleLogger({level:"error"}),agentName:b||"unknown"});try{let t=x?.getTracingContext()??M,r=await e.runProcessInputStep({messageList:l,stepNumber:O.output?.steps?.length||0,tracingContext:t,requestContext:I,model:N,steps:O.output?.steps||[],tools:n,toolChoice:i,activeTools:o,providerOptions:d,modelSettings:p,structuredOutput:h,retryCount:O.processorRetryCount||0});Object.assign(D,r)}catch(e){if(e instanceof wG){kH(g)&&g.enqueue({type:"tripwire",runId:s,from:"AGENT",payload:{reason:e.message,retry:e.options?.retry,metadata:e.options?.metadata,processorId:e.processorId}});let t=new kQ({_internal:r,model:N});return{callBail:!0,outputStream:new wB({model:{modelId:N.modelId,provider:N.provider,version:N.specificationVersion},stream:new wl.ReadableStream({start(e){e.close()}}),messageList:l,messageId:a,options:{runId:s}}),runState:t,stepTools:n}}throw v?.error("Error in processInputStep processors:",e),e}}let $=new kQ({_internal:r,model:D.model}),F={downloadRetries:w,downloadConcurrency:k,supportedUrls:D.model?.supportedUrls},U=await l.get.all.aiV5.llmPrompt(F);if(T){let e=[...l.get.all.db()].reverse().filter(e=>"assistant"===e.role).find(e=>{if(e.content.metadata?.suspendedTools||e.content.metadata?.pendingToolApprovals)return!0;let t=e.content.parts?.filter(e=>("data-tool-call-suspended"===e.type||"data-tool-call-approval"===e.type)&&!e.data.resumed);return!!t&&!!(t.length>0)});if(e){let t=e.content.metadata,r=t?.suspendedTools||t?.pendingToolApprovals;r||(r=e.content.parts?.filter(e=>"data-tool-call-suspended"===e.type||"data-tool-call-approval"===e.type)?.reduce((e,t)=>("data-tool-call-suspended"!==t.type&&"data-tool-call-approval"!==t.type||t.data.resumed||(e[t.data.toolName]=t.data),e),{}));let a=Object.values(r);a.length>0&&(U=U.map((e,t)=>("system"===e.role&&0===t&&(e.content=e.content+`

Analyse the suspended tools: ${JSON.stringify(a)}, using the messages available to you and the resumeSchema of each suspended tool, find the tool whose resumeData you can construct properly.
                      resumeData can not be an empty object nor null/undefined.
                      When you find that and call that tool, add the resumeData to the tool call arguments/input.
                      Also, add the runId of the suspended tool as suspendedToolRunId to the tool call arguments/input.
                      If the suspendedTool.type is 'approval', resumeData will be an object that contains 'approved' which can either be true or false depending on the user's message. If you can't construct resumeData from the message for approval type, set approved to true and add resumeData: { approved: true } to the tool call arguments/input.
                      `),e)))}}if(z=D.model,wC.includes(z.specificationVersion))P=pH({span:x?.getTracingContext()?.currentSpan,fn:()=>(function({runId:t,model:r,providerOptions:a,inputMessages:s,tools:n,toolChoice:i,activeTools:o,options:l,onResult:u,includeRawChunks:p,modelSettings:d,structuredOutput:c,headers:m,shouldThrowError:g,methodType:h,generateId:f}){let y=new kG({component:"LLM",name:r.modelId,generateId:f}),v=function({tools:e,toolChoice:t,activeTools:r,targetVersion:a="v2"}){if(0===Object.keys(e||{}).length)return{tools:void 0,toolChoice:void 0};let s=null!=r?Object.entries(e||{}).filter(([e])=>r.includes(e)):Object.entries(e||{}),n="v3"===a?"provider":"provider-defined";return{tools:s.map(([e,t])=>{try{let r;if("object"==typeof t&&null!==t&&("provider-defined"===t.type||"provider"===t.type)&&"string"==typeof t.id)return{type:n,name:wz(t.id),id:t.id,args:t.args??{}};"inputSchema"in t?r=t.inputSchema:"parameters"in t&&(r=t.parameters);let a={type:"function",...t,inputSchema:r},s=a?.type??"function";switch(s){case void 0:case"dynamic":case"function":return{type:"function",name:e,description:a.description,inputSchema:ra(a.inputSchema).jsonSchema,providerOptions:a.providerOptions};case"provider-defined":{let t=a.id;return{type:n,name:t?wz(t):e,id:t,args:a.args}}default:throw Error(`Unsupported tool type: ${s}`)}}catch(e){return console.error("Error preparing tool",e),null}}).filter(e=>null!==e),toolChoice:null==t?{type:"auto"}:"string"==typeof t?{type:t}:{type:"tool",toolName:t.toolName}}}({tools:n,toolChoice:i,activeTools:o,targetVersion:"v3"===r.specificationVersion?"v3":"v2"}),b=c?.schema?c?.model?"processor":"direct":void 0,w=c?.schema?function(e){if(e){let t=wq(e);return{type:"json",schema:t?.jsonSchema}}return{type:"text"}}(c?.schema):void 0,k=s;"direct"===b&&w?.type==="json"&&c?.jsonPromptInjection&&(k=pn({messages:s,schema:w.schema})),"processor"===b&&w?.type==="json"&&w?.schema&&(k=pn({messages:s,schema:w.schema,schemaPrefix:`Your response will be processed by another agent to extract structured data. Please ensure your response contains comprehensive information for all the following fields that will be extracted:
`,schemaSuffix:`

You don't need to format your response as JSON unless the user asks you to. Just ensure your natural language response includes relevant information for each field in the schema above.`}));let _=r.provider.startsWith("openai")&&w?.type==="json"&&!c?.jsonPromptInjection?{...a??{},openai:{strictJsonSchema:!0,...a?.openai??{}}}:a;return y.initialize({runId:t,onResult:u,createStream:async()=>{try{let t=function(e,t){let r={...e};for(let e of t)delete r[e];return r}(d||{},["maxRetries","headers"]),a=l?.abortSignal,s=await e.A(658637);return await s.default(async()=>{let e=("stream"===h?r.doStream:r.doGenerate).bind(r);return await e({...v,prompt:k,providerOptions:_,abortSignal:a,includeRawChunks:p,responseFormat:"direct"!==b||c?.jsonPromptInjection?void 0:w,...t,headers:m})},{retries:d?.maxRetries??2,signal:a,shouldRetry:e=>!eY.isInstance(e.error)||e.error.isRetryable})}catch(e){if(g)throw e;return{stream:new ReadableStream({start:async t=>{t.enqueue({type:"error",error:e}),t.close()}}),warnings:[],request:{},rawResponse:{}}}}})})({runId:s,model:D.model,providerOptions:D.providerOptions,inputMessages:U,tools:D.tools,toolChoice:D.toolChoice,activeTools:D.activeTools,options:c,modelSettings:D.modelSettings,includeRawChunks:u,structuredOutput:D.structuredOutput,headers:L||D.modelSettings?.headers?{...L,...D.modelSettings?.headers}:void 0,methodType:S,generateId:r?.generateId,onResult:({warnings:e,request:t,rawResponse:r})=>{R=e,C=t||{},j=r,kH(g)&&g.enqueue({runId:s,from:"AGENT",type:"step-start",payload:{request:C||{},warnings:R||[],messageId:a}})},shouldThrowError:!E})});else throw Error(`Unsupported model version: ${D.model.specificationVersion}. Supported versions: ${wC.join(", ")}`);let Z=new wB({model:{modelId:D.model.modelId,provider:D.model.provider,version:D.model.specificationVersion},stream:P,messageList:l,messageId:a,options:{runId:s,toolCallStreaming:m,includeRawChunks:u,structuredOutput:D.structuredOutput,outputProcessors:f,isLLMExecutionStep:!0,tracingContext:M,processorStates:_,requestContext:I}});try{await kJ({outputStream:Z,includeRawChunks:u,tools:D.tools,messageId:a,messageList:l,runState:$,options:c,controller:g,responseFromModel:{warnings:R,request:C,rawResponse:j},logger:v})}catch(r){let e=N?.provider,t=N?.modelId;if(eY.isInstance(r)){let a=e?` from ${e}`:"",n=t?` (model: ${t})`:"";v?.error(`Upstream LLM API error${a}${n}`,{error:r,runId:s,...e&&{provider:e},...t&&{modelId:t}})}else v?.error("Error in LLM execution",{error:r,runId:s,...e&&{provider:e},...t&&{modelId:t}});if(ps(r)&&c?.abortSignal?.aborted)return await c?.onAbort?.({steps:O?.output?.steps??[]}),kH(g)&&g.enqueue({type:"abort",runId:s,from:"AGENT",payload:{}}),{callBail:!0,outputStream:Z,runState:$,stepTools:D.tools};if(E)kH(g)&&g.enqueue({type:"error",runId:s,from:"AGENT",payload:{error:r}}),$.setState({hasErrored:!0,stepResult:{isContinued:!1,reason:"error"}});else throw r}return{outputStream:Z,callBail:!1,runState:$,stepTools:D.tools}});if(r&&(r.stepTools=q),L){let e=N._getImmediateUsage(),t=D.state.responseMetadata,r=N._getImmediateText();return z({messageId:a,stepResult:{reason:"tripwire",warnings:R,isContinued:!1},metadata:{providerMetadata:D.state.providerOptions,...t,modelMetadata:D.state.modelMetadata,headers:j?.headers,request:C},output:{text:r,toolCalls:[],usage:e??O.output.usage,steps:[]},messages:{all:l.get.all.aiV5.model(),user:l.get.input.aiV5.model(),nonUser:l.get.response.aiV5.model()}})}N.tripwire&&D.setState({stepResult:{isContinued:!1,reason:"tripwire"}});let $=N._getImmediateToolCalls()?.map(e=>e.payload);if($.length>0){let e={id:a,role:"assistant",content:{format:2,parts:$.map(e=>({type:"tool-invocation",toolInvocation:{state:"call",toolCallId:e.toolCallId,toolName:e.toolName,args:e.args},...e.providerMetadata?{providerMetadata:e.providerMetadata}:{}}))},createdAt:new Date};l.add(e,"response")}let F=null;if(f&&f.length>0){let e=new wD({inputProcessors:[],outputProcessors:f,logger:v||new eD.ConsoleLogger({level:"error"}),agentName:b||"unknown"});try{let t=O.output?.steps?.length||0,r=N._getImmediateText(),a=N._getImmediateFinishReason(),s=$.map(e=>({toolName:e.toolName,toolCallId:e.toolCallId,args:e.args})),n=O.processorRetryCount||0,i=x?.getTracingContext()??M;await e.runProcessOutputStep({steps:O.output?.steps??[],messages:l.get.all.db(),messageList:l,stepNumber:t,finishReason:a,toolCalls:s.length>0?s:void 0,text:r,tracingContext:i,requestContext:I,retryCount:n})}catch(e){if(e instanceof wG)F=e;else throw v?.error("Error in processOutputStep processors:",e),e}}let U=D?.state?.stepResult?.reason??N._getImmediateFinishReason(),Z=D.state.hasErrored,B=N._getImmediateUsage(),V=D.state.responseMetadata,K=N._getImmediateText(),G=N._getImmediateObject(),W=N.tripwire||null!==F,Q=O.processorRetryCount||0,J=F?.options?.retry===!0,H=void 0!==E&&Q<E,Y=J&&H;J&&!H&&(void 0===E?v?.warn?.("Processor requested retry but maxProcessorRetries is not set. Treating as abort."):v?.warn?.(`Processor requested retry but maxProcessorRetries (${E}) exceeded. Current count: ${Q}. Treating as abort.`));let X=O.output?.steps||[],ee=O.messages?.nonUser?.length||0,et=l.get.response.aiV5.modelContent(X.length).slice(ee),er=F?{reason:F.message,retry:F.options?.retry,metadata:F.options?.metadata,processorId:F.processorId}:void 0;X.push(new kW({warnings:N._getImmediateWarnings(),providerMetadata:D.state.providerOptions,finishReason:D.state.stepResult?.reason,content:et,response:{...V,...j,messages:l.get.response.aiV5.model()},request:C,usage:N._getImmediateUsage(),tripwire:er}));let ea=Y&&F?`[Processor Feedback] Your previous response was not accepted: ${F.message}. Please try again with the feedback in mind.`:void 0,es={all:l.get.all.aiV5.model(),user:l.get.input.aiV5.model(),nonUser:l.get.response.aiV5.model()},en=Y?"retry":W?"tripwire":Z?"error":U,ei=Y||!W&&!["stop","error"].includes(U);return{messageId:a,stepResult:{reason:en,warnings:R,isContinued:ei,...Y&&F?{retryReason:F.message,retryMetadata:F.options?.metadata,retryProcessorId:F.processorId}:{}},metadata:{providerMetadata:D.state.providerOptions,...V,...j,modelMetadata:D.state.modelMetadata,headers:j?.headers,request:C},output:{text:K,toolCalls:Y?[]:$,usage:B??O.output?.usage,steps:X,...G?{object:G}:{}},messages:es,processorRetryCount:Y?Q+1:Q,processorRetryFeedback:ea}}})}({models:t,_internal:r,...a}),n=function({tools:e,messageList:t,options:r,outputWriter:a,controller:s,runId:n,streamState:i,modelSpanTracker:o,_internal:l,logger:u}){return kj({id:"toolCallStep",inputSchema:kZ,outputSchema:kB,execute:async({inputData:p,suspend:d,resumeData:c,requestContext:m})=>{let g=l?.stepTools||e,h=g?.[p.toolName]||Object.values(g||{})?.find(e=>"id"in e&&e.id===p.toolName),f=({toolCallId:e,toolName:r,args:a,suspendPayload:s,resumeSchema:i,type:o})=>{let l="suspension"===o?"suspendedTools":"pendingToolApprovals",u=[...t.get.response.db()].reverse().find(e=>"assistant"===e.role);if(u){if(!u.content)return;let t="object"==typeof u.content.metadata&&null!==u.content.metadata?u.content.metadata:{};t[l]=t[l]||{},t[l][r]={toolCallId:e,toolName:r,args:a,type:o,runId:n,..."suspension"===o?{suspendPayload:s}:{},resumeSchema:i},u.content.metadata=t}},y=async(e,r)=>{let{saveQueueManager:a,memoryConfig:s,threadId:n}=l||{};if(!a||!n)return;let i=e=>{let t=e.content;if(t)return"object"==typeof t.metadata&&null!==t.metadata?t.metadata:void 0},o="suspension"===r?"suspendedTools":"pendingToolApprovals",p=[...t.get.all.db()].reverse().find(t=>{let r=i(t),a=r?.[o];if(a?.[e])return!0;let s=t.content.parts?.filter(e=>"data-tool-call-suspended"===e.type||"data-tool-call-approval"===e.type);return!!(s&&s.length>0&&s.find(t=>t.data.toolName===e))||!1});if(p){let r=i(p),l=r?.[o];if(l||(l=p.content.parts?.filter(e=>"data-tool-call-suspended"===e.type||"data-tool-call-approval"===e.type)?.reduce((e,t)=>(("data-tool-call-suspended"===t.type||"data-tool-call-approval"===t.type)&&(e[t.data.toolName]=t.data),e),{})),l&&"object"==typeof l){r?delete l[e]:p.content.parts=p.content.parts?.map(t=>("data-tool-call-suspended"===t.type||"data-tool-call-approval"===t.type)&&t.data.toolName===e?{...t,data:{...t.data,resumed:!0}}:t),r&&0===Object.keys(l).length&&delete r[o];try{await a.flushMessages(t,n,s)}catch(e){u?.error("Error removing tool suspension metadata:",e)}}}},v=async()=>{let{saveQueueManager:e,memoryConfig:r,threadId:a,resourceId:s,memory:n}=l||{};if(e&&a)try{n&&!l.threadExists&&s&&(await n.getThreadById?.({threadId:a})||await n.createThread?.({threadId:a,resourceId:s,memoryConfig:r}),l.threadExists=!0),await e.flushMessages(t,a,r)}catch(e){u?.error("Error flushing messages before suspension:",e)}};if(p.providerExecuted)return{...p,result:p.output};if(!h)throw Error(`Tool ${p.toolName} not found`);if(h&&"onInputAvailable"in h)try{await h?.onInputAvailable?.({toolCallId:p.toolCallId,input:p.args,messages:t.get.input.aiV5.model(),abortSignal:r?.abortSignal})}catch(e){u?.error("Error calling onInputAvailable",e)}if(!h.execute)return p;try{let e,l=m.get("__mastra_requireToolApproval"),g=p.args;if("object"==typeof p.args&&null!==p.args){let{resumeData:t,...r}=p.args;g=r,e=t}let b=e??c,w=!!e,k=l||h.requireApproval;if(h.needsApprovalFn)try{k=await h.needsApprovalFn(g)}catch(e){u?.error(`Error evaluating needsApprovalFn for tool ${p.toolName}:`,e),k=!0}if(k){if(!b)return s.enqueue({type:"tool-call-approval",runId:n,from:"AGENT",payload:{toolCallId:p.toolCallId,toolName:p.toolName,args:p.args,resumeSchema:JSON.stringify(mh(eF.object({approved:eF.boolean().describe("Controls if the tool call is approved or not, should be true when approved and false when declined")})))}}),f({toolCallId:p.toolCallId,toolName:p.toolName,args:p.args,type:"approval",resumeSchema:JSON.stringify(mh(eF.object({approved:eF.boolean().describe("Controls if the tool call is approved or not, should be true when approved and false when declined")})))}),await v(),d({requireToolApproval:{toolCallId:p.toolCallId,toolName:p.toolName,args:p.args},__streamState:i.serialize()},{resumeLabel:p.toolCallId});else if(await y(p.toolName,"approval"),!b.approved)return{result:"Tool call was not approved by the user",...p}}else w&&await y(p.toolName,"suspension");let _=k&&1===Object.keys(b).length&&"approved"in b?void 0:b,I={abortSignal:r?.abortSignal,toolCallId:p.toolCallId,messages:t.get.input.aiV5.model(),outputWriter:a,tracingContext:o?.getTracingContext(),suspend:async(e,t)=>(s.enqueue({type:"tool-call-suspended",runId:n,from:"AGENT",payload:{toolCallId:p.toolCallId,toolName:p.toolName,suspendPayload:e,args:p.args,resumeSchema:t?.resumeSchema}}),f({toolCallId:p.toolCallId,toolName:p.toolName,args:g,suspendPayload:e,type:"suspension",resumeSchema:t?.resumeSchema}),await v(),await d({toolCallSuspended:e,__streamState:i.serialize(),toolName:p.toolName,resumeLabel:t?.resumeLabel},{resumeLabel:p.toolCallId})),resumeData:_},S=await h.execute(g,I);if(h&&"onOutput"in h&&"function"==typeof h.onOutput)try{await h.onOutput({toolCallId:p.toolCallId,toolName:p.toolName,output:S,abortSignal:r?.abortSignal})}catch(e){u?.error("Error calling onOutput",e)}return{result:S,...p}}catch(e){return{error:e,...p}}}})}({_internal:r,...a}),i=function({models:e,_internal:t,...r},a){let s=r.outputProcessors?.length&&r.logger?new wD({inputProcessors:[],outputProcessors:r.outputProcessors,logger:r.logger,agentName:"LLMMappingStep"}):void 0,n=r.modelSpanTracker?.getTracingContext();async function i(e){if(s&&r.processorStates){let{part:t,blocked:a,reason:i,tripwireOptions:o,processorId:l}=await s.processPart(e,r.processorStates,n,r.requestContext,r.messageList);if(a)return void r.controller.enqueue({type:"tripwire",payload:{reason:i||"Output processor blocked content",retry:o?.retry,metadata:o?.metadata,processorId:l}});t&&r.controller.enqueue(t)}else r.controller.enqueue(e)}return kj({id:"llmExecutionMappingStep",inputSchema:eF.array(kB),outputSchema:kU,execute:async({inputData:e,getStepResult:s,bail:n})=>{let o=s(a);if(e?.some(e=>e?.result===void 0)){let a=e.filter(e=>e?.error),s=r.experimental_generateMessageId?.()||t?.generateId?.();if(a?.length){for(let e of a){let t={type:"tool-error",runId:r.runId,from:"AGENT",payload:{error:e.error,args:e.args,toolCallId:e.toolCallId,toolName:e.toolName,providerMetadata:e.providerMetadata}};await i(t)}let e={id:s||"",role:"assistant",content:{format:2,parts:a.map(e=>({type:"tool-invocation",toolInvocation:{state:"result",toolCallId:e.toolCallId,toolName:e.toolName,args:e.args,result:e.error?.message??e.error},...e.providerMetadata?{providerMetadata:e.providerMetadata}:{}}))},createdAt:new Date};r.messageList.add(e,"response")}return"retry"!==o.stepResult.reason&&(o.stepResult.isContinued=!1),n({...o,messages:{all:r.messageList.get.all.aiV5.model(),user:r.messageList.get.input.aiV5.model(),nonUser:r.messageList.get.response.aiV5.model()}})}if(e?.length){for(let t of e){let e={type:"tool-result",runId:r.runId,from:"AGENT",payload:{args:t.args,toolCallId:t.toolCallId,toolName:t.toolName,result:t.result,providerMetadata:t.providerMetadata,providerExecuted:t.providerExecuted}};await i(e),wC.includes(o?.metadata?.modelVersion)&&await r.options?.onChunk?.({chunk:function({chunk:e,mode:t="stream"}){switch(e.type){case"start":return{type:"start"};case"step-start":let{messageId:r,...a}=e.payload;return{type:"start-step",request:a.request,warnings:a.warnings||[]};case"raw":return{type:"raw",rawValue:e.payload};case"finish":return{type:"finish",finishReason:e.payload.stepResult.reason,totalUsage:e.payload.output.usage};case"reasoning-start":return{type:"reasoning-start",id:e.payload.id,providerMetadata:e.payload.providerMetadata};case"reasoning-delta":return{type:"reasoning-delta",id:e.payload.id,text:e.payload.text,providerMetadata:e.payload.providerMetadata};case"reasoning-signature":throw Error('AISDKv5 chunk type "reasoning-signature" not supported');case"redacted-reasoning":throw Error('AISDKv5 chunk type "redacted-reasoning" not supported');case"reasoning-end":return{type:"reasoning-end",id:e.payload.id,providerMetadata:e.payload.providerMetadata};case"source":if("url"===e.payload.sourceType)return{type:"source",sourceType:"url",id:e.payload.id,url:e.payload.url,title:e.payload.title,providerMetadata:e.payload.providerMetadata};return{type:"source",sourceType:"document",id:e.payload.id,mediaType:e.payload.mimeType,title:e.payload.title,filename:e.payload.filename,providerMetadata:e.payload.providerMetadata};case"file":if("generate"===t)return{type:"file",file:new pz({data:e.payload.data,mediaType:e.payload.mimeType})};return{type:"file",file:new pM({data:e.payload.data,mediaType:e.payload.mimeType})};case"tool-call":return{type:"tool-call",toolCallId:e.payload.toolCallId,providerMetadata:e.payload.providerMetadata,providerExecuted:e.payload.providerExecuted,toolName:e.payload.toolName,input:e.payload.args};case"tool-call-input-streaming-start":return{type:"tool-input-start",id:e.payload.toolCallId,toolName:e.payload.toolName,dynamic:!!e.payload.dynamic,providerMetadata:e.payload.providerMetadata,providerExecuted:e.payload.providerExecuted};case"tool-call-input-streaming-end":return{type:"tool-input-end",id:e.payload.toolCallId,providerMetadata:e.payload.providerMetadata};case"tool-call-delta":return{type:"tool-input-delta",id:e.payload.toolCallId,delta:e.payload.argsTextDelta,providerMetadata:e.payload.providerMetadata};case"step-finish":{let{request:t,providerMetadata:r,...a}=e.payload.metadata;return{type:"finish-step",response:{id:e.payload.id||"",timestamp:new Date,modelId:a.modelId||"",...a},usage:e.payload.output.usage,finishReason:e.payload.stepResult.reason,providerMetadata:r}}case"text-delta":return{type:"text-delta",id:e.payload.id,text:e.payload.text,providerMetadata:e.payload.providerMetadata};case"text-end":return{type:"text-end",id:e.payload.id,providerMetadata:e.payload.providerMetadata};case"text-start":return{type:"text-start",id:e.payload.id,providerMetadata:e.payload.providerMetadata};case"tool-result":return{type:"tool-result",input:e.payload.args,toolCallId:e.payload.toolCallId,providerExecuted:e.payload.providerExecuted,toolName:e.payload.toolName,output:e.payload.result};case"tool-error":return{type:"tool-error",error:e.payload.error,input:e.payload.args,toolCallId:e.payload.toolCallId,providerExecuted:e.payload.providerExecuted,toolName:e.payload.toolName};case"abort":return{type:"abort"};case"error":return{type:"error",error:e.payload.error};case"object":return{type:"object",object:e.object};default:if(e.type&&"payload"in e&&e.payload)return{type:e.type,...e.payload||{}};return}}({chunk:e})})}let a={id:r.experimental_generateMessageId?.()||t?.generateId?.()||"",role:"assistant",content:{format:2,parts:e.map(e=>({type:"tool-invocation",toolInvocation:{state:"result",toolCallId:e.toolCallId,toolName:e.toolName,args:e.args,result:e.result},...e.providerMetadata?{providerMetadata:e.providerMetadata}:{}}))},createdAt:new Date};return r.messageList.add(a,"response"),{...o,messages:{all:r.messageList.get.all.aiV5.model(),user:r.messageList.get.input.aiV5.model(),nonUser:r.messageList.get.response.aiV5.model()}}}return o}})}({models:t,_internal:r,...a},s),o=10;a?.toolCallConcurrency&&(o=a.toolCallConcurrency>0?a.toolCallConcurrency:10);let l=!!a.requireToolApproval,u=!1,p=!1;if(a.tools){for(let e of Object.values(a.tools))if(e?.hasSuspendSchema&&(u=!0),e?.requireApproval&&(p=!0),u||p)break}let d=l||u||p;return kL({id:"executionWorkflow",inputSchema:kU,outputSchema:kU,options:{tracingPolicy:{internal:1},shouldPersistSnapshot:({workflowStatus:e})=>"suspended"===e,validateInputs:!1}}).then(s).map(async({inputData:e})=>{let t=e.messages.nonUser;return t&&t.length>0&&a.messageList.add(t,"response"),e},{id:"add-response-to-messagelist"}).map(async({inputData:e})=>e.output.toolCalls||[],{id:"map-tool-calls"}).foreach(n,{concurrency:d?1:o}).then(i).commit()}({messageId:s,models:r,_internal:a,modelSettings:l,toolChoice:i,controller:u,outputWriter:p,messageList:o,runId:n,...d});return kL({id:"agentic-loop",inputSchema:kU,outputSchema:kU,options:{tracingPolicy:{internal:1},shouldPersistSnapshot:e=>"suspended"===e.workflowStatus,validateInputs:!1}}).dowhile(g,async({inputData:e})=>{let t=!1,r=e.messages.nonUser.flatMap(e=>e.content),a=r.slice(m);m=r.length;let s={content:a,usage:e.output.usage||{inputTokens:0,outputTokens:0,totalTokens:0},finishReason:e.stepResult?.reason||"unknown",warnings:e.stepResult?.warnings||[],request:e.metadata?.request||{},response:{...e.metadata,modelId:e.metadata?.modelId||e.metadata?.model||"",messages:[]},text:e.output.text||"",reasoning:e.output.reasoning||[],reasoningText:e.output.reasoningText||"",files:e.output.files||[],toolCalls:e.output.toolCalls||[],toolResults:e.output.toolResults||[],sources:e.output.sources||[],staticToolCalls:e.output.staticToolCalls||[],dynamicToolCalls:e.output.dynamicToolCalls||[],staticToolResults:e.output.staticToolResults||[],dynamicToolResults:e.output.dynamicToolResults||[],providerMetadata:e.metadata?.providerMetadata};c.push(s),d.stopWhen&&e.stepResult?.isContinued&&c.length>0&&(t=(await Promise.all((Array.isArray(d.stopWhen)?d.stopWhen:[d.stopWhen]).map(e=>e({steps:c})))).some(e=>e)),e.stepResult&&(e.stepResult.isContinued=!t&&e.stepResult.isContinued);let i=(e.output?.steps?.length??0)>0;return(e.stepResult?.reason!=="tripwire"||i)&&kH(u)&&u.enqueue({type:"step-finish",runId:n,from:"AGENT",payload:e}),void 0!==e.stepResult?.reason&&(e.stepResult?.isContinued??!1)}).commit()}({resumeContext:t,messageId:o,models:a,_internal:i,modelSettings:n,toolChoice:s,controller:f,outputWriter:y,runId:l,messageList:u,startTimestamp:p,streamState:d,agentId:c,requireToolApproval:r,toolCallConcurrency:g,...h});h.mastra&&v.__registerMastra(h.mastra);let b={messageId:o,messages:{all:u.get.all.aiV5.model(),user:u.get.input.aiV5.model(),nonUser:[]},output:{steps:[],usage:{inputTokens:0,outputTokens:0,totalTokens:0}},metadata:{},stepResult:{reason:"undefined",warnings:[],isContinued:!0,totalUsage:{inputTokens:0,outputTokens:0,totalTokens:0}}};t||f.enqueue({type:"start",runId:l,from:"AGENT",payload:{id:c,messageId:o}});let w=await v.createRun({runId:l}),k=new c_;r&&k.set("__mastra_requireToolApproval",!0);let _=t?await w.resume({resumeData:t.resumeData,tracingContext:h.modelSpanTracker?.getTracingContext(),label:m}):await w.start({inputData:b,tracingContext:h.modelSpanTracker?.getTracingContext(),requestContext:k});if("success"!==_.status){if("failed"===_.status){let e=(0,eN.getErrorFromUnknown)(_.error,{fallbackMessage:"Unknown error in agent workflow stream"});f.enqueue({type:"error",runId:l,from:"AGENT",payload:{error:e}}),h.options?.onError&&await h.options?.onError?.({error:e})}"suspended"!==_.status&&await v.deleteWorkflowRunById(l),f.close();return}await v.deleteWorkflowRunById(l),f.enqueue({type:"finish",runId:l,from:"AGENT",payload:{..._.result,stepResult:{..._.result.stepResult,reason:_.result.stepResult.reason}}}),f.close()}})}(T),O=f.modelSpanTracker?.wrapStream(A)??A;return y=new wB({model:{modelId:w.model.modelId,provider:w.model.provider,version:w.model.specificationVersion},stream:O,messageList:i,messageId:S,options:{runId:k,toolCallStreaming:f.toolCallStreaming,onFinish:f.options?.onFinish,onStepFinish:f.options?.onStepFinish,includeRawChunks:!!o,structuredOutput:f.structuredOutput,outputProcessors:d,returnScorerData:c,tracingContext:f.modelSpanTracker?.getTracingContext(),requestContext:f.requestContext},initialState:v}),new Proxy(y,{get(e,t,r){let a=Reflect.get(e,t,e);return"function"==typeof a?a.bind(e):a}})}(a)}catch(t){let e=new eN.MastraError({id:"LLM_STREAM_TEXT_AI_SDK_EXECUTION_FAILED",domain:"LLM",category:"THIRD_PARTY",details:{modelId:M.modelId,modelProvider:M.provider,runId:r??"unknown",threadId:l??"unknown",resourceId:u??"unknown"}},t);throw R?.reportGenerationError({error:e}),e}}},k7=eF.enum(["agent","workflow","none","tool"]);async function k9({requestContext:e,agent:t,routingConfig:r}){let a=await t.getInstructions({requestContext:e}),s=await t.listAgents({requestContext:e}),n=await t.listWorkflows({requestContext:e}),i=await t.listTools({requestContext:e}),o=await t.getModel({requestContext:e}),l=await t.getMemory({requestContext:e}),u=Object.entries(s).map(([e,t])=>` - **${e}**: ${t.getDescription()}`).join("\n"),p=Object.entries(n).map(([e,t])=>` - **${e}**: ${t.description}, input schema: ${JSON.stringify(mh(t.inputSchema??eF.object({})))}`).join("\n"),d=await l?.listTools?.(),c=Object.entries({...i,...d}).map(([e,t])=>{let r="inputSchema"in t?t.inputSchema??eF.object({}):eF.object({});return` - **${e}**: ${t.description}, input schema: ${JSON.stringify(mh(r))}`}).join("\n"),m=r?.additionalInstructions?`
## Additional Instructions
${r.additionalInstructions}`:"";return new _g({id:"routing-agent",name:"Routing Agent",instructions:`
          You are a router in a network of specialized AI agents.
          Your job is to decide which agent should handle each step of a task.
          If asking for completion of a task, make sure to follow system instructions closely.

          Every step will result in a prompt message. It will be a JSON object with a "selectionReason" and "finalResult" property. Make your decision based on previous decision history, as well as the overall task criteria. If you already called a primitive, you shouldn't need to call it again, unless you strongly believe it adds something to the task completion criteria. Make sure to call enough primitives to complete the task.

          ## System Instructions
          ${a}
          You can only pick agents and workflows that are available in the lists below. Never call any agents or workflows that are not available in the lists below.
          ## Available Agents in Network
          ${u}
          ## Available Workflows in Network (make sure to use inputs corresponding to the input schema when calling a workflow)
          ${p}
          ## Available Tools in Network (make sure to use inputs corresponding to the input schema when calling a tool)
          ${c}
          If you have multiple entries that need to be called with a workflow or agent, call them separately with each input.
          When calling a workflow, the prompt should be a JSON value that corresponds to the input schema of the workflow. The JSON value is stringified.
          When calling a tool, the prompt should be a JSON value that corresponds to the input schema of the tool. The JSON value is stringified.
          When calling an agent, the prompt should be a text value, like you would call an LLM in a chat interface.
          Keep in mind that the user only sees the final result of the task. When reviewing completion, you should know that the user will not see the intermediate results.
          ${m}
        `,model:o,memory:l,_agentNetworkAppend:!0})}async function k8({threadId:e,resourceId:t,messages:r,routingAgent:a,requestContext:s,generateId:n,tracingContext:i,memoryConfig:o}){let l,u=await a.getMemory({requestContext:s}),p=await u?.getThreadById({threadId:e});p||(p=await u?.createThread({threadId:e,title:`New Thread ${new Date().toISOString()}`,resourceId:t}));let d=[];if("string"==typeof r)l=r,u&&d.push(u.saveMessages({messages:[{id:n({idType:"message",source:"agent",threadId:p?.id,resourceId:p?.resourceId,role:"user"}),type:"text",role:"user",content:{parts:[{type:"text",text:r}],format:2},createdAt:new Date,threadId:p?.id,resourceId:p?.resourceId}]}));else{let e=new pZ({threadId:p?.id,resourceId:p?.resourceId});e.add(r,"user");let t=e.get.all.db();u&&d.push(u.saveMessages({messages:t}));let s=e.get.all.ui(),n=a.getMostRecentUserMessage(s);l=n?.content}if(p&&u){let e=u.getMergedThreadConfig(o||{}),{shouldGenerate:t,model:r,instructions:n}=a.resolveTitleGenerationConfig(e?.generateTitle);t&&l&&0===(await u.recall({threadId:p.id,resourceId:p.resourceId})).messages.filter(e=>"user"===e.role).length&&d.push(a.genTitle(l,s,i||{currentSpan:void 0},r,n).then(e=>{if(e)return u.createThread({threadId:p.id,resourceId:p.resourceId,memoryConfig:o,title:e,metadata:p.metadata})}))}return await Promise.all(d),{thread:p}}async function _e({memory:e,finalResult:t,threadId:r,resourceId:a,generateId:s}){e&&t&&await e.saveMessages({messages:[{id:s(),type:"text",role:"assistant",content:{parts:[{type:"text",text:t}],format:2},createdAt:new Date,threadId:r,resourceId:a}]})}async function _t({networkName:e,requestContext:t,runId:r,agent:a,generateId:s,routingAgentOptions:n,routing:i}){let o=kj({id:"routing-agent-step",inputSchema:eF.object({task:eF.string(),primitiveId:eF.string(),primitiveType:k7,result:eF.string().optional(),iteration:eF.number(),threadId:eF.string().optional(),threadResourceId:eF.string().optional(),isOneOff:eF.boolean(),verboseIntrospection:eF.boolean()}),outputSchema:eF.object({task:eF.string(),primitiveId:eF.string(),primitiveType:k7,prompt:eF.string(),result:eF.string(),isComplete:eF.boolean().optional(),selectionReason:eF.string(),iteration:eF.number(),conversationContext:eF.array(eF.any()).optional()}),execute:async({inputData:o,getInitData:l,writer:u})=>{let p=await l(),d=await k9({requestContext:t,agent:a,routingConfig:i}),c=(o.iteration??-1)+1,m=s({idType:"step",source:"agent",stepType:"routing-agent"});await u.write({type:"routing-agent-start",payload:{networkId:a.id,agentId:d.id,runId:m,inputData:{...o,iteration:c}},runId:r,from:"NETWORK"});let g=[{role:"assistant",content:`
                    ${o.isOneOff?"You are executing just one primitive based on the user task. Make sure to pick the primitive that is the best suited to accomplish the whole task. Primitives that execute only part of the task should be avoided.":"You will be calling just *one* primitive at a time to accomplish the user task, every call to you is one decision in the process of accomplishing the user task. Make sure to pick primitives that are the best suited to accomplish the whole task. Completeness is the highest priority."}

                    The user has given you the following task:
                    ${o.task}

                    # Rules:

                    ## Agent:
                    - prompt should be a text value, like you would call an LLM in a chat interface.
                    - If you are calling the same agent again, make sure to adjust the prompt to be more specific.

                    ## Workflow/Tool:
                    - prompt should be a JSON value that corresponds to the input schema of the workflow or tool. The JSON value is stringified.
                    - Make sure to use inputs corresponding to the input schema when calling a workflow or tool.

                    DO NOT CALL THE PRIMITIVE YOURSELF. Make sure to not call the same primitive twice, unless you call it with different arguments and believe it adds something to the task completion criteria. Take into account previous decision making history and results in your decision making and final result. These are messages whose text is a JSON structure with "isNetwork" true.

                    Please select the most appropriate primitive to handle this task and the prompt to be sent to the primitive. If no primitive is appropriate, return "none" for the primitiveId and "none" for the primitiveType.

                    {
                        "primitiveId": string,
                        "primitiveType": "agent" | "workflow" | "tool",
                        "prompt": string,
                        "selectionReason": string
                    }

                    The 'selectionReason' property should explain why you picked the primitive${o.verboseIntrospection?", as well as why the other primitives were not picked.":"."}
                    `}],h={structuredOutput:{schema:eF.object({primitiveId:eF.string().describe("The id of the primitive to be called"),primitiveType:k7.describe("The type of the primitive to be called"),prompt:eF.string().describe("The json string or text value to be sent to the primitive"),selectionReason:eF.string().describe("The reason you picked the primitive")})},requestContext:t,maxSteps:1,memory:{thread:p?.threadId??r,resource:p?.threadResourceId??e,options:{readOnly:!0,workingMemory:{enabled:!1}}},...n},f=await wj(d,g,h),y=await f.object;if(!y)throw new eN.MastraError({id:"AGENT_NETWORK_ROUTING_AGENT_INVALID_OUTPUT",domain:"AGENT_NETWORK",category:"SYSTEM",text:"Routing agent returned undefined for 'object'. This may indicate an issue with the model's response or structured output parsing.",details:{finishReason:f.finishReason??null,usage:JSON.stringify(f.usage)??null}});let v="none"===y.primitiveId&&"none"===y.primitiveType;v&&y.selectionReason&&(await u.write({type:"routing-agent-text-start",payload:{runId:m},from:"NETWORK",runId:r}),await u.write({type:"routing-agent-text-delta",payload:{runId:m,text:y.selectionReason},from:"NETWORK",runId:r}));let b=(f.rememberedMessages??[]).filter(e=>{if("user"===e.role)return!0;if("assistant"===e.role){for(let t of e.content?.parts??[])if(t?.type==="text"&&t?.text)try{let e=JSON.parse(t.text);if(e.isNetwork||e.primitiveId&&e.selectionReason)return!1}catch{}return!0}return!1}),w={task:o.task,result:v?y.selectionReason:"",primitiveId:y.primitiveId,primitiveType:y.primitiveType,prompt:y.prompt,isComplete:v,selectionReason:y.selectionReason,iteration:c,runId:m,conversationContext:b};return await u.write({type:"routing-agent-end",payload:{...w,usage:f.usage},from:"NETWORK",runId:r}),w}}),l=kj({id:"agent-execution-step",inputSchema:eF.object({task:eF.string(),primitiveId:eF.string(),primitiveType:k7,prompt:eF.string(),result:eF.string(),isComplete:eF.boolean().optional(),selectionReason:eF.string(),iteration:eF.number(),conversationContext:eF.array(eF.any()).optional()}),outputSchema:eF.object({task:eF.string(),primitiveId:eF.string(),primitiveType:k7,result:eF.string(),isComplete:eF.boolean().optional(),iteration:eF.number()}),execute:async({inputData:n,writer:i,getInitData:o,suspend:l,resumeData:u})=>{let p,d,c=(await a.listAgents({requestContext:t}))[n.primitiveId];if(!c)throw new eN.MastraError({id:"AGENT_NETWORK_AGENT_EXECUTION_STEP_INVALID_TASK_INPUT",domain:"AGENT_NETWORK",category:"USER",text:`Agent ${n.primitiveId} not found`});let m=c.id,g=s({idType:"step",source:"agent",entityId:m,stepType:"agent-execution"});await i.write({type:"agent-execution-start",payload:{agentId:m,args:n,runId:g},from:"NETWORK",runId:r});let h=await o(),f=h?.threadId||r,y=h?.threadResourceId||e,v=[...n.conversationContext??[],{role:"user",content:n.prompt}],b=await (u?c.resumeStream(u,{requestContext:t,runId:r,memory:{thread:f,resource:y,options:{lastMessages:0}}}):c.stream(v,{requestContext:t,runId:r,memory:{thread:f,resource:y,options:{lastMessages:0}}})),w=!1;for await(let e of b.fullStream)await i.write({type:`agent-execution-event-${e.type}`,payload:{...e,runId:g},from:"NETWORK",runId:r}),"tool-call-approval"===e.type&&(p={...p??{},[n.primitiveId]:{resumeSchema:e.payload.resumeSchema,args:{prompt:n.prompt},toolName:n.primitiveId,toolCallId:n.primitiveId,runId:r,type:"approval",primitiveType:"agent",primitiveId:n.primitiveId}}),"tool-call-suspended"===e.type&&(d={...d??{},[n.primitiveId]:{suspendPayload:e.payload.suspendPayload,resumeSchema:e.payload.resumeSchema,toolName:n.primitiveId,toolCallId:n.primitiveId,args:{prompt:n.prompt},runId:r,type:"suspension",primitiveType:"agent",primitiveId:n.primitiveId}}),"tool-result"===e.type&&"Tool call was not approved by the user"===e.payload.result&&(w=!0);let k=await a.getMemory({requestContext:t}),_=b.messageList.get.all.v1(),I=await b.text;if(w&&(I+="\n\nTool call was not approved by the user"),await k?.saveMessages({messages:[{id:s({idType:"message",source:"agent",entityId:m,threadId:h?.threadId||r,resourceId:h?.threadResourceId||e,role:"assistant"}),type:"text",role:"assistant",content:{parts:[{type:"text",text:JSON.stringify({isNetwork:!0,selectionReason:n.selectionReason,primitiveType:n.primitiveType,primitiveId:n.primitiveId,input:n.prompt,finalResult:{text:I,messages:_}})}],format:2,...p||d?{metadata:{...p?{requireApprovalMetadata:p}:{},...d?{suspendedTools:d}:{}}}:{}},createdAt:new Date,threadId:h?.threadId||r,resourceId:h?.threadResourceId||e}]}),p||d)return await i.write({type:p?"agent-execution-approval":"agent-execution-suspended",payload:{args:{prompt:n.prompt},agentId:m,runId:g,toolName:n.primitiveId,toolCallId:n.primitiveId,usage:await b.usage,selectionReason:n.selectionReason,...p?{resumeSchema:p[n.primitiveId].resumeSchema}:{},...d?{resumeSchema:d[n.primitiveId].resumeSchema,suspendPayload:d[n.primitiveId].suspendPayload}:{}},from:"NETWORK",runId:r}),await l({...p?{requireToolApproval:p[n.primitiveId]}:{},...d?{toolCallSuspended:d[n.primitiveId].suspendPayload,args:n.prompt,agentId:m}:{},runId:g});{let e={task:n.task,agentId:m,result:I,isComplete:!1,iteration:n.iteration,runId:g};return await i.write({type:"agent-execution-end",payload:{...e,usage:await b.usage},from:"NETWORK",runId:r}),{task:n.task,primitiveId:n.primitiveId,primitiveType:n.primitiveType,result:I,isComplete:!1,iteration:n.iteration}}}}),u=kj({id:"workflow-execution-step",inputSchema:eF.object({task:eF.string(),primitiveId:eF.string(),primitiveType:k7,prompt:eF.string(),result:eF.string(),isComplete:eF.boolean().optional(),selectionReason:eF.string(),iteration:eF.number(),conversationContext:eF.array(eF.any()).optional()}),outputSchema:eF.object({task:eF.string(),primitiveId:eF.string(),primitiveType:k7,result:eF.string(),isComplete:eF.boolean().optional(),iteration:eF.number()}),execute:async({inputData:n,writer:i,getInitData:o,suspend:l,resumeData:u,mastra:p})=>{let d,c,m,g=await a.listWorkflows({requestContext:t}),h=n.primitiveId,f=g[h];if(!f)throw new eN.MastraError({id:"AGENT_NETWORK_WORKFLOW_EXECUTION_STEP_INVALID_TASK_INPUT",domain:"AGENT_NETWORK",category:"USER",text:`Workflow ${h} not found`});try{d=JSON.parse(n.prompt)}catch(e){throw new eN.MastraError({id:"WORKFLOW_EXECUTION_STEP_INVALID_TASK_INPUT",domain:"AGENT_NETWORK",category:"USER",text:`Invalid task input: ${n.task}`},e)}let y=s({idType:"step",source:"workflow",entityId:f.id,stepType:"workflow-execution"}),v=await f.createRun({runId:r}),b={workflowId:f.id,args:n,runId:y};await i?.write({type:"workflow-execution-start",payload:b,from:"NETWORK",runId:r});let w=u?v.resumeStream({resumeData:u,requestContext:t}):v.stream({inputData:d,requestContext:t}),k=[];for await(let e of w.fullStream)k.push(e),await i?.write({type:`workflow-execution-event-${e.type}`,payload:{...e,runId:y},from:"NETWORK",runId:r});let _=!0,I=await w.result;if(I?.status&&I?.status!=="failed"||(_=!1),I?.status==="suspended"){let e=I?.suspended?.[0]?.[0];m=I?.steps?.[e]?.suspendPayload,m?.__workflow_meta&&delete m.__workflow_meta;let t=[...I?.suspended?.[0]??[]],r=f;for(;t.length>0;){let e=t.shift();if(e){if(!r.steps[e]){p?.getLogger()?.warn(`Suspended step '${e}' not found in workflow '${h}'`);break}r=r.steps[e]}}let a=r?.resumeSchema;c=a?JSON.stringify(mh(a)):""}let S=JSON.stringify({isNetwork:!0,primitiveType:n.primitiveType,primitiveId:n.primitiveId,selectionReason:n.selectionReason,input:d,finalResult:{runId:v.runId,runResult:I,chunks:k,runSuccess:_}}),x=await a.getMemory({requestContext:t}),T=await o();if(await x?.saveMessages({messages:[{id:s({idType:"message",source:"workflow",entityId:f.id,threadId:T?.threadId||r,resourceId:T?.threadResourceId||e,role:"assistant"}),type:"text",role:"assistant",content:{parts:[{type:"text",text:S}],format:2,...m?{metadata:{suspendedTools:{[n.primitiveId]:{args:d,suspendPayload:m,runId:r,type:"suspension",resumeSchema:c,workflowId:h,primitiveType:"workflow",primitiveId:n.primitiveId,toolName:n.primitiveId,toolCallId:n.primitiveId}}}}:{}},createdAt:new Date,threadId:T?.threadId||r,resourceId:T?.threadResourceId||e}]}),m)return await i?.write({type:"workflow-execution-suspended",payload:{args:d,workflowId:h,suspendPayload:m,resumeSchema:c,name:f.name,runId:y,usage:await w.usage,selectionReason:n.selectionReason,toolName:n.primitiveId,toolCallId:n.primitiveId},from:"NETWORK",runId:r}),l({...b,workflowSuspended:m});{let e={task:n.task,primitiveId:n.primitiveId,primitiveType:n.primitiveType,result:S,isComplete:!1,iteration:n.iteration};return await i?.write({type:"workflow-execution-end",payload:{...e,result:I,name:f.name,runId:y,usage:await w.usage},from:"NETWORK",runId:r}),e}}}),p=kj({id:"tool-execution-step",inputSchema:eF.object({task:eF.string(),primitiveId:eF.string(),primitiveType:k7,prompt:eF.string(),result:eF.string(),isComplete:eF.boolean().optional(),selectionReason:eF.string(),iteration:eF.number(),conversationContext:eF.array(eF.any()).optional()}),outputSchema:eF.object({task:eF.string(),primitiveId:eF.string(),primitiveType:k7,result:eF.string(),isComplete:eF.boolean().optional(),iteration:eF.number()}),resumeSchema:eF.object({approved:eF.boolean().describe("Controls if the tool call is approved or not, should be true when approved and false when declined")}),execute:async({inputData:n,getInitData:i,writer:o,resumeData:l,mastra:u,suspend:p})=>{let d,c,m=await i(),g=u?.getLogger(),h=await a.listTools({requestContext:t}),f=await a.getMemory({requestContext:t}),y=await f?.listTools?.(),v={...h,...y}[n.primitiveId];if(!v)throw new eN.MastraError({id:"AGENT_NETWORK_TOOL_EXECUTION_STEP_INVALID_TASK_INPUT",domain:"AGENT_NETWORK",category:"USER",text:`Tool ${n.primitiveId} not found`});if(!v.execute)throw new eN.MastraError({id:"AGENT_NETWORK_TOOL_EXECUTION_STEP_INVALID_TASK_INPUT",domain:"AGENT_NETWORK",category:"USER",text:`Tool ${n.primitiveId} does not have an execute function`});let b=v.id;try{d=JSON.parse(n.prompt)}catch(e){throw new eN.MastraError({id:"AGENT_NETWORK_TOOL_EXECUTION_STEP_INVALID_TASK_INPUT",domain:"AGENT_NETWORK",category:"USER",text:`Invalid task input: ${n.task}`},e)}let w=s({idType:"step",source:"agent",entityId:b,stepType:"tool-execution"});await o?.write({type:"tool-execution-start",payload:{args:{...n,args:d,toolName:b,toolCallId:w},runId:r},from:"NETWORK",runId:r});let k=v.requireApproval;if(v.needsApprovalFn)try{k=await v.needsApprovalFn(d)}catch(e){g?.error(`Error evaluating needsApprovalFn for tool ${b}:`,e),k=!0}if(k)if(l){if(!l.approved){let t="Tool call was not approved by the user";await f?.saveMessages({messages:[{id:s(),type:"text",role:"assistant",content:{parts:[{type:"text",text:JSON.stringify({isNetwork:!0,selectionReason:n.selectionReason,primitiveType:n.primitiveType,primitiveId:n.primitiveId,finalResult:{result:t,toolCallId:w},input:d})}],format:2},createdAt:new Date,threadId:m.threadId||r,resourceId:m.threadResourceId||e}]});let a={task:n.task,primitiveId:n.primitiveId,primitiveType:n.primitiveType,result:t,isComplete:!1,iteration:n.iteration,toolCallId:w,toolName:b};return await o?.write({type:"tool-execution-end",payload:a,from:"NETWORK",runId:r}),a}}else{let t=JSON.stringify(mh(eF.object({approved:eF.boolean().describe("Controls if the tool call is approved or not, should be true when approved and false when declined")})));return await f?.saveMessages({messages:[{id:s(),type:"text",role:"assistant",content:{parts:[{type:"text",text:JSON.stringify({isNetwork:!0,selectionReason:n.selectionReason,primitiveType:n.primitiveType,primitiveId:n.primitiveId,finalResult:{result:"",toolCallId:w},input:d})}],format:2,metadata:{mode:"network",requireApprovalMetadata:{[n.primitiveId]:{toolCallId:w,toolName:n.primitiveId,args:d,type:"approval",resumeSchema:t,runId:r,primitiveType:"tool",primitiveId:n.primitiveId}}}},createdAt:new Date,threadId:m.threadId||r,resourceId:m.threadResourceId||e}]}),await o?.write({type:"tool-execution-approval",payload:{toolName:n.primitiveId,toolCallId:w,args:d,selectionReason:n.selectionReason,resumeSchema:t,runId:r}}),p({requireToolApproval:{toolName:n.primitiveId,args:d,toolCallId:w}})}let _=await v.execute(d,{requestContext:t,mastra:a.getMastraInstance(),agent:{resourceId:m.threadResourceId||e,toolCallId:w,threadId:m.threadId,suspend:async(t,a)=>{await f?.saveMessages({messages:[{id:s(),type:"text",role:"assistant",content:{parts:[{type:"text",text:JSON.stringify({isNetwork:!0,selectionReason:n.selectionReason,primitiveType:n.primitiveType,primitiveId:b,finalResult:{result:"",toolCallId:w},input:d})}],format:2,metadata:{mode:"network",suspendedTools:{[n.primitiveId]:{toolCallId:w,toolName:n.primitiveId,args:d,suspendPayload:t,type:"suspension",resumeSchema:a?.resumeSchema??JSON.stringify(mh(v.resumeSchema)),runId:r,primitiveType:"tool",primitiveId:n.primitiveId}}}},createdAt:new Date,threadId:m.threadId||r,resourceId:m.threadResourceId||e}]}),await o?.write({type:"tool-execution-suspended",payload:{toolName:n.primitiveId,toolCallId:w,args:d,resumeSchema:a?.resumeSchema??JSON.stringify(mh(v.resumeSchema)),suspendPayload:t,runId:r,selectionReason:n.selectionReason}}),c=t},resumeData:l},runId:r,memory:f,context:d,tracingContext:{currentSpan:void 0},writer:o},{toolCallId:w,messages:[]});if(c)return await p({toolCallSuspended:c,toolName:n.primitiveId,args:d,toolCallId:w});await f?.saveMessages({messages:[{id:s({idType:"message",source:"agent",entityId:b,threadId:m.threadId,resourceId:m.threadResourceId||e,role:"assistant"}),type:"text",role:"assistant",content:{parts:[{type:"text",text:JSON.stringify({isNetwork:!0,selectionReason:n.selectionReason,primitiveType:n.primitiveType,primitiveId:b,finalResult:{result:_,toolCallId:w},input:d})}],format:2},createdAt:new Date,threadId:m.threadId||r,resourceId:m.threadResourceId||e}]});let I={task:n.task,primitiveId:n.primitiveId,primitiveType:n.primitiveType,result:_,isComplete:!1,iteration:n.iteration,toolCallId:w,toolName:b};return await o?.write({type:"tool-execution-end",payload:I,from:"NETWORK",runId:r}),I}}),d=kj({id:"finish-step",inputSchema:eF.object({task:eF.string(),primitiveId:eF.string(),primitiveType:k7,prompt:eF.string(),result:eF.string(),isComplete:eF.boolean().optional(),selectionReason:eF.string(),iteration:eF.number(),conversationContext:eF.array(eF.any()).optional()}),outputSchema:eF.object({task:eF.string(),result:eF.string(),isComplete:eF.boolean(),iteration:eF.number()}),execute:async({inputData:e,writer:t})=>{let a=e.result;"none"!==e.primitiveId||"none"!==e.primitiveType||e.result||(a=e.selectionReason);let s={task:e.task,result:a,isComplete:!!e.isComplete,iteration:e.iteration,runId:r};return await t?.write({type:"network-execution-event-step-finish",payload:s,from:"NETWORK",runId:r}),s}}),c=kL({id:"Agent-Network-Outer-Workflow",inputSchema:eF.object({task:eF.string(),primitiveId:eF.string(),primitiveType:k7,result:eF.string().optional(),iteration:eF.number(),threadId:eF.string().optional(),threadResourceId:eF.string().optional(),isOneOff:eF.boolean(),verboseIntrospection:eF.boolean()}),outputSchema:eF.object({task:eF.string(),primitiveId:eF.string(),primitiveType:k7,prompt:eF.string(),result:eF.string(),isComplete:eF.boolean().optional(),completionReason:eF.string().optional(),iteration:eF.number(),threadId:eF.string().optional(),threadResourceId:eF.string().optional(),isOneOff:eF.boolean()}),options:{shouldPersistSnapshot:({workflowStatus:e})=>"suspended"===e,validateInputs:!1}});return c.then(o).branch([[async({inputData:e})=>!e.isComplete&&"agent"===e.primitiveType,l],[async({inputData:e})=>!e.isComplete&&"workflow"===e.primitiveType,u],[async({inputData:e})=>!e.isComplete&&"tool"===e.primitiveType,p],[async({inputData:e})=>!!e.isComplete,d]]).map({task:{step:[o,l,u,p],path:"task"},isComplete:{step:[l,u,p,d],path:"isComplete"},completionReason:{step:[o,l,u,p,d],path:"completionReason"},result:{step:[l,u,p,d],path:"result"},primitiveId:{step:[o,l,u,p],path:"primitiveId"},primitiveType:{step:[o,l,u,p],path:"primitiveType"},iteration:{step:[o,l,u,p],path:"iteration"},isOneOff:{initData:c,path:"isOneOff"},threadId:{initData:c,path:"threadId"},threadResourceId:{initData:c,path:"threadResourceId"}}).commit(),{networkWorkflow:c}}async function _r({networkName:e,requestContext:t,runId:r,routingAgent:a,routingAgentOptions:s,generateId:n,maxIterations:i,threadId:o,resourceId:l,messages:u,validation:p,routing:d,onIterationComplete:c,resumeData:m,autoResumeSuspendedTools:g,mastra:h,structuredOutput:f}){let y,v;if(!await a.getMemory({requestContext:t}))throw new eN.MastraError({id:"AGENT_NETWORK_MEMORY_REQUIRED",domain:"AGENT_NETWORK",category:"USER",text:"Memory is required for the agent network to function properly. Please configure memory for the agent.",details:{status:400}});let b=function(e){let t="";if("string"==typeof e)t=e;else{let r=Array.isArray(e)?e[e.length-1]:e;if("string"==typeof r)t=r;else if(r&&"content"in r&&r?.content){let e=r.content;if("string"==typeof e)t=e;else if(Array.isArray(e)){let r=e[e.length-1];r?.type==="text"&&(t=r.text)}}else if(r&&"parts"in r&&r?.parts){let e=r.parts;if(Array.isArray(e)){let r=e[e.length-1];r?.type==="text"&&r?.text&&(t=r.text)}}}return t}(u);if(g&&o){let r,n,i,u=await a.getMemory({requestContext:t});if(await u?.getThreadById({threadId:o})){let p=await u?.recall({threadId:o,resourceId:l||e});if(p&&p.messages?.length>0&&(r=([...p.messages].reverse()?.filter(e=>"assistant"===e.role))[0]),r){let{metadata:e}=r.content;if(e?.requireApprovalMetadata&&(n=e.requireApprovalMetadata),e?.suspendedTools&&(i=e.suspendedTools),n||i){let e=Object.values({...i,...n})[0];if(e.resumeSchema)try{let r=await a.getLLM({requestContext:t}),n=`
            You are an assistant used to resume a suspended tool call.
            Your job is to construct the resumeData for the tool call using the messages available to you and the schema passed.
            You will generate an object that matches this schema: ${e.resumeSchema}.
            The resumeData generated should be a JSON value that is constructed from the messages, using the schema as guide. The JSON value is stringified.

            {
              "resumeData": "string"
            }
          `,i=new pZ;i.addSystem(n),i.add(b,"user");let o=r.stream({methodType:"generate",requestContext:t,messageList:i,agentId:a.id,tracingContext:s?.tracingContext,structuredOutput:{schema:eF.object({resumeData:eF.string()})}}),l=await o.object,u=JSON.parse(l.resumeData);Object.keys(u).length>0&&(y=u,v=e.runId)}catch(e){h?.getLogger()?.error(`Error generating resume data for network agent ${a.id}`,e)}}}}}let w=v??r,k=y??m,{memory:_,...I}=s||{},{networkWorkflow:S}=await _t({networkName:e,requestContext:t,runId:w,agent:a,routingAgentOptions:I,generateId:n,routing:d}),x=kj({id:"validation-step",inputSchema:S.outputSchema,outputSchema:eF.object({task:eF.string(),primitiveId:eF.string(),primitiveType:k7,prompt:eF.string(),result:eF.string(),structuredObject:eF.any().optional(),isComplete:eF.boolean().optional(),completionReason:eF.string().optional(),iteration:eF.number(),validationPassed:eF.boolean().optional(),validationFeedback:eF.string().optional()}),execute:async({inputData:s,writer:o})=>{let l,u,m,g=p?.scorers||[],h=await a.getMemory({requestContext:t}),y=h?await h.recall({threadId:s.threadId||w}):{messages:[]},v={iteration:s.iteration,maxIterations:i,messages:y.messages,originalTask:s.task,selectedPrimitive:{id:s.primitiveId,type:s.primitiveType},primitivePrompt:s.prompt,primitiveResult:s.result,networkName:e,runId:w,threadId:s.threadId,resourceId:s.threadResourceId,customContext:t?.toJSON?.()},b=g.length>0;if(await o?.write({type:"network-validation-start",payload:{runId:w,iteration:s.iteration,checksCount:b?g.length:1},from:"NETWORK",runId:r}),b){if((l=await k0({...p,scorers:g},v)).complete){let r=await k9({requestContext:t,agent:a,routingConfig:d});if(f?.schema){let e=await k4(r,v,f,{writer:o,stepId:n(),runId:w});u=e.text,m=e.object}else u=await k5(r,v,{writer:o,stepId:n(),runId:w});await _e({memory:await a.getMemory({requestContext:t}),finalResult:u,threadId:s.threadId||w,resourceId:s.threadResourceId||e,generateId:n})}}else{let i=await k9({requestContext:t,agent:a,routingConfig:d}),p=await k2(i,v,{writer:o,stepId:n(),runId:w});if(l={complete:p.passed,completionReason:p.reason,scorers:[p],totalDuration:p.duration,timedOut:!1},u=p.finalResult,p.passed&&f?.schema){let e=await k4(i,v,f,{writer:o,stepId:n(),runId:r});e.text&&(u=e.text),m=e.object}p.passed&&await _e({memory:await a.getMemory({requestContext:t}),finalResult:u||p.finalResult,threadId:s.threadId||w,resourceId:s.threadResourceId||e,generateId:n})}let k=i&&s.iteration>=i;await o?.write({type:"network-validation-end",payload:{runId:r,iteration:s.iteration,passed:l.complete,results:l.scorers,duration:l.totalDuration,timedOut:l.timedOut,reason:l.completionReason,maxIterationReached:!!k},from:"NETWORK",runId:w});let _=l.complete;c&&await c({iteration:s.iteration,primitiveId:s.primitiveId,primitiveType:s.primitiveType,result:s.result,isComplete:_});let I=function(e,t){let r=[];for(let t of(r.push("#### Completion Check Results"),r.push(""),r.push(`Overall: ${e.complete?" COMPLETE":" NOT COMPLETE"}`),r.push(`Duration: ${e.totalDuration}ms`),e.timedOut&&r.push(" Scoring timed out"),r.push(""),e.scorers))r.push(`###### ${t.scorerName} (${t.scorerId})`),r.push(`Score: ${t.score} ${t.passed?"":""}`),t.reason&&r.push(`Reason: ${t.reason}`),r.push("");return e.complete?r.push("\n\n The task is complete."):t?r.push("\n\n Max iterations reached."):r.push("\n\n Will continue working on the task."),r.join("\n")}(l,!!k),S=await a.getMemory({requestContext:t});return(S&&await S.saveMessages({messages:[{id:n(),type:"text",role:"assistant",content:{parts:[{type:"text",text:I}],format:2,metadata:{mode:"network",completionResult:{passed:l.complete}}},createdAt:new Date,threadId:s.threadId||w,resourceId:s.threadResourceId||e}]}),_)?{...s,...u?{result:u}:{},...void 0!==m?{structuredObject:m}:{},isComplete:!0,validationPassed:!0,completionReason:l.completionReason||"Task complete"}:{...s,isComplete:!1,validationPassed:!1,validationFeedback:I}}}),T=kj({id:"final-step",inputSchema:eF.object({task:eF.string(),primitiveId:eF.string(),primitiveType:k7,prompt:eF.string(),result:eF.string(),structuredObject:eF.any().optional(),isComplete:eF.boolean().optional(),completionReason:eF.string().optional(),iteration:eF.number(),validationPassed:eF.boolean().optional(),validationFeedback:eF.string().optional()}),outputSchema:eF.object({task:eF.string(),primitiveId:eF.string(),primitiveType:k7,prompt:eF.string(),result:eF.string(),object:eF.any().optional(),isComplete:eF.boolean().optional(),completionReason:eF.string().optional(),iteration:eF.number(),validationPassed:eF.boolean().optional()}),execute:async({inputData:e,writer:t})=>{let{structuredObject:r,...a}=e,s={...a,...void 0!==r?{object:r}:{},...i&&e.iteration>=i?{completionReason:`Max iterations reached: ${i}`}:{}};return await t?.write({type:"network-execution-event-finish",payload:s,from:"NETWORK",runId:w}),s}}),E=kL({id:"iteration-with-validation",inputSchema:S.inputSchema,outputSchema:x.outputSchema,options:{shouldPersistSnapshot:({workflowStatus:e})=>"suspended"===e,validateInputs:!1}}).then(S).then(x).commit(),A=kL({id:"agent-loop-main-workflow",inputSchema:eF.object({iteration:eF.number(),task:eF.string(),primitiveId:eF.string(),primitiveType:k7,result:eF.string().optional(),threadId:eF.string().optional(),threadResourceId:eF.string().optional(),isOneOff:eF.boolean(),verboseIntrospection:eF.boolean()}),outputSchema:eF.object({task:eF.string(),primitiveId:eF.string(),primitiveType:k7,prompt:eF.string(),result:eF.string(),isComplete:eF.boolean().optional(),completionReason:eF.string().optional(),iteration:eF.number(),validationPassed:eF.boolean().optional()}),options:{shouldPersistSnapshot:({workflowStatus:e})=>"suspended"===e,validateInputs:!1}}).dountil(E,async({inputData:e})=>{let t=!0===e.isComplete,r=!1!==e.validationPassed,a=!!(i&&e.iteration>=i);return t&&r||a}).then(T).commit(),O=a.getMastraInstance();O&&(A.__registerMastra(O),S.__registerMastra(O));let z=await A.createRun({runId:w}),{thread:M}=await k8({requestContext:t,threadId:o||z.runId,resourceId:l||e,messages:u,routingAgent:a,generateId:n,tracingContext:s?.tracingContext,memoryConfig:_?.options});return new wE({run:z,createStream:()=>k?z.resumeStream({resumeData:k}).fullStream:z.stream({inputData:{task:b,primitiveId:"",primitiveType:"none",iteration:-1,threadResourceId:M?.resourceId,threadId:M?.id,isOneOff:!1,verboseIntrospection:!0}}).fullStream})}var _a=(0,sm.__toESM)(wx(),1),_s=class{constructor(e){this.capabilities=e}__primitive({instructions:e,messages:t,context:r,thread:a,memoryConfig:s,resourceId:n,runId:i,toolsets:o,clientTools:l,requestContext:u,writableStream:p,methodType:d,tracingContext:c,tracingOptions:m}){return{before:async()=>{let g;this.capabilities.logger.debug(`[Agents:${this.capabilities.name}] - Starting generation`,{runId:i});let h=pQ({type:"agent_run",name:`agent run: '${this.capabilities.id}'`,entityType:"agent",entityId:this.capabilities.id,entityName:this.capabilities.name,input:{messages:t},attributes:{instructions:this.capabilities.convertInstructionsToString(e),availableTools:[...o?Object.keys(o):[],...l?Object.keys(l):[]]},metadata:{runId:i,resourceId:n,threadId:a?a.id:void 0},tracingPolicy:this.capabilities.tracingPolicy,tracingOptions:m,tracingContext:c,requestContext:u,mastra:this.capabilities.mastra}),f={currentSpan:h},y=await this.capabilities.getMemory({requestContext:u}),v=[o&&Object.keys(o||{}).length>0?`toolsets present (${Object.keys(o||{}).length} tools)`:void 0,y&&n?"memory and resourceId available":void 0].filter(Boolean).join(", ");this.capabilities.logger.debug(`[Agent:${this.capabilities.name}] - Enhancing tools: ${v}`,{runId:i,toolsets:o?Object.keys(o):void 0,clientTools:l?Object.keys(l):void 0,hasMemory:!!y,hasResourceId:!!n});let b=a?.id,w=await this.capabilities.convertTools({toolsets:o,clientTools:l,threadId:b,resourceId:n,runId:i,requestContext:u,tracingContext:f,writableStream:p,methodType:"generate"===d?"generateLegacy":"streamLegacy",memoryConfig:s}),k=new pZ({threadId:b,resourceId:n,generateMessageId:this.capabilities.mastra?.generateId?.bind(this.capabilities.mastra),_agentNetworkAppend:this.capabilities._agentNetworkAppend}).addSystem(e||await this.capabilities.getInstructions({requestContext:u})).add(r||[],"context");if(!y||!b&&!n){k.add(t,"user");let{tripwire:e}=await this.capabilities.__runInputProcessors({requestContext:u,tracingContext:f,messageList:k});return{messageObjects:e?[]:k.get.all.prompt(),convertedTools:w,threadExists:!1,thread:void 0,messageList:k,agentSpan:h,tripwire:e}}if(!b||!n){let e=new eN.MastraError({id:"AGENT_MEMORY_MISSING_RESOURCE_ID",domain:"AGENT",category:"USER",details:{agentName:this.capabilities.name,threadId:b||"",resourceId:n||""},text:`A resourceId and a threadId must be provided when using Memory. Saw threadId "${b}" and resourceId "${n}"`});throw this.capabilities.logger.trackException(e),this.capabilities.logger.error(e.toString()),h?.error({error:e}),e}let _=y.constructor.name;this.capabilities.logger.debug(`[Agent:${this.capabilities.name}] - Memory persistence enabled: store=${_}, resourceId=${n}`,{runId:i,resourceId:n,threadId:b,memoryStore:_});let I=await y.getThreadById({threadId:b});g=I?!I.metadata&&a.metadata||a.metadata&&!(0,_a.default)(I.metadata,a.metadata)?await y.saveThread({thread:{...I,metadata:a.metadata},memoryConfig:s}):I:await y.createThread({threadId:b,metadata:a.metadata,title:a.title,memoryConfig:s,resourceId:n,saveThread:!1}),u.set("MastraMemory",{thread:g,resourceId:n,memoryConfig:s}),k.add(t,"user");let{messageList:S,tripwire:x}=await this.capabilities.__runInputProcessors({requestContext:u,tracingContext:f,messageList:k}),T=(k=S).get.all.prompt();return{convertedTools:w,thread:g,messageList:k,messageObjects:T,agentSpan:h,tripwire:x,threadExists:!!I}},after:async({result:e,thread:t,threadId:r,memoryConfig:a,outputText:s,runId:i,messageList:o,threadExists:l,structuredOutput:p=!1,overrideScorers:d,agentSpan:c})=>{let m={text:e?.text,object:e?.object,toolResults:e?.toolResults,toolCalls:e?.toolCalls,usage:e?.usage,steps:e?.steps?.map(t=>({stepType:t?.stepType,text:e?.text,object:e?.object,toolResults:e?.toolResults,toolCalls:e?.toolCalls,usage:e?.usage}))};this.capabilities.logger.debug(`[Agent:${this.capabilities.name}] - Post processing LLM response`,{runId:i,result:m,threadId:r});let g=new pZ({threadId:r,resourceId:n,generateMessageId:this.capabilities.mastra?.generateId?.bind(this.capabilities.mastra),_agentNetworkAppend:this.capabilities._agentNetworkAppend}).add(e.response.messages,"response").get.all.core(),h=g?.some(e=>"tool"===e.role&&e?.content?.some(e=>e?.toolName==="updateWorkingMemory")),f=await this.capabilities.getMemory({requestContext:u}),y=h?r?await f?.getThreadById({threadId:r}):void 0:t;if(f&&n&&y)try{let t=e.response.messages;!t&&e.object&&(t=[{role:"assistant",content:[{type:"text",text:s}]}]),t&&o.add(t,"response"),l||await f.createThread({threadId:y.id,metadata:y.metadata,title:y.title,memoryConfig:a,resourceId:y.resourceId});let r=[],i=f.getMergedThreadConfig(a),p=this.capabilities.getMostRecentUserMessage(o.get.all.ui()),{shouldGenerate:d,model:m,instructions:g}=this.capabilities.resolveTitleGenerationConfig(i?.generateTitle),h=o.get.remembered.db().filter(e=>"user"===e.role),v=0===h.length;d&&v&&p&&r.push(this.capabilities.genTitle(p,u,{currentSpan:c},m,g).then(e=>{if(e)return f.createThread({threadId:y.id,resourceId:n,memoryConfig:a,title:e,metadata:y.metadata})})),r.length>0&&await Promise.all(r)}catch(t){if(t instanceof eN.MastraError)throw c?.error({error:t}),t;let e=new eN.MastraError({id:"AGENT_MEMORY_PERSIST_RESPONSE_MESSAGES_FAILED",domain:"AGENT",category:"SYSTEM",details:{agentName:this.capabilities.name,runId:i||"",threadId:r||"",result:JSON.stringify(m)}},t);throw this.capabilities.logger.trackException(e),this.capabilities.logger.error(e.toString()),c?.error({error:e}),e}else{let t=e.response.messages;!t&&e.object&&(t=[{role:"assistant",content:[{type:"text",text:s}]}]),t&&o.add(t,"response")}await this.capabilities.runScorers({messageList:o,runId:i,requestContext:u,structuredOutput:p,overrideScorers:d,threadId:r,resourceId:n,tracingContext:{currentSpan:c}});let v={input:{inputMessages:o.getPersisted.input.ui(),rememberedMessages:o.getPersisted.remembered.ui(),systemMessages:o.getSystemMessages(),taggedSystemMessages:o.getPersisted.taggedSystemMessages},output:o.getPersisted.response.ui()};return c?.end({output:{text:e?.text,object:e?.object,files:e?.files}}),{scoringData:v}}}}async prepareLLMOptions(e,t,r){let a,s,n,{context:i,memoryOptions:o,resourceId:l,maxSteps:u,onStepFinish:p,toolsets:d,clientTools:c,temperature:m,toolChoice:g="auto",requestContext:h=new c_,tracingContext:f,tracingOptions:y,savePerStep:v,writableStream:b,...w}=t,k=h.get(cw),_=h.get(ck),I=_?{id:_}:wN({threadId:w.threadId,memory:w.memory}),S=k||w.memory?.resource||l,x=w.memory?.options||o;S&&I&&!this.capabilities.hasOwnMemory()&&this.capabilities.logger.warn(`[Agent:${this.capabilities.name}] - No memory is configured but resourceId and threadId were passed in args. This will not work.`);let T=w.runId||this.capabilities.mastra?.generateId({idType:"run",source:"agent",entityId:this.capabilities.id,threadId:I?.id,resourceId:S})||(0,cz.randomUUID)(),E=w.instructions||await this.capabilities.getInstructions({requestContext:h}),A=await this.capabilities.getLLM({requestContext:h}),O=await this.capabilities.getMemory({requestContext:h}),{before:z,after:M}=this.__primitive({messages:e,instructions:E,context:i,thread:I,memoryConfig:x,resourceId:S,runId:T,toolsets:d,clientTools:c,requestContext:h,writableStream:b,methodType:r,tracingContext:f,tracingOptions:y});return{llm:A,before:async()=>{let e=await z(),{messageObjects:r,convertedTools:i,agentSpan:o}=e;n=e.threadExists||!1,a=e.messageList,s=e.thread;let l=s?.id;return{...{...t,messages:r,tools:i,runId:T,temperature:m,toolChoice:g,threadId:l,resourceId:S,requestContext:h,onStepFinish:async e=>(v&&(!n&&O&&s&&(await O.createThread({threadId:l,title:s.title,metadata:s.metadata,resourceId:s.resourceId,memoryConfig:x}),n=!0),await this.capabilities.saveStepMessages({result:e,messageList:a,runId:T})),p?.({...e,runId:T})),tripwire:e.tripwire,...w,agentSpan:o},messageList:a,requestContext:h}},after:async({result:e,outputText:t,structuredOutput:r=!1,agentSpan:i,overrideScorers:o})=>await M({result:e,outputText:t,threadId:s?.id,thread:s,memoryConfig:x,runId:T,messageList:a,structuredOutput:r,threadExists:n,agentSpan:i,overrideScorers:o})}}async generateLegacy(e,t={}){if("structuredOutput"in t&&t.structuredOutput)throw new eN.MastraError({id:"AGENT_GENERATE_LEGACY_STRUCTURED_OUTPUT_NOT_SUPPORTED",domain:"AGENT",category:"USER",text:"This method does not support structured output. Please use generate() instead."});let r=await Promise.resolve(this.capabilities.getDefaultGenerateOptionsLegacy({requestContext:t.requestContext})),a={...r,...t,experimental_generateMessageId:r.experimental_generateMessageId||this.capabilities.mastra?.generateId?.bind(this.capabilities.mastra)},{llm:s,before:n,after:i}=await this.prepareLLMOptions(e,a,"generate");if("v1"!==s.getModel().specificationVersion)throw this.capabilities.logger.error("V2 models are not supported for generateLegacy. Please use generate instead.",{modelId:s.getModel().modelId}),new eN.MastraError({id:"AGENT_GENERATE_V2_MODEL_NOT_SUPPORTED",domain:"AGENT",category:"USER",details:{modelId:s.getModel().modelId},text:"V2 models are not supported for generateLegacy. Please use generate instead."});let o=await n(),{messageList:l,requestContext:u}=o,p=o.agentSpan?.externalTraceId;if(o.tripwire)return{text:"",object:void 0,usage:{totalTokens:0,promptTokens:0,completionTokens:0},finishReason:"other",response:{id:(0,cz.randomUUID)(),timestamp:new Date,modelId:"tripwire",messages:[]},responseMessages:[],toolCalls:[],toolResults:[],warnings:void 0,request:{body:JSON.stringify({messages:[]})},experimental_output:void 0,steps:void 0,experimental_providerMetadata:void 0,tripwire:o.tripwire,traceId:p};let{experimental_output:d,output:c,agentSpan:m,...g}=o,h={currentSpan:m},f=a.outputProcessors;if(!c||d){let e=await s.__text({...g,tracingContext:h,experimental_output:d});l.add({role:"assistant",content:[{type:"text",text:e.text}]},"response");let r=await this.capabilities.__runOutputProcessors({requestContext:u||new c_,tracingContext:h,outputProcessorOverrides:f,messageList:l});if(r.tripwire)return{text:"",object:void 0,usage:{totalTokens:0,promptTokens:0,completionTokens:0},finishReason:"other",response:{id:(0,cz.randomUUID)(),timestamp:new Date,modelId:"tripwire",messages:[]},responseMessages:[],toolCalls:[],toolResults:[],warnings:void 0,request:{body:JSON.stringify({messages:[]})},experimental_output:void 0,steps:void 0,experimental_providerMetadata:void 0,tripwire:r.tripwire,traceId:p};let n=r.messageList.get.response.db().map(e=>e.content.parts.map(e=>"text"===e.type?e.text:"").join("")).join("");if(e.text=n,f&&f.length>0){let t=r.messageList.get.response.db();this.capabilities.logger.debug("Checking messages for experimentalOutput metadata:",t.map(e=>({role:e.role,hasContentMetadata:!!e.content.metadata,contentMetadata:e.content.metadata})));let a=t.filter(e=>e.content.metadata&&e.content.metadata.structuredOutput);if(this.capabilities.logger.debug("Messages with structured data:",a.length),a[0]&&a[0].content.metadata?.structuredOutput)e.object=a[0].content.metadata.structuredOutput,this.capabilities.logger.debug("Using structured data from processor metadata for result.object");else try{e.object=JSON.parse(n),this.capabilities.logger.debug("Using fallback JSON parsing for result.object")}catch(e){this.capabilities.logger.warn("Failed to parse processed output as JSON, updating text only",{error:e})}}let o=a.scorers,c=await i({result:e,outputText:n,agentSpan:m,...o?{overrideScorers:o}:{}});return t.returnScorerData&&(e.scoringData=c.scoringData),e.traceId=p,e}let y=await s.__textObject({...g,tracingContext:h,structuredOutput:c}),v=JSON.stringify(y.object);l.add({role:"assistant",content:[{type:"text",text:v}]},"response");let b=await this.capabilities.__runOutputProcessors({requestContext:u||new c_,tracingContext:h,messageList:l});if(b.tripwire)return{text:"",object:void 0,usage:{totalTokens:0,promptTokens:0,completionTokens:0},finishReason:"other",response:{id:(0,cz.randomUUID)(),timestamp:new Date,modelId:"tripwire",messages:[]},responseMessages:[],toolCalls:[],toolResults:[],warnings:void 0,request:{body:JSON.stringify({messages:[]})},experimental_output:void 0,steps:void 0,experimental_providerMetadata:void 0,tripwire:b.tripwire,traceId:p};let w=b.messageList.get.response.db().map(e=>e.content.parts.map(e=>"text"===e.type?e.text:"").join("")).join("");try{y.object=JSON.parse(w)}catch(e){this.capabilities.logger.warn("Failed to parse processed output as JSON, keeping original object",{error:e})}let k=a.scorers,_=await i({result:y,outputText:w,structuredOutput:!0,agentSpan:m,...k?{overrideScorers:k}:{}});return t.returnScorerData&&(y.scoringData=_.scoringData),y.traceId=p,y}async streamLegacy(e,t={}){let r=await Promise.resolve(this.capabilities.getDefaultStreamOptionsLegacy({requestContext:t.requestContext})),a={...r,...t,experimental_generateMessageId:r.experimental_generateMessageId||this.capabilities.mastra?.generateId?.bind(this.capabilities.mastra)},{llm:s,before:n,after:i}=await this.prepareLLMOptions(e,a,"stream");if("v1"!==s.getModel().specificationVersion)throw this.capabilities.logger.error("V2 models are not supported for streamLegacy. Please use stream instead.",{modelId:s.getModel().modelId}),new eN.MastraError({id:"AGENT_STREAM_V2_MODEL_NOT_SUPPORTED",domain:"AGENT",category:"USER",details:{modelId:s.getModel().modelId},text:"V2 models are not supported for streamLegacy. Please use stream instead."});let o=await n(),l=o.agentSpan?.externalTraceId;if(o.tripwire)return{textStream:async function*(){}(),fullStream:Promise.resolve("").then(()=>new globalThis.ReadableStream({start(e){e.close()}})),text:Promise.resolve(""),usage:Promise.resolve({totalTokens:0,promptTokens:0,completionTokens:0}),finishReason:Promise.resolve("other"),tripwire:o.tripwire,response:{id:(0,cz.randomUUID)(),timestamp:new Date,modelId:"tripwire",messages:[]},toolCalls:Promise.resolve([]),toolResults:Promise.resolve([]),warnings:Promise.resolve(void 0),request:{body:JSON.stringify({messages:[]})},experimental_output:void 0,steps:void 0,experimental_providerMetadata:void 0,traceId:l,toAIStream:()=>Promise.resolve("").then(()=>new globalThis.ReadableStream({start(e){e.close()}})),get experimental_partialOutputStream(){return async function*(){}()},pipeDataStreamToResponse:()=>Promise.resolve(),pipeTextStreamToResponse:()=>Promise.resolve(),toDataStreamResponse:()=>new Response("",{status:200,headers:{"Content-Type":"text/plain"}}),toTextStreamResponse:()=>new Response("",{status:200,headers:{"Content-Type":"text/plain"}})};let{onFinish:u,runId:p,output:d,experimental_output:c,agentSpan:m,messageList:g,requestContext:h,...f}=o,y=a.scorers,v={currentSpan:m};if(!d||c){this.capabilities.logger.debug(`Starting agent ${this.capabilities.name} llm stream call`,{runId:p});let e=s.__stream({...f,experimental_output:c,tracingContext:v,requestContext:h,outputProcessors:await this.capabilities.listResolvedOutputProcessors(h),onFinish:async e=>{try{g.add(e.response.messages,"response"),await this.capabilities.__runOutputProcessors({requestContext:h,tracingContext:v,messageList:g});let t=e.text;await i({result:e,outputText:t,agentSpan:m,...y?{overrideScorers:y}:{}})}catch(e){this.capabilities.logger.error("Error saving memory on finish",{error:e,runId:p})}await u?.({...e,runId:p})},runId:p});return e.traceId=l,e}this.capabilities.logger.debug(`Starting agent ${this.capabilities.name} llm streamObject call`,{runId:p});let b=s.__streamObject({...f,tracingContext:v,requestContext:h,onFinish:async e=>{try{if(e.object){let t=[{role:"assistant",content:[{type:"text",text:JSON.stringify(e.object)}]}];g.add(t,"response")}await this.capabilities.__runOutputProcessors({requestContext:h,tracingContext:v,messageList:g});let t=JSON.stringify(e.object);await i({result:e,outputText:t,structuredOutput:!0,agentSpan:m,...y?{overrideScorers:y}:{}})}catch(e){this.capabilities.logger.error("Error saving memory on finish",{error:e,runId:p})}await u?.({...e,runId:p})},runId:p,structuredOutput:d});return b.traceId=l,b}},_n=class e{logger;debounceMs;memory;static MAX_STALENESS_MS=1e3;constructor({logger:e,debounceMs:t,memory:r}){this.logger=e,this.debounceMs=t||100,this.memory=r}saveQueues=new Map;saveDebounceTimers=new Map;debounceSave(e,t,r){return new Promise((a,s)=>{this.saveDebounceTimers.has(e)&&clearTimeout(this.saveDebounceTimers.get(e)),this.saveDebounceTimers.set(e,setTimeout(()=>{this.enqueueSave(e,t,r).then(a).catch(t=>{this.logger?.error?.("Error in debounceSave",{err:t,threadId:e}),s(t)}).finally(()=>{this.saveDebounceTimers.delete(e)})},this.debounceMs))})}enqueueSave(e,t,r){let a=(this.saveQueues.get(e)||Promise.resolve()).then(()=>this.persistUnsavedMessages(t,r)).catch(t=>{this.logger?.error?.("Error in enqueueSave",{err:t,threadId:e})}).then(()=>{this.saveQueues.get(e)===a&&this.saveQueues.delete(e)});return this.saveQueues.set(e,a),a}clearDebounce(e){this.saveDebounceTimers.has(e)&&(clearTimeout(this.saveDebounceTimers.get(e)),this.saveDebounceTimers.delete(e))}async persistUnsavedMessages(e,t){let r=e.drainUnsavedMessages();r.length>0&&this.memory&&await this.memory.saveMessages({messages:r,memoryConfig:t})}async batchMessages(t,r,a){if(!r)return;let s=t.getEarliestUnsavedMessageTimestamp(),n=Date.now();return s&&n-s>e.MAX_STALENESS_MS?this.flushMessages(t,r,a):this.debounceSave(r,t,a)}async flushMessages(e,t,r){if(t)return this.clearDebounce(t),this.enqueueSave(t,e,r)}};function _i(e){if("generate"===e||"generateLegacy"===e)return"generate";if("stream"===e||"streamLegacy"===e)return"stream";throw new eN.MastraError({id:"INVALID_METHOD_TYPE",domain:"AGENT",category:"USER"})}var _o=(0,sm.__toESM)(wx(),1),_l=sg.object({id:sg.string().optional(),description:sg.string().optional(),parameters:sg.union([sg.record(sg.string(),sg.any()),sg.any()]),outputSchema:sg.union([sg.record(sg.string(),sg.any()),sg.any()]).optional(),execute:sg.optional(sg.function(sg.tuple([sg.any(),sg.any()]),sg.promise(sg.any()))),type:sg.union([sg.literal("function"),sg.literal("provider-defined"),sg.undefined()]).optional(),args:sg.record(sg.string(),sg.any()).optional()}),_u=sg.object({id:sg.string(),title:sg.string().optional(),resourceId:sg.string(),createdAt:sg.date(),updatedAt:sg.date(),metadata:sg.record(sg.string(),sg.any()).optional()}),_p=sg.object({convertedTools:sg.record(sg.string(),_l)}),_d=sg.object({threadExists:sg.boolean(),thread:_u.optional(),messageList:sg.instanceof(pZ),tripwire:sg.object({reason:sg.string(),retry:sg.boolean().optional(),metadata:sg.unknown().optional(),processorId:sg.string().optional()}).optional()});function _c(e,t,r){if(t)if(Array.isArray(t))for(let a of t)e.addSystem(a,r);else e.addSystem(t,r)}function _m(e,t){return e instanceof Promise||null!=e&&"function"==typeof e.then?Promise.resolve(e).then(t):t(e)}var _g=class extends wo.MastraBase{id;name;#eV;#eK;model;#eG;maxRetries;#t;#eW;#eQ;#eJ;#eH;#eY;#eX;#e0;#e1;#e2;#e3;#e5;#e4;#e6;#r;#e7;_agentNetworkAppend=!1;constructor(e){if(super({component:eD.RegisteredLogger.AGENT}),this.name=e.name,this.id=e.id??e.name,this.#eV=e.instructions,this.#eK=e.description,this.#r=e.options,!e.model){const t=new eN.MastraError({id:"AGENT_CONSTRUCTOR_MODEL_REQUIRED",domain:"AGENT",category:"USER",details:{agentName:e.name},text:"LanguageModel is required to create an Agent. Please provide the 'model'."});throw this.logger.trackException(t),this.logger.error(t.toString()),t}if(Array.isArray(e.model)){if(0===e.model.length){const t=new eN.MastraError({id:"AGENT_CONSTRUCTOR_MODEL_ARRAY_EMPTY",domain:"AGENT",category:"USER",details:{agentName:e.name},text:"Model array is empty. Please provide at least one model."});throw this.logger.trackException(t),this.logger.error(t.toString()),t}this.model=e.model.map(t=>({id:(0,cz.randomUUID)(),model:t.model,maxRetries:t.maxRetries??e?.maxRetries??0,enabled:t.enabled??!0})),this.#eG=[...this.model]}else this.model=e.model,this.#eG=e.model;this.maxRetries=e.maxRetries??0,e.workflows&&(this.#eQ=e.workflows),this.#eJ=e.defaultGenerateOptionsLegacy||{},this.#eH=e.defaultStreamOptionsLegacy||{},this.#eY=e.defaultOptions||{},this.#eX=e.defaultNetworkOptions||{},this.#e0=e.tools||{},e.mastra&&(this.__registerMastra(e.mastra),this.__registerPrimitives({logger:e.mastra.getLogger()})),this.#e1=e.scorers||{},this.#e2=e.agents||{},e.memory&&(this.#eW=e.memory),e.voice?(this.#e3=e.voice,"function"!=typeof e.tools&&this.#e3?.addTools(this.#e0),"string"==typeof e.instructions&&this.#e3?.addInstructions(e.instructions)):this.#e3=new sp,e.inputProcessors&&(this.#e5=e.inputProcessors),e.outputProcessors&&(this.#e4=e.outputProcessors),void 0!==e.maxProcessorRetries&&(this.#e6=e.maxProcessorRetries),this._agentNetworkAppend=e._agentNetworkAppend||!1}getMastraInstance(){return this.#t}listAgents({requestContext:e=new c_}={}){return _m(this.#e2?"function"==typeof this.#e2?this.#e2({requestContext:e}):this.#e2:{},e=>{if(!e){let e=new eN.MastraError({id:"AGENT_GET_AGENTS_FUNCTION_EMPTY_RETURN",domain:"AGENT",category:"USER",details:{agentName:this.name},text:`[Agent:${this.name}] - Function-based agents returned empty value`});throw this.logger.trackException(e),this.logger.error(e.toString()),e}return Object.entries(e||{}).forEach(([e,t])=>{this.#t&&t.__registerMastra(this.#t)}),e})}async getProcessorRunner({requestContext:e,inputProcessorOverrides:t,outputProcessorOverrides:r}){return new wD({inputProcessors:t??await this.listResolvedInputProcessors(e),outputProcessors:r??await this.listResolvedOutputProcessors(e),logger:this.logger,agentName:this.name})}combineProcessorsIntoWorkflow(e,t){if(0===e.length)return[];if(1===e.length&&_h(e[0])){let t=e[0];return t.type||(t.type="processor"),[t]}let r=e.filter(e=>_h(e)||kN(e));if(0===r.length)return[];if(1===r.length&&_h(r[0])){let e=r[0];return e.type||(e.type="processor"),[e]}let a=kL({id:t,inputSchema:kp,outputSchema:kp,type:"processor",options:{validateInputs:!1,tracingPolicy:{internal:1}}});for(let[e,t]of r.entries()){let r;_h(t)?r=t:(t.processorIndex=e,r=kj(t)),a=a.then(r)}return[a.commit()]}async listResolvedOutputProcessors(e){let t=this.#e4?"function"==typeof this.#e4?await this.#e4({requestContext:e||new c_}):this.#e4:[],r=await this.getMemory({requestContext:e||new c_}),a=r?await r.getOutputProcessors(t,e):[],s=[...t,...a];return this.combineProcessorsIntoWorkflow(s,`${this.id}-output-processor`)}async listResolvedInputProcessors(e){let t=this.#e5?"function"==typeof this.#e5?await this.#e5({requestContext:e||new c_}):this.#e5:[],r=await this.getMemory({requestContext:e||new c_}),a=[...r?await r.getInputProcessors(t,e):[],...t];return this.combineProcessorsIntoWorkflow(a,`${this.id}-input-processor`)}async listInputProcessors(e){return this.listResolvedInputProcessors(e)}async listOutputProcessors(e){return this.listResolvedOutputProcessors(e)}async getConfiguredProcessorWorkflows(){let e=[];if(this.#e5){let t="function"==typeof this.#e5?await this.#e5({requestContext:new c_}):this.#e5;for(let r of this.combineProcessorsIntoWorkflow(t,`${this.id}-input-processor`))_h(r)&&e.push(r)}if(this.#e4){let t="function"==typeof this.#e4?await this.#e4({requestContext:new c_}):this.#e4;for(let r of this.combineProcessorsIntoWorkflow(t,`${this.id}-output-processor`))_h(r)&&e.push(r)}return e}hasOwnMemory(){return!!this.#eW}async getMemory({requestContext:e=new c_}={}){let t;if(this.#eW){if("function"!=typeof this.#eW)t=this.#eW;else{let r=this.#eW({requestContext:e,mastra:this.#t});if(!(t=await Promise.resolve(r))){let e=new eN.MastraError({id:"AGENT_GET_MEMORY_FUNCTION_EMPTY_RETURN",domain:"AGENT",category:"USER",details:{agentName:this.name},text:`[Agent:${this.name}] - Function-based memory returned empty value`});throw this.logger.trackException(e),this.logger.error(e.toString()),e}}if(this.#t&&t&&(t.__registerMastra(this.#t),!t.hasOwnStorage)){let e=this.#t.getStorage();e&&t.setStorage(e)}return t}}get voice(){if("function"==typeof this.#eV){let e=new eN.MastraError({id:"AGENT_VOICE_INCOMPATIBLE_WITH_FUNCTION_INSTRUCTIONS",domain:"AGENT",category:"USER",details:{agentName:this.name},text:"Voice is not compatible when instructions are a function. Please use getVoice() instead."});throw this.logger.trackException(e),this.logger.error(e.toString()),e}return this.#e3}async listWorkflows({requestContext:e=new c_}={}){let t;return Object.entries((t="function"==typeof this.#eQ?await Promise.resolve(this.#eQ({requestContext:e,mastra:this.#t})):this.#eQ??{})||{}).forEach(([e,t])=>{this.#t&&t.__registerMastra(this.#t)}),t}async listScorers({requestContext:e=new c_}={}){return"function"!=typeof this.#e1?this.#e1:_m(this.#e1({requestContext:e,mastra:this.#t}),e=>{if(!e){let e=new eN.MastraError({id:"AGENT_GET_SCORERS_FUNCTION_EMPTY_RETURN",domain:"AGENT",category:"USER",details:{agentName:this.name},text:`[Agent:${this.name}] - Function-based scorers returned empty value`});throw this.logger.trackException(e),this.logger.error(e.toString()),e}return e})}async getVoice({requestContext:e}={}){if(!this.#e3)return new sp;{let t=this.#e3;t?.addTools(await this.listTools({requestContext:e}));let r=await this.getInstructions({requestContext:e});return t?.addInstructions(this.#e9(r)),t}}getInstructions({requestContext:e=new c_}={}){return"function"==typeof this.#eV?_m(this.#eV({requestContext:e,mastra:this.#t}),e=>{if(!e){let e=new eN.MastraError({id:"AGENT_GET_INSTRUCTIONS_FUNCTION_EMPTY_RETURN",domain:"AGENT",category:"USER",details:{agentName:this.name},text:"Instructions are required to use an Agent. The function-based instructions returned an empty value."});throw this.logger.trackException(e),this.logger.error(e.toString()),e}return e}):this.#eV}#e9(e){return"string"==typeof e?e:Array.isArray(e)?e.map(e=>"string"==typeof e?e:"string"==typeof e.content?e.content:"").filter(e=>e).join("\n\n"):"string"==typeof e.content?e.content:""}getDescription(){return this.#eK??""}getLegacyHandler(){return this.#e7||(this.#e7=new _s({logger:this.logger,name:this.name,id:this.id,mastra:this.#t,getDefaultGenerateOptionsLegacy:this.getDefaultGenerateOptionsLegacy.bind(this),getDefaultStreamOptionsLegacy:this.getDefaultStreamOptionsLegacy.bind(this),hasOwnMemory:this.hasOwnMemory.bind(this),getInstructions:async e=>await this.getInstructions(e),getLLM:this.getLLM.bind(this),getMemory:this.getMemory.bind(this),convertTools:this.convertTools.bind(this),getMemoryMessages:(...e)=>this.getMemoryMessages(...e),__runInputProcessors:this.__runInputProcessors.bind(this),getMostRecentUserMessage:this.getMostRecentUserMessage.bind(this),genTitle:this.genTitle.bind(this),resolveTitleGenerationConfig:this.resolveTitleGenerationConfig.bind(this),saveStepMessages:this.saveStepMessages.bind(this),convertInstructionsToString:this.#e9.bind(this),tracingPolicy:this.#r?.tracingPolicy,_agentNetworkAppend:this._agentNetworkAppend,listResolvedOutputProcessors:this.listResolvedOutputProcessors.bind(this),__runOutputProcessors:this.__runOutputProcessors.bind(this),runScorers:this.#e8.bind(this)})),this.#e7}getDefaultGenerateOptionsLegacy({requestContext:e=new c_}={}){return"function"!=typeof this.#eJ?this.#eJ:_m(this.#eJ({requestContext:e,mastra:this.#t}),e=>{if(!e){let e=new eN.MastraError({id:"AGENT_GET_DEFAULT_GENERATE_OPTIONS_FUNCTION_EMPTY_RETURN",domain:"AGENT",category:"USER",details:{agentName:this.name},text:`[Agent:${this.name}] - Function-based default generate options returned empty value`});throw this.logger.trackException(e),this.logger.error(e.toString()),e}return e})}getDefaultStreamOptionsLegacy({requestContext:e=new c_}={}){return"function"!=typeof this.#eH?this.#eH:_m(this.#eH({requestContext:e,mastra:this.#t}),e=>{if(!e){let e=new eN.MastraError({id:"AGENT_GET_DEFAULT_STREAM_OPTIONS_FUNCTION_EMPTY_RETURN",domain:"AGENT",category:"USER",details:{agentName:this.name},text:`[Agent:${this.name}] - Function-based default stream options returned empty value`});throw this.logger.trackException(e),this.logger.error(e.toString()),e}return e})}getDefaultOptions({requestContext:e=new c_}={}){return"function"!=typeof this.#eY?this.#eY:_m(this.#eY({requestContext:e,mastra:this.#t}),e=>{if(!e){let e=new eN.MastraError({id:"AGENT_GET_DEFAULT_OPTIONS_FUNCTION_EMPTY_RETURN",domain:"AGENT",category:"USER",details:{agentName:this.name},text:`[Agent:${this.name}] - Function-based default options returned empty value`});throw this.logger.trackException(e),this.logger.error(e.toString()),e}return e})}getDefaultNetworkOptions({requestContext:e=new c_}={}){return"function"!=typeof this.#eX?this.#eX:_m(this.#eX({requestContext:e,mastra:this.#t}),e=>{if(!e){let e=new eN.MastraError({id:"AGENT_GET_DEFAULT_NETWORK_OPTIONS_FUNCTION_EMPTY_RETURN",domain:"AGENT",category:"USER",details:{agentName:this.name},text:`[Agent:${this.name}] - Function-based default network options returned empty value`});throw this.logger.trackException(e),this.logger.error(e.toString()),e}return e})}listTools({requestContext:e=new c_}={}){return"function"!=typeof this.#e0?v1(this.#e0):_m(this.#e0({requestContext:e,mastra:this.#t}),e=>{if(!e){let e=new eN.MastraError({id:"AGENT_GET_TOOLS_FUNCTION_EMPTY_RETURN",domain:"AGENT",category:"USER",details:{agentName:this.name},text:`[Agent:${this.name}] - Function-based tools returned empty value`});throw this.logger.trackException(e),this.logger.error(e.toString()),e}return v1(e)})}getLLM({requestContext:e=new c_,model:t}={}){return _m(this.getModel({modelConfig:t,requestContext:e}),r=>{let a;return _m(a=wC.includes(r.specificationVersion)?(Array.isArray(this.model)&&!t?this.prepareModels(e):this.prepareModels(e,r)).then(e=>new k6({models:e.filter(e=>e.enabled),mastra:this.#t,options:{tracingPolicy:this.#r?.tracingPolicy}})):new v6({model:r,mastra:this.#t,options:{tracingPolicy:this.#r?.tracingPolicy}}),e=>(this.#te&&e.__registerPrimitives(this.#te),this.#t&&e.__registerMastra(this.#t),e))})}async resolveModelConfig(e,t){try{return await wa(e,t,this.#t)}catch(t){let e=new eN.MastraError({id:"AGENT_GET_MODEL_MISSING_MODEL_INSTANCE",domain:"AGENT",category:"USER",details:{agentName:this.name,originalError:t instanceof Error?t.message:String(t)},text:`[Agent:${this.name}] - Failed to resolve model configuration`});throw this.logger.trackException(e),this.logger.error(e.toString()),e}}getModel({requestContext:e=new c_,modelConfig:t=this.model}={}){if(!Array.isArray(t))return this.resolveModelConfig(t,e);if(0===t.length||!t[0]){let e=new eN.MastraError({id:"AGENT_GET_MODEL_MISSING_MODEL_INSTANCE",domain:"AGENT",category:"USER",details:{agentName:this.name},text:`[Agent:${this.name}] - Empty model list provided`});throw this.logger.trackException(e),this.logger.error(e.toString()),e}return this.resolveModelConfig(t[0].model,e)}async getModelList(e=new c_){return Array.isArray(this.model)?this.prepareModels(e):null}__updateInstructions(e){this.#eV=e,this.logger.debug(`[Agents:${this.name}] Instructions updated.`,{model:this.model,name:this.name})}__updateModel({model:e}){this.model=e,this.logger.debug(`[Agents:${this.name}] Model updated.`,{model:this.model,name:this.name})}__resetToOriginalModel(){this.model=Array.isArray(this.#eG)?[...this.#eG]:this.#eG,this.logger.debug(`[Agents:${this.name}] Model reset to original.`,{model:this.model,name:this.name})}reorderModels(e){Array.isArray(this.model)?(this.model=this.model.sort((t,r)=>e.indexOf(t.id)-e.indexOf(r.id)),this.logger.debug(`[Agents:${this.name}] Models reordered`)):this.logger.warn(`[Agents:${this.name}] model is not an array`)}updateModelInModelList({id:e,model:t,enabled:r,maxRetries:a}){Array.isArray(this.model)?this.model.find(t=>t.id===e)?(this.model=this.model.map(s=>s.id===e?{...s,model:t??s.model,enabled:r??s.enabled,maxRetries:a??s.maxRetries}:s),this.logger.debug(`[Agents:${this.name}] model ${e} updated`)):this.logger.warn(`[Agents:${this.name}] model ${e} not found`):this.logger.warn(`[Agents:${this.name}] model is not an array`)}#te;__registerPrimitives(e){e.logger&&this.__setLogger(e.logger),this.#te=e,this.logger.debug(`[Agents:${this.name}] initialized.`,{model:this.model,name:this.name})}__registerMastra(e){this.#t=e,this.#e0&&"object"==typeof this.#e0&&Object.entries(this.#e0).forEach(([t,r])=>{try{if(r&&"object"==typeof r&&"id"in r){let a="string"==typeof r.id?r.id:t;e.addTool(r,a)}}catch(e){if(e instanceof eN.MastraError&&"MASTRA_ADD_TOOL_DUPLICATE_KEY"!==e.id)throw e}}),this.#e5&&Array.isArray(this.#e5)&&this.#e5.forEach(t=>{try{e.addProcessor(t)}catch(e){if(e instanceof eN.MastraError&&"MASTRA_ADD_PROCESSOR_DUPLICATE_KEY"!==e.id)throw e}e.addProcessorConfiguration(t,this.id,"input")}),this.#e4&&Array.isArray(this.#e4)&&this.#e4.forEach(t=>{try{e.addProcessor(t)}catch(e){if(e instanceof eN.MastraError&&"MASTRA_ADD_PROCESSOR_DUPLICATE_KEY"!==e.id)throw e}e.addProcessorConfiguration(t,this.id,"output")})}__setTools(e){this.#e0=e,this.logger.debug(`[Agents:${this.name}] Tools set for agent ${this.name}`,{model:this.model,name:this.name})}async generateTitleFromUserMessage({message:e,requestContext:t=new c_,tracingContext:r,model:a,instructions:s}){let n,i=await this.getLLM({requestContext:t,model:a}),o=new pZ().add(e,"user").get.all.ui().at(-1);if(!o)throw Error(`Could not generate title from input ${JSON.stringify(e)}`);let l=[];for(let e of o.parts)"text"===e.type?l.push(e):"source"===e.type?l.push({type:"text",text:`User added URL: ${e.source.url.substring(0,100)}`}):"file"===e.type&&l.push({type:"text",text:`User added ${e.mimeType} file: ${e.data.substring(0,100)}`});let u=await this.resolveTitleInstructions(t,s),p="";if(n=i.getModel(),wC.includes(n.specificationVersion)){let e=new pZ().add([{role:"system",content:u}],"system").add([{role:"user",content:JSON.stringify(l)}],"input"),a=i.stream({methodType:"generate",requestContext:t,tracingContext:r,messageList:e,agentId:this.id,agentName:this.name});p=await a.text}else p=(await i.__text({requestContext:t,tracingContext:r,messages:[{role:"system",content:u},{role:"user",content:JSON.stringify(l)}]})).text;return p.replace(/<think>[\s\S]*?<\/think>/g,"").trim()}getMostRecentUserMessage(e){return e.filter(e=>"user"===e.role).at(-1)}async genTitle(e,t,r,a,s){try{if(e){let n=new pZ().add(e,"user").get.all.ui().at(-1);if(n)return await this.generateTitleFromUserMessage({message:n,requestContext:t,tracingContext:r,model:a,instructions:s})}return`New Thread ${new Date().toISOString()}`}catch(e){this.logger.error("Error generating title:",e);return}}__setMemory(e){this.#eW=e}async listMemoryTools({runId:e,resourceId:t,threadId:r,requestContext:a,tracingContext:s,mastraProxy:n,memoryConfig:i,autoResumeSuspendedTools:o}){let l={};if(this._agentNetworkAppend)return this.logger.debug(`[Agent:${this.name}] - Skipping memory tools (agent network context)`,{runId:e}),l;let u=await this.getMemory({requestContext:a}),p=u?.listTools?.(i);if(p)for(let[i,d]of(this.logger.debug(`[Agent:${this.name}] - Adding tools from memory ${Object.keys(p||{}).join(", ")}`,{runId:e}),Object.entries(p))){let p={name:i,runId:e,threadId:r,resourceId:t,logger:this.logger,mastra:n,memory:u,agentName:this.name,requestContext:a,tracingContext:s,model:await this.getModel({requestContext:a}),tracingPolicy:this.#r?.tracingPolicy,requireApproval:d.requireApproval},c=v2(d,p,void 0,o);l[i]=c}return l}async __runInputProcessors({requestContext:e,tracingContext:t,messageList:r,inputProcessorOverrides:a}){let s;if(a?.length||this.#e5||this.#eW){let n=await this.getProcessorRunner({requestContext:e,inputProcessorOverrides:a});try{r=await n.runInputProcessors(r,t,e)}catch(e){if(e instanceof wG)s={reason:e.message,retry:e.options?.retry,metadata:e.options?.metadata,processorId:e.processorId};else throw new eN.MastraError({id:"AGENT_INPUT_PROCESSOR_ERROR",domain:"AGENT",category:"USER",text:`[Agent:${this.name}] - Input processor error`},e)}}return{messageList:r,tripwire:s}}async __runOutputProcessors({requestContext:e,tracingContext:t,messageList:r,outputProcessorOverrides:a}){let s;if(a?.length||this.#e4||this.#eW){let n=await this.getProcessorRunner({requestContext:e,outputProcessorOverrides:a});try{r=await n.runOutputProcessors(r,t,e)}catch(e){if(e instanceof wG)s={reason:e.message,retry:e.options?.retry,metadata:e.options?.metadata,processorId:e.processorId},this.logger.debug(`[Agent:${this.name}] - Output processor tripwire triggered: ${e.message}`);else throw e}}return{messageList:r,tripwire:s}}async getMemoryMessages({resourceId:e,threadId:t,vectorMessageSearch:r,memoryConfig:a,requestContext:s}){let n=await this.getMemory({requestContext:s});if(!n)return{messages:[]};let i=n.getMergedThreadConfig(a||{});return i.lastMessages||i.semanticRecall?n.recall({threadId:t,resourceId:e,perPage:i.lastMessages,threadConfig:a,vectorSearchString:i.semanticRecall&&r?r:void 0}):{messages:[]}}async listAssignedTools({runId:e,resourceId:t,threadId:r,requestContext:a,tracingContext:s,mastraProxy:n,outputWriter:i,autoResumeSuspendedTools:o}){this.logger.debug(`[Agents:${this.name}] - Assembling assigned tools`,{runId:e,threadId:r,resourceId:t});let l=await this.getMemory({requestContext:a}),u=Object.entries(await this.listTools({requestContext:a})||{});return{...Object.fromEntries((await Promise.all(u.map(async([u,p])=>{if(!p)return;let d={name:u,runId:e,threadId:r,resourceId:t,logger:this.logger,mastra:n,memory:l,agentName:this.name,requestContext:a,tracingContext:s,model:await this.getModel({requestContext:a}),outputWriter:i,tracingPolicy:this.#r?.tracingPolicy,requireApproval:p.requireApproval};return[u,v2(p,d,void 0,o)]}))).filter(e=>!!e))}}async listToolsets({runId:e,threadId:t,resourceId:r,toolsets:a,requestContext:s,tracingContext:n,mastraProxy:i,autoResumeSuspendedTools:o}){let l={},u=await this.getMemory({requestContext:s}),p=Object.values(a||{});if(p.length>0)for(let d of(this.logger.debug(`[Agent:${this.name}] - Adding tools from toolsets ${Object.keys(a||{}).join(", ")}`,{runId:e}),p))for(let[a,p]of Object.entries(d)){let d={name:a,runId:e,threadId:t,resourceId:r,logger:this.logger,mastra:i,memory:u,agentName:this.name,requestContext:s,tracingContext:n,model:await this.getModel({requestContext:s}),tracingPolicy:this.#r?.tracingPolicy,requireApproval:p.requireApproval},c=v2(p,d,"toolset",o);l[a]=c}return l}async listClientTools({runId:e,threadId:t,resourceId:r,requestContext:a,tracingContext:s,mastraProxy:n,clientTools:i,autoResumeSuspendedTools:o}){let l={},u=await this.getMemory({requestContext:a}),p=Object.entries(i||{});if(p.length>0)for(let[d,c]of(this.logger.debug(`[Agent:${this.name}] - Adding client tools ${Object.keys(i||{}).join(", ")}`,{runId:e}),p)){let{execute:i,...p}=c,m=v2(p,{name:d,runId:e,threadId:t,resourceId:r,logger:this.logger,mastra:n,memory:u,agentName:this.name,requestContext:a,tracingContext:s,model:await this.getModel({requestContext:a}),tracingPolicy:this.#r?.tracingPolicy,requireApproval:c.requireApproval},"client-tool",o);l[d]=m}return l}async listAgentTools({runId:t,threadId:r,resourceId:a,requestContext:s,tracingContext:n,methodType:i,autoResumeSuspendedTools:o}){let l={},u=await this.listAgents({requestContext:s});if(Object.keys(u).length>0)for(let[p,d]of Object.entries(u)){let u=sg.object({prompt:sg.string().describe("The prompt to send to the agent"),threadId:sg.string().nullish().describe("Thread ID for conversation continuity for memory messages"),resourceId:sg.string().nullish().describe("Resource/user identifier for memory messages"),instructions:sg.string().nullish().describe("Custom instructions to override agent defaults"),maxSteps:sg.number().min(3).nullish().describe("Maximum number of execution steps for the sub-agent")}),c=sg.object({text:sg.string().describe("The response from the agent"),subAgentThreadId:sg.string().describe("The thread ID of the agent").optional(),subAgentResourceId:sg.string().describe("The resource ID of the agent").optional()}),m=(await d.getModel({requestContext:s})).specificationVersion,g=new cE({id:`agent-${p}`,description:d.getDescription()||`Agent: ${p}`,inputSchema:u,outputSchema:c,mastra:this.#t,execute:async(n,o)=>{try{let l;this.logger.debug(`[Agent:${this.name}] - Executing agent as tool ${p}`,{name:p,args:n,runId:t,threadId:r,resourceId:a});let u=await e.A(366722),c=n.threadId||o?.mastra?.generateId({idType:"thread",source:"agent",entityId:p,resourceId:a})||(0,cz.randomUUID)(),g=n.resourceId||o?.mastra?.generateId({idType:"generic",source:"agent",entityId:p})||`${u.default(this.id)}-${p}`;if(("generate"===i||"generateLegacy"===i)&&wC.includes(m))!d.hasOwnMemory()&&this.#eW&&d.__setMemory(this.#eW),l={text:(await d.generate(n.prompt,{requestContext:s,tracingContext:o?.tracingContext,...n.instructions&&{instructions:n.instructions},...n.maxSteps&&{maxSteps:n.maxSteps},...a&&r?{memory:{resource:g,thread:c}}:{}})).text,subAgentThreadId:c,subAgentResourceId:g};else if("generate"===i&&"v1"===m)l={text:(await d.generateLegacy(n.prompt,{requestContext:s,tracingContext:o?.tracingContext})).text};else if(("stream"===i||"streamLegacy"===i)&&wC.includes(m)){!d.hasOwnMemory()&&this.#eW&&d.__setMemory(this.#eW);let e=await d.stream(n.prompt,{requestContext:s,tracingContext:o?.tracingContext,...n.instructions&&{instructions:n.instructions},...n.maxSteps&&{maxSteps:n.maxSteps},...a&&r?{memory:{resource:g,thread:c}}:{}}),t="";for await(let r of e.fullStream)o?.writer&&(r.type.startsWith("data-")?await o.writer.custom(r):await o.writer.write(r)),"text-delta"===r.type&&(t+=r.payload.text);l={text:t,subAgentThreadId:c,subAgentResourceId:g}}else{let e=await d.streamLegacy(n.prompt,{requestContext:s,tracingContext:o?.tracingContext}),t="";for await(let r of e.fullStream)o?.writer&&(r.type.startsWith("data-")?await o.writer.custom(r):await o.writer.write(r)),"text-delta"===r.type&&(t+=r.textDelta);l={text:t}}return l}catch(s){let e=new eN.MastraError({id:"AGENT_AGENT_TOOL_EXECUTION_FAILED",domain:"AGENT",category:"USER",details:{agentName:this.name,subAgentName:p,runId:t||"",threadId:r||"",resourceId:a||""},text:`[Agent:${this.name}] - Failed agent tool execution for ${p}`},s);throw this.logger.trackException(e),this.logger.error(e.toString()),e}}}),h={name:`agent-${p}`,runId:t,threadId:r,resourceId:a,logger:this.logger,mastra:this.#t,memory:await this.getMemory({requestContext:s}),agentName:this.name,requestContext:s,model:await this.getModel({requestContext:s}),tracingContext:n,tracingPolicy:this.#r?.tracingPolicy};l[`agent-${p}`]=v2(g,h,void 0,o)}return l}async listWorkflowTools({runId:e,threadId:t,resourceId:r,requestContext:a,tracingContext:s,methodType:n,autoResumeSuspendedTools:i}){let o={},l=await this.listWorkflows({requestContext:a});if(Object.keys(l).length>0)for(let[u,p]of Object.entries(l)){let l=sg.object({inputData:p.inputSchema,...p.stateSchema?{initialState:p.stateSchema}:{}}),d=new cE({id:`workflow-${u}`,description:p.description||`Workflow: ${u}`,inputSchema:l,outputSchema:sg.union([sg.object({result:p.outputSchema,runId:sg.string().describe("Unique identifier for the workflow run")}),sg.object({runId:sg.string().describe("Unique identifier for the workflow run"),error:sg.string().describe("Error message if workflow execution failed")})]),mastra:this.#t,execute:async(s,i)=>{try{let o,{initialState:l,inputData:d,suspendedToolRunId:c}=s,m=c||e;this.logger.debug(`[Agent:${this.name}] - Executing workflow as tool ${u}`,{name:u,description:p.description,args:s,runId:m,threadId:t,resourceId:r});let g=await p.createRun({runId:m}),{resumeData:h,suspend:f}=i?.agent??{};if("generate"===n||"generateLegacy"===n)o=h?await g.resume({resumeData:h,requestContext:a,tracingContext:i?.tracingContext}):await g.start({inputData:d,requestContext:a,tracingContext:i?.tracingContext,...l&&{initialState:l}});else if("streamLegacy"===n){let e=g.streamLegacy({inputData:d,requestContext:a,tracingContext:i?.tracingContext});if(i?.writer)await e.stream.pipeTo(i.writer);else for await(let t of e.stream);o=await e.getWorkflowState()}else if("stream"===n){let e=h?g.resumeStream({resumeData:h,requestContext:a,tracingContext:i?.tracingContext}):g.stream({inputData:d,requestContext:a,tracingContext:i?.tracingContext,...l&&{initialState:l}});i?.writer&&await e.fullStream.pipeTo(i.writer),o=await e.result}if(o?.status==="success")return{result:o?.result||o,runId:g.runId};if(o?.status==="failed"){let e=o?.error;return{error:e?.message||String(e)||"Workflow execution failed",runId:g.runId}}{if(o?.status!=="suspended")return{error:"Workflow should never reach this path, workflow returned no status",runId:g.runId};let e=o?.suspended?.[0]?.[0],t=o?.steps?.[e]?.suspendPayload,r=o?.suspended?.map(e=>e.join(".")),a=[...o?.suspended?.[0]??[]],s=p;for(;a.length>0;){let e=a.shift();if(e){if(!s.steps[e]){this.logger.warn(`Suspended step '${e}' not found in workflow '${u}'`);break}s=s.steps[e]}}let n=s?.resumeSchema;return t?.__workflow_meta&&delete t.__workflow_meta,f?.(t,{resumeLabel:r,resumeSchema:n?JSON.stringify(mh(n)):void 0})}}catch(n){let a=new eN.MastraError({id:"AGENT_WORKFLOW_TOOL_EXECUTION_FAILED",domain:"AGENT",category:"USER",details:{agentName:this.name,runId:s.suspendedToolRunId||e||"",threadId:t||"",resourceId:r||""},text:`[Agent:${this.name}] - Failed workflow tool execution`},n);throw this.logger.trackException(a),this.logger.error(a.toString()),a}}}),c={name:`workflow-${u}`,runId:e,threadId:t,resourceId:r,logger:this.logger,mastra:this.#t,memory:await this.getMemory({requestContext:a}),agentName:this.name,requestContext:a,model:await this.getModel({requestContext:a}),tracingContext:s,tracingPolicy:this.#r?.tracingPolicy};o[`workflow-${u}`]=v2(d,c,void 0,i)}return o}async convertTools({toolsets:e,clientTools:t,threadId:r,resourceId:a,runId:s,requestContext:n,tracingContext:i,outputWriter:o,methodType:l,memoryConfig:u,autoResumeSuspendedTools:p}){let d,c=this.logger;this.#t&&(d=function({mastra:e,logger:t}){return new Proxy(e,{get(e,r){if(Reflect.has(e,r)){let t=Reflect.get(e,r);return"function"==typeof t?t.bind(e):t}return"logger"===r?(t.warn("Please use 'getLogger' instead, logger is deprecated"),Reflect.apply(e.getLogger,e,[])):"storage"===r?(t.warn("Please use 'getStorage' instead, storage is deprecated"),Reflect.get(e,"storage")):"agents"===r?(t.warn("Please use 'listAgents' instead, agents is deprecated"),Reflect.apply(e.listAgents,e,[])):"tts"===r?(t.warn("Please use 'getTTS' instead, tts is deprecated"),Reflect.apply(e.getTTS,e,[])):"vectors"===r?(t.warn("Please use 'getVectors' instead, vectors is deprecated"),Reflect.apply(e.getVectors,e,[])):"memory"===r?(t.warn("Please use 'getMemory' instead, memory is deprecated"),Reflect.get(e,"memory")):Reflect.get(e,r)}})}({mastra:this.#t,logger:c}));let m=await this.listAssignedTools({runId:s,resourceId:a,threadId:r,requestContext:n,tracingContext:i,mastraProxy:d,outputWriter:o,autoResumeSuspendedTools:p}),g=await this.listMemoryTools({runId:s,resourceId:a,threadId:r,requestContext:n,tracingContext:i,mastraProxy:d,memoryConfig:u,autoResumeSuspendedTools:p}),h=await this.listToolsets({runId:s,resourceId:a,threadId:r,requestContext:n,tracingContext:i,mastraProxy:d,toolsets:e,autoResumeSuspendedTools:p}),f=await this.listClientTools({runId:s,resourceId:a,threadId:r,requestContext:n,tracingContext:i,mastraProxy:d,clientTools:t,autoResumeSuspendedTools:p}),y=await this.listAgentTools({runId:s,resourceId:a,threadId:r,requestContext:n,methodType:l,tracingContext:i,autoResumeSuspendedTools:p}),v=await this.listWorkflowTools({runId:s,resourceId:a,threadId:r,requestContext:n,methodType:l,tracingContext:i,autoResumeSuspendedTools:p});return this.formatTools({...m,...g,...h,...f,...y,...v})}formatTools(e){let t=/[^a-zA-Z0-9_\-]/g,r=/[a-zA-Z_]/;for(let a of Object.keys(e))if(e[a]&&(a.length>63||a.match(t)||!a[0].match(r))){let s=a.replace(t,"_");if(s[0].match(r)||(s="_"+s),e[s=s.slice(0,63)]){let e=new eN.MastraError({id:"AGENT_TOOL_NAME_COLLISION",domain:"AGENT",category:"USER",details:{agentName:this.name,toolName:s},text:`Two or more tools resolve to the same name "${s}". Please rename one of the tools to avoid this collision.`});throw this.logger.trackException(e),this.logger.error(e.toString()),e}e[s]=e[a],delete e[a]}return e}async saveStepMessages({result:e,messageList:t,runId:r}){try{t.add(e.response.messages,"response")}catch(e){throw this.logger.error("Error adding messages on step finish",{error:e,runId:r}),e}}async #e8({messageList:e,runId:t,requestContext:r,structuredOutput:a,overrideScorers:s,threadId:n,resourceId:i,tracingContext:o}){let l={};try{l=s?this.resolveOverrideScorerReferences(s):await this.listScorers({requestContext:r})}catch(e){this.logger.warn(`[Agent:${this.name}] - Failed to get scorers: ${e}`);return}let u={inputMessages:e.getPersisted.input.db(),rememberedMessages:e.getPersisted.remembered.db(),systemMessages:e.getSystemMessages(),taggedSystemMessages:e.getPersisted.taggedSystemMessages},p=e.getPersisted.response.db();if(Object.keys(l||{}).length>0)for(let[e,s]of Object.entries(l))wQ({scorerId:s.scorer.id,scorerObject:s,runId:t,input:u,output:p,requestContext:r,entity:{id:this.id,name:this.name},source:"LIVE",entityType:"AGENT",structuredOutput:!!a,threadId:n,resourceId:i,tracingContext:o})}resolveOverrideScorerReferences(e){let t={};for(let[r,a]of Object.entries(e))if("string"==typeof a.scorer)try{if(!this.#t)throw new eN.MastraError({id:"AGENT_GENEREATE_SCORER_NOT_FOUND",domain:"AGENT",category:"USER",text:"Mastra not found when fetching scorer. Make sure to fetch agent from mastra.getAgent()"});let e=this.#t.getScorerById(a.scorer);t[r]={scorer:e,sampling:a.sampling}}catch(e){this.logger.warn(`[Agent:${this.name}] - Failed to get scorer ${a.scorer}: ${e}`)}else t[r]=a;if(0===Object.keys(t).length&&Object.keys(e).length>0)throw new eN.MastraError({id:"AGENT_GENEREATE_SCORER_NOT_FOUND",domain:"AGENT",category:"USER",text:"No scorers found in overrideScorers"});return t}async prepareModels(e,t){if(t||!Array.isArray(this.model)){let r,a=t??this.model,s=await this.resolveModelConfig(a,e);if(!wC.includes(s.specificationVersion)){let e=new eN.MastraError({id:"AGENT_PREPARE_MODELS_INCOMPATIBLE_WITH_MODEL_ARRAY_V1",domain:"AGENT",category:"USER",details:{agentName:this.name},text:`[Agent:${this.name}] - Only v2/v3 models are allowed when an array of models is provided`});throw this.logger.trackException(e),this.logger.error(e.toString()),e}return s instanceof wr&&(r=s.config?.headers),[{id:"main",model:s,maxRetries:this.maxRetries??0,enabled:!0,headers:r}]}return await Promise.all(this.model.map(async t=>{let r,a=await this.resolveModelConfig(t.model,e);if(!wC.includes(a.specificationVersion)){let e=new eN.MastraError({id:"AGENT_PREPARE_MODELS_INCOMPATIBLE_WITH_MODEL_ARRAY_V1",domain:"AGENT",category:"USER",details:{agentName:this.name},text:`[Agent:${this.name}] - Only v2/v3 models are allowed when an array of models is provided`});throw this.logger.trackException(e),this.logger.error(e.toString()),e}let s=t.id||a.modelId;if(!s){let e=new eN.MastraError({id:"AGENT_PREPARE_MODELS_MISSING_MODEL_ID",domain:"AGENT",category:"USER",details:{agentName:this.name},text:`[Agent:${this.name}] - Unable to determine model ID. Please provide an explicit ID in the model configuration.`});throw this.logger.trackException(e),this.logger.error(e.toString()),e}return a instanceof wr&&(r=a.config?.headers),{id:s,model:a,maxRetries:t.maxRetries??0,enabled:t.enabled??!0,headers:r}}))}async #tt({methodType:e,resumeContext:t,...r}){let a,s=t?.snapshot;if(s)for(let e in s?.context){let t=s?.context[e];if(t&&"suspended"===t.status&&t.suspendPayload?.__streamState){a=t.suspendPayload?.__streamState?.messageList?.memoryInfo;break}}let n=r.requestContext||new c_,i=n.get(cw),o=n.get(ck),l=o?{id:o}:wN({memory:{...r.memory,thread:r.memory?.thread||a?.threadId}}),u=i||r.memory?.resource||a?.resourceId,p=r.memory?.options;u&&l&&!this.hasOwnMemory()&&this.logger.warn(`[Agent:${this.name}] - No memory is configured but resourceId and threadId were passed in args. This will not work.`);let d=await this.getLLM({requestContext:n,model:r.model});if("structuredOutput"in r&&r.structuredOutput?.schema){let e=d.getModel();r.structuredOutput?.model&&(e=await this.resolveModelConfig(r.structuredOutput?.model,n));let t=e.provider,a=e.modelId;if((t.includes("openai")||a.includes("openai"))&&v0(r.structuredOutput.schema)&&a){let e={provider:t,modelId:a,supportsStructuredOutputs:!1},s=/^o[1-5]/.test(a)?new vH(e):new vJ(e);s.shouldApply()&&r.structuredOutput.schema&&(r.structuredOutput.schema=s.processZodType(r.structuredOutput.schema))}}let c=r.runId||this.#t?.generateId({idType:"run",source:"agent",entityId:this.id,threadId:l?.id,resourceId:u})||(0,cz.randomUUID)(),m=r.instructions||await this.getInstructions({requestContext:n}),g=pQ({type:"agent_run",name:`agent run: '${this.id}'`,entityType:"agent",entityId:this.id,entityName:this.name,input:r.messages,attributes:{conversationId:l?.id,instructions:this.#e9(m)},metadata:{runId:c,resourceId:u,threadId:l?.id},tracingPolicy:this.#r?.tracingPolicy,tracingOptions:r.tracingOptions,tracingContext:r.tracingContext,requestContext:n,mastra:this.#t}),h=await this.getMemory({requestContext:n}),f=new _n({logger:this.logger,memory:h});this.logger.debug(`[Agents:${this.name}] - Starting generation`,{runId:c});let y=function({capabilities:e,options:t,threadFromArgs:r,resourceId:a,runId:s,requestContext:n,agentSpan:i,methodType:o,instructions:l,memoryConfig:u,memory:p,returnScorerData:d,saveQueueManager:c,requireToolApproval:m,toolCallConcurrency:g,resumeContext:h,agentId:f,agentName:y,toolCallId:v}){let b=function({capabilities:e,options:t,threadFromArgs:r,resourceId:a,runId:s,requestContext:n,agentSpan:i,methodType:o,memory:l}){return kj({id:"prepare-tools-step",inputSchema:sg.object({}),outputSchema:_p,execute:async()=>{let u=[t?.toolsets&&Object.keys(t?.toolsets||{}).length>0?`toolsets present (${Object.keys(t?.toolsets||{}).length} tools)`:void 0,l&&a?"memory and resourceId available":void 0].filter(Boolean).join(", ");e.logger.debug(`[Agent:${e.agentName}] - Enhancing tools: ${u}`,{runId:s,toolsets:t?.toolsets?Object.keys(t?.toolsets):void 0,clientTools:t?.clientTools?Object.keys(t?.clientTools):void 0,hasMemory:!!l,hasResourceId:!!a});let p=r?.id;return{convertedTools:await e.convertTools({toolsets:t?.toolsets,clientTools:t?.clientTools,threadId:p,resourceId:a,runId:s,requestContext:n,tracingContext:{currentSpan:i},outputWriter:t.outputWriter,methodType:o,memoryConfig:t.memory?.options,autoResumeSuspendedTools:t.autoResumeSuspendedTools})}}})}({capabilities:e,options:t,threadFromArgs:r,resourceId:a,runId:s,requestContext:n,agentSpan:i,methodType:o,memory:p}),w=function({capabilities:e,options:t,threadFromArgs:r,resourceId:a,runId:s,requestContext:n,instructions:i,memoryConfig:o,memory:l}){return kj({id:"prepare-memory-step",inputSchema:sg.object({}),outputSchema:_d,execute:async({tracingContext:u})=>{let p,d=new pZ({threadId:r?.id,resourceId:a,generateMessageId:e.generateMessageId,_agentNetworkAppend:e._agentNetworkAppend});if(_c(d,i),d.add(t.context||[],"context"),_c(d,t.system,"user-provided"),!l||!r?.id&&!a){d.add(t.messages,"input");let{tripwire:r}=await e.runInputProcessors({requestContext:n,tracingContext:u,messageList:d,inputProcessorOverrides:t.inputProcessors});return{threadExists:!1,thread:void 0,messageList:d,tripwire:r}}if(!r?.id||!a){let t=new eN.MastraError({id:"AGENT_MEMORY_MISSING_RESOURCE_ID",domain:"AGENT",category:"USER",details:{agentName:e.agentName,threadId:r?.id||"",resourceId:a||""},text:`A resourceId and a threadId must be provided when using Memory. Saw threadId "${r?.id}" and resourceId "${a}"`});throw e.logger.error(t.toString()),e.logger.trackException(t),t}let c=l.constructor.name;e.logger.debug(`[Agent:${e.agentName}] - Memory persistence enabled: store=${c}, resourceId=${a}`,{runId:s,resourceId:a,threadId:r?.id,memoryStore:c});let m=await l.getThreadById({threadId:r?.id});p=m?!m.metadata&&r.metadata||r.metadata&&!(0,_o.default)(m.metadata,r.metadata)?await l.saveThread({thread:{...m,metadata:r.metadata},memoryConfig:o}):m:await l.createThread({threadId:r?.id,metadata:r.metadata,title:r.title,memoryConfig:o,resourceId:a,saveThread:!0}),n.set("MastraMemory",{thread:p,resourceId:a,memoryConfig:o}),d.add(t.messages,"input");let{tripwire:g}=await e.runInputProcessors({requestContext:n,tracingContext:u,messageList:d,inputProcessorOverrides:t.inputProcessors});return{thread:p,messageList:d,tripwire:g,threadExists:!!m}}})}({capabilities:e,options:t,threadFromArgs:r,resourceId:a,runId:s,requestContext:n,instructions:l,memoryConfig:u,memory:p}),k=function({capabilities:e,runId:t,returnScorerData:r,requireToolApproval:a,toolCallConcurrency:s,resumeContext:n,agentId:i,agentName:o,toolCallId:l,methodType:u,saveQueueManager:p,memoryConfig:d,memory:c,resourceId:m,autoResumeSuspendedTools:g}){return kj({id:"stream-text-step",inputSchema:sg.any(),outputSchema:sg.instanceof(wB),execute:async({inputData:h,tracingContext:f})=>{e.logger.debug(`Starting agent ${e.agentName} llm stream call`,{runId:t});let y=h.outputProcessors||(e.outputProcessors?"function"==typeof e.outputProcessors?await e.outputProcessors({requestContext:h.requestContext||new c_}):e.outputProcessors:[]),v=_i(u);return e.llm.stream({...h,outputProcessors:y,returnScorerData:r,tracingContext:f,requireToolApproval:a,toolCallConcurrency:s,resumeContext:n,_internal:{generateId:e.generateMessageId,saveQueueManager:p,memoryConfig:d,threadId:h.threadId,resourceId:m,memory:c},agentId:i,agentName:o,toolCallId:l,methodType:v,autoResumeSuspendedTools:g})}})}({capabilities:e,runId:s,returnScorerData:d,requireToolApproval:m,toolCallConcurrency:g,resumeContext:h,agentId:f,agentName:y,toolCallId:v,methodType:o,saveQueueManager:c,memoryConfig:u,memory:p,resourceId:a,autoResumeSuspendedTools:t.autoResumeSuspendedTools}),_=function({capabilities:e,options:t,resourceId:r,runId:a,requestContext:s,memory:n,memoryConfig:i,agentSpan:o,agentId:l,methodType:u}){return async({inputData:p,bail:d,tracingContext:c})=>{let m=p["prepare-tools-step"],g=p["prepare-memory-step"],h={...t,tools:m.convertedTools,toolChoice:t.toolChoice,thread:g.thread,threadId:g.thread?.id,resourceId:r,requestContext:s,onStepFinish:async r=>(t.savePerStep&&!i?.readOnly&&(!g.threadExists&&n&&g.thread&&(await n.createThread({threadId:g.thread?.id,title:g.thread?.title,metadata:g.thread?.metadata,resourceId:g.thread?.resourceId,memoryConfig:i}),g.threadExists=!0),await e.saveStepMessages({result:r,messageList:g.messageList,runId:a})),t.onStepFinish?.({...r,runId:a})),...g.tripwire&&{tripwire:g.tripwire}};if(h.tripwire){let r=await e.getModel({requestContext:h.requestContext});if(!wC.includes(r.specificationVersion))throw new eN.MastraError({id:"MAP_RESULTS_STEP_UNSUPPORTED_MODEL",domain:"AGENT",category:"USER",text:"Tripwire handling requires a v2/v3 model"});return d(await wW({tripwire:g.tripwire,runId:a,tracingContext:c,options:t,model:r,messageList:g.messageList}))}let f=t.outputProcessors||(e.outputProcessors?"function"==typeof e.outputProcessors?await e.outputProcessors({requestContext:h.requestContext}):e.outputProcessors:[]);if(t.structuredOutput?.model){let r=new wR({...t.structuredOutput,logger:e.logger});f=f?[...f,r]:[r]}let y=t.inputProcessors||(e.inputProcessors?"function"==typeof e.inputProcessors?await e.inputProcessors({requestContext:h.requestContext}):e.inputProcessors:[]),v=g.messageList;return{methodType:_i(u),agentId:l,requestContext:h.requestContext,tracingContext:{currentSpan:o},runId:a,toolChoice:h.toolChoice,tools:h.tools,resourceId:h.resourceId,threadId:h.threadId,stopWhen:h.stopWhen,maxSteps:h.maxSteps,providerOptions:h.providerOptions,includeRawChunks:t.includeRawChunks,options:{...t.prepareStep&&{prepareStep:t.prepareStep},onFinish:async n=>{if("error"===n.finishReason){let t=n.model?.provider,r=n.model?.modelId;if(eY.isInstance(n.error)){let s=t?` from ${t}`:"",i=r?` (model: ${r})`:"";e.logger.error(`Upstream LLM API error${s}${i}`,{error:n.error,runId:a,...t&&{provider:t},...r&&{modelId:r}})}else e.logger.error("Error in agent stream",{error:n.error,runId:a,...t&&{provider:t},...r&&{modelId:r}});return}try{let l=v.get.all.core().map(e=>e.content).join("\n");await e.executeOnFinish({result:n,outputText:l,thread:h.thread,threadId:h.threadId,readOnlyMemory:i?.readOnly,resourceId:r,memoryConfig:i,requestContext:s,agentSpan:o,runId:a,messageList:v,threadExists:g.threadExists,structuredOutput:!!t.structuredOutput?.schema,overrideScorers:t.scorers})}catch(t){e.logger.error("Error saving memory on finish",{error:t,runId:a})}await t?.onFinish?.({...n,runId:a,messages:v.get.response.aiV5.model(),usage:n.usage,totalUsage:n.totalUsage})},onStepFinish:h.onStepFinish,onChunk:t.onChunk,onError:t.onError,onAbort:t.onAbort,abortSignal:t.abortSignal},activeTools:t.activeTools,structuredOutput:t.structuredOutput,inputProcessors:y,outputProcessors:f,modelSettings:{temperature:0,...t.modelSettings||{}},messageList:g.messageList,maxProcessorRetries:t.maxProcessorRetries}}}({capabilities:e,options:t,resourceId:a,runId:s,requestContext:n,memory:p,memoryConfig:u,agentSpan:i,agentId:f,methodType:o});return kL({id:"execution-workflow",inputSchema:sg.object({}),outputSchema:sg.instanceof(wB),steps:[b,w,k],options:{tracingPolicy:{internal:1},validateInputs:!1}}).parallel([b,w]).map(_).then(k).commit()}({capabilities:{agentName:this.name,logger:this.logger,getMemory:this.getMemory.bind(this),getModel:this.getModel.bind(this),generateMessageId:this.#t?.generateId?.bind(this.#t)||(()=>(0,cz.randomUUID)()),_agentNetworkAppend:"_agentNetworkAppend"in this?!!this._agentNetworkAppend:void 0,saveStepMessages:this.saveStepMessages.bind(this),convertTools:this.convertTools.bind(this),getMemoryMessages:this.getMemoryMessages.bind(this),runInputProcessors:this.__runInputProcessors.bind(this),executeOnFinish:this.#tr.bind(this),inputProcessors:async({requestContext:e})=>this.listResolvedInputProcessors(e),outputProcessors:async({requestContext:e})=>this.listResolvedOutputProcessors(e),llm:d},options:{...r,methodType:e},threadFromArgs:l,resourceId:u,runId:c,requestContext:n,agentSpan:g,methodType:e,instructions:m,memoryConfig:p,memory:h,saveQueueManager:f,returnScorerData:r.returnScorerData,requireToolApproval:r.requireToolApproval,toolCallConcurrency:r.toolCallConcurrency,resumeContext:t,agentId:this.id,agentName:this.name,toolCallId:r.toolCallId}),v=await y.createRun();return await v.start({tracingContext:{currentSpan:g}})}async #tr({result:e,readOnlyMemory:t,thread:r,threadId:a,resourceId:s,memoryConfig:n,outputText:i,requestContext:o,agentSpan:l,runId:u,messageList:p,threadExists:d,structuredOutput:c=!1,overrideScorers:m}){let g={text:e.text,object:e.object,toolResults:e.toolResults,toolCalls:e.toolCalls,usage:e.usage,steps:e.steps.map(e=>({stepType:e.stepType,text:e.text,toolResults:e.toolResults,toolCalls:e.toolCalls,usage:e.usage}))};this.logger.debug(`[Agent:${this.name}] - Post processing LLM response`,{runId:u,result:g,threadId:a,resourceId:s});let h=p.get.response.aiV4.core().some(e=>"tool"===e.role&&e.content.some(e=>"updateWorkingMemory"===e.toolName)),f=await this.getMemory({requestContext:o}),y=h?a?await f?.getThreadById({threadId:a}):void 0:r;if(f&&s&&y&&!t)try{let t=e.response.messages;!t&&e.object&&(t=[{id:e.response.id,role:"assistant",content:[{type:"text",text:i}]}]),t&&p.add(t,"response"),d||await f.createThread({threadId:y.id,metadata:y.metadata,title:y.title,memoryConfig:n,resourceId:y.resourceId});let r=f.getMergedThreadConfig(n),{shouldGenerate:a,model:u,instructions:c}=this.resolveTitleGenerationConfig(r.generateTitle),m=p.get.remembered.db().filter(e=>"user"===e.role),g=0===m.length;if(a&&g){let e=this.getMostRecentUserMessage(p.get.all.ui());if(e){let t=await this.genTitle(e,o,{currentSpan:l},u,c);t&&await f.createThread({threadId:y.id,resourceId:s,memoryConfig:n,title:t,metadata:y.metadata})}}}catch(t){if(t instanceof eN.MastraError)throw t;let e=new eN.MastraError({id:"AGENT_MEMORY_PERSIST_RESPONSE_MESSAGES_FAILED",domain:"AGENT",category:"SYSTEM",details:{agentName:this.name,runId:u||"",threadId:a||"",result:JSON.stringify(g)}},t);throw this.logger.trackException(e),this.logger.error(e.toString()),e}else{let t=e.response.messages;!t&&e.object&&(t=[{id:e.response.id,role:"assistant",content:[{type:"text",text:i}]}]),t&&p.add(t,"response")}await this.#e8({messageList:p,runId:u,requestContext:o,structuredOutput:c,overrideScorers:m,tracingContext:{currentSpan:l}}),l?.end({output:{text:e.text,object:e.object,files:e.files}})}async network(e,t){let r=t?.requestContext||new c_,a=await this.getDefaultNetworkOptions({requestContext:r}),s={...a,...t,routing:{...a?.routing,...t?.routing},completion:{...a?.completion,...t?.completion}},n=s?.runId||this.#t?.generateId()||(0,cz.randomUUID)(),i=r.get(cw),o=r.get(ck)||("string"==typeof s?.memory?.thread?s?.memory?.thread:s?.memory?.thread?.id),l=i||s?.memory?.resource;return await _r({networkName:this.name,requestContext:r,runId:n,routingAgent:this,routingAgentOptions:{modelSettings:s?.modelSettings,memory:s?.memory},generateId:e=>this.#t?.generateId(e)||(0,cz.randomUUID)(),maxIterations:s?.maxSteps||1,messages:e,threadId:o,resourceId:l,validation:s?.completion,routing:s?.routing,onIterationComplete:s?.onIterationComplete,autoResumeSuspendedTools:s?.autoResumeSuspendedTools,mastra:this.#t,structuredOutput:s?.structuredOutput})}async resumeNetwork(e,t){let r=t.runId,a=t?.requestContext||new c_,s=await this.getDefaultNetworkOptions({requestContext:a}),n={...s,...t,routing:{...s?.routing,...t?.routing},completion:{...s?.completion,...t?.completion}},i=a.get(cw),o=a.get(ck)||("string"==typeof n?.memory?.thread?n?.memory?.thread:n?.memory?.thread?.id),l=i||n?.memory?.resource;return await _r({networkName:this.name,requestContext:a,runId:r,routingAgent:this,routingAgentOptions:{modelSettings:n?.modelSettings,memory:n?.memory},generateId:e=>this.#t?.generateId(e)||(0,cz.randomUUID)(),maxIterations:n?.maxSteps||1,messages:[],threadId:o,resourceId:l,resumeData:e,validation:n?.completion,routing:n?.routing,onIterationComplete:n?.onIterationComplete,autoResumeSuspendedTools:n?.autoResumeSuspendedTools,mastra:this.#t})}async approveNetworkToolCall(e){return this.resumeNetwork({approved:!0},e)}async declineNetworkToolCall(e){return this.resumeNetwork({approved:!1},e)}async generate(e,t){let r={...await this.getDefaultOptions({requestContext:t?.requestContext}),...t??{}},a=(await this.getLLM({requestContext:r.requestContext})).getModel();if(!wC.includes(a.specificationVersion)){let e=a.modelId||"unknown",t=a.provider||"unknown";throw new eN.MastraError({id:"AGENT_GENERATE_V1_MODEL_NOT_SUPPORTED",domain:"AGENT",category:"USER",text:`Agent "${this.name}" is using AI SDK v4 model (${t}:${e}) which is not compatible with generate(). Please use AI SDK v5+ models or call the generateLegacy() method instead. See https://mastra.ai/en/docs/streaming/overview for more information.`,details:{agentName:this.name,modelId:e,provider:t,specificationVersion:a.specificationVersion}})}let s={...r,messages:e,methodType:"generate",maxProcessorRetries:r.maxProcessorRetries??this.#e6},n=await this.#tt(s);if("success"!==n.status){if("failed"===n.status)throw new eN.MastraError({id:"AGENT_GENERATE_FAILED",domain:"AGENT",category:"USER"},n.error);throw new eN.MastraError({id:"AGENT_GENERATE_UNKNOWN_ERROR",domain:"AGENT",category:"USER",text:"An unknown error occurred while streaming"})}let i=await n.result.getFullOutput(),o=i.error;if("error"===i.finishReason&&o)throw o;return i}async stream(e,t){let r={...await this.getDefaultOptions({requestContext:t?.requestContext}),...t??{}},a=(await this.getLLM({requestContext:r.requestContext})).getModel();if(!wC.includes(a.specificationVersion)){let e=a.modelId||"unknown",t=a.provider||"unknown";throw new eN.MastraError({id:"AGENT_STREAM_V1_MODEL_NOT_SUPPORTED",domain:"AGENT",category:"USER",text:`Agent "${this.name}" is using AI SDK v4 model (${t}:${e}) which is not compatible with stream(). Please use AI SDK v5+ models or call the streamLegacy() method instead. See https://mastra.ai/en/docs/streaming/overview for more information.`,details:{agentName:this.name,modelId:e,provider:t,specificationVersion:a.specificationVersion}})}let s={...r,messages:e,methodType:"stream",maxProcessorRetries:r.maxProcessorRetries??this.#e6},n=await this.#tt(s);if("success"!==n.status){if("failed"===n.status)throw new eN.MastraError({id:"AGENT_STREAM_FAILED",domain:"AGENT",category:"USER"},n.error);throw new eN.MastraError({id:"AGENT_STREAM_UNKNOWN_ERROR",domain:"AGENT",category:"USER",text:"An unknown error occurred while streaming"})}return n.result}async resumeStream(e,t){let r,a={...await this.getDefaultOptions({requestContext:t?.requestContext}),...t};if(r=(await this.getLLM({requestContext:a.requestContext})).getModel(),!wC.includes(r.specificationVersion))throw new eN.MastraError({id:"AGENT_STREAM_V1_MODEL_NOT_SUPPORTED",domain:"AGENT",category:"USER",text:"V1 models are not supported for stream. Please use streamLegacy instead."});let s=await this.#t?.getStorage()?.getStore("workflows"),n=await s?.loadWorkflowSnapshot({workflowName:"agentic-loop",runId:t?.runId??""}),i=await this.#tt({...a,messages:[],resumeContext:{resumeData:e,snapshot:n},methodType:"stream"});if("success"!==i.status){if("failed"===i.status)throw new eN.MastraError({id:"AGENT_STREAM_FAILED",domain:"AGENT",category:"USER"},i.error);throw new eN.MastraError({id:"AGENT_STREAM_UNKNOWN_ERROR",domain:"AGENT",category:"USER",text:"An unknown error occurred while streaming"})}return i.result}async resumeGenerate(e,t){let r={...await this.getDefaultOptions({requestContext:t?.requestContext}),...t??{}},a=(await this.getLLM({requestContext:r.requestContext})).getModel();if(!wC.includes(a.specificationVersion)){let e=a.modelId||"unknown",t=a.provider||"unknown";throw new eN.MastraError({id:"AGENT_GENERATE_V1_MODEL_NOT_SUPPORTED",domain:"AGENT",category:"USER",text:`Agent "${this.name}" is using AI SDK v4 model (${t}:${e}) which is not compatible with generate(). Please use AI SDK v5+ models or call the generateLegacy() method instead. See https://mastra.ai/en/docs/streaming/overview for more information.`,details:{agentName:this.name,modelId:e,provider:t,specificationVersion:a.specificationVersion}})}let s=await this.#t?.getStorage()?.getStore("workflows"),n=await s?.loadWorkflowSnapshot({workflowName:"agentic-loop",runId:t?.runId??""}),i=await this.#tt({...r,messages:[],resumeContext:{resumeData:e,snapshot:n},methodType:"generate",maxProcessorRetries:r.maxProcessorRetries??this.#e6});if("success"!==i.status){if("failed"===i.status)throw new eN.MastraError({id:"AGENT_GENERATE_FAILED",domain:"AGENT",category:"USER"},i.error);throw new eN.MastraError({id:"AGENT_GENERATE_UNKNOWN_ERROR",domain:"AGENT",category:"USER",text:"An unknown error occurred while generating"})}let o=await i.result.getFullOutput(),l=o.error;if("error"===o.finishReason&&l)throw l;return o}async approveToolCall(e){return this.resumeStream({approved:!0},e)}async declineToolCall(e){return this.resumeStream({approved:!1},e)}async approveToolCallGenerate(e){return this.resumeGenerate({approved:!0},e)}async declineToolCallGenerate(e){return this.resumeGenerate({approved:!1},e)}async generateLegacy(e,t={}){return this.getLegacyHandler().generateLegacy(e,t)}async streamLegacy(e,t={}){return this.getLegacyHandler().streamLegacy(e,t)}resolveTitleGenerationConfig(e){return"boolean"==typeof e?{shouldGenerate:e}:"object"==typeof e&&null!==e?{shouldGenerate:!0,model:e.model,instructions:e.instructions}:{shouldGenerate:!1}}async resolveTitleInstructions(e,t){let r=`
      - you will generate a short title based on the first message a user begins a conversation with
      - ensure it is not more than 80 characters long
      - the title should be a summary of the user's message
      - do not use quotes or colons
      - the entire text you return will be used as the title`;return t?"string"==typeof t?t:_m(t({requestContext:e,mastra:this.#t}),e=>e||r):r}};new wS({max:1e3});function _h(e){return null!==e&&"object"==typeof e&&"id"in e&&"string"==typeof e.id&&"inputSchema"in e&&"outputSchema"in e&&"execute"in e&&"function"==typeof e.execute&&!("processInput"in e)&&!("processInputStep"in e)&&!("processOutputStream"in e)&&!("processOutputResult"in e)&&!("processOutputStep"in e)}wo.MastraBase;wo.MastraBase;var _f="vercel.ai.error",_y=Symbol.for(_f),_v=class e extends Error{constructor({name:e,message:t,cause:r}){super(t),this[U]=!0,this.name=e,this.cause=r}static isInstance(t){return e.hasMarker(t,_f)}static hasMarker(e,t){let r=Symbol.for(t);return null!=e&&"object"==typeof e&&r in e&&"boolean"==typeof e[r]&&!0===e[r]}};U=_y;var _b=_v;function _w(e){return null==e?"unknown error":"string"==typeof e?e:e instanceof Error?e.message:JSON.stringify(e)}var _k="AI_InvalidArgumentError",__=`vercel.ai.error.${_k}`,_I=Symbol.for(__),_S=class extends _b{constructor({message:e,cause:t,argument:r}){super({name:_k,message:e,cause:t}),this[Z]=!0,this.argument=r}static isInstance(e){return _b.hasMarker(e,__)}};Z=_I;var _x="AI_JSONParseError",_T=`vercel.ai.error.${_x}`,_E=Symbol.for(_T),_A=class extends _b{constructor({text:e,cause:t}){super({name:_x,message:`JSON parsing failed: Text: ${e}.
Error message: ${_w(t)}`,cause:t}),this[B]=!0,this.text=e}static isInstance(e){return _b.hasMarker(e,_T)}};B=_E;var _O="AI_TypeValidationError",_z=`vercel.ai.error.${_O}`,_M=Symbol.for(_z),_P=class e extends _b{constructor({value:e,cause:t}){super({name:_O,message:`Type validation failed: Value: ${JSON.stringify(e)}.
Error message: ${_w(t)}`,cause:t}),this[V]=!0,this.value=e}static isInstance(e){return _b.hasMarker(e,_z)}static wrap({value:t,cause:r}){return e.isInstance(r)&&r.value===t?r:new e({value:t,cause:r})}};V=_M;var _R=({prefix:e,size:t=16,alphabet:r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",separator:a="-"}={})=>{let s=()=>{let e=r.length,a=Array(t);for(let s=0;s<t;s++)a[s]=r[Math.random()*e|0];return a.join("")};if(null==e)return s;if(r.includes(a))throw new _S({argument:"separator",message:`The separator "${a}" must not be part of the alphabet "${r}".`});return()=>`${e}${a}${s()}`},_C=_R(),_j=/"__proto__"\s*:/,_N=/"constructor"\s*:/;function _L(e){let t=JSON.parse(e);return null===t||"object"!=typeof t||!1===_j.test(e)&&!1===_N.test(e)?t:function(e){let t=[e];for(;t.length;){let e=t;for(let r of(t=[],e)){if(Object.prototype.hasOwnProperty.call(r,"__proto__")||Object.prototype.hasOwnProperty.call(r,"constructor")&&Object.prototype.hasOwnProperty.call(r.constructor,"prototype"))throw SyntaxError("Object contains forbidden prototype property");for(let e in r){let a=r[e];a&&"object"==typeof a&&t.push(a)}}}return e}(t)}var _D=Symbol.for("vercel.ai.validator");async function _q({value:e,schema:t}){var r;let a="object"==typeof t&&null!==t&&_D in t&&!0===t[_D]&&"validate"in t?t:"function"==typeof t?t():(r=t,{[_D]:!0,validate:async e=>{let t=await r["~standard"].validate(e);return null==t.issues?{success:!0,value:t.value}:{success:!1,error:new _P({value:e,cause:t.issues})}}});try{if(null==a.validate)return{success:!0,value:e,rawValue:e};let t=await a.validate(e);if(t.success)return{success:!0,value:t.value,rawValue:e};return{success:!1,error:_P.wrap({value:e,cause:t.error}),rawValue:e}}catch(t){return{success:!1,error:_P.wrap({value:e,cause:t}),rawValue:e}}}async function _$({text:e,schema:t}){try{let r=function(e){let{stackTraceLimit:t}=Error;try{Error.stackTraceLimit=0}catch(t){return _L(e)}try{return _L(e)}finally{Error.stackTraceLimit=t}}(e);if(null==t)return{success:!0,value:r,rawValue:r};return await _q({value:r,schema:t})}catch(t){return{success:!1,error:_A.isInstance(t)?t:new _A({text:e,cause:t}),rawValue:void 0}}}var _F=Symbol("Let zodToJsonSchema decide on which parser to use"),_U={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",allowedAdditionalProperties:!0,rejectedAdditionalProperties:!1,definitionPath:"definitions",strictUnions:!1,definitions:{},errorMessages:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"};function _Z(e,t){return Ie(e.type._def,t)}var _B=void 0,_V=/^[cC][^\s-]{8,}$/,_K=/^[0-9a-z]+$/,_G=/^[0-9A-HJKMNP-TV-Z]{26}$/,_W=/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,_Q=()=>(void 0===_B&&(_B=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),_B),_J=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,_H=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,_Y=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,_X=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,_0=/^[a-zA-Z0-9_-]{21}$/,_1=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/;function _2(e,t){let r={type:"string"};if(e.checks)for(let a of e.checks)switch(a.kind){case"min":r.minLength="number"==typeof r.minLength?Math.max(r.minLength,a.value):a.value;break;case"max":r.maxLength="number"==typeof r.maxLength?Math.min(r.maxLength,a.value):a.value;break;case"email":switch(t.emailStrategy){case"format:email":_4(r,"email",a.message,t);break;case"format:idn-email":_4(r,"idn-email",a.message,t);break;case"pattern:zod":_6(r,_W,a.message,t)}break;case"url":_4(r,"uri",a.message,t);break;case"uuid":_4(r,"uuid",a.message,t);break;case"regex":_6(r,a.regex,a.message,t);break;case"cuid":_6(r,_V,a.message,t);break;case"cuid2":_6(r,_K,a.message,t);break;case"startsWith":_6(r,RegExp(`^${_3(a.value,t)}`),a.message,t);break;case"endsWith":_6(r,RegExp(`${_3(a.value,t)}$`),a.message,t);break;case"datetime":_4(r,"date-time",a.message,t);break;case"date":_4(r,"date",a.message,t);break;case"time":_4(r,"time",a.message,t);break;case"duration":_4(r,"duration",a.message,t);break;case"length":r.minLength="number"==typeof r.minLength?Math.max(r.minLength,a.value):a.value,r.maxLength="number"==typeof r.maxLength?Math.min(r.maxLength,a.value):a.value;break;case"includes":_6(r,RegExp(_3(a.value,t)),a.message,t);break;case"ip":"v6"!==a.version&&_4(r,"ipv4",a.message,t),"v4"!==a.version&&_4(r,"ipv6",a.message,t);break;case"base64url":_6(r,_X,a.message,t);break;case"jwt":_6(r,_1,a.message,t);break;case"cidr":"v6"!==a.version&&_6(r,_J,a.message,t),"v4"!==a.version&&_6(r,_H,a.message,t);break;case"emoji":_6(r,_Q(),a.message,t);break;case"ulid":_6(r,_G,a.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":_4(r,"binary",a.message,t);break;case"contentEncoding:base64":r.contentEncoding="base64";break;case"pattern:zod":_6(r,_Y,a.message,t)}break;case"nanoid":_6(r,_0,a.message,t)}return r}function _3(e,t){return"escape"===t.patternStrategy?function(e){let t="";for(let r=0;r<e.length;r++)_5.has(e[r])||(t+="\\"),t+=e[r];return t}(e):e}var _5=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function _4(e,t,r,a){var s;e.format||(null==(s=e.anyOf)?void 0:s.some(e=>e.format))?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format}),delete e.format),e.anyOf.push({format:t,...r&&a.errorMessages&&{errorMessage:{format:r}}})):e.format=t}function _6(e,t,r,a){var s;e.pattern||(null==(s=e.allOf)?void 0:s.some(e=>e.pattern))?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern}),delete e.pattern),e.allOf.push({pattern:_7(t,a),...r&&a.errorMessages&&{errorMessage:{pattern:r}}})):e.pattern=_7(t,a)}function _7(e,t){var r;if(!t.applyRegexFlags||!e.flags)return e.source;let a={i:e.flags.includes("i"),m:e.flags.includes("m"),s:e.flags.includes("s")},s=a.i?e.source.toLowerCase():e.source,n="",i=!1,o=!1,l=!1;for(let e=0;e<s.length;e++){if(i){n+=s[e],i=!1;continue}if(a.i){if(o){if(s[e].match(/[a-z]/)){l?(n+=s[e],n+=`${s[e-2]}-${s[e]}`.toUpperCase(),l=!1):"-"===s[e+1]&&(null==(r=s[e+2])?void 0:r.match(/[a-z]/))?(n+=s[e],l=!0):n+=`${s[e]}${s[e].toUpperCase()}`;continue}}else if(s[e].match(/[a-z]/)){n+=`[${s[e]}${s[e].toUpperCase()}]`;continue}}if(a.m){if("^"===s[e]){n+=`(^|(?<=[\r
]))`;continue}else if("$"===s[e]){n+=`($|(?=[\r
]))`;continue}}if(a.s&&"."===s[e]){n+=o?`${s[e]}\r
`:`[${s[e]}\r
]`;continue}n+=s[e],"\\"===s[e]?i=!0:o&&"]"===s[e]?o=!1:o||"["!==s[e]||(o=!0)}return n}function _9(e,t){var r,a,s,n,i,o;let l={type:"object",additionalProperties:null!=(r=Ie(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]}))?r:t.allowedAdditionalProperties};if((null==(a=e.keyType)?void 0:a._def.typeName)===eZ.ZodFirstPartyTypeKind.ZodString&&(null==(s=e.keyType._def.checks)?void 0:s.length)){let{type:r,...a}=_2(e.keyType._def,t);return{...l,propertyNames:a}}if((null==(n=e.keyType)?void 0:n._def.typeName)===eZ.ZodFirstPartyTypeKind.ZodEnum)return{...l,propertyNames:{enum:e.keyType._def.values}};if((null==(i=e.keyType)?void 0:i._def.typeName)===eZ.ZodFirstPartyTypeKind.ZodBranded&&e.keyType._def.type._def.typeName===eZ.ZodFirstPartyTypeKind.ZodString&&(null==(o=e.keyType._def.type._def.checks)?void 0:o.length)){let{type:r,...a}=_Z(e.keyType._def,t);return{...l,propertyNames:a}}return l}var _8={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function Ie(e,t,r=!1){var a;let s=t.seen.get(e);if(t.override){let n=null==(a=t.override)?void 0:a.call(t,e,t,s,r);if(n!==_F)return n}if(s&&!r){let e=It(s,t);if(void 0!==e)return e}let n={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,n);let i=((e,t,r)=>{var a,s,n,i,o,l;switch(t){case eZ.ZodFirstPartyTypeKind.ZodString:return _2(e,r);case eZ.ZodFirstPartyTypeKind.ZodNumber:let u={type:"number"};if(!e.checks)return u;for(let t of e.checks)switch(t.kind){case"int":u.type="integer";break;case"min":t.inclusive?u.minimum=t.value:u.exclusiveMinimum=t.value;break;case"max":t.inclusive?u.maximum=t.value:u.exclusiveMaximum=t.value;break;case"multipleOf":u.multipleOf=t.value}return u;case eZ.ZodFirstPartyTypeKind.ZodObject:return function(e,t){let r={type:"object",properties:{}},a=[],s=e.shape();for(let e in s){let n=s[e];if(void 0===n||void 0===n._def)continue;let i=function(e){try{return e.isOptional()}catch(e){return!0}}(n),o=Ie(n._def,{...t,currentPath:[...t.currentPath,"properties",e],propertyPath:[...t.currentPath,"properties",e]});void 0!==o&&(r.properties[e]=o,i||a.push(e))}a.length&&(r.required=a);let n=function(e,t){if("ZodNever"!==e.catchall._def.typeName)return Ie(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]});switch(e.unknownKeys){case"passthrough":return t.allowedAdditionalProperties;case"strict":return t.rejectedAdditionalProperties;case"strip":return"strict"===t.removeAdditionalStrategy?t.allowedAdditionalProperties:t.rejectedAdditionalProperties}}(e,t);return void 0!==n&&(r.additionalProperties=n),r}(e,r);case eZ.ZodFirstPartyTypeKind.ZodBigInt:let p={type:"integer",format:"int64"};if(!e.checks)return p;for(let t of e.checks)switch(t.kind){case"min":t.inclusive?p.minimum=t.value:p.exclusiveMinimum=t.value;break;case"max":t.inclusive?p.maximum=t.value:p.exclusiveMaximum=t.value;break;case"multipleOf":p.multipleOf=t.value}return p;case eZ.ZodFirstPartyTypeKind.ZodBoolean:return{type:"boolean"};case eZ.ZodFirstPartyTypeKind.ZodDate:return function e(t,r,a){let s=null!=a?a:r.dateStrategy;if(Array.isArray(s))return{anyOf:s.map((a,s)=>e(t,r,a))};switch(s){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":var n=t;let i={type:"integer",format:"unix-time"};for(let e of n.checks)switch(e.kind){case"min":i.minimum=e.value;break;case"max":i.maximum=e.value}return i}}(e,r);case eZ.ZodFirstPartyTypeKind.ZodUndefined:return{not:{}};case eZ.ZodFirstPartyTypeKind.ZodNull:return{type:"null"};case eZ.ZodFirstPartyTypeKind.ZodArray:let d;return d={type:"array"},(null==(n=e.type)?void 0:n._def)&&(null==(o=null==(i=e.type)?void 0:i._def)?void 0:o.typeName)!==eZ.ZodFirstPartyTypeKind.ZodAny&&(d.items=Ie(e.type._def,{...r,currentPath:[...r.currentPath,"items"]})),e.minLength&&(d.minItems=e.minLength.value),e.maxLength&&(d.maxItems=e.maxLength.value),e.exactLength&&(d.minItems=e.exactLength.value,d.maxItems=e.exactLength.value),d;case eZ.ZodFirstPartyTypeKind.ZodUnion:case eZ.ZodFirstPartyTypeKind.ZodDiscriminatedUnion:let c,m=e.options instanceof Map?Array.from(e.options.values()):e.options;if(m.every(e=>e._def.typeName in _8&&(!e._def.checks||!e._def.checks.length))){let e=m.reduce((e,t)=>{let r=_8[t._def.typeName];return r&&!e.includes(r)?[...e,r]:e},[]);return{type:e.length>1?e:e[0]}}if(m.every(e=>"ZodLiteral"===e._def.typeName&&!e.description)){let e=m.reduce((e,t)=>{let r=typeof t._def.value;switch(r){case"string":case"number":case"boolean":return[...e,r];case"bigint":return[...e,"integer"];case"object":if(null===t._def.value)return[...e,"null"];default:return e}},[]);if(e.length===m.length){let t=e.filter((e,t,r)=>r.indexOf(e)===t);return{type:t.length>1?t:t[0],enum:m.reduce((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value],[])}}}else if(m.every(e=>"ZodEnum"===e._def.typeName))return{type:"string",enum:m.reduce((e,t)=>[...e,...t._def.values.filter(t=>!e.includes(t))],[])};return a=e,s=r,(c=(a.options instanceof Map?Array.from(a.options.values()):a.options).map((e,t)=>Ie(e._def,{...s,currentPath:[...s.currentPath,"anyOf",`${t}`]})).filter(e=>!!e&&(!s.strictUnions||"object"==typeof e&&Object.keys(e).length>0))).length?{anyOf:c}:void 0;case eZ.ZodFirstPartyTypeKind.ZodIntersection:let g,h;return g=[Ie(e.left._def,{...r,currentPath:[...r.currentPath,"allOf","0"]}),Ie(e.right._def,{...r,currentPath:[...r.currentPath,"allOf","1"]})].filter(e=>!!e),h=[],g.forEach(e=>{if((!("type"in e)||"string"!==e.type)&&"allOf"in e)h.push(...e.allOf);else{let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){let{additionalProperties:r,...a}=e;t=a}h.push(t)}}),h.length?{allOf:h}:void 0;case eZ.ZodFirstPartyTypeKind.ZodTuple:return e.rest?{type:"array",minItems:e.items.length,items:e.items.map((e,t)=>Ie(e._def,{...r,currentPath:[...r.currentPath,"items",`${t}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[]),additionalItems:Ie(e.rest._def,{...r,currentPath:[...r.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map((e,t)=>Ie(e._def,{...r,currentPath:[...r.currentPath,"items",`${t}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[])};case eZ.ZodFirstPartyTypeKind.ZodRecord:return _9(e,r);case eZ.ZodFirstPartyTypeKind.ZodLiteral:let f;return"bigint"!=(f=typeof e.value)&&"number"!==f&&"boolean"!==f&&"string"!==f?{type:Array.isArray(e.value)?"array":"object"}:{type:"bigint"===f?"integer":f,const:e.value};case eZ.ZodFirstPartyTypeKind.ZodEnum:return{type:"string",enum:Array.from(e.values)};case eZ.ZodFirstPartyTypeKind.ZodNativeEnum:let y,v,b;return y=e.values,{type:1===(b=Array.from(new Set((v=Object.keys(e.values).filter(e=>"number"!=typeof y[y[e]]).map(e=>y[e])).map(e=>typeof e)))).length?"string"===b[0]?"string":"number":["string","number"],enum:v};case eZ.ZodFirstPartyTypeKind.ZodNullable:if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return{type:[_8[e.innerType._def.typeName],"null"]};let w=Ie(e.innerType._def,{...r,currentPath:[...r.currentPath,"anyOf","0"]});return w&&{anyOf:[w,{type:"null"}]};case eZ.ZodFirstPartyTypeKind.ZodOptional:if(r.currentPath.toString()===(null==(l=r.propertyPath)?void 0:l.toString()))return Ie(e.innerType._def,r);let k=Ie(e.innerType._def,{...r,currentPath:[...r.currentPath,"anyOf","1"]});return k?{anyOf:[{not:{}},k]}:{};case eZ.ZodFirstPartyTypeKind.ZodMap:if("record"===r.mapStrategy)return _9(e,r);return{type:"array",maxItems:125,items:{type:"array",items:[Ie(e.keyType._def,{...r,currentPath:[...r.currentPath,"items","items","0"]})||{},Ie(e.valueType._def,{...r,currentPath:[...r.currentPath,"items","items","1"]})||{}],minItems:2,maxItems:2}};case eZ.ZodFirstPartyTypeKind.ZodSet:let _;return _={type:"array",uniqueItems:!0,items:Ie(e.valueType._def,{...r,currentPath:[...r.currentPath,"items"]})},e.minSize&&(_.minItems=e.minSize.value),e.maxSize&&(_.maxItems=e.maxSize.value),_;case eZ.ZodFirstPartyTypeKind.ZodLazy:return()=>e.getter()._def;case eZ.ZodFirstPartyTypeKind.ZodPromise:return Ie(e.type._def,r);case eZ.ZodFirstPartyTypeKind.ZodNaN:case eZ.ZodFirstPartyTypeKind.ZodNever:return{not:{}};case eZ.ZodFirstPartyTypeKind.ZodEffects:return"input"===r.effectStrategy?Ie(e.schema._def,r):{};case eZ.ZodFirstPartyTypeKind.ZodAny:case eZ.ZodFirstPartyTypeKind.ZodUnknown:return{};case eZ.ZodFirstPartyTypeKind.ZodDefault:return{...Ie(e.innerType._def,r),default:e.defaultValue()};case eZ.ZodFirstPartyTypeKind.ZodBranded:return _Z(e,r);case eZ.ZodFirstPartyTypeKind.ZodReadonly:case eZ.ZodFirstPartyTypeKind.ZodCatch:return Ie(e.innerType._def,r);case eZ.ZodFirstPartyTypeKind.ZodPipeline:if("input"===r.pipeStrategy)return Ie(e.in._def,r);if("output"===r.pipeStrategy)return Ie(e.out._def,r);let I=Ie(e.in._def,{...r,currentPath:[...r.currentPath,"allOf","0"]}),S=Ie(e.out._def,{...r,currentPath:[...r.currentPath,"allOf",I?"1":"0"]});return{allOf:[I,S].filter(e=>void 0!==e)};case eZ.ZodFirstPartyTypeKind.ZodFunction:case eZ.ZodFirstPartyTypeKind.ZodVoid:case eZ.ZodFirstPartyTypeKind.ZodSymbol:default:return}})(e,e.typeName,t),o="function"==typeof i?Ie(i(),t):i;if(o&&Ir(e,t,o),t.postProcess){let r=t.postProcess(o,e,t);return n.jsonSchema=o,r}return n.jsonSchema=o,o}var It=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"relative":return{$ref:((e,t)=>{let r=0;for(;r<e.length&&r<t.length&&e[r]===t[r];r++);return[(e.length-r).toString(),...t.slice(r)].join("/")})(t.currentPath,e.path)};case"none":case"seen":if(e.path.length<t.currentPath.length&&e.path.every((e,r)=>t.currentPath[r]===e))return console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),{};return"seen"===t.$refStrategy?{}:void 0}},Ir=(e,t,r)=>(e.description&&(r.description=e.description),r),Ia=Symbol.for("vercel.ai.schema");function Is(e,{validate:t}={}){return{[Ia]:!0,_type:void 0,[_D]:!0,get jsonSchema(){return"function"==typeof e&&(e=e()),e},validate:t}}var In=Object.defineProperty,Ii="AI_NoObjectGeneratedError",Io=`vercel.ai.error.${Ii}`,Il=Symbol.for(Io),Iu=class extends _b{constructor({message:e="No object generated.",cause:t,text:r,response:a,usage:s,finishReason:n}){super({name:Ii,message:e,cause:t}),this[K]=!0,this.text=r,this.response=a,this.usage=s,this.finishReason=n}static isInstance(e){return _b.hasMarker(e,Io)}};K=Il;var Ip=eU.z.union([eU.z.string(),eU.z.instanceof(Uint8Array),eU.z.instanceof(ArrayBuffer),eU.z.custom(e=>{var t,r;return null!=(r=null==(t=globalThis.Buffer)?void 0:t.isBuffer(e))&&r},{message:"Must be a Buffer"})]),Id=eU.z.lazy(()=>eU.z.union([eU.z.null(),eU.z.string(),eU.z.number(),eU.z.boolean(),eU.z.record(eU.z.string(),Id),eU.z.array(Id)])),Ic=eU.z.record(eU.z.string(),eU.z.record(eU.z.string(),Id)),Im=eU.z.object({type:eU.z.literal("text"),text:eU.z.string(),providerOptions:Ic.optional()}),Ig=eU.z.object({type:eU.z.literal("image"),image:eU.z.union([Ip,eU.z.instanceof(URL)]),mediaType:eU.z.string().optional(),providerOptions:Ic.optional()}),Ih=eU.z.object({type:eU.z.literal("file"),data:eU.z.union([Ip,eU.z.instanceof(URL)]),filename:eU.z.string().optional(),mediaType:eU.z.string(),providerOptions:Ic.optional()}),If=eU.z.object({type:eU.z.literal("reasoning"),text:eU.z.string(),providerOptions:Ic.optional()}),Iy=eU.z.object({type:eU.z.literal("tool-call"),toolCallId:eU.z.string(),toolName:eU.z.string(),input:eU.z.unknown(),providerOptions:Ic.optional(),providerExecuted:eU.z.boolean().optional()}),Iv=eU.z.discriminatedUnion("type",[eU.z.object({type:eU.z.literal("text"),value:eU.z.string()}),eU.z.object({type:eU.z.literal("json"),value:Id}),eU.z.object({type:eU.z.literal("error-text"),value:eU.z.string()}),eU.z.object({type:eU.z.literal("error-json"),value:Id}),eU.z.object({type:eU.z.literal("content"),value:eU.z.array(eU.z.union([eU.z.object({type:eU.z.literal("text"),text:eU.z.string()}),eU.z.object({type:eU.z.literal("media"),data:eU.z.string(),mediaType:eU.z.string()})]))})]),Ib=eU.z.object({type:eU.z.literal("tool-result"),toolCallId:eU.z.string(),toolName:eU.z.string(),output:Iv,providerOptions:Ic.optional()}),Iw=eU.z.object({role:eU.z.literal("system"),content:eU.z.string(),providerOptions:Ic.optional()}),Ik=eU.z.object({role:eU.z.literal("user"),content:eU.z.union([eU.z.string(),eU.z.array(eU.z.union([Im,Ig,Ih]))]),providerOptions:Ic.optional()}),I_=eU.z.object({role:eU.z.literal("assistant"),content:eU.z.union([eU.z.string(),eU.z.array(eU.z.union([Im,Ih,If,Iy,Ib]))]),providerOptions:Ic.optional()}),II=eU.z.object({role:eU.z.literal("tool"),content:eU.z.array(Ib),providerOptions:Ic.optional()});async function IS(e){if(void 0===e)return{value:void 0,state:"undefined-input"};let t=await _$({text:e});return t.success?{value:t.value,state:"successful-parse"}:(t=await _$({text:function(e){let t=["ROOT"],r=-1,a=null;function s(e,s,n){switch(e){case'"':r=s,t.pop(),t.push(n),t.push("INSIDE_STRING");break;case"f":case"t":case"n":r=s,a=s,t.pop(),t.push(n),t.push("INSIDE_LITERAL");break;case"-":t.pop(),t.push(n),t.push("INSIDE_NUMBER");break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":r=s,t.pop(),t.push(n),t.push("INSIDE_NUMBER");break;case"{":r=s,t.pop(),t.push(n),t.push("INSIDE_OBJECT_START");break;case"[":r=s,t.pop(),t.push(n),t.push("INSIDE_ARRAY_START")}}function n(e,a){switch(e){case",":t.pop(),t.push("INSIDE_OBJECT_AFTER_COMMA");break;case"}":r=a,t.pop()}}function i(e,a){switch(e){case",":t.pop(),t.push("INSIDE_ARRAY_AFTER_COMMA");break;case"]":r=a,t.pop()}}for(let o=0;o<e.length;o++){let l=e[o];switch(t[t.length-1]){case"ROOT":s(l,o,"FINISH");break;case"INSIDE_OBJECT_START":switch(l){case'"':t.pop(),t.push("INSIDE_OBJECT_KEY");break;case"}":r=o,t.pop()}break;case"INSIDE_OBJECT_AFTER_COMMA":'"'===l&&(t.pop(),t.push("INSIDE_OBJECT_KEY"));break;case"INSIDE_OBJECT_KEY":'"'===l&&(t.pop(),t.push("INSIDE_OBJECT_AFTER_KEY"));break;case"INSIDE_OBJECT_AFTER_KEY":":"===l&&(t.pop(),t.push("INSIDE_OBJECT_BEFORE_VALUE"));break;case"INSIDE_OBJECT_BEFORE_VALUE":s(l,o,"INSIDE_OBJECT_AFTER_VALUE");break;case"INSIDE_OBJECT_AFTER_VALUE":n(l,o);break;case"INSIDE_STRING":switch(l){case'"':t.pop(),r=o;break;case"\\":t.push("INSIDE_STRING_ESCAPE");break;default:r=o}break;case"INSIDE_ARRAY_START":"]"===l?(r=o,t.pop()):(r=o,s(l,o,"INSIDE_ARRAY_AFTER_VALUE"));break;case"INSIDE_ARRAY_AFTER_VALUE":switch(l){case",":t.pop(),t.push("INSIDE_ARRAY_AFTER_COMMA");break;case"]":r=o,t.pop();break;default:r=o}break;case"INSIDE_ARRAY_AFTER_COMMA":s(l,o,"INSIDE_ARRAY_AFTER_VALUE");break;case"INSIDE_STRING_ESCAPE":t.pop(),r=o;break;case"INSIDE_NUMBER":switch(l){case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":r=o;break;case"e":case"E":case"-":case".":break;case",":t.pop(),"INSIDE_ARRAY_AFTER_VALUE"===t[t.length-1]&&i(l,o),"INSIDE_OBJECT_AFTER_VALUE"===t[t.length-1]&&n(l,o);break;case"}":t.pop(),"INSIDE_OBJECT_AFTER_VALUE"===t[t.length-1]&&n(l,o);break;case"]":t.pop(),"INSIDE_ARRAY_AFTER_VALUE"===t[t.length-1]&&i(l,o);break;default:t.pop()}break;case"INSIDE_LITERAL":{let s=e.substring(a,o+1);"false".startsWith(s)||"true".startsWith(s)||"null".startsWith(s)?r=o:(t.pop(),"INSIDE_OBJECT_AFTER_VALUE"===t[t.length-1]?n(l,o):"INSIDE_ARRAY_AFTER_VALUE"===t[t.length-1]&&i(l,o))}}}let o=e.slice(0,r+1);for(let r=t.length-1;r>=0;r--)switch(t[r]){case"INSIDE_STRING":o+='"';break;case"INSIDE_OBJECT_KEY":case"INSIDE_OBJECT_AFTER_KEY":case"INSIDE_OBJECT_AFTER_COMMA":case"INSIDE_OBJECT_START":case"INSIDE_OBJECT_BEFORE_VALUE":case"INSIDE_OBJECT_AFTER_VALUE":o+="}";break;case"INSIDE_ARRAY_START":case"INSIDE_ARRAY_AFTER_COMMA":case"INSIDE_ARRAY_AFTER_VALUE":o+="]";break;case"INSIDE_LITERAL":{let t=e.substring(a,e.length);"true".startsWith(t)?o+="true".slice(t.length):"false".startsWith(t)?o+="false".slice(t.length):"null".startsWith(t)&&(o+="null".slice(t.length))}}return o}(e)})).success?{value:t.value,state:"repaired-parse"}:{value:void 0,state:"failed-parse"}}eU.z.union([Iw,Ik,I_,II]),_R({prefix:"aitxt",size:24}),TransformStream,_R({prefix:"aitxt",size:24}),_R({prefix:"aiobj",size:24}),_R({prefix:"aiobj",size:24});var Ix={},IT={object:()=>IO,text:()=>IA};for(var IE in IT)In(Ix,IE,{get:IT[IE],enumerable:!0});var IA=()=>({type:"text",responseFormat:{type:"text"},parsePartial:async({text:e})=>({partial:e}),parseOutput:async({text:e})=>e}),IO=({schema:e})=>{var t;let r=null==e?Is({properties:{},additionalProperties:!1}):"object"==typeof e&&null!==e&&Ia in e&&!0===e[Ia]&&"jsonSchema"in e&&"validate"in e?e:"function"==typeof e?e():"_zod"in(t=e)?Is(()=>eF.toJSONSchema(t,{target:"draft-7",io:"output",reused:"inline"}),{validate:async e=>{let r=await e$.safeParseAsync(t,e);return r.success?{success:!0,value:r.data}:{success:!1,error:r.error}}}):Is(()=>((e,t)=>{var r;let a,s,n=(s=void 0!==(a="string"==typeof t?{..._U,name:t}:{..._U,...t}).name?[...a.basePath,a.definitionPath,a.name]:a.basePath,{...a,currentPath:s,propertyPath:void 0,seen:new Map(Object.entries(a.definitions).map(([e,t])=>[t._def,{def:t._def,path:[...a.basePath,a.definitionPath,e],jsonSchema:void 0}]))}),i="object"==typeof t&&t.definitions?Object.entries(t.definitions).reduce((e,[t,r])=>{var a;return{...e,[t]:null!=(a=Ie(r._def,{...n,currentPath:[...n.basePath,n.definitionPath,t]},!0))?a:{}}},{}):void 0,o="string"==typeof t?t:(null==t?void 0:t.nameStrategy)==="title"||null==t?void 0:t.name,l=null!=(r=Ie(e._def,void 0===o?n:{...n,currentPath:[...n.basePath,n.definitionPath,o]},!1))?r:{},u="object"==typeof t&&void 0!==t.name&&"title"===t.nameStrategy?t.name:void 0;void 0!==u&&(l.title=u);let p=void 0===o?i?{...l,[n.definitionPath]:i}:l:{$ref:[..."relative"===n.$refStrategy?[]:n.basePath,n.definitionPath,o].join("/"),[n.definitionPath]:{...i,[o]:l}};return p.$schema="http://json-schema.org/draft-07/schema#",p})(t,{$refStrategy:"none"}),{validate:async e=>{let r=await t.safeParseAsync(e);return r.success?{success:!0,value:r.data}:{success:!1,error:r.error}}});return{type:"object",responseFormat:{type:"json",schema:r.jsonSchema},async parsePartial({text:e}){let t=await IS(e);switch(t.state){case"failed-parse":case"undefined-input":return;case"repaired-parse":case"successful-parse":return{partial:t.value};default:{let e=t.state;throw Error(`Unsupported parse state: ${e}`)}}},async parseOutput({text:e},t){let a=await _$({text:e});if(!a.success)throw new Iu({message:"No object generated: could not parse the response.",cause:a.error,text:e,response:t.response,usage:t.usage,finishReason:t.finishReason});let s=await _q({value:a.value,schema:r});if(!s.success)throw new Iu({message:"No object generated: response did not match schema.",cause:s.error,text:e,response:t.response,usage:t.usage,finishReason:t.finishReason});return s.value}}},Iz="vercel.ai.error",IM=Symbol.for(Iz),IP=class e extends(W=Error,G=IM,W){constructor({name:e,message:t,cause:r}){super(t),this[G]=!0,this.name=e,this.cause=r}static isInstance(t){return e.hasMarker(t,Iz)}static hasMarker(e,t){let r=Symbol.for(t);return null!=e&&"object"==typeof e&&r in e&&"boolean"==typeof e[r]&&!0===e[r]}},IR="AI_APICallError",IC=`vercel.ai.error.${IR}`,Ij=Symbol.for(IC),IN=class extends(J=IP,Q=Ij,J){constructor({message:e,url:t,requestBodyValues:r,statusCode:a,responseHeaders:s,responseBody:n,cause:i,isRetryable:o=null!=a&&(408===a||409===a||429===a||a>=500),data:l}){super({name:IR,message:e,cause:i}),this[Q]=!0,this.url=t,this.requestBodyValues=r,this.statusCode=a,this.responseHeaders=s,this.responseBody=n,this.isRetryable=o,this.data=l}static isInstance(e){return IP.hasMarker(e,IC)}},IL="AI_EmptyResponseBodyError",ID=`vercel.ai.error.${IL}`,Iq=Symbol.for(ID),I$=class extends(Y=IP,H=Iq,Y){constructor({message:e="Empty response body"}={}){super({name:IL,message:e}),this[H]=!0}static isInstance(e){return IP.hasMarker(e,ID)}};function IF(e){return null==e?"unknown error":"string"==typeof e?e:e instanceof Error?e.message:JSON.stringify(e)}var IU="AI_InvalidArgumentError",IZ=`vercel.ai.error.${IU}`,IB=Symbol.for(IZ),IV=class extends(ee=IP,X=IB,ee){constructor({message:e,cause:t,argument:r}){super({name:IU,message:e,cause:t}),this[X]=!0,this.argument=r}static isInstance(e){return IP.hasMarker(e,IZ)}},IK=Symbol.for("vercel.ai.error.AI_InvalidPromptError");Symbol.for("vercel.ai.error.AI_InvalidResponseDataError");var IG="AI_JSONParseError",IW=`vercel.ai.error.${IG}`,IQ=Symbol.for(IW),IJ=class extends(er=IP,et=IQ,er){constructor({text:e,cause:t}){super({name:IG,message:`JSON parsing failed: Text: ${e}.
Error message: ${IF(t)}`,cause:t}),this[et]=!0,this.text=e}static isInstance(e){return IP.hasMarker(e,IW)}},IH=Symbol.for("vercel.ai.error.AI_LoadAPIKeyError");Symbol.for("vercel.ai.error.AI_LoadSettingError");Symbol.for("vercel.ai.error.AI_NoContentGeneratedError");Symbol.for("vercel.ai.error.AI_NoSuchModelError");Symbol.for("vercel.ai.error.AI_TooManyEmbeddingValuesForCallError");var IY="AI_TypeValidationError",IX=`vercel.ai.error.${IY}`,I0=Symbol.for(IX),I1=class e extends(es=IP,ea=I0,es){constructor({value:e,cause:t}){super({name:IY,message:`Type validation failed: Value: ${JSON.stringify(e)}.
Error message: ${IF(t)}`,cause:t}),this[ea]=!0,this.value=e}static isInstance(e){return IP.hasMarker(e,IX)}static wrap({value:t,cause:r}){return e.isInstance(r)&&r.value===t?r:new e({value:t,cause:r})}},I2=Symbol.for("vercel.ai.error.AI_UnsupportedFunctionalityError");function I3(...e){return e.reduce((e,t)=>({...e,...null!=t?t:{}}),{})}function I5(e){return Object.fromEntries([...e.headers])}var{btoa:I4,atob:I6}=globalThis,I7=Symbol.for("vercel.ai.error.AI_DownloadError"),I9=({prefix:e,size:t=16,alphabet:r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",separator:a="-"}={})=>{let s=()=>{let e=r.length,a=Array(t);for(let s=0;s<t;s++)a[s]=r[Math.random()*e|0];return a.join("")};if(null==e)return s;if(r.includes(a))throw new IV({argument:"separator",message:`The separator "${a}" must not be part of the alphabet "${r}".`});return()=>`${e}${a}${s()}`};function I8(e){return(e instanceof Error||e instanceof DOMException)&&("AbortError"===e.name||"ResponseAborted"===e.name||"TimeoutError"===e.name)}I9();var Se=["fetch failed","failed to fetch"];function St({error:e,url:t,requestBodyValues:r}){if(I8(e))return e;if(e instanceof TypeError&&Se.includes(e.message.toLowerCase())){let a=e.cause;if(null!=a)return new IN({message:`Cannot connect to API: ${a.message}`,cause:a,url:t,requestBodyValues:r,isRetryable:!0})}return e}function Sr(e=globalThis){var t,r,a;return e.window?"runtime/browser":(null==(t=e.navigator)?void 0:t.userAgent)?`runtime/${e.navigator.userAgent.toLowerCase()}`:(null==(a=null==(r=e.process)?void 0:r.versions)?void 0:a.node)?`runtime/node.js/${e.process.version.substring(0)}`:e.EdgeRuntime?"runtime/vercel-edge":"runtime/unknown"}function Sa(e,...t){let r=new Headers(function(e){if(null==e)return{};let t={};if(e instanceof Headers)e.forEach((e,r)=>{t[r.toLowerCase()]=e});else for(let[r,a]of(Array.isArray(e)||(e=Object.entries(e)),e))null!=a&&(t[r.toLowerCase()]=a);return t}(e)),a=r.get("user-agent")||"";return r.set("user-agent",[a,...t].filter(Boolean).join(" ")),Object.fromEntries(r.entries())}var Ss="4.0.9",Sn=()=>globalThis.fetch,Si=async({url:e,headers:t={},successfulResponseHandler:r,failedResponseHandler:a,abortSignal:s,fetch:n=Sn()})=>{try{let i=await n(e,{method:"GET",headers:Sa(t,`ai-sdk/provider-utils/${Ss}`,Sr()),signal:s}),o=I5(i);if(!i.ok){let t;try{t=await a({response:i,url:e,requestBodyValues:{}})}catch(t){if(I8(t)||IN.isInstance(t))throw t;throw new IN({message:"Failed to process error response",cause:t,statusCode:i.status,url:e,responseHeaders:o,requestBodyValues:{}})}throw t.value}try{return await r({response:i,url:e,requestBodyValues:{}})}catch(t){if(t instanceof Error&&(I8(t)||IN.isInstance(t)))throw t;throw new IN({message:"Failed to process successful response",cause:t,statusCode:i.status,url:e,responseHeaders:o,requestBodyValues:{}})}}catch(t){throw St({error:t,url:e,requestBodyValues:{}})}};function So({settingValue:e,environmentVariableName:t}){return"string"==typeof e?e:null!=e||"u"<typeof process?void 0:null!=(e=process.env[t])&&"string"==typeof e?e:void 0}var Sl=/"__proto__"\s*:/,Su=/"constructor"\s*:/;function Sp(e){let t=JSON.parse(e);return null===t||"object"!=typeof t||!1===Sl.test(e)&&!1===Su.test(e)?t:function(e){let t=[e];for(;t.length;){let e=t;for(let r of(t=[],e)){if(Object.prototype.hasOwnProperty.call(r,"__proto__")||Object.prototype.hasOwnProperty.call(r,"constructor")&&Object.prototype.hasOwnProperty.call(r.constructor,"prototype"))throw SyntaxError("Object contains forbidden prototype property");for(let e in r){let a=r[e];a&&"object"==typeof a&&t.push(a)}}}return e}(t)}function Sd(e){let{stackTraceLimit:t}=Error;try{Error.stackTraceLimit=0}catch(t){return Sp(e)}try{return Sp(e)}finally{Error.stackTraceLimit=t}}function Sc(e){if("object"===e.type||Array.isArray(e.type)&&e.type.includes("object")){e.additionalProperties=!1;let{properties:t}=e;if(null!=t)for(let e of Object.keys(t))t[e]=Sm(t[e])}null!=e.items&&(e.items=Array.isArray(e.items)?e.items.map(Sm):Sm(e.items)),null!=e.anyOf&&(e.anyOf=e.anyOf.map(Sm)),null!=e.allOf&&(e.allOf=e.allOf.map(Sm)),null!=e.oneOf&&(e.oneOf=e.oneOf.map(Sm));let{definitions:t}=e;if(null!=t)for(let e of Object.keys(t))t[e]=Sm(t[e]);return e}function Sm(e){return"boolean"==typeof e?e:Sc(e)}var Sg=Symbol("Let zodToJsonSchema decide on which parser to use"),Sh={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",allowedAdditionalProperties:!0,rejectedAdditionalProperties:!1,definitionPath:"definitions",strictUnions:!1,definitions:{},errorMessages:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"};function Sf(e,t){return SL(e.type._def,t)}var Sy=void 0,Sv=/^[cC][^\s-]{8,}$/,Sb=/^[0-9a-z]+$/,Sw=/^[0-9A-HJKMNP-TV-Z]{26}$/,Sk=/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,S_=()=>(void 0===Sy&&(Sy=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),Sy),SI=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,SS=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,Sx=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,ST=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,SE=/^[a-zA-Z0-9_-]{21}$/,SA=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/;function SO(e,t){let r={type:"string"};if(e.checks)for(let a of e.checks)switch(a.kind){case"min":r.minLength="number"==typeof r.minLength?Math.max(r.minLength,a.value):a.value;break;case"max":r.maxLength="number"==typeof r.maxLength?Math.min(r.maxLength,a.value):a.value;break;case"email":switch(t.emailStrategy){case"format:email":SP(r,"email",a.message,t);break;case"format:idn-email":SP(r,"idn-email",a.message,t);break;case"pattern:zod":SR(r,Sk,a.message,t)}break;case"url":SP(r,"uri",a.message,t);break;case"uuid":SP(r,"uuid",a.message,t);break;case"regex":SR(r,a.regex,a.message,t);break;case"cuid":SR(r,Sv,a.message,t);break;case"cuid2":SR(r,Sb,a.message,t);break;case"startsWith":SR(r,RegExp(`^${Sz(a.value,t)}`),a.message,t);break;case"endsWith":SR(r,RegExp(`${Sz(a.value,t)}$`),a.message,t);break;case"datetime":SP(r,"date-time",a.message,t);break;case"date":SP(r,"date",a.message,t);break;case"time":SP(r,"time",a.message,t);break;case"duration":SP(r,"duration",a.message,t);break;case"length":r.minLength="number"==typeof r.minLength?Math.max(r.minLength,a.value):a.value,r.maxLength="number"==typeof r.maxLength?Math.min(r.maxLength,a.value):a.value;break;case"includes":SR(r,RegExp(Sz(a.value,t)),a.message,t);break;case"ip":"v6"!==a.version&&SP(r,"ipv4",a.message,t),"v4"!==a.version&&SP(r,"ipv6",a.message,t);break;case"base64url":SR(r,ST,a.message,t);break;case"jwt":SR(r,SA,a.message,t);break;case"cidr":"v6"!==a.version&&SR(r,SI,a.message,t),"v4"!==a.version&&SR(r,SS,a.message,t);break;case"emoji":SR(r,S_(),a.message,t);break;case"ulid":SR(r,Sw,a.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":SP(r,"binary",a.message,t);break;case"contentEncoding:base64":r.contentEncoding="base64";break;case"pattern:zod":SR(r,Sx,a.message,t)}break;case"nanoid":SR(r,SE,a.message,t)}return r}function Sz(e,t){return"escape"===t.patternStrategy?function(e){let t="";for(let r=0;r<e.length;r++)SM.has(e[r])||(t+="\\"),t+=e[r];return t}(e):e}var SM=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function SP(e,t,r,a){var s;e.format||(null==(s=e.anyOf)?void 0:s.some(e=>e.format))?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format}),delete e.format),e.anyOf.push({format:t,...r&&a.errorMessages&&{errorMessage:{format:r}}})):e.format=t}function SR(e,t,r,a){var s;e.pattern||(null==(s=e.allOf)?void 0:s.some(e=>e.pattern))?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern}),delete e.pattern),e.allOf.push({pattern:SC(t,a),...r&&a.errorMessages&&{errorMessage:{pattern:r}}})):e.pattern=SC(t,a)}function SC(e,t){var r;if(!t.applyRegexFlags||!e.flags)return e.source;let a={i:e.flags.includes("i"),m:e.flags.includes("m"),s:e.flags.includes("s")},s=a.i?e.source.toLowerCase():e.source,n="",i=!1,o=!1,l=!1;for(let e=0;e<s.length;e++){if(i){n+=s[e],i=!1;continue}if(a.i){if(o){if(s[e].match(/[a-z]/)){l?(n+=s[e],n+=`${s[e-2]}-${s[e]}`.toUpperCase(),l=!1):"-"===s[e+1]&&(null==(r=s[e+2])?void 0:r.match(/[a-z]/))?(n+=s[e],l=!0):n+=`${s[e]}${s[e].toUpperCase()}`;continue}}else if(s[e].match(/[a-z]/)){n+=`[${s[e]}${s[e].toUpperCase()}]`;continue}}if(a.m){if("^"===s[e]){n+=`(^|(?<=[\r
]))`;continue}else if("$"===s[e]){n+=`($|(?=[\r
]))`;continue}}if(a.s&&"."===s[e]){n+=o?`${s[e]}\r
`:`[${s[e]}\r
]`;continue}n+=s[e],"\\"===s[e]?i=!0:o&&"]"===s[e]?o=!1:o||"["!==s[e]||(o=!0)}try{new RegExp(n)}catch(r){return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),e.source}return n}function Sj(e,t){var r,a,s,n,i,o;let l={type:"object",additionalProperties:null!=(r=SL(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]}))?r:t.allowedAdditionalProperties};if((null==(a=e.keyType)?void 0:a._def.typeName)===eZ.ZodFirstPartyTypeKind.ZodString&&(null==(s=e.keyType._def.checks)?void 0:s.length)){let{type:r,...a}=SO(e.keyType._def,t);return{...l,propertyNames:a}}if((null==(n=e.keyType)?void 0:n._def.typeName)===eZ.ZodFirstPartyTypeKind.ZodEnum)return{...l,propertyNames:{enum:e.keyType._def.values}};if((null==(i=e.keyType)?void 0:i._def.typeName)===eZ.ZodFirstPartyTypeKind.ZodBranded&&e.keyType._def.type._def.typeName===eZ.ZodFirstPartyTypeKind.ZodString&&(null==(o=e.keyType._def.type._def.checks)?void 0:o.length)){let{type:r,...a}=Sf(e.keyType._def,t);return{...l,propertyNames:a}}return l}var SN={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function SL(e,t,r=!1){var a;let s=t.seen.get(e);if(t.override){let n=null==(a=t.override)?void 0:a.call(t,e,t,s,r);if(n!==Sg)return n}if(s&&!r){let e=SD(s,t);if(void 0!==e)return e}let n={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,n);let i=((e,t,r)=>{var a,s,n,i,o,l;switch(t){case eZ.ZodFirstPartyTypeKind.ZodString:return SO(e,r);case eZ.ZodFirstPartyTypeKind.ZodNumber:let u={type:"number"};if(!e.checks)return u;for(let t of e.checks)switch(t.kind){case"int":u.type="integer";break;case"min":t.inclusive?u.minimum=t.value:u.exclusiveMinimum=t.value;break;case"max":t.inclusive?u.maximum=t.value:u.exclusiveMaximum=t.value;break;case"multipleOf":u.multipleOf=t.value}return u;case eZ.ZodFirstPartyTypeKind.ZodObject:return function(e,t){let r={type:"object",properties:{}},a=[],s=e.shape();for(let e in s){let n=s[e];if(void 0===n||void 0===n._def)continue;let i=function(e){try{return e.isOptional()}catch(e){return!0}}(n),o=SL(n._def,{...t,currentPath:[...t.currentPath,"properties",e],propertyPath:[...t.currentPath,"properties",e]});void 0!==o&&(r.properties[e]=o,i||a.push(e))}a.length&&(r.required=a);let n=function(e,t){if("ZodNever"!==e.catchall._def.typeName)return SL(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]});switch(e.unknownKeys){case"passthrough":return t.allowedAdditionalProperties;case"strict":return t.rejectedAdditionalProperties;case"strip":return"strict"===t.removeAdditionalStrategy?t.allowedAdditionalProperties:t.rejectedAdditionalProperties}}(e,t);return void 0!==n&&(r.additionalProperties=n),r}(e,r);case eZ.ZodFirstPartyTypeKind.ZodBigInt:let p={type:"integer",format:"int64"};if(!e.checks)return p;for(let t of e.checks)switch(t.kind){case"min":t.inclusive?p.minimum=t.value:p.exclusiveMinimum=t.value;break;case"max":t.inclusive?p.maximum=t.value:p.exclusiveMaximum=t.value;break;case"multipleOf":p.multipleOf=t.value}return p;case eZ.ZodFirstPartyTypeKind.ZodBoolean:return{type:"boolean"};case eZ.ZodFirstPartyTypeKind.ZodDate:return function e(t,r,a){let s=null!=a?a:r.dateStrategy;if(Array.isArray(s))return{anyOf:s.map((a,s)=>e(t,r,a))};switch(s){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":var n=t;let i={type:"integer",format:"unix-time"};for(let e of n.checks)switch(e.kind){case"min":i.minimum=e.value;break;case"max":i.maximum=e.value}return i}}(e,r);case eZ.ZodFirstPartyTypeKind.ZodUndefined:return{not:{}};case eZ.ZodFirstPartyTypeKind.ZodNull:return{type:"null"};case eZ.ZodFirstPartyTypeKind.ZodArray:let d;return d={type:"array"},(null==(n=e.type)?void 0:n._def)&&(null==(o=null==(i=e.type)?void 0:i._def)?void 0:o.typeName)!==eZ.ZodFirstPartyTypeKind.ZodAny&&(d.items=SL(e.type._def,{...r,currentPath:[...r.currentPath,"items"]})),e.minLength&&(d.minItems=e.minLength.value),e.maxLength&&(d.maxItems=e.maxLength.value),e.exactLength&&(d.minItems=e.exactLength.value,d.maxItems=e.exactLength.value),d;case eZ.ZodFirstPartyTypeKind.ZodUnion:case eZ.ZodFirstPartyTypeKind.ZodDiscriminatedUnion:let c,m=e.options instanceof Map?Array.from(e.options.values()):e.options;if(m.every(e=>e._def.typeName in SN&&(!e._def.checks||!e._def.checks.length))){let e=m.reduce((e,t)=>{let r=SN[t._def.typeName];return r&&!e.includes(r)?[...e,r]:e},[]);return{type:e.length>1?e:e[0]}}if(m.every(e=>"ZodLiteral"===e._def.typeName&&!e.description)){let e=m.reduce((e,t)=>{let r=typeof t._def.value;switch(r){case"string":case"number":case"boolean":return[...e,r];case"bigint":return[...e,"integer"];case"object":if(null===t._def.value)return[...e,"null"];default:return e}},[]);if(e.length===m.length){let t=e.filter((e,t,r)=>r.indexOf(e)===t);return{type:t.length>1?t:t[0],enum:m.reduce((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value],[])}}}else if(m.every(e=>"ZodEnum"===e._def.typeName))return{type:"string",enum:m.reduce((e,t)=>[...e,...t._def.values.filter(t=>!e.includes(t))],[])};return a=e,s=r,(c=(a.options instanceof Map?Array.from(a.options.values()):a.options).map((e,t)=>SL(e._def,{...s,currentPath:[...s.currentPath,"anyOf",`${t}`]})).filter(e=>!!e&&(!s.strictUnions||"object"==typeof e&&Object.keys(e).length>0))).length?{anyOf:c}:void 0;case eZ.ZodFirstPartyTypeKind.ZodIntersection:let g,h;return g=[SL(e.left._def,{...r,currentPath:[...r.currentPath,"allOf","0"]}),SL(e.right._def,{...r,currentPath:[...r.currentPath,"allOf","1"]})].filter(e=>!!e),h=[],g.forEach(e=>{if((!("type"in e)||"string"!==e.type)&&"allOf"in e)h.push(...e.allOf);else{let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){let{additionalProperties:r,...a}=e;t=a}h.push(t)}}),h.length?{allOf:h}:void 0;case eZ.ZodFirstPartyTypeKind.ZodTuple:return e.rest?{type:"array",minItems:e.items.length,items:e.items.map((e,t)=>SL(e._def,{...r,currentPath:[...r.currentPath,"items",`${t}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[]),additionalItems:SL(e.rest._def,{...r,currentPath:[...r.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map((e,t)=>SL(e._def,{...r,currentPath:[...r.currentPath,"items",`${t}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[])};case eZ.ZodFirstPartyTypeKind.ZodRecord:return Sj(e,r);case eZ.ZodFirstPartyTypeKind.ZodLiteral:let f;return"bigint"!=(f=typeof e.value)&&"number"!==f&&"boolean"!==f&&"string"!==f?{type:Array.isArray(e.value)?"array":"object"}:{type:"bigint"===f?"integer":f,const:e.value};case eZ.ZodFirstPartyTypeKind.ZodEnum:return{type:"string",enum:Array.from(e.values)};case eZ.ZodFirstPartyTypeKind.ZodNativeEnum:let y,v,b;return y=e.values,{type:1===(b=Array.from(new Set((v=Object.keys(e.values).filter(e=>"number"!=typeof y[y[e]]).map(e=>y[e])).map(e=>typeof e)))).length?"string"===b[0]?"string":"number":["string","number"],enum:v};case eZ.ZodFirstPartyTypeKind.ZodNullable:if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return{type:[SN[e.innerType._def.typeName],"null"]};let w=SL(e.innerType._def,{...r,currentPath:[...r.currentPath,"anyOf","0"]});return w&&{anyOf:[w,{type:"null"}]};case eZ.ZodFirstPartyTypeKind.ZodOptional:if(r.currentPath.toString()===(null==(l=r.propertyPath)?void 0:l.toString()))return SL(e.innerType._def,r);let k=SL(e.innerType._def,{...r,currentPath:[...r.currentPath,"anyOf","1"]});return k?{anyOf:[{not:{}},k]}:{};case eZ.ZodFirstPartyTypeKind.ZodMap:if("record"===r.mapStrategy)return Sj(e,r);return{type:"array",maxItems:125,items:{type:"array",items:[SL(e.keyType._def,{...r,currentPath:[...r.currentPath,"items","items","0"]})||{},SL(e.valueType._def,{...r,currentPath:[...r.currentPath,"items","items","1"]})||{}],minItems:2,maxItems:2}};case eZ.ZodFirstPartyTypeKind.ZodSet:let _;return _={type:"array",uniqueItems:!0,items:SL(e.valueType._def,{...r,currentPath:[...r.currentPath,"items"]})},e.minSize&&(_.minItems=e.minSize.value),e.maxSize&&(_.maxItems=e.maxSize.value),_;case eZ.ZodFirstPartyTypeKind.ZodLazy:return()=>e.getter()._def;case eZ.ZodFirstPartyTypeKind.ZodPromise:return SL(e.type._def,r);case eZ.ZodFirstPartyTypeKind.ZodNaN:case eZ.ZodFirstPartyTypeKind.ZodNever:return{not:{}};case eZ.ZodFirstPartyTypeKind.ZodEffects:return"input"===r.effectStrategy?SL(e.schema._def,r):{};case eZ.ZodFirstPartyTypeKind.ZodAny:case eZ.ZodFirstPartyTypeKind.ZodUnknown:return{};case eZ.ZodFirstPartyTypeKind.ZodDefault:return{...SL(e.innerType._def,r),default:e.defaultValue()};case eZ.ZodFirstPartyTypeKind.ZodBranded:return Sf(e,r);case eZ.ZodFirstPartyTypeKind.ZodReadonly:case eZ.ZodFirstPartyTypeKind.ZodCatch:return SL(e.innerType._def,r);case eZ.ZodFirstPartyTypeKind.ZodPipeline:if("input"===r.pipeStrategy)return SL(e.in._def,r);if("output"===r.pipeStrategy)return SL(e.out._def,r);let I=SL(e.in._def,{...r,currentPath:[...r.currentPath,"allOf","0"]}),S=SL(e.out._def,{...r,currentPath:[...r.currentPath,"allOf",I?"1":"0"]});return{allOf:[I,S].filter(e=>void 0!==e)};case eZ.ZodFirstPartyTypeKind.ZodFunction:case eZ.ZodFirstPartyTypeKind.ZodVoid:case eZ.ZodFirstPartyTypeKind.ZodSymbol:default:return}})(e,e.typeName,t),o="function"==typeof i?SL(i(),t):i;if(o&&Sq(e,t,o),t.postProcess){let r=t.postProcess(o,e,t);return n.jsonSchema=o,r}return n.jsonSchema=o,o}var SD=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"relative":return{$ref:((e,t)=>{let r=0;for(;r<e.length&&r<t.length&&e[r]===t[r];r++);return[(e.length-r).toString(),...t.slice(r)].join("/")})(t.currentPath,e.path)};case"none":case"seen":if(e.path.length<t.currentPath.length&&e.path.every((e,r)=>t.currentPath[r]===e))return console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),{};return"seen"===t.$refStrategy?{}:void 0}},Sq=(e,t,r)=>(e.description&&(r.description=e.description),r),S$=Symbol.for("vercel.ai.schema");function SF(e){let t;return()=>(null==t&&(t=e()),t)}function SU(e,{validate:t}={}){return{[S$]:!0,_type:void 0,get jsonSchema(){return"function"==typeof e&&(e=e()),e},validate:t}}function SZ(e){var t;return null==e?SU({properties:{},additionalProperties:!1}):"object"==typeof e&&null!==e&&S$ in e&&!0===e[S$]&&"jsonSchema"in e&&"validate"in e?e:"~standard"in e?"zod"===e["~standard"].vendor?SB(e):(t=e,SU(()=>Sc(t["~standard"].jsonSchema.input({target:"draft-07"})),{validate:async e=>{let r=await t["~standard"].validate(e);return"value"in r?{success:!0,value:r.value}:{success:!1,error:new I1({value:e,cause:r.issues})}}})):e()}function SB(e,t){var r,a;let s;if("_zod"in e){let a;return a=null!=(r=null==t?void 0:t.useReferences)&&r,SU(()=>Sc(eF.toJSONSchema(e,{target:"draft-7",io:"input",reused:a?"ref":"inline"})),{validate:async t=>{let r=await e$.safeParseAsync(e,t);return r.success?{success:!0,value:r.data}:{success:!1,error:r.error}}})}return s=null!=(a=null==t?void 0:t.useReferences)&&a,SU(()=>((e,t)=>{var r;let a,s,n=(s=void 0!==(a="string"==typeof t?{...Sh,name:t}:{...Sh,...t}).name?[...a.basePath,a.definitionPath,a.name]:a.basePath,{...a,currentPath:s,propertyPath:void 0,seen:new Map(Object.entries(a.definitions).map(([e,t])=>[t._def,{def:t._def,path:[...a.basePath,a.definitionPath,e],jsonSchema:void 0}]))}),i="object"==typeof t&&t.definitions?Object.entries(t.definitions).reduce((e,[t,r])=>{var a;return{...e,[t]:null!=(a=SL(r._def,{...n,currentPath:[...n.basePath,n.definitionPath,t]},!0))?a:{}}},{}):void 0,o="string"==typeof t?t:(null==t?void 0:t.nameStrategy)==="title"||null==t?void 0:t.name,l=null!=(r=SL(e._def,void 0===o?n:{...n,currentPath:[...n.basePath,n.definitionPath,o]},!1))?r:{},u="object"==typeof t&&void 0!==t.name&&"title"===t.nameStrategy?t.name:void 0;void 0!==u&&(l.title=u);let p=void 0===o?i?{...l,[n.definitionPath]:i}:l:{$ref:[..."relative"===n.$refStrategy?[]:n.basePath,n.definitionPath,o].join("/"),[n.definitionPath]:{...i,[o]:l}};return p.$schema="http://json-schema.org/draft-07/schema#",p})(e,{$refStrategy:s?"root":"none"}),{validate:async t=>{let r=await e.safeParseAsync(t);return r.success?{success:!0,value:r.data}:{success:!1,error:r.error}}})}async function SV({value:e,schema:t}){let r=await SK({value:e,schema:t});if(!r.success)throw I1.wrap({value:e,cause:r.error});return r.value}async function SK({value:e,schema:t}){let r=SZ(t);try{if(null==r.validate)return{success:!0,value:e,rawValue:e};let t=await r.validate(e);if(t.success)return{success:!0,value:t.value,rawValue:e};return{success:!1,error:I1.wrap({value:e,cause:t.error}),rawValue:e}}catch(t){return{success:!1,error:I1.wrap({value:e,cause:t}),rawValue:e}}}async function SG({text:e,schema:t}){try{let r=Sd(e);if(null==t)return r;return SV({value:r,schema:t})}catch(t){if(IJ.isInstance(t)||I1.isInstance(t))throw t;throw new IJ({text:e,cause:t})}}async function SW({text:e,schema:t}){try{let r=Sd(e);if(null==t)return{success:!0,value:r,rawValue:r};return await SK({value:r,schema:t})}catch(t){return{success:!1,error:IJ.isInstance(t)?t:new IJ({text:e,cause:t}),rawValue:void 0}}}var SQ=()=>globalThis.fetch,SJ=async({url:e,headers:t,body:r,failedResponseHandler:a,successfulResponseHandler:s,abortSignal:n,fetch:i})=>SH({url:e,headers:{"Content-Type":"application/json",...t},body:{content:JSON.stringify(r),values:r},failedResponseHandler:a,successfulResponseHandler:s,abortSignal:n,fetch:i}),SH=async({url:e,headers:t={},body:r,successfulResponseHandler:a,failedResponseHandler:s,abortSignal:n,fetch:i=SQ()})=>{try{let o=await i(e,{method:"POST",headers:Sa(t,`ai-sdk/provider-utils/${Ss}`,Sr()),body:r.content,signal:n}),l=I5(o);if(!o.ok){let t;try{t=await s({response:o,url:e,requestBodyValues:r.values})}catch(t){if(I8(t)||IN.isInstance(t))throw t;throw new IN({message:"Failed to process error response",cause:t,statusCode:o.status,url:e,responseHeaders:l,requestBodyValues:r.values})}throw t.value}try{return await a({response:o,url:e,requestBodyValues:r.values})}catch(t){if(t instanceof Error&&(I8(t)||IN.isInstance(t)))throw t;throw new IN({message:"Failed to process successful response",cause:t,statusCode:o.status,url:e,responseHeaders:l,requestBodyValues:r.values})}}catch(t){throw St({error:t,url:e,requestBodyValues:r.values})}};async function SY(e){return"function"==typeof e&&(e=e()),Promise.resolve(e)}var SX=({errorSchema:e,errorToMessage:t,isRetryable:r})=>async({response:a,url:s,requestBodyValues:n})=>{let i=await a.text(),o=I5(a);if(""===i.trim())return{responseHeaders:o,value:new IN({message:a.statusText,url:s,requestBodyValues:n,statusCode:a.status,responseHeaders:o,responseBody:i,isRetryable:null==r?void 0:r(a)})};try{let l=await SG({text:i,schema:e});return{responseHeaders:o,value:new IN({message:t(l),url:s,requestBodyValues:n,statusCode:a.status,responseHeaders:o,responseBody:i,data:l,isRetryable:null==r?void 0:r(a,l)})}}catch(e){return{responseHeaders:o,value:new IN({message:a.statusText,url:s,requestBodyValues:n,statusCode:a.status,responseHeaders:o,responseBody:i,isRetryable:null==r?void 0:r(a)})}}},S0=e=>async({response:t,url:r,requestBodyValues:a})=>{let s=await t.text(),n=await SW({text:s,schema:e}),i=I5(t);if(!n.success)throw new IN({message:"Invalid JSON response",cause:n.error,statusCode:t.status,responseHeaders:i,responseBody:s,url:r,requestBodyValues:a});return{responseHeaders:i,value:n.value,rawValue:n.rawValue}},sg=eF,S1=e.i(609523),S2=Symbol.for("vercel.ai.gateway.error"),S3=class e extends(ei=Error,en=S2,ei){constructor({message:e,statusCode:t=500,cause:r,generationId:a}){super(a?`${e} [${a}]`:e),this[en]=!0,this.statusCode=t,this.cause=r,this.generationId=a}static isInstance(t){return e.hasMarker(t)}static hasMarker(e){return"object"==typeof e&&null!==e&&S2 in e&&!0===e[S2]}},S5="GatewayAuthenticationError",S4=Symbol.for(`vercel.ai.gateway.error.${S5}`),S6=class e extends(el=S3,eo=S4,el){constructor({message:e="Authentication failed",statusCode:t=401,cause:r,generationId:a}={}){super({message:e,statusCode:t,cause:r,generationId:a}),this[eo]=!0,this.name=S5,this.type="authentication_error"}static isInstance(e){return S3.hasMarker(e)&&S4 in e}static createContextualError({apiKeyProvided:t,oidcTokenProvided:r,message:a="Authentication failed",statusCode:s=401,cause:n,generationId:i}){return new e({message:t?`AI Gateway authentication failed: Invalid API key.

Create a new API key: https://vercel.com/d?to=%2F%5Bteam%5D%2F%7E%2Fai%2Fapi-keys

Provide via 'apiKey' option or 'AI_GATEWAY_API_KEY' environment variable.`:r?`AI Gateway authentication failed: Invalid OIDC token.

Run 'npx vercel link' to link your project, then 'vc env pull' to fetch the token.

Alternatively, use an API key: https://vercel.com/d?to=%2F%5Bteam%5D%2F%7E%2Fai%2Fapi-keys`:`AI Gateway authentication failed: No authentication provided.

Option 1 - API key:
Create an API key: https://vercel.com/d?to=%2F%5Bteam%5D%2F%7E%2Fai%2Fapi-keys
Provide via 'apiKey' option or 'AI_GATEWAY_API_KEY' environment variable.

Option 2 - OIDC token:
Run 'npx vercel link' to link your project, then 'vc env pull' to fetch the token.`,statusCode:s,cause:n,generationId:i})}},S7="GatewayInvalidRequestError",S9=Symbol.for(`vercel.ai.gateway.error.${S7}`),S8=class extends(ep=S3,eu=S9,ep){constructor({message:e="Invalid request",statusCode:t=400,cause:r,generationId:a}={}){super({message:e,statusCode:t,cause:r,generationId:a}),this[eu]=!0,this.name=S7,this.type="invalid_request_error"}static isInstance(e){return S3.hasMarker(e)&&S9 in e}},xe="GatewayRateLimitError",xt=Symbol.for(`vercel.ai.gateway.error.${xe}`),xr=class extends(ec=S3,ed=xt,ec){constructor({message:e="Rate limit exceeded",statusCode:t=429,cause:r,generationId:a}={}){super({message:e,statusCode:t,cause:r,generationId:a}),this[ed]=!0,this.name=xe,this.type="rate_limit_exceeded"}static isInstance(e){return S3.hasMarker(e)&&xt in e}},xa="GatewayModelNotFoundError",xs=Symbol.for(`vercel.ai.gateway.error.${xa}`),xn=SF(()=>SB(eU.z.object({modelId:eU.z.string()}))),xi=class extends(eg=S3,em=xs,eg){constructor({message:e="Model not found",statusCode:t=404,modelId:r,cause:a,generationId:s}={}){super({message:e,statusCode:t,cause:a,generationId:s}),this[em]=!0,this.name=xa,this.type="model_not_found",this.modelId=r}static isInstance(e){return S3.hasMarker(e)&&xs in e}},xo="GatewayInternalServerError",xl=Symbol.for(`vercel.ai.gateway.error.${xo}`),xu=class extends(ef=S3,eh=xl,ef){constructor({message:e="Internal server error",statusCode:t=500,cause:r,generationId:a}={}){super({message:e,statusCode:t,cause:r,generationId:a}),this[eh]=!0,this.name=xo,this.type="internal_server_error"}static isInstance(e){return S3.hasMarker(e)&&xl in e}},xp="GatewayResponseError",xd=Symbol.for(`vercel.ai.gateway.error.${xp}`),xc=class extends(ev=S3,ey=xd,ev){constructor({message:e="Invalid response from Gateway",statusCode:t=502,response:r,validationError:a,cause:s,generationId:n}={}){super({message:e,statusCode:t,cause:s,generationId:n}),this[ey]=!0,this.name=xp,this.type="response_error",this.response=r,this.validationError=a}static isInstance(e){return S3.hasMarker(e)&&xd in e}};async function xm({response:e,statusCode:t,defaultMessage:r="Gateway request failed",cause:a,authMethod:s}){var n;let i=await SK({value:e,schema:xg});if(!i.success){let s="object"==typeof e&&null!==e&&"generationId"in e?e.generationId:void 0;return new xc({message:`Invalid error response format: ${r}`,statusCode:t,response:e,validationError:i.error,cause:a,generationId:s})}let o=i.value,l=o.error.type,u=o.error.message,p=null!=(n=o.generationId)?n:void 0;switch(l){case"authentication_error":return S6.createContextualError({apiKeyProvided:"api-key"===s,oidcTokenProvided:"oidc"===s,statusCode:t,cause:a,generationId:p});case"invalid_request_error":return new S8({message:u,statusCode:t,cause:a,generationId:p});case"rate_limit_exceeded":return new xr({message:u,statusCode:t,cause:a,generationId:p});case"model_not_found":{let e=await SK({value:o.error.param,schema:xn});return new xi({message:u,statusCode:t,modelId:e.success?e.value.modelId:void 0,cause:a,generationId:p})}default:return new xu({message:u,statusCode:t,cause:a,generationId:p})}}var xg=SF(()=>SB(eU.z.object({error:eU.z.object({message:eU.z.string(),type:eU.z.string().nullish(),param:eU.z.unknown().nullish(),code:eU.z.union([eU.z.string(),eU.z.number()]).nullish()}),generationId:eU.z.string().nullish()})));function xh(e,t){var r;return S3.isInstance(e)?e:IN.isInstance(e)?xm({response:function(e){if(void 0!==e.data)return e.data;if(null!=e.responseBody)try{return JSON.parse(e.responseBody)}catch(t){return e.responseBody}return{}}(e),statusCode:null!=(r=e.statusCode)?r:500,defaultMessage:"Gateway request failed",cause:e,authMethod:t}):xm({response:{},statusCode:500,defaultMessage:e instanceof Error?`Gateway request failed: ${e.message}`:"Unknown Gateway error",cause:e,authMethod:t})}var xf="ai-gateway-auth-method";async function xy(e){let t=await SK({value:e[xf],schema:xv});return t.success?t.value:void 0}var xv=SF(()=>SB(eU.z.union([eU.z.literal("api-key"),eU.z.literal("oidc")]))),xb=class{constructor(e){this.config=e}async getAvailableModels(){try{let{value:e}=await Si({url:`${this.config.baseURL}/config`,headers:await SY(this.config.headers()),successfulResponseHandler:S0(xw),failedResponseHandler:SX({errorSchema:eU.z.any(),errorToMessage:e=>e}),fetch:this.config.fetch});return e}catch(e){throw await xh(e)}}async getCredits(){try{let e=new URL(this.config.baseURL),{value:t}=await Si({url:`${e.origin}/v1/credits`,headers:await SY(this.config.headers()),successfulResponseHandler:S0(xk),failedResponseHandler:SX({errorSchema:eU.z.any(),errorToMessage:e=>e}),fetch:this.config.fetch});return t}catch(e){throw await xh(e)}}},xw=SF(()=>SB(eU.z.object({models:eU.z.array(eU.z.object({id:eU.z.string(),name:eU.z.string(),description:eU.z.string().nullish(),pricing:eU.z.object({input:eU.z.string(),output:eU.z.string(),input_cache_read:eU.z.string().nullish(),input_cache_write:eU.z.string().nullish()}).transform(({input:e,output:t,input_cache_read:r,input_cache_write:a})=>({input:e,output:t,...r?{cachedInputTokens:r}:{},...a?{cacheCreationInputTokens:a}:{}})).nullish(),specification:eU.z.object({specificationVersion:eU.z.literal("v3"),provider:eU.z.string(),modelId:eU.z.string()}),modelType:eU.z.enum(["language","embedding","image"]).nullish()}))}))),xk=SF(()=>SB(eU.z.object({balance:eU.z.string(),total_used:eU.z.string()}).transform(({balance:e,total_used:t})=>({balance:e,totalUsed:t})))),x_=class{constructor(e,t){this.modelId=e,this.config=t,this.specificationVersion="v3",this.supportedUrls={"*/*":[/.*/]}}get provider(){return this.config.provider}async getArgs(e){let{abortSignal:t,...r}=e;return{args:this.maybeEncodeFileParts(r),warnings:[]}}async doGenerate(e){let{args:t,warnings:r}=await this.getArgs(e),{abortSignal:a}=e,s=await SY(this.config.headers());try{let{responseHeaders:n,value:i,rawValue:o}=await SJ({url:this.getUrl(),headers:I3(s,e.headers,this.getModelConfigHeaders(this.modelId,!1),await SY(this.config.o11yHeaders)),body:t,successfulResponseHandler:S0(eU.z.any()),failedResponseHandler:SX({errorSchema:eU.z.any(),errorToMessage:e=>e}),...a&&{abortSignal:a},fetch:this.config.fetch});return{...i,request:{body:t},response:{headers:n,body:o},warnings:r}}catch(e){throw await xh(e,await xy(s))}}async doStream(e){let{args:t,warnings:r}=await this.getArgs(e),{abortSignal:a}=e,s=await SY(this.config.headers());try{let n,{value:i,responseHeaders:o}=await SJ({url:this.getUrl(),headers:I3(s,e.headers,this.getModelConfigHeaders(this.modelId,!0),await SY(this.config.o11yHeaders)),body:t,successfulResponseHandler:(n=eU.z.any(),async({response:e})=>{let t=I5(e);if(null==e.body)throw new I$({});return{responseHeaders:t,value:function({stream:e,schema:t}){return e.pipeThrough(new TextDecoderStream).pipeThrough(new pa).pipeThrough(new TransformStream({async transform({data:e},r){"[DONE]"!==e&&r.enqueue(await SW({text:e,schema:t}))}}))}({stream:e.body,schema:n})}}),failedResponseHandler:SX({errorSchema:eU.z.any(),errorToMessage:e=>e}),...a&&{abortSignal:a},fetch:this.config.fetch});return{stream:i.pipeThrough(new TransformStream({start(e){r.length>0&&e.enqueue({type:"stream-start",warnings:r})},transform(t,r){if(t.success){let a=t.value;("raw"!==a.type||e.includeRawChunks)&&("response-metadata"===a.type&&a.timestamp&&"string"==typeof a.timestamp&&(a.timestamp=new Date(a.timestamp)),r.enqueue(a))}else r.error(t.error)}})),request:{body:t},response:{headers:o}}}catch(e){throw await xh(e,await xy(s))}}isFilePart(e){return e&&"object"==typeof e&&"type"in e&&"file"===e.type}maybeEncodeFileParts(e){for(let t of e.prompt)for(let e of t.content)if(this.isFilePart(e)&&e.data instanceof Uint8Array){let t=Uint8Array.from(e.data),r=Buffer.from(t).toString("base64");e.data=new URL(`data:${e.mediaType||"application/octet-stream"};base64,${r}`)}return e}getUrl(){return`${this.config.baseURL}/language-model`}getModelConfigHeaders(e,t){return{"ai-language-model-specification-version":"3","ai-language-model-id":e,"ai-language-model-streaming":String(t)}}},xI=class{constructor(e,t){this.modelId=e,this.config=t,this.specificationVersion="v3",this.maxEmbeddingsPerCall=2048,this.supportsParallelCalls=!0}get provider(){return this.config.provider}async doEmbed({values:e,headers:t,abortSignal:r,providerOptions:a}){var s;let n=await SY(this.config.headers());try{let{responseHeaders:i,value:o,rawValue:l}=await SJ({url:this.getUrl(),headers:I3(n,null!=t?t:{},this.getModelConfigHeaders(),await SY(this.config.o11yHeaders)),body:{values:e,...a?{providerOptions:a}:{}},successfulResponseHandler:S0(xS),failedResponseHandler:SX({errorSchema:eU.z.any(),errorToMessage:e=>e}),...r&&{abortSignal:r},fetch:this.config.fetch});return{embeddings:o.embeddings,usage:null!=(s=o.usage)?s:void 0,providerMetadata:o.providerMetadata,response:{headers:i,body:l},warnings:[]}}catch(e){throw await xh(e,await xy(n))}}getUrl(){return`${this.config.baseURL}/embedding-model`}getModelConfigHeaders(){return{"ai-embedding-model-specification-version":"3","ai-model-id":this.modelId}}},xS=SF(()=>SB(eU.z.object({embeddings:eU.z.array(eU.z.array(eU.z.number())),usage:eU.z.object({tokens:eU.z.number()}).nullish(),providerMetadata:eU.z.record(eU.z.string(),eU.z.record(eU.z.string(),eU.z.unknown())).optional()}))),xx=class{constructor(e,t){this.modelId=e,this.config=t,this.specificationVersion="v3",this.maxImagesPerCall=Number.MAX_SAFE_INTEGER}get provider(){return this.config.provider}async doGenerate({prompt:e,n:t,size:r,aspectRatio:a,seed:s,files:n,mask:i,providerOptions:o,headers:l,abortSignal:u}){var p;let d=await SY(this.config.headers());try{let{responseHeaders:c,value:m,rawValue:g}=await SJ({url:this.getUrl(),headers:I3(d,null!=l?l:{},this.getModelConfigHeaders(),await SY(this.config.o11yHeaders)),body:{prompt:e,n:t,...r&&{size:r},...a&&{aspectRatio:a},...s&&{seed:s},...o&&{providerOptions:o},...n&&{files:n.map(e=>xT(e))},...i&&{mask:xT(i)}},successfulResponseHandler:S0(xA),failedResponseHandler:SX({errorSchema:eU.z.any(),errorToMessage:e=>e}),...u&&{abortSignal:u},fetch:this.config.fetch});return{images:m.images,warnings:null!=(p=m.warnings)?p:[],providerMetadata:m.providerMetadata,response:{timestamp:new Date,modelId:this.modelId,headers:c}}}catch(e){throw xh(e,await xy(d))}}getUrl(){return`${this.config.baseURL}/image-model`}getModelConfigHeaders(){return{"ai-image-model-specification-version":"3","ai-model-id":this.modelId}}};function xT(e){return"file"===e.type&&e.data instanceof Uint8Array?{...e,data:function(e){let t="";for(let r=0;r<e.length;r++)t+=String.fromCodePoint(e[r]);return I4(t)}(e.data)}:e}var xE=eU.z.object({images:eU.z.array(eU.z.unknown()).optional()}).catchall(eU.z.unknown()),xA=eU.z.object({images:eU.z.array(eU.z.string()),warnings:eU.z.array(eU.z.object({type:eU.z.literal("other"),message:eU.z.string()})).optional(),providerMetadata:eU.z.record(eU.z.string(),xE).optional()}),xO=function({id:e,inputSchema:t,outputSchema:r,supportsDeferredResults:a}){return({execute:s,needsApproval:n,toModelOutput:i,onInputStart:o,onInputDelta:l,onInputAvailable:u,...p})=>({type:"provider",id:e,args:p,inputSchema:t,outputSchema:r,execute:s,needsApproval:n,toModelOutput:i,onInputStart:o,onInputDelta:l,onInputAvailable:u,supportsDeferredResults:a})}({id:"gateway.perplexity_search",inputSchema:SF(()=>SB(sg.object({query:sg.union([sg.string(),sg.array(sg.string())]).describe("Search query (string) or multiple queries (array of up to 5 strings). Multi-query searches return combined results from all queries."),max_results:sg.number().optional().describe("Maximum number of search results to return (1-20, default: 10)"),max_tokens_per_page:sg.number().optional().describe("Maximum number of tokens to extract per search result page (256-2048, default: 2048)"),max_tokens:sg.number().optional().describe("Maximum total tokens across all search results (default: 25000, max: 1000000)"),country:sg.string().optional().describe("Two-letter ISO 3166-1 alpha-2 country code for regional search results (e.g., 'US', 'GB', 'FR')"),search_domain_filter:sg.array(sg.string()).optional().describe("List of domains to include or exclude from search results (max 20). To include: ['nature.com', 'science.org']. To exclude: ['-example.com', '-spam.net']"),search_language_filter:sg.array(sg.string()).optional().describe("List of ISO 639-1 language codes to filter results (max 10, lowercase). Examples: ['en', 'fr', 'de']"),search_after_date:sg.string().optional().describe("Include only results published after this date. Format: 'MM/DD/YYYY' (e.g., '3/1/2025'). Cannot be used with search_recency_filter."),search_before_date:sg.string().optional().describe("Include only results published before this date. Format: 'MM/DD/YYYY' (e.g., '3/15/2025'). Cannot be used with search_recency_filter."),last_updated_after_filter:sg.string().optional().describe("Include only results last updated after this date. Format: 'MM/DD/YYYY' (e.g., '3/1/2025'). Cannot be used with search_recency_filter."),last_updated_before_filter:sg.string().optional().describe("Include only results last updated before this date. Format: 'MM/DD/YYYY' (e.g., '3/15/2025'). Cannot be used with search_recency_filter."),search_recency_filter:sg.enum(["day","week","month","year"]).optional().describe("Filter results by relative time period. Cannot be used with search_after_date or search_before_date.")}))),outputSchema:SF(()=>SB(sg.union([sg.object({results:sg.array(sg.object({title:sg.string(),url:sg.string(),snippet:sg.string(),date:sg.string().optional(),lastUpdated:sg.string().optional()})),id:sg.string()}),sg.object({error:sg.enum(["api_error","rate_limit","timeout","invalid_input","unknown"]),statusCode:sg.number().optional(),message:sg.string()})])))}),xz={perplexitySearch:(e={})=>xO(e)};async function xM(){var e;return null==(e=(0,S1.getContext)().headers)?void 0:e["x-vercel-id"]}async function xP(e){let t=So({settingValue:e.apiKey,environmentVariableName:"AI_GATEWAY_API_KEY"});return t?{token:t,authMethod:"api-key"}:{token:await (0,S1.getVercelOidcToken)(),authMethod:"oidc"}}!function(e={}){var t,r,a;let s=null,n=null,i=null!=(t=e.metadataCacheRefreshMillis)?t:3e5,o=0,l=null!=(r=null==(a=e.baseURL)?void 0:a.replace(/\/$/,""))?r:"https://ai-gateway.vercel.sh/v3/ai",u=async()=>{try{let t=await xP(e);return Sa({Authorization:`Bearer ${t.token}`,"ai-gateway-protocol-version":"0.0.1",[xf]:t.authMethod,...e.headers},"ai-sdk/gateway/3.0.23")}catch(e){throw S6.createContextualError({apiKeyProvided:!1,oidcTokenProvided:!1,statusCode:401,cause:e})}},p=()=>{let e=So({settingValue:void 0,environmentVariableName:"VERCEL_DEPLOYMENT_ID"}),t=So({settingValue:void 0,environmentVariableName:"VERCEL_ENV"}),r=So({settingValue:void 0,environmentVariableName:"VERCEL_REGION"});return async()=>{let a=await xM();return{...e&&{"ai-o11y-deployment-id":e},...t&&{"ai-o11y-environment":t},...r&&{"ai-o11y-region":r},...a&&{"ai-o11y-request-id":a}}}},d=t=>new x_(t,{provider:"gateway",baseURL:l,headers:u,fetch:e.fetch,o11yHeaders:p()}),c=async()=>{var t,r,a;let p=null!=(a=null==(r=null==(t=e._internal)?void 0:t.currentDate)?void 0:r.call(t).getTime())?a:Date.now();return(!s||p-o>i)&&(o=p,s=new xb({baseURL:l,headers:u,fetch:e.fetch}).getAvailableModels().then(e=>(n=e,e)).catch(async e=>{throw await xh(e,await xy(await u()))})),n?Promise.resolve(n):s},m=async()=>new xb({baseURL:l,headers:u,fetch:e.fetch}).getCredits().catch(async e=>{throw await xh(e,await xy(await u()))}),g=function(e){if(new.target)throw Error("The Gateway Provider model function cannot be called with the new keyword.");return d(e)};g.specificationVersion="v3",g.getAvailableModels=c,g.getCredits=m,g.imageModel=t=>new xx(t,{provider:"gateway",baseURL:l,headers:u,fetch:e.fetch,o11yHeaders:p()}),g.languageModel=d;let h=t=>new xI(t,{provider:"gateway",baseURL:l,headers:u,fetch:e.fetch,o11yHeaders:p()});g.embeddingModel=h,g.textEmbeddingModel=h,g.tools=xz}(),e.i(274812),e.i(214664),e.i(837809);var xR=Object.defineProperty,xC=(Symbol.for("vercel.ai.error.AI_InvalidArgumentError"),Symbol.for("vercel.ai.error.AI_InvalidStreamPartError"),Symbol.for("vercel.ai.error.AI_InvalidToolApprovalError"),Symbol.for("vercel.ai.error.AI_InvalidToolInputError"),Symbol.for("vercel.ai.error.AI_ToolCallNotFoundForApprovalError"),Symbol.for("vercel.ai.error.AI_MissingToolResultsError"),Symbol.for("vercel.ai.error.AI_NoImageGeneratedError"),"AI_NoObjectGeneratedError"),xj=`vercel.ai.error.${xC}`,xN=Symbol.for(xj),xL=class extends IP{constructor({message:e="No object generated.",cause:t,text:r,response:a,usage:s,finishReason:n}){super({name:xC,message:e,cause:t}),this[eb]=!0,this.text=r,this.response=a,this.usage=s,this.finishReason=n}static isInstance(e){return IP.hasMarker(e,xj)}};eb=xN,Symbol.for("vercel.ai.error.AI_NoOutputGeneratedError"),Symbol.for("vercel.ai.error.AI_NoSuchToolError"),Symbol.for("vercel.ai.error.AI_ToolCallRepairError"),Symbol.for("vercel.ai.error.AI_UIMessageStreamError"),Symbol.for("vercel.ai.error.AI_InvalidDataContentError"),Symbol.for("vercel.ai.error.AI_InvalidMessageRoleError"),Symbol.for("vercel.ai.error.AI_MessageConversionError"),Symbol.for("vercel.ai.error.AI_RetryError");var xD=eU.z.union([eU.z.string(),eU.z.instanceof(Uint8Array),eU.z.instanceof(ArrayBuffer),eU.z.custom(e=>{var t,r;return null!=(r=null==(t=globalThis.Buffer)?void 0:t.isBuffer(e))&&r},{message:"Must be a Buffer"})]),xq=eU.z.lazy(()=>eU.z.union([eU.z.null(),eU.z.string(),eU.z.number(),eU.z.boolean(),eU.z.record(eU.z.string(),xq.optional()),eU.z.array(xq)])),x$=eU.z.record(eU.z.string(),eU.z.record(eU.z.string(),xq.optional())),xF=eU.z.object({type:eU.z.literal("text"),text:eU.z.string(),providerOptions:x$.optional()}),xU=eU.z.object({type:eU.z.literal("image"),image:eU.z.union([xD,eU.z.instanceof(URL)]),mediaType:eU.z.string().optional(),providerOptions:x$.optional()}),xZ=eU.z.object({type:eU.z.literal("file"),data:eU.z.union([xD,eU.z.instanceof(URL)]),filename:eU.z.string().optional(),mediaType:eU.z.string(),providerOptions:x$.optional()}),xB=eU.z.object({type:eU.z.literal("reasoning"),text:eU.z.string(),providerOptions:x$.optional()}),xV=eU.z.object({type:eU.z.literal("tool-call"),toolCallId:eU.z.string(),toolName:eU.z.string(),input:eU.z.unknown(),providerOptions:x$.optional(),providerExecuted:eU.z.boolean().optional()}),xK=eU.z.discriminatedUnion("type",[eU.z.object({type:eU.z.literal("text"),value:eU.z.string(),providerOptions:x$.optional()}),eU.z.object({type:eU.z.literal("json"),value:xq,providerOptions:x$.optional()}),eU.z.object({type:eU.z.literal("execution-denied"),reason:eU.z.string().optional(),providerOptions:x$.optional()}),eU.z.object({type:eU.z.literal("error-text"),value:eU.z.string(),providerOptions:x$.optional()}),eU.z.object({type:eU.z.literal("error-json"),value:xq,providerOptions:x$.optional()}),eU.z.object({type:eU.z.literal("content"),value:eU.z.array(eU.z.union([eU.z.object({type:eU.z.literal("text"),text:eU.z.string(),providerOptions:x$.optional()}),eU.z.object({type:eU.z.literal("media"),data:eU.z.string(),mediaType:eU.z.string()}),eU.z.object({type:eU.z.literal("file-data"),data:eU.z.string(),mediaType:eU.z.string(),filename:eU.z.string().optional(),providerOptions:x$.optional()}),eU.z.object({type:eU.z.literal("file-url"),url:eU.z.string(),providerOptions:x$.optional()}),eU.z.object({type:eU.z.literal("file-id"),fileId:eU.z.union([eU.z.string(),eU.z.record(eU.z.string(),eU.z.string())]),providerOptions:x$.optional()}),eU.z.object({type:eU.z.literal("image-data"),data:eU.z.string(),mediaType:eU.z.string(),providerOptions:x$.optional()}),eU.z.object({type:eU.z.literal("image-url"),url:eU.z.string(),providerOptions:x$.optional()}),eU.z.object({type:eU.z.literal("image-file-id"),fileId:eU.z.union([eU.z.string(),eU.z.record(eU.z.string(),eU.z.string())]),providerOptions:x$.optional()}),eU.z.object({type:eU.z.literal("custom"),providerOptions:x$.optional()})]))})]),xG=eU.z.object({type:eU.z.literal("tool-result"),toolCallId:eU.z.string(),toolName:eU.z.string(),output:xK,providerOptions:x$.optional()}),xW=eU.z.object({type:eU.z.literal("tool-approval-request"),approvalId:eU.z.string(),toolCallId:eU.z.string()}),xQ=eU.z.object({type:eU.z.literal("tool-approval-response"),approvalId:eU.z.string(),approved:eU.z.boolean(),reason:eU.z.string().optional()}),xJ=eU.z.object({role:eU.z.literal("system"),content:eU.z.string(),providerOptions:x$.optional()}),xH=eU.z.object({role:eU.z.literal("user"),content:eU.z.union([eU.z.string(),eU.z.array(eU.z.union([xF,xU,xZ]))]),providerOptions:x$.optional()}),xY=eU.z.object({role:eU.z.literal("assistant"),content:eU.z.union([eU.z.string(),eU.z.array(eU.z.union([xF,xZ,xB,xV,xG,xW]))]),providerOptions:x$.optional()}),xX=eU.z.object({role:eU.z.literal("tool"),content:eU.z.array(eU.z.union([xG,xQ])),providerOptions:x$.optional()});eU.z.union([xJ,xH,xY,xX]);var x0={},x1={array:()=>x6,choice:()=>x7,json:()=>x9,object:()=>x4,text:()=>x5};for(var x2 in x1)xR(x0,x2,{get:x1[x2],enumerable:!0});async function x3(e){if(void 0===e)return{value:void 0,state:"undefined-input"};let t=await SW({text:e});return t.success?{value:t.value,state:"successful-parse"}:(t=await SW({text:function(e){let t=["ROOT"],r=-1,a=null;function s(e,s,n){switch(e){case'"':r=s,t.pop(),t.push(n),t.push("INSIDE_STRING");break;case"f":case"t":case"n":r=s,a=s,t.pop(),t.push(n),t.push("INSIDE_LITERAL");break;case"-":t.pop(),t.push(n),t.push("INSIDE_NUMBER");break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":r=s,t.pop(),t.push(n),t.push("INSIDE_NUMBER");break;case"{":r=s,t.pop(),t.push(n),t.push("INSIDE_OBJECT_START");break;case"[":r=s,t.pop(),t.push(n),t.push("INSIDE_ARRAY_START")}}function n(e,a){switch(e){case",":t.pop(),t.push("INSIDE_OBJECT_AFTER_COMMA");break;case"}":r=a,t.pop()}}function i(e,a){switch(e){case",":t.pop(),t.push("INSIDE_ARRAY_AFTER_COMMA");break;case"]":r=a,t.pop()}}for(let o=0;o<e.length;o++){let l=e[o];switch(t[t.length-1]){case"ROOT":s(l,o,"FINISH");break;case"INSIDE_OBJECT_START":switch(l){case'"':t.pop(),t.push("INSIDE_OBJECT_KEY");break;case"}":r=o,t.pop()}break;case"INSIDE_OBJECT_AFTER_COMMA":'"'===l&&(t.pop(),t.push("INSIDE_OBJECT_KEY"));break;case"INSIDE_OBJECT_KEY":'"'===l&&(t.pop(),t.push("INSIDE_OBJECT_AFTER_KEY"));break;case"INSIDE_OBJECT_AFTER_KEY":":"===l&&(t.pop(),t.push("INSIDE_OBJECT_BEFORE_VALUE"));break;case"INSIDE_OBJECT_BEFORE_VALUE":s(l,o,"INSIDE_OBJECT_AFTER_VALUE");break;case"INSIDE_OBJECT_AFTER_VALUE":n(l,o);break;case"INSIDE_STRING":switch(l){case'"':t.pop(),r=o;break;case"\\":t.push("INSIDE_STRING_ESCAPE");break;default:r=o}break;case"INSIDE_ARRAY_START":"]"===l?(r=o,t.pop()):(r=o,s(l,o,"INSIDE_ARRAY_AFTER_VALUE"));break;case"INSIDE_ARRAY_AFTER_VALUE":switch(l){case",":t.pop(),t.push("INSIDE_ARRAY_AFTER_COMMA");break;case"]":r=o,t.pop();break;default:r=o}break;case"INSIDE_ARRAY_AFTER_COMMA":s(l,o,"INSIDE_ARRAY_AFTER_VALUE");break;case"INSIDE_STRING_ESCAPE":t.pop(),r=o;break;case"INSIDE_NUMBER":switch(l){case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":r=o;break;case"e":case"E":case"-":case".":break;case",":t.pop(),"INSIDE_ARRAY_AFTER_VALUE"===t[t.length-1]&&i(l,o),"INSIDE_OBJECT_AFTER_VALUE"===t[t.length-1]&&n(l,o);break;case"}":t.pop(),"INSIDE_OBJECT_AFTER_VALUE"===t[t.length-1]&&n(l,o);break;case"]":t.pop(),"INSIDE_ARRAY_AFTER_VALUE"===t[t.length-1]&&i(l,o);break;default:t.pop()}break;case"INSIDE_LITERAL":{let s=e.substring(a,o+1);"false".startsWith(s)||"true".startsWith(s)||"null".startsWith(s)?r=o:(t.pop(),"INSIDE_OBJECT_AFTER_VALUE"===t[t.length-1]?n(l,o):"INSIDE_ARRAY_AFTER_VALUE"===t[t.length-1]&&i(l,o))}}}let o=e.slice(0,r+1);for(let r=t.length-1;r>=0;r--)switch(t[r]){case"INSIDE_STRING":o+='"';break;case"INSIDE_OBJECT_KEY":case"INSIDE_OBJECT_AFTER_KEY":case"INSIDE_OBJECT_AFTER_COMMA":case"INSIDE_OBJECT_START":case"INSIDE_OBJECT_BEFORE_VALUE":case"INSIDE_OBJECT_AFTER_VALUE":o+="}";break;case"INSIDE_ARRAY_START":case"INSIDE_ARRAY_AFTER_COMMA":case"INSIDE_ARRAY_AFTER_VALUE":o+="]";break;case"INSIDE_LITERAL":{let t=e.substring(a,e.length);"true".startsWith(t)?o+="true".slice(t.length):"false".startsWith(t)?o+="false".slice(t.length):"null".startsWith(t)&&(o+="null".slice(t.length))}}return o}(e)})).success?{value:t.value,state:"repaired-parse"}:{value:void 0,state:"failed-parse"}}var x5=()=>({name:"text",responseFormat:Promise.resolve({type:"text"}),parseCompleteOutput:async({text:e})=>e,parsePartialOutput:async({text:e})=>({partial:e}),createElementStreamTransform(){}}),x4=({schema:e,name:t,description:r})=>{let a=SZ(e);return{name:"object",responseFormat:SY(a.jsonSchema).then(e=>({type:"json",schema:e,...null!=t&&{name:t},...null!=r&&{description:r}})),async parseCompleteOutput({text:e},t){let r=await SW({text:e});if(!r.success)throw new xL({message:"No object generated: could not parse the response.",cause:r.error,text:e,response:t.response,usage:t.usage,finishReason:t.finishReason});let s=await SK({value:r.value,schema:a});if(!s.success)throw new xL({message:"No object generated: response did not match schema.",cause:s.error,text:e,response:t.response,usage:t.usage,finishReason:t.finishReason});return s.value},async parsePartialOutput({text:e}){let t=await x3(e);switch(t.state){case"failed-parse":case"undefined-input":return;case"repaired-parse":case"successful-parse":return{partial:t.value}}},createElementStreamTransform(){}}},x6=({element:e,name:t,description:r})=>{let a=SZ(e);return{name:"array",responseFormat:SY(a.jsonSchema).then(e=>{let{$schema:a,...s}=e;return{type:"json",schema:{$schema:"http://json-schema.org/draft-07/schema#",type:"object",properties:{elements:{type:"array",items:s}},required:["elements"],additionalProperties:!1},...null!=t&&{name:t},...null!=r&&{description:r}}}),async parseCompleteOutput({text:e},t){let r=await SW({text:e});if(!r.success)throw new xL({message:"No object generated: could not parse the response.",cause:r.error,text:e,response:t.response,usage:t.usage,finishReason:t.finishReason});let s=r.value;if(null==s||"object"!=typeof s||!("elements"in s)||!Array.isArray(s.elements))throw new xL({message:"No object generated: response did not match schema.",cause:new I1({value:s,cause:"response must be an object with an elements array"}),text:e,response:t.response,usage:t.usage,finishReason:t.finishReason});for(let r of s.elements){let s=await SK({value:r,schema:a});if(!s.success)throw new xL({message:"No object generated: response did not match schema.",cause:s.error,text:e,response:t.response,usage:t.usage,finishReason:t.finishReason})}return s.elements},async parsePartialOutput({text:e}){let t=await x3(e);switch(t.state){case"failed-parse":case"undefined-input":return;case"repaired-parse":case"successful-parse":{let e=t.value;if(null==e||"object"!=typeof e||!("elements"in e)||!Array.isArray(e.elements))return;let r="repaired-parse"===t.state&&e.elements.length>0?e.elements.slice(0,-1):e.elements,s=[];for(let e of r){let t=await SK({value:e,schema:a});t.success&&s.push(t.value)}return{partial:s}}}},createElementStreamTransform(){let e=0;return new TransformStream({transform({partialOutput:t},r){if(null!=t)for(;e<t.length;e++)r.enqueue(t[e])}})}}},x7=({options:e,name:t,description:r})=>({name:"choice",responseFormat:Promise.resolve({type:"json",schema:{$schema:"http://json-schema.org/draft-07/schema#",type:"object",properties:{result:{type:"string",enum:e}},required:["result"],additionalProperties:!1},...null!=t&&{name:t},...null!=r&&{description:r}}),async parseCompleteOutput({text:t},r){let a=await SW({text:t});if(!a.success)throw new xL({message:"No object generated: could not parse the response.",cause:a.error,text:t,response:r.response,usage:r.usage,finishReason:r.finishReason});let s=a.value;if(null==s||"object"!=typeof s||!("result"in s)||"string"!=typeof s.result||!e.includes(s.result))throw new xL({message:"No object generated: response did not match schema.",cause:new I1({value:s,cause:"response must be an object that contains a choice value."}),text:t,response:r.response,usage:r.usage,finishReason:r.finishReason});return s.result},async parsePartialOutput({text:t}){let r=await x3(t);switch(r.state){case"failed-parse":case"undefined-input":return;case"repaired-parse":case"successful-parse":{let t=r.value;if(null==t||"object"!=typeof t||!("result"in t)||"string"!=typeof t.result)return;let a=e.filter(e=>e.startsWith(t.result));if("successful-parse"===r.state)return a.includes(t.result)?{partial:t.result}:void 0;return 1===a.length?{partial:a[0]}:void 0}}},createElementStreamTransform(){}}),x9=({name:e,description:t}={})=>({name:"json",responseFormat:Promise.resolve({type:"json",...null!=e&&{name:e},...null!=t&&{description:t}}),async parseCompleteOutput({text:e},t){let r=await SW({text:e});if(!r.success)throw new xL({message:"No object generated: could not parse the response.",cause:r.error,text:e,response:t.response,usage:t.usage,finishReason:t.finishReason});return r.value},async parsePartialOutput({text:e}){let t=await x3(e);switch(t.state){case"failed-parse":case"undefined-input":return;case"repaired-parse":case"successful-parse":return void 0===t.value?void 0:{partial:t.value}}},createElementStreamTransform(){}});I9({prefix:"aitxt",size:24});(class extends TransformStream{constructor(){super({transform(e,t){t.enqueue(`data: ${JSON.stringify(e)}

`)},flush(e){e.enqueue("data: [DONE]\n\n")}})}});SF(()=>SB(eU.z.union([eU.z.strictObject({type:eU.z.literal("text-start"),id:eU.z.string(),providerMetadata:x$.optional()}),eU.z.strictObject({type:eU.z.literal("text-delta"),id:eU.z.string(),delta:eU.z.string(),providerMetadata:x$.optional()}),eU.z.strictObject({type:eU.z.literal("text-end"),id:eU.z.string(),providerMetadata:x$.optional()}),eU.z.strictObject({type:eU.z.literal("error"),errorText:eU.z.string()}),eU.z.strictObject({type:eU.z.literal("tool-input-start"),toolCallId:eU.z.string(),toolName:eU.z.string(),providerExecuted:eU.z.boolean().optional(),providerMetadata:x$.optional(),dynamic:eU.z.boolean().optional(),title:eU.z.string().optional()}),eU.z.strictObject({type:eU.z.literal("tool-input-delta"),toolCallId:eU.z.string(),inputTextDelta:eU.z.string()}),eU.z.strictObject({type:eU.z.literal("tool-input-available"),toolCallId:eU.z.string(),toolName:eU.z.string(),input:eU.z.unknown(),providerExecuted:eU.z.boolean().optional(),providerMetadata:x$.optional(),dynamic:eU.z.boolean().optional(),title:eU.z.string().optional()}),eU.z.strictObject({type:eU.z.literal("tool-input-error"),toolCallId:eU.z.string(),toolName:eU.z.string(),input:eU.z.unknown(),providerExecuted:eU.z.boolean().optional(),providerMetadata:x$.optional(),dynamic:eU.z.boolean().optional(),errorText:eU.z.string(),title:eU.z.string().optional()}),eU.z.strictObject({type:eU.z.literal("tool-approval-request"),approvalId:eU.z.string(),toolCallId:eU.z.string()}),eU.z.strictObject({type:eU.z.literal("tool-output-available"),toolCallId:eU.z.string(),output:eU.z.unknown(),providerExecuted:eU.z.boolean().optional(),dynamic:eU.z.boolean().optional(),preliminary:eU.z.boolean().optional()}),eU.z.strictObject({type:eU.z.literal("tool-output-error"),toolCallId:eU.z.string(),errorText:eU.z.string(),providerExecuted:eU.z.boolean().optional(),dynamic:eU.z.boolean().optional()}),eU.z.strictObject({type:eU.z.literal("tool-output-denied"),toolCallId:eU.z.string()}),eU.z.strictObject({type:eU.z.literal("reasoning-start"),id:eU.z.string(),providerMetadata:x$.optional()}),eU.z.strictObject({type:eU.z.literal("reasoning-delta"),id:eU.z.string(),delta:eU.z.string(),providerMetadata:x$.optional()}),eU.z.strictObject({type:eU.z.literal("reasoning-end"),id:eU.z.string(),providerMetadata:x$.optional()}),eU.z.strictObject({type:eU.z.literal("source-url"),sourceId:eU.z.string(),url:eU.z.string(),title:eU.z.string().optional(),providerMetadata:x$.optional()}),eU.z.strictObject({type:eU.z.literal("source-document"),sourceId:eU.z.string(),mediaType:eU.z.string(),title:eU.z.string(),filename:eU.z.string().optional(),providerMetadata:x$.optional()}),eU.z.strictObject({type:eU.z.literal("file"),url:eU.z.string(),mediaType:eU.z.string(),providerMetadata:x$.optional()}),eU.z.strictObject({type:eU.z.custom(e=>"string"==typeof e&&e.startsWith("data-"),{message:'Type must start with "data-"'}),id:eU.z.string().optional(),data:eU.z.unknown(),transient:eU.z.boolean().optional()}),eU.z.strictObject({type:eU.z.literal("start-step")}),eU.z.strictObject({type:eU.z.literal("finish-step")}),eU.z.strictObject({type:eU.z.literal("start"),messageId:eU.z.string().optional(),messageMetadata:eU.z.unknown().optional()}),eU.z.strictObject({type:eU.z.literal("finish"),finishReason:eU.z.enum(["stop","length","content-filter","tool-calls","error","other"]).optional(),messageMetadata:eU.z.unknown().optional()}),eU.z.strictObject({type:eU.z.literal("abort"),reason:eU.z.string().optional()}),eU.z.strictObject({type:eU.z.literal("message-metadata"),messageMetadata:eU.z.unknown()})]))),I9({prefix:"aitxt",size:24}),SF(()=>SB(eU.z.array(eU.z.object({id:eU.z.string(),role:eU.z.enum(["system","user","assistant"]),metadata:eU.z.unknown().optional(),parts:eU.z.array(eU.z.union([eU.z.object({type:eU.z.literal("text"),text:eU.z.string(),state:eU.z.enum(["streaming","done"]).optional(),providerMetadata:x$.optional()}),eU.z.object({type:eU.z.literal("reasoning"),text:eU.z.string(),state:eU.z.enum(["streaming","done"]).optional(),providerMetadata:x$.optional()}),eU.z.object({type:eU.z.literal("source-url"),sourceId:eU.z.string(),url:eU.z.string(),title:eU.z.string().optional(),providerMetadata:x$.optional()}),eU.z.object({type:eU.z.literal("source-document"),sourceId:eU.z.string(),mediaType:eU.z.string(),title:eU.z.string(),filename:eU.z.string().optional(),providerMetadata:x$.optional()}),eU.z.object({type:eU.z.literal("file"),mediaType:eU.z.string(),filename:eU.z.string().optional(),url:eU.z.string(),providerMetadata:x$.optional()}),eU.z.object({type:eU.z.literal("step-start")}),eU.z.object({type:eU.z.string().startsWith("data-"),id:eU.z.string().optional(),data:eU.z.unknown()}),eU.z.object({type:eU.z.literal("dynamic-tool"),toolName:eU.z.string(),toolCallId:eU.z.string(),state:eU.z.literal("input-streaming"),input:eU.z.unknown().optional(),providerExecuted:eU.z.boolean().optional(),callProviderMetadata:x$.optional(),output:eU.z.never().optional(),errorText:eU.z.never().optional(),approval:eU.z.never().optional()}),eU.z.object({type:eU.z.literal("dynamic-tool"),toolName:eU.z.string(),toolCallId:eU.z.string(),state:eU.z.literal("input-available"),input:eU.z.unknown(),providerExecuted:eU.z.boolean().optional(),output:eU.z.never().optional(),errorText:eU.z.never().optional(),callProviderMetadata:x$.optional(),approval:eU.z.never().optional()}),eU.z.object({type:eU.z.literal("dynamic-tool"),toolName:eU.z.string(),toolCallId:eU.z.string(),state:eU.z.literal("approval-requested"),input:eU.z.unknown(),providerExecuted:eU.z.boolean().optional(),output:eU.z.never().optional(),errorText:eU.z.never().optional(),callProviderMetadata:x$.optional(),approval:eU.z.object({id:eU.z.string(),approved:eU.z.never().optional(),reason:eU.z.never().optional()})}),eU.z.object({type:eU.z.literal("dynamic-tool"),toolName:eU.z.string(),toolCallId:eU.z.string(),state:eU.z.literal("approval-responded"),input:eU.z.unknown(),providerExecuted:eU.z.boolean().optional(),output:eU.z.never().optional(),errorText:eU.z.never().optional(),callProviderMetadata:x$.optional(),approval:eU.z.object({id:eU.z.string(),approved:eU.z.boolean(),reason:eU.z.string().optional()})}),eU.z.object({type:eU.z.literal("dynamic-tool"),toolName:eU.z.string(),toolCallId:eU.z.string(),state:eU.z.literal("output-available"),input:eU.z.unknown(),providerExecuted:eU.z.boolean().optional(),output:eU.z.unknown(),errorText:eU.z.never().optional(),callProviderMetadata:x$.optional(),preliminary:eU.z.boolean().optional(),approval:eU.z.object({id:eU.z.string(),approved:eU.z.literal(!0),reason:eU.z.string().optional()}).optional()}),eU.z.object({type:eU.z.literal("dynamic-tool"),toolName:eU.z.string(),toolCallId:eU.z.string(),state:eU.z.literal("output-error"),input:eU.z.unknown(),rawInput:eU.z.unknown().optional(),providerExecuted:eU.z.boolean().optional(),output:eU.z.never().optional(),errorText:eU.z.string(),callProviderMetadata:x$.optional(),approval:eU.z.object({id:eU.z.string(),approved:eU.z.literal(!0),reason:eU.z.string().optional()}).optional()}),eU.z.object({type:eU.z.literal("dynamic-tool"),toolName:eU.z.string(),toolCallId:eU.z.string(),state:eU.z.literal("output-denied"),input:eU.z.unknown(),providerExecuted:eU.z.boolean().optional(),output:eU.z.never().optional(),errorText:eU.z.never().optional(),callProviderMetadata:x$.optional(),approval:eU.z.object({id:eU.z.string(),approved:eU.z.literal(!1),reason:eU.z.string().optional()})}),eU.z.object({type:eU.z.string().startsWith("tool-"),toolCallId:eU.z.string(),state:eU.z.literal("input-streaming"),providerExecuted:eU.z.boolean().optional(),callProviderMetadata:x$.optional(),input:eU.z.unknown().optional(),output:eU.z.never().optional(),errorText:eU.z.never().optional(),approval:eU.z.never().optional()}),eU.z.object({type:eU.z.string().startsWith("tool-"),toolCallId:eU.z.string(),state:eU.z.literal("input-available"),providerExecuted:eU.z.boolean().optional(),input:eU.z.unknown(),output:eU.z.never().optional(),errorText:eU.z.never().optional(),callProviderMetadata:x$.optional(),approval:eU.z.never().optional()}),eU.z.object({type:eU.z.string().startsWith("tool-"),toolCallId:eU.z.string(),state:eU.z.literal("approval-requested"),input:eU.z.unknown(),providerExecuted:eU.z.boolean().optional(),output:eU.z.never().optional(),errorText:eU.z.never().optional(),callProviderMetadata:x$.optional(),approval:eU.z.object({id:eU.z.string(),approved:eU.z.never().optional(),reason:eU.z.never().optional()})}),eU.z.object({type:eU.z.string().startsWith("tool-"),toolCallId:eU.z.string(),state:eU.z.literal("approval-responded"),input:eU.z.unknown(),providerExecuted:eU.z.boolean().optional(),output:eU.z.never().optional(),errorText:eU.z.never().optional(),callProviderMetadata:x$.optional(),approval:eU.z.object({id:eU.z.string(),approved:eU.z.boolean(),reason:eU.z.string().optional()})}),eU.z.object({type:eU.z.string().startsWith("tool-"),toolCallId:eU.z.string(),state:eU.z.literal("output-available"),providerExecuted:eU.z.boolean().optional(),input:eU.z.unknown(),output:eU.z.unknown(),errorText:eU.z.never().optional(),callProviderMetadata:x$.optional(),preliminary:eU.z.boolean().optional(),approval:eU.z.object({id:eU.z.string(),approved:eU.z.literal(!0),reason:eU.z.string().optional()}).optional()}),eU.z.object({type:eU.z.string().startsWith("tool-"),toolCallId:eU.z.string(),state:eU.z.literal("output-error"),providerExecuted:eU.z.boolean().optional(),input:eU.z.unknown(),rawInput:eU.z.unknown().optional(),output:eU.z.never().optional(),errorText:eU.z.string(),callProviderMetadata:x$.optional(),approval:eU.z.object({id:eU.z.string(),approved:eU.z.literal(!0),reason:eU.z.string().optional()}).optional()}),eU.z.object({type:eU.z.string().startsWith("tool-"),toolCallId:eU.z.string(),state:eU.z.literal("output-denied"),providerExecuted:eU.z.boolean().optional(),input:eU.z.unknown(),output:eU.z.never().optional(),errorText:eU.z.never().optional(),callProviderMetadata:x$.optional(),approval:eU.z.object({id:eU.z.string(),approved:eU.z.literal(!1),reason:eU.z.string().optional()})})])).nonempty("Message must contain at least one part")})).nonempty("Messages array must not be empty"))),I9({prefix:"aiobj",size:24}),I9({prefix:"aiobj",size:24}),Symbol.for("vercel.ai.error.AI_NoSuchProviderError");let x8=Error("Cannot find module '@/src/mastra'");throw x8.code="MODULE_NOT_FOUND",x8}];

//# sourceMappingURL=%5Broot-of-the-server%5D__f5bcc489._.js.map